<!DOCTYPE html>
<html lang=zh>

    <head>
        <meta charset="utf-8">
        
            <title>
                
                    Lab 2.1 系统调用流程——以sleep为例 | 
                            Rinevard
            </title>
            
                
                    <meta name="keywords" content="Lab 2.1 系统调用流程——以sleep为例" />
                    
                        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
                        <meta name="description" content="我们知道应用程序在User mode下运行，而系统函数的执行需要Supervisor mode，那在系统调用时，User mode是怎么进入Supervisor mode的呢？我们以sleep的执行为例，看看都发生了什么。首先我们用 git checkout util 切换到 util 分支上。 在此之前，我们要先简介一下ECALL指令和stvec（Supervisor Trap Vector B">
<meta property="og:type" content="article">
<meta property="og:title" content="Lab 2.1 系统调用流程——以sleep为例">
<meta property="og:url" content="http://rinevard.github.io/wiki/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/index.html">
<meta property="og:site_name" content="Rinevard">
<meta property="og:description" content="我们知道应用程序在User mode下运行，而系统函数的执行需要Supervisor mode，那在系统调用时，User mode是怎么进入Supervisor mode的呢？我们以sleep的执行为例，看看都发生了什么。首先我们用 git checkout util 切换到 util 分支上。 在此之前，我们要先简介一下ECALL指令和stvec（Supervisor Trap Vector B">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://rinevard.github.io/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/stvec.png">
<meta property="og:image" content="http://rinevard.github.io/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/debug_start.png">
<meta property="og:image" content="http://rinevard.github.io/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/sleep_main.png">
<meta property="og:image" content="http://rinevard.github.io/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/sleep_jal_atoi.png">
<meta property="og:image" content="http://rinevard.github.io/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/sleep_jal_sleep.png">
<meta property="og:image" content="http://rinevard.github.io/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/usys_enter.png">
<meta property="og:image" content="http://rinevard.github.io/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/print_stvec.png">
<meta property="og:image" content="http://rinevard.github.io/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/stvec.png">
<meta property="og:image" content="http://rinevard.github.io/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/break_ecall_target.png">
<meta property="og:image" content="http://rinevard.github.io/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/ecall.png">
<meta property="og:image" content="http://rinevard.github.io/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/trapoline_enter.png">
<meta property="og:image" content="http://rinevard.github.io/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/trapoline_jump.png">
<meta property="og:image" content="http://rinevard.github.io/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/usertrap_enter.png">
<meta property="og:image" content="http://rinevard.github.io/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/usertrap_jump.png">
<meta property="og:image" content="http://rinevard.github.io/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/syscall_enter.png">
<meta property="og:image" content="http://rinevard.github.io/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/syssleep_enter.png">
<meta property="og:image" content="http://rinevard.github.io/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/syssleep_return.png">
<meta property="og:image" content="http://rinevard.github.io/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/usertrapret_enter.png">
<meta property="og:image" content="http://rinevard.github.io/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/usertrapret_break.png">
<meta property="og:image" content="http://rinevard.github.io/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/usertrapret_jump.png">
<meta property="og:image" content="http://rinevard.github.io/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/trapoline_enter_again.png">
<meta property="og:image" content="http://rinevard.github.io/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/trapoline_ret_user.png">
<meta property="og:image" content="http://rinevard.github.io/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/hello_world_again.png">
<meta property="og:image" content="http://rinevard.github.io/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/return_to_user.png">
<meta property="og:image" content="http://rinevard.github.io/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/im_back.png">
<meta property="article:published_time" content="2025-10-15T08:02:38.000Z">
<meta property="article:modified_time" content="2025-10-15T08:09:51.505Z">
<meta property="article:author" content="Rinevard">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://rinevard.github.io/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/stvec.png">
                            

                                

                                        
                                            <link rel="icon" href="/images/jurorara.png" />
                                            

                                                
<link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">

                                                    
<link rel="stylesheet" href="/libs/open-sans/styles.css">

                                                        
<link rel="stylesheet" href="/libs/source-code-pro/styles.css">


                                                            
<link rel="stylesheet" href="/css/style.css">


                                                                <!-- TOC Sidebar CSS -->
                                                                
                                                                    
<link rel="stylesheet" href="/css/toc-sidebar.css">

                                                                        

                                                                            <!-- Medium Zoom CSS -->
                                                                            
<link rel="stylesheet" href="/css/medium-zoom.css">


                                                                                
<script src="/libs/jquery/2.1.3/jquery.min.js"></script>


                                                                                    <script
                                                                                        src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>
                                                                                    <script>
                                                                                        if (Cookies.get('sidebarHidden') === 'true') {
                                                                                            document.documentElement.classList.add('sidebar-hidden');
                                                                                        }
                                                                                    </script>

                                                                                    
    
                
                            
                                        
                                                
                                                            
                                                                                        

                                                                                                <!-- PrismJS assets -->
                                                                                                <!-- use light theme -->
                                                                                                <link rel="stylesheet"
                                                                                                    href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" />
                                                                                                <link rel="stylesheet"
                                                                                                    href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />
                                                                                                <script defer
                                                                                                    src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
                                                                                                <script defer
                                                                                                    src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
                                                                                                <link rel="stylesheet"
                                                                                                    href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.css" />
                                                                                                <script defer
                                                                                                    src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.js"></script>
                                                                                                <script defer
                                                                                                    src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js"></script>
                                                                                                <!-- Custom Prism copy button styling -->
                                                                                                
<link rel="stylesheet" href="/css/prism-copy-button.css">

                                                                                                    <!-- configure autoloader before it loads -->
                                                                                                    <script>
                                                                                                        window.Prism = window.Prism || {};
                                                                                                        Prism.plugins = Prism.plugins || {};
                                                                                                        Prism.plugins.autoloader = Prism.plugins.autoloader || {};
                                                                                                        Prism.plugins.autoloader.languages_path = 'https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/';
                                                                                                    </script>
                                                                                                    <script defer
                                                                                                        src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
                                                                                                    <!-- Custom Prism copy button JavaScript -->
                                                                                                    <script defer
                                                                                                        src="/js/prism-copy-button.js"></script>

                                                                                                    <!-- Medium Zoom for Images -->
                                                                                                    <script defer
                                                                                                        src="/libs/medium-zoom/medium-zoom.min.js"></script>
                                                                                                    <script defer
                                                                                                        src="/js/medium-zoom-init.js"></script>
    <meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Rinevard" type="application/atom+xml">
</head>

    <body>
        <div id="container">
            <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">Rinevard</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/">首页</a>
                
                    <a class="main-nav-link" href="/archives">文章历史</a>
                
                    <a class="main-nav-link" href="/about">关于我</a>
                
            </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="想要查找什么..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>


</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/">首页</a></td>
                
                    <td><a class="main-nav-link" href="/archives">文章历史</a></td>
                
                    <td><a class="main-nav-link" href="/about">关于我</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

                <div class="outer">
                    
                                <section id="main"><article id="post-learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process" class="article article-type-post" itemscope
    itemprop="blogPost">
    <div class="article-inner">
        
                    
                        <header class="article-header">
                            
                                <div class="article-meta">
                                    
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/">公开课</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/MIT-6-S081/">MIT-6.S081</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/MIT-6-S081/Labs/">Labs</a>
    </div>

                                        
                                            
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/wiki/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/">
            <time datetime="2025-10-15T08:02:38.000Z" itemprop="datePublished">2025-10-15</time>
        </a>
    </div>


                                                
                                                        
                                </div>
                                
                                    
    
        <h1 class="article-title" itemprop="name">
            Lab 2.1 系统调用流程——以sleep为例
        </h1>
    

                        </header>
                        
                            
                                <div class="article-entry" itemprop="articleBody">
                                    
                                        
                                                                                                                
                                                                                                                    <!-- 原始目录隐藏，但保留供JS获取结构 -->
                                                                                                                    <div id="toc"
                                                                                                                        class="toc-article"
                                                                                                                        style="display: none;">
                                                                                                                        <strong
                                                                                                                            class="toc-title">
                                                                                                                            文章目录
                                                                                                                        </strong>
                                                                                                                        
                                                                                                                    </div>
                                                                                                                    
                                                                                                                        <p>我们知道应用程序在User mode下运行，而系统函数的执行需要Supervisor mode，那在系统调用时，User mode是怎么进入Supervisor mode的呢？我们以sleep的执行为例，看看都发生了什么。首先我们用 <code>git checkout util</code> 切换到 util 分支上。</p>
<p>在此之前，我们要先简介一下<strong>ECALL</strong>指令和<strong>stvec</strong>（Supervisor Trap Vector Base Address Register）寄存器。</p>
<p>ECALL 会触发一个异常，如果我们在用户态触发这个异常，程序计数器 pc 就会根据 stvec 进行跳转，到达异常处理处。</p>
<p>以下是 <a target="_blank" rel="noopener" href="https://www.scs.stanford.edu/~zyedidia/docs/riscv/riscv-privileged.pdf">risc-v 手册</a> 对 ECALL 的解释：</p>
<blockquote>
<p>When executed in U-mode, S-mode, or M-mode, it generates an environment-call-from-U-mode exception, environment-call-from-S-mode exception, or environment-call-from-M-mode exception, respectively, and performs no other operation.</p>
<p>如果在 U-mode 执行，ECALL 指令会产生一个来自 U-mode 的环境调用异常；如果在 S-mode 执行，则产生来自 S-mode 的环境调用异常；如果在 M-mode 执行，则产生来自 M-mode 的环境调用异常。</p>
</blockquote>
<p>以下是 risc-v 手册对 stvec 寄存器的简介：</p>
<p><img src="/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/stvec.png" alt=""></p>
<p>BASE是4字节对齐的（RISC-V 手册 P80），所以在MODE == 0时，我们跳转到的地址是 <code>(stvec &gt;&gt; 2) &lt;&lt; 2</code>，而由于 MODE == 0，这个值就是 stvec ；在MODE == 1时，我们转到的地址是 <code>(stvec &gt;&gt; 2) &lt;&lt; 2 + 4*cause</code></p>
<p>接下来我们就可以开始看看系统调用时究竟发生了什么！我们会以sleep为例。</p>
<p>首先我们打开gdb-multiarch（参考 Note 0 的”用终端调试“），然后用 <code>set prompt \\001\\033[1;33m\\002(gdb) \\001\\033[0m\\002</code> 来高亮 “(gdb)” 以方便观察自己的输入。</p>
<p>用 <code>file user/_sleep</code> 切换到用户符号表，接着用<code>c</code>运行到xv6的shell启动。</p>
<p>观察右边的终端可以看到shell已经成功启动了。</p>
<p><img src="/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/debug_start.png" alt=""></p>
<p>然后我们在gdb里按下ctrl+c来中断，并用 <code>b main</code> 设置断点，再使用 <code>layout split</code> 让gdb显示出源码和汇编代码。接下来我们在gdb里输入 <code>c</code> 以让xv6继续执行，否则xv6的shell会处于暂停状态，不能处理输入。</p>
<p>然后在xv6的shell里执行 <code>sleep 1</code> ，它会在断点处停下。</p>
<p>观察左边的gdb，可以看到它停在了sleep.c的main函数。</p>
<p><img src="/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/sleep_main.png" alt=""></p>
<p>随便执行一下直到到达sleep这行，<code>n</code> 表示执行一行c语言，<code>si</code>表示执行一个汇编语句。</p>
<p><img src="/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/sleep_jal_atoi.png" alt=""></p>
<p>我们用<code>si</code>进入atoi，然后交替着用<code>n</code>和<code>si</code>，在快到return时用<code>si</code>，就能离开atoi回到sleep.c。</p>
<p>观察左边的gdb，和上图相比，虽然c语言的位置没有变化，但汇编代码的位置是有变化的。</p>
<p><img src="/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/sleep_jal_sleep.png" alt=""></p>
<p>之后用<code>si</code>，会发现我们跳转到了 <code>usys.S</code>，它把sleep的系统调用号放到寄存器a7里，然后借助ecall来执行系统调用。</p>
<p>观察左边的gdb发现我们已经进入了<code>usys.S</code></p>
<p><img src="/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/usys_enter.png" alt=""></p>
<p>如果我们直接用几个<code>si</code>，会发现<code>ecall</code>并没有像<code>jal</code>之类的跳转语句一样带我们到一些神奇的地方，而是直接到了下一行。这是因为<code>ecall</code>不是跳转，而是抛出了一个异常，内核自动处理了异常。</p>
<p>这样看来，我们要找到这个异常的开始处并设置断点才行。还记得我们之前说过<code>ecall</code>抛出异常时pc会跳转到哪里吗？答案是它会根据寄存器stvec的值进行跳转。让我们借助<code>p /x $stvec</code>看看stvec的值。</p>
<p>观察左边的gdb，发现stvec的值是 0x3ffffff000，至少在我这里是这样。</p>
<p><img src="/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/print_stvec.png" alt=""></p>
<p>回顾一下stvec寄存器的结构和功能，会发现执行ecall后，pc会跳转到BASE所在的地址。我们之前说过，BASE是4字节对齐的（RISC-V 手册 P80），所以在MODE == 0时，我们跳转到的地址是 <code>(stvec &gt;&gt; 2) &lt;&lt; 2</code>，而由于 MODE == 0，这个值就是 stvec。</p>
<p><img src="/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/stvec.png" alt=""></p>
<p>我们接下来把断点设置在这个值，然后用<code>si</code>到达<code>ecall</code>语句处</p>
<p>观察左边的gdb，我们现在已经在<code>ecall</code>这里了。</p>
<p><img src="/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/break_ecall_target.png" alt=""></p>
<p>如果我们的操作正确，接下来的<code>si</code>会触发一个异常导致我们跳转到 0x3ffffff000 并触发断点，希望我们没有翻车~</p>
<p>观察左边的gdb，发现我们成功跳转到了一个未知的地方！</p>
<p>按我的理解，由于我们在U-mode下执行ecall以触发异常，所以我们现在已经进入了S-mode。不过我翻了很多资料还是没有找到能明确支持这一点的证据（也没有找到明确反对的证据），所以我保留我的观点。</p>
<p><img src="/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/ecall.png" alt=""></p>
<p>总之一切顺利！让我们暂停一下，想想这个 0x3ffffff000 的地址代表什么。在内核启动时通过<code>file kernel/kernel</code> 加载内核符号表并在<code>usertrapret</code>设置断点，我们可以发现 0x3ffffff000 这个地址和 <code>kernel/trap.c</code> 里的<code>trampoline_uservec</code> 相等。</p>
<p>trampoline是什么？trampoline是在进程虚拟内存的顶部的一块空间，映射到的物理地址存放着跳转进和跳转出内核的代码。看起来在做系统调用时，我们通过ecall跳转进内核。这样一切都说得通了~</p>
<p>让我们打开trampoline.S，对比左边gdb显示的代码和右边的trampoline.S，会发现它们确实能对上！</p>
<p>好吧，也不是完全能对上，你会注意到右边的 <code>li a0,TRAPFRAME</code> 在左边似乎对应了三条语句，这是怎么回事呢？实际上，<code>li</code> 是RISC-V 汇编中的伪指令，实际执行时，<code>li</code> 会被汇编器翻译为一条或多条真正的 RISC-V 指令。</p>
<p>嗯，这样就能对上了！</p>
<p><img src="/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/trapoline_enter.png" alt=""></p>
<p>读一读trampoline.S，我们发现它会把用户进程的寄存器等信息保存到trapframe里，然后跳转到内核的usertrap函数。</p>
<p>因此接下来我们要用<code>file kernel/kernel</code>把符号表切换到kernel，再用<code>si n</code> 来一次执行多条汇编语句，直到指令<code>jr</code>处：</p>
<p>比较左边和右边，发现它们的汇编代码确实能对上，接下来我们要准备跳转了。</p>
<p><img src="/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/trapoline_jump.png" alt=""></p>
<p>陷阱，启动！</p>
<p><img src="/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/usertrap_enter.png" alt=""></p>
<p>如果你发现你的gdb没有顺利显示出c语言代码，可能是你忘记切换符号表到内核了，用<code>file kernel/kernel</code>来切换，然后补一个<code>si</code>就能显示出来了。</p>
<p>由于一切正常，我们可以一路按<code>n</code>直到到达syscall这里。</p>
<p>比较左边和右边的代码，它们是能对应上的。接下来让我们准备进入<code>syscall</code></p>
<p><img src="/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/usertrap_jump.png" alt=""></p>
<p>我们用<code>s</code>进入syscall函数。<code>n</code>和<code>s</code>都会执行当前行，不过如果当前行是函数，<code>n</code>不会进入函数，而<code>s</code>会。</p>
<p><img src="/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/syscall_enter.png" alt=""></p>
<p>syscall函数从trapframe中取出系统调用号，然后调用它。还记得吗，我们调用系统函数时先进入了usys.S，然后把系统调用号保存到了a7。之后由于我们转入了内核，我们在trapoline.S里把所有的用户空间的寄存器都保存到了trapframe中。</p>
<p>总之我们在这里调用了sys_sleep，我们进入它看看。</p>
<p><img src="/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/syssleep_enter.png" alt=""></p>
<p>可以发现它就是真正干活的地方！它非常忠实地执行了sleep的逻辑。</p>
<p>我们可以注意到 n 就是存放着我们最开始传入的参数的变量，内核通过argint来找到我们一开始传入的参数。argint的思路和我们之前找到系统调用号类似，也是从trapframe中找到存放着传入参数的寄存器。</p>
<p>让我们继续往后，看看在执行完逻辑以后发生了什么吧。</p>
<p><img src="/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/syssleep_return.png" alt=""></p>
<p>回到<code>usertrap</code>，我们一路往下到达<code>usertrapret</code>，然后用<code>s</code>进入它。</p>
<p><img src="/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/usertrapret_enter.png" alt=""></p>
<p>看函数名上面的注释就能发现它会带我们回到用户空间。</p>
<p>我们用<code>n</code>一路运行到底，再看看注释，发现注释说我们会跳转到trampoline.S。</p>
<p>观察左边的gdb，<code>p /x trampoline_userret</code> 没有打印值是因为trampoline_userret被编译器优化掉了，我们要手动把它的表达式写出来再打印，总之我们打印出了 0x3ffffff09c。</p>
<p>在那里设个断点，然后准备继续。</p>
<p><img src="/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/usertrapret_break.png" alt=""></p>
<p>多按几个<code>si</code> 到达跳转语句处，不出意外的话再用一次<code>si</code> 就会带我们进入trapoline.S的userret部分了。</p>
<p><img src="/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/usertrapret_jump.png" alt=""></p>
<p>一切的一切都符合预期，我们成功进入了trampoline.S。</p>
<p>对比左右的汇编代码可以发现它们是对应的。与之前相同，<code>li</code>被展开了。</p>
<p><img src="/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/trapoline_enter_again.png" alt=""></p>
<p>然后我们一路按<code>si</code>到达<code>sret</code>语句处。<code>sret</code>会做什么呢？让我们看看riscv手册：</p>
<blockquote>
<p>The SRET instruction is used to return from a trap taken into S-mode. […] When executing SRET, the privilege level is set to the value in the SPP field of the sstatus register; […] the pc is set to the value stored in the sepc register.</p>
<p><code>SRET</code> 指令用于从进入 S-mode 的陷阱中返回。[…] 当执行 <code>SRET</code> 时，特权级别被设置为<code>sstatus</code> 寄存器中 <code>SPP</code> 字段的值；[…] 程序计数器 pc 被设置为存储在 <code>sepc</code> 寄存器中的值。</p>
</blockquote>
<p>我们借助 <code>p /x sepc</code> 打印这个寄存器的值看看~（请忽视左图里我之前写成spec的手误）</p>
<p><img src="/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/trapoline_ret_user.png" alt=""></p>
<p>0x342是什么？如果你记忆力很好的话，会发现它恰好就是usys.S里的<code>ret</code>那行！</p>
<p>（这鬼才记得住啊喂）</p>
<p>总之我们看看之前的截图吧，我们可以发现0x342确实是ret那行，就是下面的截图中高亮的汇编代码下面那行。</p>
<p><img src="/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/hello_world_again.png" alt=""></p>
<p>我们用<code>b *0x342</code>设个断点在那里，然后执行<code>si</code> ，我们回到了用户空间！同时，<code>sret</code>也让我们回到了U-mode。</p>
<p><img src="/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/return_to_user.png" alt=""></p>
<p>用<code>file user/_sleep</code>切换符号表，再执行<code>si</code>，我们回来了。</p>
<p><img src="/images/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/im_back.png" alt=""></p>
<p>至此，我们就完成了一个完整的系统调用。</p>
<p>总结一下，当我们进行系统调用时，我们先进入usys.S，然后ecall触发异常并跳转到trapoline.S的uservec处，之后到达trap.c的usertrap函数，它会调用syscall函数以执行系统函数的逻辑，执行完后进入usertrapret函数，再跳转到trapoline.S的userret处，最后回到usys.S，再回到用户的代码里。</p>
<p>第一次跳转到trapoline.S主要是保存了用户的各个寄存器到trapframe，第二次跳转是从trapframe中恢复了这些寄存器。</p>

                                                                                                                            
                                                                                                                                
                                </div>
                                <footer class="article-footer">
                                </footer>
    </div>
</article>


    
<nav id="article-nav">
    
        <a href="/wiki/others/translation/%E4%B8%83%E5%A4%A9%E5%8E%9F%E5%9E%8B/" id="article-nav-newer" class="article-nav-link-wrap">
            <strong class="article-nav-caption">上一篇</strong>
            <div class="article-nav-title">
                
                    如何在七天内制作游戏原型
                
            </div>
        </a>
    
    
        <a href="/wiki/learning/open-course/MIT-6.S081/Labs/lab2-syscall/" id="article-nav-older" class="article-nav-link-wrap">
            <strong class="article-nav-caption">下一篇</strong>
            <div class="article-nav-title">Lab 2 System calls</div>
        </a>
    
</nav>


        

            
                 
<section id="comments">
  <div class="giscus"></div>
  <script src="https://giscus.app/client.js" data-repo="rinevard/rinevard.github.io"
    data-repo-id="R_kgDOLkoe9A" data-category="Announcements"
    data-category-id="DIC_kwDOLkoe9M4CjJnR" data-mapping="pathname" data-reactions-enabled="1"
    data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN"
    data-loading="lazy" crossorigin="anonymous" async></script>
  </section>
 

                    

                        
                            <!-- baidu url auto push script -->
                            <script type="text/javascript">
                                !function () { var e = /([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi, r = window.location.href, o = document.referrer; if (!e.test(r)) { var n = "//api.share.baidu.com/s.gif"; o ? (n += "?r=" + encodeURIComponent(document.referrer), r && (n += "&l=" + r)) : r && (n += "?l=" + r); var t = new Image; t.src = n } }(window);
                            </script>
                            </section>
                                
                                    <aside id="sidebar">
    <div class="sidebar-content">
        
            
    <div class="widget-wrap" id='categories'>
        <h3 class="widget-title">
            <span>文章</span>
        </h3>

        <div class="widget categories-widget">
            

                

                        
                            
                                
                    <ul class="unstyled" id="tree" >
                            
                                <li class="directory">
                                    <a href="#" data-role="directory">
                                        <i
                                            class="fa fa-folder"></i>
                                        gamejam
                                    </a>
                                    
                    <ul class="unstyled" id="tree" >
                            
                                    <li class="file">
                                        <a href="/wiki/game-design/ldjam%E5%8F%82%E8%B5%9B%E6%8C%87%E5%8D%97/">
                                            <i class="fa fa-file-text-o"></i>
                                            Ludum Dare参加指南
                                        </a>
                                    </li>
                                    
                    </ul>
                    
                                </li>
                                
                                <li class="directory open">
                                    <a href="#" data-role="directory">
                                        <i
                                            class="fa fa-folder-open"></i>
                                        公开课
                                    </a>
                                    
                    <ul class="unstyled" id="tree" >
                            
                                <li class="directory">
                                    <a href="#" data-role="directory">
                                        <i
                                            class="fa fa-folder"></i>
                                        GAMES101
                                    </a>
                                    
                    <ul class="unstyled" id="tree" >
                            
                                <li class="directory">
                                    <a href="#" data-role="directory">
                                        <i
                                            class="fa fa-folder"></i>
                                        Assignments
                                    </a>
                                    
                    <ul class="unstyled" id="tree" >
                            
                                    <li class="file">
                                        <a href="/wiki/learning/open-course/GAMES101/Hw/Hw1-transformation/">
                                            <i class="fa fa-file-text-o"></i>
                                            Assignment 1 Transformation
                                        </a>
                                    </li>
                                    
                                    <li class="file">
                                        <a href="/wiki/learning/open-course/GAMES101/Hw/Hw2-rasterizing/">
                                            <i class="fa fa-file-text-o"></i>
                                            Assignment 2 Rasterizing
                                        </a>
                                    </li>
                                    
                                    <li class="file">
                                        <a href="/wiki/learning/open-course/GAMES101/Hw/Hw3-pipeline-and-shading/">
                                            <i class="fa fa-file-text-o"></i>
                                            Assignment 3 Pipeline and Shading
                                        </a>
                                    </li>
                                    
                                    <li class="file">
                                        <a href="/wiki/learning/open-course/GAMES101/Hw/Hw4-geometry/">
                                            <i class="fa fa-file-text-o"></i>
                                            Assignment 4 Geometry
                                        </a>
                                    </li>
                                    
                                    <li class="file">
                                        <a href="/wiki/learning/open-course/GAMES101/Hw/Hw5-raytracing/">
                                            <i class="fa fa-file-text-o"></i>
                                            Assignment 5 Raytracing
                                        </a>
                                    </li>
                                    
                                    <li class="file">
                                        <a href="/wiki/learning/open-course/GAMES101/Hw/Hw6-bounding-box/">
                                            <i class="fa fa-file-text-o"></i>
                                            Assignment 6 Bounding Box
                                        </a>
                                    </li>
                                    
                                    <li class="file">
                                        <a href="/wiki/learning/open-course/GAMES101/Hw/Hw7-path-tracing/">
                                            <i class="fa fa-file-text-o"></i>
                                            Assignment 7 Path Tracing
                                        </a>
                                    </li>
                                    
                    </ul>
                    
                                </li>
                                
                                <li class="directory">
                                    <a href="#" data-role="directory">
                                        <i
                                            class="fa fa-folder"></i>
                                        Notes
                                    </a>
                                    
                    <ul class="unstyled" id="tree" >
                            
                                    <li class="file">
                                        <a href="/wiki/learning/open-course/GAMES101/Notes/Note1-transformation/">
                                            <i class="fa fa-file-text-o"></i>
                                            Note 1 Transformation
                                        </a>
                                    </li>
                                    
                                    <li class="file">
                                        <a href="/wiki/learning/open-course/GAMES101/Notes/Note2-Rasterizing/">
                                            <i class="fa fa-file-text-o"></i>
                                            Note 2 Rasterizing
                                        </a>
                                    </li>
                                    
                                    <li class="file">
                                        <a href="/wiki/learning/open-course/GAMES101/Notes/Note3-Shading/">
                                            <i class="fa fa-file-text-o"></i>
                                            Note 3 Shading
                                        </a>
                                    </li>
                                    
                                    <li class="file">
                                        <a href="/wiki/learning/open-course/GAMES101/Notes/Note4-Geometry/">
                                            <i class="fa fa-file-text-o"></i>
                                            Note 4 Geometry
                                        </a>
                                    </li>
                                    
                                    <li class="file">
                                        <a href="/wiki/learning/open-course/GAMES101/Notes/Note5-RayTracing/">
                                            <i class="fa fa-file-text-o"></i>
                                            Note 5 RayTracing
                                        </a>
                                    </li>
                                    
                                    <li class="file">
                                        <a href="/wiki/learning/open-course/GAMES101/Notes/Note6-BRDF-and-renderingequation/">
                                            <i class="fa fa-file-text-o"></i>
                                            Note 6 BRDF and Rendering Eequation
                                        </a>
                                    </li>
                                    
                    </ul>
                    
                                </li>
                                
                    </ul>
                    
                                </li>
                                
                                <li class="directory open">
                                    <a href="#" data-role="directory">
                                        <i
                                            class="fa fa-folder-open"></i>
                                        MIT-6.S081
                                    </a>
                                    
                    <ul class="unstyled" id="tree" >
                            
                                <li class="directory open">
                                    <a href="#" data-role="directory">
                                        <i
                                            class="fa fa-folder-open"></i>
                                        Labs
                                    </a>
                                    
                    <ul class="unstyled" id="tree" >
                            
                                    <li class="file">
                                        <a href="/wiki/learning/open-course/MIT-6.S081/Labs/lab1-util/">
                                            <i class="fa fa-file-text-o"></i>
                                            Lab 1 Xv6 and Unix utilities
                                        </a>
                                    </li>
                                    
                                    <li class="file">
                                        <a href="/wiki/learning/open-course/MIT-6.S081/Labs/lab2-syscall/">
                                            <i class="fa fa-file-text-o"></i>
                                            Lab 2 System calls
                                        </a>
                                    </li>
                                    
                                    <li class="file active">
                                        <a href="/wiki/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/">
                                            <i class="fa fa-file-text-o"></i>
                                            Lab 2.1 系统调用流程——以sleep为例
                                        </a>
                                    </li>
                                    
                    </ul>
                    
                                </li>
                                
                                <li class="directory">
                                    <a href="#" data-role="directory">
                                        <i
                                            class="fa fa-folder"></i>
                                        Notes
                                    </a>
                                    
                    <ul class="unstyled" id="tree" >
                            
                                    <li class="file">
                                        <a href="/wiki/learning/open-course/MIT-6.S081/Notes/note1-sys-interface/">
                                            <i class="fa fa-file-text-o"></i>
                                            第一章——系统接口
                                        </a>
                                    </li>
                                    
                    </ul>
                    
                                </li>
                                
                                    <li class="file">
                                        <a href="/wiki/learning/open-course/MIT-6.S081/BeforeStory/">
                                            <i class="fa fa-file-text-o"></i>
                                            在开始之前
                                        </a>
                                    </li>
                                    
                    </ul>
                    
                                </li>
                                
                                    <li class="file">
                                        <a href="/wiki/learning/open-course/%E8%BF%99%E6%98%AF%E5%93%AA%E9%87%8C/">
                                            <i class="fa fa-file-text-o"></i>
                                            这里有什么？
                                        </a>
                                    </li>
                                    
                    </ul>
                    
                                </li>
                                
                                <li class="directory">
                                    <a href="#" data-role="directory">
                                        <i
                                            class="fa fa-folder"></i>
                                        杂谈
                                    </a>
                                    
                    <ul class="unstyled" id="tree" >
                            
                                <li class="directory">
                                    <a href="#" data-role="directory">
                                        <i
                                            class="fa fa-folder"></i>
                                        二次元
                                    </a>
                                    
                    <ul class="unstyled" id="tree" >
                            
                                    <li class="file">
                                        <a href="/wiki/others/animation/%E6%AF%8D%E9%B8%A1%E5%8D%A1%E7%9A%84%E5%90%84%E7%A7%8D%E7%A5%9E%E5%A5%87%E5%81%87%E8%8D%AF/">
                                            <i class="fa fa-file-text-o"></i>
                                            母鸡卡的各种神奇假药
                                        </a>
                                    </li>
                                    
                    </ul>
                    
                                </li>
                                
                                <li class="directory">
                                    <a href="#" data-role="directory">
                                        <i
                                            class="fa fa-folder"></i>
                                        碎碎念
                                    </a>
                                    
                    <ul class="unstyled" id="tree" >
                            
                                    <li class="file">
                                        <a href="/wiki/others/thoughts/datalab%E5%92%8C%E6%88%91/">
                                            <i class="fa fa-file-text-o"></i>
                                            _Datalab和我
                                        </a>
                                    </li>
                                    
                                    <li class="file">
                                        <a href="/wiki/others/thoughts/%E7%8E%A9%E4%B9%90%E7%9A%84%E4%BA%BA/">
                                            <i class="fa fa-file-text-o"></i>
                                            _玩乐的人
                                        </a>
                                    </li>
                                    
                                    <li class="file">
                                        <a href="/wiki/others/thoughts/%E7%BD%91%E4%B8%8A%E5%86%B2%E6%B5%AA/">
                                            <i class="fa fa-file-text-o"></i>
                                            慢慢地冲浪
                                        </a>
                                    </li>
                                    
                                    <li class="file">
                                        <a href="/wiki/others/thoughts/%E6%88%91%E4%B9%9F%E6%83%B3%E5%81%9A%E5%87%BA%E4%BC%98%E7%A7%80%E7%9A%84%E4%BD%9C%E5%93%81/">
                                            <i class="fa fa-file-text-o"></i>
                                            _我也想做出优秀的作品
                                        </a>
                                    </li>
                                    
                                    <li class="file">
                                        <a href="/wiki/others/thoughts/%E6%8E%A2%E7%B4%A2%E6%97%A5%E5%BF%970/">
                                            <i class="fa fa-file-text-o"></i>
                                            探索日志[0]
                                        </a>
                                    </li>
                                    
                                    <li class="file">
                                        <a href="/wiki/others/thoughts/%E6%8E%A2%E7%B4%A2%E6%97%A5%E5%BF%971/">
                                            <i class="fa fa-file-text-o"></i>
                                            探索日志[1]
                                        </a>
                                    </li>
                                    
                    </ul>
                    
                                </li>
                                
                                <li class="directory">
                                    <a href="#" data-role="directory">
                                        <i
                                            class="fa fa-folder"></i>
                                        翻译
                                    </a>
                                    
                    <ul class="unstyled" id="tree" >
                            
                                    <li class="file">
                                        <a href="/wiki/others/translation/%E4%B8%83%E5%A4%A9%E5%8E%9F%E5%9E%8B/">
                                            <i class="fa fa-file-text-o"></i>
                                            如何在七天内制作游戏原型
                                        </a>
                                    </li>
                                    
                    </ul>
                    
                                </li>
                                
                    </ul>
                    
                                </li>
                                
                                <li class="directory">
                                    <a href="#" data-role="directory">
                                        <i
                                            class="fa fa-folder"></i>
                                        游戏设计
                                    </a>
                                    
                    <ul class="unstyled" id="tree" >
                            
                                    <li class="file">
                                        <a href="/wiki/game-design/%E5%AF%B9%E6%8E%A2%E7%B4%A2%E7%B1%BB%E6%B8%B8%E6%88%8F%E7%9A%84%E6%80%9D%E8%80%83/">
                                            <i class="fa fa-file-text-o"></i>
                                            对探索类游戏的思考
                                        </a>
                                    </li>
                                    
                                    <li class="file">
                                        <a href="/wiki/game-design/%E5%86%B0%E5%B1%B1%E4%B9%8B%E4%B8%8B%E7%9A%84%E6%B7%B1%E5%BA%A6/">
                                            <i class="fa fa-file-text-o"></i>
                                            技巧的分类，冰山之下的深度
                                        </a>
                                    </li>
                                    
                                    <li class="file">
                                        <a href="/wiki/game-design/%E6%9D%80%E6%88%AE%E5%B0%96%E5%A1%94%E6%A1%86%E6%9E%B6/">
                                            <i class="fa fa-file-text-o"></i>
                                            杀戮尖塔的框架如此自洽，我们能离开它吗？
                                        </a>
                                    </li>
                                    
                    </ul>
                    
                                </li>
                                
                                    <li class="file">
                                        <a href="/">
                                            <i class="fa fa-file-text-o"></i>
                                            欢迎！
                                        </a>
                                    </li>
                                    
                    </ul>
                    
                                    
        </div>
    </div>

    <script>
        $(document).ready(function () {
            var iconFolderOpenClass = 'fa-folder-open';
            var iconFolderCloseClass = 'fa-folder';

            // Handle directory-tree expansion:
            // 左键单独展开目录
            $(document).on('click', '#categories a[data-role="directory"]', function (event) {
                event.preventDefault();

                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconFolderOpenClass);
                var subtree = $(this).siblings('ul');
                icon.removeClass(iconFolderOpenClass).removeClass(iconFolderCloseClass);

                if (expanded) {
                    if (typeof subtree != 'undefined') {
                        subtree.slideUp({ duration: 100 });
                    }
                    icon.addClass(iconFolderCloseClass);
                } else {
                    if (typeof subtree != 'undefined') {
                        subtree.slideDown({ duration: 100 });
                    }
                    icon.addClass(iconFolderOpenClass);
                }
            });

            // 右键展开下属所有目录
            $('#categories a[data-role="directory"]').bind("contextmenu", function (event) {
                event.preventDefault();

                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconFolderOpenClass);
                var listNode = $(this).siblings('ul');
                var subtrees = $.merge(listNode.find('li ul'), listNode);
                var icons = $.merge(listNode.find('.fa'), icon);
                icons.removeClass(iconFolderOpenClass).removeClass(iconFolderCloseClass);

                if (expanded) {
                    subtrees.slideUp({ duration: 100 });
                    icons.addClass(iconFolderCloseClass);
                } else {
                    subtrees.slideDown({ duration: 100 });
                    icons.addClass(iconFolderOpenClass);
                }
            });
        });
    </script>
    
        
    </div>
</aside>
                                        
                </div>
                <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            Rinevard &copy; 2025
                    <a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc-nd/4.0/">CC BY-NC-ND 4.0</a>
                    <br> Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme - <a
                        href="https://github.com/rinevard" target="_blank">Rinekitten</a>
                    
        </div>
    </div>
</footer>
                    
    
                                                                
                                                                                                            
                                                                                                                        
                                                                                                                            <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true,
            TeX: {
                equationNumbers: {
                  autoNumber: 'AMS'
                }
            }
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
                                                                                                                                
                                                                                                                                    

        <!-- Custom Scripts -->
        
<script src="/js/main.js"></script>

            
                <!-- Notion风格目录JS -->
                
<script src="/js/toc-sidebar.js"></script>

                    
                        
<script src="/js/sidebar.js"></script>

        </div>

        <!-- 固定在左下角的侧边栏切换按钮 -->
        <div id="sidebar-toggle-btn">
            <i class="fa fa-angle-double-left"></i>
        </div>

        <!-- 回到顶部按钮 -->
        <div id="toTop" title="回到顶部">
            <i class="fa fa-arrow-up"></i>
        </div>

        <script>
            $(document).ready(function () {
                // 回到顶部按钮功能
                $(window).scroll(function () {
                    if ($(this).scrollTop() > 200) {
                        $('#toTop').fadeIn();
                    } else {
                        $('#toTop').fadeOut();
                    }
                });

                $('#toTop').click(function () {
                    $('html, body').animate({
                        scrollTop: 0
                    }, 400);
                    return false;
                });
            });
        </script>
    </body>

    </html>