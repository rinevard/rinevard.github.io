<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Rinevard</title>
  
  
  <link href="http://rinevard.github.io/atom.xml" rel="self"/>
  
  <link href="http://rinevard.github.io/"/>
  <updated>2026-01-30T14:26:47.276Z</updated>
  <id>http://rinevard.github.io/</id>
  
  <author>
    <name>Rinevard</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>æ¢ç´¢æ—¥å¿—[6]</title>
    <link href="http://rinevard.github.io/wiki/others/thoughts/%E6%8E%A2%E7%B4%A2%E6%97%A5%E5%BF%976/"/>
    <id>http://rinevard.github.io/wiki/others/thoughts/%E6%8E%A2%E7%B4%A2%E6%97%A5%E5%BF%976/</id>
    <published>2026-01-30T14:18:35.000Z</published>
    <updated>2026-01-30T14:26:47.276Z</updated>
    
    <content type="html"><![CDATA[<p>äº‹å…ˆå£°æ˜ï¼Œæˆ‘å¯¹æŠŠ LLM å¼•å…¥æ¸¸æˆæ²¡æœ‰ç‰¹åˆ«çš„åå¥½ï¼Œåªæ˜¯æ°å·§æœ‰äº†å¾ˆå¤šåš LLM æ¸¸æˆçš„æœºä¼šè€Œå·²ã€‚ğŸ« ğŸ« è¿™å­¦æœŸæˆ‘ä»¬æœ‰è‡ªç„¶è¯­è¨€å¤„ç†è¯¾ï¼Œé‰´èè€å¸ˆéå¸¸å¼€æ˜åœ°ç­”åº”äº†æˆ‘å®è·µä½œä¸šäº¤ LLM æ¸¸æˆçš„è¯·æ±‚ã€‚åœ¨è¿™é‡Œå¤¸å¤¸é‰´èè€å¸ˆï¼Œå¥¹çš„è¯¾æœ‰è¶£è€Œè´´è¿‘å‰æ²¿ã€PPT è´¨é‡é«˜ã€è€ƒè¯•é¢˜ç›®ä¸æ­»è®°ç¡¬èƒŒï¼Œå¯è°“æ˜¯æˆ‘åœ¨åŒ—ç†å­¦è¿‡çš„è´¨é‡å‰ä¸‰çš„è¯¾ç¨‹ã€‚</p><p>æˆ‘åŸæœ¬æ‰“ç®—åšä¸€ä¸ªæ•™å°çŒ«ç©æ¸¸æˆçš„æ¸¸æˆï¼ˆæœ‰è°ä¼šä¸å–œæ¬¢ä¸€åªå¥½å­¦çš„å°çŒ«å‘¢ï¼‰ï¼Œä½†åæ¥å‘ç°æè¿°ç­–ç•¥æ˜¯ä¸€ä»¶å¾ˆéš¾çš„äº‹ï¼Œè€Œä¸” LLM æ—¶ä¸æ—¶å°±ä¸éµå¾ªæ•™å­¦è€Œè®©æˆ‘çº¢æ¸©ï¼Œäºæ˜¯åªèƒ½ä½œç½¢ã€‚ä¸è¿‡å¬å®ƒå«æˆ‘â€œè€å¸ˆâ€è¿˜æ˜¯æŒºæœ‰è¶£çš„ï¼Œæ„Ÿè§‰ LLM è¿˜æ˜¯å¤ªä¼šè®¨å¥½äººç±»äº†ï¼ˆä½ ä»¬åˆ°åº•æŠŠ LLM è°ƒæˆä»€ä¹ˆäº†å•Šï¼ï¼ï¼‰</p><p>æˆ‘åœ¨ 1.18 å¼€å·¥ï¼Œä½œä¸š 1.28 æˆªæ­¢ï¼Œçœ‹èµ·æ¥æ—¶é—´è¿˜æ˜¯æŒºå……è£•çš„ã€‚ä¸è¿‡æˆ‘åˆ° 23 å·ç¡å‰æ‰ä¸‹å®šå†³å¿ƒæŠ›å¼ƒæ•™çŒ«çŒ«çš„æƒ³æ³•å’ŒåŸå‹ï¼Œ24 å·åˆ° 26 å·åˆåœ¨æ·±åœ³ç©ï¼Œæœ€åå°±åªå‰©ä¸‹ 48 å°æ—¶å•äººå¼€å‘äº†ã€‚è‡´æ•¬ä¼ å¥‡æ¸¸æˆå¼€å‘æ´»åŠ¨ Ludum DareğŸ˜‡</p><p>å…¶å®å®é™…æƒ…å†µæ¯” 48 å°æ—¶è¿˜ç³Ÿã€‚æˆ‘åœ¨ 27 å·èŠ±äº†ä¸€æ•´å¤©æ¥æ‰¾æƒ³æ³•ä½†ä¹Ÿæ²¡æƒ³å‡ºä»€ä¹ˆï¼Œæœ€ååªèƒ½é‡Šæ€€åœ°å»ç¡è§‰ã€‚ä¸è¿‡åéªŒåœ°æ¥çœ‹ï¼Œ27 å·ç©çš„ Nicky Case çš„ Crowds å¯¹æœ€ç»ˆæˆå“è¿˜æ˜¯æœ‰ä¸å°‘å½±å“çš„ã€‚</p><p>å¦‚æœæœ‰ 48 å°æ—¶æˆ‘è¿˜èƒ½æŒ£æ‰åœ°è‡ªå·±å†™å†™ä»£ç ï¼Œä½†åªæœ‰ 24 å°æ—¶å°±çœŸçš„ä¸å¾—ä¸ç”¨ AI ç¼–ç¨‹äº†ã€‚å¦‚æœæœ‰ 48 å°æ—¶æˆ‘è¿˜èƒ½æŒ£æ‰åœ°è‡ªå·±æƒ³æƒ³ç©æ³•ï¼Œä½†åªæœ‰ 24 å°æ—¶å°±çœŸçš„ä¸å¾—ä¸ç…§ç€åˆ«äººæŠ„äº†ã€‚è¿˜å¥½æˆ‘è§è¿‡çš„ LLM æ¸¸æˆå¤šï¼Œæˆ‘å¯ä»¥å…ˆæŠ„ä¸ª BV16zKVeLE2Nã€‚è¿™æ˜¯ä¸€ä¸ªç±» UNO çš„æ¸¸æˆï¼Œä½†å¯ä»¥è‡ªå·±å†™è§„åˆ™ã€‚</p><p>ä¸è¿‡æˆ‘ä»¥å‰è¯•ç©å®ƒçš„æ—¶å€™æ„Ÿè§‰ä¸å¤ªæœ‰è¶£ã€‚æˆ‘ä¸å¤ªç¡®å®šä»–ä»¬æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œä½†ä»–ä»¬çš„ LLM è€æ˜¯è¯´â€œè¿™ä¸ªè§„åˆ™å†™ä¸äº†â€ï¼Œäºæ˜¯æˆ‘å°±åªç•™ä¸‹äº†é‚£ä¸ª UNO çš„ç©æ³•ï¼Œè€Œæ˜¯æ‰“ç®—æƒ³æƒ³åˆ«çš„æŠŠ LLM å¡è¿›æ¥çš„æ€è·¯ã€‚æˆ‘æƒ³åˆ°ä»¥å‰ç©ç‚‰çŸ³çš„æ—¶å€™å¾ˆå–œæ¬¢ç¥å¥‡çš„æ™ºæ…§ä¹‹çƒï¼Œå°±æ‰“ç®—åšä¸ªç±»ä¼¼çš„ä¸œè¥¿ã€‚</p><p>åŸè®¡åˆ’æ˜¯è®© LLM è§‚å¯Ÿå±€åŠ¿å¹¶æ—¶ä¸æ—¶æ¥å¸®å¸®å¿™ï¼Œä¸è¿‡ç”±äºæ—¶é—´æœ‰é™å°±åšæˆäº†æ›´ç®€å•çš„å¯¹è¯å½¢å¼ã€‚å¥½è®¾è®¡å…¶å®ä¸€çœ¼å°±èƒ½çœ‹å‡ºæ¥æ˜¯å¥½è®¾è®¡ï¼Œå¯æƒœæ„Ÿè§‰è¿™æ¬¡åªåšäº†ä¸€ä¸ªæ™®æ™®é€šé€šçš„ä¸œè¥¿ï¼Œè¿˜æ˜¯è¦å¤šå¤šç»ƒä¹ æ‰è¡Œã€‚</p><p>æ¼”ç¤ºè§†é¢‘ï¼š<a href="https://rinevard.lanzn.com/i50oK3he6igf#å¯†ç :50g3">https://rinevard.lanzn.com/i50oK3he6igf#å¯†ç :50g3</a></p><p>æœ¬æ¥æƒ³æŠŠè§†é¢‘ä¼ Bç«™ä¸Šï¼Œä½†è¿™æ ·æ™®æ™®é€šé€šçš„ä¸œè¥¿ä¼ ä¸Šå»å¥½åƒä¸å¤ªæœ‰å¿…è¦ï¼Œäºæ˜¯å°±æ²¡ä¼ ã€‚æ„Ÿè§‰è‡ªå·±åšçš„å°é¢è¿˜æ˜¯æŒºæœ‰è¶£çš„ã€‚</p><p><img src="/images/others/random_thoughts/explore6/pulpyball.png" width="50%"></p><p>æ„Ÿè§‰ AI ç¼–ç¨‹è®©æˆ‘å˜å¾—æ‡’æƒ°äº†ï¼Œè¿˜æ˜¯è¦å¤æ³•ç¼–ç¨‹è‡ªå·±å†™ä»£ç æ‰å¥½ã€‚æˆ‘è®¤ä¸ºæˆ‘ä»¬çš„èƒ½åŠ›æ˜¯è¿ç»­è€Œæ— è·³å˜åœ°æå‡çš„ï¼Œåœ¨è‡ªå·±ä¸äº†è§£çš„é¢†åŸŸç›´æ¥è®© AI ç»™å‡ºç­”æ¡ˆå°±è·³è¿‡äº†è¿™ä¸ªè¿ç»­æˆé•¿çš„è¿‡ç¨‹ï¼Œä»è€ŒæŠŠç»“æœçš„å¥½åå¾ˆå¤§ç¨‹åº¦ä¸Šå¯„æ‰˜åœ¨ AI æ¨¡å‹çš„æˆé•¿ä¸Šï¼Œä¸å¤ªåˆ©äºä¸ªäººæ°´å¹³çš„æå‡ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;äº‹å…ˆå£°æ˜ï¼Œæˆ‘å¯¹æŠŠ LLM å¼•å…¥æ¸¸æˆæ²¡æœ‰ç‰¹åˆ«çš„åå¥½ï¼Œåªæ˜¯æ°å·§æœ‰äº†å¾ˆå¤šåš LLM æ¸¸æˆçš„æœºä¼šè€Œå·²ã€‚ğŸ« ğŸ« è¿™å­¦æœŸæˆ‘ä»¬æœ‰è‡ªç„¶è¯­è¨€å¤„ç†è¯¾ï¼Œé‰´èè€å¸ˆéå¸¸å¼€æ˜åœ°ç­”åº”äº†æˆ‘å®è·µä½œä¸šäº¤ LLM æ¸¸æˆçš„è¯·æ±‚ã€‚åœ¨è¿™é‡Œå¤¸å¤¸é‰´èè€å¸ˆï¼Œå¥¹çš„è¯¾æœ‰è¶£è€Œè´´è¿‘å‰æ²¿ã€PPT è´¨é‡é«˜ã€è€ƒè¯•é¢˜ç›®ä¸æ­»è®°ç¡¬èƒŒï¼Œå¯è°“æ˜¯æˆ‘</summary>
      
    
    
    
    <category term="æ‚è°ˆ" scheme="http://rinevard.github.io/categories/%E6%9D%82%E8%B0%88/"/>
    
    <category term="ç¢ç¢å¿µ" scheme="http://rinevard.github.io/categories/%E6%9D%82%E8%B0%88/%E7%A2%8E%E7%A2%8E%E5%BF%B5/"/>
    
    
  </entry>
  
  <entry>
    <title>æ¢ç´¢æ—¥å¿—[5]</title>
    <link href="http://rinevard.github.io/wiki/others/thoughts/%E6%8E%A2%E7%B4%A2%E6%97%A5%E5%BF%975/"/>
    <id>http://rinevard.github.io/wiki/others/thoughts/%E6%8E%A2%E7%B4%A2%E6%97%A5%E5%BF%975/</id>
    <published>2026-01-30T14:17:31.000Z</published>
    <updated>2026-01-30T14:25:37.456Z</updated>
    
    <content type="html"><![CDATA[<p>å»æ·±åœ³å‚åŠ äº† Agentland ä¸¾åŠçš„ LLM æ¸¸æˆå¼€å‘è€…æ´»åŠ¨ã€‚åŸæœ¬æ‰“ç®—æ´»åŠ¨å®Œå¤šé€›ä¸¤å¤©é¡ºä¾¿å»è¶Ÿé¦™æ¸¯ï¼Œä¸è¿‡æœ€åå‘ç°è‡ªå·±å¯¹æ—…è¡Œå…´è¶£ç¼ºç¼ºï¼Œå°±é€‰æ‹©äº†æå‰è·‘è·¯ã€‚çœä¸‹æ¥çš„é…’åº—é’±è¿˜èƒ½åƒç‚¹å¥½åƒçš„å‘¢ï¼</p><p>è¿™åº”è¯¥æ˜¯æˆ‘ç¬¬ä¸€æ¬¡å‚åŠ çº¿ä¸‹çš„å¼€å‘è€…èšä¼šã€‚ç¬¬ä¸€æ¬¡å‚åŠ å¼€å‘è€…èšä¼šå¹¶æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„æ„Ÿè§‰ï¼Œå› ä¸ºæœ€å–œæ¬¢çš„æ¸¸æˆæˆ‘æ—©å·²é‡è§ã€‚è¿™æ¬¡è§åˆ°äº†å‡ ä¸ªè¿˜ç®—æœ‰è¶£çš„æ¸¸æˆï¼Œä½†å¹¶æ²¡æœ‰çœ‹åˆ°ç‰¹åˆ«æƒŠè‰³çš„æ¸¸æˆã€‚å…¶å®åˆ°ç°åœ¨ä¸ºæ­¢æˆ‘ä¹Ÿè¿˜æ²¡è§è¿‡ä»»ä½•ç‰¹åˆ«æƒŠè‰³çš„ LLM æ¸¸æˆï¼Œå¤šå°‘è¿˜æ˜¯æœ‰ç‚¹é—æ†¾çš„ã€‚</p><p>ä¸è¿‡æ·±åœ³çœŸæ˜¯åº§å¥½åŸå¸‚ã€‚åœ¨ä¸€æœˆçš„åŒ—äº¬éª‘è½¦ä¼šè¢«å†»æ™•ï¼Œè€Œåœ¨æ·±åœ³éª‘è½¦èƒ½ä½“ä¼šåˆ°æš–é£æ‹‚é¢çš„æ„Ÿè§‰ğŸ« ğŸ« æ¨ªå‘å¯¹æ¯”ï¼ŒåŒ—äº¬ä¸€æœˆåœ¨ -5 åº¦å·¦å³ï¼Œè€Œæ·±åœ³åœ¨ 15 åº¦å·¦å³ï¼Œé«˜ä¸‹ç«‹åˆ¤ï¼</p><p>åœ¨å¯è§‚æµ‹çš„æœªæ¥é‡Œï¼Œä¸‹æ¬¡ CGJ åº”è¯¥ä¹Ÿä¼šé€‰æ‹©çº¿ä¸‹å‚åŠ å§ï¼Œåˆ°æ—¶å€™çœ‹çœ‹èƒ½ä¸èƒ½æ‹‰åˆ°å–œæ¬¢çš„å‡ ä¸ªå¼€å‘è€…ä¸€èµ·çº¿ä¸‹åšæ¸¸æˆã€‚</p><p><img src="/images/others/random_thoughts/explore5/shenzhen.jpg" width="50%"> </p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;å»æ·±åœ³å‚åŠ äº† Agentland ä¸¾åŠçš„ LLM æ¸¸æˆå¼€å‘è€…æ´»åŠ¨ã€‚åŸæœ¬æ‰“ç®—æ´»åŠ¨å®Œå¤šé€›ä¸¤å¤©é¡ºä¾¿å»è¶Ÿé¦™æ¸¯ï¼Œä¸è¿‡æœ€åå‘ç°è‡ªå·±å¯¹æ—…è¡Œå…´è¶£ç¼ºç¼ºï¼Œå°±é€‰æ‹©äº†æå‰è·‘è·¯ã€‚çœä¸‹æ¥çš„é…’åº—é’±è¿˜èƒ½åƒç‚¹å¥½åƒçš„å‘¢ï¼&lt;/p&gt;
&lt;p&gt;è¿™åº”è¯¥æ˜¯æˆ‘ç¬¬ä¸€æ¬¡å‚åŠ çº¿ä¸‹çš„å¼€å‘è€…èšä¼šã€‚ç¬¬ä¸€æ¬¡å‚åŠ å¼€å‘è€…èšä¼šå¹¶æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„</summary>
      
    
    
    
    <category term="æ‚è°ˆ" scheme="http://rinevard.github.io/categories/%E6%9D%82%E8%B0%88/"/>
    
    <category term="ç¢ç¢å¿µ" scheme="http://rinevard.github.io/categories/%E6%9D%82%E8%B0%88/%E7%A2%8E%E7%A2%8E%E5%BF%B5/"/>
    
    
  </entry>
  
  <entry>
    <title>å¤šçº§é¡µé¢æµ‹è¯•</title>
    <link href="http://rinevard.github.io/wiki/others/thoughts/%E5%A4%9A%E7%BA%A7%E9%A1%B5%E9%9D%A2%E6%B5%8B%E8%AF%95/"/>
    <id>http://rinevard.github.io/wiki/others/thoughts/%E5%A4%9A%E7%BA%A7%E9%A1%B5%E9%9D%A2%E6%B5%8B%E8%AF%95/</id>
    <published>2026-01-02T03:09:00.000Z</published>
    <updated>2026-01-02T03:09:39.340Z</updated>
    
    <content type="html"><![CDATA[<style>.hidden-link, .hidden-link span {    color: transparent;    cursor: default;}.hidden-link span::selection {    color: blue;    background: #e0e0ff;}</style><p>ä½ å¥½ä¸–ç•Œï¼</p><p class="hidden-link"><span onclick="location.href='/secret/ç©ä¹çš„äºº.html'">ç©ä¹çš„äºº</span> | <span onclick="location.href='/secret/æˆ‘ä¹Ÿæƒ³åšå‡ºä¼˜ç§€çš„ä½œå“.html'">æˆ‘ä¹Ÿæƒ³åšå‡ºä¼˜ç§€çš„ä½œå“</span> | <span onclick="location.href='/secret/datalabå’Œæˆ‘.html'">datalabå’Œæˆ‘</span></p>]]></content>
    
    
      
      
    <summary type="html">&lt;style&gt;
.hidden-link, .hidden-link span {
    color: transparent;
    cursor: default;
}
.hidden-link span::selection {
    color: blue;
   </summary>
      
    
    
    
    <category term="æ‚è°ˆ" scheme="http://rinevard.github.io/categories/%E6%9D%82%E8%B0%88/"/>
    
    <category term="ç¢ç¢å¿µ" scheme="http://rinevard.github.io/categories/%E6%9D%82%E8%B0%88/%E7%A2%8E%E7%A2%8E%E5%BF%B5/"/>
    
    
  </entry>
  
  <entry>
    <title>æ ‘ä¸Šçš„é»„èœ‚</title>
    <link href="http://rinevard.github.io/wiki/others/thoughts/%E5%A4%A7%E9%BB%84%E8%9C%82/"/>
    <id>http://rinevard.github.io/wiki/others/thoughts/%E5%A4%A7%E9%BB%84%E8%9C%82/</id>
    <published>2026-01-02T01:58:30.000Z</published>
    <updated>2026-01-02T02:40:55.512Z</updated>
    
    <content type="html"><![CDATA[<p>æ‰“ç®—åœ¨æ–°å¹´ç¬¬ä¸€å¤©é¼“æ£ä¸€äº›æœ‰è¶£çš„ä¸œè¥¿ã€‚ç¨å¾®æƒ³äº†æƒ³æ„Ÿè§‰æŠŠå¤§é»„èœ‚æŒ‚æ ‘ä¸Šä¼šæŒºæœ‰è¶£ï¼Œäºæ˜¯å°±å¼€å·¥äº†ï¼</p><p>æˆ‘æœ‰ä¸€ä¸ªç¡¬å¸å¤§å°çš„å¤§é»„èœ‚ï¼Œä½†æˆ‘æ²¡æœ‰çº¿å•ŠğŸ˜”</p><p><img src="/images/others/random_thoughts/hornet/saki.jpg" width="30%" height="auto"></p><p>ä¸è¿‡åªè¦æ€æƒ³ä¸æ»‘å¡ï¼ŒåŠæ³•æ€»æ¯”å›°éš¾å¤šã€‚æˆ‘ä»¬å‘æŒ¥ä¸»è§‚èƒ½åŠ¨æ€§æ¥æƒ³æƒ³æ‰‹å¤´ä¸Šæœ‰ä»€ä¹ˆèƒ½åˆ©ç”¨èµ·æ¥çš„ä¸œè¥¿å§ã€‚ä¸€ä¸ªæ­£å¸¸çš„å¤§å­¦ç”Ÿæ‰‹å¤´ä¸Šæœ‰ä»€ä¹ˆå¯ä»¥å½“çº¿çš„ä¸œè¥¿å‘¢ï¼Ÿç­”æ¡ˆå½“ç„¶æ˜¯ã€çŸ³ä¹‹è‡ªç”±ã€ï¼åªè¦å°†è‡ªå·±çš„èº«ä½“åˆ†æ•£æˆçº¿ï¼Œå°±èƒ½æŠŠå¤§é»„èœ‚æŒ‚èµ·æ¥ï¼</p><p>å¼€ç©ç¬‘çš„ï¼Œè¿™è¶…å‡ºå°„ç¨‹èŒƒå›´äº†ã€‚ä¸è¿‡æˆ‘ç¿»å‡ºäº†ä¸€æ ¹åºŸå¼ƒæ•°æ®çº¿ï¼Œç”¨å°åˆ€æŠŠå®ƒå‰²å¼€å°±èƒ½æ‹¿å‡ºé‡Œé¢çš„ç»†é“œçº¿äº†ã€‚è¿™ä¸ªä¸œè¥¿å¤ªç»†è€Œä¸”å¼¯å¼¯ç»•ç»•ä»¥è‡³äºæƒ³æ‰“ç»“éƒ½æŒºéš¾çš„ï¼Œä½†ç»è¿‡ä¸æ‡ˆåŠªåŠ›æˆ‘è¿˜æ˜¯æŠŠå®ƒç»‘åœ¨äº†å¤§é»„èœ‚èº«ä¸Šã€‚æˆ‘ä»¬å…ˆæŠŠå®ƒæŒ‚åˆ°ç¯çº¿ä¸Šæ‰“ä¸ªç»“è¯•è¯•æ•ˆæœå§ï¼</p><p><img src="/images/others/random_thoughts/hornet/light.jpg" width="30%" height="auto"></p><p>æ•ˆæœä¸é”™ï¼Œä½†æˆ‘çªç„¶æ„è¯†åˆ°å¥½åƒæ‹¿ä¸ä¸‹æ¥äº†â€¦æŠ˜è…¾åŠå¤©ç»ˆäºè§£å¼€äº†ç»“ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å‰å¾€æ ‘æ—å§â€”â€”ç„¶åæŠŠå¥¹æŒ‚ä¸Šå»ï¼</p><p><img src="/images/others/random_thoughts/hornet/tree.jpg" width="30%" height="auto"></p><p>å†æ¥ç‚¹ç‰¹å†™</p><p><img src="/images/others/random_thoughts/hornet/hornet.jpg" width="30%" height="auto"></p><p><img src="/images/others/random_thoughts/hornet/silksong.jpg" width="30%" height="auto"></p><p>æˆ‘ä»¬æˆåŠŸäº†å–µğŸ« ğŸ« </p><p>æ™šä¸Šå†æ¥çœ‹çœ‹ï¼Œå¤§é»„èœ‚æˆåŠŸå­˜æ´»ï¼</p><p><img src="/images/others/random_thoughts/hornet/night.jpg" width="30%" height="auto"></p><p>ç¬¬äºŒå¤©æ—©ä¸Šå†æ¥çœ‹çœ‹ï¼Œå¤§é»„èœ‚æˆåŠŸå­˜æ´»ä¸€å¤©ï¼</p><p><img src="/images/others/random_thoughts/hornet/morning.jpg" width="30%" height="auto"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;æ‰“ç®—åœ¨æ–°å¹´ç¬¬ä¸€å¤©é¼“æ£ä¸€äº›æœ‰è¶£çš„ä¸œè¥¿ã€‚ç¨å¾®æƒ³äº†æƒ³æ„Ÿè§‰æŠŠå¤§é»„èœ‚æŒ‚æ ‘ä¸Šä¼šæŒºæœ‰è¶£ï¼Œäºæ˜¯å°±å¼€å·¥äº†ï¼&lt;/p&gt;
&lt;p&gt;æˆ‘æœ‰ä¸€ä¸ªç¡¬å¸å¤§å°çš„å¤§é»„èœ‚ï¼Œä½†æˆ‘æ²¡æœ‰çº¿å•ŠğŸ˜”&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/others/random_thoughts/hornet/saki.jpg</summary>
      
    
    
    
    <category term="æ‚è°ˆ" scheme="http://rinevard.github.io/categories/%E6%9D%82%E8%B0%88/"/>
    
    <category term="ç¢ç¢å¿µ" scheme="http://rinevard.github.io/categories/%E6%9D%82%E8%B0%88/%E7%A2%8E%E7%A2%8E%E5%BF%B5/"/>
    
    
  </entry>
  
  <entry>
    <title>æ¢ç´¢æ—¥å¿—[4]</title>
    <link href="http://rinevard.github.io/wiki/others/thoughts/%E6%8E%A2%E7%B4%A2%E6%97%A5%E5%BF%974/"/>
    <id>http://rinevard.github.io/wiki/others/thoughts/%E6%8E%A2%E7%B4%A2%E6%97%A5%E5%BF%974/</id>
    <published>2025-12-31T16:50:42.000Z</published>
    <updated>2026-01-30T14:29:09.898Z</updated>
    
    <content type="html"><![CDATA[<p>èµ¶åœ¨2025çš„æœ«ç­è½¦å¼€å§‹å†™æ¢ç´¢æ—¥å¿—ï¼Œè¿™æ ·å°±èƒ½æ¢ç´¢ä¸€å¹´äº†ã€‚</p><p>ä¹‹å‰çš„å‡ ç¯‡æ¢ç´¢æ—¥å¿—å…¨æ˜¯å’Œæ¸¸æˆç›¸å…³çš„ï¼Œå†™å®Œæ¢ç´¢æ—¥å¿—[3]åå°±ä¸‹å®šå†³å¿ƒä¸‹ä¸€ç¯‡ç»ä¸å†™æ¸¸æˆç›¸å…³çš„ä¸œè¥¿ï¼Œè¿™ä¹ˆä¸€æ‹–å°±æ‹–åˆ°äº†ç°åœ¨ã€‚</p><p>é‚£ä¸å†™æ¸¸æˆï¼Œè¿˜èƒ½å†™ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘å¿½ç„¶æƒŠè®¶åœ°å‘ç°è‡ªå·±æ‰€æœ‰æœ‰è¶£çš„ä½“éªŒéƒ½æ˜¯å’Œæ¸¸æˆæœ‰å…³çš„ï¼Œæˆ‘æƒ³æˆ‘ä¸èƒ½è¿™æ ·å»ç”Ÿæ´»ã€‚ä½œä¸ºäººç±»åº”è¯¥å»ä½“éªŒå¤šç§å¤šæ ·çš„äº‹ç‰©ï¼Œä¸è¯¥æŠŠè‡ªå·±çš„ç”Ÿæ´»åªå¯„æ‰˜åœ¨ä¸€ä»¶äº‹æƒ…ä¸Šã€‚</p><p>æ€»ä¹‹æˆ‘å°±å»åšäº† <a href="https://github.com/rinevard/BIT-Annual-Eat/">BIT åƒé¥­å¹´åº¦æŠ¥å‘Š</a>ã€‚åšçš„è¿‡ç¨‹å’Œåšå‡ºæ¥çš„æˆæœå…¶å®ä¸å¤ªæœ‰ä»€ä¹ˆéå¸¸å‡ºä¹æ„æ–™çš„åœ°æ–¹ï¼Œä½†ä¹Ÿç¡®å®ç®—å¾—ä¸Šæ˜¯æ¢ç´¢å§ã€‚</p><p><img src="/images/others/random_thoughts/explore4/demo.jpg" width="80%"> </p><p>æˆ‘æ›¾ç»ä¸€å®šæƒ³è¿‡è¦ç»™å­¦æ ¡ç•™ä¸‹äº›ä»€ä¹ˆï¼Œå°±æ˜¯å¾ˆä¸­äºŒçš„é‚£ç§æƒ³è¦åœ¨å­¦æ ¡ç•™ä¸‹è‡ªå·±çš„è¶³è¿¹ä¹‹ç±»çš„ï¼Œæ— è®ºå¦‚ä½•è¿™ä¸ªä¸œè¥¿ä¹Ÿéƒ½èƒ½ç»™è¿‡å»çš„è‡ªå·±ä¸€ä¸ªäº¤ä»£äº†ã€‚</p><p>ä½œä¸ºä¸€ç¯‡è·¨å¹´çš„æ¢ç´¢æ—¥å¿—ï¼Œæƒ³å¿…ä¹Ÿè¯¥å†™ç‚¹å’Œ 2025 ç›¸å…³çš„ä¸œè¥¿ã€‚æˆ‘ä»¬åœ¨ 2025 å¹´éƒ½ä½“éªŒäº†å“ªäº›æœ‰è¶£çš„ä½œå“ï¼Ÿå¦‚æœæœ‰äººçœ‹åˆ°è¿™é‡Œå¯ä»¥åˆ†äº«ä¸€ä¸‹è‡ªå·±åœ¨ 2025 çœ‹åˆ°çš„æœ‰è¶£ä½œå“ï¼Œæˆ‘å¾ˆæƒ³ä½“éªŒä¸€ä¸‹ã€‚</p><p>äºæˆ‘è€Œè¨€ï¼Œæˆ‘åœ¨ 2025 å¹´æœ€å–œæ¬¢çš„åŠ¨ç”»åº”è¯¥å°±æ˜¯å‡‰å®«æ˜¥æ—¥äº†ã€‚æˆ‘å¾ˆå°‘åœ¨åŠ¨ç”»é‡Œçœ‹åˆ°è¿™æ ·ç”Ÿæœºå‹ƒå‹ƒçš„ä¸»è§’ï¼Œä»¥è‡³äºæˆ‘ç°åœ¨ä¹Ÿä¼šæ—¶ä¸æ—¶æ‰“å¼€éšæœºä¸€é›†ï¼Œæ„Ÿæ…¨â€œä¸–ç•Œä¸Šæœ‰ç€ç”Ÿå‘½åŠ›è¿™ä¹ˆæ—ºç››çš„äººâ€ç„¶åè‡ªå·±ä¹Ÿå°±éšç€å›¢é•¿æ¬£æ¬£å‘è£äº†èµ·æ¥ã€‚</p><p>é™¤äº†åŠ¨ç”»ä¹‹å¤–ï¼Œæœ€å–œæ¬¢çš„ä¹¦åº”è¯¥æ˜¯æ¼«é•¿çš„å‘Šåˆ«ï¼ˆè™½ç„¶æ²¡çœ‹å‡ æœ¬ä¹¦ï¼‰ï¼Œæœ€å–œæ¬¢çš„æ¸¸æˆå¤§æ¦‚åœ¨è‹ä¸¹çš„æ¸¸æˆã€å…­è§’ç–‘äº‘ã€æ€æ­»å…¬ä¸»é‡Œé¢é€‰ï¼Œä½†å…¶å®å¹¶æ²¡ç©åˆ°æå…¶ç²¾å½©ä»¥è‡³äºèƒ½åœ¨æˆ‘å¿ƒä¸­ç¨³å±…ç¬¬ä¸€çš„æ¸¸æˆã€‚</p><p>ä½ çŸ¥é“çš„ï¼Œæˆ‘æ˜¯ä¸ç†¬å¤œä¸»ä¹‰è€…ï¼Œå†™åˆ°è¿™é‡ŒçœŸçš„æœ‰ç‚¹æ™•æ™•äº†ï¼Œå¸Œæœ›é†’æ¥åçš„æˆ‘è®¤ä¸ºè¿™ç¯‡æ–‡ç« é€»è¾‘é€šé¡ºæ–‡ç¬”æµç•…ï¼Œæˆ‘è¦å»ç¡è§‰äº†ï¼Œç¥å¤§å®¶æ–°å¹´å¿«ä¹ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;èµ¶åœ¨2025çš„æœ«ç­è½¦å¼€å§‹å†™æ¢ç´¢æ—¥å¿—ï¼Œè¿™æ ·å°±èƒ½æ¢ç´¢ä¸€å¹´äº†ã€‚&lt;/p&gt;
&lt;p&gt;ä¹‹å‰çš„å‡ ç¯‡æ¢ç´¢æ—¥å¿—å…¨æ˜¯å’Œæ¸¸æˆç›¸å…³çš„ï¼Œå†™å®Œæ¢ç´¢æ—¥å¿—[3]åå°±ä¸‹å®šå†³å¿ƒä¸‹ä¸€ç¯‡ç»ä¸å†™æ¸¸æˆç›¸å…³çš„ä¸œè¥¿ï¼Œè¿™ä¹ˆä¸€æ‹–å°±æ‹–åˆ°äº†ç°åœ¨ã€‚&lt;/p&gt;
&lt;p&gt;é‚£ä¸å†™æ¸¸æˆï¼Œè¿˜èƒ½å†™ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘å¿½ç„¶æƒŠè®¶åœ°å‘ç°è‡ªå·±æ‰€æœ‰æœ‰è¶£çš„ä½“éªŒéƒ½æ˜¯å’Œæ¸¸æˆ</summary>
      
    
    
    
    <category term="æ‚è°ˆ" scheme="http://rinevard.github.io/categories/%E6%9D%82%E8%B0%88/"/>
    
    <category term="ç¢ç¢å¿µ" scheme="http://rinevard.github.io/categories/%E6%9D%82%E8%B0%88/%E7%A2%8E%E7%A2%8E%E5%BF%B5/"/>
    
    
  </entry>
  
  <entry>
    <title>Lab 6 Building an IP router</title>
    <link href="http://rinevard.github.io/wiki/learning/open-course/CS144/labs/lab6-ip-router/"/>
    <id>http://rinevard.github.io/wiki/learning/open-course/CS144/labs/lab6-ip-router/</id>
    <published>2025-12-31T04:38:28.000Z</published>
    <updated>2025-12-31T05:10:40.188Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨è¿™ä¸ª Lab é‡Œæˆ‘ä»¬è¦å®ç°æŒ‰è½¬å‘è¡¨è½¬å‘æ•°æ®æŠ¥çš„æ–¹æ³•ã€‚æˆ‘ä»¬ä¸éœ€è¦å®ç°æ„é€ è½¬å‘è¡¨çš„ç®—æ³•ï¼Œä¹Ÿä¸éœ€è¦ç”¨å‰ç¼€æ ‘æ¥å¿«é€ŸæŸ¥è¯¢è½¬å‘è¡¨ï¼Œæ‰€ä»¥å®ç°èµ·æ¥ä¸ç®—éš¾ã€‚</p><p>è½¬å‘è¡¨éœ€è¦å¯¹ç»™å®šçš„ IP ç»™å‡ºä¸‹ä¸€è·³çš„ IP å’Œå¯¹åº”çš„å‡ºæ¥å£/ç«¯å£å·ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å¤´æ–‡ä»¶å’Œç›¸åº”çš„æ–°å¢è½¬å‘è¡¨æ¡ç›®çš„æ–¹æ³•ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Router</span><span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>  <span class="token comment">// ...</span><span class="token keyword">private</span><span class="token operator">:</span>  std<span class="token double-colon punctuation">::</span>pair<span class="token operator">&lt;</span>size_t<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>optional<span class="token operator">&lt;</span>Address<span class="token operator">>></span> <span class="token function">find_best_route</span><span class="token punctuation">(</span> <span class="token keyword">const</span> IPv4Datagram<span class="token operator">&amp;</span> dgram <span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>  <span class="token comment">// The router's collection of network interfaces</span>  std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>NetworkInterface<span class="token operator">>></span> interfaces_ <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token keyword">struct</span> <span class="token class-name">ForwardEntry</span>  <span class="token punctuation">&#123;</span>    <span class="token keyword">uint32_t</span> route_prefix <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">uint8_t</span> prefix_length <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    std<span class="token double-colon punctuation">::</span>optional<span class="token operator">&lt;</span>Address<span class="token operator">></span> next_hop <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>nullopt<span class="token punctuation">;</span>    size_t interface_num <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>ForwardEntry<span class="token operator">></span> forward_table_ <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token class-name">Router</span><span class="token double-colon punctuation">::</span><span class="token function">add_route</span><span class="token punctuation">(</span> <span class="token keyword">const</span> <span class="token keyword">uint32_t</span> route_prefix<span class="token punctuation">,</span>                        <span class="token keyword">const</span> <span class="token keyword">uint8_t</span> prefix_length<span class="token punctuation">,</span>                        <span class="token keyword">const</span> optional<span class="token operator">&lt;</span>Address<span class="token operator">></span> next_hop<span class="token punctuation">,</span>                        <span class="token keyword">const</span> size_t interface_num <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  forward_table_<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span> <span class="token punctuation">&#123;</span> route_prefix<span class="token punctuation">,</span> prefix_length<span class="token punctuation">,</span> next_hop<span class="token punctuation">,</span> interface_num <span class="token punctuation">&#125;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶åæˆ‘ä»¬è¦å®ç°æŒ‰è½¬å‘è¡¨è½¬å‘æ•°æ®çš„æ–¹æ³•ã€‚ä¸€ä¸ªè·¯ç”±å™¨æœ‰å¤šä¸ªç«¯å£ï¼Œæ¯ä¸ªç«¯å£é€šå¸¸å¯¹åº”ä¸€ä¸ªå­ç½‘ã€‚è¿™é‡Œçš„ NetworkInterface æ˜¯å¯¹ç«¯å£çš„æŠ½è±¡ï¼Œè·¯ç”±å™¨åˆ™é€šè¿‡ç«¯å£ä¹‹é—´çš„æ•°æ®äº¤æ¢å®ç°äº†å¤šä¸ªå­ç½‘ä¹‹é—´çš„æ•°æ®äº¤æ¢ã€‚</p><p>æˆ‘ä»¬å¯ä»¥ç”¨å‰ç¼€æ ‘æŠŠæŸ¥è¡¨é€Ÿåº¦ä¼˜åŒ–ä¸ºå¸¸æ•°çº§ï¼Œä½† Lab æ–‡æ¡£è¯´ $O(N)$ çš„æŸ¥è¡¨é€Ÿåº¦æ˜¯å¯ä»¥æ¥å—çš„ï¼Œæ‰€ä»¥æˆ‘è¿™é‡Œå°±ä¸ä¼˜åŒ–äº†ã€‚</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token class-name">Router</span><span class="token double-colon punctuation">::</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> interface <span class="token operator">:</span> interfaces_ <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">auto</span><span class="token operator">&amp;</span> datagram_received <span class="token operator">=</span> interface<span class="token operator">-></span><span class="token function">datagrams_received</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token operator">not</span> datagram_received<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">auto</span> dgram <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span> datagram_received<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>      datagram_received<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">const</span> <span class="token keyword">auto</span> <span class="token punctuation">[</span>interface_num<span class="token punctuation">,</span> next_hop<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">find_best_route</span><span class="token punctuation">(</span> dgram <span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span> dgram<span class="token punctuation">.</span>header<span class="token punctuation">.</span>ttl <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">--</span>dgram<span class="token punctuation">.</span>header<span class="token punctuation">.</span>ttl <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> next_hop<span class="token punctuation">.</span><span class="token function">has_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        dgram<span class="token punctuation">.</span>header<span class="token punctuation">.</span><span class="token function">compute_checksum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        interfaces_<span class="token punctuation">[</span>interface_num<span class="token punctuation">]</span><span class="token operator">-></span><span class="token function">send_datagram</span><span class="token punctuation">(</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span> dgram <span class="token punctuation">)</span><span class="token punctuation">,</span> next_hop<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¦æ³¨æ„å·¦ç§» 32 ä½æ˜¯æœªå®šä¹‰è¡Œä¸ºï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ç‰¹æ®Šå¤„ç† prefix_length == 0 å³é»˜è®¤è·¯ç”±çš„æƒ…å†µã€‚</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">std<span class="token double-colon punctuation">::</span>pair<span class="token operator">&lt;</span>size_t<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>optional<span class="token operator">&lt;</span>Address<span class="token operator">>></span> <span class="token class-name">Router</span><span class="token double-colon punctuation">::</span><span class="token function">find_best_route</span><span class="token punctuation">(</span> <span class="token keyword">const</span> IPv4Datagram<span class="token operator">&amp;</span> dgram <span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">&#123;</span>  size_t interface_num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  std<span class="token double-colon punctuation">::</span>optional<span class="token operator">&lt;</span>Address<span class="token operator">></span> next_hop <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>nullopt<span class="token punctuation">;</span>  <span class="token keyword">uint8_t</span> longest_prefix_match <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> entry <span class="token operator">:</span> forward_table_ <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> entry<span class="token punctuation">.</span>prefix_length <span class="token operator">&lt;</span> longest_prefix_match <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">continue</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">const</span> <span class="token keyword">uint32_t</span> mask <span class="token operator">=</span> <span class="token punctuation">(</span> entry<span class="token punctuation">.</span>prefix_length <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token punctuation">(</span> UINT32_MAX <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span> <span class="token number">32</span> <span class="token operator">-</span> entry<span class="token punctuation">.</span>prefix_length <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> entry<span class="token punctuation">.</span>prefix_length <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> dgram<span class="token punctuation">.</span>header<span class="token punctuation">.</span>dst <span class="token operator">&amp;</span> mask <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span> entry<span class="token punctuation">.</span>route_prefix <span class="token operator">&amp;</span> mask <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token comment">// The range of left shift counts is limited in 0-31, so `mask` is not reliable when</span>      <span class="token comment">// entry.prefix_length == 0, which means the entry is the default route, so we do not use `mask` when</span>      <span class="token comment">// prefix_length == 0</span>      interface_num <span class="token operator">=</span> entry<span class="token punctuation">.</span>interface_num<span class="token punctuation">;</span>      longest_prefix_match <span class="token operator">=</span> entry<span class="token punctuation">.</span>prefix_length<span class="token punctuation">;</span>      next_hop <span class="token operator">=</span> entry<span class="token punctuation">.</span>next_hop<span class="token punctuation">.</span><span class="token function">value_or</span><span class="token punctuation">(</span> <span class="token class-name">Address</span><span class="token double-colon punctuation">::</span><span class="token function">from_ipv4_numeric</span><span class="token punctuation">(</span> dgram<span class="token punctuation">.</span>header<span class="token punctuation">.</span>dst <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> interface_num<span class="token punctuation">,</span> next_hop <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;åœ¨è¿™ä¸ª Lab é‡Œæˆ‘ä»¬è¦å®ç°æŒ‰è½¬å‘è¡¨è½¬å‘æ•°æ®æŠ¥çš„æ–¹æ³•ã€‚æˆ‘ä»¬ä¸éœ€è¦å®ç°æ„é€ è½¬å‘è¡¨çš„ç®—æ³•ï¼Œä¹Ÿä¸éœ€è¦ç”¨å‰ç¼€æ ‘æ¥å¿«é€ŸæŸ¥è¯¢è½¬å‘è¡¨ï¼Œæ‰€ä»¥å®ç°èµ·æ¥ä¸ç®—éš¾ã€‚&lt;/p&gt;
&lt;p&gt;è½¬å‘è¡¨éœ€è¦å¯¹ç»™å®šçš„ IP ç»™å‡ºä¸‹ä¸€è·³çš„ IP å’Œå¯¹åº”çš„å‡ºæ¥å£/ç«¯å£å·ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å¤´æ–‡ä»¶å’Œç›¸åº”çš„æ–°å¢è½¬å‘è¡¨æ¡ç›®çš„æ–¹æ³•ï¼š</summary>
      
    
    
    
    <category term="å…¬å¼€è¯¾" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/"/>
    
    <category term="CS144" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/CS144/"/>
    
    <category term="Labs" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/CS144/Labs/"/>
    
    
  </entry>
  
  <entry>
    <title>Lab 4 Measuring the real world</title>
    <link href="http://rinevard.github.io/wiki/learning/open-course/CS144/labs/lab4-real-world/"/>
    <id>http://rinevard.github.io/wiki/learning/open-course/CS144/labs/lab4-real-world/</id>
    <published>2025-12-30T03:16:28.000Z</published>
    <updated>2025-12-30T03:24:03.007Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™ä¸ª Lab è®©æˆ‘ä»¬ ping ä¸€å°æ—¶è¿œç¨‹ä¸»æœºæ¥æ”¶é›†æ•°æ®ç”»å›¾ã€‚æˆ‘åœ¨æ ¡å›­ç½‘ç¯å¢ƒä¸‹ ping äº† githubã€mit.eduï¼Œè¿˜åœ¨æ‰‹æœºçƒ­ç‚¹ä¸‹ ping äº† mit.eduã€‚</p><p>å¯ä»¥çœ‹å‡ºæ‰‹æœºçƒ­ç‚¹å»¶è¿Ÿæ³¢åŠ¨å¤§ï¼Œä½†æ€»ä½“å»¶è¿Ÿä¼˜äºæ ¡å›­ç½‘ã€‚</p><p><img src="/images/learning/open-course/CS144/labs/lab4/req6_min_rtt.png"></p><p><img src="/images/learning/open-course/CS144/labs/lab4/rtt_trend.png"></p><p><img src="/images/learning/open-course/CS144/labs/lab4/rtt_dist.png"></p><p>æ¯”è¾ƒæœ‰è¶£çš„æ˜¯åœ¨æˆ‘è¿è¡Œ traceroute mit.edu æ—¶ï¼Œæ ¡å›­ç½‘ç¯å¢ƒä¸‹è§£æå‡ºçš„ IP æ˜¯ 23.75.122.29ï¼ˆä½äºç¾å›½ï¼‰ï¼Œè€Œæ‰‹æœºçƒ­ç‚¹ç¯å¢ƒè§£æå‡ºçš„ IP æ˜¯ 184.87.104.30ï¼ˆä½äºé¦™æ¸¯ï¼‰ã€‚è¿™æ˜¯å› ä¸º DNS è¿”å›çš„ IP å’Œä¾›åº”å•†æœ‰å…³ï¼ˆå¤§æ¦‚å§ğŸ« ğŸ« ï¼‰</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;è¿™ä¸ª Lab è®©æˆ‘ä»¬ ping ä¸€å°æ—¶è¿œç¨‹ä¸»æœºæ¥æ”¶é›†æ•°æ®ç”»å›¾ã€‚æˆ‘åœ¨æ ¡å›­ç½‘ç¯å¢ƒä¸‹ ping äº† githubã€mit.eduï¼Œè¿˜åœ¨æ‰‹æœºçƒ­ç‚¹ä¸‹ ping äº† mit.eduã€‚&lt;/p&gt;
&lt;p&gt;å¯ä»¥çœ‹å‡ºæ‰‹æœºçƒ­ç‚¹å»¶è¿Ÿæ³¢åŠ¨å¤§ï¼Œä½†æ€»ä½“å»¶è¿Ÿä¼˜äºæ ¡å›­ç½‘ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/</summary>
      
    
    
    
    <category term="å…¬å¼€è¯¾" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/"/>
    
    <category term="CS144" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/CS144/"/>
    
    <category term="Labs" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/CS144/Labs/"/>
    
    
  </entry>
  
  <entry>
    <title>Lab 5 Down the stack (the network interface)</title>
    <link href="http://rinevard.github.io/wiki/learning/open-course/CS144/labs/lab5-network-interface/"/>
    <id>http://rinevard.github.io/wiki/learning/open-course/CS144/labs/lab5-network-interface/</id>
    <published>2025-12-30T03:01:28.000Z</published>
    <updated>2025-12-31T02:54:36.231Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨è¿™ä¸ª lab é‡Œï¼Œæˆ‘ä»¬è¦æŠŠç¬¬äºŒå±‚é“¾è·¯å±‚å’Œç¬¬ä¸‰å±‚ç½‘ç»œå±‚è¿æ¥èµ·æ¥ï¼Œå®ç°ä¸€ä¸ªèƒ½è®©åŒä¸€å­ç½‘ä¸‹çš„ä¸»æœºé€šä¿¡çš„æ¥å£ã€‚åœ¨å‡ºç«™æ–¹å‘ï¼Œæˆ‘ä»¬çš„ä»£ç å°† IP åŒ…å°è£…ä¸º ETH å¸§ï¼Œå¹¶è§†æƒ…å†µå‘èµ· ARP è¯·æ±‚ä»¥ç»´æŠ¤ IP åˆ° MAC çš„æ˜ å°„è¡¨ï¼›åœ¨å…¥ç«™æ–¹å‘ï¼Œæˆ‘ä»¬æŠŠ ETH å¸§è§£æä¸º IP åŒ…å¹¶å‘ä¸Šä¼ é€’ï¼Œæˆ–è§£æä¸º ARP åè®®åŒ…å¹¶æ›´æ–° ARP è¡¨ã€‚</p><p>æˆ‘ä»¬è¦ç»´æŠ¤ ARP è¡¨å’Œâ€œæƒ³è¦å‘é€ä½†å°šä¸çŸ¥é“ç›®æ ‡ MAC åœ°å€çš„åŒ…â€åˆ—è¡¨ï¼Œå¹¶åœ¨ä¸€å®šæ—¶é—´åè®©å®ƒä»¬è¿‡æœŸã€‚æ‰€ä»¥æˆ‘ä»¬åœ¨å¤´æ–‡ä»¶é‡Œæ–°å¢ä»¥ä¸‹å­—æ®µï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">NetworkInterface</span><span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>  <span class="token comment">// ...</span><span class="token keyword">private</span><span class="token operator">:</span>  <span class="token comment">// ...</span>  <span class="token keyword">static</span> <span class="token keyword">constexpr</span> size_t ARP_TTL <span class="token operator">=</span> <span class="token number">30000</span><span class="token punctuation">;</span>  <span class="token keyword">static</span> <span class="token keyword">constexpr</span> size_t ARP_SAME_REQUEST_CD <span class="token operator">=</span> <span class="token number">5000</span><span class="token punctuation">;</span>    <span class="token comment">// Datagrams to send. We store datagrams whose next hop's MAC is still unknown here.</span>  <span class="token keyword">struct</span> <span class="token class-name">PendingArpRequest</span>  <span class="token punctuation">&#123;</span>    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>InternetDatagram<span class="token operator">></span> buffered_datagrams <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    size_t ms_since_last_request <span class="token punctuation">&#123;</span>      SIZE_MAX <span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// Init to max so the first request is not limited by ARP_SAME_REQUEST_CD.</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token comment">// Mapping ip to pending arp request</span>  std<span class="token double-colon punctuation">::</span>unordered_map<span class="token operator">&lt;</span><span class="token keyword">uint32_t</span><span class="token punctuation">,</span> PendingArpRequest<span class="token operator">></span> pending_arp_requests_ <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token keyword">struct</span> <span class="token class-name">ArpEntry</span>  <span class="token punctuation">&#123;</span>    EthernetAddress eth_addr <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    size_t living_ms <span class="token punctuation">&#123;</span> <span class="token number">0</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token comment">// Table mapping IP to MAC and living time</span>  std<span class="token double-colon punctuation">::</span>unordered_map<span class="token operator">&lt;</span><span class="token keyword">uint32_t</span><span class="token punctuation">,</span> ArpEntry<span class="token operator">></span> arp_table_ <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨å‡ºç«™æ–¹å‘ï¼Œå¦‚æœå·²ç»çŸ¥é“ä¸‹ä¸€è·³å¯¹åº”çš„ MAC åœ°å€ï¼Œç›´æ¥å‘é€å°±è¡Œï¼›å¦‚æœä¸çŸ¥é“å°±è¦æŠŠæƒ³è¦å‡ºç«™çš„æ•°æ®å­˜å‚¨èµ·æ¥å¹¶å¹¿æ’­ ARP è¯·æ±‚ã€‚æ³¨æ„å¯¹åŒä¸€ä¸ª IP çš„ ARP è¯·æ±‚ä¸åº”å¤ªé¢‘ç¹ï¼Œå¦‚å®éªŒæ–‡æ¡£æ‰€è¯´æˆ‘ä»¬å¯ä»¥è®¾ç½®ä¸€ä¸ªäº”ç§’çš„ CD.</p><p>è¿™é‡Œçš„ serialize å‡½æ•°æ˜¯ä¸€ä¸ªè¾…åŠ©å‡½æ•°ï¼Œç”¨äºæŠŠæ•°æ®è½¬æ¢æˆäºŒè¿›åˆ¶åºåˆ—ã€‚åœ¨ InternetDatagram è¿™äº›ç±»å†…éƒ¨å†…å­˜ä¸ä¸€å®šè¿ç»­ï¼ˆæ¯”å¦‚ <code>std::vector&lt;Refstd::string&gt; payload &#123;&#125;</code>ï¼‰ï¼Œä¹Ÿå¯èƒ½æœ‰å¤§å°ç«¯é—®é¢˜ï¼Œserialize åˆ™å¤„ç†è¿™äº›é—®é¢˜æŠŠå®ƒä»¬è½¬åŒ–æˆè¿ç»­çš„ã€ç½‘ç»œåºçš„å­—èŠ‚æµã€‚</p><p>è¿™é‡Œçš„ transmit åˆ™æ˜¯å¯¹ä¸»æœºçš„ç‰©ç†å‘ä¿¡èƒ½åŠ›çš„æŠ½è±¡ã€‚</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token class-name">NetworkInterface</span><span class="token double-colon punctuation">::</span><span class="token function">send_datagram</span><span class="token punctuation">(</span> InternetDatagram dgram<span class="token punctuation">,</span> <span class="token keyword">const</span> Address<span class="token operator">&amp;</span> next_hop <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  EthernetFrame eth_frame <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  eth_frame<span class="token punctuation">.</span>header<span class="token punctuation">.</span>src <span class="token operator">=</span> ethernet_address_<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> arp_table_<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span> next_hop<span class="token punctuation">.</span><span class="token function">ipv4_numeric</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> arp_table_<span class="token punctuation">[</span>next_hop<span class="token punctuation">.</span><span class="token function">ipv4_numeric</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>living_ms <span class="token operator">&lt;</span> ARP_TTL <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// Send datagram right away if the dst eth address is already known</span>    eth_frame<span class="token punctuation">.</span>header<span class="token punctuation">.</span>dst <span class="token operator">=</span> arp_table_<span class="token punctuation">[</span>next_hop<span class="token punctuation">.</span><span class="token function">ipv4_numeric</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>eth_addr<span class="token punctuation">;</span>    eth_frame<span class="token punctuation">.</span>header<span class="token punctuation">.</span>type <span class="token operator">=</span> EthernetHeader<span class="token double-colon punctuation">::</span>TYPE_IPv4<span class="token punctuation">;</span>    eth_frame<span class="token punctuation">.</span>payload <span class="token operator">=</span> <span class="token function">serialize</span><span class="token punctuation">(</span> dgram <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    pending_arp_requests_<span class="token punctuation">[</span>next_hop<span class="token punctuation">.</span><span class="token function">ipv4_numeric</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>buffered_datagrams<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span> dgram <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// Send ARP request if last ARP request with same IP was more than ARP_SAME_REQUEST_CD ago</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> pending_arp_requests_<span class="token punctuation">[</span>next_hop<span class="token punctuation">.</span><span class="token function">ipv4_numeric</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ms_since_last_request <span class="token operator">&lt;</span> ARP_SAME_REQUEST_CD <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    eth_frame<span class="token punctuation">.</span>header<span class="token punctuation">.</span>dst <span class="token operator">=</span> ETHERNET_BROADCAST<span class="token punctuation">;</span>    eth_frame<span class="token punctuation">.</span>header<span class="token punctuation">.</span>type <span class="token operator">=</span> EthernetHeader<span class="token double-colon punctuation">::</span>TYPE_ARP<span class="token punctuation">;</span>    ARPMessage arpmsg<span class="token punctuation">;</span>    arpmsg<span class="token punctuation">.</span>opcode <span class="token operator">=</span> ARPMessage<span class="token double-colon punctuation">::</span>OPCODE_REQUEST<span class="token punctuation">;</span>    arpmsg<span class="token punctuation">.</span>sender_ethernet_address <span class="token operator">=</span> ethernet_address_<span class="token punctuation">;</span>    arpmsg<span class="token punctuation">.</span>sender_ip_address <span class="token operator">=</span> ip_address_<span class="token punctuation">.</span><span class="token function">ipv4_numeric</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    arpmsg<span class="token punctuation">.</span>target_ethernet_address <span class="token operator">=</span> ETHERNET_ZERO<span class="token punctuation">;</span>    arpmsg<span class="token punctuation">.</span>target_ip_address <span class="token operator">=</span> next_hop<span class="token punctuation">.</span><span class="token function">ipv4_numeric</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    eth_frame<span class="token punctuation">.</span>payload <span class="token operator">=</span> <span class="token function">serialize</span><span class="token punctuation">(</span> arpmsg <span class="token punctuation">)</span><span class="token punctuation">;</span>    pending_arp_requests_<span class="token punctuation">[</span>next_hop<span class="token punctuation">.</span><span class="token function">ipv4_numeric</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ms_since_last_request <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token function">transmit</span><span class="token punctuation">(</span> eth_frame <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨å…¥ç«™æ–¹å‘ï¼Œæ¥æ”¶åˆ° ETH å¸§æ—¶åšä¸ª Multiplexing åˆ†æˆ IPV4 å’Œ ARP ä¸¤ä¸ªåˆ†æ”¯ï¼Œé‡åˆ° IPV4 å°±æ”¾è¿› datagrams<em>received</em> ç»™ä¸Šå±‚åº”ç”¨ï¼›é‡åˆ° ARP å…ˆç»“åˆå…¶ sender çš„ IP å’Œ MAC ä¿¡æ¯æ›´æ–° ARP è¡¨ã€å‘ç¼“å­˜çš„åŒ…ï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œå†æ ¹æ®ç±»å‹åˆ¤æ–­æ˜¯å¦å›å¤ã€‚</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token class-name">NetworkInterface</span><span class="token double-colon punctuation">::</span><span class="token function">recv_frame</span><span class="token punctuation">(</span> <span class="token keyword">const</span> EthernetFrame<span class="token operator">&amp;</span> frame <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> frame<span class="token punctuation">.</span>header<span class="token punctuation">.</span>dst <span class="token operator">!=</span> ethernet_address_ <span class="token operator">&amp;&amp;</span> frame<span class="token punctuation">.</span>header<span class="token punctuation">.</span>dst <span class="token operator">!=</span> ETHERNET_BROADCAST <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> frame<span class="token punctuation">.</span>header<span class="token punctuation">.</span>type <span class="token operator">==</span> EthernetHeader<span class="token double-colon punctuation">::</span>TYPE_IPv4 <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    InternetDatagram dgram<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">parse</span><span class="token punctuation">(</span> dgram<span class="token punctuation">,</span> frame<span class="token punctuation">.</span>payload <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      datagrams_received_<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span> dgram <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>      <span class="token function">debug</span><span class="token punctuation">(</span> <span class="token string">"recv_frame: Parse failed!"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> frame<span class="token punctuation">.</span>header<span class="token punctuation">.</span>type <span class="token operator">==</span> EthernetHeader<span class="token double-colon punctuation">::</span>TYPE_ARP <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    ARPMessage arpmsg<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">parse</span><span class="token punctuation">(</span> arpmsg<span class="token punctuation">,</span> frame<span class="token punctuation">.</span>payload <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      arp_table_<span class="token punctuation">[</span>arpmsg<span class="token punctuation">.</span>sender_ip_address<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span> arpmsg<span class="token punctuation">.</span>sender_ethernet_address<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>      <span class="token comment">// Send datagrams whose next hop's MAC was unknown but is known now.</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span> pending_arp_requests_<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span> arpmsg<span class="token punctuation">.</span>sender_ip_address <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> dgram <span class="token operator">:</span> pending_arp_requests_<span class="token punctuation">[</span>arpmsg<span class="token punctuation">.</span>sender_ip_address<span class="token punctuation">]</span><span class="token punctuation">.</span>buffered_datagrams <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          EthernetFrame eth_frame<span class="token punctuation">;</span>          eth_frame<span class="token punctuation">.</span>header<span class="token punctuation">.</span>src <span class="token operator">=</span> ethernet_address_<span class="token punctuation">;</span>          eth_frame<span class="token punctuation">.</span>header<span class="token punctuation">.</span>dst <span class="token operator">=</span> arp_table_<span class="token punctuation">[</span>arpmsg<span class="token punctuation">.</span>sender_ip_address<span class="token punctuation">]</span><span class="token punctuation">.</span>eth_addr<span class="token punctuation">;</span>          eth_frame<span class="token punctuation">.</span>header<span class="token punctuation">.</span>type <span class="token operator">=</span> EthernetHeader<span class="token double-colon punctuation">::</span>TYPE_IPv4<span class="token punctuation">;</span>          eth_frame<span class="token punctuation">.</span>payload <span class="token operator">=</span> <span class="token function">serialize</span><span class="token punctuation">(</span> dgram <span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">transmit</span><span class="token punctuation">(</span> eth_frame <span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>      pending_arp_requests_<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span> arpmsg<span class="token punctuation">.</span>sender_ip_address <span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// Send ARP reply if it is an ARP request asking for our IP address</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span> arpmsg<span class="token punctuation">.</span>opcode <span class="token operator">==</span> ARPMessage<span class="token double-colon punctuation">::</span>OPCODE_REQUEST <span class="token operator">&amp;&amp;</span> arpmsg<span class="token punctuation">.</span>target_ip_address <span class="token operator">==</span> ip_address_<span class="token punctuation">.</span><span class="token function">ipv4_numeric</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        EthernetFrame eth_frame <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        eth_frame<span class="token punctuation">.</span>header<span class="token punctuation">.</span>src <span class="token operator">=</span> ethernet_address_<span class="token punctuation">;</span>        eth_frame<span class="token punctuation">.</span>header<span class="token punctuation">.</span>dst <span class="token operator">=</span> arpmsg<span class="token punctuation">.</span>sender_ethernet_address<span class="token punctuation">;</span>        eth_frame<span class="token punctuation">.</span>header<span class="token punctuation">.</span>type <span class="token operator">=</span> EthernetHeader<span class="token double-colon punctuation">::</span>TYPE_ARP<span class="token punctuation">;</span>        ARPMessage arpreply<span class="token punctuation">;</span>        arpreply<span class="token punctuation">.</span>opcode <span class="token operator">=</span> ARPMessage<span class="token double-colon punctuation">::</span>OPCODE_REPLY<span class="token punctuation">;</span>        arpreply<span class="token punctuation">.</span>sender_ethernet_address <span class="token operator">=</span> ethernet_address_<span class="token punctuation">;</span>        arpreply<span class="token punctuation">.</span>sender_ip_address <span class="token operator">=</span> ip_address_<span class="token punctuation">.</span><span class="token function">ipv4_numeric</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        arpreply<span class="token punctuation">.</span>target_ethernet_address <span class="token operator">=</span> arpmsg<span class="token punctuation">.</span>sender_ethernet_address<span class="token punctuation">;</span>        arpreply<span class="token punctuation">.</span>target_ip_address <span class="token operator">=</span> arpmsg<span class="token punctuation">.</span>sender_ip_address<span class="token punctuation">;</span>        eth_frame<span class="token punctuation">.</span>payload <span class="token operator">=</span> <span class="token function">serialize</span><span class="token punctuation">(</span> arpreply <span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">transmit</span><span class="token punctuation">(</span> eth_frame <span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>      <span class="token function">debug</span><span class="token punctuation">(</span> <span class="token string">"recv_frame: Parse failed!"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ€åæ˜¯ tick å‡½æ•°ï¼Œå®ƒæ›´æ–°å¤§å®¶çš„è®¡æ—¶å™¨ç„¶ååœ¨åˆ°æœŸæ—¶ erase å°±è¡Œã€‚æ³¨æ„åˆ«æŠŠè¾¹éå†è¾¹ erase çš„é€»è¾‘å†™é”™äº†ã€‚</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token class-name">NetworkInterface</span><span class="token double-colon punctuation">::</span><span class="token function">tick</span><span class="token punctuation">(</span> <span class="token keyword">const</span> size_t ms_since_last_tick <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">auto</span> it <span class="token operator">=</span> pending_arp_requests_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> pending_arp_requests_<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">auto</span><span class="token operator">&amp;</span> <span class="token punctuation">[</span>ip<span class="token punctuation">,</span> pending_arp_request<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span>it<span class="token punctuation">;</span>    pending_arp_request<span class="token punctuation">.</span>ms_since_last_request <span class="token operator">+=</span> ms_since_last_tick<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> pending_arp_request<span class="token punctuation">.</span>ms_since_last_request <span class="token operator">></span> ARP_SAME_REQUEST_CD <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      it <span class="token operator">=</span> pending_arp_requests_<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span> it <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>      <span class="token operator">++</span>it<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">auto</span> it <span class="token operator">=</span> arp_table_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> arp_table_<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">auto</span><span class="token operator">&amp;</span> <span class="token punctuation">[</span>ip<span class="token punctuation">,</span> arp_entry<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span>it<span class="token punctuation">;</span>    arp_entry<span class="token punctuation">.</span>living_ms <span class="token operator">+=</span> ms_since_last_tick<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> arp_entry<span class="token punctuation">.</span>living_ms <span class="token operator">></span> ARP_TTL <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      it <span class="token operator">=</span> arp_table_<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span> it <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>      <span class="token operator">++</span>it<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;åœ¨è¿™ä¸ª lab é‡Œï¼Œæˆ‘ä»¬è¦æŠŠç¬¬äºŒå±‚é“¾è·¯å±‚å’Œç¬¬ä¸‰å±‚ç½‘ç»œå±‚è¿æ¥èµ·æ¥ï¼Œå®ç°ä¸€ä¸ªèƒ½è®©åŒä¸€å­ç½‘ä¸‹çš„ä¸»æœºé€šä¿¡çš„æ¥å£ã€‚åœ¨å‡ºç«™æ–¹å‘ï¼Œæˆ‘ä»¬çš„ä»£ç å°† IP åŒ…å°è£…ä¸º ETH å¸§ï¼Œå¹¶è§†æƒ…å†µå‘èµ· ARP è¯·æ±‚ä»¥ç»´æŠ¤ IP åˆ° MAC çš„æ˜ å°„è¡¨ï¼›åœ¨å…¥ç«™æ–¹å‘ï¼Œæˆ‘ä»¬æŠŠ ETH å¸§è§£æä¸º IP åŒ…å¹¶å‘ä¸Šä¼ </summary>
      
    
    
    
    <category term="å…¬å¼€è¯¾" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/"/>
    
    <category term="CS144" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/CS144/"/>
    
    <category term="Labs" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/CS144/Labs/"/>
    
    
  </entry>
  
  <entry>
    <title>Lab 2 The TCP receiver</title>
    <link href="http://rinevard.github.io/wiki/learning/open-course/CS144/labs/lab2-receiver/"/>
    <id>http://rinevard.github.io/wiki/learning/open-course/CS144/labs/lab2-receiver/</id>
    <published>2025-12-15T12:40:28.000Z</published>
    <updated>2025-12-15T13:43:09.896Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨è¿™ä¸ª Lab é‡Œæˆ‘ä»¬è¦å†™ TCP åè®®çš„æ¥æ”¶æ–¹æ”¶åˆ°æ•°æ®æ—¶çš„å¤„ç†å‡½æ•°ï¼Œä»¥åŠæ„é€ æ¥æ”¶æ–¹çš„å›ä¿¡çš„å‡½æ•°ã€‚</p><p>åœ¨ TCP åè®®ä¸­æˆ‘ä»¬è¦å’Œä¸‰ç§ç´¢å¼•æ‰“äº¤é“ï¼š</p><ol><li>seqno: åœ¨ TCP å¤´éƒ¨ä¸­ç©ºé—´å¾ˆå®è´µï¼Œæ‰€ä»¥åªç”¨ 32 ä½æ¥å­˜å‚¨åºåˆ—å·ï¼Œè¿™å°±æ˜¯ seqno. è€ƒè™‘åˆ°å®‰å…¨æ€§ï¼Œseqno ä¸ä» 0 å¼€å§‹ï¼Œè€Œæ˜¯ä»ä¸€ä¸ªéšæœºæ•° ISN å¼€å§‹ã€‚</li><li>absolute seqno: æ¯ä¸ª TCP è¿æ¥ä¸­çš„å­—èŠ‚æµä»¥ SYN ä¸ºå¼€å¤´ï¼ŒFIN ä¸ºç»“å°¾ã€‚ç”¨ 64 ä½ç»™æ¯ä¸ªå­—èŠ‚ç¼–å·å°±å¾—åˆ°äº† absolute deqno.</li><li>stream index: ç”¨ 64 ä½ç»™ TCP è¿æ¥ä¸­é™¤ SYN å’Œ FIN ä»¥å¤–çš„å®é™…æ•°æ®ç¼–ç å°±å¾—åˆ°äº† stream index.</li></ol><div class="table-container"><table><thead><tr><th></th><th>Sequence Numbers</th><th>Absolute Sequence Numbers</th><th>Stream Indices</th></tr></thead><tbody><tr><td>æ ‡è¯†</td><td>â€œseqnoâ€</td><td>â€œabsolute seqnoâ€</td><td>â€œstream indexâ€</td></tr><tr><td>èµ·å§‹ç‚¹</td><td>ä» ISN å¼€å§‹</td><td>ä» 0 å¼€å§‹</td><td>ä» 0 å¼€å§‹</td></tr><tr><td>å†…å®¹èŒƒå›´</td><td>åŒ…æ‹¬ SYN/FIN</td><td>åŒ…æ‹¬ SYN/FIN</td><td>ä¸åŒ…å« SYN/FIN</td></tr><tr><td>æ€§è´¨</td><td>32 bits, å›ç»•</td><td>64 bits, ä¸å›ç»•</td><td>64 bits, ä¸å›ç»•</td></tr></tbody></table></div><p>è¿™é‡Œæ˜¯ç¤ºä¾‹æ•°æ®ï¼Œå‡è®¾ ISN ä¸º $2^{32} - 2$ï¼Œä¼ è¾“çš„å†…å®¹ä¸º â€œcatâ€ï¼Œåˆ™æœ‰ï¼š</p><div class="table-container"><table><thead><tr><th>element</th><th>SYN</th><th>c</th><th>a</th><th>t</th><th>FIN</th></tr></thead><tbody><tr><td>seqno</td><td>$2^{32} - 2$</td><td>$2^{32} - 1$</td><td>0</td><td>1</td><td>2</td></tr><tr><td>absolute seqno</td><td>0</td><td>1</td><td>2</td><td>3</td><td>4</td></tr><tr><td>stream index</td><td></td><td>0</td><td>1</td><td>2</td></tr></tbody></table></div><h2 id="Translating-between-64-bit-indexes-and-32-bit-seqnos"><a href="#Translating-between-64-bit-indexes-and-32-bit-seqnos" class="headerlink" title="Translating between 64-bit indexes and 32-bit seqnos"></a>Translating between 64-bit indexes and 32-bit seqnos</h2><p>åœ¨ Lab çš„å¼€å§‹æˆ‘ä»¬è¦å†™ seqno å’Œ absolute seqno é—´ç›¸äº’è½¬æ¢çš„ä¸¤ä¸ªå‡½æ•°ï¼Œæˆ‘çš„å®ç°å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">Wrap32 <span class="token class-name">Wrap32</span><span class="token double-colon punctuation">::</span><span class="token function">wrap</span><span class="token punctuation">(</span> <span class="token keyword">uint64_t</span> n<span class="token punctuation">,</span> Wrap32 zero_point <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> zero_point <span class="token operator">+</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">uint32_t</span><span class="token operator">></span></span></span><span class="token punctuation">(</span> n <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">uint64_t</span> <span class="token class-name">Wrap32</span><span class="token double-colon punctuation">::</span><span class="token function">unwrap</span><span class="token punctuation">(</span> Wrap32 zero_point<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> checkpoint <span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">&#123;</span>  <span class="token keyword">auto</span> dist <span class="token operator">=</span> <span class="token punctuation">[</span>checkpoint<span class="token punctuation">]</span><span class="token punctuation">(</span> <span class="token keyword">uint64_t</span> x <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> x <span class="token operator">></span> checkpoint <span class="token operator">?</span> <span class="token punctuation">(</span> x <span class="token operator">-</span> checkpoint <span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span> checkpoint <span class="token operator">-</span> x <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> <span class="token keyword">uint64_t</span> k <span class="token operator">=</span> checkpoint <span class="token operator">>></span> <span class="token number">32</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> <span class="token keyword">uint64_t</span> val1 <span class="token operator">=</span> raw_value_ <span class="token operator">-</span> zero_point<span class="token punctuation">.</span>raw_value_ <span class="token operator">+</span> k <span class="token operator">*</span> <span class="token punctuation">(</span> <span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">32</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> <span class="token keyword">uint64_t</span> val2 <span class="token operator">=</span> raw_value_ <span class="token operator">-</span> zero_point<span class="token punctuation">.</span>raw_value_ <span class="token operator">+</span> <span class="token punctuation">(</span> k <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span> <span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">32</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> <span class="token keyword">uint64_t</span> val3 <span class="token operator">=</span> raw_value_ <span class="token operator">-</span> zero_point<span class="token punctuation">.</span>raw_value_ <span class="token operator">+</span> <span class="token punctuation">(</span> k <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span> <span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">32</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span> <span class="token punctuation">&#123;</span> val1<span class="token punctuation">,</span> val2<span class="token punctuation">,</span> val3 <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>dist<span class="token punctuation">]</span><span class="token punctuation">(</span> <span class="token keyword">uint64_t</span> x<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> y <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token function">dist</span><span class="token punctuation">(</span> x <span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token function">dist</span><span class="token punctuation">(</span> y <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Implementing-the-TCP-receiver"><a href="#Implementing-the-TCP-receiver" class="headerlink" title="Implementing the TCP receiver"></a>Implementing the TCP receiver</h2><p>ç„¶åæˆ‘ä»¬è¦ç»™ TCP æ¥æ”¶æ–¹å†™æ”¶åˆ°æ•°æ®çš„å¤„ç†å‡½æ•°å’Œæ„é€ å›ä¿¡çš„å‡½æ•°äº†ã€‚è¿™é‡Œä¸»è¦æœ‰ä¸‰ä¸ªéš¾ç‚¹ï¼Œæˆ‘ä»¬åˆ†æä¸€ä¸‹ï¼š</p><ol><li><p>æ€ä¹ˆæ ¹æ® message é‡Œçš„ RSTã€SYNã€FIN æ”¹å˜æ”¶ä¿¡æ–¹çš„çŠ¶æ€ï¼Ÿ</p><p> æˆ‘ä»¬å¯ä»¥æŠŠ TCP receiver åˆ†æˆ LISTENã€SYN_RCVDã€CLOSE_WAIT ä¸‰ç§çŠ¶æ€ï¼Œ LISTEN æ˜¯è¿˜æ²¡æ”¶åˆ° SYN çš„çŠ¶æ€ï¼ŒSYN_RCVD æ˜¯æ”¶åˆ° SYN åæ­£å¸¸æ¥æ”¶æ•°æ®çš„çŠ¶æ€ï¼ŒCLOSE_WAIT åˆ™æ˜¯æ”¶åˆ° FIN åçš„çŠ¶æ€ã€‚</p><p> å¦å¤–ï¼ŒRST è¡¨ç¤ºå‘ç”Ÿäº†ä¸å¯æŒ½å›çš„é”™è¯¯ï¼Œå› æ­¤åœ¨æ”¶åˆ° RST ååº”è¯¥ç«‹å³æŠ›å‡ºå¼‚å¸¸ã€‚åœ¨æˆ‘ä»¬çš„ä»£ç é‡Œå°±è¡¨ç°ä¸ºå…³é—­ ByteStream. æ¯ä¸ª TCP è¿æ¥å’Œä¸€ä¸ª ByteStream å”¯ä¸€ç»‘å®šï¼Œæ˜¯è¯¥è¿æ¥å‘ç”¨æˆ·äº¤ä»˜æ•°æ®çš„å”¯ä¸€æ¸ é“ã€‚</p></li><li><p>æ€ä¹ˆè®¡ç®— acknoï¼Ÿ</p><p> ackno æ˜¯æˆ‘ä»¬éœ€è¦çš„ä¸‹ä¸€ä¸ª byte çš„ 32 ä½ç´¢å¼•ï¼Œä¹Ÿå°±æ˜¯å°šæœªè¢«å†™å…¥ ByteStream çš„æœ€å°ç´¢å¼•ã€‚ByteStream å­˜çš„æ˜¯ stream indexï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å…ˆæ ¹æ®å®ƒç®—å‡º absolute seqnoï¼Œå†ç”¨æˆ‘ä»¬ä¹‹å‰å®ç°çš„ Wrap32 çš„å„ç§æ–¹æ³•å¾—åˆ° 32 ä½çš„ acknoï¼š</p> <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">const</span> <span class="token keyword">uint64_t</span> abs_ackno <span class="token operator">=</span> reassembler_<span class="token punctuation">.</span><span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bytes_pushed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> seen_syn_ <span class="token operator">+</span> reassembler_<span class="token punctuation">.</span><span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_closed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>optional<span class="token operator">&lt;</span>Wrap32<span class="token operator">></span> ackno  <span class="token operator">=</span> seen_syn_ <span class="token operator">?</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">optional</span><span class="token generic class-name"><span class="token operator">&lt;</span>Wrap32<span class="token operator">></span></span></span><span class="token punctuation">(</span> <span class="token class-name">Wrap32</span><span class="token double-colon punctuation">::</span><span class="token function">wrap</span><span class="token punctuation">(</span> abs_ackno<span class="token punctuation">,</span> zero_point_ <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">:</span> std<span class="token double-colon punctuation">::</span>nullopt<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p> è¿™é‡Œçš„ reassembler<em>.writer().is_closed() ä¸èƒ½æ¢æˆ seen_fin</em>ï¼Œå› ä¸ºæ”¶åˆ° FIN å¹¶ä¸ä»£è¡¨æ•°æ®å·²ç»è¢«å¡«å…¥äº† ByteStream.</p></li><li><p>æ€ä¹ˆè®¡ç®— stream indexï¼Ÿ</p><p> å¯¹å¸¦ SYN çš„ messageï¼Œstream index å°±æ˜¯ 0.</p><p> å¯¹ä¸å¸¦ SYN çš„ messageï¼Œstream index æ˜¯ absolute seqno - 1.</p></li></ol><p>æœ€åæˆ‘ä»¬æ”¾ä»£ç ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">TCPReceiver</span><span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>  <span class="token comment">// ...</span><span class="token keyword">private</span><span class="token operator">:</span>  Reassembler reassembler_<span class="token punctuation">;</span>  Wrap32 zero_point_ <span class="token punctuation">&#123;</span> <span class="token number">0</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token keyword">bool</span> seen_syn_ <span class="token punctuation">&#123;</span> <span class="token boolean">false</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token class-name">TCPReceiver</span><span class="token double-colon punctuation">::</span><span class="token function">receive</span><span class="token punctuation">(</span> TCPSenderMessage message <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> message<span class="token punctuation">.</span>RST <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    reassembler_<span class="token punctuation">.</span><span class="token function">reader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>seen_syn_ <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>message<span class="token punctuation">.</span>SYN <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>seen_syn_ <span class="token operator">&amp;&amp;</span> message<span class="token punctuation">.</span>SYN <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    zero_point_ <span class="token operator">=</span> message<span class="token punctuation">.</span>seqno<span class="token punctuation">;</span>    seen_syn_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">const</span> <span class="token keyword">uint64_t</span> abs_ackno <span class="token operator">=</span> reassembler_<span class="token punctuation">.</span><span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bytes_pushed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> seen_syn_ <span class="token operator">+</span> reassembler_<span class="token punctuation">.</span><span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_closed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> <span class="token keyword">uint64_t</span> stream_idx <span class="token operator">=</span> message<span class="token punctuation">.</span>seqno<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span> zero_point_<span class="token punctuation">,</span> abs_ackno <span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token operator">!</span>message<span class="token punctuation">.</span>SYN<span class="token punctuation">;</span>  reassembler_<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span> stream_idx<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span> message<span class="token punctuation">.</span>payload <span class="token punctuation">)</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span>FIN <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">TCPReceiverMessage <span class="token class-name">TCPReceiver</span><span class="token double-colon punctuation">::</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> <span class="token keyword">uint64_t</span> abs_ackno <span class="token operator">=</span> reassembler_<span class="token punctuation">.</span><span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bytes_pushed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> seen_syn_ <span class="token operator">+</span> reassembler_<span class="token punctuation">.</span><span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_closed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>optional<span class="token operator">&lt;</span>Wrap32<span class="token operator">></span> ackno    <span class="token operator">=</span> seen_syn_ <span class="token operator">?</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">optional</span><span class="token generic class-name"><span class="token operator">&lt;</span>Wrap32<span class="token operator">></span></span></span><span class="token punctuation">(</span> <span class="token class-name">Wrap32</span><span class="token double-colon punctuation">::</span><span class="token function">wrap</span><span class="token punctuation">(</span> abs_ackno<span class="token punctuation">,</span> zero_point_ <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">:</span> std<span class="token double-colon punctuation">::</span>nullopt<span class="token punctuation">;</span>  <span class="token keyword">const</span> <span class="token keyword">uint16_t</span> window_size <span class="token operator">=</span> <span class="token punctuation">(</span> reassembler_<span class="token punctuation">.</span><span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">available_capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> UINT16_MAX <span class="token punctuation">)</span>                                 <span class="token operator">?</span> UINT16_MAX                                 <span class="token operator">:</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">uint16_t</span><span class="token operator">></span></span></span><span class="token punctuation">(</span> reassembler_<span class="token punctuation">.</span><span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">available_capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> ackno<span class="token punctuation">,</span> window_size<span class="token punctuation">,</span> reassembler_<span class="token punctuation">.</span><span class="token function">reader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">has_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;åœ¨è¿™ä¸ª Lab é‡Œæˆ‘ä»¬è¦å†™ TCP åè®®çš„æ¥æ”¶æ–¹æ”¶åˆ°æ•°æ®æ—¶çš„å¤„ç†å‡½æ•°ï¼Œä»¥åŠæ„é€ æ¥æ”¶æ–¹çš„å›ä¿¡çš„å‡½æ•°ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨ TCP åè®®ä¸­æˆ‘ä»¬è¦å’Œä¸‰ç§ç´¢å¼•æ‰“äº¤é“ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;seqno: åœ¨ TCP å¤´éƒ¨ä¸­ç©ºé—´å¾ˆå®è´µï¼Œæ‰€ä»¥åªç”¨ 32 ä½æ¥å­˜å‚¨åºåˆ—å·ï¼Œè¿™å°±æ˜¯ seq</summary>
      
    
    
    
    <category term="å…¬å¼€è¯¾" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/"/>
    
    <category term="CS144" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/CS144/"/>
    
    <category term="Labs" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/CS144/Labs/"/>
    
    
  </entry>
  
  <entry>
    <title>Lab 1 Stitching substrings into a byte stream</title>
    <link href="http://rinevard.github.io/wiki/learning/open-course/CS144/labs/lab1-reassembler/"/>
    <id>http://rinevard.github.io/wiki/learning/open-course/CS144/labs/lab1-reassembler/</id>
    <published>2025-12-13T08:55:28.000Z</published>
    <updated>2025-12-15T12:19:14.727Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™ä¸ª Lab é‡Œæˆ‘ä»¬è¦æ‰‹åŠ¨æ„é€ ä¸€ä¸ª IP è¯·æ±‚ï¼Œç„¶åå†™ä¸€ä¸ªæŠŠæ— åºæ•°æ®å˜æˆæœ‰åºæ•°æ®çš„ Reassembler.</p><h2 id="Send-an-Internet-datagram-by-hand"><a href="#Send-an-Internet-datagram-by-hand" class="headerlink" title="Send an Internet datagram by hand"></a>Send an Internet datagram by hand</h2><p>Reliability from unreliability é‚£èŠ‚è¯¾çš„ notesï¼ˆLecture notes - Week 1 Day 2ï¼‰é‡Œè®°å½•äº†ä¸€æ®µç¤ºä¾‹ä»£ç ï¼Œæˆ‘ä»¬æŠŠå®ƒå¤åˆ¶åˆ° ip_raw.cc ç„¶åæ”¹æ”¹å°±èƒ½å‘åŒ…äº†ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"address.hh"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"socket.hh"</span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">auto</span> args <span class="token operator">=</span> <span class="token function">span</span><span class="token punctuation">(</span> argv<span class="token punctuation">,</span> argc <span class="token punctuation">)</span><span class="token punctuation">;</span>  string datagram<span class="token punctuation">;</span>  datagram <span class="token operator">+=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">0b0100'0101</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// version and IHL</span>  datagram <span class="token operator">+=</span> <span class="token function">string</span><span class="token punctuation">(</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// rest of first two lines</span>  datagram <span class="token operator">+=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// TTL</span>  datagram <span class="token operator">+=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// proto</span>  <span class="token comment">// checksum</span>  datagram <span class="token operator">+=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  datagram <span class="token operator">+=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// sender ip</span>  datagram <span class="token operator">+=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  datagram <span class="token operator">+=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">194</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  datagram <span class="token operator">+=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">218</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  datagram <span class="token operator">+=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">138</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// target ip</span>  datagram <span class="token operator">+=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  datagram <span class="token operator">+=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">195</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  datagram <span class="token operator">+=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">159</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  datagram <span class="token operator">+=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    string art<span class="token punctuation">;</span>  art <span class="token operator">+=</span>          <span class="token string">"                "</span><span class="token punctuation">;</span>  art <span class="token operator">+=</span>          <span class="token string">"   /\\_____/\\    "</span><span class="token punctuation">;</span>  art <span class="token operator">+=</span>          <span class="token string">"  /  o   o  \\   "</span><span class="token punctuation">;</span>  art <span class="token operator">+=</span>          <span class="token string">" ( ==  ^  == )  "</span><span class="token punctuation">;</span>  art <span class="token operator">+=</span>          <span class="token string">"  )         (   "</span><span class="token punctuation">;</span>  art <span class="token operator">+=</span>          <span class="token string">" (           )  "</span><span class="token punctuation">;</span>  art <span class="token operator">+=</span>          <span class="token string">"( (  )   (  ) ) "</span><span class="token punctuation">;</span>  art <span class="token operator">+=</span>          <span class="token string">"(__(__)___(__)_)"</span><span class="token punctuation">;</span>  art <span class="token operator">+=</span>          <span class="token string">"  Lyraine Cat!  "</span><span class="token punctuation">;</span>  art <span class="token operator">+=</span>          <span class="token string">"                "</span><span class="token punctuation">;</span>  datagram <span class="token operator">+=</span> art<span class="token punctuation">;</span>  RawSocket <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>datagram<span class="token punctuation">,</span> <span class="token function">Address</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘åœ¨ WSL ä¸Šå¯ä»¥ç”¨ä¸Šé¢çš„ä»£ç ç»™å®¤å‹çš„ç”µè„‘å‘åŒ…ï¼Œä»–èƒ½ç”¨ wireshark ç›‘å¬åˆ°åŒ…ï¼Œä¸‹å›¾æ˜¯ wireshark æˆªå›¾ï¼š</p><p><img src="/images/learning/open-course/CS144/labs/lab1/cattt.jpg"></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬åˆ†æä¸€ä¸‹è¿™æ®µä»£ç åœ¨åšä»€ä¹ˆã€‚æˆ‘ä»¬è¢«è¦æ±‚ä½¿ç”¨ Rawsocket è€ŒéåŸå§‹ socket æ¥å‘åŒ…ï¼ŒRaw Socket ä¸€èˆ¬å·¥ä½œåœ¨ç¬¬ä¸‰å±‚ç½‘ç»œå±‚ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æ‰‹åŠ¨æ„é€  IP æ•°æ®åŒ…ã€‚</p><p>æˆ‘ä»¬å›é¡¾ä¸€ä¸‹ IP header çš„ç»“æ„ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">struct</span> <span class="token class-name">ip</span> <span class="token punctuation">&#123;</span>    uint8 ip_vhl<span class="token punctuation">;</span>  <span class="token comment">// version &lt;&lt; 4 | header length >> 2</span>    uint8 ip_tos<span class="token punctuation">;</span>  <span class="token comment">// type of service</span>    uint16 ip_len<span class="token punctuation">;</span> <span class="token comment">// total length, including this IP header</span>    uint16 ip_id<span class="token punctuation">;</span>  <span class="token comment">// identification</span>    uint16 ip_off<span class="token punctuation">;</span> <span class="token comment">// fragment offset field</span>    uint8 ip_ttl<span class="token punctuation">;</span>  <span class="token comment">// time to live</span>    uint8 ip_p<span class="token punctuation">;</span>    <span class="token comment">// protocol</span>    uint16 ip_sum<span class="token punctuation">;</span> <span class="token comment">// checksum, covers just IP header</span>    uint32 ip_src<span class="token punctuation">,</span> ip_dst<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶åæŒ‰æ ¼å¼å¡«å…¥æ•°æ®å°±è¡Œã€‚</p><h2 id="Reassembler"><a href="#Reassembler" class="headerlink" title="Reassembler"></a>Reassembler</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬è¦å®ç°ä¸€ä¸ªé‡ç»„å™¨ã€‚é‡ç»„å™¨æ¥å—ä¸€ä¸ªä¹±åºçš„æ•°æ®æµï¼ŒæŠŠä»–ä»¬ç»„ç»‡æˆé¡ºåºå¹¶ push åˆ° ByteStream ä¸­ï¼Œè¿™æ ·è¯»è€…å°±èƒ½è¯»å–é¡ºåºæ•°æ®äº†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="/images/learning/open-course/CS144/labs/lab1/stream.png"></p><p>æˆ‘ä»¬ç”¨ç¯å­˜å‚¨åˆ°è¾¾çš„æ•°æ®ï¼Œå¹¶ç»´æŠ¤ä¸€ä¸ª valid_ æ•°ç»„ä»¥è®°å½•ç¯çš„å“ªäº›ä½ç½®æ˜¯æœ‰æ•ˆæ•°æ®ã€‚å¯¹åˆ°è¾¾çš„æ–°æ•°æ®ï¼Œä¸€ä¸ªæœ´ç´ çš„å¤„ç†æ€è·¯å¦‚ä¸‹ï¼Œå¯ä»¥å¯¹ç…§ä»£ç ä¸‹é¢çš„å›¾ç‰‡æ¥ç†è§£ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// æŠŠæ•°æ®å­˜åˆ°ç¯ä¸­</span><span class="token keyword">auto</span> dst <span class="token operator">=</span> <span class="token punctuation">(</span> head_ <span class="token operator">+</span> first_index <span class="token operator">-</span> first_unassembled_idx_ <span class="token punctuation">)</span> <span class="token operator">%</span> ring_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">uint64_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> data<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  ring_<span class="token punctuation">[</span><span class="token punctuation">(</span> dst <span class="token operator">+</span> i <span class="token punctuation">)</span> <span class="token operator">%</span> ring_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>  valid_<span class="token punctuation">[</span><span class="token punctuation">(</span> dst <span class="token operator">+</span> i <span class="token punctuation">)</span> <span class="token operator">%</span> ring_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// å¦‚æœæ–°æ•°æ®å¡«å……äº†å¼€å¤´ä»è€Œæœ‰äº†å¯ä»¥å†™å…¥çš„è¿ç»­æ•°æ®, å†™å…¥ ByteStream</span><span class="token keyword">if</span> <span class="token punctuation">(</span> first_index <span class="token operator">==</span> first_unassembled_idx_ <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// è®¡ç®— written_len, å†™å…¥ ByteStream</span>  <span class="token comment">// æ›´æ–° valid_, first_unassembled_idx, head_</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/images/learning/open-course/CS144/labs/lab1/ring.png" width="70%" height="auto"></p><p>ä¸Šé¢çš„æ€è·¯åªèƒ½å¤„ç†æ–°æ•°æ®çš„ä¸¤ç«¯ï¼ˆfirst_index å’Œ first_indx + data.sizeï¼‰éƒ½åœ¨ç¯å†…çš„æƒ…å†µï¼Œç„¶è€Œæ–°æ•°æ®çš„æŸä¸€ç«¯å¯èƒ½åœ¨ç¯å¤–ï¼Œè¿™æ—¶æˆ‘ä»¬å°±è¦è£å‰ªæ•°æ®ï¼ŒåªæŠŠå’Œç¯é‡å çš„éƒ¨åˆ†å­˜å…¥ç¯ä¸­ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬ç»™å‡ºå®Œæ•´ä»£ç ï¼Œå…ˆæ”¾å¤´æ–‡ä»¶ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Reassembler</span><span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>  <span class="token keyword">explicit</span> <span class="token function">Reassembler</span><span class="token punctuation">(</span> ByteStream<span class="token operator">&amp;&amp;</span> output <span class="token punctuation">)</span>    <span class="token operator">:</span> <span class="token function">output_</span><span class="token punctuation">(</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span> output <span class="token punctuation">)</span> <span class="token punctuation">)</span>    <span class="token punctuation">,</span> <span class="token function">ring_</span><span class="token punctuation">(</span> output_<span class="token punctuation">.</span><span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">available_capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">)</span>    <span class="token punctuation">,</span> <span class="token function">valid_</span><span class="token punctuation">(</span> output_<span class="token punctuation">.</span><span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">available_capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token comment">// ...</span><span class="token keyword">private</span><span class="token operator">:</span>  ByteStream output_<span class="token punctuation">;</span>  <span class="token keyword">uint64_t</span> head_ <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> first_unassembled_idx_ <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> eof_idx_ <span class="token punctuation">&#123;</span> UINT64_MAX <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span> ring_<span class="token punctuation">;</span>  std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span> valid_<span class="token punctuation">;</span> <span class="token comment">// use vector&lt;char> instead of &lt;bool> to improve performance</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶åæ˜¯ insert å’Œ count_bytes_pending çš„å®ç°ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"reassembler.hh"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"debug.hh"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;algorithm></span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token class-name">Reassembler</span><span class="token double-colon punctuation">::</span><span class="token function">insert</span><span class="token punctuation">(</span> <span class="token keyword">uint64_t</span> first_index<span class="token punctuation">,</span> string data<span class="token punctuation">,</span> <span class="token keyword">bool</span> is_last_substring <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> output_<span class="token punctuation">.</span><span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_closed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> is_last_substring <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    eof_idx_ <span class="token operator">=</span> first_index <span class="token operator">+</span> data<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token comment">// Cut overlap data</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> first_index <span class="token operator">&lt;</span> first_unassembled_idx_ <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> <span class="token keyword">uint64_t</span> offset <span class="token operator">=</span> first_unassembled_idx_ <span class="token operator">-</span> first_index<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> offset <span class="token operator">>=</span> data<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    data <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span> offset <span class="token punctuation">)</span><span class="token punctuation">;</span>    first_index <span class="token operator">=</span> first_unassembled_idx_<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token comment">// Copy data into ring</span>  <span class="token keyword">const</span> <span class="token keyword">uint64_t</span> capacity <span class="token operator">=</span> output_<span class="token punctuation">.</span><span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">available_capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> first_index <span class="token operator">>=</span> first_unassembled_idx_ <span class="token operator">+</span> capacity <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">const</span> <span class="token keyword">uint64_t</span> cplen <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span> data<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> capacity <span class="token operator">-</span> <span class="token punctuation">(</span> first_index <span class="token operator">-</span> first_unassembled_idx_ <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> <span class="token keyword">uint64_t</span> dst <span class="token operator">=</span> <span class="token punctuation">(</span> head_ <span class="token operator">+</span> first_index <span class="token operator">-</span> first_unassembled_idx_ <span class="token punctuation">)</span> <span class="token operator">%</span> ring_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> <span class="token keyword">uint64_t</span> len1 <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span> cplen<span class="token punctuation">,</span> ring_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> dst <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> <span class="token keyword">uint64_t</span> len2 <span class="token operator">=</span> cplen <span class="token operator">-</span> len1<span class="token punctuation">;</span>  std<span class="token double-colon punctuation">::</span><span class="token function">copy</span><span class="token punctuation">(</span>    data<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">></span></span></span><span class="token punctuation">(</span> len1 <span class="token punctuation">)</span><span class="token punctuation">,</span> ring_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">></span></span></span><span class="token punctuation">(</span> dst <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  std<span class="token double-colon punctuation">::</span><span class="token function">copy</span><span class="token punctuation">(</span>    data<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">></span></span></span><span class="token punctuation">(</span> len1 <span class="token punctuation">)</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">></span></span></span><span class="token punctuation">(</span> cplen <span class="token punctuation">)</span><span class="token punctuation">,</span> ring_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  std<span class="token double-colon punctuation">::</span><span class="token function">fill</span><span class="token punctuation">(</span> valid_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">></span></span></span><span class="token punctuation">(</span> dst <span class="token punctuation">)</span><span class="token punctuation">,</span> valid_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">></span></span></span><span class="token punctuation">(</span> dst <span class="token operator">+</span> len1 <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  std<span class="token double-colon punctuation">::</span><span class="token function">fill</span><span class="token punctuation">(</span> valid_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> valid_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">></span></span></span><span class="token punctuation">(</span> len2 <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Write into stream if possible</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> first_index <span class="token operator">==</span> first_unassembled_idx_ <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">uint64_t</span> written_len <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span> written_len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> written_len <span class="token operator">&lt;</span> capacity <span class="token operator">&amp;&amp;</span> valid_<span class="token punctuation">[</span><span class="token punctuation">(</span> head_ <span class="token operator">+</span> written_len <span class="token punctuation">)</span> <span class="token operator">%</span> ring_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>          written_len<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      valid_<span class="token punctuation">[</span><span class="token punctuation">(</span> head_ <span class="token operator">+</span> written_len <span class="token punctuation">)</span> <span class="token operator">%</span> ring_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">const</span> <span class="token keyword">uint64_t</span> last <span class="token operator">=</span> <span class="token punctuation">(</span> head_ <span class="token operator">+</span> written_len <span class="token punctuation">)</span> <span class="token operator">%</span> ring_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// push [head_, last) or [head, size) + [0, last) into writer</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> head_ <span class="token operator">&lt;=</span> last <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      output_<span class="token punctuation">.</span><span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span> std<span class="token double-colon punctuation">::</span><span class="token function">string</span><span class="token punctuation">(</span> ring_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">></span></span></span><span class="token punctuation">(</span> head_ <span class="token punctuation">)</span><span class="token punctuation">,</span>                                          ring_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">></span></span></span><span class="token punctuation">(</span> last <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>      output_<span class="token punctuation">.</span><span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span> std<span class="token double-colon punctuation">::</span><span class="token function">string</span><span class="token punctuation">(</span> ring_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">></span></span></span><span class="token punctuation">(</span> head_ <span class="token punctuation">)</span><span class="token punctuation">,</span> ring_<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>      output_<span class="token punctuation">.</span><span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span> std<span class="token double-colon punctuation">::</span><span class="token function">string</span><span class="token punctuation">(</span> ring_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ring_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">></span></span></span><span class="token punctuation">(</span> last <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    first_unassembled_idx_ <span class="token operator">+=</span> written_len<span class="token punctuation">;</span>    head_ <span class="token operator">=</span> last<span class="token punctuation">;</span>    <span class="token comment">// Close writer if all data have been writen into stream</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> first_unassembled_idx_ <span class="token operator">==</span> eof_idx_ <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      output_<span class="token punctuation">.</span><span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// How many bytes are stored in the Reassembler itself?</span><span class="token comment">// This function is for testing only; don't add extra state to support it.</span><span class="token keyword">uint64_t</span> <span class="token class-name">Reassembler</span><span class="token double-colon punctuation">::</span><span class="token function">count_bytes_pending</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span>ranges<span class="token double-colon punctuation">::</span><span class="token function">count</span><span class="token punctuation">(</span> valid_<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ€åè·‘å‡ºäº† 25Gbit/s çš„ç»“æœï¼Œæ˜¯æ–‡æ¡£è¯´çš„â€œtop-of-the-lineâ€çš„ä¸¤å€å¤šğŸ« ğŸ« </p><p><img src="/images/learning/open-course/CS144/labs/lab1/reassembler.png"></p><p>æœ€åè°ˆè°ˆæˆ‘ä¼˜åŒ–æ€§èƒ½çš„æ–¹æ³•ã€‚æˆ‘åœ¨ä¼˜åŒ–æ—¶ä¸»è¦ä»å°‘å–æ¨¡ã€å°‘å†™ for å¾ªç¯å’Œå°‘åˆ†æ”¯ä¸‰æ–¹é¢è€ƒè™‘ã€‚</p><ol><li><p>å°‘å–æ¨¡å’Œå°‘å†™ for å¾ªç¯æ˜¯å¯†åˆ‡ç›¸å…³çš„ã€‚æˆ‘ä»¬åœ¨ç”¨ for å¾ªç¯éå†ç¯æ—¶ç»å¸¸ä¼šå¯¹ç¯çš„é•¿åº¦å–æ¨¡ï¼Œå…¸å‹ä¾‹å­å°±æ¯”å¦‚ä¸‹é¢çš„ä»£ç ï¼š</p> <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">uint64_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cplen<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  ring_<span class="token punctuation">[</span><span class="token punctuation">(</span> dst <span class="token operator">+</span> i <span class="token punctuation">)</span> <span class="token operator">%</span> ring_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p> å–æ¨¡çš„é€Ÿåº¦å¾ˆæ…¢ï¼Œæ‰‹æ“ for å¾ªç¯æ¥é€å­—èŠ‚æ‹·è´ä¹Ÿæ¯” std::copy æ…¢ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨ std::copy æ¥ä»£æ›¿è¿™é‡Œçš„å¾ªç¯ï¼Œå¾—åˆ°ï¼š</p> <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">const</span> <span class="token keyword">uint64_t</span> len1 <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span> cplen<span class="token punctuation">,</span> ring_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> dst <span class="token punctuation">)</span><span class="token punctuation">;</span>std<span class="token double-colon punctuation">::</span><span class="token function">copy</span><span class="token punctuation">(</span>  data<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   data<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> len1<span class="token punctuation">,</span>   ring_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> dst <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>len1 <span class="token operator">&lt;</span> data<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    std<span class="token double-colon punctuation">::</span><span class="token function">copy</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> len1<span class="token punctuation">,</span>     data<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     ring_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p> è¿™èƒ½æŠŠ no overlap çš„é€Ÿåº¦ä» 30Gbit/s æå‡åˆ° 40Gbit/sï¼ŒæŠŠ 10x overlap ä» 5Gbit/s æå‡åˆ° 20Gbit/s</p></li><li><p>ä¸Šé¢çš„æ•ˆæœå·²ç»å¾ˆä¸é”™äº†ï¼Œæˆ‘ä»¬è¿˜èƒ½é€šè¿‡å‡å°‘åˆ†æ”¯é¢„æµ‹çš„å¼€é”€æ¥è¿›ä¸€æ­¥ä¼˜åŒ–æ€§èƒ½ï¼š</p> <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">const</span> <span class="token keyword">uint64_t</span> len1 <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span> cplen<span class="token punctuation">,</span> ring_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> dst <span class="token punctuation">)</span><span class="token punctuation">;</span>std<span class="token double-colon punctuation">::</span><span class="token function">copy</span><span class="token punctuation">(</span>  data<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   data<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> len1<span class="token punctuation">,</span>   ring_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> dst <span class="token punctuation">)</span><span class="token punctuation">;</span>std<span class="token double-colon punctuation">::</span><span class="token function">copy</span><span class="token punctuation">(</span>  data<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> len1<span class="token punctuation">,</span>   data<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> cplen<span class="token punctuation">,</span>   ring_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p> è¿™èƒ½æŠŠ no overlap çš„é€Ÿåº¦ä» 40Gbit/s æå‡åˆ° 70Gbit/sï¼ŒæŠŠ 10x overlap ä» 20Gbit/s æå‡åˆ° 25Gbit/s</p></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;è¿™ä¸ª Lab é‡Œæˆ‘ä»¬è¦æ‰‹åŠ¨æ„é€ ä¸€ä¸ª IP è¯·æ±‚ï¼Œç„¶åå†™ä¸€ä¸ªæŠŠæ— åºæ•°æ®å˜æˆæœ‰åºæ•°æ®çš„ Reassembler.&lt;/p&gt;
&lt;h2 id=&quot;Send-an-Internet-datagram-by-hand&quot;&gt;&lt;a href=&quot;#Send-an-Internet-datagram</summary>
      
    
    
    
    <category term="å…¬å¼€è¯¾" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/"/>
    
    <category term="CS144" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/CS144/"/>
    
    <category term="Labs" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/CS144/Labs/"/>
    
    
  </entry>
  
  <entry>
    <title>Lab 0 Networking Warmup</title>
    <link href="http://rinevard.github.io/wiki/learning/open-course/CS144/labs/lab0-network-warmup/"/>
    <id>http://rinevard.github.io/wiki/learning/open-course/CS144/labs/lab0-network-warmup/</id>
    <published>2025-12-10T10:03:28.000Z</published>
    <updated>2025-12-12T08:26:04.875Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨è¿™ä¸ª Lab é‡Œæˆ‘ä»¬è¦å®ç°ä¸€ä¸ªå‘ GET è¯·æ±‚çš„å‡½æ•°å’Œä¸€ä¸ªâ€œå†…å­˜å­—èŠ‚æµâ€ï¼Œæˆ‘ä»¬å¼€å§‹å§ã€‚</p><h2 id="webget"><a href="#webget" class="headerlink" title="webget"></a>webget</h2><p>é¦–å…ˆæˆ‘ä»¬å›é¡¾ä¸€ä¸‹ CSAPP é‡Œå®¢æˆ·ç«¯ä½¿ç”¨ socket æ¥å£çš„æ–¹æ³•ï¼šgetaddrinfo -&gt; socket -&gt; connect -&gt; read/write -&gt; close</p><p>ç„¶åå¯¹ç…§ socket.hh å’Œ file_descriptor.hh å†™å‡º C++ ç‰ˆæœ¬çš„ä»£ç å°±è¡Œï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">get_URL</span><span class="token punctuation">(</span> <span class="token keyword">const</span> string<span class="token operator">&amp;</span> host<span class="token punctuation">,</span> <span class="token keyword">const</span> string<span class="token operator">&amp;</span> path <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  TCPSocket socket<span class="token punctuation">;</span>  socket<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span> <span class="token function">Address</span><span class="token punctuation">(</span> host<span class="token punctuation">,</span> <span class="token string">"http"</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  socket<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span> <span class="token string">"GET "</span> <span class="token operator">+</span> path <span class="token operator">+</span> <span class="token string">" HTTP/1.1\r\nHost: "</span> <span class="token operator">+</span> host <span class="token operator">+</span> <span class="token string">"\r\nConnection: close\r\n\r\n"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  std<span class="token double-colon punctuation">::</span>string buf<span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token operator">!</span>socket<span class="token punctuation">.</span><span class="token function">eof</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    socket<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span> buf <span class="token punctuation">)</span><span class="token punctuation">;</span>    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> buf<span class="token punctuation">;</span>    buf<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œä¸éœ€è¦æ‰‹åŠ¨è°ƒç”¨ closeï¼Œå› ä¸º file_descriptor.cc çš„ææ„å‡½æ•° ~FDWrapper() è‡ªå·±ä¼šè°ƒç”¨ close. è¿™æ˜¯éµå¾ªäº† C++ çš„ RAII è§„èŒƒã€‚</p><p>æµ‹è¯•ä»£ç çš„åŸç†æ˜¯ webget_t.sh ç”¨ç®¡é“é‡å®šå‘ç¨‹åºè¾“å‡ºï¼Œç„¶åå¯¹æ¯”æ­£ç¡®å€¼ã€‚</p><h2 id="byte-stream"><a href="#byte-stream" class="headerlink" title="byte stream"></a>byte stream</h2><p>æˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ªå†…å­˜å­—èŠ‚æµï¼Œå†™è€…å¯ä»¥å¾€é‡Œé¢å†™ä¸œè¥¿ï¼Œè¯»è€…å¯ä»¥è¯»ï¼Œå­—èŠ‚æµæœ‰æœ€å¤§å®¹é‡ã€‚Lab æ–‡æ¡£è¯´æ— éœ€è€ƒè™‘å¹¶å‘ï¼Œæ‰€ä»¥æˆ‘ä»¬ç®€å•åšä¸ªç¯å½¢é˜Ÿåˆ—ç„¶åè®¾ç½®è¯»å†™å¤´å°±è¡Œï¼ˆæ­»å»çš„ 6S081 è®°å¿†çªç„¶æ”»å‡»æˆ‘ï¼ï¼‰</p><p>é¦–å…ˆè®¾ç½®å‡ ä¸ªæˆå‘˜å˜é‡ï¼Œè¿™é‡Œçš„ head<em> å§‹ç»ˆæŒ‡å‘ç¬¬ä¸€ä¸ªæœ‰æ•ˆæ•°æ®ï¼Œtail</em> å§‹ç»ˆæŒ‡å‘ç©ºä½ç½®ï¼š</p><p><img src="/images/learning/open-course/CS144/labs/lab0/ring.png" width="50%" height="auto"></p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">ByteStream</span><span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>  <span class="token keyword">explicit</span> <span class="token function">ByteStream</span><span class="token punctuation">(</span> <span class="token keyword">uint64_t</span> capacity <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Helper functions (provided) to access the ByteStream's Reader and Writer interfaces</span>  Reader<span class="token operator">&amp;</span> <span class="token function">reader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> Reader<span class="token operator">&amp;</span> <span class="token function">reader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>  Writer<span class="token operator">&amp;</span> <span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> Writer<span class="token operator">&amp;</span> <span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>  <span class="token keyword">void</span> <span class="token function">set_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> error_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>       <span class="token comment">// Signal that the stream suffered an error.</span>  <span class="token keyword">bool</span> <span class="token function">has_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> error_<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// Has the stream had an error?</span><span class="token keyword">protected</span><span class="token operator">:</span>  <span class="token comment">// Please add any additional state to the ByteStream here, and not to the Writer and Reader interfaces.</span>  <span class="token keyword">uint64_t</span> capacity_<span class="token punctuation">;</span>  <span class="token keyword">uint64_t</span> tot_pushed_ <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token keyword">uint64_t</span> head_ <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> tail_ <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span> ring_<span class="token punctuation">;</span>  <span class="token keyword">bool</span> closed_ <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token keyword">bool</span> error_ <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œæˆå‘˜å˜é‡å‘½åç»“å°¾å¸¦ä¸‹åˆ’çº¿æ˜¯ Google C++ Styleï¼Œåˆ©äºåŒºåˆ†æˆå‘˜å˜é‡å’Œå±€éƒ¨å˜é‡ / å‡½æ•°å‚æ•°ã€‚</p><p>ç„¶åè¿™é‡Œçš„ Reader å’Œ Writer æ–¹æ³•æœ‰ä»€ä¹ˆç”¨å‘¢ï¼ŸReader å’Œ Writer ç»§æ‰¿è‡ª ByteStreamï¼Œå…è®¸ç”¨æˆ·ç”¨ä¸åŒè§†è§’çœ‹åŒä¸€ä¸ªå¯¹è±¡ã€‚è¿™ä¹ˆè¯´æœ‰ç‚¹æŠ½è±¡ï¼Œå¯ä»¥çœ‹å‘ byte_stream_helpers.ccï¼Œå®ƒåªæ˜¯åšäº†ç±»å‹è½¬æ¢ã€‚</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">Reader<span class="token operator">&amp;</span> <span class="token class-name">ByteStream</span><span class="token double-colon punctuation">::</span><span class="token function">reader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">static_assert</span><span class="token punctuation">(</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span> Reader <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span> ByteStream <span class="token punctuation">)</span><span class="token punctuation">,</span>                 <span class="token string">"Please add member variables to the ByteStream base, not the ByteStream Reader."</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>Reader<span class="token operator">&amp;</span><span class="token operator">></span></span></span><span class="token punctuation">(</span> <span class="token operator">*</span><span class="token keyword">this</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// NOLINT(*-downcast)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¯»è€…å’Œå†™è€…æ“æ§çš„æ˜¯åŒä¸€ä¸ª ByteStream å¯¹è±¡ï¼Œæˆ‘ä»¬åˆ™æä¾›äº†ä¸¤ç§ä¸åŒçš„è§†è§’ï¼Œæ¯ç§è§†è§’æœ‰ä¸åŒçš„æ“ä½œæ•°æ®çš„æ–¹æ³•ã€‚</p><p>ç„¶åå®ç°ä¸¤ç§è§†è§’å„è‡ªçš„æ¥å£ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"byte_stream.hh"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"debug.hh"</span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token comment">// Leave one space to distinguish between a full ring and an empty ring.</span><span class="token class-name">ByteStream</span><span class="token double-colon punctuation">::</span><span class="token function">ByteStream</span><span class="token punctuation">(</span> <span class="token keyword">uint64_t</span> capacity <span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">capacity_</span><span class="token punctuation">(</span> capacity <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ring_</span><span class="token punctuation">(</span> capacity <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token comment">// Push data to stream, but only as much as available capacity allows.</span><span class="token keyword">void</span> <span class="token class-name">Writer</span><span class="token double-colon punctuation">::</span><span class="token function">push</span><span class="token punctuation">(</span> <span class="token keyword">const</span> string<span class="token operator">&amp;</span> data <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> <span class="token keyword">auto</span> written_len <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span> <span class="token function">available_capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> written_len <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">uint64_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> written_len<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    ring_<span class="token punctuation">[</span>tail_<span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>    tail_ <span class="token operator">=</span> <span class="token punctuation">(</span> tail_ <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token operator">%</span> ring_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  tot_pushed_ <span class="token operator">+=</span> written_len<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Signal that the stream has reached its ending. Nothing more will be written.</span><span class="token keyword">void</span> <span class="token class-name">Writer</span><span class="token double-colon punctuation">::</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  closed_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Has the stream been closed?</span><span class="token keyword">bool</span> <span class="token class-name">Writer</span><span class="token double-colon punctuation">::</span><span class="token function">is_closed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> closed_<span class="token punctuation">;</span> <span class="token comment">// Your code here.</span><span class="token punctuation">&#125;</span><span class="token comment">// How many bytes can be pushed to the stream right now?</span><span class="token keyword">uint64_t</span> <span class="token class-name">Writer</span><span class="token double-colon punctuation">::</span><span class="token function">available_capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span> head_ <span class="token operator">+</span> ring_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> tail_ <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token operator">%</span> ring_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Total number of bytes cumulatively pushed to the stream</span><span class="token keyword">uint64_t</span> <span class="token class-name">Writer</span><span class="token double-colon punctuation">::</span><span class="token function">bytes_pushed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> tot_pushed_<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Peek at the next bytes in the buffer -- ideally as many as possible.</span><span class="token comment">// It's not required to return a string_view of the *whole* buffer, but</span><span class="token comment">// if the peeked string_view is only one byte at a time, it will probably force</span><span class="token comment">// the caller to do a lot of extra work.</span>string_view <span class="token class-name">Reader</span><span class="token double-colon punctuation">::</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> head_ <span class="token operator">==</span> tail_ <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> head_ <span class="token operator">&lt;</span> tail_ <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> ring_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">></span></span></span><span class="token punctuation">(</span> head_ <span class="token punctuation">)</span><span class="token punctuation">,</span> ring_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">></span></span></span><span class="token punctuation">(</span> tail_ <span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> ring_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">></span></span></span><span class="token punctuation">(</span> head_ <span class="token punctuation">)</span><span class="token punctuation">,</span> ring_<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Remove `len` bytes from the buffer.</span><span class="token keyword">void</span> <span class="token class-name">Reader</span><span class="token double-colon punctuation">::</span><span class="token function">pop</span><span class="token punctuation">(</span> <span class="token keyword">uint64_t</span> len <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  head_ <span class="token operator">=</span> <span class="token punctuation">(</span> head_ <span class="token operator">+</span> len <span class="token punctuation">)</span> <span class="token operator">%</span> ring_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Is the stream finished (closed and fully popped)?</span><span class="token keyword">bool</span> <span class="token class-name">Reader</span><span class="token double-colon punctuation">::</span><span class="token function">is_finished</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> closed_ <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> head_ <span class="token operator">==</span> tail_ <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Number of bytes currently buffered (pushed and not popped)</span><span class="token keyword">uint64_t</span> <span class="token class-name">Reader</span><span class="token double-colon punctuation">::</span><span class="token function">bytes_buffered</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span> tail_ <span class="token operator">+</span> ring_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> head_ <span class="token punctuation">)</span> <span class="token operator">%</span> ring_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Total number of bytes cumulatively popped from stream</span><span class="token keyword">uint64_t</span> <span class="token class-name">Reader</span><span class="token double-colon punctuation">::</span><span class="token function">bytes_popped</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> tot_pushed_ <span class="token operator">-</span> <span class="token function">bytes_buffered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œçš„ Reader::peek æ— éœ€è¿”å›æ•´ä¸ªç¯ï¼Œåªéœ€å°½åŠ›è€Œä¸ºï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ head &gt; tail æ—¶åªè¿”å› head åˆ° ring.size éƒ¨åˆ†çš„å†…å®¹è€Œæ²¡å¸¦ä¸Š 0 åˆ° tail çš„å†…å®¹ï¼›è¿™é‡Œçš„ Writer::push æˆ–è®¸å¯ä»¥ç”¨ std::copy æ¥ä¼˜åŒ–ï¼Œä½†æˆ‘å°±ä¸å†™äº†å§ã€‚</p><p>ç„¶åæ”¾ä¸‹æµ‹è¯•ç»“æœï¼š</p><p><img src="/images/learning/open-course/CS144/labs/lab0/test.png" width="70%" height="auto"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;åœ¨è¿™ä¸ª Lab é‡Œæˆ‘ä»¬è¦å®ç°ä¸€ä¸ªå‘ GET è¯·æ±‚çš„å‡½æ•°å’Œä¸€ä¸ªâ€œå†…å­˜å­—èŠ‚æµâ€ï¼Œæˆ‘ä»¬å¼€å§‹å§ã€‚&lt;/p&gt;
&lt;h2 id=&quot;webget&quot;&gt;&lt;a href=&quot;#webget&quot; class=&quot;headerlink&quot; title=&quot;webget&quot;&gt;&lt;/a&gt;webget&lt;/h2&gt;&lt;p&gt;é¦–å…ˆ</summary>
      
    
    
    
    <category term="å…¬å¼€è¯¾" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/"/>
    
    <category term="CS144" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/CS144/"/>
    
    <category term="Labs" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/CS144/Labs/"/>
    
    
  </entry>
  
  <entry>
    <title>Lab 9 mmap</title>
    <link href="http://rinevard.github.io/wiki/learning/open-course/MIT-6.S081/Labs/lab9-mmap/"/>
    <id>http://rinevard.github.io/wiki/learning/open-course/MIT-6.S081/Labs/lab9-mmap/</id>
    <published>2025-12-07T07:24:28.000Z</published>
    <updated>2025-12-07T07:30:24.305Z</updated>
    
    <content type="html"><![CDATA[<p><img src="/images/learning/open-course/MIT-6.S081/labs/lab9-mmap/last.jpg" alt=""></p><p>è¿™ä¸ª Lab è¦æ±‚æˆ‘ä»¬è¦å®ç°ç®€å•ç‰ˆçš„ mmapï¼Œå®ƒæŠŠæ–‡ä»¶æ˜ å°„åˆ°å†…å­˜ä¸­ä»¥æé«˜è®¿é—®æ•ˆç‡ã€‚mmap çš„å®šä¹‰å¯ä»¥å‚è€ƒ <a href="https://linux.die.net/man/2/mmap">man 2 mmap</a>ï¼Œæ€»ä¹‹å®ƒçš„å‚æ•°å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">,</span> <span class="token keyword">int</span> prot<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span>           <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token class-name">off_t</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">munmap</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token class-name">size_t</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä»¬è·³è¿‡ç³»ç»Ÿè°ƒç”¨çš„é…ç½®ï¼Œå› ä¸ºæƒ³å¿…å¤§å®¶å·²ç»å“é‰´çš„å¤Ÿå¤šäº†ã€‚</p><h1 id="sys-mmap-å’Œ-vmfault"><a href="#sys-mmap-å’Œ-vmfault" class="headerlink" title="sys_mmap å’Œ vmfault"></a>sys_mmap å’Œ vmfault</h1><p>Lab è¦æ±‚ lazy allocationï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æŠŠ mmap è¢«è°ƒç”¨æ—¶ä¼ å…¥çš„å‚æ•°è®°å½•åœ¨ä¸€ä¸ªç»“æ„ä½“ä¸­ä»¥ä¾¿åç»­åœ¨ page fault æ—¶æŒ‰éœ€åˆ†é…ï¼Œæˆ‘è®¾è®¡çš„ç»“æ„ä½“å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> valid<span class="token punctuation">;</span>      <span class="token comment">// Is this idx being used?</span>    uint64 st<span class="token punctuation">;</span>     <span class="token comment">// Start of the mmap, page aligned</span>    <span class="token keyword">int</span> len<span class="token punctuation">;</span>     <span class="token comment">// Number of bytes to map</span>    <span class="token keyword">int</span> prot<span class="token punctuation">;</span>       <span class="token comment">// PROT_READ or PROT_WRITE or both</span>    <span class="token keyword">int</span> flags<span class="token punctuation">;</span>      <span class="token comment">// MAP_SHARED or MAP_PRIVATE</span>    <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>f<span class="token punctuation">;</span>         <span class="token comment">// Mapped file</span>    <span class="token keyword">int</span> off<span class="token punctuation">;</span><span class="token punctuation">&#125;</span> mmap<span class="token punctuation">[</span>NMMAP<span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…¶ä¸­ NMMAP è¢«å®šä¹‰åœ¨ param.h ä¸­ã€‚è¿™é‡Œå®šä¹‰æˆ 16 æ˜¯å› ä¸º Lab æ–‡æ¡£è¯´ç”¨é•¿åº¦ä¸º 16 çš„å®šé•¿æ•°ç»„æ¥è®°å½• mmap ä¿¡æ¯å°±å¤Ÿäº†ã€‚</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NMMAP</span> <span class="token expression"><span class="token number">16</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è¿™é‡Œç®€å•èŠä¸‹æˆ‘æ˜¯æ€ä¹ˆè®¾è®¡ç»“æ„ä½“çš„ã€‚æˆ‘åœ¨è®¾è®¡ç»“æ„ä½“æ—¶ä¹ æƒ¯å¿«é€Ÿå†™ä¸€ä¸ªåˆç‰ˆï¼Œç„¶ååœ¨å†™åç»­ä»£ç çš„è¿‡ç¨‹ä¸­è¿­ä»£ã€‚åƒè¿™é‡Œçš„åˆç‰ˆå°±æ˜¯æŠŠ mmap çš„å‚æ•°å…¨å¡è¿›å»å†åŠ ä¸ª valid ä½ï¼Œç„¶åå†™ sys_mmap æ—¶å‘ç° offset é»˜è®¤æ˜¯ 0 äºæ˜¯å°±åˆ æ‰äº† offï¼Œåæ¥åœ¨å†™ sys_munmap æ—¶åˆå‘ç° off æ˜¯æœ‰ç”¨çš„å°±åŠ äº†å›æ¥ã€‚</p><p>æœ‰äº†ç»“æ„ä½“ä»¥åæˆ‘ä»¬å°±èƒ½å®ç° sys_mmap äº†ã€‚åœ¨è¿™ä¸ªå‡½æ•°é‡Œç®€å•åœ°ä¿å­˜æ•°æ®å³å¯ï¼Œæ— éœ€å¤åˆ¶æ–‡ä»¶å†…å®¹åˆ°ç‰©ç†å†…å­˜ä¸­ï¼Œæ¯•ç«Ÿæˆ‘ä»¬æ˜¯ lazy allocation.</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">uint64 <span class="token function">sys_mmap</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> len<span class="token punctuation">,</span> prot<span class="token punctuation">,</span> flags<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>f<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">proc</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>    <span class="token keyword">int</span> i<span class="token punctuation">;</span>    <span class="token comment">// Ignore args[0], `addr`, which is always zero</span>    <span class="token function">argint</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">argint</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>prot<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">argint</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">argfd</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>f<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// Ignore arg[5], `offset`, which is always zero</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>f<span class="token operator">-></span>writable <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> MAP_SHARED<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>prot <span class="token operator">&amp;</span> PROT_WRITE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    p <span class="token operator">=</span> <span class="token function">myproc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NMMAP<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>valid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>valid <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>            p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>st <span class="token operator">=</span> <span class="token function">PGROUNDUP</span><span class="token punctuation">(</span>p<span class="token operator">-></span>sz<span class="token punctuation">)</span><span class="token punctuation">;</span>            p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>len <span class="token operator">=</span> len<span class="token punctuation">;</span>            p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>prot <span class="token operator">=</span> prot<span class="token punctuation">;</span>            p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>flags <span class="token operator">=</span> flags<span class="token punctuation">;</span>            p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>f <span class="token operator">=</span> f<span class="token punctuation">;</span>            p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>off <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token function">filedup</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> NMMAP<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// No space to save metadata for this mmap</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    p<span class="token operator">-></span>sz <span class="token operator">=</span> <span class="token function">PGROUNDUP</span><span class="token punctuation">(</span>p<span class="token operator">-></span>sz<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">PGROUNDUP</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>st<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶åæˆ‘ä»¬éœ€è¦å®ç° page fault æ¥æŠŠä¼ å…¥ mmap çš„æ–‡ä»¶å¤åˆ¶åˆ°ç‰©ç†å†…å­˜ä¸­ã€‚å’Œ cow lab ç±»ä¼¼ï¼Œè¦ä¿®æ”¹ trap.c çš„ usertrap å‡½æ•°ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">r_scause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// system call</span>    <span class="token comment">// ...</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>which_dev <span class="token operator">=</span> <span class="token function">devintr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// ok</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">r_scause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">15</span> <span class="token operator">||</span> <span class="token function">r_scause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">13</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>           <span class="token function">vmfault</span><span class="token punctuation">(</span>p<span class="token operator">-></span>pagetable<span class="token punctuation">,</span> <span class="token function">r_stval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token function">r_scause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">13</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// page fault on mmap page</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// kill process</span>    <span class="token comment">// ...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶åè¿™é‡Œæ˜¯æˆ‘å¯¹ vmfault çš„å®ç°ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">ismapped</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">,</span> uint64 va<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">pte_t</span> <span class="token operator">*</span>pte <span class="token operator">=</span> <span class="token function">walk</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> va<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>pte <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>uint64 <span class="token function">vmfault</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">,</span> uint64 va<span class="token punctuation">,</span> <span class="token keyword">int</span> read<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"vmfault\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"va: %lu, related page: %lu\n"</span><span class="token punctuation">,</span> va<span class="token punctuation">,</span> <span class="token function">PGROUNDDOWN</span><span class="token punctuation">(</span>va<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    uint64 mem<span class="token punctuation">;</span>    <span class="token keyword">int</span> perm<span class="token punctuation">,</span> i<span class="token punctuation">;</span>    uint off<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>f <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">proc</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">myproc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>va <span class="token operator">>=</span> p<span class="token operator">-></span>sz<span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ismapped</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> va<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// Find mmap metadata corresponding to va</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NMMAP<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>valid <span class="token operator">&amp;&amp;</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>st <span class="token operator">&lt;=</span> va <span class="token operator">&amp;&amp;</span>            va <span class="token operator">&lt;</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>st <span class="token operator">+</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            f <span class="token operator">=</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>f<span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>f<span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">// Alloc new page and fill with file data</span>    mem <span class="token operator">=</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span><span class="token function">kalloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mem <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>mem<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">ilock</span><span class="token punctuation">(</span>f<span class="token operator">-></span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>    off <span class="token operator">=</span> <span class="token function">PGROUNDDOWN</span><span class="token punctuation">(</span>va<span class="token punctuation">)</span> <span class="token operator">-</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>st <span class="token operator">+</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>off<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>off <span class="token operator">></span> f<span class="token operator">-></span>ip<span class="token operator">-></span>size<span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">readi</span><span class="token punctuation">(</span>f<span class="token operator">-></span>ip<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> mem<span class="token punctuation">,</span> off<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">iunlock</span><span class="token punctuation">(</span>f<span class="token operator">-></span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// Map page</span>    perm <span class="token operator">=</span> PTE_U<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>prot <span class="token operator">&amp;</span> PROT_READ<span class="token punctuation">)</span>        perm <span class="token operator">|=</span> PTE_R<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>prot <span class="token operator">&amp;</span> PROT_WRITE<span class="token punctuation">)</span>        perm <span class="token operator">|=</span> PTE_W<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mappages</span><span class="token punctuation">(</span>p<span class="token operator">-></span>pagetable<span class="token punctuation">,</span> <span class="token function">PGROUNDDOWN</span><span class="token punctuation">(</span>va<span class="token punctuation">)</span><span class="token punctuation">,</span> PGSIZE<span class="token punctuation">,</span> mem<span class="token punctuation">,</span> perm<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">kfree</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>mem<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> mem<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è‡³æ­¤æˆ‘ä»¬å°±èƒ½é€šè¿‡ç¬¬ä¸€ä¸ª munmap ä¹‹å‰çš„æ‰€æœ‰æµ‹è¯•äº†ã€‚æˆ‘ä»¬å¯èƒ½ä¼šç–‘æƒ‘ï¼Œå¦‚æœä¼ å…¥ mmap çš„ len æ¯” f-&gt;ip-&gt;size å¤§å¾ˆå¤šæ€ä¹ˆåŠï¼Ÿå¯¹ç…§ man æ–‡æ¡£å¯ä»¥å‘ç°æˆ‘ä»¬åº”è¯¥åœ¨è®¿é—®éæ–‡ä»¶åŒºåŸŸæ—¶ï¼ˆè¶…å‡ºæ–‡ä»¶å¤§å°çš„åŒºåŸŸï¼‰åº”è¯¥å‘ SIGBUS ä¿¡å·ï¼Œä½†æ‰€å¹¸æµ‹è¯•ä»£ç æ²¡æœ‰æµ‹è¿™ä¸€ç‚¹ï¼Œå› æ­¤æˆ‘ä»¬åªè¦æŒ‰éœ€åˆ†é¡µå¹¶å¤åˆ¶å°±è¡Œäº†ã€‚å¦‚å®éªŒæ–‡æ¡£æ‰€è¨€ï¼Œâ€œIf mmaptest doesnâ€™t use a mmap feature, you donâ€™t need to implement that feature.â€</p><h1 id="sys-munmap"><a href="#sys-munmap" class="headerlink" title="sys_munmap"></a>sys_munmap</h1><p>æ¥ä¸‹æ¥æˆ‘ä»¬å®ç°ä¸€ä¸ªä¾¿å®œç‰ˆæœ¬çš„ sys_munmap. æ„Ÿè§‰åœ¨è¿™ä¸ª Lab é‡Œè¦ä¸æ–­å›é¡¾ â€If mmaptest doesnâ€™t use a mmap feature, you donâ€™t need to implement that featureâ€ï¼Œä¸ç„¶å®ç°èµ·æ¥å°±æ²¡å®Œæ²¡äº†äº†ğŸ« ğŸ« </p><p>åœ¨ Lab ä¸­ï¼Œmunmap æ€»æ˜¯åœ¨å°è¯• unmap ä¸€å—å½¢å¦‚ [start of a map, mid of this map] æˆ– [mid of a map, end of this map] æˆ– [start of a map, end of this map] çš„åŒºåŸŸã€‚æ€»ä¹‹å°±æ˜¯å®ƒåªåœ¨ä¸€ä¸ª map åŒºåŸŸå†… unmapï¼Œä¸”ä¸ä¼šæŒ–æ´ã€‚</p><p>è‡ªç„¶è€Œç„¶åœ°æˆ‘ä»¬ä¼šæƒ³é—®ï¼Œå¦‚æœä¼ å…¥çš„å‚æ•°è¦†ç›–äº†å¤šä¸ª mmap åŒºåŸŸå‘¢ï¼Ÿå¦‚æœè¦†ç›–äº†æ™®é€šå†…å­˜å‘¢ï¼Ÿå¦‚æœæŒ–äº†ä¸ªæ´å‘¢ï¼Ÿ</p><p>æˆ‘åªèƒ½è¯´ï¼Œä¸è¦å¤šæƒ³ğŸ« ğŸ« ğŸ« ğŸ« </p><p>ä½†æå‡ºäº†é—®é¢˜æ€»å½’æ˜¯è¦ç»™è§£ç­”çš„ï¼Œè™½ç„¶æˆ‘æ²¡æœ‰å®ç°è¿™äº›åŠŸèƒ½ï¼Œè€Œä¸”ä¸å®ç°å®ƒä»¬ä¹Ÿèƒ½é€šè¿‡æµ‹è¯•ã€‚æ ¹æ® man æ‰‹å†Œæ¨æµ‹è¿™å‡ ç§æƒ…å†µçš„è¡Œä¸ºå¦‚ä¸‹ï¼š</p><ol><li>å¦‚æœä¼ å…¥çš„å‚æ•°è¦†ç›–äº†å¤šä¸ª mmap åŒºåŸŸï¼ŒæŠŠå®ƒä»¬éƒ½ unmap æ‰ï¼ˆæ½œåœ¨çš„é£é™©æ˜¯æ¯ä¸ªåŒºåŸŸçš„ flags å¯èƒ½ä¸åŒï¼‰</li><li>å¦‚æœè¦†ç›–äº†æ™®é€šå†…å­˜ï¼ŒæŠŠé‚£å—å†…å­˜é‡Šæ”¾æ‰</li><li>å¦‚æœæŒ–äº†ä¸ªæ´ï¼ŒæŠŠè¿™å— mmap åŒºåŸŸåˆ†å‰²æˆä¸¤å— mmap åŒºåŸŸ</li></ol><p>å›åˆ°æˆ‘ä»¬çš„ Lab. åœ¨å®ç° sys_munmap å‰æœ‰ä¸¤ç‚¹è¦æ³¨æ„ï¼Œç¬¬ä¸€ç‚¹æ˜¯åœ¨ unmap æ—¶è¦æ£€æŸ¥ map åŒºåŸŸæ˜¯å¦è¢«è®¾ä¸º MAP_SHAREDï¼Œå¦‚æœæ˜¯è¦æŠŠå†…å®¹å†™å›æ–‡ä»¶ï¼›ç¬¬äºŒç‚¹æ˜¯æˆ‘ä»¬ç°åœ¨ä½¿ç”¨ lazy allocationï¼Œæ‰€ä»¥è™šæ‹Ÿå†…å­˜ç©ºé—´å¯èƒ½æœ‰æœªæ˜ å°„çš„è™šæ‹Ÿé¡µï¼Œå› æ­¤è¦ä¿®æ”¹ uvmunmap è®©å®ƒåœ¨é‡åˆ°æœªæ˜ å°„çš„è™šæ‹Ÿé¡µæ—¶è·³è¿‡è€Œé panic.</p><p>å…ˆæ¥çœ‹çœ‹ç¬¬ä¸€ç‚¹ï¼Œå†™å›æ–‡ä»¶çš„å®ç°å¦‚ä¸‹ï¼Œå¦‚ hint æ‰€è¨€å‚è€ƒ filewrite å°±è¡Œï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// Write parts of a shared mmap[i] back to file</span><span class="token comment">// theses parts must in mappepd pages and addr must be page-aligned</span><span class="token keyword">int</span> <span class="token function">mmap_wbk</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> uint64 addr<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>f<span class="token punctuation">;</span>    uint64 fileend<span class="token punctuation">,</span> src<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">proc</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>    <span class="token keyword">int</span> pg<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>addr <span class="token operator">%</span> PGSIZE <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    p <span class="token operator">=</span> <span class="token function">myproc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">>=</span> NMMAP <span class="token operator">||</span> <span class="token operator">!</span><span class="token punctuation">(</span>p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> MAP_SHARED<span class="token punctuation">)</span> <span class="token operator">||</span>        addr <span class="token operator">&lt;</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>st <span class="token operator">||</span> addr <span class="token operator">+</span> len <span class="token operator">></span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>st <span class="token operator">+</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    f <span class="token operator">=</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>f<span class="token punctuation">;</span>    <span class="token function">ilock</span><span class="token punctuation">(</span>f<span class="token operator">-></span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>    fileend <span class="token operator">=</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>st <span class="token operator">-</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>off <span class="token operator">+</span> f<span class="token operator">-></span>ip<span class="token operator">-></span>size<span class="token punctuation">;</span>    <span class="token function">iunlock</span><span class="token punctuation">(</span>f<span class="token operator">-></span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// Write valid pages back to file</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>pg <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> pg <span class="token operator">*</span> PGSIZE <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> pg<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">walkaddr</span><span class="token punctuation">(</span>p<span class="token operator">-></span>pagetable<span class="token punctuation">,</span> addr <span class="token operator">+</span> pg <span class="token operator">*</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">int</span> max <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>MAXOPBLOCKS <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> BSIZE<span class="token punctuation">;</span>            <span class="token keyword">int</span> tot <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>PGSIZE<span class="token punctuation">,</span> fileend <span class="token operator">-</span> <span class="token punctuation">(</span>addr <span class="token operator">+</span> pg <span class="token operator">*</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> r<span class="token punctuation">,</span> written <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span>written <span class="token operator">&lt;</span> tot<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">int</span> n <span class="token operator">=</span> tot <span class="token operator">-</span> written<span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">></span> max<span class="token punctuation">)</span>                    n <span class="token operator">=</span> max<span class="token punctuation">;</span>                <span class="token function">begin_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">ilock</span><span class="token punctuation">(</span>f<span class="token operator">-></span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>                src <span class="token operator">=</span> addr <span class="token operator">+</span> pg <span class="token operator">*</span> PGSIZE <span class="token operator">+</span> written<span class="token punctuation">;</span>                r <span class="token operator">=</span> <span class="token function">writei</span><span class="token punctuation">(</span>f<span class="token operator">-></span>ip<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> src<span class="token punctuation">,</span> src <span class="token operator">-</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>st <span class="token operator">+</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>off<span class="token punctuation">,</span>                           n<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">iunlock</span><span class="token punctuation">(</span>f<span class="token operator">-></span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> n<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                written <span class="token operator">+=</span> r<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œä»¥é¡µä¸ºå•ä½å†™å›æ–‡ä»¶æ˜¯å› ä¸º lazy allocation å¯¼è‡´å¯èƒ½å­˜åœ¨æœªè¢«æ˜ å°„çš„è™šæ‹Ÿé¡µï¼Œæˆ‘ä»¬ä¸å¸Œæœ›æŠŠæœªæ˜ å°„çš„é¡µå†™å›æ–‡ä»¶ã€‚å¦å¤–è¦æ³¨æ„å†™å›çš„é•¿åº¦ä¸èƒ½è¶…è¿‡æ–‡ä»¶æœ¬èº«é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯è¯´å¯¹æ¯ä¸€ä¸ªå°è¯•å†™å›çš„é¡µï¼Œå®é™…å†™å…¥çš„é•¿åº¦ä¸ºï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> tot <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>PGSIZE<span class="token punctuation">,</span> fileend <span class="token operator">-</span> <span class="token punctuation">(</span>addr <span class="token operator">+</span> pg <span class="token operator">*</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æˆ‘æŠŠè¿™ä¸ª mmap_wbk å‡½æ•°æ”¾åœ¨ proc.c ä¸­ï¼Œå› ä¸ºåç»­åœ¨ exit å‡½æ•°é‡Œä¹Ÿè¦ç”¨åˆ°å®ƒã€‚</p><p>ç„¶åæ˜¯ç¬¬äºŒç‚¹ï¼Œè®© uvmunmap åœ¨é‡åˆ°æœªæ˜ å°„çš„è™šæ‹Ÿé¡µæ—¶è·³è¿‡è€Œé panicï¼Œæˆ‘ä»¬ç®€å•æ”¹äº†ä¸€ä¸‹ uvmunmapï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">uvmunmap</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">,</span> uint64 va<span class="token punctuation">,</span> uint64 npages<span class="token punctuation">,</span> <span class="token keyword">int</span> do_free<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    uint64 a<span class="token punctuation">;</span>    <span class="token class-name">pte_t</span> <span class="token operator">*</span>pte<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>va <span class="token operator">%</span> PGSIZE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmunmap: not aligned"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>a <span class="token operator">=</span> va<span class="token punctuation">;</span> a <span class="token operator">&lt;</span> va <span class="token operator">+</span> npages <span class="token operator">*</span> PGSIZE<span class="token punctuation">;</span> a <span class="token operator">+=</span> PGSIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pte <span class="token operator">=</span> <span class="token function">walk</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token comment">// panic("uvmunmap: walk");</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token comment">// panic("uvmunmap: not mapped");</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PTE_FLAGS</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span> <span class="token operator">==</span> PTE_V<span class="token punctuation">)</span>            <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmunmap: not a leaf"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>do_free<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            uint64 pa <span class="token operator">=</span> <span class="token function">PTE2PA</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">kfree</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token operator">*</span>pte <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ€åè®©æˆ‘ä»¬æ¥çœ‹çœ‹ sys_munmapï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">min</span><span class="token expression"><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>uint64 <span class="token function">sys_munmap</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>f<span class="token punctuation">;</span>    uint64 addr<span class="token punctuation">;</span>    <span class="token keyword">int</span> len<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">proc</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>    <span class="token keyword">int</span> i<span class="token punctuation">;</span>    <span class="token function">argaddr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">argint</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>addr <span class="token operator">%</span> PGSIZE <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    p <span class="token operator">=</span> <span class="token function">myproc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// Find mmap corresponding to addr</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NMMAP<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>valid <span class="token operator">&amp;&amp;</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>st <span class="token operator">&lt;=</span> addr <span class="token operator">&amp;&amp;</span>            addr <span class="token operator">&lt;</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>st <span class="token operator">+</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            f <span class="token operator">=</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>f<span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> NMMAP<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// No mmap corresponding to addr</span>        <span class="token function">uvmunmap</span><span class="token punctuation">(</span>p<span class="token operator">-></span>pagetable<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> <span class="token function">PGROUNDUP</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span> <span class="token operator">/</span> PGSIZE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> MAP_SHARED<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mmap_wbk</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> <span class="token function">min</span><span class="token punctuation">(</span>len<span class="token punctuation">,</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>st <span class="token operator">+</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>len <span class="token operator">-</span> addr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span>            <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">uvmunmap</span><span class="token punctuation">(</span>p<span class="token operator">-></span>pagetable<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> <span class="token function">PGROUNDUP</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span> <span class="token operator">/</span> PGSIZE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>addr <span class="token operator">==</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>st <span class="token operator">&amp;&amp;</span> addr <span class="token operator">+</span> len <span class="token operator">==</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>st <span class="token operator">+</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>valid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token function">fileclose</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>addr <span class="token operator">==</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>st<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>st <span class="token operator">+=</span> <span class="token function">PGROUNDUP</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>        p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>len <span class="token operator">-=</span> <span class="token function">PGROUNDUP</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>        p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>off <span class="token operator">+=</span> <span class="token function">PGROUNDUP</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>addr <span class="token operator">+</span> len <span class="token operator">==</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>st <span class="token operator">+</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>len <span class="token operator">-=</span> <span class="token function">PGROUNDUP</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// No need to consider hole punching case in this lab</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å®ƒèƒ½é€šè¿‡æµ‹è¯•ä»£ç ï¼Œä¹Ÿç®—æ˜¯å¤Ÿç”¨äº†å§ğŸ« ğŸ« </p><h1 id="exit-å’Œ-fork"><a href="#exit-å’Œ-fork" class="headerlink" title="exit å’Œ fork"></a>exit å’Œ fork</h1><p>æœ‰äº† munmap çš„ç»éªŒï¼Œexit å‡½æ•°çš„ä¿®æ”¹å°±å¾ˆç®€å•äº†ã€‚æˆ‘æŠŠå…³é—­ mmap çš„ä»£ç æ”¾åœ¨äº†å…³é—­æ–‡ä»¶åé¢ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token keyword">int</span> status<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// ...</span>        <span class="token comment">// Close all open files.</span>    <span class="token comment">// ...</span>    <span class="token comment">// Close all mmaps</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NMMAP<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>valid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>f<span class="token punctuation">;</span>            uint64 addr<span class="token punctuation">;</span>            f <span class="token operator">=</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>f<span class="token punctuation">;</span>            addr <span class="token operator">=</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>st<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> MAP_SHARED<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mmap_wbk</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>len<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"mmap wbk failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> pg <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> pg <span class="token operator">*</span> PGSIZE <span class="token operator">&lt;</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>len<span class="token punctuation">;</span> pg<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">walkaddr</span><span class="token punctuation">(</span>p<span class="token operator">-></span>pagetable<span class="token punctuation">,</span> addr <span class="token operator">+</span> pg <span class="token operator">*</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token function">uvmunmap</span><span class="token punctuation">(</span>p<span class="token operator">-></span>pagetable<span class="token punctuation">,</span> addr <span class="token operator">+</span> pg <span class="token operator">*</span> PGSIZE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>            p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>valid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token function">fileclose</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// ...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è€Œ fork çš„ä¿®æ”¹ä¹Ÿä¸éš¾ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// ...</span>    <span class="token comment">// increment reference counts on open file descriptors.</span>    <span class="token comment">// ...</span>    <span class="token comment">// Copy mmap</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NMMAP<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>valid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            np<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token function">filedup</span><span class="token punctuation">(</span>np<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">safestrcpy</span><span class="token punctuation">(</span>np<span class="token operator">-></span>name<span class="token punctuation">,</span> p<span class="token operator">-></span>name<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>p<span class="token operator">-></span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// ...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å†è§äº†ï¼Œæ‰€æœ‰çš„ 6S081</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab9-mmap/goodbye.png" alt=""></p><p>å®Œç»“æ’’èŠ±ï¼Œæ„Ÿè°¢é™ªä¼´ï¼Bilibili å¹²æ¯ - ( ã‚œ- ã‚œ)ã¤ãƒ­[</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;img src=&quot;/images/learning/open-course/MIT-6.S081/labs/lab9-mmap/last.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;è¿™ä¸ª Lab è¦æ±‚æˆ‘ä»¬è¦å®ç°ç®€å•ç‰ˆçš„ mmapï¼Œå®ƒæŠŠæ–‡ä»¶æ˜ å°„åˆ°å†…å­˜ä¸­ä»¥æé«˜è®¿é—®æ•ˆç‡ã€‚mmap </summary>
      
    
    
    
    <category term="å…¬å¼€è¯¾" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/"/>
    
    <category term="MIT-6.S081" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/MIT-6-S081/"/>
    
    <category term="Labs" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/MIT-6-S081/Labs/"/>
    
    
  </entry>
  
  <entry>
    <title>Lab 8 File System</title>
    <link href="http://rinevard.github.io/wiki/learning/open-course/MIT-6.S081/Labs/lab8-fs/"/>
    <id>http://rinevard.github.io/wiki/learning/open-course/MIT-6.S081/Labs/lab8-fs/</id>
    <published>2025-12-03T15:01:11.000Z</published>
    <updated>2025-12-03T15:03:40.522Z</updated>
    
    <content type="html"><![CDATA[<p>æ„Ÿè§‰ xv6 çš„æ–‡ä»¶ç³»ç»Ÿè¿˜æ˜¯æŒºæœ‰æ·±åº¦çš„ã€‚è¿™ä¸ª lab å¸¦æˆ‘ä»¬ç®€å•å¤ä¹ äº†ä¸‹ inode å¦‚ä½•æŒ‡å‘ blocksï¼Œä»¥åŠé€šè¿‡è·¯å¾„åæŸ¥æ‰¾æ–‡ä»¶çš„æ–¹æ³•ã€‚</p><h1 id="Large-files"><a href="#Large-files" class="headerlink" title="Large files"></a>Large files</h1><p>è¿™é“é¢˜è®©æˆ‘ä»¬å¢å¤§ xv6 æœ€å¤§æ–‡ä»¶çš„å¤§å°ã€‚åŸæœ¬çš„ xv6 çš„æ¯ä¸ª inode æ”¯æŒ 12 ä¸ªæ™®é€šå—å’Œä¸€ä¸ªé—´æ¥å—ï¼Œé‚£ä¹ˆåŸæœ¬çš„æœ€å¤§æ–‡ä»¶å æ® 12 + 256 = 268 ä¸ªå—ã€‚æˆ‘ä»¬éœ€è¦æŠŠ inode ä¿®æ”¹ä¸ºæ”¯æŒ 11 ä¸ªæ™®é€šå—ã€ä¸€ä¸ªé—´æ¥å—ã€ä¸€ä¸ªåŒé‡é—´æ¥å—ï¼Œè¿™æ ·æœ€å¤§æ–‡ä»¶å°±èƒ½å æ® 11 + 256 + 256 * 256 = 65803 ä¸ªå—ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬è¦å» fs.h é‡Œä¿®æ”¹ dinode å’Œä¸€äº›å¸¸é‡çš„å®šä¹‰ï¼Œå†å» file.h é‡Œä¿®æ”¹ inode çš„å®šä¹‰ï¼Œä¸»è¦æ˜¯ä¿®æ”¹ addrsï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NDIRECT</span> <span class="token expression"><span class="token number">11</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NINDIRECT</span> <span class="token expression"><span class="token punctuation">(</span>BSIZE <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>uint<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NDOUBLYINDIRECT</span> <span class="token expression"><span class="token punctuation">(</span>NINDIRECT <span class="token operator">*</span> NINDIRECT<span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAXFILE</span> <span class="token expression"><span class="token punctuation">(</span>NDIRECT <span class="token operator">+</span> NINDIRECT <span class="token operator">+</span> NDOUBLYINDIRECT<span class="token punctuation">)</span></span></span><span class="token keyword">struct</span> <span class="token class-name">dinode</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// å…¶ä»–å†…å®¹ä¿æŒä¸å˜</span>    uint addrs<span class="token punctuation">[</span>NDIRECT <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// å…¶ä»–å†…å®¹ä¿æŒä¸å˜</span>    uint addrs<span class="token punctuation">[</span>NDIRECT <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶åæˆ‘ä»¬å¯ä»¥ç”»ä¸€ç”» ip-&gt;addrs çš„ç»“æ„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab8-fs/doub_indirect.png" alt=""></p><p>å¯¹ç»™å®šçš„ bnï¼Œå¦‚æœå®ƒåœ¨ $[0,11)$ ä¹‹é—´ï¼Œå°±æŸ¥æ‰¾æ™®é€šå—ï¼›å¦‚æœåœ¨ $[11,11+256)$ ä¹‹é—´ï¼Œå°±æŸ¥æ‰¾é—´æ¥å—ï¼›å¦‚æœåœ¨ $[11+256,256+256\times256)$ ä¹‹é—´ï¼Œå°±æŸ¥æ‰¾åŒé‡é—´æ¥å—ã€‚å†å‚è€ƒ bmap åŸæœ‰çš„ä»£ç å°±èƒ½å®Œæˆä¿®æ”¹äº†ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> uint <span class="token function">bmap</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>ip<span class="token punctuation">,</span> uint bn<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    uint addr<span class="token punctuation">,</span> <span class="token operator">*</span>a<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">buf</span> <span class="token operator">*</span>bp<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>bn <span class="token operator">&lt;</span> NDIRECT<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">=</span> ip<span class="token operator">-></span>addrs<span class="token punctuation">[</span>bn<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            addr <span class="token operator">=</span> <span class="token function">balloc</span><span class="token punctuation">(</span>ip<span class="token operator">-></span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>addr <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>            ip<span class="token operator">-></span>addrs<span class="token punctuation">[</span>bn<span class="token punctuation">]</span> <span class="token operator">=</span> addr<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> addr<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    bn <span class="token operator">-=</span> NDIRECT<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>bn <span class="token operator">&lt;</span> NINDIRECT<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// Load indirect block, allocating if necessary.</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">=</span> ip<span class="token operator">-></span>addrs<span class="token punctuation">[</span>NDIRECT<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            addr <span class="token operator">=</span> <span class="token function">balloc</span><span class="token punctuation">(</span>ip<span class="token operator">-></span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>addr <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>            ip<span class="token operator">-></span>addrs<span class="token punctuation">[</span>NDIRECT<span class="token punctuation">]</span> <span class="token operator">=</span> addr<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        bp <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>ip<span class="token operator">-></span>dev<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">;</span>        a <span class="token operator">=</span> <span class="token punctuation">(</span>uint <span class="token operator">*</span><span class="token punctuation">)</span>bp<span class="token operator">-></span>data<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">=</span> a<span class="token punctuation">[</span>bn<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            addr <span class="token operator">=</span> <span class="token function">balloc</span><span class="token punctuation">(</span>ip<span class="token operator">-></span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>addr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                a<span class="token punctuation">[</span>bn<span class="token punctuation">]</span> <span class="token operator">=</span> addr<span class="token punctuation">;</span>                <span class="token function">log_write</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">brelse</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> addr<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    bn <span class="token operator">-=</span> NINDIRECT<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>bn <span class="token operator">&lt;</span> NDOUBLYINDIRECT<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// Load doubly indirect block, allocating if necessary.</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">=</span> ip<span class="token operator">-></span>addrs<span class="token punctuation">[</span>NDIRECT <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            addr <span class="token operator">=</span> <span class="token function">balloc</span><span class="token punctuation">(</span>ip<span class="token operator">-></span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>addr <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>            ip<span class="token operator">-></span>addrs<span class="token punctuation">[</span>NDIRECT <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> addr<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// Load indirect block, allocating if necessary.</span>        bp <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>ip<span class="token operator">-></span>dev<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">;</span>        a <span class="token operator">=</span> <span class="token punctuation">(</span>uint <span class="token operator">*</span><span class="token punctuation">)</span>bp<span class="token operator">-></span>data<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">=</span> a<span class="token punctuation">[</span><span class="token punctuation">(</span>bn <span class="token operator">/</span> NINDIRECT<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            addr <span class="token operator">=</span> <span class="token function">balloc</span><span class="token punctuation">(</span>ip<span class="token operator">-></span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>addr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                a<span class="token punctuation">[</span><span class="token punctuation">(</span>bn <span class="token operator">/</span> NINDIRECT<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> addr<span class="token punctuation">;</span>                <span class="token function">log_write</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">brelse</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>addr <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// Find addr in block</span>        bp <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>ip<span class="token operator">-></span>dev<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">;</span>        a <span class="token operator">=</span> <span class="token punctuation">(</span>uint <span class="token operator">*</span><span class="token punctuation">)</span>bp<span class="token operator">-></span>data<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">=</span> a<span class="token punctuation">[</span>bn <span class="token operator">%</span> NINDIRECT<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            addr <span class="token operator">=</span> <span class="token function">balloc</span><span class="token punctuation">(</span>ip<span class="token operator">-></span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>addr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                a<span class="token punctuation">[</span>bn <span class="token operator">%</span> NINDIRECT<span class="token punctuation">]</span> <span class="token operator">=</span> addr<span class="token punctuation">;</span>                <span class="token function">log_write</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">brelse</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> addr<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"bmap: out of range"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä»¬è¿˜éœ€è¦ä¿®æ”¹ itruncï¼Œå®ƒé‡Šæ”¾ä¼ å…¥çš„ inode å ç”¨çš„æ‰€æœ‰æ•°æ®å—ã€‚ä»¿ç…§ itrunc åŸæœ‰çš„ä»£ç åŠ å…¥é‡Šæ”¾åŒé‡é—´æ¥å—çš„ä»£ç å°±è¡Œï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">itrunc</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>ip<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">buf</span> <span class="token operator">*</span>bp<span class="token punctuation">,</span> <span class="token operator">*</span>bbp<span class="token punctuation">;</span>    uint <span class="token operator">*</span>a<span class="token punctuation">,</span> <span class="token operator">*</span>aa<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NDIRECT<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>ip<span class="token operator">-></span>addrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">bfree</span><span class="token punctuation">(</span>ip<span class="token operator">-></span>dev<span class="token punctuation">,</span> ip<span class="token operator">-></span>addrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            ip<span class="token operator">-></span>addrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ip<span class="token operator">-></span>addrs<span class="token punctuation">[</span>NDIRECT<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        bp <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>ip<span class="token operator">-></span>dev<span class="token punctuation">,</span> ip<span class="token operator">-></span>addrs<span class="token punctuation">[</span>NDIRECT<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        a <span class="token operator">=</span> <span class="token punctuation">(</span>uint <span class="token operator">*</span><span class="token punctuation">)</span>bp<span class="token operator">-></span>data<span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> NINDIRECT<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span>                <span class="token function">bfree</span><span class="token punctuation">(</span>ip<span class="token operator">-></span>dev<span class="token punctuation">,</span> a<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">brelse</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">bfree</span><span class="token punctuation">(</span>ip<span class="token operator">-></span>dev<span class="token punctuation">,</span> ip<span class="token operator">-></span>addrs<span class="token punctuation">[</span>NDIRECT<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ip<span class="token operator">-></span>addrs<span class="token punctuation">[</span>NDIRECT<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ip<span class="token operator">-></span>addrs<span class="token punctuation">[</span>NDIRECT <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// Free doubly indirect block</span>        bp <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>ip<span class="token operator">-></span>dev<span class="token punctuation">,</span> ip<span class="token operator">-></span>addrs<span class="token punctuation">[</span>NDIRECT <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        a <span class="token operator">=</span> <span class="token punctuation">(</span>uint <span class="token operator">*</span><span class="token punctuation">)</span>bp<span class="token operator">-></span>data<span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> NINDIRECT<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// Free indirect block j</span>                bbp <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>ip<span class="token operator">-></span>dev<span class="token punctuation">,</span> a<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                aa <span class="token operator">=</span> <span class="token punctuation">(</span>uint <span class="token operator">*</span><span class="token punctuation">)</span>bbp<span class="token operator">-></span>data<span class="token punctuation">;</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span>k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> NINDIRECT<span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>aa<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span>                        <span class="token function">bfree</span><span class="token punctuation">(</span>ip<span class="token operator">-></span>dev<span class="token punctuation">,</span> aa<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token function">brelse</span><span class="token punctuation">(</span>bbp<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">bfree</span><span class="token punctuation">(</span>ip<span class="token operator">-></span>dev<span class="token punctuation">,</span> a<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">brelse</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">bfree</span><span class="token punctuation">(</span>ip<span class="token operator">-></span>dev<span class="token punctuation">,</span> ip<span class="token operator">-></span>addrs<span class="token punctuation">[</span>NDIRECT <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ip<span class="token operator">-></span>addrs<span class="token punctuation">[</span>NDIRECT <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    ip<span class="token operator">-></span>size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">iupdate</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="Symbolic-links"><a href="#Symbolic-links" class="headerlink" title="Symbolic links"></a>Symbolic links</h1><p>è¿™é“é¢˜è®©æˆ‘ä»¬ç»™ xv6 åŠ å…¥ç¬¦å·é“¾æ¥ï¼Œä¸è¿‡è¿™é‡Œçš„ç¬¦å·é“¾æ¥æ˜¯é’æ˜¥ç‰ˆã€‚ç¬¦å·é“¾æ¥æ­£ç»Ÿç‰ˆåº”è¯¥èƒ½æŒ‡å‘ç›®å½•ï¼Œæˆ‘ä»¬çš„åªèƒ½æŒ‡å‘æ–‡ä»¶ã€‚</p><p>è¿™é‡Œå°±ä¸æ”¾é…ç½®ç³»ç»Ÿè°ƒç”¨çš„ä»£ç äº†ï¼ˆå¤§å®¶éƒ½å·²ç»å“é‰´è¿‡æ— æ•°æ¬¡äº†ï¼‰ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹ man æ‰‹å†Œæ˜¯æ€ä¹ˆä»‹ç» symlink çš„ã€‚è¿™é‡Œæˆ‘ä»¬ä¸»è¦çœ‹ man 2 symlink å’Œ man 7 symlinkï¼Œå‰è€…æ˜¯ç»™ä½¿ç”¨è€…çœ‹çš„å‡½æ•°è¯´æ˜ï¼Œåè€…æ˜¯å‡½æ•°åŸç†ã€‚</p><p><a href="https://linux.die.net/man/2/symlink">symlink(2): make new name for file - Linux man page</a></p><p><a href="https://linux.die.net/man/7/symlink">symlink(7): symbolic link handling - Linux man page</a></p><p>symlink çš„ç­¾åæ˜¯ <code>int symlink(const char *oldpath, const char *newpath);</code>ï¼Œå®ƒåˆ›å»ºä¸€ä¸ªåä¸º newpath çš„æŒ‡å‘ oldpath çš„ç¬¦å·é“¾æ¥æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶é‡Œå­˜å‚¨ç€ oldpath è¿™ä¸ªå­—ç¬¦ä¸²ã€‚</p><p>å¯¹ç…§ hintï¼Œæˆ‘ä»¬çŸ¥é“è¦å» stat.h é‡Œæ–°å¢ä¸€ç§å«ä½œ T_SYMLINK çš„æ–‡ä»¶ç±»å‹ï¼Œè¿™å°±æ˜¯ç¬¦å·é“¾æ¥ç±»å‹ã€‚è‡³æ­¤æˆ‘ä»¬å°±èƒ½æ–°å¢ sys_symlink å‡½æ•°äº†ã€‚</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">uint64 <span class="token function">sys_symlink</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">char</span> old<span class="token punctuation">[</span>MAXPATH<span class="token punctuation">]</span><span class="token punctuation">,</span> new<span class="token punctuation">[</span>MAXPATH<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>ip<span class="token punctuation">;</span>    <span class="token keyword">int</span> len<span class="token punctuation">;</span>    <span class="token function">begin_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">argstr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> old<span class="token punctuation">,</span> MAXPATH<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">argstr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> new<span class="token punctuation">,</span> MAXPATH<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span>        <span class="token punctuation">(</span>ip <span class="token operator">=</span> <span class="token function">create</span><span class="token punctuation">(</span>new<span class="token punctuation">,</span> T_SYMLINK<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>old<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">writei</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span><span class="token operator">&amp;</span>len<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">writei</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>old<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">,</span> len <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">iunlockput</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä¸€å¼€å§‹å¯¹ iunlockã€iunlockput å¾ˆç–‘æƒ‘ï¼Œä¸»è¦æ˜¯ä¸çŸ¥é“ iput æœ‰ä»€ä¹ˆç”¨ã€‚å…¶å® iput å’Œ inode çš„å·¥ä½œæ–¹å¼å¯†åˆ‡ç›¸å…³ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥ç®€è¦åˆ†æä¸€ä¸‹ã€‚è¿™é‡Œæ¶‰åŠåˆ°çš„æ–‡ä»¶æ˜¯ fs.cã€‚</p><p>è€ƒè™‘åˆ°æˆ‘ä»¬åªèƒ½ç›´æ¥å’Œå†…å­˜äº¤äº’ï¼Œè€Œç£ç›˜ä¸Šåˆæœ‰å¾ˆå¤š inodeï¼Œæˆ‘ä»¬ä¼šæŠŠæœ‰äººåœ¨ç”¨çš„çš„ inode ä¿å­˜åœ¨ itable.inode ä¸­ï¼Œå¹¶ç”¨ inode.ref æ¥è®°å½•æœ‰å¤šå°‘äººåœ¨ç”¨ã€‚ç”¨å®Œçš„äººè¦è°ƒç”¨ iput è¯´è‡ªå·±ç”¨å®Œäº†ï¼Œè¿™æ · ref å°±ä¼šå‡å°‘ã€‚æœªæ¥æˆ‘ä»¬åœ¨æŠŠç£ç›˜ inode æ”¾åˆ°å†…å­˜ä¸­æ—¶ä¼šæ‰¾åˆ° ref == 0 çš„ä¸œè¥¿æ¥æ›¿æ¢ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œdirlookup æ‰¾è·¯å¾„å¯¹åº”çš„ inodeï¼Œè¿™ç§â€œæ‰¾â€æœ€ç»ˆæ€»ä¼šè°ƒç”¨ igetï¼Œiget ä¼šæ£€æŸ¥æƒ³æ‰¾çš„ inode åœ¨ä¸åœ¨å†…å­˜ä¸­çš„ itable.inode ä¸­ï¼Œå¦‚æœä¸åœ¨å°±åœ¨ itable.inode é‡Œæ‰¾ä¸ª ref == 0 çš„å…ƒç´ ï¼ŒæŠŠå®ƒæ›¿æ¢æˆæƒ³æ‰¾çš„ inode å¹¶è®¾ç½®å…¶ refã€‚ç›¸åº”åœ°ï¼Œè°ƒç”¨è€…åœ¨ç”¨å®Œ inode åè¦è´Ÿè´£è°ƒç”¨ iput è¯´è‡ªå·±ç”¨å®Œäº†ï¼Œä¸ç„¶ itable.inode çš„ç©ºé—´è¢«å æ»¡åå°±ä¸èƒ½åŠ è½½æ–°çš„ inode äº†ã€‚</p><p>æ‰€ä»¥åœ¨ sys_symlink çš„æœ«å°¾æˆ‘ä»¬è¦è°ƒç”¨ iunlockput è€Œä¸æ˜¯åªè°ƒç”¨ iunlockï¼Œæ¯•ç«Ÿæˆ‘ä»¬åœ¨ sys_symlink é‡Œä¸å†ä½¿ç”¨è¿™ä¸ª inode äº†ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ open å‡½æ•°ã€‚é¦–å…ˆç…§ç€ hint åœ¨ fcntl.h é‡ŒåŠ å…¥ O_NOFOLLOWï¼Œç„¶åå¯¹ç¬¦å·é“¾æ¥ç±»å‹çš„æ–‡ä»¶ï¼Œè¯»å–å…¶ path ç„¶åé¡ºè—¤æ‘¸ç“œå°±è¡Œï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">uint64 <span class="token function">sys_open</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">char</span> path<span class="token punctuation">[</span>MAXPATH<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> fd<span class="token punctuation">,</span> omode<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>f<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>ip<span class="token punctuation">;</span>    <span class="token keyword">int</span> n<span class="token punctuation">,</span> symcnt<span class="token punctuation">,</span> len<span class="token punctuation">;</span>    <span class="token function">argint</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>omode<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token function">argstr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> path<span class="token punctuation">,</span> MAXPATH<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token function">begin_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>omode <span class="token operator">&amp;</span> O_CREATE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        ip <span class="token operator">=</span> <span class="token function">create</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> T_FILE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>ip <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>omode <span class="token operator">&amp;</span> O_NOFOLLOW<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ip <span class="token operator">=</span> <span class="token function">namei</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">ilock</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>ip<span class="token operator">-></span>type <span class="token operator">==</span> T_DIR <span class="token operator">&amp;&amp;</span> omode <span class="token operator">!=</span> O_RDONLY<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">iunlockput</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        symcnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ip <span class="token operator">=</span> <span class="token function">namei</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">ilock</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>ip<span class="token operator">-></span>type <span class="token operator">==</span> T_SYMLINK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            symcnt<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>symcnt <span class="token operator">>=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">iunlockput</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token function">readi</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span><span class="token operator">&amp;</span>len<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">readi</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>path<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">,</span> len <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">iunlockput</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ip <span class="token operator">=</span> <span class="token function">namei</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token function">ilock</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>ip<span class="token operator">-></span>type <span class="token operator">==</span> T_DIR <span class="token operator">&amp;&amp;</span> omode <span class="token operator">!=</span> O_RDONLY<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">iunlockput</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ip<span class="token operator">-></span>type <span class="token operator">==</span> T_DEVICE <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>ip<span class="token operator">-></span>major <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> ip<span class="token operator">-></span>major <span class="token operator">>=</span> NDEV<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">iunlockput</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>f <span class="token operator">=</span> <span class="token function">filealloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span>fd <span class="token operator">=</span> <span class="token function">fdalloc</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span>            <span class="token function">fileclose</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">iunlockput</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ip<span class="token operator">-></span>type <span class="token operator">==</span> T_DEVICE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        f<span class="token operator">-></span>type <span class="token operator">=</span> FD_DEVICE<span class="token punctuation">;</span>        f<span class="token operator">-></span>major <span class="token operator">=</span> ip<span class="token operator">-></span>major<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        f<span class="token operator">-></span>type <span class="token operator">=</span> FD_INODE<span class="token punctuation">;</span>        f<span class="token operator">-></span>off <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    f<span class="token operator">-></span>ip <span class="token operator">=</span> ip<span class="token punctuation">;</span>    f<span class="token operator">-></span>readable <span class="token operator">=</span> <span class="token operator">!</span><span class="token punctuation">(</span>omode <span class="token operator">&amp;</span> O_WRONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>    f<span class="token operator">-></span>writable <span class="token operator">=</span> <span class="token punctuation">(</span>omode <span class="token operator">&amp;</span> O_WRONLY<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>omode <span class="token operator">&amp;</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>omode <span class="token operator">&amp;</span> O_TRUNC<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> ip<span class="token operator">-></span>type <span class="token operator">==</span> T_FILE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">itrunc</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">iunlock</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> fd<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é¡ºæä¸€å¥ï¼Œmake grade æ˜¾ç¤º Timeout FAIL å¯èƒ½æ˜¯å› ä¸ºåå°çš„è¿›ç¨‹å¤ªå¤šäº†å¯¼è‡´ CPU æ²¡æœ‰å…¨åŠ›ä»¥èµ´ã€‚å°½é‡æŠŠåˆ«çš„è¿›ç¨‹ï¼ˆæ¯”å¦‚æµè§ˆå™¨ï¼‰å…³æ‰åªä¿ç•™ä¸€ä¸ªåœ¨è·‘ make grade çš„ç»ˆç«¯ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;æ„Ÿè§‰ xv6 çš„æ–‡ä»¶ç³»ç»Ÿè¿˜æ˜¯æŒºæœ‰æ·±åº¦çš„ã€‚è¿™ä¸ª lab å¸¦æˆ‘ä»¬ç®€å•å¤ä¹ äº†ä¸‹ inode å¦‚ä½•æŒ‡å‘ blocksï¼Œä»¥åŠé€šè¿‡è·¯å¾„åæŸ¥æ‰¾æ–‡ä»¶çš„æ–¹æ³•ã€‚&lt;/p&gt;
&lt;h1 id=&quot;Large-files&quot;&gt;&lt;a href=&quot;#Large-files&quot; class=&quot;headerlink&quot;</summary>
      
    
    
    
    <category term="å…¬å¼€è¯¾" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/"/>
    
    <category term="MIT-6.S081" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/MIT-6-S081/"/>
    
    <category term="Labs" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/MIT-6-S081/Labs/"/>
    
    
  </entry>
  
  <entry>
    <title>Lab 7 Lock</title>
    <link href="http://rinevard.github.io/wiki/learning/open-course/MIT-6.S081/Labs/lab7-lock/"/>
    <id>http://rinevard.github.io/wiki/learning/open-course/MIT-6.S081/Labs/lab7-lock/</id>
    <published>2025-12-02T04:15:29.000Z</published>
    <updated>2025-12-02T04:15:32.298Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™ä¸ª lab è®©æˆ‘ä»¬ç†Ÿæ‚‰å¯¹é”çš„ä½¿ç”¨ã€‚é™¤äº† 2024 çš„é¢˜å¤–æˆ‘è¿˜é¡ºä¾¿åšäº†ä¸‹ 2025 æ–°å¢çš„è¯»å†™é”ï¼ˆ2025 å¹´ç”¨ Read-write lock æ¢æ‰äº† Buffer cacheï¼‰ï¼Œè®©æˆ‘ä»¬ä¾æ¬¡æ¥çœ‹çœ‹è¿™å‡ é“é¢˜ã€‚</p><h1 id="Memory-allocator"><a href="#Memory-allocator" class="headerlink" title="Memory allocator"></a>Memory allocator</h1><p>åœ¨ xv6 é‡Œï¼Œå¤šä¸ªè¿›ç¨‹åŒæ—¶å°è¯•æ–°å¢ / é‡Šæ”¾å†…å­˜æ—¶ä¼šåœ¨ kalloc.c çš„ kmem ä¸Šäº§ç”Ÿæ¿€çƒˆçš„é”ç«äº‰ï¼Œè¿™é“é¢˜è®©æˆ‘ä»¬ç»™æ¯ä¸ª CPU è®¾ç½®ä¸€ä¸ªè‡ªå·±çš„ç©ºé—²å—é“¾è¡¨æ¥ç¼“è§£ç«äº‰é—®é¢˜ã€‚æ¯”è¾ƒ tricky çš„åœ°æ–¹æ˜¯å½“ä¸€ä¸ª CPU çš„ç©ºé—²å—é“¾è¡¨ä¸ºç©ºæ—¶ï¼Œå®ƒè¦å»åˆ«çš„ CPU é‚£é‡Œå·ç©ºé—²å—ã€‚</p><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹æµ‹è¯•ä»£ç åœ¨åšä»€ä¹ˆå§ï¼Œå…ˆæ¥çœ‹çœ‹ test2ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> free0 <span class="token operator">=</span> <span class="token function">countfree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> free1<span class="token punctuation">;</span>    <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token punctuation">(</span>PHYSTOP <span class="token operator">-</span> KERNBASE<span class="token punctuation">)</span> <span class="token operator">/</span> PGSIZE<span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"start test2\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"total free number of pages: %d (out of %d)\n"</span><span class="token punctuation">,</span> free0<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> free0 <span class="token operator">></span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"test2 FAILED: cannot allocate enough memory"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">50</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        free1 <span class="token operator">=</span> <span class="token function">countfree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">==</span> <span class="token number">9</span><span class="token punctuation">)</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>free1 <span class="token operator">!=</span> free0<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"test2 FAIL: losing pages %d %d\n"</span><span class="token punctuation">,</span> free0<span class="token punctuation">,</span> free1<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\ntest2 OK\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œçš„ countfree å‡½æ•°åœ¨ sbrk å°½å¯èƒ½å¤šçš„å†…å­˜ï¼Œè®¡ç®—ä¸€å…±æ–°å¢äº†å¤šå°‘é¡µï¼Œç„¶åè¿”å›æ–°å¢çš„é¡µæ•°ã€‚å¯ä»¥çœ‹å‡º test2 å°±æ˜¯åœ¨æ£€æŸ¥åˆ†é… / é‡Šæ”¾å†…å­˜æ—¶æœ‰æ²¡æœ‰ä¸¢é¡µã€‚</p><p>test1 åˆ™æ›´å¤æ‚ä¸€äº›ã€‚å®ƒæŠŠå¤šè¿›ç¨‹ sbrk å‰åé”è‡ªæ—‹çš„æ€»æ¬¡æ•°å­˜åœ¨ m å’Œ n ä¸­å¹¶è®¡ç®— n - mã€‚å¦‚æœæˆ‘ä»¬çš„å®ç°è¾ƒå¥½ï¼Œé”å°±ä¼šè‡ªæ—‹è¾ƒå°‘ï¼Œå°±èƒ½é€šè¿‡ if (n - m &lt; 10) ç„¶åé€šè¿‡æµ‹è¯•ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> n<span class="token punctuation">,</span> m<span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"start test1\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    m <span class="token operator">=</span> <span class="token function">ntas</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// åˆ›å»º NCHILD ä¸ªå­è¿›ç¨‹å¹¶è®©ä»–ä»¬ä¸æ–­ sbrk</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NCHILD<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// ...</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">int</span> status <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NCHILD<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    n <span class="token operator">=</span> <span class="token function">ntas</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> m <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"test1 OK\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">else</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"test1 FAIL\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œçš„ ntas å¾ˆç¥å¥‡ï¼Œæˆ‘èŠ±äº†è›®é•¿æ—¶é—´æ‰å¼„æ˜ç™½å®ƒæ˜¯æ€ä¹ˆè·å–é”çš„è‡ªæ—‹æ¬¡æ•°çš„ã€‚æ„Ÿå…´è¶£çš„è¯å¯ä»¥çœ‹çœ‹ï¼Œä¸æ„Ÿå…´è¶£çš„è¯è®°ä½å®ƒæœ€ç»ˆå€ŸåŠ©äº† spinlock.c çš„ statslock æ¥è·å–é”çš„è‡ªæ—‹æ€»æ¬¡æ•°å°±è¡Œã€‚</p><p>é¦–å…ˆ ntas è°ƒç”¨äº† statisticsï¼Œçœ‹å‘ statistics.cï¼Œå®ƒåœ¨è¯»å– statistics æ–‡ä»¶ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">statistics</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">int</span> sz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> fd<span class="token punctuation">,</span> i<span class="token punctuation">,</span> n<span class="token punctuation">;</span>    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"statistics"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"stats: open failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> sz<span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf <span class="token operator">+</span> i<span class="token punctuation">,</span> sz <span class="token operator">-</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        i <span class="token operator">+=</span> n<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> i<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é‚£ statistics æ–‡ä»¶åœ¨å“ªå‘¢ï¼Ÿstatistics æ–‡ä»¶åœ¨ init.c é‡Œè¢«åˆå§‹åŒ–ã€‚æˆ‘ä»¬åœ¨å†…æ ¸çš„ stats.c çš„ statsinit é‡Œåˆå§‹åŒ–äº† STATSï¼ŒæŠŠå¯¹å®ƒçš„è¯»è®¾ç½®ä¸ºè°ƒç”¨ statsreadï¼Œå¹¶åœ¨ statsread é‡Œè°ƒç”¨ spinlock.c é‡Œçš„ statslock. æ³¨æ„è¿™é‡Œæœ‰å†…æ ¸çš„ stats.c å’Œç”¨æˆ·çš„ stats.cï¼Œæˆ‘ä»¬è¯´çš„æ˜¯å‰è€…ã€‚</p><p>æ€»ä¹‹ statistics å‡½æ•°ä¼šè¯»å– statisticsï¼Œå¯¹ statistics çš„è¯»ä¼šè°ƒç”¨ statsreadï¼Œstatsread åœ¨ statistics è¢«è¯»å®Œåä¼šè°ƒç”¨ statslock æ¥æ›´æ–°å†…å®¹ã€‚</p><p>æˆ‘ä»¬å½“ç„¶ä¼šé—®ä¸ºä»€ä¹ˆè¦ç»•è¿™ä¹ˆå¤§ä¸€åœˆï¼Œç›´æ¥è¯»spinlock.cé‡Œçš„ä¸œè¥¿ä¸è¡Œå—ï¼Ÿè¿™æ˜¯å› ä¸ºç”¨æˆ·å’Œå†…æ ¸æœ‰éš”ç¦»ã€‚statistics æ˜¯ç”¨æˆ·æ€çš„å‡½æ•°ï¼Œä¸èƒ½ä¹Ÿä¸åº”è¯¥ç›´æ¥è¯»å†…æ ¸çš„ spinlock.c é‡Œçš„æ•°æ®ã€‚</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab7-lock/user_kernel.png" alt=""></p><p>test3 åˆ™æ˜¯ test1 å’Œ test2 çš„æ•´åˆé«˜æ¸…é‡åˆ¶è±ªååŠ å¼ºç‰ˆã€‚æˆ‘çš„ä»£ç èƒ½é€šè¿‡ 2023 å¹´å’Œ 2025 å¹´ç‰ˆæœ¬çš„å®Œæ•´æµ‹è¯•ï¼Œä½†ä¸èƒ½ç¨³å®šé€šè¿‡ 2024 ç‰ˆæœ¬çš„ test3ï¼ˆå¤§éƒ¨åˆ†æ—¶é—´è¿‡ä¸äº†ï¼Œè¿æ°”å¥½èƒ½è¿‡ï¼‰ã€‚</p><p>2023 å¹´çš„ç‰ˆæœ¬æ²¡æœ‰è¿™ç§æ•´åˆæµ‹è¯•ï¼Œ2025 å¹´çš„ç‰ˆæœ¬å†™çš„æ˜¯ n-m &lt; (NCHILD4-1)*10000ï¼Œæ„Ÿè§‰ 2025 æ¯” 2024 çš„æµ‹è¯•æ›´åˆç†ï¼Œé‚£å°±è®¤ä¸ºæˆ‘çš„ä»£ç å·²ç»æ»¡è¶³è¦æ±‚äº†å§ã€‚</p><p>ç„¶åæˆ‘ä»¬ä¸Šä»£ç ã€‚å…ˆæ”¾åœ¨åˆå§‹åŒ–çš„éƒ¨åˆ†å’Œ kfreeï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">spinlock</span> lock<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">run</span> <span class="token operator">*</span>freelist<span class="token punctuation">;</span><span class="token punctuation">&#125;</span> kmems<span class="token punctuation">[</span>NCPU<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">char</span> kmemlockname<span class="token punctuation">[</span>NCPU<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token keyword">int</span> STOLEN_NUM <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">kinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ncpu<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">snprintf</span><span class="token punctuation">(</span>kmemlockname<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>kmemlockname<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"kmem_%d"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">initlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmems<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">,</span> kmemlockname<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">freerange</span><span class="token punctuation">(</span>end<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>PHYSTOP<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">freerange</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>pa_start<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>pa_end<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>    p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">PGROUNDUP</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>pa_start<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> p <span class="token operator">+</span> PGSIZE <span class="token operator">&lt;=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa_end<span class="token punctuation">;</span> p <span class="token operator">+=</span> PGSIZE<span class="token punctuation">)</span>        <span class="token function">kfree</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">kfree</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>pa<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">run</span> <span class="token operator">*</span>r<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>pa <span class="token operator">%</span> PGSIZE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa <span class="token operator">&lt;</span> end <span class="token operator">||</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>pa <span class="token operator">>=</span> PHYSTOP<span class="token punctuation">)</span>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"kfree"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// Fill with junk to catch dangling refs.</span>    <span class="token function">memset</span><span class="token punctuation">(</span>pa<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>    r <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">run</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa<span class="token punctuation">;</span>    <span class="token function">push_off</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> id <span class="token operator">=</span> <span class="token function">cpuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmems<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    r<span class="token operator">-></span>next <span class="token operator">=</span> kmems<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>freelist<span class="token punctuation">;</span>    kmems<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>freelist <span class="token operator">=</span> r<span class="token punctuation">;</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmems<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">pop_off</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä»£ç æ€è·¯å¾ˆæ¸…æ™°ï¼Œæ¯ä¸ª CPU ä¸€ä¸ªè‡ªå·±çš„ç©ºé—²é“¾è¡¨ï¼Œkfree æŠŠé‡Šæ”¾æ‰çš„å—åŠ åˆ°å½“å‰ CPU çš„é“¾è¡¨ä¸Šã€‚</p><p>æˆ‘è¿˜è¯•äº†ä¸‹åœ¨ kinit ç»“å°¾æ‰“å°å‡ºæ¯ä¸ª CPU çš„ç©ºé—²å—é“¾è¡¨é•¿åº¦ï¼Œç„¶åå‘ç°æ‰€æœ‰çš„ç©ºé—²å—éƒ½åœ¨ä¸€ä¸ª CPU é‚£é‡Œã€‚åŸæœ¬æˆ‘è¿˜ä»¥ä¸º freerange çš„è¿‡ç¨‹ä¸­æ¯ä¸ª CPU éƒ½ä¼šè·‘ä¸€è·‘ kfreeï¼Œç„¶åè®©ç©ºé—²å—å‡åŒ€åˆ†å¸ƒåœ¨å„ä¸ª CPU ä¸Šå‘¢ã€‚</p><p>ç„¶åæˆ‘ä»¬çœ‹çœ‹ kallocï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">kalloc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// We can consistently pass the 2025 tests, but occasionally fail the 2024</span>    <span class="token comment">// test3. I think this is good enough, so we won't continue further.</span>    <span class="token keyword">struct</span> <span class="token class-name">run</span> <span class="token operator">*</span>r<span class="token punctuation">;</span>    <span class="token function">push_off</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> id <span class="token operator">=</span> <span class="token function">cpuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmems<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    r <span class="token operator">=</span> kmems<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>freelist<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        kmems<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>freelist <span class="token operator">=</span> r<span class="token operator">-></span>next<span class="token punctuation">;</span>        <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmems<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// There isn't a fixed acquire order for CPU locks</span>        <span class="token comment">// so release the lock before acquiring other locks to avoid deadlock</span>        <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmems<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">struct</span> <span class="token class-name">run</span> <span class="token operator">*</span>stolen_head <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">struct</span> <span class="token class-name">run</span> <span class="token operator">*</span>stolen_end <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token comment">// Steal STOLEN_NUM pages from another CPU's free list</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token punctuation">(</span>id <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">+</span> ncpu<span class="token punctuation">)</span> <span class="token operator">%</span> ncpu<span class="token punctuation">;</span> i <span class="token operator">!=</span> id<span class="token punctuation">;</span>             i <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">+</span> ncpu<span class="token punctuation">)</span> <span class="token operator">%</span> ncpu<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmems<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>kmems<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>freelist<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmems<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            stolen_head <span class="token operator">=</span> kmems<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>freelist<span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">(</span>kmems<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>freelist<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>cnt <span class="token operator">&lt;</span> STOLEN_NUM<span class="token punctuation">)</span><span class="token punctuation">;</span>                 cnt<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                stolen_end <span class="token operator">=</span> kmems<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>freelist<span class="token punctuation">;</span>                kmems<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>freelist <span class="token operator">=</span> stolen_end<span class="token operator">-></span>next<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            stolen_end<span class="token operator">-></span>next <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmems<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>stolen_head<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmems<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>            stolen_end<span class="token operator">-></span>next <span class="token operator">=</span> kmems<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>freelist<span class="token punctuation">;</span>            kmems<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>freelist <span class="token operator">=</span> stolen_head<span class="token punctuation">;</span>            r <span class="token operator">=</span> kmems<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>freelist<span class="token punctuation">;</span>            kmems<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>freelist <span class="token operator">=</span> r<span class="token operator">-></span>next<span class="token punctuation">;</span>            <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmems<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">pop_off</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">)</span>        <span class="token function">memset</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>r<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// fill with junk</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>r<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œæ¯”è¾ƒ trickky çš„å°±æ˜¯ else é‡Œçªƒå–åˆ«çš„ CPU çš„å—çš„éƒ¨åˆ†ã€‚é¦–å…ˆå¦‚æˆ‘çš„æ³¨é‡Šæ‰€è¨€ï¼Œå„ä¸ª CPU çš„ kmem lock æ²¡æœ‰å›ºå®šçš„è·å–é¡ºåºï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å…ˆé‡Šæ”¾è‡ªå·±çš„ kmem lock å†å¼€å·ï¼Œä¿è¯åŒä¸€æ—¶é—´åªæ‹¿ç€ä¸€ä¸ª CPU çš„ kmem lockï¼Œä¸ç„¶æœ‰æ­»é”é£é™©ã€‚</p><p>ç„¶åæˆ‘ä»¬ä»å½“å‰ CPU å¼€å§‹å¾€åéå†ï¼Œæ‰¾åˆ°åˆé€‚çš„ CPU ä»¥åå°±æŠ“å®ƒçš„é”ç„¶åå· STOLEN_NUM ä¸ªå—æš‚å­˜åœ¨ stolen_head è¿™ä¸ªé“¾è¡¨é‡Œï¼Œå·å®Œä»¥åé‡Šæ”¾å®ƒçš„é”å¹¶æŠ“è‡ªå·±çš„é”å†æŠŠé“¾è¡¨æ¥åˆ°è‡ªå·±å¤´ä¸Šã€‚</p><p>è¿™æ ·ä¸€æ¥çªƒå–å’Œæ–°å¢å—éƒ½æ˜¯åŸå­æ€§çš„ï¼Œä¸ä¼šæœ‰å¹¶å‘é—®é¢˜ã€‚</p><p>æˆ‘æµ‹å‡ºæ¥è®¾ç½® STOLEN_NUM ä¸º 1 æˆ– 8 æ—¶æ•ˆæœæœ€å¥½ï¼Œæ›´å¤§åè€Œæ•ˆæœæ¬ ä½³ï¼ŒæŒºç¥å¥‡çš„ã€‚</p><h1 id="Buffer-cache"><a href="#Buffer-cache" class="headerlink" title="Buffer cache"></a>Buffer cache</h1><p>æ–‡ä»¶ç³»ç»Ÿçš„ç¼“å­˜å±‚ä¹Ÿæœ‰ä¸€ä¸ªè¾ƒæ¿€çƒˆçš„é”ç«äº‰ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æŠŠç¼“å­˜é“¾è¡¨æ‹†åˆ†æˆè‹¥å¹²ä¸ªå°çš„é“¾è¡¨ï¼Œç»™æ¯ä¸ªé“¾è¡¨è®¾ç½®å•ç‹¬çš„é”æ¥ç¼“è§£ç«äº‰ã€‚</p><p>é‚£ä¹ˆæ€ä¹ˆæ‹†åˆ†é“¾è¡¨å‘¢ï¼Ÿæˆ‘ä»¬çŸ¥é“æ¯ä¸ª block æœ‰ blocknoï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥æŠŠ block æ”¾åˆ°ç¼–å·ä¸º hash(blockno) çš„é“¾è¡¨ä¸­ã€‚åŸºæœ¬æ€è·¯å°±æ˜¯è¿™æ ·ï¼Œæ¥ä¸‹æ¥çœ‹ä»£ç å§ï¼Œé¦–å…ˆæ˜¯åˆå§‹åŒ–éƒ¨åˆ†ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BUCKET_SIZE</span> <span class="token expression"><span class="token number">13</span></span></span><span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">spinlock</span>        steal_lock<span class="token punctuation">;</span> <span class="token comment">// steal lock, only one process is stealing at a time</span>    <span class="token keyword">struct</span> <span class="token class-name">buf</span> buf<span class="token punctuation">[</span>NBUF<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">buf</span> head<span class="token punctuation">;</span><span class="token punctuation">&#125;</span> bcache<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">spinlock</span> lock<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">buf</span> head<span class="token punctuation">;</span><span class="token punctuation">&#125;</span> buckets<span class="token punctuation">[</span>BUCKET_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>uint <span class="token function">hash</span><span class="token punctuation">(</span>uint blockno<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> blockno <span class="token operator">%</span> BUCKET_SIZE<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">binit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">buf</span> <span class="token operator">*</span>b<span class="token punctuation">;</span>    <span class="token function">initlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>steal_lock<span class="token punctuation">,</span> <span class="token string">"bcache"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> BUCKET_SIZE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">initlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">,</span> <span class="token string">"bcache.bucket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// Put all buffers into bucket[0] initially</span>    <span class="token keyword">struct</span> <span class="token class-name">buf</span> <span class="token operator">*</span>cur<span class="token punctuation">;</span>    cur <span class="token operator">=</span> <span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>head<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>b <span class="token operator">=</span> bcache<span class="token punctuation">.</span>buf<span class="token punctuation">;</span> b <span class="token operator">&lt;</span> bcache<span class="token punctuation">.</span>buf <span class="token operator">+</span> NBUF<span class="token punctuation">;</span> b<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        cur<span class="token operator">-></span>next <span class="token operator">=</span> b<span class="token punctuation">;</span>        b<span class="token operator">-></span>prev <span class="token operator">=</span> cur<span class="token punctuation">;</span>        <span class="token function">initsleeplock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token operator">-></span>lock<span class="token punctuation">,</span> <span class="token string">"buffer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        cur <span class="token operator">=</span> b<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œä¸»è¦æ˜¯å¯¹é“¾è¡¨åšäº†ä¸‹æ‹†åˆ†ã€‚è¿™é‡Œçš„ steal_lock å’Œæ¥ä¸‹æ¥çš„ bget ç›¸å…³ï¼Œä¸»è¦æ˜¯ä¸ºäº†é˜²æ­¢ä¸‹é¢è¿™ç§æƒ…å†µï¼š</p><ol><li>è¿›ç¨‹ A å’Œè¿›ç¨‹ B éƒ½åœ¨è¯·æ±‚ blocknoï¼Œæˆ‘ä»¬ä»¤ dest = hash(blockno)</li><li>è¿›ç¨‹ A å’Œ B éƒ½æ²¡åœ¨ buckets[dest] æ‰¾åˆ°å—ï¼Œå¼€å§‹çªƒå–ã€‚</li><li>è¿›ç¨‹ B æ¯” A å…ˆçªƒå–åˆ°äº†ä¸€ä¸ªç©ºé—²å—ï¼ŒæŠŠå®ƒæ”¾è¿›äº† buckets[dest] å¹¶å¡«å…¥äº†æ•°æ®ã€‚</li><li>è¿›ç¨‹ A ä¹Ÿæ‰¾åˆ°äº†ä¸€ä¸ªç©ºé—²å—å¹¶æŠŠå®ƒæ”¾å…¥ buckets[dest] å¹¶å¡«å…¥æ•°æ®ã€‚</li><li>è¿™ä¼šå¯¼è‡´ä¸¤ä¸ª buf æœ‰ç›¸åŒçš„ blocknoï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚</li></ol><p>è¿™é‡Œçš„ steal_lock ä¿è¯åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªè¿›ç¨‹åœ¨è¯•å›¾çªƒå–åˆ«çš„ bucket çš„ buf. é…åˆåœ¨çªƒå–å‰å†æ¬¡æ£€æŸ¥ä¸€é bucket[dest] å°±èƒ½é¿å…ä¸Šè¿°æƒ…å†µçš„å‘ç”Ÿã€‚</p><p>æˆ‘ä»¬ç°åœ¨æ¥çœ‹çœ‹ bgetï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">buf</span> <span class="token operator">*</span><span class="token function">bget</span><span class="token punctuation">(</span>uint dev<span class="token punctuation">,</span> uint blockno<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">buf</span> <span class="token operator">*</span>b<span class="token punctuation">;</span>    uint dest <span class="token operator">=</span> <span class="token function">hash</span><span class="token punctuation">(</span>blockno<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>dest<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// Is the block already cached?</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>b <span class="token operator">=</span> buckets<span class="token punctuation">[</span>dest<span class="token punctuation">]</span><span class="token punctuation">.</span>head<span class="token punctuation">.</span>next<span class="token punctuation">;</span> b<span class="token punctuation">;</span> b <span class="token operator">=</span> b<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token operator">-></span>dev <span class="token operator">==</span> dev <span class="token operator">&amp;&amp;</span> b<span class="token operator">-></span>blockno <span class="token operator">==</span> blockno<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            b<span class="token operator">-></span>refcnt<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>dest<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">acquiresleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> b<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// --------------------ä¸‹é¢æ˜¯çªƒå–ä»£ç --------------------</span>    <span class="token comment">// Not cached.</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>dest<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>steal_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>dest<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// double check, other process might have stolen before we steal</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>b <span class="token operator">=</span> buckets<span class="token punctuation">[</span>dest<span class="token punctuation">]</span><span class="token punctuation">.</span>head<span class="token punctuation">.</span>next<span class="token punctuation">;</span> b<span class="token punctuation">;</span> b <span class="token operator">=</span> b<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token operator">-></span>dev <span class="token operator">==</span> dev <span class="token operator">&amp;&amp;</span> b<span class="token operator">-></span>blockno <span class="token operator">==</span> blockno<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            b<span class="token operator">-></span>refcnt<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>dest<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>steal_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">acquiresleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> b<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>dest<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// steal from another bucket</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> BUCKET_SIZE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// iterate through bucket to find a free buf</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>b <span class="token operator">=</span> buckets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>head<span class="token punctuation">.</span>next<span class="token punctuation">;</span> b<span class="token punctuation">;</span> b <span class="token operator">=</span> b<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token operator">-></span>refcnt <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// remove b from orig bucket</span>                b<span class="token operator">-></span>prev<span class="token operator">-></span>next <span class="token operator">=</span> b<span class="token operator">-></span>next<span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    b<span class="token operator">-></span>next<span class="token operator">-></span>prev <span class="token operator">=</span> b<span class="token operator">-></span>prev<span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                b<span class="token operator">-></span>prev <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                b<span class="token operator">-></span>next <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// put b into dest bucket</span>                <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>dest<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>                b<span class="token operator">-></span>prev <span class="token operator">=</span> <span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>dest<span class="token punctuation">]</span><span class="token punctuation">.</span>head<span class="token punctuation">;</span>                b<span class="token operator">-></span>next <span class="token operator">=</span> buckets<span class="token punctuation">[</span>dest<span class="token punctuation">]</span><span class="token punctuation">.</span>head<span class="token punctuation">.</span>next<span class="token punctuation">;</span>                b<span class="token operator">-></span>prev<span class="token operator">-></span>next <span class="token operator">=</span> b<span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    b<span class="token operator">-></span>next<span class="token operator">-></span>prev <span class="token operator">=</span> b<span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                b<span class="token operator">-></span>dev <span class="token operator">=</span> dev<span class="token punctuation">;</span>                b<span class="token operator">-></span>blockno <span class="token operator">=</span> blockno<span class="token punctuation">;</span>                b<span class="token operator">-></span>valid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                b<span class="token operator">-></span>refcnt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>                <span class="token function">acquiresleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>dest<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>steal_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> b<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"bget: no buffers"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¹Ÿæœ‰ä¸åŠ  steal_lock çš„å†™æ³•ï¼Œå¯ä»¥åœ¨å¡«å…¥æ•°æ®å‰æ£€æŸ¥ buckets[dest] ä¸­æ˜¯å¦æœ‰ blockno å¯¹åº”çš„ bufï¼Œå¦‚æœæœ‰å°±ä¸å¡«æ•°æ®è€Œæ˜¯æŠŠç©ºå—åŠ å…¥ buckets[dest]ï¼Œå¦‚æœæ²¡æœ‰å†å¡«æ•°æ®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">buf</span> <span class="token operator">*</span><span class="token function">bget</span><span class="token punctuation">(</span>uint dev<span class="token punctuation">,</span> uint blockno<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">buf</span> <span class="token operator">*</span>b<span class="token punctuation">;</span>    uint dest <span class="token operator">=</span> <span class="token function">hash</span><span class="token punctuation">(</span>blockno<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>dest<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// Is the block already cached?</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>b <span class="token operator">=</span> buckets<span class="token punctuation">[</span>dest<span class="token punctuation">]</span><span class="token punctuation">.</span>head<span class="token punctuation">.</span>next<span class="token punctuation">;</span> b<span class="token punctuation">;</span> b <span class="token operator">=</span> b<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token operator">-></span>dev <span class="token operator">==</span> dev <span class="token operator">&amp;&amp;</span> b<span class="token operator">-></span>blockno <span class="token operator">==</span> blockno<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            b<span class="token operator">-></span>refcnt<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>dest<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">acquiresleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> b<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// Not cached.</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>dest<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// steal from another bucket</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> BUCKET_SIZE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// iterate through bucket to find a free buf</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>b <span class="token operator">=</span> buckets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>head<span class="token punctuation">.</span>next<span class="token punctuation">;</span> b<span class="token punctuation">;</span> b <span class="token operator">=</span> b<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token operator">-></span>refcnt <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// remove b from orig bucket</span>                b<span class="token operator">-></span>prev<span class="token operator">-></span>next <span class="token operator">=</span> b<span class="token operator">-></span>next<span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    b<span class="token operator">-></span>next<span class="token operator">-></span>prev <span class="token operator">=</span> b<span class="token operator">-></span>prev<span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                b<span class="token operator">-></span>prev <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                b<span class="token operator">-></span>next <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// put b into dest bucket</span>                <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>dest<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>                b<span class="token operator">-></span>prev <span class="token operator">=</span> <span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>dest<span class="token punctuation">]</span><span class="token punctuation">.</span>head<span class="token punctuation">;</span>                b<span class="token operator">-></span>next <span class="token operator">=</span> buckets<span class="token punctuation">[</span>dest<span class="token punctuation">]</span><span class="token punctuation">.</span>head<span class="token punctuation">.</span>next<span class="token punctuation">;</span>                b<span class="token operator">-></span>prev<span class="token operator">-></span>next <span class="token operator">=</span> b<span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    b<span class="token operator">-></span>next<span class="token operator">-></span>prev <span class="token operator">=</span> b<span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token comment">// double check, other process might have stolen before we steal</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">buf</span> <span class="token operator">*</span>check <span class="token operator">=</span> buckets<span class="token punctuation">[</span>dest<span class="token punctuation">]</span><span class="token punctuation">.</span>head<span class="token punctuation">.</span>next<span class="token punctuation">;</span> check<span class="token punctuation">;</span>                     check <span class="token operator">=</span> check<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>check<span class="token operator">-></span>dev <span class="token operator">==</span> dev <span class="token operator">&amp;&amp;</span> check<span class="token operator">-></span>blockno <span class="token operator">==</span> blockno<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                        check<span class="token operator">-></span>refcnt<span class="token operator">++</span><span class="token punctuation">;</span>                        <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>dest<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token function">acquiresleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>check<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">return</span> check<span class="token punctuation">;</span>                    <span class="token punctuation">&#125;</span>                <span class="token punctuation">&#125;</span>                b<span class="token operator">-></span>dev <span class="token operator">=</span> dev<span class="token punctuation">;</span>                b<span class="token operator">-></span>blockno <span class="token operator">=</span> blockno<span class="token punctuation">;</span>                b<span class="token operator">-></span>valid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                b<span class="token operator">-></span>refcnt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>                <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>dest<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">acquiresleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> b<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"bget: no buffers"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ€åå‡ ä¸ªè¦æ”¹çš„å‡½æ•°æŠŠåŸæœ¬çš„é”æ¢æˆ bucket çš„é”å°±å¯ä»¥äº†ã€‚</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">brelse</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">buf</span> <span class="token operator">*</span>b<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">holdingsleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"brelse"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">releasesleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    uint idx <span class="token operator">=</span> <span class="token function">hash</span><span class="token punctuation">(</span>b<span class="token operator">-></span>blockno<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    b<span class="token operator">-></span>refcnt<span class="token operator">--</span><span class="token punctuation">;</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">bpin</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">buf</span> <span class="token operator">*</span>b<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    uint idx <span class="token operator">=</span> <span class="token function">hash</span><span class="token punctuation">(</span>b<span class="token operator">-></span>blockno<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    b<span class="token operator">-></span>refcnt<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">bunpin</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">buf</span> <span class="token operator">*</span>b<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    uint idx <span class="token operator">=</span> <span class="token function">hash</span><span class="token punctuation">(</span>b<span class="token operator">-></span>blockno<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    b<span class="token operator">-></span>refcnt<span class="token operator">--</span><span class="token punctuation">;</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="Read-write-lock"><a href="#Read-write-lock" class="headerlink" title="Read-write lock"></a>Read-write lock</h1><p>æˆ‘è¿˜æŠ½ç©ºåšäº†ä¸‹ 2025 ç‰ˆæœ¬æ–°å¢çš„ Read-write lockï¼Œè¿™è¦æ±‚æˆ‘ä»¬å®ç°ä¸€ä¸ªè¯»å†™é”ã€‚è¯»å†™é”æŠŠç”¨æˆ·åˆ†ä¸ºè¯»è€…å’Œå†™è€…ï¼ŒåŒä¸€æ—¶é—´å¯ä»¥æœ‰å¤šä¸ªè¯»è€…æˆ–ä¸€ä¸ªå†™è€…æŒæœ‰è¯»å†™é”ã€‚å¦å¤–åœ¨è¿™é“é¢˜é‡Œï¼Œå¦‚æœè¯»è€…å’Œå†™è€…åŒæ—¶åœ¨ç­‰å¾…ï¼Œå†™è€…ä¼˜å…ˆæŒé”ã€‚</p><p>æˆ‘çš„å®ç°æ€è·¯è¿˜æ˜¯æ¯”è¾ƒæœ´ç´ çš„ï¼Œæˆ‘ä»¬å…ˆçœ‹æ•°æ®ç»“æ„å§ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">rwspinlock</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">spinlock</span> l<span class="token punctuation">;</span>    <span class="token keyword">int</span> readers<span class="token punctuation">;</span>    <span class="token keyword">int</span> writer_active<span class="token punctuation">;</span> <span class="token comment">// 0 or 1</span>    <span class="token keyword">int</span> waiting_writers<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¯»è€…ä»…åœ¨æ²¡æœ‰å†™è€…æŒé”ä¸”æ²¡æœ‰å†™è€…åœ¨ç­‰å¾…æ—¶æ‰èƒ½æŒé”ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ writer_active å’Œ waiting_writers ä¸¤ä¸ªå­—æ®µï¼›å†™è€…ä»…åœ¨æ²¡æœ‰åˆ«çš„å†™è€…æŒé”ä¸”æ²¡æœ‰è¯»è€…æŒé”æ—¶æ‰èƒ½æŒé”ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿéœ€è¦ readers å­—æ®µã€‚è¿™é‡Œçš„ spinlock åˆ™æ˜¯ä¸ºäº†ä¿æŠ¤è¿™äº›å…±äº«æ•°æ®ã€‚</p><p>å…¶å®ä¹Ÿå¯ä»¥ä¸ç”¨ spinlock è€Œå…¨ç”¨åŸå­è¯­å¥å†™ï¼Œä½†æˆ‘æ„Ÿè§‰å¤ªéš¾äº†å°±æ²¡è¿™ä¹ˆåšã€‚</p><p>å‡½æ•°çš„å®ç°æ€è·¯ä¹Ÿæ¯”è¾ƒæœ´ç´ ï¼Œå¯ä»¥ç›´æ¥çœ‹ä»£ç ã€‚è¦æ³¨æ„æˆ‘ä»¬è¢«è¦æ±‚å®ç°è‡ªæ—‹ç‰ˆæœ¬çš„è¯»å†™é”ï¼Œæ‰€ä»¥åœ¨ acquire çš„æ¡ä»¶ä¸æ»¡è¶³æ—¶æˆ‘ä»¬ä¸èƒ½ sleepï¼Œè€Œåº”é‡Šæ”¾é”ç„¶åä¸æ–­å¾ªç¯ã€‚</p><p>ç°å®é‡Œä¹Ÿå­˜åœ¨ç¡çœ ç‰ˆæœ¬çš„è¯»å†™é”ï¼Œä¸è¿‡è¿™å’Œæˆ‘ä»¬çš„ lab æ²¡å…³ç³»ã€‚</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">read_acquire_inner</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">rwspinlock</span> <span class="token operator">*</span>rwlk<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlk<span class="token operator">-></span>l<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>rwlk<span class="token operator">-></span>writer_active <span class="token operator">||</span> rwlk<span class="token operator">-></span>waiting_writers <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlk<span class="token operator">-></span>l<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">continue</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    rwlk<span class="token operator">-></span>readers<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlk<span class="token operator">-></span>l<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">read_release_inner</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">rwspinlock</span> <span class="token operator">*</span>rwlk<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlk<span class="token operator">-></span>l<span class="token punctuation">)</span><span class="token punctuation">;</span>  rwlk<span class="token operator">-></span>readers<span class="token operator">--</span><span class="token punctuation">;</span>  <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlk<span class="token operator">-></span>l<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">write_acquire_inner</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">rwspinlock</span> <span class="token operator">*</span>rwlk<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlk<span class="token operator">-></span>l<span class="token punctuation">)</span><span class="token punctuation">;</span>  rwlk<span class="token operator">-></span>waiting_writers<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlk<span class="token operator">-></span>l<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlk<span class="token operator">-></span>l<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>rwlk<span class="token operator">-></span>readers <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">||</span> rwlk<span class="token operator">-></span>writer_active<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlk<span class="token operator">-></span>l<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">continue</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    rwlk<span class="token operator">-></span>waiting_writers<span class="token operator">--</span><span class="token punctuation">;</span>    rwlk<span class="token operator">-></span>writer_active <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlk<span class="token operator">-></span>l<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">write_release_inner</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">rwspinlock</span> <span class="token operator">*</span>rwlk<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlk<span class="token operator">-></span>l<span class="token punctuation">)</span><span class="token punctuation">;</span>  rwlk<span class="token operator">-></span>writer_active <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlk<span class="token operator">-></span>l<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œæ˜¯ initrwlock çš„ä»£ç </p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">initrwlock</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">rwspinlock</span> <span class="token operator">*</span>rwlk<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// Replace this with your implementation.</span>  <span class="token function">initlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlk<span class="token operator">-></span>l<span class="token punctuation">,</span> <span class="token string">"rwlk"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  rwlk<span class="token operator">-></span>readers <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  rwlk<span class="token operator">-></span>waiting_writers <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  rwlk<span class="token operator">-></span>writer_active <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æµ‹è¯•æ—¶æˆ‘ä»¬é‡åˆ°äº†ä¸€ä¸ªç¥å¥‡çš„ç°è±¡ï¼Œåœ¨ make qemu åç¬¬ä¸€æ¬¡è¿è¡Œ rwlktest æ€»æ˜¯èƒ½é€šè¿‡çš„ï¼Œè€Œä¹‹åè¿è¡Œæ€»æ˜¯ä¸èƒ½é€šè¿‡çš„ã€‚é‡æ–° make qemu ä»¥åè¿˜æ˜¯ç¬¬ä¸€æ¬¡è¿è¡Œèƒ½é€šè¿‡ï¼Œåç»­è¿è¡Œæ— æ³•é€šè¿‡ã€‚</p><p>ç»è¿‡æ¼«é•¿çš„ debug æ—¶å…‰ï¼Œæˆ‘ä»¬å‘ç°é—®é¢˜å‡ºåœ¨ä¸‹é¢çš„æµ‹è¯•å‡½æ•°ä¸Šï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">rwspinlock_test_step</span><span class="token punctuation">(</span>uint step<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>msg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">static</span> uint barrier<span class="token punctuation">;</span>  <span class="token keyword">const</span> uint ncpu <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>  <span class="token function">__atomic_fetch_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>barrier<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> __ATOMIC_ACQ_REL<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">__atomic_load_n</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>barrier<span class="token punctuation">,</span> __ATOMIC_RELAXED<span class="token punctuation">)</span> <span class="token operator">&lt;</span> ncpu <span class="token operator">*</span> step<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// spin</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">cpuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"rwspinlock_test: step %d: %s\n"</span><span class="token punctuation">,</span> step<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™ä¸ªå‡½æ•°çš„è®¾è®¡åŸæ„åº”è¯¥æ˜¯èµ·è¿™ä¸¤ä¸ªä½œç”¨ï¼š</p><ol><li>åŒæ­¥ CPUï¼Œä¿è¯å››ä¸ª CPU éƒ½åˆ°è¾¾äº†è¿™é‡Œå†ç»§ç»­å¾€ä¸‹è¿è¡Œ</li><li>æ‰“å°å½“å‰è¿è¡Œåˆ°çš„æµ‹è¯•ç¼–å·ï¼ˆstepï¼‰</li></ol><p>è¿™ä¸ªå‡½æ•°é€šè¿‡ä¸‹é¢çš„ä»£ç å®ç° CPU åŒæ­¥ã€‚å®ƒè®© barrier åŸå­æ€§åœ°åŠ ä¸€ï¼Œè¡¨ç¤ºä¸€ä¸ª CPU è·‘åˆ°äº†è¿™é‡Œï¼Œç„¶åå¦‚æœå››ä¸ª CPU ä¸­è¿˜æœ‰äººæ²¡æ¥å°±è‡ªæ—‹ç­‰å¾…ã€‚</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">__atomic_fetch_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>barrier<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> __ATOMIC_ACQ_REL<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">__atomic_load_n</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>barrier<span class="token punctuation">,</span> __ATOMIC_RELAXED<span class="token punctuation">)</span> <span class="token operator">&lt;</span> ncpu <span class="token operator">*</span> step<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// spin</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸ºäº†ä¿è¯ barrier è¢«å››ä¸ª CPU å…±äº«ï¼Œbarrier è¢«è®¾ç½®ä¸ºé™æ€å˜é‡ static uint barrier. ä½†æµ‹è¯•ä»£ç åˆæ²¡åœ¨æµ‹è¯•å¼€å§‹æ—¶æŠŠå®ƒé‡ç½®ä¸º 0ï¼Œæ‰€ä»¥å°±å‡ºç°äº†è¿™ç§ç¬¬ä¸€æ¬¡æµ‹è¯•èƒ½é€šè¿‡ï¼Œä¹‹åçš„æµ‹è¯•ä¸èƒ½é€šè¿‡çš„æƒ…å†µã€‚</p><p>ç¬¬ä¸€æ¬¡æµ‹è¯•æ—¶ï¼Œbarrier æ˜¯åˆå§‹å€¼ 0ï¼Œæ‰€ä»¥ä¸€åˆ‡æ­£å¸¸ï¼›ä¹‹åçš„æµ‹è¯•é‡Œ barrier ä¿ç•™äº†ä¹‹å‰çš„å€¼ï¼Œwhile çš„æ¡ä»¶å§‹ç»ˆä¸ºå‡ï¼Œäºæ˜¯è¿™ç§åŒæ­¥åŠŸèƒ½ä¹Ÿå°±å®Œå…¨å¤±æ•ˆäº†ã€‚åœ¨åŒæ­¥åŠŸèƒ½å¤±æ•ˆåï¼Œè·‘å¾—å¿«çš„ CPU éƒ½è·‘å®Œ 30 ä¸ª steps äº†ï¼Œè·‘å¾—æ…¢çš„ CPU å¯èƒ½è¿˜åœ¨ç¬¬ 8 ä¸ª step æŒ£æ‰ï¼Œè¿™å°±è®© rwlktest ä¹Ÿè·Ÿç€å¤±æ•ˆäº†ã€‚</p><p>æ°”æ°›éƒ½åˆ°è¿™å„¿äº†ï¼Œä¸ç»™ä¸ªä¿®å¤ä¹Ÿä¸å¥½æ„æ€ğŸ« ğŸ« ç”¨ä¸‹é¢çš„ä»£ç å°±è¡Œäº†</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">rwspinlock_test_step</span><span class="token punctuation">(</span>uint step<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>msg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">static</span> uint count<span class="token punctuation">;</span>  <span class="token keyword">static</span> uint sense<span class="token punctuation">;</span>  <span class="token keyword">const</span> uint ncpu <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>  <span class="token keyword">int</span> local_sense <span class="token operator">=</span> <span class="token function">__atomic_load_n</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sense<span class="token punctuation">,</span> __ATOMIC_RELAXED<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__atomic_fetch_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>count<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> __ATOMIC_ACQ_REL<span class="token punctuation">)</span> <span class="token operator">==</span> ncpu <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// Let the last reached CPU reset values and print message</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"rwspinlock_test: step %d: %s\n"</span><span class="token punctuation">,</span> step<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">__atomic_store_n</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>count<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> __ATOMIC_RELAXED<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">__atomic_store_n</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sense<span class="token punctuation">,</span> <span class="token operator">!</span>local_sense<span class="token punctuation">,</span> __ATOMIC_RELEASE<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">__atomic_load_n</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sense<span class="token punctuation">,</span> __ATOMIC_ACQUIRE<span class="token punctuation">)</span> <span class="token operator">==</span> local_sense<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token comment">// spin</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>count å’Œ sense æ˜¯å…±äº«çš„å˜é‡ï¼Œæ‰€ä»¥è¦ç”¨åŸå­è¯­å¥è¯»å†™ã€‚__ATOMIC_RELAXED ä¹‹ç±»çš„ä¸œè¥¿æ˜¯å¯¹å†…å­˜é¡ºåºï¼ˆmemory ordersï¼‰çš„é™åˆ¶ï¼Œè¿™èƒ½é˜²æ­¢æŒ‡ä»¤é‡æ’ï¼Œå…·ä½“å¯ä»¥çœ‹ <a href="https://gcc.gnu.org/onlinedocs/gcc/_005f_005fatomic-Builtins.html">https://gcc.gnu.org/onlinedocs/gcc/_005f_005fatomic-Builtins.html</a>.</p><p>å‘ç°è¿™ä¸ª bug ä»¥åæˆ‘ä¹Ÿç»™ 6S081 çš„å®˜æ–¹å‘äº†é‚®ä»¶ï¼Œæ²¡æƒ³åˆ°è¿˜çœŸæ”¶åˆ°å›å¤äº†ï¼ä»–ä»¬è¯´åŠ å…¥äº†ä¸€ä¸ªç±»ä¼¼çš„ä¿®å¤ï¼Œä¼šåœ¨ 2026 å¹´çš„ç‰ˆæœ¬æ›´æ–°ã€‚æ„Ÿè§‰è‡ªå·±å¯¹ MIT çš„æ»¤é•œæ›´åšäº†ï¼ˆï¼‰</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;è¿™ä¸ª lab è®©æˆ‘ä»¬ç†Ÿæ‚‰å¯¹é”çš„ä½¿ç”¨ã€‚é™¤äº† 2024 çš„é¢˜å¤–æˆ‘è¿˜é¡ºä¾¿åšäº†ä¸‹ 2025 æ–°å¢çš„è¯»å†™é”ï¼ˆ2025 å¹´ç”¨ Read-write lock æ¢æ‰äº† Buffer cacheï¼‰ï¼Œè®©æˆ‘ä»¬ä¾æ¬¡æ¥çœ‹çœ‹è¿™å‡ é“é¢˜ã€‚&lt;/p&gt;
&lt;h1 id=&quot;Memory-allocator&quot;&gt;&lt;a</summary>
      
    
    
    
    <category term="å…¬å¼€è¯¾" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/"/>
    
    <category term="MIT-6.S081" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/MIT-6-S081/"/>
    
    <category term="Labs" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/MIT-6-S081/Labs/"/>
    
    
  </entry>
  
  <entry>
    <title>Lab 6 Networking</title>
    <link href="http://rinevard.github.io/wiki/learning/open-course/MIT-6.S081/Labs/lab6-net/"/>
    <id>http://rinevard.github.io/wiki/learning/open-course/MIT-6.S081/Labs/lab6-net/</id>
    <published>2025-11-08T23:41:29.000Z</published>
    <updated>2025-11-08T23:58:14.625Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™ä¸ª lab åˆ†ä¸¤ä¸ªéƒ¨åˆ†ï¼Œç¬¬ä¸€éƒ¨åˆ†æ˜¯è¡¥å…¨ E1000 ç½‘å¡é©±åŠ¨çš„æ•°æ®åŒ…æ”¶å‘ç›¸å…³ä»£ç ï¼Œç¬¬äºŒéƒ¨åˆ†æ˜¯æ·»åŠ ä»£ç å®Œæˆ UDP åŒ…çš„æ¥æ”¶ã€‚åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬åº”è¯¥å…ˆå»æŠŠè®²ç½‘ç»œçš„ lecture çœ‹æ‰ï¼Œå› ä¸ºé‡Œé¢æ¶‰åŠäº†å¾ˆå¤šç›¸å…³å†…å®¹ã€‚ä½ å¯èƒ½ä¼šç–‘æƒ‘ä¸ºä»€ä¹ˆè¯¾ç¨‹æŠŠ lab å®‰æ’åœ¨ lec å‰é¢ï¼Œæˆ‘åœ¨æœ¬æ–‡çš„æ–‡æœ«åæ§½é‡Œå†™äº†å¯èƒ½çš„åŸå› ã€‚</p><p>è®©æˆ‘ä»¬è¿›å…¥æ­£é¢˜ã€‚</p><h1 id="E1000-ç½‘å¡é©±åŠ¨"><a href="#E1000-ç½‘å¡é©±åŠ¨" class="headerlink" title="E1000 ç½‘å¡é©±åŠ¨"></a>E1000 ç½‘å¡é©±åŠ¨</h1><p>æˆ‘ä»¬åœ¨ç¼–å†™ä»£ç æ—¶è¦å›ç­”ä¸¤ä¸ªé—®é¢˜â€”â€”æˆ‘ä»¬å¦‚ä½•å€ŸåŠ©ç½‘å¡æ¥æ”¶æ•°æ®ï¼Œåˆå¦‚ä½•å‘é€æ•°æ®ï¼Ÿæˆ‘ä»¬å¯¹ç…§æ–‡æ¡£ç¬¬ä¸‰ç« æ¥åˆ†æä¸€ä¸‹ï¼Œç„¶ååœ¨åˆ†æçš„ç»“å°¾åˆ†åˆ«ç»™å‡º e1000_recv å’Œ e1000_transmit çš„ä»£ç ï¼š</p><ol><li><p>æˆ‘ä»¬å¦‚ä½•å€ŸåŠ©ç½‘å¡æ¥æ”¶æ•°æ®ï¼Ÿ</p><p> æˆ‘ä»¬åœ¨åˆå§‹åŒ–é‡Œè®¾ç½®äº† RDTRï¼Œè¿™è®©ç½‘å¡åœ¨æ”¶åˆ°åŒ…æ—¶å‘å‡ºä¸­æ–­ï¼Œè¿™ä¸€éƒ¨åˆ†å’Œæ–‡æ¡£çš„ 3.2.8 Receive Interrupts æœ‰å…³ï¼š</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// ask e1000 for receive interrupts.</span>regs<span class="token punctuation">[</span>E1000_RDTR<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// interrupt after every received packet (no timer)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p> æˆ‘ä»¬è¿˜åœ¨åˆå§‹åŒ–é‡Œè®¾ç½®äº† RDBALï¼Œè¿™è®©ç½‘å¡åœ¨æ”¶åˆ°åŒ…æ—¶æŠŠæ•°æ®æ”¾åˆ° rx_ring ä¸­ï¼š</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// [E1000 14.4] Receive initialization</span><span class="token function">memset</span><span class="token punctuation">(</span>rx_ring<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>rx_ring<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> RX_RING_SIZE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    rx_bufs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">kalloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rx_bufs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"e1000"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    rx_ring<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>addr <span class="token operator">=</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>rx_bufs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>regs<span class="token punctuation">[</span>E1000_RDBAL<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>rx_ring<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p> å…·ä½“æ¥è¯´ï¼Œå®ƒä¼šæŠŠåŒ…æ”¾åˆ° rx_ring[RDH] é‡Œï¼Œæˆ‘ä»¬åˆ™ç”¨ RDT æ¥è¯»å–ã€‚</p><p> ä¸‹å›¾æ˜¯ rx_ring çš„ç¤ºæ„å›¾ï¼Œç¡¬ä»¶å¯å‘ [HEAD, TAIL) ä¸­å†™å…¥å†…å®¹ï¼Œ TAIL å¤„ç•™ç©ºä»¥åŒºåˆ†ç©ºç¯å’Œæ»¡ç¯ã€‚</p><p> <img src="/images/learning/open-course/MIT-6.S081/labs/lab6-net/rxring.png" alt=""></p><p> ç½‘å¡ä¼ æ¥çš„æ•°æ®æ ¼å¼åœ¨ e1000_dev.h é‡Œå®šä¹‰ï¼Œå¯å‚è€ƒæ–‡æ¡£ 3.2.3 Receive Descriptor Formatï¼š</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">rx_desc</span> <span class="token punctuation">&#123;</span>    uint64 addr<span class="token punctuation">;</span>   <span class="token comment">/* Address of the descriptor's data buffer */</span>    uint16 length<span class="token punctuation">;</span> <span class="token comment">/* Length of data DMAed into data buffer */</span>    uint16 csum<span class="token punctuation">;</span>   <span class="token comment">/* Packet checksum */</span>    uint8 status<span class="token punctuation">;</span>  <span class="token comment">/* Descriptor status */</span>    uint8 errors<span class="token punctuation">;</span>  <span class="token comment">/* Descriptor Errors */</span>    uint16 special<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p> ç½‘å¡å‘å‡ºä¸­æ–­åï¼Œå†…æ ¸ä¼šè°ƒç”¨ e1000_intrï¼Œe1000_intr åˆä¼šè¿›ä¸€æ­¥è°ƒç”¨ e1000_recv. </p><p> å¯¹ç…§ rx_ring çš„ç¤ºæ„å›¾ï¼Œæˆ‘ä»¬å°±çŸ¥é“ e1000_recv åº”è¯¥å» rx_ring[RDT + 1] å¤„è¯»å–æ•°æ®ï¼Œç›´åˆ°è¯»åˆ°æ— æ•ˆæ•°æ®ä¸ºæ­¢ã€‚å‚è€ƒæ–‡æ¡£çš„ 3.2.3.1 Receive Descriptor Status Fieldï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ® rx_desc çš„ status çš„ DD ä½å¾—çŸ¥æ•°æ®æ˜¯å¦æœ‰æ•ˆã€‚</p><p> æ€»ä¹‹ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">e1000_recv</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//</span>    <span class="token comment">// Your code here.</span>    <span class="token comment">//</span>    <span class="token comment">// Check for packets that have arrived from the e1000</span>    <span class="token comment">// Create and deliver a buf for each packet (using net_rx()).</span>    <span class="token comment">//</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>e1000_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    uint32 idx <span class="token operator">=</span> <span class="token punctuation">(</span>regs<span class="token punctuation">[</span>E1000_RDT<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> RX_RING_SIZE<span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>rx_ring<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>status <span class="token operator">&amp;</span> E1000_RXD_STAT_DD<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">char</span> <span class="token operator">*</span>recv_buf <span class="token operator">=</span> rx_bufs<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> buflen <span class="token operator">=</span> rx_ring<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>        rx_bufs<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">kalloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rx_bufs<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"e1000"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        rx_ring<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>addr <span class="token operator">=</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>rx_bufs<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span>        rx_ring<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        idx <span class="token operator">=</span> <span class="token punctuation">(</span>idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> RX_RING_SIZE<span class="token punctuation">;</span>        <span class="token comment">// net_rx could call e1000_transmit, so release lock before calling it</span>        <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>e1000_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">net_rx</span><span class="token punctuation">(</span>recv_buf<span class="token punctuation">,</span> buflen<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>e1000_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// set RDT to the last processed index</span>    regs<span class="token punctuation">[</span>E1000_RDT<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>idx <span class="token operator">+</span> RX_RING_SIZE <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> RX_RING_SIZE<span class="token punctuation">;</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>e1000_lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p> è¿™é‡Œçš„ <code>regs[E1000_RDT] = (idx + RX_RING_SIZE - 1) % RX_RING_SIZE</code> å¯èƒ½æ¯”è¾ƒ trickyï¼Œæ€»ä¹‹å°±æ˜¯ RDT åº”è¯¥æŒ‡åœ¨æœ€åä¸€ä¸ªè¢«å–å‡ºçš„æè¿°ç¬¦å¤„ä»¥å®ç°ç•™ç©ºã€‚</p></li><li><p>æˆ‘ä»¬å¦‚ä½•å€ŸåŠ©ç½‘å¡å‘é€æ•°æ®ï¼Ÿ</p><p> å¦‚æ–‡æ¡£ 3.4.3 Transmit Interrupts æ‰€å†™ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è®¾ç½®ç½‘å¡åœ¨ä¼ è¾“å®Œæˆæ—¶å‘ç”Ÿä¸­æ–­ï¼Œä¸è¿‡åœ¨ xv6 é‡Œæˆ‘ä»¬æ²¡æœ‰è¿™ä¹ˆè®¾ç½®ï¼Œæ‰€ä»¥å‘é€æˆåŠŸä¸ä¼šä¸­æ–­ã€‚</p><p> ä¸è¯»å–æ•°æ®è¦æŠŠ rx_ring çš„ä½ç½®å‘Šè¯‰ç½‘å¡ç±»ä¼¼ï¼Œæˆ‘ä»¬è¦æŠŠ tx_ring çš„ä½ç½®åœ¨åˆå§‹åŒ–é‡Œå‘Šè¯‰ç½‘å¡ï¼š</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// [E1000 14.5] Transmit initialization</span><span class="token function">memset</span><span class="token punctuation">(</span>tx_ring<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tx_ring<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> TX_RING_SIZE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    tx_ring<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>status <span class="token operator">=</span> E1000_TXD_STAT_DD<span class="token punctuation">;</span>    tx_bufs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>regs<span class="token punctuation">[</span>E1000_TDBAL<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>tx_ring<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p> æˆ‘ä»¬ä¼šæŠŠæ•°æ®æ”¾åˆ° tx_ring[TDT] é‡Œï¼Œç½‘å¡ä¼šè‡ªåŠ¨èµ°åŠ¨ TDH ç›´åˆ°è¿½ä¸Š TDT.</p><p> ä¸‹å›¾æ˜¯ rx_ring çš„ç¤ºæ„å›¾ï¼ŒTAIL æŒ‡å‘ç¡¬ä»¶èƒ½å¤Ÿå¤„ç†çš„æœ€åä¸€ä¸ªæè¿°ç¬¦ä¹‹åçš„ä½ç½®ï¼Œè¿™ä¹Ÿæ˜¯è½¯ä»¶å†™å…¥ç¬¬ä¸€ä¸ªæ–°æè¿°ç¬¦çš„ä½ç½®ã€‚ä¸ rx_ring ä¸åŒï¼Œtx_ring æ— ç•™ç©ºã€‚</p><p> <img src="/images/learning/open-course/MIT-6.S081/labs/lab6-net/txring.png" alt=""></p><p> ä¼ ç»™ç½‘å¡çš„æ•°æ®ç»“æ„ä¹Ÿåœ¨ e1000_dev.h é‡Œå®šä¹‰ï¼Œå¯å‚è€ƒæ–‡æ¡£ 3.3.2 Transmit Descriptorsï¼š</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">tx_desc</span> <span class="token punctuation">&#123;</span>    uint64 addr<span class="token punctuation">;</span>    uint16 length<span class="token punctuation">;</span>    uint8 cso<span class="token punctuation">;</span>    uint8 cmd<span class="token punctuation">;</span>    uint8 status<span class="token punctuation">;</span>    uint8 css<span class="token punctuation">;</span>    uint16 special<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p> å¯¹ç…§ tx_ring çš„ç¤ºæ„å›¾ï¼Œæˆ‘ä»¬è¦æŠŠæ•°æ®å­˜åœ¨ tx_ring[TDT] é‡Œã€‚è¦æ³¨æ„å¦‚æœ TDT æŒ‡å‘çš„å†…å®¹å·²ç»è¢«ç½‘å¡æˆåŠŸå‘é€äº†ï¼ˆå¯ä»¥é€šè¿‡ status çš„ DD ä½æ¥åˆ¤æ–­ï¼‰ï¼Œæˆ‘ä»¬è¦é‡Šæ”¾ TDT æŒ‡å‘çš„å†…å­˜ä»¥é¿å…å†…å­˜æ³„æ¼ï¼›å¦å¤–æˆ‘ä»¬è¿˜è¦æ›´æ–° cmd ä½ï¼Œå…·ä½“å¯ä»¥å‚è€ƒ 3.3.3.1 Transmit Descriptor Command Field Format. æ€»ä¹‹ä¸‹é¢æ˜¯ä»£ç ï¼š</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">e1000_transmit</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//</span>    <span class="token comment">// Your code here.</span>    <span class="token comment">//</span>    <span class="token comment">// buf contains an ethernet frame; program it into</span>    <span class="token comment">// the TX descriptor ring so that the e1000 sends it. Stash</span>    <span class="token comment">// a pointer so that it can be freed after send completes.</span>    <span class="token comment">//</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>e1000_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    uint32 idx <span class="token operator">=</span> regs<span class="token punctuation">[</span>E1000_TDT<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>tx_ring<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>status <span class="token operator">&amp;</span> E1000_TXD_STAT_DD<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>e1000_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// free old buf that has been sent away</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>tx_ring<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>addr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">kfree</span><span class="token punctuation">(</span>tx_bufs<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    tx_bufs<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> buf<span class="token punctuation">;</span>    tx_ring<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>addr <span class="token operator">=</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>tx_bufs<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span>    tx_ring<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">=</span> len<span class="token punctuation">;</span>    tx_ring<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>cmd <span class="token operator">=</span> E1000_TXD_CMD_EOP <span class="token operator">|</span> E1000_TXD_CMD_RS<span class="token punctuation">;</span>    tx_ring<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    regs<span class="token punctuation">[</span>E1000_TDT<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> TX_RING_SIZE<span class="token punctuation">;</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>e1000_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><h1 id="UDP-åŒ…çš„æ¥æ”¶"><a href="#UDP-åŒ…çš„æ¥æ”¶" class="headerlink" title="UDP åŒ…çš„æ¥æ”¶"></a>UDP åŒ…çš„æ¥æ”¶</h1><p>æˆ‘ä»¬å…ˆæ¥æ¢³ç†ä¸€ä¸‹æ•´ä¸ªæ”¶ä¿¡æµç¨‹æ˜¯æ€æ ·çš„ï¼šå¤–éƒ¨ä¼šå‘ packet ç»™ç½‘å¡ï¼Œç½‘å¡åœ¨æ”¶åˆ°åä¼šå¼•å‘ä¸­æ–­ï¼Œå†…æ ¸å‘ç°ä¸­æ–­ç”±ç½‘å¡å¼•å‘å°±ä¼šè°ƒç”¨ <code>e1000_intr</code>ï¼Œä¹‹å packet ä¼šè¢«å‘ç»™ <code>net_rx</code> æ¥è®©å†…æ ¸åšè¿›ä¸€æ­¥å¤„ç†ã€‚å¦‚æœ <code>net_rx</code> å‘ç°è¿™æ˜¯ä¸€ä¸ª IP packet å°±ä¼šè¿›ä¸€æ­¥è°ƒç”¨ <code>ip_rx</code>ï¼Œç„¶åå°±åˆ°æˆ‘ä»¬çš„å·¥ä½œäº†ã€‚</p><p>æˆ‘ä»¬åªéœ€è¦å¤„ç† ETH-IP-UDP åµŒå¥—çš„ packetï¼Œè®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹å®ƒçš„ç»“æ„ï¼š</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab6-net/packet.png" alt=""></p><p>å…·ä½“çš„ packet header çš„å®šä¹‰åœ¨ net.h é‡Œã€‚</p><p>æ€»ä¹‹æˆ‘ä»¬è¦å®ç° recvã€bindã€ip_rx è¿™ä¸‰ä¸ªå‡½æ•°ã€‚åº”ç”¨ä¼šè°ƒç”¨ bind æ¥ç›‘å¬ä¸€ä¸ªç«¯å£ï¼Œå½“ç«¯å£è¢«ç›‘å¬æ—¶æˆ‘ä»¬éœ€è¦ä¿å­˜åˆ°è¾¾è¿™ä¸ªç«¯å£çš„æ•°æ®åŒ…ï¼Œæ‰€ä»¥è¦åœ¨ <code>net.h</code> ä¸­å®šä¹‰å¦‚ä¸‹çš„æ•°æ®ç»“æ„ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_LISTEN_PORTS</span> <span class="token expression"><span class="token number">128</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PACKET_RING_SIZE</span> <span class="token expression"><span class="token number">16</span> </span><span class="token comment">// for any given port, no more than 16 packets should be saved</span></span><span class="token keyword">struct</span> <span class="token class-name">listener</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> used<span class="token punctuation">;</span>    <span class="token keyword">int</span> port<span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>packet_ring<span class="token punctuation">[</span>PACKET_RING_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> head<span class="token punctuation">;</span> <span class="token comment">// used by writer</span>    <span class="token keyword">int</span> tail<span class="token punctuation">;</span> <span class="token comment">// used by reader</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œçš„ used å­—æ®µå¯èƒ½æœ‰ç‚¹å¥‡æ€ªï¼Œæˆ‘æ¥è§£é‡Šä¸€ä¸‹ï¼šæˆ‘ä»¬å¸Œæœ›æ¯å½“ä¸€ä¸ªåº”ç”¨è°ƒç”¨ bindï¼Œæˆ‘ä»¬å°±æ–°å¢ä¸€ä¸ª listenerï¼Œä½†ç”±äº C è¯­è¨€å®ç°åŠ¨æ€æ•°ç»„å¾ˆéº»çƒ¦ï¼Œæ‰€ä»¥æˆ‘ä»¬é€‰æ‹©åˆ›å»ºé™æ€å¤§å°çš„ listeners æ•°ç»„ã€‚é‚£ä¸ºä»€ä¹ˆä¸ç”¨é“¾è¡¨å‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬æ–°å¢å†…å­˜çš„æ‰‹æ®µåªæœ‰ kallocï¼Œè€Œä¸€æ•´ä¸ªé¡µå¯¹ä¸€ä¸ª listener æ¥è¯´å¤ªå¤§äº†ã€‚</p><p>struct listener é‡Œçš„ used å­—æ®µå°±æ˜¯ä¸ºäº†åˆ¤æ–­ listeners æ•°ç»„é‡Œçš„æŸä¸ª listener æ˜¯å¦å·²ç»è¢«ä½¿ç”¨ã€‚</p><p>æˆ‘ä»¬è¦åœ¨ net.c é‡Œåˆå§‹åŒ– listeners æ•°ç»„ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">listener</span> listeners<span class="token punctuation">[</span>MAX_LISTEN_PORTS<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">netinit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">initlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netlock<span class="token punctuation">,</span> <span class="token string">"netlock"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX_LISTEN_PORTS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        listeners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>used <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> PACKET_RING_SIZE<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            listeners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>packet_ring<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ¥ä¸‹æ¥æˆ‘ä»¬åˆ†æä¸€ä¸‹æ¯ä¸ªå‡½æ•°è¦åšä»€ä¹ˆï¼Œå†ç»™å‡ºä»£ç ï¼š</p><ol><li><p>recv(int dport, int *src, short *sport, char *buf, int maxlen)</p><p> æ¥æ”¶åˆ°è¾¾ dport ç«¯å£çš„ UDP packet. å¦‚æœåˆ°è¾¾äº†å¤šä¸ªï¼Œå–å‡ºç¬¬ä¸€ä¸ª packetï¼›å¦‚æœæ²¡æœ‰ä¸œè¥¿åˆ°è¾¾ï¼Œç­‰å¾…ç›´åˆ°æœ‰ä¸œè¥¿åˆ°è¾¾ã€‚</p><p> æœ¬å‡½æ•°æŠŠå–å‡ºçš„ packet é‡Œ 32 ä½çš„æº IP åœ°å€å¤åˆ¶åˆ° *srcï¼ŒUDP æºç«¯å£å·å¤åˆ¶åˆ° *sportï¼Œpayload çš„è‡³å¤š maxlen ä¸ªå­—èŠ‚å¤åˆ¶åˆ° buf. æˆåŠŸåˆ™è¿”å›å¤åˆ¶çš„ payload å­—èŠ‚æ•°ï¼Œå¤±è´¥è¿”å› -1.</p><p> æ³¨æ„ç½‘ç»œå­—èŠ‚åºå’Œç³»ç»Ÿå­—èŠ‚åºä¸åŒï¼Œè¦ç”¨ <code>ntohs</code> å’Œ <code>ntohl</code> æ¥é€†è½¬å­—èŠ‚åºã€‚</p><p> å¦å¤–ï¼Œè¿™é‡Œçš„å„ä¸ªæŒ‡é’ˆæ˜¯ç”¨æˆ·ç©ºé—´çš„è™šæ‹Ÿåœ°å€ï¼Œæˆ‘ä»¬è¦ç”¨ copyout æŠŠ packet é‡Œçš„å†…å®¹ï¼ˆå®ƒä»¬åœ¨å†…æ ¸ç©ºé—´ï¼‰å¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´ã€‚</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c">uint64 <span class="token function">sys_recv</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//</span>    <span class="token comment">// Your code here.</span>    <span class="token comment">//</span>    <span class="token keyword">struct</span> <span class="token class-name">proc</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>    <span class="token keyword">int</span> dport<span class="token punctuation">;</span>    uint64 src<span class="token punctuation">;</span>    uint64 sport<span class="token punctuation">;</span>    uint64 buf<span class="token punctuation">;</span>    <span class="token keyword">int</span> maxlen<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">listener</span> <span class="token operator">*</span>listener <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    p <span class="token operator">=</span> <span class="token function">myproc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">argint</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>dport<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">argaddr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">argaddr</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>sport<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">argaddr</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">argint</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>maxlen<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// find listener related to dport</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netlock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX_LISTEN_PORTS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        listener <span class="token operator">=</span> <span class="token operator">&amp;</span>listeners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>listener<span class="token operator">-></span>used <span class="token operator">&amp;&amp;</span> listener<span class="token operator">-></span>port <span class="token operator">==</span> dport<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        listener <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>listener<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">goto</span> bad<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// return the earliest waiting packet or wait until a packet arrives</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>listener<span class="token operator">-></span>packet_ring<span class="token punctuation">[</span>listener<span class="token operator">-></span>tail<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// extract a packet from the ring</span>            <span class="token keyword">char</span> <span class="token operator">*</span>packet <span class="token operator">=</span> listener<span class="token operator">-></span>packet_ring<span class="token punctuation">[</span>listener<span class="token operator">-></span>tail<span class="token punctuation">]</span><span class="token punctuation">;</span>            listener<span class="token operator">-></span>packet_ring<span class="token punctuation">[</span>listener<span class="token operator">-></span>tail<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            listener<span class="token operator">-></span>tail <span class="token operator">=</span> <span class="token punctuation">(</span>listener<span class="token operator">-></span>tail <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> PACKET_RING_SIZE<span class="token punctuation">;</span>            <span class="token comment">// extract data from the packet</span>            <span class="token keyword">struct</span> <span class="token class-name">ip</span> <span class="token operator">*</span>ip_packet <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ip</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>packet <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">eth</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">struct</span> <span class="token class-name">udp</span> <span class="token operator">*</span>udp_packet <span class="token operator">=</span>                <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">udp</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>packet <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">eth</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ip</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">void</span> <span class="token operator">*</span>payload <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>udp_packet<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">udp</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// re-arrange the bytes</span>            uint32 src_ip <span class="token operator">=</span> <span class="token function">ntohl</span><span class="token punctuation">(</span>ip_packet<span class="token operator">-></span>ip_src<span class="token punctuation">)</span><span class="token punctuation">;</span>            uint16 src_port <span class="token operator">=</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>udp_packet<span class="token operator">-></span>sport<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copyout</span><span class="token punctuation">(</span>p<span class="token operator">-></span>pagetable<span class="token punctuation">,</span> src<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>src_ip<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>src_ip<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span>                <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">kfree</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">goto</span> bad<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copyout</span><span class="token punctuation">(</span>p<span class="token operator">-></span>pagetable<span class="token punctuation">,</span> sport<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>src_port<span class="token punctuation">,</span>                        <span class="token keyword">sizeof</span><span class="token punctuation">(</span>src_port<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">kfree</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">goto</span> bad<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">// copy at most maxlen bytes of the payload and free the packet</span>            uint16 buflen <span class="token operator">=</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>udp_packet<span class="token operator">-></span>ulen<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">udp</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            uint64 cplen <span class="token operator">=</span> <span class="token punctuation">(</span>buflen <span class="token operator">></span> maxlen<span class="token punctuation">)</span> <span class="token operator">?</span> maxlen <span class="token operator">:</span> buflen<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copyout</span><span class="token punctuation">(</span>p<span class="token operator">-></span>pagetable<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> cplen<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">kfree</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">goto</span> bad<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token function">kfree</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netlock<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> cplen<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// wait until a packet arrives</span>            <span class="token function">sleep</span><span class="token punctuation">(</span>listener<span class="token operator">-></span>packet_ring<span class="token punctuation">,</span> <span class="token operator">&amp;</span>netlock<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">goto</span> bad<span class="token punctuation">;</span>bad<span class="token operator">:</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netlock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>bind(int port)</p><p> è¿›ç¨‹åœ¨è°ƒç”¨ recv å‰åº”å½“å…ˆè°ƒç”¨ bind æ¥ç›‘å¬ç‰¹å®šç«¯å£ï¼Œbind è¢«è°ƒç”¨æ—¶åº”è¯¥è¦åˆå§‹åŒ– port å¯¹åº”çš„å¾…å¤„ç†åŒºã€‚</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c">uint64 <span class="token function">sys_bind</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//</span>    <span class="token comment">// Your code here.</span>    <span class="token comment">//</span>    <span class="token keyword">int</span> port<span class="token punctuation">;</span>    <span class="token function">argint</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netlock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// return error if repeated binding</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX_LISTEN_PORTS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>listeners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>used <span class="token operator">&amp;&amp;</span> listeners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>port <span class="token operator">==</span> port<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">goto</span> bad<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX_LISTEN_PORTS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>listeners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>used<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// use the first unused listener for port</span>            listeners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>used <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>            listeners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>port <span class="token operator">=</span> port<span class="token punctuation">;</span>            listeners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>head <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            listeners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>tail <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netlock<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">goto</span> bad<span class="token punctuation">;</span>bad<span class="token operator">:</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netlock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>ip_rx(char *buf, int len)</p><p> e1000_recv ä¼šæŠŠ packet è½¬å‘ç»™ net_rxï¼Œnet_rx åœ¨å‘ç°æ”¶åˆ°çš„ packet æ˜¯ IP packet æ—¶ä¼šæŠŠ packet è½¬å‘ç»™ ip_rx.</p><p> æˆ‘ä»¬éœ€è¦æ£€æŸ¥ destination port æ˜¯å¦åœ¨æ­£åœ¨è¢«ç›‘å¬ï¼Œå¦‚æœæœªç›‘å¬æˆ–å¾…å¤„ç†åŒºå·²æ»¡å°±ä¸¢å¼ƒåŒ…ï¼Œå¦åˆ™å­˜åˆ°å¾…å¤„ç†åŒºã€‚</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">ip_rx</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// don't delete this printf; make grade depends on it.</span>    <span class="token keyword">static</span> <span class="token keyword">int</span> seen_ip <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>seen_ip <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ip_rx: received an IP packet\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    seen_ip <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token comment">//</span>    <span class="token comment">// Your code here.</span>    <span class="token comment">//</span>    <span class="token keyword">struct</span> <span class="token class-name">udp</span> <span class="token operator">*</span>udp_packet<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">listener</span> <span class="token operator">*</span>listener <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    udp_packet <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">udp</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>buf <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">eth</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ip</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netlock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX_LISTEN_PORTS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        listener <span class="token operator">=</span> <span class="token operator">&amp;</span>listeners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token comment">// try best to save packet in listener related to dport</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>listener<span class="token operator">-></span>used <span class="token operator">&amp;&amp;</span> listener<span class="token operator">-></span>port <span class="token operator">==</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>udp_packet<span class="token operator">-></span>dport<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">int</span> head <span class="token operator">=</span> listener<span class="token operator">-></span>head<span class="token punctuation">;</span>            <span class="token comment">// if ring is full, drop the incoming packet</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>listener<span class="token operator">-></span>packet_ring<span class="token punctuation">[</span>head<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">kfree</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netlock<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">// save packet in listener</span>            listener<span class="token operator">-></span>packet_ring<span class="token punctuation">[</span>head<span class="token punctuation">]</span> <span class="token operator">=</span> buf<span class="token punctuation">;</span>            listener<span class="token operator">-></span>head <span class="token operator">=</span> <span class="token punctuation">(</span>head <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> PACKET_RING_SIZE<span class="token punctuation">;</span>            <span class="token function">wakeup</span><span class="token punctuation">(</span>listener<span class="token operator">-></span>packet_ring<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netlock<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">kfree</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netlock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><p>ç„¶åæˆ‘ä»¬å°±ä¸‹ç­äº†ï¼</p><h1 id="æ‚ä¸ƒæ‚å…«å°çŸ¥è¯†"><a href="#æ‚ä¸ƒæ‚å…«å°çŸ¥è¯†" class="headerlink" title="æ‚ä¸ƒæ‚å…«å°çŸ¥è¯†"></a>æ‚ä¸ƒæ‚å…«å°çŸ¥è¯†</h1><h2 id="æ‰€æœ‰æƒè½¬ç§»"><a href="#æ‰€æœ‰æƒè½¬ç§»" class="headerlink" title="æ‰€æœ‰æƒè½¬ç§»"></a>æ‰€æœ‰æƒè½¬ç§»</h2><p>çœ‹ä¸€çœ¼ e1000_recv çš„ä»£ç ï¼Œæˆ‘ä»¬ä¼šå‘ç°å®ƒè°ƒç”¨äº† kallocï¼Œå´æ²¡æœ‰åœ¨å†…éƒ¨æ˜¾å¼é‡Šæ”¾æ–°å»ºçš„å†…å­˜ï¼Œè¿™æ˜¯å†…å­˜æ³„æ¼å—ï¼Ÿ</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">e1000_recv</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//</span>    <span class="token comment">// Your code here.</span>    <span class="token comment">//</span>    <span class="token comment">// Check for packets that have arrived from the e1000</span>    <span class="token comment">// Create and deliver a buf for each packet (using net_rx()).</span>    <span class="token comment">//</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>e1000_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    uint32 idx <span class="token operator">=</span> <span class="token punctuation">(</span>regs<span class="token punctuation">[</span>E1000_RDT<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> RX_RING_SIZE<span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>rx_ring<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>status <span class="token operator">&amp;</span> E1000_RXD_STAT_DD<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">char</span> <span class="token operator">*</span>recv_buf <span class="token operator">=</span> rx_bufs<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// åœ¨è¿™é‡Œå–å‡º</span>        <span class="token keyword">int</span> buflen <span class="token operator">=</span> rx_ring<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>        rx_bufs<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">kalloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// åœ¨è¿™é‡Œåˆ†é…æ–°å†…å­˜</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rx_bufs<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"e1000"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        rx_ring<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>addr <span class="token operator">=</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>rx_bufs<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span>        rx_ring<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        idx <span class="token operator">=</span> <span class="token punctuation">(</span>idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> RX_RING_SIZE<span class="token punctuation">;</span>        <span class="token comment">// net_rx could call e1000_transmit, so release lock before calling it</span>        <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>e1000_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">net_rx</span><span class="token punctuation">(</span>recv_buf<span class="token punctuation">,</span> buflen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// åœ¨è¿™é‡Œè½¬ç§»æ‰€æœ‰æƒ</span>        <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>e1000_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// set RDT to the last processed index</span>    regs<span class="token punctuation">[</span>E1000_RDT<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>idx <span class="token operator">+</span> RX_RING_SIZE <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> RX_RING_SIZE<span class="token punctuation">;</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>e1000_lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™å¹¶ä¸æ˜¯å†…å­˜æ³„æ¼ï¼Œè€Œæ˜¯ä¸€ç§æ‰€æœ‰æƒè½¬ç§»ã€‚å¯¹æ¯ä¸ªæ–°å»ºçš„ <code>rx_bufs[idx] = kalloc()</code>ï¼Œæˆ‘ä»¬éƒ½ä¼šåœ¨æœªæ¥é€šè¿‡ <code>recv_buf = rx_bufs[idx]</code> æŠŠå®ƒå–å‡ºï¼Œå¹¶æŠŠå…¶æ‰€æœ‰æƒé€šè¿‡ <code>net_rx(recv_buf, buflen)</code> è½¬ç§»ç»™ <code>net_rx</code>. ä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>net_rx</code> è´Ÿè´£é‡Šæ”¾ä¼ å…¥çš„ buf.</p><p>è€Œ <code>net_rx</code> ä¹Ÿå¯èƒ½æŠŠ buf çš„æ‰€æœ‰æƒè½¬ç§»ç»™ <code>app_rx</code> æˆ– <code>ip_rx</code>.</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">net_rx</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">eth</span> <span class="token operator">*</span>eth <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">eth</span> <span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">>=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">eth</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">arp</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>        <span class="token function">ntohs</span><span class="token punctuation">(</span>eth<span class="token operator">-></span>type<span class="token punctuation">)</span> <span class="token operator">==</span> ETHTYPE_ARP<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">arp_rx</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">>=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">eth</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ip</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>               <span class="token function">ntohs</span><span class="token punctuation">(</span>eth<span class="token operator">-></span>type<span class="token punctuation">)</span> <span class="token operator">==</span> ETHTYPE_IP<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">ip_rx</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token function">kfree</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™å’Œ C++ é‡Œçš„ move è¯­ä¹‰ç±»ä¼¼ï¼Œéƒ½æ˜¯â€œè½¬ç§»æ‰€æœ‰æƒâ€ã€‚</p><h2 id="ä»€ä¹ˆæ˜¯-attribute-packed"><a href="#ä»€ä¹ˆæ˜¯-attribute-packed" class="headerlink" title="ä»€ä¹ˆæ˜¯ attribute((packed))"></a>ä»€ä¹ˆæ˜¯ <strong>attribute((packed))</strong></h2><p>net.h é‡Œæœ‰ packet header çš„å®šä¹‰ï¼Œè¿™é‡Œ struct eth é‡Œçš„ <code>__attribute((packed))__</code> æ˜¯åœ¨å‘ŠçŸ¥ç¼–è¯‘å™¨å–æ¶ˆå†…å­˜å¯¹é½ä¼˜åŒ–ï¼Œè®©ç»“æ„ä½“æˆå‘˜ç´§å‡‘æ’åˆ—ã€‚</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">eth</span> <span class="token punctuation">&#123;</span>    uint8 dhost<span class="token punctuation">[</span>ETHADDR_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>    uint8 shost<span class="token punctuation">[</span>ETHADDR_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>    uint16 type<span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>packed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿˜è®°å¾—å¯¹é½ä¼˜åŒ–æ˜¯ä»€ä¹ˆå—ï¼Ÿä¸ºäº†æé«˜ CPU è®¿é—®å†…å­˜çš„æ•ˆç‡ï¼Œç»“æ„ä½“ä¸­çš„æ¯ä¸ªæˆå‘˜çš„èµ·å§‹åœ°å€ç›¸å¯¹äºç»“æ„ä½“èµ·å§‹åœ°å€çš„åç§»é‡éœ€è¦æ˜¯è¯¥æˆå‘˜è‡ªèº«å¤§å°çš„æ•´æ•°å€ã€‚å¦‚æœä¸æ˜¯ï¼Œç¼–è¯‘å™¨ä¼šåœ¨å‰ä¸€ä¸ªæˆå‘˜åé¢å¡«å……ä¸€äº›ç©ºç™½å­—èŠ‚ã€‚</p><p>æ¯”å¦‚å¯¹ä¸‹é¢çš„ç»“æ„ä½“ï¼Œsizeof(struct Test) æ˜¯ 12 å­—èŠ‚ï¼Œè€Œä¸æ˜¯æˆå‘˜å¤§å°ä¹‹å’Œçš„ 1 + 4 + 1 = 6 å­—èŠ‚ã€‚</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">Test</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">char</span> c1<span class="token punctuation">;</span>    <span class="token keyword">int</span> i<span class="token punctuation">;</span>    <span class="token keyword">char</span> c2<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="æ–‡æœ«åæ§½"><a href="#æ–‡æœ«åæ§½" class="headerlink" title="æ–‡æœ«åæ§½"></a>æ–‡æœ«åæ§½</h1><p>Lab Net ç»å†äº†ä¸å°‘å˜è¿ï¼Œåœ¨ 2019 å’Œ 2020 å¹´å®ƒè¿˜æ˜¯è¯¾ç¨‹çš„æœ€åä¸€ä¸ª labï¼Œè€Œä» 2021 å¹´å¼€å§‹å®ƒå°±è¢«ç§»åˆ°äº†è¯¾ç¨‹ä¸­æœŸï¼Œè€Œç½‘ç»œ lec åˆ™ä¸€ç›´åœ¨è¯¾ç¨‹åæœŸï¼Œæ‰€ä»¥å°±é€ æˆäº† lab å’Œ lec çš„é”™ä½ã€‚</p><p><a href="https://pdos.csail.mit.edu/6.828/2023/labs/net.html">2023 å¹´ç‰ˆæœ¬çš„ Net Lab</a> åªè¦æ±‚å®ç° Part One è€Œä¸”æ ‡æ³¨çš„éš¾åº¦è¿˜æ˜¯ hardï¼Œ2024 å¹´å°±å˜æˆäº† moderate è¿˜æ–°åŠ äº†ä¸€ä¸ª Part Twoï¼Œæœç„¶è¯¾ç¨‹éš¾åº¦ä¹Ÿæ˜¯ä¼šé€šè´§è†¨èƒ€çš„ğŸ« ğŸ« </p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;è¿™ä¸ª lab åˆ†ä¸¤ä¸ªéƒ¨åˆ†ï¼Œç¬¬ä¸€éƒ¨åˆ†æ˜¯è¡¥å…¨ E1000 ç½‘å¡é©±åŠ¨çš„æ•°æ®åŒ…æ”¶å‘ç›¸å…³ä»£ç ï¼Œç¬¬äºŒéƒ¨åˆ†æ˜¯æ·»åŠ ä»£ç å®Œæˆ UDP åŒ…çš„æ¥æ”¶ã€‚åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬åº”è¯¥å…ˆå»æŠŠè®²ç½‘ç»œçš„ lecture çœ‹æ‰ï¼Œå› ä¸ºé‡Œé¢æ¶‰åŠäº†å¾ˆå¤šç›¸å…³å†…å®¹ã€‚ä½ å¯èƒ½ä¼šç–‘æƒ‘ä¸ºä»€ä¹ˆè¯¾ç¨‹æŠŠ lab å®‰æ’åœ¨ lec å‰é¢ï¼Œæˆ‘åœ¨æœ¬</summary>
      
    
    
    
    <category term="å…¬å¼€è¯¾" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/"/>
    
    <category term="MIT-6.S081" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/MIT-6-S081/"/>
    
    <category term="Labs" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/MIT-6-S081/Labs/"/>
    
    
  </entry>
  
  <entry>
    <title>é€è¿‡æœ›è¿œé•œç»™æœˆäº®æ‹ç…§</title>
    <link href="http://rinevard.github.io/wiki/others/thoughts/moon/"/>
    <id>http://rinevard.github.io/wiki/others/thoughts/moon/</id>
    <published>2025-11-05T14:10:15.000Z</published>
    <updated>2025-11-05T15:01:12.376Z</updated>
    
    <content type="html"><![CDATA[<p>ä»Šå¤©æ‹¿å‡ºäº†æˆ‘è€—è´¹ 200 å…ƒå·¨èµ„ä¹°çš„æ£®æ—äººæœ›è¿œé•œè¯•ç€çœ‹æœˆäº®ï¼</p><p><img src="/images/others/random_thoughts/moon/telescope.jpg" alt="7x50"></p><p>åœ¨æ‹¿èµ·æœ›è¿œé•œçœ‹å‘æœˆäº®ä¹‹å‰çœŸçš„å¾ˆéš¾æƒ³è±¡ï¼Œä¸€ä¸ªä¸¤ç™¾å…ƒçš„æœ›è¿œé•œå°±èƒ½è®©æˆ‘çœ‹æ¸…æœˆæµ·ã€æœˆé™†ã€ç¬¬è°·ç¯å½¢å±±ã€‚ä¸è¿‡å¦‚æœæˆ‘åªæ˜¯åœ¨è¿™é‡Œé«˜è°ˆé˜”è®ºçš„è¯ï¼Œè¯»è€…ï¼ˆè¿™ç¯‡æ–‡ç« çœŸçš„å­˜åœ¨è¯»è€…å—ï¼‰ä¸€å®šæ„Ÿå—ä¸åˆ°è¿™ç§å¥‡å¦™çš„ä½“éªŒçš„ï¼Œé‚£æˆ‘å°±ä¸Šå›¾å§ï¼</p><p><img src="/images/others/random_thoughts/moon/square_moon.png" alt="æœˆäº®"></p><p>æˆ‘ä»¬ä¼šæ³¨æ„åˆ°å®ƒæ˜¯é»‘ä¸€å—ç™½ä¸€å—çš„ã€‚é»‘çš„å°±æ˜¯æœˆæµ·ï¼Œå®ƒä»¬æ˜¯å¤ä»£ç«å±±å–·å‘åç„æ­¦å²©å½¢æˆçš„å¹³åŸï¼Œç„æ­¦å²©é¢œè‰²è¾ƒæ·±ï¼Œåå°„é˜³å…‰çš„èƒ½åŠ›å¼±ï¼Œæ‰€ä»¥çœ‹èµ·æ¥æ˜¯æš—ç°è‰²çš„ã€‚è€Œç™½çš„åˆ™æ˜¯æœˆé™†ï¼Œä¸»è¦ç”±ä¸€ç§å«åšæ–œé•¿å²©çš„æµ…è‰²å²©çŸ³æ„æˆï¼Œçœ‹èµ·æ¥æ›´æ˜äº®ã€‚</p><p>è€Œå›¾ç‰‡äº”ç‚¹åŠæ–¹å‘ä¸Šçš„é‚£ä¸ªè¾å°„çŠ¶çš„ä¸œè¥¿å°±æ˜¯ç¬¬è°·å‘ï¼ï¼ˆçœ‹èµ·æ¥æœ‰ç‚¹åƒæ˜Ÿé™…æ‹“è’çš„å®‡å®™ä¹‹çœ¼å‘¢ï¼‰</p><p>ä¸è¿‡è¿™æ˜¯ PS è°ƒæ•´åçš„å›¾ï¼Œä¸»è¦æ˜¯æ‹‰é«˜äº†æ›å…‰ã€æ‹‰ä½äº†é«˜å…‰ã€æ‹‰é«˜äº†çº¹ç†å’Œæ¸…æ™°åº¦ï¼Œä¸‹é¢æ˜¯ç›´æ¥æ‹å‡ºæ¥çš„å›¾ï¼ˆå½“ç„¶ä¸æ˜¯åŸå›¾ï¼ŒåŸå›¾ 20mb æ„Ÿè§‰æ”¾è¿™é‡Œå°±å¤ªå¤§äº†ï¼‰ï¼š</p><p><img src="/images/others/random_thoughts/moon/moon_origin.jpg" alt="æœˆäº®å…¸è—ç‰ˆ"></p><p>æ¥ä¸‹æ¥çœ‹çœ‹æˆ‘æ˜¯æ€ä¹ˆæ‹å‡ºæ¥çš„å§ï¼ç›´æ¥æ‹¿ç€æ‰‹æœºå¯¹ç€æœ›è¿œé•œæ‹åªèƒ½æ‹å‡ºæ¥ä¸€ä¸ªå°å…‰çƒï¼Œæ­£ç¡®çš„åšæ³•æ˜¯è°ƒåˆ°ä¸“ä¸šæ¨¡å¼ç„¶åè°ƒæ•´å‚æ•°ï¼Œæˆ‘çš„K80è‡³å°Šç‰ˆæœ‰è¿™äº›å‚æ•°å¯è°ƒï¼š</p><ol><li>S - å¿«é—¨é€Ÿåº¦ï¼ˆShutter Speedï¼‰</li><li>ISO - æ„Ÿå…‰åº¦</li><li>WB - ç™½å¹³è¡¡</li><li>F - å¯¹ç„¦ï¼ˆFocusï¼‰</li></ol><p>ç›´æ¥æ‹åªèƒ½æ‹å‡ºå°å…‰çƒæ˜¯å› ä¸ºæ‰‹æœºæ‹ç…§é»˜è®¤æ˜¯è‡ªåŠ¨æ¨¡å¼ï¼Œè‡ªåŠ¨æ¨¡å¼çœ‹åˆ°æ•´ä¸ªç”»é¢éƒ½æ˜¯é»‘è‰²çš„ï¼ˆä¼—æ‰€å‘¨çŸ¥å¤œç©ºæ˜¯é»‘çš„ï¼‰å°±ä¼šåŠªåŠ›è°ƒèŠ‚è‡ªåŠ¨æ›å…‰ï¼Œæœ€åå¯¼è‡´è¿‡æ›ã€‚</p><p>ä¸ºäº†é¿å…è¿‡æ›ï¼Œæˆ‘ä»¬è¦åœ¨ä¸“ä¸šæ¨¡å¼é‡ŒæŠŠ S æé«˜ã€ISO é™ä½ã€‚æ€»ä¹‹æˆ‘æœ€åçš„å‚æ•°è®¾ç½®æ˜¯è¿™æ ·çš„ï¼šS: 1/160, ISO: 100, WB: æ²¡è°ƒ, F: æ‹‰åˆ°æœ€å³è¾¹ã€‚ç„¶åå°±èƒ½æ„‰å¿«åœ°æ‹ç…§äº†ï¼</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;ä»Šå¤©æ‹¿å‡ºäº†æˆ‘è€—è´¹ 200 å…ƒå·¨èµ„ä¹°çš„æ£®æ—äººæœ›è¿œé•œè¯•ç€çœ‹æœˆäº®ï¼&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/others/random_thoughts/moon/telescope.jpg&quot; alt=&quot;7x50&quot;&gt;&lt;/p&gt;
&lt;p&gt;åœ¨æ‹¿èµ·æœ›è¿œé•œçœ‹å‘æœˆäº®ä¹‹å‰çœŸçš„å¾ˆéš¾æƒ³è±¡ï¼Œ</summary>
      
    
    
    
    <category term="æ‚è°ˆ" scheme="http://rinevard.github.io/categories/%E6%9D%82%E8%B0%88/"/>
    
    <category term="ç¢ç¢å¿µ" scheme="http://rinevard.github.io/categories/%E6%9D%82%E8%B0%88/%E7%A2%8E%E7%A2%8E%E5%BF%B5/"/>
    
    
  </entry>
  
  <entry>
    <title>Lab 5 Copy-on-Write Fork</title>
    <link href="http://rinevard.github.io/wiki/learning/open-course/MIT-6.S081/Labs/lab5-cow/"/>
    <id>http://rinevard.github.io/wiki/learning/open-course/MIT-6.S081/Labs/lab5-cow/</id>
    <published>2025-11-03T13:56:22.000Z</published>
    <updated>2025-11-03T13:57:01.187Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™ä¸ª Lab è¦æ±‚æˆ‘ä»¬å®ç° cow forkï¼Œè¿™æ˜¯ä¸€ä¸ªå¸¸è§çš„èŠ‚çœå†…å­˜çš„æ‰‹æ®µã€‚</p><p>æ€»è€Œè¨€ä¹‹ï¼Œå°±æ˜¯åœ¨ fork æ—¶æŠŠçˆ¶å­çš„è™šæ‹Ÿå†…å­˜éƒ½æ˜ å°„åˆ°åŸæœ¬çš„çˆ¶è¿›ç¨‹çš„ç‰©ç†å†…å­˜ä¸Šï¼Œå¹¶å°†å…¶è®¾ä¸ºâ€œä»…è¯»â€ã€‚å½“æœ‰è¿›ç¨‹å°è¯•å†™å®ƒä¼šè§¦å‘ page faultï¼Œè¿™æ—¶æˆ‘ä»¬æ‰æ–°å»ºç‰©ç†é¡µï¼Œç„¶åè°ƒæ•´å°è¯•å†™çš„è¿›ç¨‹çš„é¡µè¡¨ï¼Œå°†å¯¹åº”è™šæ‹Ÿé¡µæ˜ å°„åˆ°æ–°å»ºçš„ç‰©ç†é¡µä¸Šã€‚</p><p>è¿™ä¸ª Lab ä¼¼ä¹æ²¡æœ‰å¤ª tricky çš„åœ°æ–¹ï¼Œæ¥ä¸‹æ¥æˆ‘ä¼šè‡ªé—®è‡ªç­”ä¸€ä¸‹ï¼Œåªè¦èƒ½æŠŠè¿™é‡Œçš„ç­”æ¡ˆæƒ³æ˜ç™½åŸºæœ¬å°±èƒ½å†™å¯¹ä»£ç äº†ï¼š</p><ol><li><p>æ€ä¹ˆè®©åªè¯»é¡µæ­£ç¡®åªè¯»ï¼Œè€Œä¸èƒ½è¢«å†™ï¼Ÿ</p><p> æˆ‘ä»¬é€šè¿‡ç»™ PTE è®¾ç½®ä¸€ä¸ª COW ä½æ¥åˆ¤æ–­æ˜¯å¦æ˜¯åªè¯». COW ä¸º 1 è¡¨ç¤ºè¿™ä¸ª PTE åŸæœ¬åº”è¯¥æ˜¯å¯å†™çš„ï¼Œä½†ç°åœ¨è¢«ä¸´æ—¶æ ‡è®°ä¸ºåªè¯»ï¼Œå› ä¸ºå¯¹åº”çš„ç‰©ç†é¡µæ­£åœ¨è¢«å¤šä¸ªè¿›ç¨‹å…±äº«ã€‚</p></li><li><p>ä»€ä¹ˆæ—¶å€™æ–°å»ºç‰©ç†é¡µï¼Ÿæˆ‘ä»¬ä¼šä¸ä¼šå¤šå»ºäº†ä¸å¿…è¦çš„ç‰©ç†é¡µï¼Ÿ</p><p> æˆ‘ä»¬ç»´æŠ¤å¯¹æ¯ä¸ªç‰©ç†é¡µçš„å¼•ç”¨è®¡æ•°ï¼Œå½“å¼•ç”¨è®¡æ•°ä¸º 1 æ—¶å°±æŠŠ COW é‡è®¾ä¸º 0ï¼ˆå› ä¸ºè¿™ä¸ªç‰©ç†é¡µä¸å†è¢«å¤šä¸ªè¿›ç¨‹å…±äº«ï¼‰ï¼ŒæŠŠ W ä½é‡æ–°è®¾ä¸º 1.</p></li><li><p>ä»€ä¹ˆæ—¶å€™é‡Šæ”¾ç‰©ç†é¡µï¼Ÿ</p><p> è°ƒç”¨ kfree æ—¶ï¼Œå¦‚æœå¼•ç”¨è®¡æ•°å¤§äº 1ï¼Œå°†å¼•ç”¨è®¡æ•° -1 ç„¶åä¸åŠ¨ï¼›å¦‚æœå¼•ç”¨è®¡æ•° == 1ï¼Œé‡Šæ”¾ç‰©ç†é¡µã€‚</p></li></ol><p>ç„¶åå°±ä¸Šä»£ç å§ã€‚</p><h1 id="ç‰©ç†å†…å­˜å±‚çš„åŸºå»ºä»£ç "><a href="#ç‰©ç†å†…å­˜å±‚çš„åŸºå»ºä»£ç " class="headerlink" title="ç‰©ç†å†…å­˜å±‚çš„åŸºå»ºä»£ç "></a>ç‰©ç†å†…å­˜å±‚çš„åŸºå»ºä»£ç </h1><p>é¦–å…ˆåœ¨ kalloc.c é‡Œæ–°å»ºä¸€ä¸ªæ•°æ®ç»“æ„ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">spinlock</span> lock<span class="token punctuation">;</span>    <span class="token keyword">int</span> refcnt<span class="token punctuation">[</span>PHYSTOP <span class="token operator">/</span> PGSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> kref<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œæœ‰é”æ˜¯å› ä¸ºæˆ‘ä»¬ä¸å¸Œæœ›å¤šä¸ªè¿›ç¨‹åŒæ—¶è¯»å†™ refcnt. æˆ‘ä»¬è¦åœ¨ kinit é‡Œåˆå§‹åŒ–é”ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">kinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">initlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmem<span class="token punctuation">.</span>lock<span class="token punctuation">,</span> <span class="token string">"kmem"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">initlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kref<span class="token punctuation">.</span>lock<span class="token punctuation">,</span> <span class="token string">"kref"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">freerange</span><span class="token punctuation">(</span>end<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>PHYSTOP<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶åæˆ‘ä»¬æä¾›ä¸‰ä¸ªæ¥å£ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">kaddref</span><span class="token punctuation">(</span>uint64 pa<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kref<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    kref<span class="token punctuation">.</span>refcnt<span class="token punctuation">[</span>pa <span class="token operator">/</span> PGSIZE<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kref<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">kdecref</span><span class="token punctuation">(</span>uint64 pa<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kref<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>kref<span class="token punctuation">.</span>refcnt<span class="token punctuation">[</span>pa <span class="token operator">/</span> PGSIZE<span class="token punctuation">]</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        kref<span class="token punctuation">.</span>refcnt<span class="token punctuation">[</span>pa <span class="token operator">/</span> PGSIZE<span class="token punctuation">]</span> <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kref<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">kgetref</span><span class="token punctuation">(</span>uint64 pa<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> ref<span class="token punctuation">;</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kref<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    ref <span class="token operator">=</span> kref<span class="token punctuation">.</span>refcnt<span class="token punctuation">[</span>pa <span class="token operator">/</span> PGSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kref<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> ref<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¹‹åå°±èƒ½ä¿®æ”¹ kfree å’Œ kalloc äº†ï¼Œè¿™é‡Œæˆ‘æä¾›çš„ kfree æ˜¯æœ‰å¹¶å‘é£é™©çš„ï¼Œå…·ä½“å¯ä»¥çœ‹æ³¨é‡Šï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">kfree</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>pa<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">run</span> <span class="token operator">*</span>r<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>pa <span class="token operator">%</span> PGSIZE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa <span class="token operator">&lt;</span> end <span class="token operator">||</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>pa <span class="token operator">>=</span> PHYSTOP<span class="token punctuation">)</span>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"kfree"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// è¿™é‡Œæœ‰æ½œåœ¨çš„å¹¶å‘é£é™©, å¦‚æœå¤šä¸ªå…±äº«äº†ç‰©ç†é¡µçš„è¿›ç¨‹åŒæ—¶ kfree è¿™ä¸ªç‰©ç†é¡µ,</span>    <span class="token comment">// é‚£ä¹ˆ if (kgetref((uint64)pa) == 0) ä¸‹çš„è¯­å¥å°±æœ‰å¯èƒ½è¢«å¤šä¸ªè¿›ç¨‹è¿›å…¥.</span>    <span class="token comment">// æƒ³ä¿®æ­£ä¹Ÿä¸éš¾, ä¸è°ƒç”¨å‡½æ•°è€Œæ˜¯æ‰‹åŠ¨è¯·æ±‚é”, åœ¨å’Œ refcnt äº¤äº’å®Œåé‡Šæ”¾é”å°±è¡Œ.</span>    <span class="token comment">// ä¸è¿‡ä»‹äºæµ‹è¯•ä»£ç å·²ç»è¿‡äº†, æˆ‘ä»¬å°±ä¸æ”¹åŠ¨äº†</span>    <span class="token function">kdecref</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>pa<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// Free physical memory only when no other reference exists</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">kgetref</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>pa<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// Fill with junk to catch dangling refs.</span>        <span class="token function">memset</span><span class="token punctuation">(</span>pa<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>        r <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">run</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa<span class="token punctuation">;</span>        <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmem<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>        r<span class="token operator">-></span>next <span class="token operator">=</span> kmem<span class="token punctuation">.</span>freelist<span class="token punctuation">;</span>        kmem<span class="token punctuation">.</span>freelist <span class="token operator">=</span> r<span class="token punctuation">;</span>        <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmem<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">kalloc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">run</span> <span class="token operator">*</span>r<span class="token punctuation">;</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmem<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    r <span class="token operator">=</span> kmem<span class="token punctuation">.</span>freelist<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">)</span>        kmem<span class="token punctuation">.</span>freelist <span class="token operator">=</span> r<span class="token operator">-></span>next<span class="token punctuation">;</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmem<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">)</span>        <span class="token function">kaddref</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">)</span>        <span class="token function">memset</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>r<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// fill with junk</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>r<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="COW-ç­–ç•¥å®ç°"><a href="#COW-ç­–ç•¥å®ç°" class="headerlink" title="COW ç­–ç•¥å®ç°"></a>COW ç­–ç•¥å®ç°</h1><p>ç„¶åæˆ‘ä»¬çœ‹å‘ trap.cï¼Œåœ¨ usertrap é‡ŒåŠ å…¥é¡µé”™è¯¯çš„åˆ†æ”¯ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">r_scause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// ...</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>which_dev <span class="token operator">=</span> <span class="token function">devintr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// ...</span><span class="token punctuation">&#125;</span> <span class="token comment">// è¿™é‡Œæ˜¯åŠ å…¥çš„åˆ†æ”¯</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">r_scause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">writefault</span><span class="token punctuation">(</span>p<span class="token operator">-></span>pagetable<span class="token punctuation">,</span> <span class="token function">r_stval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// copy on write</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// ...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ¥ç€æˆ‘ä»¬åˆ° vm.c é‡Œå®ç° writefaultï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// return 0 if error, and physical address if successful.</span>uint64 <span class="token function">writefault</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">,</span> uint64 va<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">pte_t</span> <span class="token operator">*</span>pte<span class="token punctuation">;</span>    uint64 pa<span class="token punctuation">;</span>    uint flags<span class="token punctuation">;</span>    <span class="token keyword">int</span> refcnt<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">proc</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">myproc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>va <span class="token operator">>=</span> p<span class="token operator">-></span>sz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    va <span class="token operator">=</span> <span class="token function">PGROUNDDOWN</span><span class="token punctuation">(</span>va<span class="token punctuation">)</span><span class="token punctuation">;</span>    pte <span class="token operator">=</span> <span class="token function">walk</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> va<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>pte <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    flags <span class="token operator">=</span> <span class="token function">PTE_FLAGS</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> PTE_COW<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// read-only page</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    pa <span class="token operator">=</span> <span class="token function">PTE2PA</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>refcnt <span class="token operator">=</span> <span class="token function">kgetref</span><span class="token punctuation">(</span>pa<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// no process ref this page</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>refcnt <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// only one process ref this page, change it to a regular writeable page</span>        <span class="token operator">*</span>pte <span class="token operator">&amp;=</span> <span class="token punctuation">(</span><span class="token operator">~</span>PTE_COW<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">*</span>pte <span class="token operator">|=</span> <span class="token punctuation">(</span>PTE_W<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> pa<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// copy on write</span>        <span class="token keyword">char</span> <span class="token operator">*</span>mem<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mem <span class="token operator">=</span> <span class="token function">kalloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">memmove</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">*</span>pte <span class="token operator">&amp;=</span> <span class="token punctuation">(</span><span class="token operator">~</span>PTE_V<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// make mappages work</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mappages</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> va<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">,</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>mem<span class="token punctuation">,</span> flags<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">kfree</span><span class="token punctuation">(</span>mem<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token operator">*</span>pte <span class="token operator">&amp;=</span> <span class="token punctuation">(</span><span class="token operator">~</span>PTE_COW<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">*</span>pte <span class="token operator">|=</span> <span class="token punctuation">(</span>PTE_W<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">kdecref</span><span class="token punctuation">(</span>pa<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> pa<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶ååœ¨ uvmcopy é‡ŒåŠ å…¥æŠŠå¤šä¸ªè™šæ‹Ÿå†…å­˜æ˜ å°„åˆ°ç›¸åŒç‰©ç†å†…å­˜çš„æœºåˆ¶ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">uvmcopy</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> old<span class="token punctuation">,</span> <span class="token class-name">pagetable_t</span> new<span class="token punctuation">,</span> uint64 sz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">pte_t</span> <span class="token operator">*</span>pte<span class="token punctuation">;</span>    uint64 pa<span class="token punctuation">,</span> i<span class="token punctuation">;</span>    uint flags<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> sz<span class="token punctuation">;</span> i <span class="token operator">+=</span> PGSIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pte <span class="token operator">=</span> <span class="token function">walk</span><span class="token punctuation">(</span>old<span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmcopy: pte should exist"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmcopy: page not present"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        pa <span class="token operator">=</span> <span class="token function">PTE2PA</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>        flags <span class="token operator">=</span> <span class="token function">PTE_FLAGS</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mappages</span><span class="token punctuation">(</span>new<span class="token punctuation">,</span> i<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">,</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>pa<span class="token punctuation">,</span> flags<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">goto</span> err<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> PTE_W<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">pte_t</span> <span class="token operator">*</span>new_pte <span class="token operator">=</span> <span class="token function">walk</span><span class="token punctuation">(</span>new<span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">*</span>pte <span class="token operator">&amp;=</span> <span class="token punctuation">(</span><span class="token operator">~</span>PTE_W<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">*</span>new_pte <span class="token operator">&amp;=</span> <span class="token punctuation">(</span><span class="token operator">~</span>PTE_W<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">*</span>pte <span class="token operator">|=</span> <span class="token punctuation">(</span>PTE_COW<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">*</span>new_pte <span class="token operator">|=</span> <span class="token punctuation">(</span>PTE_COW<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">kaddref</span><span class="token punctuation">(</span>pa<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>err<span class="token operator">:</span>    <span class="token function">uvmunmap</span><span class="token punctuation">(</span>new<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> i <span class="token operator">/</span> PGSIZE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ€åæ”¹æ”¹ copyout å°±å¯ä»¥ä¸‹ç­äº†ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">copyout</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">,</span> uint64 dstva<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>src<span class="token punctuation">,</span> uint64 len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    uint64 n<span class="token punctuation">,</span> va0<span class="token punctuation">,</span> pa0<span class="token punctuation">;</span>    <span class="token class-name">pte_t</span> <span class="token operator">*</span>pte<span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>len <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        va0 <span class="token operator">=</span> <span class="token function">PGROUNDDOWN</span><span class="token punctuation">(</span>dstva<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>va0 <span class="token operator">>=</span> MAXVA<span class="token punctuation">)</span>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        pte <span class="token operator">=</span> <span class="token function">walk</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> va0<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pte <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_U<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_W<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_COW<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">writefault</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> va0<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// copy on write</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        pa0 <span class="token operator">=</span> <span class="token function">PTE2PA</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>        n <span class="token operator">=</span> PGSIZE <span class="token operator">-</span> <span class="token punctuation">(</span>dstva <span class="token operator">-</span> va0<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">></span> len<span class="token punctuation">)</span>            n <span class="token operator">=</span> len<span class="token punctuation">;</span>        <span class="token function">memmove</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>pa0 <span class="token operator">+</span> <span class="token punctuation">(</span>dstva <span class="token operator">-</span> va0<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> src<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>        len <span class="token operator">-=</span> n<span class="token punctuation">;</span>        src <span class="token operator">+=</span> n<span class="token punctuation">;</span>        dstva <span class="token operator">=</span> va0 <span class="token operator">+</span> PGSIZE<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç­‰ç­‰ï¼Œå…ˆåˆ«æ€¥ç€ä¸‹ç­ï¼Œcopyout æ˜¯åšä»€ä¹ˆçš„ï¼Ÿä¸ºä»€ä¹ˆå®ƒçœ‹èµ·æ¥ç‹¬æ ‘ä¸€å¸œï¼Œè¦æˆ‘ä»¬æ‰‹åŠ¨è°ƒç”¨å¤„ç†å†™æ•…éšœçš„å‡½æ•°ï¼Œè€Œä¸æ˜¯è‡ªåŠ¨è§¦å‘å†™æ•…éšœç„¶åè‡ªåŠ¨è¢«å¤„ç†ï¼Ÿ</p><p>çœ‹çœ‹ä»£ç å¯ä»¥å‘ç°ï¼Œå®ƒæ²¡æœ‰é€šè¿‡ç”¨æˆ·é¡µè¡¨æ¥â€œå†™â€å†…å­˜ï¼Œè€Œæ˜¯é€šè¿‡ç”¨æˆ·é¡µè¡¨æ‹¿åˆ°ç‰©ç†åœ°å€ï¼Œå†é€šè¿‡å†…æ ¸é¡µè¡¨å†™å†…å­˜ã€‚åœ¨è¿™é‡Œï¼Œç¡¬ä»¶åªæ£€æŸ¥å†…æ ¸é¡µè¡¨çš„æƒé™ï¼Œè€Œä¸æ£€æŸ¥ç”¨æˆ·é¡µè¡¨ PTE çš„ PTE_W/COWï¼Œå› æ­¤è‡ªç„¶ä¸ä¼šè§¦å‘å†™æ•…éšœã€‚</p><p>æ€»ä¹‹å°±ä¸‹ç­äº†ï¼Œç„¶åæ”¾å¼ å›¾å›¾å§</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab5-cow/wtf_i_just_want_video_game.png" alt=""></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;è¿™ä¸ª Lab è¦æ±‚æˆ‘ä»¬å®ç° cow forkï¼Œè¿™æ˜¯ä¸€ä¸ªå¸¸è§çš„èŠ‚çœå†…å­˜çš„æ‰‹æ®µã€‚&lt;/p&gt;
&lt;p&gt;æ€»è€Œè¨€ä¹‹ï¼Œå°±æ˜¯åœ¨ fork æ—¶æŠŠçˆ¶å­çš„è™šæ‹Ÿå†…å­˜éƒ½æ˜ å°„åˆ°åŸæœ¬çš„çˆ¶è¿›ç¨‹çš„ç‰©ç†å†…å­˜ä¸Šï¼Œå¹¶å°†å…¶è®¾ä¸ºâ€œä»…è¯»â€ã€‚å½“æœ‰è¿›ç¨‹å°è¯•å†™å®ƒä¼šè§¦å‘ page faultï¼Œè¿™æ—¶æˆ‘ä»¬æ‰æ–°å»ºç‰©ç†é¡µï¼Œç„¶åè°ƒæ•´å°è¯•å†™</summary>
      
    
    
    
    <category term="å…¬å¼€è¯¾" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/"/>
    
    <category term="MIT-6.S081" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/MIT-6-S081/"/>
    
    <category term="Labs" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/MIT-6-S081/Labs/"/>
    
    
  </entry>
  
  <entry>
    <title>Lab 4 Traps</title>
    <link href="http://rinevard.github.io/wiki/learning/open-course/MIT-6.S081/Labs/lab4-traps/"/>
    <id>http://rinevard.github.io/wiki/learning/open-course/MIT-6.S081/Labs/lab4-traps/</id>
    <published>2025-10-30T14:28:22.000Z</published>
    <updated>2025-10-30T14:38:20.127Z</updated>
    
    <content type="html"><![CDATA[<h1 id="RISC-V-assembly"><a href="#RISC-V-assembly" class="headerlink" title="RISC-V assembly"></a><strong>RISC-V assembly</strong></h1><p>åœ¨ lab å¼€å§‹æ—¶ï¼Œæˆ‘ä»¬è¦ç®€å•å›ç­”ä¸€äº›é—®é¢˜ã€‚è¿™é‡Œåªç®€å•èŠèŠæœ€åä¸¤é“ï¼š</p><ol><li><p>ä¸‹é¢çš„ä»£ç ä¼šæ‰“å°ä»€ä¹ˆï¼Ÿ</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0x00646c72</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"H%x Wo%s"</span><span class="token punctuation">,</span> <span class="token number">57616</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p> 57616 è½¬æ¢åˆ°åå…­è¿›åˆ¶æ˜¯ E110ï¼Œæ‰€ä»¥ç©ºæ ¼å‰æ‰“å°çš„æ˜¯ HE110.</p><p> RISC-V ä½¿ç”¨å°ç«¯æ³•ï¼Œæ‰€ä»¥ <code>i</code> åœ¨å†…å­˜ä¸­çš„å­˜å‚¨æ˜¯ <code>72 6c 64 00</code>ï¼Œæ‰€ä»¥ç©ºæ ¼åæ‰“å°çš„æ˜¯ rld.</p><p> æ€»ä¹‹æˆ‘ä»¬æ‰“å°äº† HE110, World!ï¼ˆä»¥åå’±å°±ç”¨è¿™ä¸ªå»æ°´è´´</p></li><li><p>ä¸‹é¢çš„ä»£ç åœ¨ â€œy=â€ åä¼šæ‰“å°ä»€ä¹ˆï¼Ÿ</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"x=%d y=%d"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p> æˆ‘ä»¬æ²¡æœ‰ä¼ å…¥ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šæŠŠå¯„å­˜å™¨ a2 é‡Œçš„ä¸œè¥¿å½“ä½œ int æ¥æ‰“å°ã€‚</p></li></ol><h1 id="Backtrace"><a href="#Backtrace" class="headerlink" title="Backtrace"></a>Backtrace</h1><p>è¿™é‡Œè¦æ±‚æˆ‘ä»¬å®ç°ä¸€ä¸ª backtrace å‡½æ•°ï¼Œæ‰“å°å‡ºå½“å‰è°ƒç”¨æ ˆã€‚</p><h2 id="è§£æ³•"><a href="#è§£æ³•" class="headerlink" title="è§£æ³•"></a>è§£æ³•</h2><p>æˆ‘ä»¬å…ˆæ¥å›é¡¾ä¸€ä¸‹ xv6 çš„æ ˆç»“æ„ï¼š</p><pre class="line-numbers language-none"><code class="language-none">                 .                 .    +-&gt;          .    |   +-----------------+   |    |   | return address  |   |    |   |   previous fp ------+    |   | saved registers |    |   | local variables |    |   |       ...       | &lt;-+    |   +-----------------+   |    |   | return address  |   |    +------ previous fp   |   |        | saved registers |   |        | local variables |   |    +-&gt; |       ...       |   |    |   +-----------------+   |    |   | return address  |   |    |   |   previous fp ------+    |   | saved registers |    |   | local variables |    |   |       ...       | &lt;-+    |   +-----------------+   |    |   | return address  |   |    +------ previous fp   |   |        | saved registers |   |        | local variables |   |$fp --&gt; |       ...       |   |        +-----------------+   |        | return address  |   |        |   previous fp ------+        | saved registers |$sp --&gt; | local variables |        +-----------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥æ¦‚æ‹¬ç®—æ³•æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>æ‰¾åˆ°å½“å‰ stack frame çš„ fpï¼Œè¿™åœ¨åˆå§‹åŒ–æ—¶å°±æ˜¯æ‰¾åˆ°å¯„å­˜å™¨ s0 é‡Œå­˜å‚¨çš„æŒ‡é’ˆã€‚</li><li>æ‰¾åˆ°å½“å‰ stack frame çš„ previous fpï¼Œåˆ¤æ–­ previous fp å’Œå½“å‰ fp æ˜¯å¦åœ¨ä¸€ä¸ª page å†…<ol><li>å¦‚æœåœ¨ï¼Œç”¨ %p æ‰“å°è¿™ä¸ª frame å­˜å‚¨çš„è·³è½¬å€¼ï¼Œç„¶åç»§ç»­å¾ªç¯</li><li>å¦‚æœä¸åœ¨å°±ç»“æŸå¾ªç¯</li></ol></li></ol><p>æ€»ä¹‹ä»£ç å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">backtrace</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    uint64 fp <span class="token operator">=</span> <span class="token function">r_fp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"backtrace:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>uint64 cur_fp <span class="token operator">=</span> fp<span class="token punctuation">;</span> <span class="token function">PGROUNDDOWN</span><span class="token punctuation">(</span>cur_fp<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">PGROUNDDOWN</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>         cur_fp <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>uint64 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>cur_fp <span class="token operator">-</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        uint64 ret_addr <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>uint64 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>cur_fp <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%p\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>ret_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="å’Œ-CSAPP-ä»‹ç»çš„æ ˆç»“æ„çš„å¯¹æ¯”"><a href="#å’Œ-CSAPP-ä»‹ç»çš„æ ˆç»“æ„çš„å¯¹æ¯”" class="headerlink" title="å’Œ CSAPP ä»‹ç»çš„æ ˆç»“æ„çš„å¯¹æ¯”"></a>å’Œ CSAPP ä»‹ç»çš„æ ˆç»“æ„çš„å¯¹æ¯”</h2><p>æˆ‘ä»¬ä¼šæ³¨æ„åˆ° xv6 çš„æ ˆç»“æ„å’Œ CSAPP é‡Œä»‹ç»çš„ç•¥æœ‰å·®å¼‚ï¼Œä¸»è¦æ˜¯ CSAPP çš„æ ˆå¸§ä¸åŒ…å« <code>previous fp</code>ã€‚ä¸‹é¢çš„æ˜¯ CSAPP ä»‹ç»çš„æ ˆç»“æ„</p><pre class="line-numbers language-none"><code class="language-none">é«˜åœ°å€            |  å‚æ•°7                |            |  å‚æ•°8                |            |  ...                 |  â† è°ƒç”¨å‰push            |  è¿”å›åœ°å€             |  â† callæŒ‡ä»¤è‡ªåŠ¨push            |  ä¿å­˜çš„å¯„å­˜å™¨å€¼        |  â† åˆšè¿›å…¥å‡½æ•°æ—¶push            |  æœ¬åœ°å˜é‡1            |            |  æœ¬åœ°å˜é‡2            |            |  ...                 |   â† å½“å‰rspæŒ‡å‘è¿™é‡Œä½åœ°å€<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸‹é¢æˆ‘ä»¬æ¥ç¼–è¯‘ CSAPP ä¹¦ä¸­çš„ä¸€æ®µä»£ç ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">long</span> <span class="token function">caller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">long</span> arg1 <span class="token operator">=</span> <span class="token number">534</span><span class="token punctuation">;</span>    <span class="token keyword">long</span> arg2 <span class="token operator">=</span> <span class="token number">1057</span><span class="token punctuation">;</span>    <span class="token keyword">long</span> sum <span class="token operator">=</span> <span class="token function">swap_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>arg1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>arg2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">long</span> diff <span class="token operator">=</span> arg1 <span class="token operator">-</span> arg2<span class="token punctuation">;</span>    <span class="token keyword">return</span> sum <span class="token operator">*</span> diff<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œæ˜¯ CSAPP ä¹¦ä¸Šç»™å‡ºçš„ç¼–è¯‘ç»“æœï¼š</p><pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token label function">caller:</span>    subq    <span class="token number">$16</span>, <span class="token operator">%</span><span class="token register variable">rsp</span>       <span class="token comment">; Allocate 16 bytes for stack frame</span>    movq    <span class="token number">$534</span>, (<span class="token operator">%</span><span class="token register variable">rsp</span>)    <span class="token comment">; Store 534 in arg1</span>    movq    <span class="token number">$1057</span>, <span class="token number">8</span>(<span class="token operator">%</span><span class="token register variable">rsp</span>)  <span class="token comment">; Store 1057 in arg2</span>    leaq    <span class="token number">8</span>(<span class="token operator">%</span><span class="token register variable">rsp</span>), <span class="token operator">%</span><span class="token register variable">rsi</span>   <span class="token comment">; Compute &amp;arg2 as second argument</span>    movq    <span class="token operator">%</span><span class="token register variable">rsp</span>, <span class="token operator">%</span><span class="token register variable">rdi</span>      <span class="token comment">; Compute &amp;arg1 as first argument</span>    call    swap_add        <span class="token comment">; Call swap_add(&amp;arg1, &amp;arg2)</span>    movq    (<span class="token operator">%</span><span class="token register variable">rsp</span>), <span class="token operator">%</span><span class="token register variable">rdx</span>    <span class="token comment">; Get arg1</span>    subq    <span class="token number">8</span>(<span class="token operator">%</span><span class="token register variable">rsp</span>), <span class="token operator">%</span><span class="token register variable">rdx</span>   <span class="token comment">; Compute diff = arg1 - arg2</span>    imulq   <span class="token operator">%</span><span class="token register variable">rdx</span>, <span class="token operator">%</span><span class="token register variable">rax</span>      <span class="token comment">; Compute sum * diff</span>    addq    <span class="token number">$16</span>, <span class="token operator">%</span><span class="token register variable">rsp</span>       <span class="token comment">; Deallocate stack frame</span>    ret                     <span class="token comment">; Return</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œåˆ™æ˜¯åœ¨ xv6 é‡Œå¾—åˆ°çš„ç¼–è¯‘ç»“æœï¼š</p><pre class="line-numbers language-none"><code class="language-none">0000000000000034 &lt;caller&gt;:long caller()  34:1141                addisp,sp,-16  36:e422                sds0,8(sp)  38:0800                addis0,sp,16  3a:000cb537            luia0,0xcb  3e:25d50513            addia0,a0,605 # cb25d &lt;base+0xca24d&gt;  42:6422                lds0,8(sp)  44:0141                addisp,sp,16  46:8082                ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥æ³¨æ„åˆ° CSAPP åªæ˜¯æŠŠå±€éƒ¨å˜é‡ arg1 å’Œ arg2 å­˜å‚¨åœ¨äº†æ ˆä¸­ï¼Œè€Œ xv6 çš„ <code>sd s0,8(sp)</code> æŠŠè°ƒç”¨è€…çš„æ ˆå¸§æŒ‡é’ˆå‹å…¥äº†æ ˆä¸­ã€‚</p><p>äº§ç”Ÿè¿™ç§å·®å¼‚çš„åŸå› æ˜¯ç¼–è¯‘å™¨çš„ä¼˜åŒ–ï¼ŒCSAPP é‡Œçš„ç¼–è¯‘å™¨è®¤ä¸ºé€šè¿‡ <code>subq $16, %rsp</code> å’Œ <code>addq $16, %rsp</code> å°±èƒ½å®Œæˆè¿™ä¸ªå‡½æ•°çš„å·¥ä½œï¼Œæ‰€ä»¥æ²¡æœ‰å­˜å‚¨æ ˆå¸§æŒ‡é’ˆï¼›xv6 åˆ™ä¸ºäº†æ–¹ä¾¿æ•™å­¦ï¼ŒåŒ…å«äº†æ ˆå¸§æŒ‡é’ˆã€‚</p><h1 id="Alarm"><a href="#Alarm" class="headerlink" title="Alarm"></a>Alarm</h1><p>è¿™é‡Œæˆ‘ä»¬è¦å®ç°ä¸€ä¸ªå«åš <code>sigalarm(interval, handler)</code> çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå®ƒä¼šæ¯éš” interval ä¸ª ticks è°ƒç”¨ä¸€æ¬¡ handler. </p><p>æ¯ä¸ª tick éƒ½ä¼šäº§ç”Ÿä¸€ä¸ªä¸­æ–­ï¼Œæˆ‘ä»¬è¦åšçš„å°±æ˜¯æ¯ä¸­æ–­è‹¥å¹²æ¬¡è°ƒç”¨ä¸€ä¸‹ handler.</p><p>æˆ‘ä»¬è¿˜éœ€è¦å®ç° <code>sigreturn</code>ï¼Œå®ƒæ˜¯ä¸€ä¸ªè¾…åŠ© <code>sigalarm</code> æ­£ç¡®å·¥ä½œçš„ç³»ç»Ÿè°ƒç”¨ã€‚æˆ‘ä»¬æœ‰è¿™æ ·çš„ promiseâ€”â€”ç”¨æˆ·åœ¨è°ƒç”¨ <code>sigalram</code> æ—¶æä¾›çš„ handler å‡½æ•°å¿…é¡»åœ¨ç»“å°¾è°ƒç”¨ <code>sigreturn</code>ã€‚æ€»ä¹‹ï¼Œ<code>sigreturn</code> çš„å·¥ä½œä¸»è¦æ˜¯æŠŠç”¨æˆ·è¿›ç¨‹çŠ¶æ€æ¢å¤åˆ°è¢«ä¸­æ–­æ—¶çš„çŠ¶æ€ã€‚</p><h2 id="å¼€å·¥ï¼"><a href="#å¼€å·¥ï¼" class="headerlink" title="å¼€å·¥ï¼"></a>å¼€å·¥ï¼</h2><p>æˆ‘ä»¬å¯ä»¥æŒ‰ä¸‹é¢çš„æµç¨‹å®Œæˆä»»åŠ¡ï¼š</p><ol><li><p>åœ¨å¼€å§‹ä¹‹å‰ï¼š</p><p> åœ¨ <code>usys.pl</code> ç­‰åœ°æ–¹åšä¸€äº›åŸºå»ºæ¥æŠŠä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨åŠ å…¥åˆ°ç³»ç»Ÿé‡Œ</p></li><li><p>æ¯éš”è‹¥å¹² ticks è°ƒç”¨ä¸€æ¬¡ handlerï¼š</p><p> åœ¨ <code>proc.h</code> é‡ŒåŠ å…¥å­˜å‚¨ intervalã€handler ä»¥åŠè·ç¦»ä¸Šä¸€æ¬¡è°ƒç”¨ handler è¿‡å»çš„ ticks çš„å­—æ®µ</p><p> åœ¨ <code>sysproc.c</code> é‡Œå®ç° <code>sys_sigalarm</code>ï¼Œå®ƒè®°å½•å¹¶å­˜å‚¨ç”¨æˆ·ä¼ è¿›æ¥çš„ interval å’Œ handler</p><p> åœ¨ <code>trap.c</code> çš„ <code>usertrap</code> é‡ŒåŠ å…¥å¯¹ handler çš„è°ƒç”¨ã€‚è¿˜è®°å¾—å—ï¼Œå½“æ‰§è¡Œ SERT æ—¶ï¼Œç¨‹åºè®¡æ•°å™¨ pc è¢«è®¾ç½®ä¸ºå­˜å‚¨åœ¨ sepc å¯„å­˜å™¨ä¸­çš„å€¼ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ä¿®æ”¹ <code>p-&gt;trapframe-&gt;epc</code>.</p></li><li><p>æŠŠç”¨æˆ·è¿›ç¨‹çŠ¶æ€æ¢å¤åˆ°è¢«ä¸­æ–­æ—¶çš„çŠ¶æ€ï¼š</p><p> æˆ‘ä»¬éœ€è¦ä¿å­˜çš„æ˜¯ç”¨æˆ·ä¸­æ–­æ—¶çš„ <code>struct trapframe</code>. æ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨ proc.h é‡Œæ–°å¢ <code>struct trapframe alarm_tf</code> å­—æ®µï¼Œåœ¨ handler è¢«è°ƒç”¨æ—¶æŠŠ p-&gt;trapframe å¤åˆ¶åˆ° alarm_tfï¼Œå¹¶åœ¨ <code>sys_sigreturn</code> è¢«è°ƒç”¨æ—¶æŠŠ alarm_tf å¤åˆ¶å› p-&gt;trapframe.</p></li></ol><p>æˆ‘ä»¬å°±ç›´æ¥æ”¾æœ€ç»ˆä»£ç äº†ã€‚</p><p>é¦–å…ˆåœ¨ proc.h çš„ struct proc é‡Œæ–°å¢è¿™äº›å­—æ®µï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> alarm_freq<span class="token punctuation">;</span>              <span class="token comment">// How many ticks to call alarm_handler once</span>uint64 alarm_handler<span class="token punctuation">;</span>        <span class="token comment">// Handler's user virtual address</span><span class="token keyword">int</span> tick_from_last<span class="token punctuation">;</span>          <span class="token comment">// How many ticks have passed since the last call</span><span class="token keyword">int</span> is_alarming<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">trapframe</span> alarm_tf<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶ååœ¨ sys_proc.c é‡ŒæŠŠç”¨æˆ·ä¼ å…¥çš„ interval å’Œ handler ä¿å­˜ä¸‹æ¥ï¼Œå¹¶åˆå§‹åŒ–ä¸€äº›å’Œè°ƒç”¨ handler ç›¸å…³çš„å˜é‡ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">uint64 <span class="token function">sys_sigalarm</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> ticks<span class="token punctuation">;</span>    uint64 handler<span class="token punctuation">;</span>    <span class="token function">argint</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>ticks<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">argaddr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">myproc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>alarm_freq <span class="token operator">=</span> ticks<span class="token punctuation">;</span>    <span class="token function">myproc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>alarm_handler <span class="token operator">=</span> handler<span class="token punctuation">;</span>    <span class="token function">myproc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>tick_from_last <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">myproc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>is_alarming <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¹‹åä¿®æ”¹ trap.c å®Œæˆå¯¹ handler çš„è°ƒç”¨ä»¥åŠå¯¹ç”¨æˆ·è¿›ç¨‹çŠ¶æ€çš„ä¿å­˜ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span>which_dev <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-></span>alarm_freq <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>p<span class="token operator">-></span>is_alarming <span class="token operator">&amp;&amp;</span> p<span class="token operator">-></span>tick_from_last <span class="token operator">>=</span> p<span class="token operator">-></span>alarm_freq <span class="token operator">&amp;&amp;</span>            p<span class="token operator">-></span>tick_from_last <span class="token operator">%</span> p<span class="token operator">-></span>alarm_freq <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            p<span class="token operator">-></span>is_alarming <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token function">memmove</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token operator">-></span>alarm_tf<span class="token punctuation">,</span> p<span class="token operator">-></span>trapframe<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token operator">-></span>trapframe<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            p<span class="token operator">-></span>trapframe<span class="token operator">-></span>epc <span class="token operator">=</span> p<span class="token operator">-></span>alarm_handler<span class="token punctuation">;</span>            p<span class="token operator">-></span>tick_from_last <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            p<span class="token operator">-></span>tick_from_last <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ€ååœ¨è¿”å›æ—¶é‡ç½®ç”¨æˆ·è¿›ç¨‹çŠ¶æ€ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">uint64 <span class="token function">sys_sigreturn</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">proc</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">myproc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">memmove</span><span class="token punctuation">(</span>p<span class="token operator">-></span>trapframe<span class="token punctuation">,</span> <span class="token operator">&amp;</span>p<span class="token operator">-></span>alarm_tf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token operator">-></span>trapframe<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    p<span class="token operator">-></span>is_alarming <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> p<span class="token operator">-></span>alarm_tf<span class="token punctuation">.</span>a0<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="ä¸€äº›å°æƒ³æ³•"><a href="#ä¸€äº›å°æƒ³æ³•" class="headerlink" title="ä¸€äº›å°æƒ³æ³•"></a>ä¸€äº›å°æƒ³æ³•</h2><p>ä¸ºä»€ä¹ˆè¯´â€œPrevent re-entrant calls to the handlerâ€”â€”if a handler hasnâ€™t returned yet, the kernel shouldnâ€™t call it again. test2 tests this.â€ï¼Œå³ä¸èƒ½åœ¨ä¸Šæ¬¡å¯¹ handler çš„è°ƒç”¨å®Œæˆå‰è¿›è¡Œä¸‹æ¬¡è°ƒç”¨ï¼Ÿæˆ‘çŒœæ˜¯å› ä¸ºæˆ‘ä»¬ä¼šä¿å­˜è°ƒç”¨å‰çš„ç”¨æˆ·è¿›ç¨‹çŠ¶æ€ï¼Œè€Œåœ¨ä¸Šæ¬¡ handler å®Œæˆå‰å†æ¬¡è°ƒç”¨ handler å°±ä¼šä¿å­˜ä¸Šæ¬¡ handler æ­£åœ¨æ‰§è¡Œæ—¶çš„ç”¨æˆ·è¿›ç¨‹çŠ¶æ€ï¼Œè¿™ä¼šè¦†ç›–æœ€å¼€å§‹çš„ç”¨æˆ·è¿›ç¨‹çŠ¶æ€ã€‚</p><p>å†è¯´å¥é¢˜å¤–è¯ï¼Œæ„Ÿè§‰ Page Tables çš„ hard çš„éš¾åº¦æ¯”è¿™ä¸ªéš¾ä¸å°‘â€¦â€¦æœç„¶ All hards are hard, but some hards are harder than othersğŸ« ğŸ« </p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;RISC-V-assembly&quot;&gt;&lt;a href=&quot;#RISC-V-assembly&quot; class=&quot;headerlink&quot; title=&quot;RISC-V assembly&quot;&gt;&lt;/a&gt;&lt;strong&gt;RISC-V assembly&lt;/strong&gt;&lt;/h1&gt;&lt;p&gt;åœ¨</summary>
      
    
    
    
    <category term="å…¬å¼€è¯¾" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/"/>
    
    <category term="MIT-6.S081" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/MIT-6-S081/"/>
    
    <category term="Labs" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/MIT-6-S081/Labs/"/>
    
    
  </entry>
  
  <entry>
    <title>Lab 3 Page Tables</title>
    <link href="http://rinevard.github.io/wiki/learning/open-course/MIT-6.S081/Labs/lab3-pagetable/"/>
    <id>http://rinevard.github.io/wiki/learning/open-course/MIT-6.S081/Labs/lab3-pagetable/</id>
    <published>2025-10-28T08:28:22.000Z</published>
    <updated>2025-10-28T08:29:01.912Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Inspect-a-user-process-page-table"><a href="#Inspect-a-user-process-page-table" class="headerlink" title="Inspect a user-process page table"></a><strong>Inspect a user-process page table</strong></h1><p>è¿™é“é¢˜è®©æˆ‘ä»¬è§£é‡Šä¸€ä¸‹ <code>print_pgtbl</code> çš„æ‰“å°ç»“æœï¼Œé¦–å…ˆè®©æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒæ‰“å°äº†ä»€ä¹ˆï¼š</p><pre class="line-numbers language-none"><code class="language-none">print_pgtbl startingva 0x0 pte 0x21FCD85B pa 0x87F36000 perm 0x5Bva 0x1000 pte 0x21FD141B pa 0x87F45000 perm 0x1Bva 0x2000 pte 0x21FD1017 pa 0x87F44000 perm 0x17va 0x3000 pte 0x21FD4007 pa 0x87F50000 perm 0x7va 0x4000 pte 0x21FC70D7 pa 0x87F1C000 perm 0xD7va 0x5000 pte 0x0 pa 0x0 perm 0x0va 0x6000 pte 0x0 pa 0x0 perm 0x0va 0x7000 pte 0x0 pa 0x0 perm 0x0va 0x8000 pte 0x0 pa 0x0 perm 0x0va 0x9000 pte 0x0 pa 0x0 perm 0x0va 0xFFFF6000 pte 0x0 pa 0x0 perm 0x0va 0xFFFF7000 pte 0x0 pa 0x0 perm 0x0va 0xFFFF8000 pte 0x0 pa 0x0 perm 0x0va 0xFFFF9000 pte 0x0 pa 0x0 perm 0x0va 0xFFFFA000 pte 0x0 pa 0x0 perm 0x0va 0xFFFFB000 pte 0x0 pa 0x0 perm 0x0va 0xFFFFC000 pte 0x0 pa 0x0 perm 0x0va 0xFFFFD000 pte 0x0 pa 0x0 perm 0x0va 0xFFFFE000 pte 0x21FC94C7 pa 0x87F25000 perm 0xC7va 0xFFFFF000 pte 0x2000184B pa 0x80006000 perm 0x4Bprint_pgtbl: OK<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç»“åˆ <code>print_pgtbl</code> çš„å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ <code>pgtbltest</code> éå†äº†ç”¨æˆ·è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´å¼€å¤´å’Œæœ«å°¾çš„ä¸€äº›åœ°å€ï¼Œå¹¶æ‰“å°å‡ºå®ƒä»¬å¯¹åº”çš„ PTEã€ç‰©ç†åœ°å€ã€æƒé™ä½ã€‚è®©æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ PTE çš„ç»“æ„ï¼š</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab3-pagetable/pte.png" alt=""></p><p>ç„¶åæˆ‘ä»¬ä»¥ <code>va 0x4000 pte 0x21FC70D7 pa 0x87F1C000 perm 0xD7</code> ä¸ºä¾‹ï¼Œè§£æä¸€ä¸‹å…¶æ‰“å°çš„å†…å®¹ã€‚é¦–å…ˆæˆ‘ä»¬ä» PTE ä¸­æå–å‡º Physical Page Numberï¼ˆPPNï¼‰å’Œæƒé™ä½ï¼š</p><pre class="line-numbers language-none"><code class="language-none">&#x2F;&#x2F; æ‰“å° PPN&#x2F;&#x2F; è™šæ‹Ÿåœ°å€çš„æœ«å°¾ 12 ä½æ˜¯ 0, æ‰€ä»¥ç‰©ç†åœ°å€åç§»é‡ä¸º 0&#x2F;&#x2F; ç‰©ç†åœ°å€ä¸º ((pte &gt;&gt; 10) &lt;&lt; 12) + 0 å³ 0x87f1c000(gdb) p &#x2F;x (0x21FC70D7 &gt;&gt; 10)$17 &#x3D; 0x87f1c&#x2F;&#x2F; æ„é€ ä¸€ä¸ªæœ«å°¾ 10 ä½ä¸º 1 çš„é‡, æ–¹ä¾¿åç»­å–å‡ºæƒé™ä½(gdb) set $mask &#x3D; ((1 &lt;&lt; 10) - 1)(gdb) p &#x2F;t $mask$18 &#x3D; 1111111111&#x2F;&#x2F; åˆ†åˆ«ç”¨äºŒè¿›åˆ¶å’Œåå…­è¿›åˆ¶æ‰“å°æƒé™ä½(gdb) p &#x2F;t (0x21FC70D7 &amp; $mask)$19 &#x3D; 11010111(gdb) p &#x2F;x (0x21FC70D7 &amp; $mask)$20 &#x3D; 0xd7<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ£€éªŒå¯çŸ¥å’Œ <code>print_pgtbl</code> çš„æ‰“å°ç»“æœä¸€è‡´ã€‚å¯¹ç…§æƒé™ä½çš„æœ«äº”ä½ 10111 å’Œ PTE çš„æœ«å°¾äº”ä½ UXWRVï¼Œå¯çŸ¥è¿™é‡Œæ˜¯ç”¨æˆ·å†…å­˜ã€ä¸å¯æ‰§è¡Œã€å¯å†™ã€å¯è¯»ã€åˆæ³•ã€‚</p><p>æˆ‘ä»¬å¯ä»¥å†æ£€æŸ¥ä¸€ä¸‹ <code>va 0xFFFFF000 pte 0x2000184B pa 0x80006000 perm 0x4B</code>ï¼Œä¼šå‘ç°å®ƒçš„æƒé™ä½æœ«äº”ä½æ˜¯ 01011ï¼Œè¯´æ˜è¿™é‡Œæ˜¯éç”¨æˆ·å†…å­˜ã€å¯ä»¥æ‰§è¡Œã€ä¸å¯å†™ã€å¯è¯»ã€åˆæ³•ã€‚</p><p>å¯¹ç…§ä¸‹é¢çš„ç”¨æˆ·è¿›ç¨‹è™šæ‹Ÿå†…å­˜ç©ºé—´å›¾å¯çŸ¥æˆ‘ä»¬åˆ†æçš„ç¬¬ä¸€æ®µè™šæ‹Ÿåœ°å€ <code>0x4000</code> å¤§çº¦åœ¨å¼€å¤´ä½ç½®ï¼Œç¡®å®æ˜¯ç”¨æˆ·çš„ä¸œè¥¿ï¼›è€Œåˆ†æçš„ç¬¬äºŒæ®µ <code>0xFFFFF000</code> åˆ™åœ¨æ¥è¿‘æœ«å°¾çš„ä½ç½®ï¼Œç”¨äºå­˜å‚¨ç³»ç»Ÿè°ƒç”¨ç›¸å…³çš„é™·é˜±ä»£ç ã€‚</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab3-pagetable/user_addr_space.png" alt=""></p><p>æˆ‘ä»¬è¿˜å¯ä»¥è¿›ä¸€æ­¥æ‰“å°ä¸€ä¸‹å†…å­˜é‡Œçš„å€¼ã€‚å¯åŠ¨ gdbï¼Œç”¨ <code>file user/_pgtbltest</code> åŠ è½½ç¬¦å·è¡¨ï¼Œç„¶ååœ¨ <code>main</code> è®¾ç½®æ–­ç‚¹ï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½åœ¨åŠ è½½ç”¨æˆ·é¡µè¡¨æ—¶æ‰“å°å„ä¸ªè™šæ‹Ÿåœ°å€çš„å€¼ï¼š</p><pre class="line-numbers language-none"><code class="language-none">(gdb) p *0x0$7 &#x3D; -335146751(gdb) p *0x1000$8 &#x3D; 72(gdb) p *0x5000Cannot access memory at address 0x5000(gdb) p *0xFFFFE000Cannot access memory at address 0xffffe000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯¹ç…§æœ€å¼€å§‹çš„ <code>print_pgtbl</code> çš„æ‰“å°ç»“æœï¼ˆå…³æ³¨å…¶æƒé™ä½ï¼‰ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬èƒ½æ­£ç¡®æ‰“å° <code>0x0</code> å’Œ <code>0x1000</code> ï¼Œå®ƒä»¬æ˜¯ç”¨æˆ·å†…å­˜ã€å¯è¯»ã€åˆæ³•çš„è™šæ‹Ÿåœ°å€çš„å†…å®¹ã€‚è€Œ <code>0x5000</code> æ˜¯ä¸åˆæ³•çš„åœ°å€æ‰€ä»¥æ— æ³•æ‰“å°ï¼Œ<code>0xFFFFE000</code> æ˜¯éç”¨æˆ·å†…å­˜ï¼ˆå†…æ ¸å†…å­˜ï¼‰æ‰€ä»¥æ— æ³•æ‰“å°ã€‚</p><h1 id="Speed-up-system-calls"><a href="#Speed-up-system-calls" class="headerlink" title="Speed up system calls"></a>Speed up system calls</h1><p>è¿™é“é¢˜è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç‰¹æ®Šçš„å†…å­˜é¡µå¹¶æŠŠè¿›ç¨‹ pid å­˜å‚¨åœ¨é‡Œé¢ï¼Œè¿™æ ·æˆ‘ä»¬åœ¨è·å– pid æ—¶å°±ä¸å¿…åšç³»ç»Ÿè°ƒç”¨ <code>getpid</code>ï¼Œè€Œæ˜¯å¯ä»¥ç›´æ¥è°ƒç”¨ <code>ugetpid</code>ï¼Œä»è€Œæ— éœ€é™·å…¥å†…æ ¸ä»¥æé«˜æ•ˆç‡ã€‚</p><p>æç¤ºé‡Œè¯´æˆ‘ä»¬åˆ›å»ºçš„è¿™ä¸ªé¡µé¢ä¼šå’Œ <code>trapframe</code> æœ‰å¾ˆå¤šç›¸ä¼¼ä¹‹å¤„â€”â€”å®ƒä»¬éƒ½åœ¨è¿›ç¨‹åˆå§‹åŒ–æ—¶è‡ªåŠ¨åˆ›å»ºï¼Œåœ¨è¿›ç¨‹é€€å‡ºæ—¶è‡ªåŠ¨é‡Šæ”¾ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥å®Œæˆä»»åŠ¡ï¼š</p><ol><li>å®šä¹‰ <code>usyscall</code>ï¼šåœ¨ <code>struct proc</code> é‡Œæ·»åŠ  <code>struct usyscall *usyscall</code></li><li><p>è¿›ç¨‹åˆå§‹åŒ–æ—¶åˆ›å»ºé¡µé¢ï¼šé˜…è¯» <code>fork</code> çš„ä»£ç å¯ä»¥çŸ¥é“æˆ‘ä»¬è°ƒç”¨ <code>allocproc</code> ä»¥åˆ›å»ºè¿›ç¨‹ã€‚</p><p> åœ¨ <code>allocproc</code> é‡Œï¼Œæˆ‘ä»¬ç”¨ <code>kalloc</code> ç»™ <code>trapframe</code> åˆ†é…äº†ä¸€ä¸ªç‰©ç†é¡µï¼Œç„¶åè°ƒç”¨ <code>proc_pagetable</code> æ¥åšé¡µè¡¨æ˜ å°„ã€‚</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">proc</span> <span class="token operator">*</span><span class="token function">allocproc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// ...</span>    <span class="token comment">// Allocate a trapframe page.</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token operator">-></span>trapframe <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">trapframe</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">kalloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">freeproc</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// An empty user page table.</span>    p<span class="token operator">-></span>pagetable <span class="token operator">=</span> <span class="token function">proc_pagetable</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p> æ‰€ä»¥ç…§è‘«èŠ¦ç”»ç“¢å°±è¡Œï¼Œå…ˆåœ¨ <code>allocproc</code> é‡ŒåŠ å…¥ç»™ <code>usyscall</code> åˆ†é…ç‰©ç†é¡µçš„ä»£ç ï¼ˆè®°å¾—æŠŠ <code>pid</code> å­˜è¿›å»ï¼‰ï¼š</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// Allocate a usyscall page</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token operator">-></span>usyscall <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">usyscall</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">kalloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">freeproc</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>p<span class="token operator">-></span>usyscall<span class="token operator">-></span>pid <span class="token operator">=</span> p<span class="token operator">-></span>pid<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p> ç„¶ååœ¨ <code>proc_pagetable</code> åŠ å…¥é¡µè¡¨æ˜ å°„çš„ä»£ç ï¼š</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// map the usyscall page just below the trapframe page, for</span><span class="token comment">// data sharing between userspace and the kernel</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mappages</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> USYSCALL<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">,</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span><span class="token punctuation">(</span>p<span class="token operator">-></span>usyscall<span class="token punctuation">)</span><span class="token punctuation">,</span>             PTE_R <span class="token operator">|</span> PTE_U<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">uvmunmap</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> TRAPFRAME<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">uvmunmap</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> TRAMPOLINE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">uvmfree</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>é€€å‡ºæ—¶é‡Šæ”¾ï¼šæˆ‘ä»¬çŸ¥é“è¿›ç¨‹è°ƒç”¨ <code>exit</code> æ¥ä¸‹ç­ï¼Œä½†å…¶å®è°ƒç”¨ <code>exit</code> åè¿›ç¨‹å¹¶æ²¡æœ‰ç«‹å³é”€æ¯è‡ªèº«ï¼Œè€Œæ˜¯è¿›å…¥ ZOMBIE æ€ç­‰å¾…çˆ¶è¿›ç¨‹çš„ <code>wait</code> æ¥å›æ”¶ã€‚å…·ä½“å¯ä»¥çœ‹çœ‹ <code>proc.c</code>ï¼Œè¿™é‡Œä¸å¤šèµ˜è¿°ã€‚</p><p> æ€»ä¹‹çœ‹å‘ <code>wait</code> å‡½æ•°ï¼Œå¯ä»¥å‘ç°æˆ‘ä»¬è°ƒç”¨ <code>freeproc</code> æ¥é‡Šæ”¾è¿›ç¨‹ã€‚</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">freeproc</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">proc</span> <span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-></span>trapframe<span class="token punctuation">)</span>        <span class="token function">kfree</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token operator">-></span>trapframe<span class="token punctuation">)</span><span class="token punctuation">;</span>    p<span class="token operator">-></span>trapframe <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-></span>pagetable<span class="token punctuation">)</span>        <span class="token function">proc_freepagetable</span><span class="token punctuation">(</span>p<span class="token operator">-></span>pagetable<span class="token punctuation">,</span> p<span class="token operator">-></span>sz<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p> å¯¹ç…§ä»£ç å¯¹ <code>trapframe</code> çš„å¤„ç†ï¼Œæˆ‘ä»¬è¦åœ¨ <code>freeproc</code> é‡ŒåŠ å…¥é‡Šæ”¾ç‰©ç†é¡µçš„ä»£ç ï¼š</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-></span>usyscall<span class="token punctuation">)</span>    <span class="token function">kfree</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token operator">-></span>usyscall<span class="token punctuation">)</span><span class="token punctuation">;</span>p<span class="token operator">-></span>usyscall <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p> ç„¶åä¿®æ”¹ <code>proc_freepagetable</code> ä»¥åˆ é™¤é¡µè¡¨æ˜ å°„ï¼š</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">uvmunmap</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> USYSCALL<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ol><p>é—²ç€ä¹Ÿæ˜¯é—²ç€ï¼Œä¸å¦‚å’Œæˆ‘ä¸€èµ·çœ‹çœ‹ <code>uvmfree</code> ä¸ºä»€ä¹ˆæ²¡æœ‰è‡ªåŠ¨é‡Šæ”¾ <code>trapframe</code> å’Œ <code>usyscall</code>ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">uvmfree</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">,</span> uint64 sz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>sz <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token function">uvmunmap</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">PGROUNDUP</span><span class="token punctuation">(</span>sz<span class="token punctuation">)</span> <span class="token operator">/</span> PGSIZE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">freewalk</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™æ®µä»£ç è°ƒç”¨ <code>uvmunmap</code> æ¥é‡Šæ”¾æ‰€æœ‰åœ¨é¡µè¡¨é‡Œæœ‰è®°å½•çš„ç‰©ç†é¡µï¼Œç„¶åè°ƒç”¨ <code>freewalk</code> æ¥é‡Šæ”¾é¡µè¡¨è‡ªèº«ã€‚</p><p>è¿™é‡Œçš„ <code>uvmunmap(pagetable, 0, PGROUNDUP(sz) / PGSIZE, 1)</code> è¡¨ç¤ºé‡Šæ”¾è™šæ‹Ÿåœ°å€ä» <code>0</code> åˆ° <code>0 + PGROUNDUP(sz) / PGSIZE</code> çš„å†…å®¹ï¼Œå³é‡Šæ”¾ç”¨æˆ·å†…å­˜çš„å†…å®¹ã€‚</p><p>ä½† <code>trapframe</code> å’Œ <code>usyscall</code> ä¸æ˜¯ç”¨æˆ·å†…å­˜çš„å†…å®¹ï¼Œå®ƒä»¬è¢«å­˜æ”¾åœ¨è™šæ‹Ÿåœ°å€çš„é¡¶éƒ¨ï¼ˆåˆ†åˆ«åœ¨ TRAPFRAME å’Œ USYSCALLï¼‰ï¼Œæ‰€ä»¥å®ƒä»¬æ²¡æœ‰è¢«é‡Šæ”¾ã€‚</p><h1 id="Print-a-page-table"><a href="#Print-a-page-table" class="headerlink" title="Print a page table"></a>Print a page table</h1><p>å…ˆæ¥çœ‹çœ‹æ‰“å°ç»“æœå§ï¼š</p><pre class="line-numbers language-none"><code class="language-none">page table 0x0000000087f22000 ..0x0000000000000000: pte 0x0000000021fc7801 pa 0x0000000087f1e000 .. ..0x0000000000000000: pte 0x0000000021fc7401 pa 0x0000000087f1d000 .. .. ..0x0000000000000000: pte 0x0000000021fc7c5b pa 0x0000000087f1f000 .. .. ..0x0000000000001000: pte 0x0000000021fc701b pa 0x0000000087f1c000 .. .. ..0x0000000000002000: pte 0x0000000021fc6cd7 pa 0x0000000087f1b000 .. .. ..0x0000000000003000: pte 0x0000000021fc6807 pa 0x0000000087f1a000 .. .. ..0x0000000000004000: pte 0x0000000021fc64d7 pa 0x0000000087f19000 ..0xffffffffc0000000: pte 0x0000000021fc8401 pa 0x0000000087f21000 .. ..0xffffffffffe00000: pte 0x0000000021fc8001 pa 0x0000000087f20000 .. .. ..0xffffffffffffd000: pte 0x0000000021fd4c13 pa 0x0000000087f53000 .. .. ..0xffffffffffffe000: pte 0x0000000021fd00c7 pa 0x0000000087f40000 .. .. ..0xfffffffffffff000: pte 0x000000002000184b pa 0x0000000080006000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç»“æœæ¯” 2024 çš„ä½œä¸šæ–‡æ¡£å¤šäº†ä¸€è¡Œ</p><pre class="line-numbers language-none"><code class="language-none">.. .. ..0x0000000000000000: pte 0x0000000021fc7c5b pa 0x0000000087f1f000<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è¿™æ˜¯æ­£ç¡®è¡¨ç°ã€‚2024 çš„ä½œä¸šæ–‡æ¡£è¿™é‡Œå†™é”™äº†ï¼Œ2025 çš„ç‰ˆæœ¬å°±åŠ å…¥äº†è¿™è¡Œã€‚</p><p>å¦‚æç¤ºæ‰€è¨€ï¼Œè¿™ä¸ªå‡½æ•°å’Œ <code>freewalk</code> å¾ˆåƒï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ <code>freewalk</code>ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">freewalk</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// there are 2^9 = 512 PTEs in a page table.</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">512</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">pte_t</span> pte <span class="token operator">=</span> pagetable<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pte <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>pte <span class="token operator">&amp;</span> <span class="token punctuation">(</span>PTE_R <span class="token operator">|</span> PTE_W <span class="token operator">|</span> PTE_X<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// this PTE points to a lower-level page table.</span>            uint64 child <span class="token operator">=</span> <span class="token function">PTE2PA</span><span class="token punctuation">(</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">freewalk</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span><span class="token punctuation">)</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>            pagetable<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pte <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"freewalk: leaf"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">kfree</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>pagetable<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å®ƒéå† L0 çº§é¡µè¡¨çš„ 512 ä¸ª PTEï¼Œå¯¹æ¯ä¸ª PTEï¼Œç”¨ <code>PTE2PA(pte)</code> æ‰¾åˆ°å®ƒæŒ‡å‘çš„æ¬¡çº§é¡µè¡¨çš„ç‰©ç†åœ°å€ï¼Œç„¶åé€’å½’ã€‚å®ƒå¿½ç•¥äº†å¶å­ PTEï¼Œåœ¨æ‰“å°æ—¶æˆ‘ä»¬ä¸éœ€è¦å¿½ç•¥å¶å­ã€‚</p><p>æˆ‘ä»¬å†æ¥çœ‹çœ‹æ‰“å°ç»“æœçš„å½¢å¼</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token punctuation">.</span><span class="token punctuation">.</span> è™šæ‹Ÿåœ°å€<span class="token operator">:</span> pte PTEçš„å€¼ pa ç‰©ç†åœ°å€çš„å€¼<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å‚è€ƒ <code>freewalk</code> æˆ‘ä»¬å°±èƒ½æ‹¿åˆ° PTEï¼Œè°ƒç”¨ <code>PTE2PA</code> å°±èƒ½å¾—åˆ° <code>pa</code>ï¼Œä½†æ€ä¹ˆè·å¾—è™šæ‹Ÿåœ°å€å‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹çœ‹è™šæ‹Ÿåœ°å€çš„ç¿»è¯‘ï¼š</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab3-pagetable/addr_translation.png" alt=""></p><p>ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œå¦‚æœæŠŠ Offset ç½®é›¶ï¼Œæˆ‘ä»¬éœ€è¦ L2ã€L1ã€L0 é¡µè¡¨çš„ PTE çš„ç´¢å¼•æ¥ç¡®å®šè™šæ‹Ÿåœ°å€ã€‚ä½†æˆ‘ä»¬å½“ç„¶æœ‰åŠæ³•è·å¾—è¿™äº›ç´¢å¼•ï¼Œæˆ‘ä»¬ä¸æ˜¯åœ¨éå†é¡µè¡¨å—ï¼Œ<code>for (int i = 0; i &lt; 512; i++)</code> é‡Œçš„ <code>i</code> å°±æ˜¯æˆ‘ä»¬éœ€è¦çš„ç´¢å¼•ï¼æ‰€ä»¥å¦‚æœæˆ‘ä»¬çš„ç´¢å¼•æ˜¯ <code>i, j, k</code>ï¼Œæˆ‘ä»¬æ‰“å°çš„è™šæ‹Ÿåœ°å€å°±æ˜¯ <code>((i &lt;&lt; 30) + (j &lt;&lt; 21) + (k &lt;&lt; 12))</code></p><p>å¤§è‡´æ€è·¯å°±æ˜¯è¿™æ ·ã€‚è¿˜æœ‰ä¸€äº›å°ç»†èŠ‚ï¼š</p><ol><li>ä½œä¸šæ–‡æ¡£é‡Œåœ¨éå† L2 å’Œ L1 çº§é¡µè¡¨æ—¶ä¹Ÿæ‰“å°äº†è™šæ‹Ÿåœ°å€ï¼Œè¿™é‡Œæ‰“å°çš„åœ°å€æ˜¯æŠŠæ¬¡çº§ç´¢å¼•å½“ä½œé›¶ç®—å‡ºçš„åœ°å€ã€‚æ¯”å¦‚å¦‚æœæˆ‘ä»¬åœ¨éå† L1 é¡µè¡¨ï¼ŒL2 é¡µè¡¨çš„ç´¢å¼•æ˜¯ <code>i</code>ï¼ŒL1 é¡µè¡¨çš„ç´¢å¼•æ˜¯ <code>j</code>ï¼Œæ‰“å°çš„å°±æ˜¯ <code>((i &lt;&lt; 30) + (j &lt;&lt; 21) + (0 &lt;&lt; 12))</code></li><li>ä¸ºäº†åœ¨é€’å½’æ—¶å¾—çŸ¥ä¸Šä¸€çº§é¡µè¡¨çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬åŠ å…¥äº† <code>father_va</code> ç”¨äºè®°å½•ä¸Šä¸€çº§çš„è™šæ‹Ÿåœ°å€</li><li>ç¬¦å·æ‹“å±•ç”¨äº†ä¸€äº› tricky çš„æ€§è´¨ï¼Œåœ¨ 255 &lt;&lt; 30 é‚£è¡Œçš„æ³¨é‡Šé‡Œå†™çš„åº”è¯¥è¿˜ç®—æ¸…æ¥š</li></ol><p>æ€»ä¹‹å¯ä»¥å†™å‡ºä¸‹é¢çš„ä»£ç ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">const</span> <span class="token keyword">int</span> MAX_LEVEL <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">_vmprint_helper</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">,</span> uint64 father_va<span class="token punctuation">,</span> <span class="token keyword">int</span> level<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// there are 2^9 = 512 PTEs in a page table.</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">512</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">pte_t</span> pte <span class="token operator">=</span> pagetable<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pte <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> level<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> MAX_LEVEL<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">" .."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">// 255 &lt;&lt; 30 is automatically sign extended to 0xffffffffc0000000</span>            uint64 va <span class="token operator">=</span> father_va <span class="token operator">+</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">12</span> <span class="token operator">+</span> <span class="token number">9</span> <span class="token operator">*</span> level<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%p: pte %p pa %p\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>va<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>pte<span class="token punctuation">,</span>                   <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">PTE2PA</span><span class="token punctuation">(</span>pte<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// this PTE points to a lower-level page table.</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>level <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">_vmprint_helper</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span><span class="token punctuation">)</span><span class="token function">PTE2PA</span><span class="token punctuation">(</span>pte<span class="token punctuation">)</span><span class="token punctuation">,</span> va<span class="token punctuation">,</span> level <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">vmprint</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"page table %p\n"</span><span class="token punctuation">,</span> pagetable<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">_vmprint_helper</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MAX_LEVEL<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="Use-superpages"><a href="#Use-superpages" class="headerlink" title="Use superpages"></a><strong>Use superpages</strong></h1><p>è¿™é“é¢˜è®©æˆ‘ä»¬ç»™ xv6 åŠ å…¥è¶…çº§é¡µã€‚å½“ç”¨æˆ·è¯·æ±‚ä¸€å—è¶…è¿‡ 2MB çš„å†…å­˜ï¼Œæˆ‘ä»¬å°±åˆ†é…è¶…çº§é¡µè€Œéå¤§é‡çš„å°é¡µæ¥ä¼˜åŒ–æ€§èƒ½ã€‚</p><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹æ™®é€šé¡µå’Œè¶…çº§é¡µå„è‡ªæ˜¯å¦‚ä½•ç¿»è¯‘è™šæ‹Ÿåœ°å€çš„ï¼š</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab3-pagetable/regular_vs_super.png" alt=""></p><ol><li><p>æ™®é€šé¡µï¼š</p><p> æ™®é€šé¡µåœ¨ç¿»è¯‘æ—¶æŠŠè™šæ‹Ÿåœ°å€åˆ†æˆ L2, L1, L0, Offset å››ä¸ªéƒ¨åˆ†ã€‚å‰ä¸‰è€…ç”¨äºåœ¨ä¸åŒçº§åˆ«çš„é¡µè¡¨é‡Œåšåç§»æ‰¾åˆ°ä¸‹ä¸€ä¸ªé¡µçš„å¼€å¤´çš„ç‰©ç†åœ°å€ï¼ˆä¸€ä¸ª Page Directory ä¹Ÿæ˜¯ä¸€ä¸ªé¡µï¼‰ï¼ŒOffset åˆ™ç”¨äºè®¡ç®—æœ€ç»ˆçš„ç‰©ç†åœ°å€åç§»ã€‚</p><p> Sv39 è§„å®š PPN å®½åº¦ä¸º 44 ä½ï¼ŒOffset å®½åº¦ 12 ä½ï¼Œä¸€ä¸ªæ™®é€šé¡µçš„å¤§å°å°±æ˜¯ $2^{12}$ bytes = 4KB.</p><p> åœ¨æ‰¾åˆ°äº† L0 leaf åï¼Œæˆ‘ä»¬å°±èƒ½ç”¨ <code>(PPN &lt;&lt; 12) + Offest</code> æ¥è®¡ç®—è™šæ‹Ÿåœ°å€å¯¹åº”çš„ç‰©ç†åœ°å€äº†ã€‚</p></li><li><p>è¶…çº§é¡µï¼š</p><p> è¶…çº§é¡µåˆ™æŠŠè™šæ‹Ÿåœ°å€åˆ†æˆ L2, L1, Offset ä¸‰ä¸ªéƒ¨åˆ†ã€‚</p><p> Sv39 è§„å®šè¶…çº§é¡µçš„ Offset ä¸º 21 ä½ï¼Œè¿™æ˜¯æŠŠåŸæœ¬çš„ L0 å’Œ Offset åˆå¹¶æˆäº†ä¸€ä¸ª 21 ä½çš„ Offsetã€‚è¶…çº§é¡µå¤§å°å°±æ˜¯ $2^{21}$ bytes å³ 2MB.</p><p> è¶…çº§é¡µæ˜¯ 2MB å¯¹é½çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ $56 - \log (2097152) = 35$ ä½æ¥æè¿°ä¸€ä¸ªè¶…çº§é¡µçš„å¼€å¤´ï¼Œæ‰€ä»¥è¶…çº§é¡µå¯¹åº”çš„ L1 leaf å­˜å‚¨çš„ PPN çš„æœ«å°¾ 9 ä½ä¸º 0. è¿™é‡Œæœ‰ $2097152$ æ˜¯å› ä¸º 2MB = 2097152 bytes.</p><p> åœ¨æ‰¾åˆ° L1 leaf åï¼Œæˆ‘ä»¬åŒæ ·ç”¨ <code>(PPN &lt;&lt; 12) + Offest</code> æ¥è®¡ç®—è™šæ‹Ÿåœ°å€å¯¹åº”çš„ç‰©ç†åœ°å€ã€‚</p></li></ol><h2 id="æµ‹è¯•ä»£ç "><a href="#æµ‹è¯•ä»£ç " class="headerlink" title="æµ‹è¯•ä»£ç "></a>æµ‹è¯•ä»£ç </h2><p>éµå¾ªæç¤ºï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ <code>superpg_test</code> åšäº†ä»€ä¹ˆã€‚è¦è¯´æ˜çš„æ˜¯ï¼Œ2024 ç‰ˆæœ¬çš„æµ‹è¯•ä¸å…¨é¢è€Œä¸”æœ‰ bugâ€”â€”åœ¨ <code>supercheck</code> å‡½æ•°çš„æœ«å°¾çš„ for å¾ªç¯é‡Œï¼Œæ¡ä»¶åº”è¯¥æ˜¯ <code>i &lt; 512 * PGSIZE</code> è€Œé <code>i &lt; 512</code>ï¼Œåº”è¯¥æ”¹æˆä¸‹é¢è¿™æ ·ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// check whether different va are mapped to different pa</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">512</span> <span class="token operator">*</span> PGSIZE<span class="token punctuation">;</span> i <span class="token operator">+=</span> PGSIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>s <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> i<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">512</span> <span class="token operator">*</span> PGSIZE<span class="token punctuation">;</span> i <span class="token operator">+=</span> PGSIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>s <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">!=</span> i<span class="token punctuation">)</span>        <span class="token function">err</span><span class="token punctuation">(</span><span class="token string">"wrong value"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ€»ä¹‹æˆ‘ä»¬ä¸‹é¢åˆ†æ 2025 ç‰ˆæœ¬çš„æµ‹è¯•ã€‚2025 ç‰ˆæœ¬çš„æµ‹è¯•å…±åŒ…æ‹¬ <code>supercheck</code>ã€<code>superpg_fork</code> å’Œ <code>superpg_free</code> ä¸‰ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨ <code>supercheck</code>ã€‚<code>supercheck</code> åˆ¤æ–­ä» <code>end</code> ä¹‹åç¬¬ä¸€ä¸ªå¯¹é½è¶…çº§é¡µçš„åœ°å€å¼€å§‹æ˜¯å¦æ˜¯è¶…çº§é¡µï¼Œå…·ä½“çš„åˆ¤æ–­æ–¹æ³•å¯ä»¥å‚è€ƒä¸‹é¢çš„æ³¨é‡Šï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">supercheck</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>end<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">pte_t</span> last_pte <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    uint64 a <span class="token operator">=</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>end<span class="token punctuation">;</span>    uint64 s <span class="token operator">=</span> <span class="token function">SUPERPGROUNDUP</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// Check that virtual address up to the next superpage boundary are mapped to PTE</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> a <span class="token operator">&lt;</span> s<span class="token punctuation">;</span> a <span class="token operator">+=</span> PGSIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">pte_t</span> pte <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">pte_t</span><span class="token punctuation">)</span><span class="token function">pgpte</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pte <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">err</span><span class="token punctuation">(</span><span class="token string">"no pte"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// Check that all virtual address in the superpage share the same valid PTE</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>uint64 p <span class="token operator">=</span> s<span class="token punctuation">;</span> p <span class="token operator">&lt;</span> s <span class="token operator">+</span> <span class="token number">512</span> <span class="token operator">*</span> PGSIZE<span class="token punctuation">;</span> p <span class="token operator">+=</span> PGSIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">pte_t</span> pte <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">pte_t</span><span class="token punctuation">)</span><span class="token function">pgpte</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pte <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token function">err</span><span class="token punctuation">(</span><span class="token string">"no pte"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>last_pte <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> pte <span class="token operator">!=</span> last_pte<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">err</span><span class="token punctuation">(</span><span class="token string">"pte different"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pte <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span>pte <span class="token operator">&amp;</span> PTE_R<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span>pte <span class="token operator">&amp;</span> PTE_W<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">err</span><span class="token punctuation">(</span><span class="token string">"pte wrong"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        last_pte <span class="token operator">=</span> pte<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// Check that different va are mapped to different pa</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">512</span> <span class="token operator">*</span> PGSIZE<span class="token punctuation">;</span> i <span class="token operator">+=</span> PGSIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>s <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">512</span> <span class="token operator">*</span> PGSIZE<span class="token punctuation">;</span> i <span class="token operator">+=</span> PGSIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>s <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">!=</span> i<span class="token punctuation">)</span>            <span class="token function">err</span><span class="token punctuation">(</span><span class="token string">"wrong value"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶åæˆ‘ä»¬ç®€è¦æä¸€ä¸‹å¦å¤–ä¸¤ä¸ªå‡½æ•°çš„ä½œç”¨ï¼š</p><ol><li><code>superpg_fork</code> æ£€æŸ¥è¶…çº§é¡µåœ¨ <code>fork</code> åæ˜¯å¦è¢«æ­£ç¡®å¤åˆ¶ä¸ºè¶…çº§é¡µã€‚</li><li><code>superpg_free</code> æ£€æŸ¥ <code>sbrk</code> èƒ½å¦æ­£ç¡®é‡Šæ”¾æ•´ä¸ªè¶…çº§é¡µï¼Œä»¥åŠèƒ½å¦åœ¨é‡Šæ”¾è¶…çº§é¡µçš„éƒ¨åˆ†å†…å­˜æ—¶å°†è¶…çº§é¡µé€€åŒ–ä¸ºå¤šä¸ªæ™®é€šé¡µï¼ˆ2024 ç‰ˆæœ¬æ²¡æµ‹è¯•è¿™ä¸€ç‚¹ï¼Œä½†è¿™ä¸ªæ˜¯å¾ˆå€¼å¾—åšçš„åŠŸèƒ½ï¼‰ã€‚</li></ol><h2 id="sbrk-è°ƒç”¨é“¾"><a href="#sbrk-è°ƒç”¨é“¾" class="headerlink" title="sbrk è°ƒç”¨é“¾"></a>sbrk è°ƒç”¨é“¾</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬åˆ†æç”¨æˆ·åœ¨è°ƒç”¨ <code>sbrk</code> æ—¶å…·ä½“è°ƒç”¨äº†å“ªäº›å‡½æ•°ã€‚è¿™åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š</p><ol><li>åˆ†é…ï¼šsys_sbrk-&gt;growproc-&gt;uvmalloc -&gt; kalloc/kfree</li><li>é‡Šæ”¾ï¼šsys_sbrk -&gt; growproc -&gt; uvmdealloc -&gt; uvmunmap</li></ol><p>è¦æ³¨æ„çš„æ˜¯å½“åˆ†é…å†…å­˜å‡ºé”™æ—¶ï¼Œ<code>uvmalloc</code> ä¹Ÿä¼šè°ƒç”¨ <code>uvmdealloc</code>ã€‚</p><p>æˆ‘ä»¬ä»æœ€åº•å±‚å‡ºå‘ï¼Œå…ˆåœ¨ kalloc.c é‡Œå®Œæˆå¯¹è¶…çº§é¡µçš„æ”¯æŒã€‚è¿™åŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤ï¼š</p><ol><li><p>æ·»åŠ ä¸€ä¸ªè¶…çº§é¡µé“¾è¡¨</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">spinlock</span> lock<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">run</span> <span class="token operator">*</span>superlist<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">run</span> <span class="token operator">*</span>freelist<span class="token punctuation">;</span><span class="token punctuation">&#125;</span> kmem<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>åœ¨åˆå§‹åŒ–ä»£ç é‡Œåˆå§‹åŒ–è¿™ä¸ªè¶…çº§é¡µé“¾è¡¨</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">const</span> <span class="token keyword">int</span> MAX_SUPER <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">freerange</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>pa_start<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>pa_end<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>    p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">PGROUNDUP</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>pa_start<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> sz<span class="token punctuation">;</span>    <span class="token keyword">int</span> super_cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> p <span class="token operator">+</span> PGSIZE <span class="token operator">&lt;=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa_end<span class="token punctuation">;</span> p <span class="token operator">+=</span> sz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>super_cnt <span class="token operator">&lt;</span> MAX_SUPER <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>p <span class="token operator">%</span> SUPERPGSIZE <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>            p <span class="token operator">+</span> SUPERPGSIZE <span class="token operator">&lt;=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa_end<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            sz <span class="token operator">=</span> SUPERPGSIZE<span class="token punctuation">;</span>            <span class="token function">superfree</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>            super_cnt <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            sz <span class="token operator">=</span> PGSIZE<span class="token punctuation">;</span>            <span class="token function">kfree</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>æ·»åŠ  superalloc å’Œ superfree å‡½æ•°ï¼ˆç…§æŠ„ kalloc å’Œ kfreeï¼‰ï¼š</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">superalloc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">run</span> <span class="token operator">*</span>r<span class="token punctuation">;</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmem<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    r <span class="token operator">=</span> kmem<span class="token punctuation">.</span>superlist<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">)</span>        kmem<span class="token punctuation">.</span>superlist <span class="token operator">=</span> r<span class="token operator">-></span>next<span class="token punctuation">;</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmem<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">)</span>        <span class="token function">memset</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>r<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> SUPERPGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// fill with junk</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>r<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">superfree</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>pa<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">run</span> <span class="token operator">*</span>r<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>pa <span class="token operator">%</span> SUPERPGSIZE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa <span class="token operator">&lt;</span> end <span class="token operator">||</span>        <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>pa <span class="token operator">>=</span> PHYSTOP<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"superfree"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// Fill with junk to catch dangling refs.</span>    <span class="token function">memset</span><span class="token punctuation">(</span>pa<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> SUPERPGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>    r <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">run</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa<span class="token punctuation">;</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmem<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    r<span class="token operator">-></span>next <span class="token operator">=</span> kmem<span class="token punctuation">.</span>superlist<span class="token punctuation">;</span>    kmem<span class="token punctuation">.</span>superlist <span class="token operator">=</span> r<span class="token punctuation">;</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmem<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><p>è‡³æ­¤ï¼Œæœ€åº•å±‚çš„å·¥ä½œå°±åšå®Œäº†ã€‚</p><h2 id="åˆ†é…å†…å­˜"><a href="#åˆ†é…å†…å­˜" class="headerlink" title="åˆ†é…å†…å­˜"></a>åˆ†é…å†…å­˜</h2><p>å›é¡¾å†…å­˜åˆ†é…çš„è°ƒç”¨é“¾ï¼šsys_sbrk-&gt;growproc-&gt;uvmalloc -&gt; kalloc/kfreeï¼Œåœ¨å¼€å§‹ç¼–å†™ä»£ç ä¹‹å‰æˆ‘ä»¬å…ˆåˆ†æä¸€ä¸‹æ¯ä¸€å±‚çš„èŒè´£ã€‚</p><ol><li>sys_sbrk æ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œè´Ÿè´£ç³»ç»Ÿå’Œç”¨æˆ·çš„äº¤äº’</li><li>grow_proc æ˜¯è¿›ç¨‹æŠ½è±¡çš„ä¸€ä¸ªæ¥å£ï¼Œè´Ÿè´£ç®¡ç†è¿›ç¨‹çŠ¶æ€</li><li>uvmalloc æ˜¯è™šæ‹Ÿå†…å­˜å±‚ï¼Œè´Ÿè´£ç®¡ç†è¿›ç¨‹çœ¼ä¸­çš„â€œå†…å­˜â€ï¼Œç®¡ç†è™šæ‹Ÿåˆ°ç‰©ç†çš„æ˜ å°„</li><li>kalloc å’Œ kfree åˆ™æ˜¯ç‰©ç†å†…å­˜å±‚ï¼Œç®¡ç†ç‰©ç†å†…å­˜</li></ol><p>æˆ‘ä»¬åœ¨è¿™é‡Œè¦ä¿®æ”¹çš„æ˜¯ uvmalloc. ç®€å•è¯»ä¸‹å®ƒåŸæœ¬çš„ä»£ç å¯ä»¥å‘ç°å®ƒä¸»è¦è°ƒç”¨çš„æ˜¯ kalloc å’Œ mappages. åœ¨è¶…çº§é¡µä¸­ï¼Œå‰è€…å¯¹åº” superallocï¼Œè€Œå¯¹åè€…æˆ‘è‡ªå·±å†™äº†ä¸€ä¸ª mapsuperpages ä½œä¸ºå¯¹åº”ã€‚ä¸ºäº†è®© mapsuperpages è·‘èµ·æ¥ï¼Œæˆ‘è¿˜å†™äº†ä¸ª l1walk å‡½æ•°ç”¨äºæ‰¾åˆ°ä¸€ä¸ªè™šæ‹Ÿåœ°å€å¯¹åº”çš„ L1 PTE. å…ˆæ¥çœ‹çœ‹ l1walkï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">pte_t</span> <span class="token operator">*</span><span class="token function">l1walk</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">,</span> uint64 va<span class="token punctuation">,</span> <span class="token keyword">int</span> alloc<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>va <span class="token operator">>=</span> MAXVA<span class="token punctuation">)</span>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"walk"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">pte_t</span> <span class="token operator">*</span>pte <span class="token operator">=</span> <span class="token operator">&amp;</span>pagetable<span class="token punctuation">[</span><span class="token function">PX</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> va<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        pagetable <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">pagetable_t</span><span class="token punctuation">)</span><span class="token function">PTE2PA</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">&amp;</span>pagetable<span class="token punctuation">[</span><span class="token function">PX</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> va<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>alloc <span class="token operator">||</span> <span class="token punctuation">(</span>pagetable <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">pde_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">kalloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">memset</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">*</span>pte <span class="token operator">=</span> <span class="token function">PA2PTE</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">)</span> <span class="token operator">|</span> PTE_V<span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">&amp;</span>pagetable<span class="token punctuation">[</span><span class="token function">PX</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> va<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å®ƒå’Œ walk å‡½æ•°åŸºæœ¬ä¸€è‡´ï¼Œä¸è¿‡ walk æ˜¯è¿”å› leafï¼Œè€Œè¿™é‡Œçš„ l1walk è¿”å› L1 PTE.</p><p>ç„¶åçœ‹çœ‹ mapsuperpagesï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">mapsuperpages</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">,</span> uint64 va<span class="token punctuation">,</span> uint64 size<span class="token punctuation">,</span> uint64 pa<span class="token punctuation">,</span>                  <span class="token keyword">int</span> perm<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    uint64 a<span class="token punctuation">,</span> last<span class="token punctuation">;</span>    <span class="token class-name">pte_t</span> <span class="token operator">*</span>pte<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>va <span class="token operator">%</span> SUPERPGSIZE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"mapsuperpages: va not aligned"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>size <span class="token operator">%</span> SUPERPGSIZE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"mapsuperpages: size not aligned"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"mapsuperpages: size"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    a <span class="token operator">=</span> va<span class="token punctuation">;</span>    last <span class="token operator">=</span> va <span class="token operator">+</span> size <span class="token operator">-</span> SUPERPGSIZE<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pte <span class="token operator">=</span> <span class="token function">l1walk</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"mapsuperpages: l1walk failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span>            <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"mapsuperpages: remap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">*</span>pte <span class="token operator">=</span> <span class="token function">PA2PTE</span><span class="token punctuation">(</span>pa<span class="token punctuation">)</span> <span class="token operator">|</span> perm <span class="token operator">|</span> PTE_V <span class="token operator">|</span> PTE_R<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">==</span> last<span class="token punctuation">)</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        a <span class="token operator">+=</span> SUPERPGSIZE<span class="token punctuation">;</span>        pa <span class="token operator">+=</span> SUPERPGSIZE<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™åŸºæœ¬æ˜¯ç…§æŠ„ mappagesï¼Œåªæ˜¯æŠŠæ™®é€šé¡µæ”¹æˆäº†è¶…çº§é¡µã€‚</p><p>æœ€åçœ‹çœ‹æˆ‘ä»¬å¯¹ uvmalloc çš„ä¿®æ”¹ã€‚uvmalloc ä¸»è¦åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œç¬¬ä¸€éƒ¨åˆ†æ˜¯ç”¨ kalloc/superalloc è¯·æ±‚ç‰©ç†å†…å­˜ï¼Œç¬¬äºŒéƒ¨åˆ†æ˜¯ç”¨ mappages/mapsuperpages æŠŠè™šæ‹Ÿå†…å­˜æ˜ å°„åˆ°ç‰©ç†å†…å­˜ä¸Šã€‚</p><p>æˆ‘ä»¬åœ¨æ³¨é‡Šé‡Œæ ‡å‡ºäº†ä¿®æ”¹çš„åœ°æ–¹ï¼Œä¿®æ”¹ 1 å¯¹åº”è¯·æ±‚ç‰©ç†å†…å­˜çš„ç¬¬ä¸€éƒ¨åˆ†ï¼Œä¿®æ”¹ 2 å¯¹åº”åšæ˜ å°„çš„ç¬¬äºŒéƒ¨åˆ†ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">uint64 <span class="token function">uvmalloc</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">,</span> uint64 oldsz<span class="token punctuation">,</span> uint64 newsz<span class="token punctuation">,</span> <span class="token keyword">int</span> xperm<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>mem<span class="token punctuation">;</span>    uint64 a<span class="token punctuation">;</span>    <span class="token keyword">int</span> sz<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>newsz <span class="token operator">&lt;</span> oldsz<span class="token punctuation">)</span>        <span class="token keyword">return</span> oldsz<span class="token punctuation">;</span>    oldsz <span class="token operator">=</span> <span class="token function">PGROUNDUP</span><span class="token punctuation">(</span>oldsz<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>a <span class="token operator">=</span> oldsz<span class="token punctuation">;</span> a <span class="token operator">&lt;</span> newsz<span class="token punctuation">;</span> a <span class="token operator">+=</span> sz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// ä¿®æ”¹1ä»è¿™é‡Œå¼€å§‹</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">%</span> SUPERPGSIZE <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> a <span class="token operator">+</span> SUPERPGSIZE <span class="token operator">&lt;=</span> newsz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            sz <span class="token operator">=</span> SUPERPGSIZE<span class="token punctuation">;</span>            mem <span class="token operator">=</span> <span class="token function">superalloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// If no superpages, use regular pages</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>mem <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                sz <span class="token operator">=</span> PGSIZE<span class="token punctuation">;</span>                mem <span class="token operator">=</span> <span class="token function">kalloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            sz <span class="token operator">=</span> PGSIZE<span class="token punctuation">;</span>            mem <span class="token operator">=</span> <span class="token function">kalloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// ä¿®æ”¹1åˆ°è¿™é‡Œç»“æŸ</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mem <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">uvmdealloc</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> a<span class="token punctuation">,</span> oldsz<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">LAB_SYSCALL</span></span>        <span class="token function">memset</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sz<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>        <span class="token comment">// ä¿®æ”¹2ä»è¿™é‡Œå¼€å§‹</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>sz <span class="token operator">==</span> PGSIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mappages</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> a<span class="token punctuation">,</span> sz<span class="token punctuation">,</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>mem<span class="token punctuation">,</span>                         PTE_R <span class="token operator">|</span> PTE_U <span class="token operator">|</span> xperm<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">kfree</span><span class="token punctuation">(</span>mem<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">uvmdealloc</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> a<span class="token punctuation">,</span> oldsz<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mapsuperpages</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> a<span class="token punctuation">,</span> sz<span class="token punctuation">,</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>mem<span class="token punctuation">,</span>                              PTE_R <span class="token operator">|</span> PTE_U <span class="token operator">|</span> xperm<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">superfree</span><span class="token punctuation">(</span>mem<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">uvmdealloc</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> a<span class="token punctuation">,</span> oldsz<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// ä¿®æ”¹2åˆ°è¿™é‡Œç»“æŸ</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> newsz<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="é‡Šæ”¾å†…å­˜"><a href="#é‡Šæ”¾å†…å­˜" class="headerlink" title="é‡Šæ”¾å†…å­˜"></a>é‡Šæ”¾å†…å­˜</h2><p>åœ¨å®Œæˆäº†åˆ†é…å†…å­˜çš„å·¥ä½œåï¼Œæˆ‘ä»¬å°±èƒ½å†™é‡Šæ”¾å†…å­˜ç›¸å…³çš„ä»£ç äº†ã€‚</p><p>å›é¡¾è°ƒç”¨é“¾ï¼šsys_sbrk -&gt; growproc -&gt; uvmdealloc -&gt; uvmunmapï¼Œæˆ‘ä»¬è¦ä¿®æ”¹ uvmunmap. è¿™éƒ¨åˆ†ä»£ç æ¯”è¾ƒæ£˜æ‰‹ã€‚å®ƒåŸæœ¬åªæ˜¯åœ¨æŒ‰éƒ¨å°±ç­åœ°åˆ æ‰é¡µè¡¨é‡Œä» va å‡ºå‘çš„ npages ä¸ªç‰©ç†é¡µçš„æ˜ å°„ï¼Œå¹¶é€‰æ‹©æ€§é‡Šæ”¾ç‰©ç†å†…å­˜ï¼Œä½†åœ¨åŠ å…¥è¶…çº§é¡µåå®ƒéœ€è¦å®Œæˆè¿™äº›å·¥ä½œï¼š</p><ol><li>è®© <code>uint64 a</code> ä» <code>va</code> å‡ºå‘ï¼Œå¦‚æœé‡åˆ°äº†æ™®é€šé¡µï¼Œèµ°æ™®é€šé¡µçš„ unmap æµç¨‹ï¼Œç„¶å <code>a += PGSIZE</code></li><li>å¦‚æœé‡åˆ°äº†è¶…çº§é¡µï¼Œåˆ¤æ–­ <code>a</code> æ˜¯è¶…çº§é¡µçš„å¼€å¤´è¿˜æ˜¯è¶…çº§é¡µçš„ä¸­é—´<ol><li>å¦‚æœæ˜¯è¶…çº§é¡µçš„å¼€å¤´ï¼Œèµ°è¶…çº§é¡µçš„ unmap æµç¨‹ï¼ˆå’Œæ™®é€šé¡µ unmap åŸºæœ¬ä¸€è‡´ï¼‰ï¼Œç„¶å <code>a += SUPERPGSIZE</code></li><li>å¦‚æœæ˜¯è¶…çº§é¡µçš„ä¸­é—´ï¼ŒæŠŠè¶…çº§é¡µé€€åŒ–æˆè‹¥å¹²ä¸ªæ™®é€šé¡µï¼Œå†èµ°æ™®é€šé¡µé‡Šæ”¾æµç¨‹ï¼Œç„¶å <code>a += PGSIZE</code></li></ol></li></ol><p>è¿™é‡Œä¸»è¦æ˜¯ä¸Šé¢æ­¥éª¤ä¸­çš„ 2b çš„â€œé€€åŒ–â€æ¯”è¾ƒæ£˜æ‰‹ï¼Œæˆ‘æ˜¯æŠŠé¡µè¡¨é‡Œå¯¹åº”è¶…çº§é¡µçš„ L1 leaf è®¾ç½®æˆäº† invalidï¼Œç„¶åæŠŠè¶…çº§é¡µè§†ä½œå¤šä¸ªæ™®é€šé¡µçš„åˆå¹¶ï¼Œä»è¶…çº§é¡µçš„å¼€å¤´å‡ºå‘åšè‹¥å¹²æ¬¡ mappages ä»è€Œå®Œæˆé€€åŒ–ã€‚æ€è·¯å¯ä»¥å‚è€ƒä¸‹å›¾ï¼š</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab3-pagetable/super_demote.png" alt=""></p><p>è¿™é‡Œæ˜¯é€€åŒ–éƒ¨åˆ†çš„ä»£ç ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> perm <span class="token operator">=</span> <span class="token function">PTE_FLAGS</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>uint64 super_va_st <span class="token operator">=</span> <span class="token function">SUPERPGROUNDDOWN</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>uint64 super_pa_st <span class="token operator">=</span> <span class="token function">PTE2PA</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span>pte <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// Make pte invalid to make `mappages` work</span><span class="token keyword">for</span> <span class="token punctuation">(</span>uint64 super_va <span class="token operator">=</span> super_va_st<span class="token punctuation">,</span> super_pa <span class="token operator">=</span> super_pa_st<span class="token punctuation">;</span>     super_va <span class="token operator">&lt;</span> super_va_st <span class="token operator">+</span> SUPERPGSIZE<span class="token punctuation">;</span>     super_va <span class="token operator">+=</span> PGSIZE<span class="token punctuation">,</span> super_pa <span class="token operator">+=</span> PGSIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mappages</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> super_va<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">,</span> super_pa<span class="token punctuation">,</span> perm<span class="token punctuation">)</span> <span class="token operator">!=</span>        <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmunmap: mappages failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å½“ç„¶è¿™æ ·çš„é€€åŒ–æœ‰ä¸€ä¸ªæ½œåœ¨é£é™©â€”â€”æ¯ä¸ªè¿›ç¨‹çš„è¶…çº§é¡µä¸Šé™åœ¨è¿›ç¨‹å¯åŠ¨æ—¶å°±å†³å®šäº†ï¼Œæˆ‘ä»¬çš„é€€åŒ–ä¼šè®©æœ¬è¿›ç¨‹çš„è¶…çº§é¡µä¸Šé™å‡ä¸€ã€‚å¦‚æœæœ‰ä»€ä¹ˆè‡ªåŠ¨åˆå¹¶æ™®é€šé¡µä¸ºè¶…çº§é¡µçš„åŠŸèƒ½å°±å¥½äº†â€¦</p><p>å¦å¤–ï¼Œæˆ‘çš„ä»£ç æŠŠä¹‹å‰æ­¥éª¤é‡Œæè¿°çš„ 1 å’Œ 2b æ•´åˆäº†ä¸€ä¸‹ï¼ˆæ¯•ç«Ÿå®ƒä»¬æœ€åéƒ½èµ°çš„æ˜¯æ™®é€šé¡µé‡Šæ”¾æµç¨‹ï¼‰ï¼Œæ€»ä¹‹è¿™é‡Œæ˜¯å®Œæ•´ä»£ç ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">uvmunmap</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">,</span> uint64 va<span class="token punctuation">,</span> uint64 npages<span class="token punctuation">,</span> <span class="token keyword">int</span> do_free<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    uint64 a<span class="token punctuation">;</span>    <span class="token class-name">pte_t</span> <span class="token operator">*</span>pte<span class="token punctuation">;</span>    <span class="token keyword">int</span> sz<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>va <span class="token operator">%</span> PGSIZE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmunmap: not aligned"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>a <span class="token operator">=</span> va<span class="token punctuation">;</span> a <span class="token operator">&lt;</span> va <span class="token operator">+</span> npages <span class="token operator">*</span> PGSIZE<span class="token punctuation">;</span> a <span class="token operator">+=</span> sz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// If `a` corresponds to a superpage and the superpage starts at `a`,</span>        <span class="token comment">// free the superpage</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pte <span class="token operator">=</span> <span class="token function">l1walk</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">PTE_LEAF</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>            a <span class="token operator">%</span> SUPERPGSIZE <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            sz <span class="token operator">=</span> SUPERPGSIZE<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"va=%ld pte=%ld\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmunmap: not mapped"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>do_free<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                uint64 pa <span class="token operator">=</span> <span class="token function">PTE2PA</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">superfree</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token operator">*</span>pte <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            sz <span class="token operator">=</span> PGSIZE<span class="token punctuation">;</span>            <span class="token comment">// If `a` corresponds to a superpage but the superpage doesn't</span>            <span class="token comment">// start at `a`, demote the superpage into regular pages</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>pte <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">PTE_LEAF</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// Potential issue:</span>                <span class="token comment">// Each process has a max number of superpages defined as</span>                <span class="token comment">// `MAX_SUPER`. But whenever a superpage is demoted, the</span>                <span class="token comment">// process's max number of superpages permanently minus one,</span>                <span class="token comment">// since we view superpage as multiple regular pages.</span>                <span class="token comment">//</span>                <span class="token comment">// A possible solution is to kalloc multiple regular pages,</span>                <span class="token comment">// copy memory into them, and superfree the superpage.</span>                <span class="token keyword">int</span> perm <span class="token operator">=</span> <span class="token function">PTE_FLAGS</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>                uint64 super_va_st <span class="token operator">=</span> <span class="token function">SUPERPGROUNDDOWN</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>                uint64 super_pa_st <span class="token operator">=</span> <span class="token function">PTE2PA</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token operator">*</span>pte <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">)</span>                       <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// Make pte invalid to make `mappages` work</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span>uint64 super_va <span class="token operator">=</span> super_va_st<span class="token punctuation">,</span> super_pa <span class="token operator">=</span> super_pa_st<span class="token punctuation">;</span>                     super_va <span class="token operator">&lt;</span> super_va_st <span class="token operator">+</span> SUPERPGSIZE<span class="token punctuation">;</span>                     super_va <span class="token operator">+=</span> PGSIZE<span class="token punctuation">,</span> super_pa <span class="token operator">+=</span> PGSIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mappages</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> super_va<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">,</span> super_pa<span class="token punctuation">,</span> perm<span class="token punctuation">)</span> <span class="token operator">!=</span>                        <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmunmap: mappages failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">&#125;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">// Free the regular page that begins at `a`</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pte <span class="token operator">=</span> <span class="token function">walk</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>                <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmunmap: walk"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"va=%ld pte=%ld\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmunmap: not mapped"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PTE_FLAGS</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span> <span class="token operator">==</span> PTE_V<span class="token punctuation">)</span>                <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmunmap: not a leaf"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>do_free<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                uint64 pa <span class="token operator">=</span> <span class="token function">PTE2PA</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">kfree</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token operator">*</span>pte <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="fork"><a href="#fork" class="headerlink" title="fork"></a>fork</h2><p>æœ€è‰°éš¾çš„å·¥ä½œå·²ç»åšå®Œäº†ï¼Œæˆ‘ä»¬åªè¦ä¿®æ”¹ uvmcopy å°±èƒ½ä¸‹ç­äº†ï¼è¿™é‡Œçš„ä¿®æ”¹åªæ˜¯åŠ å…¥ä¸€ä¸ªç®€å•çš„åˆ†ç±»ï¼Œåœ¨é‡åˆ°æ™®é€šé¡µæ—¶èµ°æ™®é€šæµç¨‹ï¼Œé‡åˆ°è¶…çº§é¡µæ—¶èµ°è¶…çº§æµç¨‹ã€‚å’±å°±ç›´æ¥æ”¾ä»£ç äº†ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">uvmcopy</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> old<span class="token punctuation">,</span> <span class="token class-name">pagetable_t</span> new<span class="token punctuation">,</span> uint64 sz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">pte_t</span> <span class="token operator">*</span>pte<span class="token punctuation">;</span>    uint64 pa<span class="token punctuation">,</span> i<span class="token punctuation">;</span>    uint flags<span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>mem<span class="token punctuation">;</span>    <span class="token keyword">int</span> szinc<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> sz<span class="token punctuation">;</span> i <span class="token operator">+=</span> szinc<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// super page case</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pte <span class="token operator">=</span> <span class="token function">l1walk</span><span class="token punctuation">(</span>old<span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">PTE_LEAF</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            szinc <span class="token operator">=</span> SUPERPGSIZE<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>                <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmcopy: page not present"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            pa <span class="token operator">=</span> <span class="token function">PTE2PA</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>            flags <span class="token operator">=</span> <span class="token function">PTE_FLAGS</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mem <span class="token operator">=</span> <span class="token function">superalloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>                <span class="token keyword">goto</span> err<span class="token punctuation">;</span>            <span class="token function">memmove</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa<span class="token punctuation">,</span> SUPERPGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mapsuperpages</span><span class="token punctuation">(</span>new<span class="token punctuation">,</span> i<span class="token punctuation">,</span> SUPERPGSIZE<span class="token punctuation">,</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>mem<span class="token punctuation">,</span> flags<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">superfree</span><span class="token punctuation">(</span>mem<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">goto</span> err<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// regular page case</span>        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            szinc <span class="token operator">=</span> PGSIZE<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pte <span class="token operator">=</span> <span class="token function">walk</span><span class="token punctuation">(</span>old<span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>                <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmcopy: pte should exist"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>                <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmcopy: page not present"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            pa <span class="token operator">=</span> <span class="token function">PTE2PA</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>            flags <span class="token operator">=</span> <span class="token function">PTE_FLAGS</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mem <span class="token operator">=</span> <span class="token function">kalloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>                <span class="token keyword">goto</span> err<span class="token punctuation">;</span>            <span class="token function">memmove</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mappages</span><span class="token punctuation">(</span>new<span class="token punctuation">,</span> i<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">,</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>mem<span class="token punctuation">,</span> flags<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">kfree</span><span class="token punctuation">(</span>mem<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">goto</span> err<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>err<span class="token operator">:</span>    <span class="token function">uvmunmap</span><span class="token punctuation">(</span>new<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> i <span class="token operator">/</span> PGSIZE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Inspect-a-user-process-page-table&quot;&gt;&lt;a href=&quot;#Inspect-a-user-process-page-table&quot; class=&quot;headerlink&quot; title=&quot;Inspect a user-process pag</summary>
      
    
    
    
    <category term="å…¬å¼€è¯¾" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/"/>
    
    <category term="MIT-6.S081" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/MIT-6-S081/"/>
    
    <category term="Labs" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/MIT-6-S081/Labs/"/>
    
    
  </entry>
  
  <entry>
    <title>æ¢ç´¢æ—¥å¿—[3]</title>
    <link href="http://rinevard.github.io/wiki/others/thoughts/%E6%8E%A2%E7%B4%A2%E6%97%A5%E5%BF%973/"/>
    <id>http://rinevard.github.io/wiki/others/thoughts/%E6%8E%A2%E7%B4%A2%E6%97%A5%E5%BF%973/</id>
    <published>2025-10-27T13:56:16.000Z</published>
    <updated>2025-10-28T02:14:10.603Z</updated>
    
    <content type="html"><![CDATA[<p>ä¹¦æ¥ä¸Šä¸Šä¸Šå›ï¼ˆæ¢ç´¢æ—¥å¿—[0]ï¼‰ï¼Œä»Šå¤©å’Œä¸Šä¸Šæ¬¡å‚åŠ  Ludum Dare Compo ç»“è¯†çš„æœ‹å‹ä¸€èµ·åƒé¥­äº†ï¼Œéš¾é“è¯´æˆ‘å°±è¦å¤±å»ç¤¾æå±æ€§å’Œå®…å±æ€§äº†å—ï¼</p><p>æ€»ä¹‹å°±æ˜¯ä»–è¿™å‡ å¤©æ¥åŒ—äº¬ç©ï¼Œæˆ‘å°±é¼“èµ·å‹‡æ°”é—®ä»–è¦ä¸è¦æ¥æ‰¾æˆ‘ç©ï¼ˆå…¶å®å¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯ä¸ºäº†æ°´ä¸€ç¯‡æ¢ç´¢æ—¥å¿—ï¼Œæ¢ç´¢æ—¥å¿—é©±åŠ¨æ¢ç´¢ï¼‰ï¼Œç„¶åä»Šå¤©å°±ä¸€èµ·åƒäº†æŠ«è¨è–¯æ¡ç‚¸é¸¡ã€‚</p><p><img src="/images/others/random_thoughts/explore3/rubatotree_food.jpg" alt="å¥½åƒçš„"></p><p>æ„Ÿè§‰è‡ªå·±å®…çš„å¾ˆå¤§åŸå› æ˜¯äº’è”ç½‘å¤ªæœ‰è¶£äº†ã€‚ä»Šå¤©ä¹Ÿæ²¡æœ‰å’Œä»–ä¸€èµ·åˆ°å¤„ç©ï¼ˆæ ¹æ®æˆ‘çš„ç»éªŒå’Œæƒ³è±¡ï¼Œäººä»¬ä¸€èˆ¬æ˜¯ä¼šåœ¨ç›¸èšæ—¶å»ä¸€äº›åœ°ç‚¹é—²é€›çš„ï¼‰ï¼Œè€Œæ˜¯åœ¨é¥­åº—è¾¹åƒé¥­è¾¹ç©æ¸¸æˆé¡ºä¾¿é—²èŠã€‚å’±è¿˜ç»™ä»–è¯•äº†è¯•æœ€è¿‘åšçš„æ–°åŸå‹ï¼ˆæ¢ç´¢æ—¥å¿—[2]ï¼Œæ„Ÿè§‰æ¢ç´¢æ—¥å¿—çš„ç›¸äº’å¼•ç”¨éƒ½å¯ä»¥å˜æˆèŠ‚ç‚¹å›¾äº†ï¼‰ï¼Œæ„Ÿè§‰è¿˜ä¸é”™ã€‚ç„¶åæˆ‘ä»¬å°±åœ¨é¥­åº—å¾…äº†ä¸¤ä¸ªå¤šå°æ—¶ï¼Œç›´åˆ°ä»–å»èµ¶é«˜é“å›å­¦æ ¡ã€‚</p><p>æˆ‘è¿˜è›®å–œæ¬¢è¿™æ ·çš„äº¤æµçš„ï¼Œæœç„¶è¿˜æ˜¯è¦ä¸»åŠ¨å»å’Œåˆ«äººç»“äº¤æ‰è¡Œã€‚å¥½è€¶ï¼Œè¿™åˆæ˜¯ä¸€ä¸ªæ°´æ¢ç´¢æ—¥å¿—çš„æœºä¼šã€‚ç­‰æˆ‘ä¸‹æ¬¡ gamejam çœ‹åˆ°å–œæ¬¢çš„æ¸¸æˆå°±å»æ‰¾ä½œè€…åŠ å¥½å‹ï¼ŒæˆåŠŸäº†å°±æ°´ä¸€ç¯‡ï¼Œå¤±è´¥äº†ä¹Ÿèƒ½æ°´ä¸€ç¯‡ã€‚å½“ç„¶ï¼Œå¦‚æœåªæ˜¯æŠŠèŒƒå›´å±€é™åœ¨æ¸¸æˆé¢†åŸŸä¹Ÿå¤ªç‹­çª„äº†ï¼Œä¸è¿‡ç­‰æˆ‘æ°´å®Œå†è¯´å§ã€‚</p><p>ä¸ºä»€ä¹ˆé…’åº—å«é…’åº—å‘¢ï¼Œå®ƒåœ¨å­—é¢ä¸Šçœ‹èµ·æ¥å¾ˆåƒé¥­åº—ï¼Œå´æ˜¯å±…ä½çš„åœ°æ–¹ã€‚æˆ‘ä¸Šç½‘æœäº†ä¸€ä¸‹ï¼ˆå¦‚æˆ‘æ‰€è¨€ï¼Œäº’è”ç½‘å¤ªæœ‰è¶£äº†ï¼‰ï¼Œè¿™æ˜¯å› ä¸ºå®ƒæ˜¯ä» â€œHotelâ€ ç¿»è¯‘è¿‡æ¥çš„ã€‚å¯¹æ¸…æœ«çš„ä¸­å›½ä¸Šå±‚ç¤¾ä¼šï¼Œâ€Hotelâ€ çš„ç¬¬ä¸€åŠŸèƒ½æ˜¯é¥®å®´ï¼Œè€Œéä½å®¿ã€‚ä¼ ç»Ÿä¸­å›½è´µäººå‡ºè¡Œéƒ½å¸¦ç€ä»†äººï¼Œæ‰€ä»¥ â€œHotelâ€ çš„å°é—´å¯¹ä»–ä»¬å¹¶ä¸æ˜¯ä½å®¿çš„åœ°æ–¹ï¼Œè€Œåªæ˜¯èšå®´çš„åœ°æ–¹ï¼Œæ‰€ä»¥è¢«ç¿»è¯‘æˆäº†â€œé…’åº—â€ã€‚</p><p>æœ‰è¶£çš„ç”Ÿæ´»å¤ªå¤šäº†ï¼Œä¸€ä¸ªäººæ˜¯ä½“éªŒä¸è¿‡æ¥çš„ï¼Œæ‰€ä»¥è¦è®¤è¯†æ›´å¤šçš„ç»å†è¿‡æœ‰è¶£ç”Ÿæ´»çš„äººï¼Œæ‰èƒ½çœ‹åˆ°æ›´å¤šæœ‰è¶£çš„ä½“éªŒã€‚</p><p>åˆæˆ–è®¸äººä»¬åªæ˜¯å› ä¸ºç¢°å·§ç›¸é‡ï¼Œæ‰ç¢°å·§è®¤è¯†äº†å½¼æ­¤å§ã€‚</p><p>å½“ç„¶è¿˜æ˜¯è¦ç‚«è€€ä¸€ä¸‹æ”¶åˆ°çš„å°å¡ç‰‡çš„ï¼</p><p><img src="/images/others/random_thoughts/explore3/rubatotree_shielded_card.jpg" alt=""></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;ä¹¦æ¥ä¸Šä¸Šä¸Šå›ï¼ˆæ¢ç´¢æ—¥å¿—[0]ï¼‰ï¼Œä»Šå¤©å’Œä¸Šä¸Šæ¬¡å‚åŠ  Ludum Dare Compo ç»“è¯†çš„æœ‹å‹ä¸€èµ·åƒé¥­äº†ï¼Œéš¾é“è¯´æˆ‘å°±è¦å¤±å»ç¤¾æå±æ€§å’Œå®…å±æ€§äº†å—ï¼&lt;/p&gt;
&lt;p&gt;æ€»ä¹‹å°±æ˜¯ä»–è¿™å‡ å¤©æ¥åŒ—äº¬ç©ï¼Œæˆ‘å°±é¼“èµ·å‹‡æ°”é—®ä»–è¦ä¸è¦æ¥æ‰¾æˆ‘ç©ï¼ˆå…¶å®å¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯ä¸ºäº†æ°´ä¸€ç¯‡æ¢ç´¢æ—¥å¿—ï¼Œæ¢ç´¢æ—¥å¿—é©±åŠ¨æ¢ç´¢ï¼‰ï¼Œ</summary>
      
    
    
    
    <category term="æ‚è°ˆ" scheme="http://rinevard.github.io/categories/%E6%9D%82%E8%B0%88/"/>
    
    <category term="ç¢ç¢å¿µ" scheme="http://rinevard.github.io/categories/%E6%9D%82%E8%B0%88/%E7%A2%8E%E7%A2%8E%E5%BF%B5/"/>
    
    
  </entry>
  
</feed>
