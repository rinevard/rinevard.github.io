<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Rinevard</title>
  
  
  <link href="http://rinevard.github.io/atom.xml" rel="self"/>
  
  <link href="http://rinevard.github.io/"/>
  <updated>2025-12-13T09:01:08.278Z</updated>
  <id>http://rinevard.github.io/</id>
  
  <author>
    <name>Rinevard</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Lab 1 Stitching substrings into a byte stream</title>
    <link href="http://rinevard.github.io/wiki/learning/open-course/CS144/labs/lab1-reassembler/"/>
    <id>http://rinevard.github.io/wiki/learning/open-course/CS144/labs/lab1-reassembler/</id>
    <published>2025-12-13T08:55:28.000Z</published>
    <updated>2025-12-13T09:01:08.278Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™ä¸ª Lab é‡Œæˆ‘ä»¬è¦æ‰‹åŠ¨æ„é€ ä¸€ä¸ª IP è¯·æ±‚ï¼Œç„¶åå†™ä¸€ä¸ªæŠŠæ— åºæ•°æ®å˜æˆæœ‰åºæ•°æ®çš„ Reassembler.</p><h2 id="Send-an-Internet-datagram-by-hand"><a href="#Send-an-Internet-datagram-by-hand" class="headerlink" title="Send an Internet datagram by hand"></a>Send an Internet datagram by hand</h2><p>Reliability from unreliability é‚£èŠ‚è¯¾çš„ notesï¼ˆLecture notes - Week 1 Day 2ï¼‰é‡Œè®°å½•äº†ä¸€æ®µç¤ºä¾‹ä»£ç ï¼Œæˆ‘ä»¬æŠŠå®ƒå¤åˆ¶åˆ° ip_raw.cc ç„¶åæ”¹æ”¹å°±èƒ½å‘åŒ…äº†ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"address.hh"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"socket.hh"</span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">auto</span> args <span class="token operator">=</span> <span class="token function">span</span><span class="token punctuation">(</span> argv<span class="token punctuation">,</span> argc <span class="token punctuation">)</span><span class="token punctuation">;</span>  string datagram<span class="token punctuation">;</span>  datagram <span class="token operator">+=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">0b0100'0101</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// version and IHL</span>  datagram <span class="token operator">+=</span> <span class="token function">string</span><span class="token punctuation">(</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// rest of first two lines</span>  datagram <span class="token operator">+=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// TTL</span>  datagram <span class="token operator">+=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// proto</span>  <span class="token comment">// checksum</span>  datagram <span class="token operator">+=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  datagram <span class="token operator">+=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// sender ip</span>  datagram <span class="token operator">+=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  datagram <span class="token operator">+=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">194</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  datagram <span class="token operator">+=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">218</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  datagram <span class="token operator">+=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">138</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// target ip</span>  datagram <span class="token operator">+=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  datagram <span class="token operator">+=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">195</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  datagram <span class="token operator">+=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">159</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  datagram <span class="token operator">+=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    string art<span class="token punctuation">;</span>  art <span class="token operator">+=</span>          <span class="token string">"                "</span><span class="token punctuation">;</span>  art <span class="token operator">+=</span>          <span class="token string">"   /\\_____/\\    "</span><span class="token punctuation">;</span>  art <span class="token operator">+=</span>          <span class="token string">"  /  o   o  \\   "</span><span class="token punctuation">;</span>  art <span class="token operator">+=</span>          <span class="token string">" ( ==  ^  == )  "</span><span class="token punctuation">;</span>  art <span class="token operator">+=</span>          <span class="token string">"  )         (   "</span><span class="token punctuation">;</span>  art <span class="token operator">+=</span>          <span class="token string">" (           )  "</span><span class="token punctuation">;</span>  art <span class="token operator">+=</span>          <span class="token string">"( (  )   (  ) ) "</span><span class="token punctuation">;</span>  art <span class="token operator">+=</span>          <span class="token string">"(__(__)___(__)_)"</span><span class="token punctuation">;</span>  art <span class="token operator">+=</span>          <span class="token string">"  Lyraine Cat!  "</span><span class="token punctuation">;</span>  art <span class="token operator">+=</span>          <span class="token string">"                "</span><span class="token punctuation">;</span>  datagram <span class="token operator">+=</span> art<span class="token punctuation">;</span>  RawSocket <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>datagram<span class="token punctuation">,</span> <span class="token function">Address</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘åœ¨ WSL ä¸Šå¯ä»¥ç”¨ä¸Šé¢çš„ä»£ç ç»™å®¤å‹çš„ç”µè„‘å‘åŒ…ï¼Œä»–èƒ½ç”¨ wireshark ç›‘å¬åˆ°åŒ…ï¼Œä¸‹å›¾æ˜¯ wireshark æˆªå›¾ï¼š</p><p><img src="/images/learning/open-course/CS144/labs/lab1/cattt.jpg"></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬åˆ†æä¸€ä¸‹è¿™æ®µä»£ç åœ¨åšä»€ä¹ˆã€‚æˆ‘ä»¬è¢«è¦æ±‚ä½¿ç”¨ Rawsocket è€ŒéåŸå§‹ socket æ¥å‘åŒ…ï¼ŒRaw Socket ä¸€èˆ¬å·¥ä½œåœ¨ç¬¬ä¸‰å±‚ç½‘ç»œå±‚ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æ‰‹åŠ¨æ„é€  IP æ•°æ®åŒ…ã€‚</p><p>æˆ‘ä»¬å›é¡¾ä¸€ä¸‹ IP header çš„ç»“æ„ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">struct</span> <span class="token class-name">ip</span> <span class="token punctuation">&#123;</span>    uint8 ip_vhl<span class="token punctuation">;</span>  <span class="token comment">// version &lt;&lt; 4 | header length >> 2</span>    uint8 ip_tos<span class="token punctuation">;</span>  <span class="token comment">// type of service</span>    uint16 ip_len<span class="token punctuation">;</span> <span class="token comment">// total length, including this IP header</span>    uint16 ip_id<span class="token punctuation">;</span>  <span class="token comment">// identification</span>    uint16 ip_off<span class="token punctuation">;</span> <span class="token comment">// fragment offset field</span>    uint8 ip_ttl<span class="token punctuation">;</span>  <span class="token comment">// time to live</span>    uint8 ip_p<span class="token punctuation">;</span>    <span class="token comment">// protocol</span>    uint16 ip_sum<span class="token punctuation">;</span> <span class="token comment">// checksum, covers just IP header</span>    uint32 ip_src<span class="token punctuation">,</span> ip_dst<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶åæŒ‰æ ¼å¼å¡«å…¥æ•°æ®å°±è¡Œã€‚</p><h2 id="Reassembler"><a href="#Reassembler" class="headerlink" title="Reassembler"></a>Reassembler</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬è¦å®ç°ä¸€ä¸ªé‡ç»„å™¨ã€‚é‡ç»„å™¨æ¥å—ä¸€ä¸ªä¹±åºçš„æ•°æ®æµï¼ŒæŠŠä»–ä»¬ç»„ç»‡æˆé¡ºåºå¹¶ push åˆ° ByteStream ä¸­ï¼Œè¿™æ ·è¯»è€…å°±èƒ½è¯»å–é¡ºåºæ•°æ®äº†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="/images/learning/open-course/CS144/labs/lab1/stream.png"></p><p>æˆ‘ä»¬ç”¨ç¯å­˜å‚¨åˆ°è¾¾çš„æ•°æ®ï¼Œå¹¶ç»´æŠ¤ä¸€ä¸ª valid_ æ•°ç»„ä»¥è®°å½•ç¯çš„å“ªäº›ä½ç½®æ˜¯æœ‰æ•ˆæ•°æ®ã€‚å¯¹åˆ°è¾¾çš„æ–°æ•°æ®ï¼Œä¸€ä¸ªæœ´ç´ çš„å¤„ç†æ€è·¯å¦‚ä¸‹ï¼Œå¯ä»¥å¯¹ç…§ä»£ç ä¸‹é¢çš„å›¾ç‰‡æ¥ç†è§£ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// æŠŠæ•°æ®å­˜åˆ°ç¯ä¸­</span><span class="token keyword">auto</span> dst <span class="token operator">=</span> <span class="token punctuation">(</span> head_ <span class="token operator">+</span> first_index <span class="token operator">-</span> first_unassembled_idx_ <span class="token punctuation">)</span> <span class="token operator">%</span> ring_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">uint64_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> data<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  ring_<span class="token punctuation">[</span><span class="token punctuation">(</span> dst <span class="token operator">+</span> i <span class="token punctuation">)</span> <span class="token operator">%</span> ring_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>  valid_<span class="token punctuation">[</span><span class="token punctuation">(</span> dst <span class="token operator">+</span> i <span class="token punctuation">)</span> <span class="token operator">%</span> ring_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// å¦‚æœæ–°æ•°æ®å¡«å……äº†å¼€å¤´ä»è€Œæœ‰äº†å¯ä»¥å†™å…¥çš„è¿ç»­æ•°æ®, å†™å…¥ ByteStream</span><span class="token keyword">if</span> <span class="token punctuation">(</span> first_index <span class="token operator">==</span> first_unassembled_idx_ <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// è®¡ç®— written_len, å†™å…¥ ByteStream</span>  <span class="token comment">// æ›´æ–° valid_, first_unassembled_idx, head_</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/images/learning/open-course/CS144/labs/lab1/ring.png" width="70%" height="auto"></p><p>å†åšä¸€äº›ç»†èŠ‚å¤„ç†å’Œä¼˜åŒ–ï¼Œå°±èƒ½å¾—åˆ°ä¸‹é¢çš„ä»£ç ã€‚æˆ‘ä»¬å…ˆæ”¾å¤´æ–‡ä»¶ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Reassembler</span><span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>  <span class="token keyword">explicit</span> <span class="token function">Reassembler</span><span class="token punctuation">(</span> ByteStream<span class="token operator">&amp;&amp;</span> output <span class="token punctuation">)</span>    <span class="token operator">:</span> <span class="token function">output_</span><span class="token punctuation">(</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span> output <span class="token punctuation">)</span> <span class="token punctuation">)</span>    <span class="token punctuation">,</span> <span class="token function">ring_</span><span class="token punctuation">(</span> output_<span class="token punctuation">.</span><span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">available_capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">)</span>    <span class="token punctuation">,</span> <span class="token function">valid_</span><span class="token punctuation">(</span> output_<span class="token punctuation">.</span><span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">available_capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token comment">// ...</span><span class="token keyword">private</span><span class="token operator">:</span>  ByteStream output_<span class="token punctuation">;</span>  <span class="token keyword">uint64_t</span> head_ <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> first_unassembled_idx_ <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> eof_idx_ <span class="token punctuation">&#123;</span> UINT64_MAX <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span> ring_<span class="token punctuation">;</span>  std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span> valid_<span class="token punctuation">;</span> <span class="token comment">// use vector&lt;char> instead of &lt;bool> to improve performance</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶åæ˜¯ insert å’Œ count_bytes_pending çš„å®ç°ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"reassembler.hh"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"debug.hh"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;algorithm></span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token class-name">Reassembler</span><span class="token double-colon punctuation">::</span><span class="token function">insert</span><span class="token punctuation">(</span> <span class="token keyword">uint64_t</span> first_index<span class="token punctuation">,</span> string data<span class="token punctuation">,</span> <span class="token keyword">bool</span> is_last_substring <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token function">debug</span><span class="token punctuation">(</span> <span class="token string">"Reassembler insert(&#123;&#125;, &#123;&#125;, &#123;&#125;) called"</span><span class="token punctuation">,</span> first_index<span class="token punctuation">,</span> data<span class="token punctuation">,</span> is_last_substring <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> output_<span class="token punctuation">.</span><span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_closed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> is_last_substring <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    eof_idx_ <span class="token operator">=</span> first_index <span class="token operator">+</span> data<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token comment">// Cut overlap data</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> first_index <span class="token operator">&lt;</span> first_unassembled_idx_ <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> <span class="token keyword">uint64_t</span> offset <span class="token operator">=</span> first_unassembled_idx_ <span class="token operator">-</span> first_index<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> offset <span class="token operator">>=</span> data<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    data <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span> offset <span class="token punctuation">)</span><span class="token punctuation">;</span>    first_index <span class="token operator">=</span> first_unassembled_idx_<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token comment">// Copy data into ring</span>  <span class="token keyword">const</span> <span class="token keyword">uint64_t</span> capacity <span class="token operator">=</span> output_<span class="token punctuation">.</span><span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">available_capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> first_index <span class="token operator">>=</span> first_unassembled_idx_ <span class="token operator">+</span> capacity <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">const</span> <span class="token keyword">uint64_t</span> cplen <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span> data<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> capacity <span class="token operator">-</span> <span class="token punctuation">(</span> first_index <span class="token operator">-</span> first_unassembled_idx_ <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> <span class="token keyword">uint64_t</span> dst <span class="token operator">=</span> <span class="token punctuation">(</span> head_ <span class="token operator">+</span> first_index <span class="token operator">-</span> first_unassembled_idx_ <span class="token punctuation">)</span> <span class="token operator">%</span> ring_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> <span class="token keyword">uint64_t</span> len1 <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span> cplen<span class="token punctuation">,</span> ring_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> dst <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> <span class="token keyword">uint64_t</span> len2 <span class="token operator">=</span> cplen <span class="token operator">-</span> len1<span class="token punctuation">;</span>  std<span class="token double-colon punctuation">::</span><span class="token function">copy</span><span class="token punctuation">(</span>    data<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">></span></span></span><span class="token punctuation">(</span> len1 <span class="token punctuation">)</span><span class="token punctuation">,</span> ring_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">></span></span></span><span class="token punctuation">(</span> dst <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  std<span class="token double-colon punctuation">::</span><span class="token function">copy</span><span class="token punctuation">(</span>    data<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">></span></span></span><span class="token punctuation">(</span> len1 <span class="token punctuation">)</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">></span></span></span><span class="token punctuation">(</span> cplen <span class="token punctuation">)</span><span class="token punctuation">,</span> ring_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  std<span class="token double-colon punctuation">::</span><span class="token function">fill</span><span class="token punctuation">(</span> valid_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">></span></span></span><span class="token punctuation">(</span> dst <span class="token punctuation">)</span><span class="token punctuation">,</span> valid_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">></span></span></span><span class="token punctuation">(</span> dst <span class="token operator">+</span> len1 <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  std<span class="token double-colon punctuation">::</span><span class="token function">fill</span><span class="token punctuation">(</span> valid_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> valid_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">></span></span></span><span class="token punctuation">(</span> len2 <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Write into stream if possible</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> first_index <span class="token operator">==</span> first_unassembled_idx_ <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">uint64_t</span> written_len <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span> written_len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> written_len <span class="token operator">&lt;</span> capacity <span class="token operator">&amp;&amp;</span> valid_<span class="token punctuation">[</span><span class="token punctuation">(</span> head_ <span class="token operator">+</span> written_len <span class="token punctuation">)</span> <span class="token operator">%</span> ring_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>          written_len<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      valid_<span class="token punctuation">[</span><span class="token punctuation">(</span> head_ <span class="token operator">+</span> written_len <span class="token punctuation">)</span> <span class="token operator">%</span> ring_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">const</span> <span class="token keyword">uint64_t</span> last <span class="token operator">=</span> <span class="token punctuation">(</span> head_ <span class="token operator">+</span> written_len <span class="token punctuation">)</span> <span class="token operator">%</span> ring_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// push [head_, last) or [head, size) + [0, last) into writer</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> head_ <span class="token operator">&lt;=</span> last <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      output_<span class="token punctuation">.</span><span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span> std<span class="token double-colon punctuation">::</span><span class="token function">string</span><span class="token punctuation">(</span> ring_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">></span></span></span><span class="token punctuation">(</span> head_ <span class="token punctuation">)</span><span class="token punctuation">,</span>                                          ring_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">></span></span></span><span class="token punctuation">(</span> last <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>      output_<span class="token punctuation">.</span><span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span> std<span class="token double-colon punctuation">::</span><span class="token function">string</span><span class="token punctuation">(</span> ring_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">></span></span></span><span class="token punctuation">(</span> head_ <span class="token punctuation">)</span><span class="token punctuation">,</span> ring_<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>      output_<span class="token punctuation">.</span><span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span> std<span class="token double-colon punctuation">::</span><span class="token function">string</span><span class="token punctuation">(</span> ring_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ring_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">></span></span></span><span class="token punctuation">(</span> last <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    first_unassembled_idx_ <span class="token operator">+=</span> written_len<span class="token punctuation">;</span>    head_ <span class="token operator">=</span> last<span class="token punctuation">;</span>    <span class="token comment">// Close writer if all data have been writen into stream</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> first_unassembled_idx_ <span class="token operator">==</span> eof_idx_ <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      output_<span class="token punctuation">.</span><span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// How many bytes are stored in the Reassembler itself?</span><span class="token comment">// This function is for testing only; don't add extra state to support it.</span><span class="token keyword">uint64_t</span> <span class="token class-name">Reassembler</span><span class="token double-colon punctuation">::</span><span class="token function">count_bytes_pending</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span>ranges<span class="token double-colon punctuation">::</span><span class="token function">count</span><span class="token punctuation">(</span> valid_<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ€åè·‘å‡ºäº† 25Gbit/s çš„ç»“æœï¼Œæ˜¯æ–‡æ¡£è¯´çš„â€œtop-of-the-lineâ€çš„ä¸¤å€å¤šğŸ« ğŸ« </p><p><img src="/images/learning/open-course/CS144/labs/lab1/reassembler.png"></p><p>æœ€åè°ˆè°ˆæˆ‘ä¼˜åŒ–æ€§èƒ½çš„æ–¹æ³•ã€‚æˆ‘åœ¨ä¼˜åŒ–æ—¶ä¸»è¦ä»å°‘å–æ¨¡ã€å°‘å†™ for å¾ªç¯å’Œå°‘åˆ†æ”¯ä¸‰æ–¹é¢è€ƒè™‘ã€‚</p><ol><li><p>å°‘å–æ¨¡å’Œå°‘å†™ for å¾ªç¯æ˜¯å¯†åˆ‡ç›¸å…³çš„ã€‚æˆ‘ä»¬åœ¨ç”¨ for å¾ªç¯éå†ç¯æ—¶ç»å¸¸ä¼šå¯¹ç¯çš„é•¿åº¦å–æ¨¡ï¼Œå…¸å‹ä¾‹å­å°±æ¯”å¦‚ä¸‹é¢çš„ä»£ç ï¼š</p> <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">uint64_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cplen<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  ring_<span class="token punctuation">[</span><span class="token punctuation">(</span> dst <span class="token operator">+</span> i <span class="token punctuation">)</span> <span class="token operator">%</span> ring_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p> å–æ¨¡çš„é€Ÿåº¦å¾ˆæ…¢ï¼Œæ‰‹æ“ for å¾ªç¯æ¥é€å­—èŠ‚æ‹·è´ä¹Ÿæ¯” std::copy æ…¢ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨ std::copy æ¥ä»£æ›¿è¿™é‡Œçš„å¾ªç¯ï¼Œå¾—åˆ°ï¼š</p> <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">const</span> <span class="token keyword">uint64_t</span> len1 <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span> cplen<span class="token punctuation">,</span> ring_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> dst <span class="token punctuation">)</span><span class="token punctuation">;</span>std<span class="token double-colon punctuation">::</span><span class="token function">copy</span><span class="token punctuation">(</span>  data<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   data<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> len1<span class="token punctuation">,</span>   ring_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> dst <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>len1 <span class="token operator">&lt;</span> data<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    std<span class="token double-colon punctuation">::</span><span class="token function">copy</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> len1<span class="token punctuation">,</span>     data<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     ring_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p> è¿™èƒ½æŠŠ no overlap çš„é€Ÿåº¦ä» 30Gbit/s æå‡åˆ° 40Gbit/sï¼ŒæŠŠ 10x overlap ä» 5Gbit/s æå‡åˆ° 20Gbit/s</p></li><li><p>ä¸Šé¢çš„æ•ˆæœå·²ç»å¾ˆä¸é”™äº†ï¼Œæˆ‘ä»¬è¿˜èƒ½é€šè¿‡å‡å°‘åˆ†æ”¯é¢„æµ‹çš„å¼€é”€æ¥è¿›ä¸€æ­¥ä¼˜åŒ–æ€§èƒ½ï¼š</p> <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">const</span> <span class="token keyword">uint64_t</span> len1 <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span> cplen<span class="token punctuation">,</span> ring_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> dst <span class="token punctuation">)</span><span class="token punctuation">;</span>std<span class="token double-colon punctuation">::</span><span class="token function">copy</span><span class="token punctuation">(</span>  data<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   data<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> len1<span class="token punctuation">,</span>   ring_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> dst <span class="token punctuation">)</span><span class="token punctuation">;</span>std<span class="token double-colon punctuation">::</span><span class="token function">copy</span><span class="token punctuation">(</span>  data<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> len1<span class="token punctuation">,</span>   data<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> cplen<span class="token punctuation">,</span>   ring_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p> è¿™èƒ½æŠŠ no overlap çš„é€Ÿåº¦ä» 40Gbit/s æå‡åˆ° 70Gbit/sï¼ŒæŠŠ 10x overlap ä» 20Gbit/s æå‡åˆ° 25Gbit/s</p></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;è¿™ä¸ª Lab é‡Œæˆ‘ä»¬è¦æ‰‹åŠ¨æ„é€ ä¸€ä¸ª IP è¯·æ±‚ï¼Œç„¶åå†™ä¸€ä¸ªæŠŠæ— åºæ•°æ®å˜æˆæœ‰åºæ•°æ®çš„ Reassembler.&lt;/p&gt;
&lt;h2 id=&quot;Send-an-Internet-datagram-by-hand&quot;&gt;&lt;a href=&quot;#Send-an-Internet-datagram</summary>
      
    
    
    
    <category term="å…¬å¼€è¯¾" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/"/>
    
    <category term="CS144" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/CS144/"/>
    
    <category term="Labs" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/CS144/Labs/"/>
    
    
  </entry>
  
  <entry>
    <title>Lab 0 Networking Warmup</title>
    <link href="http://rinevard.github.io/wiki/learning/open-course/CS144/labs/lab0-network-warmup/"/>
    <id>http://rinevard.github.io/wiki/learning/open-course/CS144/labs/lab0-network-warmup/</id>
    <published>2025-12-10T10:03:28.000Z</published>
    <updated>2025-12-12T08:26:04.875Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨è¿™ä¸ª Lab é‡Œæˆ‘ä»¬è¦å®ç°ä¸€ä¸ªå‘ GET è¯·æ±‚çš„å‡½æ•°å’Œä¸€ä¸ªâ€œå†…å­˜å­—èŠ‚æµâ€ï¼Œæˆ‘ä»¬å¼€å§‹å§ã€‚</p><h2 id="webget"><a href="#webget" class="headerlink" title="webget"></a>webget</h2><p>é¦–å…ˆæˆ‘ä»¬å›é¡¾ä¸€ä¸‹ CSAPP é‡Œå®¢æˆ·ç«¯ä½¿ç”¨ socket æ¥å£çš„æ–¹æ³•ï¼šgetaddrinfo -&gt; socket -&gt; connect -&gt; read/write -&gt; close</p><p>ç„¶åå¯¹ç…§ socket.hh å’Œ file_descriptor.hh å†™å‡º C++ ç‰ˆæœ¬çš„ä»£ç å°±è¡Œï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">get_URL</span><span class="token punctuation">(</span> <span class="token keyword">const</span> string<span class="token operator">&amp;</span> host<span class="token punctuation">,</span> <span class="token keyword">const</span> string<span class="token operator">&amp;</span> path <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  TCPSocket socket<span class="token punctuation">;</span>  socket<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span> <span class="token function">Address</span><span class="token punctuation">(</span> host<span class="token punctuation">,</span> <span class="token string">"http"</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  socket<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span> <span class="token string">"GET "</span> <span class="token operator">+</span> path <span class="token operator">+</span> <span class="token string">" HTTP/1.1\r\nHost: "</span> <span class="token operator">+</span> host <span class="token operator">+</span> <span class="token string">"\r\nConnection: close\r\n\r\n"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  std<span class="token double-colon punctuation">::</span>string buf<span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token operator">!</span>socket<span class="token punctuation">.</span><span class="token function">eof</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    socket<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span> buf <span class="token punctuation">)</span><span class="token punctuation">;</span>    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> buf<span class="token punctuation">;</span>    buf<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œä¸éœ€è¦æ‰‹åŠ¨è°ƒç”¨ closeï¼Œå› ä¸º file_descriptor.cc çš„ææ„å‡½æ•° ~FDWrapper() è‡ªå·±ä¼šè°ƒç”¨ close. è¿™æ˜¯éµå¾ªäº† C++ çš„ RAII è§„èŒƒã€‚</p><p>æµ‹è¯•ä»£ç çš„åŸç†æ˜¯ webget_t.sh ç”¨ç®¡é“é‡å®šå‘ç¨‹åºè¾“å‡ºï¼Œç„¶åå¯¹æ¯”æ­£ç¡®å€¼ã€‚</p><h2 id="byte-stream"><a href="#byte-stream" class="headerlink" title="byte stream"></a>byte stream</h2><p>æˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ªå†…å­˜å­—èŠ‚æµï¼Œå†™è€…å¯ä»¥å¾€é‡Œé¢å†™ä¸œè¥¿ï¼Œè¯»è€…å¯ä»¥è¯»ï¼Œå­—èŠ‚æµæœ‰æœ€å¤§å®¹é‡ã€‚Lab æ–‡æ¡£è¯´æ— éœ€è€ƒè™‘å¹¶å‘ï¼Œæ‰€ä»¥æˆ‘ä»¬ç®€å•åšä¸ªç¯å½¢é˜Ÿåˆ—ç„¶åè®¾ç½®è¯»å†™å¤´å°±è¡Œï¼ˆæ­»å»çš„ 6S081 è®°å¿†çªç„¶æ”»å‡»æˆ‘ï¼ï¼‰</p><p>é¦–å…ˆè®¾ç½®å‡ ä¸ªæˆå‘˜å˜é‡ï¼Œè¿™é‡Œçš„ head_ å§‹ç»ˆæŒ‡å‘ç¬¬ä¸€ä¸ªæœ‰æ•ˆæ•°æ®ï¼Œtail_ å§‹ç»ˆæŒ‡å‘ç©ºä½ç½®ï¼š</p><p><img src="/images/learning/open-course/CS144/labs/lab0/ring.png" width="50%" height="auto"></p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">ByteStream</span><span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>  <span class="token keyword">explicit</span> <span class="token function">ByteStream</span><span class="token punctuation">(</span> <span class="token keyword">uint64_t</span> capacity <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Helper functions (provided) to access the ByteStream's Reader and Writer interfaces</span>  Reader<span class="token operator">&amp;</span> <span class="token function">reader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> Reader<span class="token operator">&amp;</span> <span class="token function">reader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>  Writer<span class="token operator">&amp;</span> <span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> Writer<span class="token operator">&amp;</span> <span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>  <span class="token keyword">void</span> <span class="token function">set_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> error_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>       <span class="token comment">// Signal that the stream suffered an error.</span>  <span class="token keyword">bool</span> <span class="token function">has_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> error_<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// Has the stream had an error?</span><span class="token keyword">protected</span><span class="token operator">:</span>  <span class="token comment">// Please add any additional state to the ByteStream here, and not to the Writer and Reader interfaces.</span>  <span class="token keyword">uint64_t</span> capacity_<span class="token punctuation">;</span>  <span class="token keyword">uint64_t</span> tot_pushed_ <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token keyword">uint64_t</span> head_ <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> tail_ <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span> ring_<span class="token punctuation">;</span>  <span class="token keyword">bool</span> closed_ <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token keyword">bool</span> error_ <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œæˆå‘˜å˜é‡å‘½åç»“å°¾å¸¦ä¸‹åˆ’çº¿æ˜¯ Google C++ Styleï¼Œåˆ©äºåŒºåˆ†æˆå‘˜å˜é‡å’Œå±€éƒ¨å˜é‡ / å‡½æ•°å‚æ•°ã€‚</p><p>ç„¶åè¿™é‡Œçš„ Reader å’Œ Writer æ–¹æ³•æœ‰ä»€ä¹ˆç”¨å‘¢ï¼ŸReader å’Œ Writer ç»§æ‰¿è‡ª ByteStreamï¼Œå…è®¸ç”¨æˆ·ç”¨ä¸åŒè§†è§’çœ‹åŒä¸€ä¸ªå¯¹è±¡ã€‚è¿™ä¹ˆè¯´æœ‰ç‚¹æŠ½è±¡ï¼Œå¯ä»¥çœ‹å‘ byte_stream_helpers.ccï¼Œå®ƒåªæ˜¯åšäº†ç±»å‹è½¬æ¢ã€‚</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">Reader<span class="token operator">&amp;</span> <span class="token class-name">ByteStream</span><span class="token double-colon punctuation">::</span><span class="token function">reader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">static_assert</span><span class="token punctuation">(</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span> Reader <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span> ByteStream <span class="token punctuation">)</span><span class="token punctuation">,</span>                 <span class="token string">"Please add member variables to the ByteStream base, not the ByteStream Reader."</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>Reader<span class="token operator">&amp;</span><span class="token operator">></span></span></span><span class="token punctuation">(</span> <span class="token operator">*</span><span class="token keyword">this</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// NOLINT(*-downcast)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¯»è€…å’Œå†™è€…æ“æ§çš„æ˜¯åŒä¸€ä¸ª ByteStream å¯¹è±¡ï¼Œæˆ‘ä»¬åˆ™æä¾›äº†ä¸¤ç§ä¸åŒçš„è§†è§’ï¼Œæ¯ç§è§†è§’æœ‰ä¸åŒçš„æ“ä½œæ•°æ®çš„æ–¹æ³•ã€‚</p><p>ç„¶åå®ç°ä¸¤ç§è§†è§’å„è‡ªçš„æ¥å£ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"byte_stream.hh"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"debug.hh"</span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token comment">// Leave one space to distinguish between a full ring and an empty ring.</span><span class="token class-name">ByteStream</span><span class="token double-colon punctuation">::</span><span class="token function">ByteStream</span><span class="token punctuation">(</span> <span class="token keyword">uint64_t</span> capacity <span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">capacity_</span><span class="token punctuation">(</span> capacity <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ring_</span><span class="token punctuation">(</span> capacity <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token comment">// Push data to stream, but only as much as available capacity allows.</span><span class="token keyword">void</span> <span class="token class-name">Writer</span><span class="token double-colon punctuation">::</span><span class="token function">push</span><span class="token punctuation">(</span> <span class="token keyword">const</span> string<span class="token operator">&amp;</span> data <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> <span class="token keyword">auto</span> written_len <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span> <span class="token function">available_capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> written_len <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">uint64_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> written_len<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    ring_<span class="token punctuation">[</span>tail_<span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>    tail_ <span class="token operator">=</span> <span class="token punctuation">(</span> tail_ <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token operator">%</span> ring_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  tot_pushed_ <span class="token operator">+=</span> written_len<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Signal that the stream has reached its ending. Nothing more will be written.</span><span class="token keyword">void</span> <span class="token class-name">Writer</span><span class="token double-colon punctuation">::</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  closed_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Has the stream been closed?</span><span class="token keyword">bool</span> <span class="token class-name">Writer</span><span class="token double-colon punctuation">::</span><span class="token function">is_closed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> closed_<span class="token punctuation">;</span> <span class="token comment">// Your code here.</span><span class="token punctuation">&#125;</span><span class="token comment">// How many bytes can be pushed to the stream right now?</span><span class="token keyword">uint64_t</span> <span class="token class-name">Writer</span><span class="token double-colon punctuation">::</span><span class="token function">available_capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span> head_ <span class="token operator">+</span> ring_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> tail_ <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token operator">%</span> ring_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Total number of bytes cumulatively pushed to the stream</span><span class="token keyword">uint64_t</span> <span class="token class-name">Writer</span><span class="token double-colon punctuation">::</span><span class="token function">bytes_pushed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> tot_pushed_<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Peek at the next bytes in the buffer -- ideally as many as possible.</span><span class="token comment">// It's not required to return a string_view of the *whole* buffer, but</span><span class="token comment">// if the peeked string_view is only one byte at a time, it will probably force</span><span class="token comment">// the caller to do a lot of extra work.</span>string_view <span class="token class-name">Reader</span><span class="token double-colon punctuation">::</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> head_ <span class="token operator">==</span> tail_ <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> head_ <span class="token operator">&lt;</span> tail_ <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> ring_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">></span></span></span><span class="token punctuation">(</span> head_ <span class="token punctuation">)</span><span class="token punctuation">,</span> ring_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">></span></span></span><span class="token punctuation">(</span> tail_ <span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> ring_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">></span></span></span><span class="token punctuation">(</span> head_ <span class="token punctuation">)</span><span class="token punctuation">,</span> ring_<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Remove `len` bytes from the buffer.</span><span class="token keyword">void</span> <span class="token class-name">Reader</span><span class="token double-colon punctuation">::</span><span class="token function">pop</span><span class="token punctuation">(</span> <span class="token keyword">uint64_t</span> len <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  head_ <span class="token operator">=</span> <span class="token punctuation">(</span> head_ <span class="token operator">+</span> len <span class="token punctuation">)</span> <span class="token operator">%</span> ring_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Is the stream finished (closed and fully popped)?</span><span class="token keyword">bool</span> <span class="token class-name">Reader</span><span class="token double-colon punctuation">::</span><span class="token function">is_finished</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> closed_ <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> head_ <span class="token operator">==</span> tail_ <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Number of bytes currently buffered (pushed and not popped)</span><span class="token keyword">uint64_t</span> <span class="token class-name">Reader</span><span class="token double-colon punctuation">::</span><span class="token function">bytes_buffered</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span> tail_ <span class="token operator">+</span> ring_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> head_ <span class="token punctuation">)</span> <span class="token operator">%</span> ring_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// Total number of bytes cumulatively popped from stream</span><span class="token keyword">uint64_t</span> <span class="token class-name">Reader</span><span class="token double-colon punctuation">::</span><span class="token function">bytes_popped</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> tot_pushed_ <span class="token operator">-</span> <span class="token function">bytes_buffered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œçš„ Reader::peek æ— éœ€è¿”å›æ•´ä¸ªç¯ï¼Œåªéœ€å°½åŠ›è€Œä¸ºï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ head &gt; tail æ—¶åªè¿”å› head åˆ° ring.size éƒ¨åˆ†çš„å†…å®¹è€Œæ²¡å¸¦ä¸Š 0 åˆ° tail çš„å†…å®¹ï¼›è¿™é‡Œçš„ Writer::push æˆ–è®¸å¯ä»¥ç”¨ std::copy æ¥ä¼˜åŒ–ï¼Œä½†æˆ‘å°±ä¸å†™äº†å§ã€‚</p><p>ç„¶åæ”¾ä¸‹æµ‹è¯•ç»“æœï¼š</p><p><img src="/images/learning/open-course/CS144/labs/lab0/test.png" width="70%" height="auto"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;åœ¨è¿™ä¸ª Lab é‡Œæˆ‘ä»¬è¦å®ç°ä¸€ä¸ªå‘ GET è¯·æ±‚çš„å‡½æ•°å’Œä¸€ä¸ªâ€œå†…å­˜å­—èŠ‚æµâ€ï¼Œæˆ‘ä»¬å¼€å§‹å§ã€‚&lt;/p&gt;
&lt;h2 id=&quot;webget&quot;&gt;&lt;a href=&quot;#webget&quot; class=&quot;headerlink&quot; title=&quot;webget&quot;&gt;&lt;/a&gt;webget&lt;/h2&gt;&lt;p&gt;é¦–å…ˆ</summary>
      
    
    
    
    <category term="å…¬å¼€è¯¾" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/"/>
    
    <category term="CS144" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/CS144/"/>
    
    <category term="Labs" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/CS144/Labs/"/>
    
    
  </entry>
  
  <entry>
    <title>Lab 9 mmap</title>
    <link href="http://rinevard.github.io/wiki/learning/open-course/MIT-6.S081/Labs/lab9-mmap/"/>
    <id>http://rinevard.github.io/wiki/learning/open-course/MIT-6.S081/Labs/lab9-mmap/</id>
    <published>2025-12-07T07:24:28.000Z</published>
    <updated>2025-12-07T07:30:24.305Z</updated>
    
    <content type="html"><![CDATA[<p><img src="/images/learning/open-course/MIT-6.S081/labs/lab9-mmap/last.jpg" alt=""></p><p>è¿™ä¸ª Lab è¦æ±‚æˆ‘ä»¬è¦å®ç°ç®€å•ç‰ˆçš„ mmapï¼Œå®ƒæŠŠæ–‡ä»¶æ˜ å°„åˆ°å†…å­˜ä¸­ä»¥æé«˜è®¿é—®æ•ˆç‡ã€‚mmap çš„å®šä¹‰å¯ä»¥å‚è€ƒ <a href="https://linux.die.net/man/2/mmap">man 2 mmap</a>ï¼Œæ€»ä¹‹å®ƒçš„å‚æ•°å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">,</span> <span class="token keyword">int</span> prot<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span>           <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token class-name">off_t</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">munmap</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token class-name">size_t</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä»¬è·³è¿‡ç³»ç»Ÿè°ƒç”¨çš„é…ç½®ï¼Œå› ä¸ºæƒ³å¿…å¤§å®¶å·²ç»å“é‰´çš„å¤Ÿå¤šäº†ã€‚</p><h1 id="sys-mmap-å’Œ-vmfault"><a href="#sys-mmap-å’Œ-vmfault" class="headerlink" title="sys_mmap å’Œ vmfault"></a>sys_mmap å’Œ vmfault</h1><p>Lab è¦æ±‚ lazy allocationï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æŠŠ mmap è¢«è°ƒç”¨æ—¶ä¼ å…¥çš„å‚æ•°è®°å½•åœ¨ä¸€ä¸ªç»“æ„ä½“ä¸­ä»¥ä¾¿åç»­åœ¨ page fault æ—¶æŒ‰éœ€åˆ†é…ï¼Œæˆ‘è®¾è®¡çš„ç»“æ„ä½“å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> valid<span class="token punctuation">;</span>      <span class="token comment">// Is this idx being used?</span>    uint64 st<span class="token punctuation">;</span>     <span class="token comment">// Start of the mmap, page aligned</span>    <span class="token keyword">int</span> len<span class="token punctuation">;</span>     <span class="token comment">// Number of bytes to map</span>    <span class="token keyword">int</span> prot<span class="token punctuation">;</span>       <span class="token comment">// PROT_READ or PROT_WRITE or both</span>    <span class="token keyword">int</span> flags<span class="token punctuation">;</span>      <span class="token comment">// MAP_SHARED or MAP_PRIVATE</span>    <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>f<span class="token punctuation">;</span>         <span class="token comment">// Mapped file</span>    <span class="token keyword">int</span> off<span class="token punctuation">;</span><span class="token punctuation">&#125;</span> mmap<span class="token punctuation">[</span>NMMAP<span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…¶ä¸­ NMMAP è¢«å®šä¹‰åœ¨ param.h ä¸­ã€‚è¿™é‡Œå®šä¹‰æˆ 16 æ˜¯å› ä¸º Lab æ–‡æ¡£è¯´ç”¨é•¿åº¦ä¸º 16 çš„å®šé•¿æ•°ç»„æ¥è®°å½• mmap ä¿¡æ¯å°±å¤Ÿäº†ã€‚</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NMMAP</span> <span class="token expression"><span class="token number">16</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è¿™é‡Œç®€å•èŠä¸‹æˆ‘æ˜¯æ€ä¹ˆè®¾è®¡ç»“æ„ä½“çš„ã€‚æˆ‘åœ¨è®¾è®¡ç»“æ„ä½“æ—¶ä¹ æƒ¯å¿«é€Ÿå†™ä¸€ä¸ªåˆç‰ˆï¼Œç„¶ååœ¨å†™åç»­ä»£ç çš„è¿‡ç¨‹ä¸­è¿­ä»£ã€‚åƒè¿™é‡Œçš„åˆç‰ˆå°±æ˜¯æŠŠ mmap çš„å‚æ•°å…¨å¡è¿›å»å†åŠ ä¸ª valid ä½ï¼Œç„¶åå†™ sys_mmap æ—¶å‘ç° offset é»˜è®¤æ˜¯ 0 äºæ˜¯å°±åˆ æ‰äº† offï¼Œåæ¥åœ¨å†™ sys_munmap æ—¶åˆå‘ç° off æ˜¯æœ‰ç”¨çš„å°±åŠ äº†å›æ¥ã€‚</p><p>æœ‰äº†ç»“æ„ä½“ä»¥åæˆ‘ä»¬å°±èƒ½å®ç° sys_mmap äº†ã€‚åœ¨è¿™ä¸ªå‡½æ•°é‡Œç®€å•åœ°ä¿å­˜æ•°æ®å³å¯ï¼Œæ— éœ€å¤åˆ¶æ–‡ä»¶å†…å®¹åˆ°ç‰©ç†å†…å­˜ä¸­ï¼Œæ¯•ç«Ÿæˆ‘ä»¬æ˜¯ lazy allocation.</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">uint64 <span class="token function">sys_mmap</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> len<span class="token punctuation">,</span> prot<span class="token punctuation">,</span> flags<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>f<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">proc</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>    <span class="token keyword">int</span> i<span class="token punctuation">;</span>    <span class="token comment">// Ignore args[0], `addr`, which is always zero</span>    <span class="token function">argint</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">argint</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>prot<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">argint</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">argfd</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>f<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// Ignore arg[5], `offset`, which is always zero</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>f<span class="token operator">-></span>writable <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> MAP_SHARED<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>prot <span class="token operator">&amp;</span> PROT_WRITE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    p <span class="token operator">=</span> <span class="token function">myproc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NMMAP<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>valid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>valid <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>            p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>st <span class="token operator">=</span> <span class="token function">PGROUNDUP</span><span class="token punctuation">(</span>p<span class="token operator">-></span>sz<span class="token punctuation">)</span><span class="token punctuation">;</span>            p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>len <span class="token operator">=</span> len<span class="token punctuation">;</span>            p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>prot <span class="token operator">=</span> prot<span class="token punctuation">;</span>            p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>flags <span class="token operator">=</span> flags<span class="token punctuation">;</span>            p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>f <span class="token operator">=</span> f<span class="token punctuation">;</span>            p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>off <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token function">filedup</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> NMMAP<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// No space to save metadata for this mmap</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    p<span class="token operator">-></span>sz <span class="token operator">=</span> <span class="token function">PGROUNDUP</span><span class="token punctuation">(</span>p<span class="token operator">-></span>sz<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">PGROUNDUP</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>st<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶åæˆ‘ä»¬éœ€è¦å®ç° page fault æ¥æŠŠä¼ å…¥ mmap çš„æ–‡ä»¶å¤åˆ¶åˆ°ç‰©ç†å†…å­˜ä¸­ã€‚å’Œ cow lab ç±»ä¼¼ï¼Œè¦ä¿®æ”¹ trap.c çš„ usertrap å‡½æ•°ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">r_scause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// system call</span>    <span class="token comment">// ...</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>which_dev <span class="token operator">=</span> <span class="token function">devintr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// ok</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">r_scause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">15</span> <span class="token operator">||</span> <span class="token function">r_scause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">13</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>           <span class="token function">vmfault</span><span class="token punctuation">(</span>p<span class="token operator">-></span>pagetable<span class="token punctuation">,</span> <span class="token function">r_stval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token function">r_scause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">13</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// page fault on mmap page</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// kill process</span>    <span class="token comment">// ...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶åè¿™é‡Œæ˜¯æˆ‘å¯¹ vmfault çš„å®ç°ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">ismapped</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">,</span> uint64 va<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">pte_t</span> <span class="token operator">*</span>pte <span class="token operator">=</span> <span class="token function">walk</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> va<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>pte <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>uint64 <span class="token function">vmfault</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">,</span> uint64 va<span class="token punctuation">,</span> <span class="token keyword">int</span> read<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"vmfault\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"va: %lu, related page: %lu\n"</span><span class="token punctuation">,</span> va<span class="token punctuation">,</span> <span class="token function">PGROUNDDOWN</span><span class="token punctuation">(</span>va<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    uint64 mem<span class="token punctuation">;</span>    <span class="token keyword">int</span> perm<span class="token punctuation">,</span> i<span class="token punctuation">;</span>    uint off<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>f <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">proc</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">myproc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>va <span class="token operator">>=</span> p<span class="token operator">-></span>sz<span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ismapped</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> va<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// Find mmap metadata corresponding to va</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NMMAP<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>valid <span class="token operator">&amp;&amp;</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>st <span class="token operator">&lt;=</span> va <span class="token operator">&amp;&amp;</span>            va <span class="token operator">&lt;</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>st <span class="token operator">+</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            f <span class="token operator">=</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>f<span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>f<span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">// Alloc new page and fill with file data</span>    mem <span class="token operator">=</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span><span class="token function">kalloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mem <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>mem<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">ilock</span><span class="token punctuation">(</span>f<span class="token operator">-></span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>    off <span class="token operator">=</span> <span class="token function">PGROUNDDOWN</span><span class="token punctuation">(</span>va<span class="token punctuation">)</span> <span class="token operator">-</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>st <span class="token operator">+</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>off<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>off <span class="token operator">></span> f<span class="token operator">-></span>ip<span class="token operator">-></span>size<span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">readi</span><span class="token punctuation">(</span>f<span class="token operator">-></span>ip<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> mem<span class="token punctuation">,</span> off<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">iunlock</span><span class="token punctuation">(</span>f<span class="token operator">-></span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// Map page</span>    perm <span class="token operator">=</span> PTE_U<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>prot <span class="token operator">&amp;</span> PROT_READ<span class="token punctuation">)</span>        perm <span class="token operator">|=</span> PTE_R<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>prot <span class="token operator">&amp;</span> PROT_WRITE<span class="token punctuation">)</span>        perm <span class="token operator">|=</span> PTE_W<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mappages</span><span class="token punctuation">(</span>p<span class="token operator">-></span>pagetable<span class="token punctuation">,</span> <span class="token function">PGROUNDDOWN</span><span class="token punctuation">(</span>va<span class="token punctuation">)</span><span class="token punctuation">,</span> PGSIZE<span class="token punctuation">,</span> mem<span class="token punctuation">,</span> perm<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">kfree</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>mem<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> mem<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è‡³æ­¤æˆ‘ä»¬å°±èƒ½é€šè¿‡ç¬¬ä¸€ä¸ª munmap ä¹‹å‰çš„æ‰€æœ‰æµ‹è¯•äº†ã€‚æˆ‘ä»¬å¯èƒ½ä¼šç–‘æƒ‘ï¼Œå¦‚æœä¼ å…¥ mmap çš„ len æ¯” f-&gt;ip-&gt;size å¤§å¾ˆå¤šæ€ä¹ˆåŠï¼Ÿå¯¹ç…§ man æ–‡æ¡£å¯ä»¥å‘ç°æˆ‘ä»¬åº”è¯¥åœ¨è®¿é—®éæ–‡ä»¶åŒºåŸŸæ—¶ï¼ˆè¶…å‡ºæ–‡ä»¶å¤§å°çš„åŒºåŸŸï¼‰åº”è¯¥å‘ SIGBUS ä¿¡å·ï¼Œä½†æ‰€å¹¸æµ‹è¯•ä»£ç æ²¡æœ‰æµ‹è¿™ä¸€ç‚¹ï¼Œå› æ­¤æˆ‘ä»¬åªè¦æŒ‰éœ€åˆ†é¡µå¹¶å¤åˆ¶å°±è¡Œäº†ã€‚å¦‚å®éªŒæ–‡æ¡£æ‰€è¨€ï¼Œâ€œIf mmaptest doesnâ€™t use a mmap feature, you donâ€™t need to implement that feature.â€</p><h1 id="sys-munmap"><a href="#sys-munmap" class="headerlink" title="sys_munmap"></a>sys_munmap</h1><p>æ¥ä¸‹æ¥æˆ‘ä»¬å®ç°ä¸€ä¸ªä¾¿å®œç‰ˆæœ¬çš„ sys_munmap. æ„Ÿè§‰åœ¨è¿™ä¸ª Lab é‡Œè¦ä¸æ–­å›é¡¾ â€If mmaptest doesnâ€™t use a mmap feature, you donâ€™t need to implement that featureâ€ï¼Œä¸ç„¶å®ç°èµ·æ¥å°±æ²¡å®Œæ²¡äº†äº†ğŸ« ğŸ« </p><p>åœ¨ Lab ä¸­ï¼Œmunmap æ€»æ˜¯åœ¨å°è¯• unmap ä¸€å—å½¢å¦‚ [start of a map, mid of this map] æˆ– [mid of a map, end of this map] æˆ– [start of a map, end of this map] çš„åŒºåŸŸã€‚æ€»ä¹‹å°±æ˜¯å®ƒåªåœ¨ä¸€ä¸ª map åŒºåŸŸå†… unmapï¼Œä¸”ä¸ä¼šæŒ–æ´ã€‚</p><p>è‡ªç„¶è€Œç„¶åœ°æˆ‘ä»¬ä¼šæƒ³é—®ï¼Œå¦‚æœä¼ å…¥çš„å‚æ•°è¦†ç›–äº†å¤šä¸ª mmap åŒºåŸŸå‘¢ï¼Ÿå¦‚æœè¦†ç›–äº†æ™®é€šå†…å­˜å‘¢ï¼Ÿå¦‚æœæŒ–äº†ä¸ªæ´å‘¢ï¼Ÿ</p><p>æˆ‘åªèƒ½è¯´ï¼Œä¸è¦å¤šæƒ³ğŸ« ğŸ« ğŸ« ğŸ« </p><p>ä½†æå‡ºäº†é—®é¢˜æ€»å½’æ˜¯è¦ç»™è§£ç­”çš„ï¼Œè™½ç„¶æˆ‘æ²¡æœ‰å®ç°è¿™äº›åŠŸèƒ½ï¼Œè€Œä¸”ä¸å®ç°å®ƒä»¬ä¹Ÿèƒ½é€šè¿‡æµ‹è¯•ã€‚æ ¹æ® man æ‰‹å†Œæ¨æµ‹è¿™å‡ ç§æƒ…å†µçš„è¡Œä¸ºå¦‚ä¸‹ï¼š</p><ol><li>å¦‚æœä¼ å…¥çš„å‚æ•°è¦†ç›–äº†å¤šä¸ª mmap åŒºåŸŸï¼ŒæŠŠå®ƒä»¬éƒ½ unmap æ‰ï¼ˆæ½œåœ¨çš„é£é™©æ˜¯æ¯ä¸ªåŒºåŸŸçš„ flags å¯èƒ½ä¸åŒï¼‰</li><li>å¦‚æœè¦†ç›–äº†æ™®é€šå†…å­˜ï¼ŒæŠŠé‚£å—å†…å­˜é‡Šæ”¾æ‰</li><li>å¦‚æœæŒ–äº†ä¸ªæ´ï¼ŒæŠŠè¿™å— mmap åŒºåŸŸåˆ†å‰²æˆä¸¤å— mmap åŒºåŸŸ</li></ol><p>å›åˆ°æˆ‘ä»¬çš„ Lab. åœ¨å®ç° sys_munmap å‰æœ‰ä¸¤ç‚¹è¦æ³¨æ„ï¼Œç¬¬ä¸€ç‚¹æ˜¯åœ¨ unmap æ—¶è¦æ£€æŸ¥ map åŒºåŸŸæ˜¯å¦è¢«è®¾ä¸º MAP_SHAREDï¼Œå¦‚æœæ˜¯è¦æŠŠå†…å®¹å†™å›æ–‡ä»¶ï¼›ç¬¬äºŒç‚¹æ˜¯æˆ‘ä»¬ç°åœ¨ä½¿ç”¨ lazy allocationï¼Œæ‰€ä»¥è™šæ‹Ÿå†…å­˜ç©ºé—´å¯èƒ½æœ‰æœªæ˜ å°„çš„è™šæ‹Ÿé¡µï¼Œå› æ­¤è¦ä¿®æ”¹ uvmunmap è®©å®ƒåœ¨é‡åˆ°æœªæ˜ å°„çš„è™šæ‹Ÿé¡µæ—¶è·³è¿‡è€Œé panic.</p><p>å…ˆæ¥çœ‹çœ‹ç¬¬ä¸€ç‚¹ï¼Œå†™å›æ–‡ä»¶çš„å®ç°å¦‚ä¸‹ï¼Œå¦‚ hint æ‰€è¨€å‚è€ƒ filewrite å°±è¡Œï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// Write parts of a shared mmap[i] back to file</span><span class="token comment">// theses parts must in mappepd pages and addr must be page-aligned</span><span class="token keyword">int</span> <span class="token function">mmap_wbk</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> uint64 addr<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>f<span class="token punctuation">;</span>    uint64 fileend<span class="token punctuation">,</span> src<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">proc</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>    <span class="token keyword">int</span> pg<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>addr <span class="token operator">%</span> PGSIZE <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    p <span class="token operator">=</span> <span class="token function">myproc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">>=</span> NMMAP <span class="token operator">||</span> <span class="token operator">!</span><span class="token punctuation">(</span>p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> MAP_SHARED<span class="token punctuation">)</span> <span class="token operator">||</span>        addr <span class="token operator">&lt;</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>st <span class="token operator">||</span> addr <span class="token operator">+</span> len <span class="token operator">></span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>st <span class="token operator">+</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    f <span class="token operator">=</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>f<span class="token punctuation">;</span>    <span class="token function">ilock</span><span class="token punctuation">(</span>f<span class="token operator">-></span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>    fileend <span class="token operator">=</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>st <span class="token operator">-</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>off <span class="token operator">+</span> f<span class="token operator">-></span>ip<span class="token operator">-></span>size<span class="token punctuation">;</span>    <span class="token function">iunlock</span><span class="token punctuation">(</span>f<span class="token operator">-></span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// Write valid pages back to file</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>pg <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> pg <span class="token operator">*</span> PGSIZE <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> pg<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">walkaddr</span><span class="token punctuation">(</span>p<span class="token operator">-></span>pagetable<span class="token punctuation">,</span> addr <span class="token operator">+</span> pg <span class="token operator">*</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">int</span> max <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>MAXOPBLOCKS <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> BSIZE<span class="token punctuation">;</span>            <span class="token keyword">int</span> tot <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>PGSIZE<span class="token punctuation">,</span> fileend <span class="token operator">-</span> <span class="token punctuation">(</span>addr <span class="token operator">+</span> pg <span class="token operator">*</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> r<span class="token punctuation">,</span> written <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span>written <span class="token operator">&lt;</span> tot<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">int</span> n <span class="token operator">=</span> tot <span class="token operator">-</span> written<span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">></span> max<span class="token punctuation">)</span>                    n <span class="token operator">=</span> max<span class="token punctuation">;</span>                <span class="token function">begin_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">ilock</span><span class="token punctuation">(</span>f<span class="token operator">-></span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>                src <span class="token operator">=</span> addr <span class="token operator">+</span> pg <span class="token operator">*</span> PGSIZE <span class="token operator">+</span> written<span class="token punctuation">;</span>                r <span class="token operator">=</span> <span class="token function">writei</span><span class="token punctuation">(</span>f<span class="token operator">-></span>ip<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> src<span class="token punctuation">,</span> src <span class="token operator">-</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>st <span class="token operator">+</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>off<span class="token punctuation">,</span>                           n<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">iunlock</span><span class="token punctuation">(</span>f<span class="token operator">-></span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> n<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                written <span class="token operator">+=</span> r<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œä»¥é¡µä¸ºå•ä½å†™å›æ–‡ä»¶æ˜¯å› ä¸º lazy allocation å¯¼è‡´å¯èƒ½å­˜åœ¨æœªè¢«æ˜ å°„çš„è™šæ‹Ÿé¡µï¼Œæˆ‘ä»¬ä¸å¸Œæœ›æŠŠæœªæ˜ å°„çš„é¡µå†™å›æ–‡ä»¶ã€‚å¦å¤–è¦æ³¨æ„å†™å›çš„é•¿åº¦ä¸èƒ½è¶…è¿‡æ–‡ä»¶æœ¬èº«é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯è¯´å¯¹æ¯ä¸€ä¸ªå°è¯•å†™å›çš„é¡µï¼Œå®é™…å†™å…¥çš„é•¿åº¦ä¸ºï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> tot <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>PGSIZE<span class="token punctuation">,</span> fileend <span class="token operator">-</span> <span class="token punctuation">(</span>addr <span class="token operator">+</span> pg <span class="token operator">*</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æˆ‘æŠŠè¿™ä¸ª mmap_wbk å‡½æ•°æ”¾åœ¨ proc.c ä¸­ï¼Œå› ä¸ºåç»­åœ¨ exit å‡½æ•°é‡Œä¹Ÿè¦ç”¨åˆ°å®ƒã€‚</p><p>ç„¶åæ˜¯ç¬¬äºŒç‚¹ï¼Œè®© uvmunmap åœ¨é‡åˆ°æœªæ˜ å°„çš„è™šæ‹Ÿé¡µæ—¶è·³è¿‡è€Œé panicï¼Œæˆ‘ä»¬ç®€å•æ”¹äº†ä¸€ä¸‹ uvmunmapï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">uvmunmap</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">,</span> uint64 va<span class="token punctuation">,</span> uint64 npages<span class="token punctuation">,</span> <span class="token keyword">int</span> do_free<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    uint64 a<span class="token punctuation">;</span>    <span class="token class-name">pte_t</span> <span class="token operator">*</span>pte<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>va <span class="token operator">%</span> PGSIZE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmunmap: not aligned"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>a <span class="token operator">=</span> va<span class="token punctuation">;</span> a <span class="token operator">&lt;</span> va <span class="token operator">+</span> npages <span class="token operator">*</span> PGSIZE<span class="token punctuation">;</span> a <span class="token operator">+=</span> PGSIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pte <span class="token operator">=</span> <span class="token function">walk</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token comment">// panic("uvmunmap: walk");</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token comment">// panic("uvmunmap: not mapped");</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PTE_FLAGS</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span> <span class="token operator">==</span> PTE_V<span class="token punctuation">)</span>            <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmunmap: not a leaf"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>do_free<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            uint64 pa <span class="token operator">=</span> <span class="token function">PTE2PA</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">kfree</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token operator">*</span>pte <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ€åè®©æˆ‘ä»¬æ¥çœ‹çœ‹ sys_munmapï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">min</span><span class="token expression"><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>uint64 <span class="token function">sys_munmap</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>f<span class="token punctuation">;</span>    uint64 addr<span class="token punctuation">;</span>    <span class="token keyword">int</span> len<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">proc</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>    <span class="token keyword">int</span> i<span class="token punctuation">;</span>    <span class="token function">argaddr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">argint</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>addr <span class="token operator">%</span> PGSIZE <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    p <span class="token operator">=</span> <span class="token function">myproc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// Find mmap corresponding to addr</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NMMAP<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>valid <span class="token operator">&amp;&amp;</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>st <span class="token operator">&lt;=</span> addr <span class="token operator">&amp;&amp;</span>            addr <span class="token operator">&lt;</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>st <span class="token operator">+</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            f <span class="token operator">=</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>f<span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> NMMAP<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// No mmap corresponding to addr</span>        <span class="token function">uvmunmap</span><span class="token punctuation">(</span>p<span class="token operator">-></span>pagetable<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> <span class="token function">PGROUNDUP</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span> <span class="token operator">/</span> PGSIZE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> MAP_SHARED<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mmap_wbk</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> <span class="token function">min</span><span class="token punctuation">(</span>len<span class="token punctuation">,</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>st <span class="token operator">+</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>len <span class="token operator">-</span> addr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span>            <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">uvmunmap</span><span class="token punctuation">(</span>p<span class="token operator">-></span>pagetable<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> <span class="token function">PGROUNDUP</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span> <span class="token operator">/</span> PGSIZE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>addr <span class="token operator">==</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>st <span class="token operator">&amp;&amp;</span> addr <span class="token operator">+</span> len <span class="token operator">==</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>st <span class="token operator">+</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>valid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token function">fileclose</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>addr <span class="token operator">==</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>st<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>st <span class="token operator">+=</span> <span class="token function">PGROUNDUP</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>        p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>len <span class="token operator">-=</span> <span class="token function">PGROUNDUP</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>        p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>off <span class="token operator">+=</span> <span class="token function">PGROUNDUP</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>addr <span class="token operator">+</span> len <span class="token operator">==</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>st <span class="token operator">+</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>len <span class="token operator">-=</span> <span class="token function">PGROUNDUP</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// No need to consider hole punching case in this lab</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å®ƒèƒ½é€šè¿‡æµ‹è¯•ä»£ç ï¼Œä¹Ÿç®—æ˜¯å¤Ÿç”¨äº†å§ğŸ« ğŸ« </p><h1 id="exit-å’Œ-fork"><a href="#exit-å’Œ-fork" class="headerlink" title="exit å’Œ fork"></a>exit å’Œ fork</h1><p>æœ‰äº† munmap çš„ç»éªŒï¼Œexit å‡½æ•°çš„ä¿®æ”¹å°±å¾ˆç®€å•äº†ã€‚æˆ‘æŠŠå…³é—­ mmap çš„ä»£ç æ”¾åœ¨äº†å…³é—­æ–‡ä»¶åé¢ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token keyword">int</span> status<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// ...</span>        <span class="token comment">// Close all open files.</span>    <span class="token comment">// ...</span>    <span class="token comment">// Close all mmaps</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NMMAP<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>valid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>f<span class="token punctuation">;</span>            uint64 addr<span class="token punctuation">;</span>            f <span class="token operator">=</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>f<span class="token punctuation">;</span>            addr <span class="token operator">=</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>st<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> MAP_SHARED<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mmap_wbk</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>len<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"mmap wbk failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> pg <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> pg <span class="token operator">*</span> PGSIZE <span class="token operator">&lt;</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>len<span class="token punctuation">;</span> pg<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">walkaddr</span><span class="token punctuation">(</span>p<span class="token operator">-></span>pagetable<span class="token punctuation">,</span> addr <span class="token operator">+</span> pg <span class="token operator">*</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token function">uvmunmap</span><span class="token punctuation">(</span>p<span class="token operator">-></span>pagetable<span class="token punctuation">,</span> addr <span class="token operator">+</span> pg <span class="token operator">*</span> PGSIZE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>            p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>valid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token function">fileclose</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// ...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è€Œ fork çš„ä¿®æ”¹ä¹Ÿä¸éš¾ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// ...</span>    <span class="token comment">// increment reference counts on open file descriptors.</span>    <span class="token comment">// ...</span>    <span class="token comment">// Copy mmap</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NMMAP<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>valid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            np<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> p<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token function">filedup</span><span class="token punctuation">(</span>np<span class="token operator">-></span>mmap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">safestrcpy</span><span class="token punctuation">(</span>np<span class="token operator">-></span>name<span class="token punctuation">,</span> p<span class="token operator">-></span>name<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>p<span class="token operator">-></span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// ...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å†è§äº†ï¼Œæ‰€æœ‰çš„ 6S081</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab9-mmap/goodbye.png" alt=""></p><p>å®Œç»“æ’’èŠ±ï¼Œæ„Ÿè°¢é™ªä¼´ï¼Bilibili å¹²æ¯ - ( ã‚œ- ã‚œ)ã¤ãƒ­[</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;img src=&quot;/images/learning/open-course/MIT-6.S081/labs/lab9-mmap/last.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;è¿™ä¸ª Lab è¦æ±‚æˆ‘ä»¬è¦å®ç°ç®€å•ç‰ˆçš„ mmapï¼Œå®ƒæŠŠæ–‡ä»¶æ˜ å°„åˆ°å†…å­˜ä¸­ä»¥æé«˜è®¿é—®æ•ˆç‡ã€‚mmap </summary>
      
    
    
    
    <category term="å…¬å¼€è¯¾" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/"/>
    
    <category term="MIT-6.S081" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/MIT-6-S081/"/>
    
    <category term="Labs" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/MIT-6-S081/Labs/"/>
    
    
  </entry>
  
  <entry>
    <title>Lab 8 File System</title>
    <link href="http://rinevard.github.io/wiki/learning/open-course/MIT-6.S081/Labs/lab8-fs/"/>
    <id>http://rinevard.github.io/wiki/learning/open-course/MIT-6.S081/Labs/lab8-fs/</id>
    <published>2025-12-03T15:01:11.000Z</published>
    <updated>2025-12-03T15:03:40.522Z</updated>
    
    <content type="html"><![CDATA[<p>æ„Ÿè§‰ xv6 çš„æ–‡ä»¶ç³»ç»Ÿè¿˜æ˜¯æŒºæœ‰æ·±åº¦çš„ã€‚è¿™ä¸ª lab å¸¦æˆ‘ä»¬ç®€å•å¤ä¹ äº†ä¸‹ inode å¦‚ä½•æŒ‡å‘ blocksï¼Œä»¥åŠé€šè¿‡è·¯å¾„åæŸ¥æ‰¾æ–‡ä»¶çš„æ–¹æ³•ã€‚</p><h1 id="Large-files"><a href="#Large-files" class="headerlink" title="Large files"></a>Large files</h1><p>è¿™é“é¢˜è®©æˆ‘ä»¬å¢å¤§ xv6 æœ€å¤§æ–‡ä»¶çš„å¤§å°ã€‚åŸæœ¬çš„ xv6 çš„æ¯ä¸ª inode æ”¯æŒ 12 ä¸ªæ™®é€šå—å’Œä¸€ä¸ªé—´æ¥å—ï¼Œé‚£ä¹ˆåŸæœ¬çš„æœ€å¤§æ–‡ä»¶å æ® 12 + 256 = 268 ä¸ªå—ã€‚æˆ‘ä»¬éœ€è¦æŠŠ inode ä¿®æ”¹ä¸ºæ”¯æŒ 11 ä¸ªæ™®é€šå—ã€ä¸€ä¸ªé—´æ¥å—ã€ä¸€ä¸ªåŒé‡é—´æ¥å—ï¼Œè¿™æ ·æœ€å¤§æ–‡ä»¶å°±èƒ½å æ® 11 + 256 + 256 * 256 = 65803 ä¸ªå—ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬è¦å» fs.h é‡Œä¿®æ”¹ dinode å’Œä¸€äº›å¸¸é‡çš„å®šä¹‰ï¼Œå†å» file.h é‡Œä¿®æ”¹ inode çš„å®šä¹‰ï¼Œä¸»è¦æ˜¯ä¿®æ”¹ addrsï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NDIRECT</span> <span class="token expression"><span class="token number">11</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NINDIRECT</span> <span class="token expression"><span class="token punctuation">(</span>BSIZE <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>uint<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NDOUBLYINDIRECT</span> <span class="token expression"><span class="token punctuation">(</span>NINDIRECT <span class="token operator">*</span> NINDIRECT<span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAXFILE</span> <span class="token expression"><span class="token punctuation">(</span>NDIRECT <span class="token operator">+</span> NINDIRECT <span class="token operator">+</span> NDOUBLYINDIRECT<span class="token punctuation">)</span></span></span><span class="token keyword">struct</span> <span class="token class-name">dinode</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// å…¶ä»–å†…å®¹ä¿æŒä¸å˜</span>    uint addrs<span class="token punctuation">[</span>NDIRECT <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// å…¶ä»–å†…å®¹ä¿æŒä¸å˜</span>    uint addrs<span class="token punctuation">[</span>NDIRECT <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶åæˆ‘ä»¬å¯ä»¥ç”»ä¸€ç”» ip-&gt;addrs çš„ç»“æ„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab8-fs/doub_indirect.png" alt=""></p><p>å¯¹ç»™å®šçš„ bnï¼Œå¦‚æœå®ƒåœ¨ $[0,11)$ ä¹‹é—´ï¼Œå°±æŸ¥æ‰¾æ™®é€šå—ï¼›å¦‚æœåœ¨ $[11,11+256)$ ä¹‹é—´ï¼Œå°±æŸ¥æ‰¾é—´æ¥å—ï¼›å¦‚æœåœ¨ $[11+256,256+256\times256)$ ä¹‹é—´ï¼Œå°±æŸ¥æ‰¾åŒé‡é—´æ¥å—ã€‚å†å‚è€ƒ bmap åŸæœ‰çš„ä»£ç å°±èƒ½å®Œæˆä¿®æ”¹äº†ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> uint <span class="token function">bmap</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>ip<span class="token punctuation">,</span> uint bn<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    uint addr<span class="token punctuation">,</span> <span class="token operator">*</span>a<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">buf</span> <span class="token operator">*</span>bp<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>bn <span class="token operator">&lt;</span> NDIRECT<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">=</span> ip<span class="token operator">-></span>addrs<span class="token punctuation">[</span>bn<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            addr <span class="token operator">=</span> <span class="token function">balloc</span><span class="token punctuation">(</span>ip<span class="token operator">-></span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>addr <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>            ip<span class="token operator">-></span>addrs<span class="token punctuation">[</span>bn<span class="token punctuation">]</span> <span class="token operator">=</span> addr<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> addr<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    bn <span class="token operator">-=</span> NDIRECT<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>bn <span class="token operator">&lt;</span> NINDIRECT<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// Load indirect block, allocating if necessary.</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">=</span> ip<span class="token operator">-></span>addrs<span class="token punctuation">[</span>NDIRECT<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            addr <span class="token operator">=</span> <span class="token function">balloc</span><span class="token punctuation">(</span>ip<span class="token operator">-></span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>addr <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>            ip<span class="token operator">-></span>addrs<span class="token punctuation">[</span>NDIRECT<span class="token punctuation">]</span> <span class="token operator">=</span> addr<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        bp <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>ip<span class="token operator">-></span>dev<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">;</span>        a <span class="token operator">=</span> <span class="token punctuation">(</span>uint <span class="token operator">*</span><span class="token punctuation">)</span>bp<span class="token operator">-></span>data<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">=</span> a<span class="token punctuation">[</span>bn<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            addr <span class="token operator">=</span> <span class="token function">balloc</span><span class="token punctuation">(</span>ip<span class="token operator">-></span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>addr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                a<span class="token punctuation">[</span>bn<span class="token punctuation">]</span> <span class="token operator">=</span> addr<span class="token punctuation">;</span>                <span class="token function">log_write</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">brelse</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> addr<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    bn <span class="token operator">-=</span> NINDIRECT<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>bn <span class="token operator">&lt;</span> NDOUBLYINDIRECT<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// Load doubly indirect block, allocating if necessary.</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">=</span> ip<span class="token operator">-></span>addrs<span class="token punctuation">[</span>NDIRECT <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            addr <span class="token operator">=</span> <span class="token function">balloc</span><span class="token punctuation">(</span>ip<span class="token operator">-></span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>addr <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>            ip<span class="token operator">-></span>addrs<span class="token punctuation">[</span>NDIRECT <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> addr<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// Load indirect block, allocating if necessary.</span>        bp <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>ip<span class="token operator">-></span>dev<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">;</span>        a <span class="token operator">=</span> <span class="token punctuation">(</span>uint <span class="token operator">*</span><span class="token punctuation">)</span>bp<span class="token operator">-></span>data<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">=</span> a<span class="token punctuation">[</span><span class="token punctuation">(</span>bn <span class="token operator">/</span> NINDIRECT<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            addr <span class="token operator">=</span> <span class="token function">balloc</span><span class="token punctuation">(</span>ip<span class="token operator">-></span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>addr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                a<span class="token punctuation">[</span><span class="token punctuation">(</span>bn <span class="token operator">/</span> NINDIRECT<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> addr<span class="token punctuation">;</span>                <span class="token function">log_write</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">brelse</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>addr <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// Find addr in block</span>        bp <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>ip<span class="token operator">-></span>dev<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">;</span>        a <span class="token operator">=</span> <span class="token punctuation">(</span>uint <span class="token operator">*</span><span class="token punctuation">)</span>bp<span class="token operator">-></span>data<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">=</span> a<span class="token punctuation">[</span>bn <span class="token operator">%</span> NINDIRECT<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            addr <span class="token operator">=</span> <span class="token function">balloc</span><span class="token punctuation">(</span>ip<span class="token operator">-></span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>addr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                a<span class="token punctuation">[</span>bn <span class="token operator">%</span> NINDIRECT<span class="token punctuation">]</span> <span class="token operator">=</span> addr<span class="token punctuation">;</span>                <span class="token function">log_write</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">brelse</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> addr<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"bmap: out of range"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä»¬è¿˜éœ€è¦ä¿®æ”¹ itruncï¼Œå®ƒé‡Šæ”¾ä¼ å…¥çš„ inode å ç”¨çš„æ‰€æœ‰æ•°æ®å—ã€‚ä»¿ç…§ itrunc åŸæœ‰çš„ä»£ç åŠ å…¥é‡Šæ”¾åŒé‡é—´æ¥å—çš„ä»£ç å°±è¡Œï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">itrunc</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>ip<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">buf</span> <span class="token operator">*</span>bp<span class="token punctuation">,</span> <span class="token operator">*</span>bbp<span class="token punctuation">;</span>    uint <span class="token operator">*</span>a<span class="token punctuation">,</span> <span class="token operator">*</span>aa<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NDIRECT<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>ip<span class="token operator">-></span>addrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">bfree</span><span class="token punctuation">(</span>ip<span class="token operator">-></span>dev<span class="token punctuation">,</span> ip<span class="token operator">-></span>addrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            ip<span class="token operator">-></span>addrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ip<span class="token operator">-></span>addrs<span class="token punctuation">[</span>NDIRECT<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        bp <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>ip<span class="token operator">-></span>dev<span class="token punctuation">,</span> ip<span class="token operator">-></span>addrs<span class="token punctuation">[</span>NDIRECT<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        a <span class="token operator">=</span> <span class="token punctuation">(</span>uint <span class="token operator">*</span><span class="token punctuation">)</span>bp<span class="token operator">-></span>data<span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> NINDIRECT<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span>                <span class="token function">bfree</span><span class="token punctuation">(</span>ip<span class="token operator">-></span>dev<span class="token punctuation">,</span> a<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">brelse</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">bfree</span><span class="token punctuation">(</span>ip<span class="token operator">-></span>dev<span class="token punctuation">,</span> ip<span class="token operator">-></span>addrs<span class="token punctuation">[</span>NDIRECT<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ip<span class="token operator">-></span>addrs<span class="token punctuation">[</span>NDIRECT<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ip<span class="token operator">-></span>addrs<span class="token punctuation">[</span>NDIRECT <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// Free doubly indirect block</span>        bp <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>ip<span class="token operator">-></span>dev<span class="token punctuation">,</span> ip<span class="token operator">-></span>addrs<span class="token punctuation">[</span>NDIRECT <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        a <span class="token operator">=</span> <span class="token punctuation">(</span>uint <span class="token operator">*</span><span class="token punctuation">)</span>bp<span class="token operator">-></span>data<span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> NINDIRECT<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// Free indirect block j</span>                bbp <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>ip<span class="token operator">-></span>dev<span class="token punctuation">,</span> a<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                aa <span class="token operator">=</span> <span class="token punctuation">(</span>uint <span class="token operator">*</span><span class="token punctuation">)</span>bbp<span class="token operator">-></span>data<span class="token punctuation">;</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span>k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> NINDIRECT<span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>aa<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span>                        <span class="token function">bfree</span><span class="token punctuation">(</span>ip<span class="token operator">-></span>dev<span class="token punctuation">,</span> aa<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token function">brelse</span><span class="token punctuation">(</span>bbp<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">bfree</span><span class="token punctuation">(</span>ip<span class="token operator">-></span>dev<span class="token punctuation">,</span> a<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">brelse</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">bfree</span><span class="token punctuation">(</span>ip<span class="token operator">-></span>dev<span class="token punctuation">,</span> ip<span class="token operator">-></span>addrs<span class="token punctuation">[</span>NDIRECT <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ip<span class="token operator">-></span>addrs<span class="token punctuation">[</span>NDIRECT <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    ip<span class="token operator">-></span>size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">iupdate</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="Symbolic-links"><a href="#Symbolic-links" class="headerlink" title="Symbolic links"></a>Symbolic links</h1><p>è¿™é“é¢˜è®©æˆ‘ä»¬ç»™ xv6 åŠ å…¥ç¬¦å·é“¾æ¥ï¼Œä¸è¿‡è¿™é‡Œçš„ç¬¦å·é“¾æ¥æ˜¯é’æ˜¥ç‰ˆã€‚ç¬¦å·é“¾æ¥æ­£ç»Ÿç‰ˆåº”è¯¥èƒ½æŒ‡å‘ç›®å½•ï¼Œæˆ‘ä»¬çš„åªèƒ½æŒ‡å‘æ–‡ä»¶ã€‚</p><p>è¿™é‡Œå°±ä¸æ”¾é…ç½®ç³»ç»Ÿè°ƒç”¨çš„ä»£ç äº†ï¼ˆå¤§å®¶éƒ½å·²ç»å“é‰´è¿‡æ— æ•°æ¬¡äº†ï¼‰ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹ man æ‰‹å†Œæ˜¯æ€ä¹ˆä»‹ç» symlink çš„ã€‚è¿™é‡Œæˆ‘ä»¬ä¸»è¦çœ‹ man 2 symlink å’Œ man 7 symlinkï¼Œå‰è€…æ˜¯ç»™ä½¿ç”¨è€…çœ‹çš„å‡½æ•°è¯´æ˜ï¼Œåè€…æ˜¯å‡½æ•°åŸç†ã€‚</p><p><a href="https://linux.die.net/man/2/symlink">symlink(2): make new name for file - Linux man page</a></p><p><a href="https://linux.die.net/man/7/symlink">symlink(7): symbolic link handling - Linux man page</a></p><p>symlink çš„ç­¾åæ˜¯ <code>int symlink(const char *oldpath, const char *newpath);</code>ï¼Œå®ƒåˆ›å»ºä¸€ä¸ªåä¸º newpath çš„æŒ‡å‘ oldpath çš„ç¬¦å·é“¾æ¥æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶é‡Œå­˜å‚¨ç€ oldpath è¿™ä¸ªå­—ç¬¦ä¸²ã€‚</p><p>å¯¹ç…§ hintï¼Œæˆ‘ä»¬çŸ¥é“è¦å» stat.h é‡Œæ–°å¢ä¸€ç§å«ä½œ T_SYMLINK çš„æ–‡ä»¶ç±»å‹ï¼Œè¿™å°±æ˜¯ç¬¦å·é“¾æ¥ç±»å‹ã€‚è‡³æ­¤æˆ‘ä»¬å°±èƒ½æ–°å¢ sys_symlink å‡½æ•°äº†ã€‚</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">uint64 <span class="token function">sys_symlink</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">char</span> old<span class="token punctuation">[</span>MAXPATH<span class="token punctuation">]</span><span class="token punctuation">,</span> new<span class="token punctuation">[</span>MAXPATH<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>ip<span class="token punctuation">;</span>    <span class="token keyword">int</span> len<span class="token punctuation">;</span>    <span class="token function">begin_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">argstr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> old<span class="token punctuation">,</span> MAXPATH<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">argstr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> new<span class="token punctuation">,</span> MAXPATH<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span>        <span class="token punctuation">(</span>ip <span class="token operator">=</span> <span class="token function">create</span><span class="token punctuation">(</span>new<span class="token punctuation">,</span> T_SYMLINK<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>old<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">writei</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span><span class="token operator">&amp;</span>len<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">writei</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>old<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">,</span> len <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">iunlockput</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä¸€å¼€å§‹å¯¹ iunlockã€iunlockput å¾ˆç–‘æƒ‘ï¼Œä¸»è¦æ˜¯ä¸çŸ¥é“ iput æœ‰ä»€ä¹ˆç”¨ã€‚å…¶å® iput å’Œ inode çš„å·¥ä½œæ–¹å¼å¯†åˆ‡ç›¸å…³ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥ç®€è¦åˆ†æä¸€ä¸‹ã€‚è¿™é‡Œæ¶‰åŠåˆ°çš„æ–‡ä»¶æ˜¯ fs.cã€‚</p><p>è€ƒè™‘åˆ°æˆ‘ä»¬åªèƒ½ç›´æ¥å’Œå†…å­˜äº¤äº’ï¼Œè€Œç£ç›˜ä¸Šåˆæœ‰å¾ˆå¤š inodeï¼Œæˆ‘ä»¬ä¼šæŠŠæœ‰äººåœ¨ç”¨çš„çš„ inode ä¿å­˜åœ¨ itable.inode ä¸­ï¼Œå¹¶ç”¨ inode.ref æ¥è®°å½•æœ‰å¤šå°‘äººåœ¨ç”¨ã€‚ç”¨å®Œçš„äººè¦è°ƒç”¨ iput è¯´è‡ªå·±ç”¨å®Œäº†ï¼Œè¿™æ · ref å°±ä¼šå‡å°‘ã€‚æœªæ¥æˆ‘ä»¬åœ¨æŠŠç£ç›˜ inode æ”¾åˆ°å†…å­˜ä¸­æ—¶ä¼šæ‰¾åˆ° ref == 0 çš„ä¸œè¥¿æ¥æ›¿æ¢ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œdirlookup æ‰¾è·¯å¾„å¯¹åº”çš„ inodeï¼Œè¿™ç§â€œæ‰¾â€æœ€ç»ˆæ€»ä¼šè°ƒç”¨ igetï¼Œiget ä¼šæ£€æŸ¥æƒ³æ‰¾çš„ inode åœ¨ä¸åœ¨å†…å­˜ä¸­çš„ itable.inode ä¸­ï¼Œå¦‚æœä¸åœ¨å°±åœ¨ itable.inode é‡Œæ‰¾ä¸ª ref == 0 çš„å…ƒç´ ï¼ŒæŠŠå®ƒæ›¿æ¢æˆæƒ³æ‰¾çš„ inode å¹¶è®¾ç½®å…¶ refã€‚ç›¸åº”åœ°ï¼Œè°ƒç”¨è€…åœ¨ç”¨å®Œ inode åè¦è´Ÿè´£è°ƒç”¨ iput è¯´è‡ªå·±ç”¨å®Œäº†ï¼Œä¸ç„¶ itable.inode çš„ç©ºé—´è¢«å æ»¡åå°±ä¸èƒ½åŠ è½½æ–°çš„ inode äº†ã€‚</p><p>æ‰€ä»¥åœ¨ sys_symlink çš„æœ«å°¾æˆ‘ä»¬è¦è°ƒç”¨ iunlockput è€Œä¸æ˜¯åªè°ƒç”¨ iunlockï¼Œæ¯•ç«Ÿæˆ‘ä»¬åœ¨ sys_symlink é‡Œä¸å†ä½¿ç”¨è¿™ä¸ª inode äº†ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ open å‡½æ•°ã€‚é¦–å…ˆç…§ç€ hint åœ¨ fcntl.h é‡ŒåŠ å…¥ O_NOFOLLOWï¼Œç„¶åå¯¹ç¬¦å·é“¾æ¥ç±»å‹çš„æ–‡ä»¶ï¼Œè¯»å–å…¶ path ç„¶åé¡ºè—¤æ‘¸ç“œå°±è¡Œï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">uint64 <span class="token function">sys_open</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">char</span> path<span class="token punctuation">[</span>MAXPATH<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> fd<span class="token punctuation">,</span> omode<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>f<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>ip<span class="token punctuation">;</span>    <span class="token keyword">int</span> n<span class="token punctuation">,</span> symcnt<span class="token punctuation">,</span> len<span class="token punctuation">;</span>    <span class="token function">argint</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>omode<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token function">argstr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> path<span class="token punctuation">,</span> MAXPATH<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token function">begin_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>omode <span class="token operator">&amp;</span> O_CREATE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        ip <span class="token operator">=</span> <span class="token function">create</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> T_FILE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>ip <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>omode <span class="token operator">&amp;</span> O_NOFOLLOW<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ip <span class="token operator">=</span> <span class="token function">namei</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">ilock</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>ip<span class="token operator">-></span>type <span class="token operator">==</span> T_DIR <span class="token operator">&amp;&amp;</span> omode <span class="token operator">!=</span> O_RDONLY<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">iunlockput</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        symcnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ip <span class="token operator">=</span> <span class="token function">namei</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">ilock</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>ip<span class="token operator">-></span>type <span class="token operator">==</span> T_SYMLINK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            symcnt<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>symcnt <span class="token operator">>=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">iunlockput</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token function">readi</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span><span class="token operator">&amp;</span>len<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">readi</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>path<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">,</span> len <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">iunlockput</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ip <span class="token operator">=</span> <span class="token function">namei</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token function">ilock</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>ip<span class="token operator">-></span>type <span class="token operator">==</span> T_DIR <span class="token operator">&amp;&amp;</span> omode <span class="token operator">!=</span> O_RDONLY<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">iunlockput</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ip<span class="token operator">-></span>type <span class="token operator">==</span> T_DEVICE <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>ip<span class="token operator">-></span>major <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> ip<span class="token operator">-></span>major <span class="token operator">>=</span> NDEV<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">iunlockput</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>f <span class="token operator">=</span> <span class="token function">filealloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span>fd <span class="token operator">=</span> <span class="token function">fdalloc</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span>            <span class="token function">fileclose</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">iunlockput</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ip<span class="token operator">-></span>type <span class="token operator">==</span> T_DEVICE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        f<span class="token operator">-></span>type <span class="token operator">=</span> FD_DEVICE<span class="token punctuation">;</span>        f<span class="token operator">-></span>major <span class="token operator">=</span> ip<span class="token operator">-></span>major<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        f<span class="token operator">-></span>type <span class="token operator">=</span> FD_INODE<span class="token punctuation">;</span>        f<span class="token operator">-></span>off <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    f<span class="token operator">-></span>ip <span class="token operator">=</span> ip<span class="token punctuation">;</span>    f<span class="token operator">-></span>readable <span class="token operator">=</span> <span class="token operator">!</span><span class="token punctuation">(</span>omode <span class="token operator">&amp;</span> O_WRONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>    f<span class="token operator">-></span>writable <span class="token operator">=</span> <span class="token punctuation">(</span>omode <span class="token operator">&amp;</span> O_WRONLY<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>omode <span class="token operator">&amp;</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>omode <span class="token operator">&amp;</span> O_TRUNC<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> ip<span class="token operator">-></span>type <span class="token operator">==</span> T_FILE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">itrunc</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">iunlock</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> fd<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é¡ºæä¸€å¥ï¼Œmake grade æ˜¾ç¤º Timeout FAIL å¯èƒ½æ˜¯å› ä¸ºåå°çš„è¿›ç¨‹å¤ªå¤šäº†å¯¼è‡´ CPU æ²¡æœ‰å…¨åŠ›ä»¥èµ´ã€‚å°½é‡æŠŠåˆ«çš„è¿›ç¨‹ï¼ˆæ¯”å¦‚æµè§ˆå™¨ï¼‰å…³æ‰åªä¿ç•™ä¸€ä¸ªåœ¨è·‘ make grade çš„ç»ˆç«¯ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;æ„Ÿè§‰ xv6 çš„æ–‡ä»¶ç³»ç»Ÿè¿˜æ˜¯æŒºæœ‰æ·±åº¦çš„ã€‚è¿™ä¸ª lab å¸¦æˆ‘ä»¬ç®€å•å¤ä¹ äº†ä¸‹ inode å¦‚ä½•æŒ‡å‘ blocksï¼Œä»¥åŠé€šè¿‡è·¯å¾„åæŸ¥æ‰¾æ–‡ä»¶çš„æ–¹æ³•ã€‚&lt;/p&gt;
&lt;h1 id=&quot;Large-files&quot;&gt;&lt;a href=&quot;#Large-files&quot; class=&quot;headerlink&quot;</summary>
      
    
    
    
    <category term="å…¬å¼€è¯¾" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/"/>
    
    <category term="MIT-6.S081" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/MIT-6-S081/"/>
    
    <category term="Labs" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/MIT-6-S081/Labs/"/>
    
    
  </entry>
  
  <entry>
    <title>Lab 7 Lock</title>
    <link href="http://rinevard.github.io/wiki/learning/open-course/MIT-6.S081/Labs/lab7-lock/"/>
    <id>http://rinevard.github.io/wiki/learning/open-course/MIT-6.S081/Labs/lab7-lock/</id>
    <published>2025-12-02T04:15:29.000Z</published>
    <updated>2025-12-02T04:15:32.298Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™ä¸ª lab è®©æˆ‘ä»¬ç†Ÿæ‚‰å¯¹é”çš„ä½¿ç”¨ã€‚é™¤äº† 2024 çš„é¢˜å¤–æˆ‘è¿˜é¡ºä¾¿åšäº†ä¸‹ 2025 æ–°å¢çš„è¯»å†™é”ï¼ˆ2025 å¹´ç”¨ Read-write lock æ¢æ‰äº† Buffer cacheï¼‰ï¼Œè®©æˆ‘ä»¬ä¾æ¬¡æ¥çœ‹çœ‹è¿™å‡ é“é¢˜ã€‚</p><h1 id="Memory-allocator"><a href="#Memory-allocator" class="headerlink" title="Memory allocator"></a>Memory allocator</h1><p>åœ¨ xv6 é‡Œï¼Œå¤šä¸ªè¿›ç¨‹åŒæ—¶å°è¯•æ–°å¢ / é‡Šæ”¾å†…å­˜æ—¶ä¼šåœ¨ kalloc.c çš„ kmem ä¸Šäº§ç”Ÿæ¿€çƒˆçš„é”ç«äº‰ï¼Œè¿™é“é¢˜è®©æˆ‘ä»¬ç»™æ¯ä¸ª CPU è®¾ç½®ä¸€ä¸ªè‡ªå·±çš„ç©ºé—²å—é“¾è¡¨æ¥ç¼“è§£ç«äº‰é—®é¢˜ã€‚æ¯”è¾ƒ tricky çš„åœ°æ–¹æ˜¯å½“ä¸€ä¸ª CPU çš„ç©ºé—²å—é“¾è¡¨ä¸ºç©ºæ—¶ï¼Œå®ƒè¦å»åˆ«çš„ CPU é‚£é‡Œå·ç©ºé—²å—ã€‚</p><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹æµ‹è¯•ä»£ç åœ¨åšä»€ä¹ˆå§ï¼Œå…ˆæ¥çœ‹çœ‹ test2ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> free0 <span class="token operator">=</span> <span class="token function">countfree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> free1<span class="token punctuation">;</span>    <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token punctuation">(</span>PHYSTOP <span class="token operator">-</span> KERNBASE<span class="token punctuation">)</span> <span class="token operator">/</span> PGSIZE<span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"start test2\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"total free number of pages: %d (out of %d)\n"</span><span class="token punctuation">,</span> free0<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> free0 <span class="token operator">></span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"test2 FAILED: cannot allocate enough memory"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">50</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        free1 <span class="token operator">=</span> <span class="token function">countfree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">==</span> <span class="token number">9</span><span class="token punctuation">)</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>free1 <span class="token operator">!=</span> free0<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"test2 FAIL: losing pages %d %d\n"</span><span class="token punctuation">,</span> free0<span class="token punctuation">,</span> free1<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\ntest2 OK\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œçš„ countfree å‡½æ•°åœ¨ sbrk å°½å¯èƒ½å¤šçš„å†…å­˜ï¼Œè®¡ç®—ä¸€å…±æ–°å¢äº†å¤šå°‘é¡µï¼Œç„¶åè¿”å›æ–°å¢çš„é¡µæ•°ã€‚å¯ä»¥çœ‹å‡º test2 å°±æ˜¯åœ¨æ£€æŸ¥åˆ†é… / é‡Šæ”¾å†…å­˜æ—¶æœ‰æ²¡æœ‰ä¸¢é¡µã€‚</p><p>test1 åˆ™æ›´å¤æ‚ä¸€äº›ã€‚å®ƒæŠŠå¤šè¿›ç¨‹ sbrk å‰åé”è‡ªæ—‹çš„æ€»æ¬¡æ•°å­˜åœ¨ m å’Œ n ä¸­å¹¶è®¡ç®— n - mã€‚å¦‚æœæˆ‘ä»¬çš„å®ç°è¾ƒå¥½ï¼Œé”å°±ä¼šè‡ªæ—‹è¾ƒå°‘ï¼Œå°±èƒ½é€šè¿‡ if (n - m &lt; 10) ç„¶åé€šè¿‡æµ‹è¯•ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> n<span class="token punctuation">,</span> m<span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"start test1\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    m <span class="token operator">=</span> <span class="token function">ntas</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// åˆ›å»º NCHILD ä¸ªå­è¿›ç¨‹å¹¶è®©ä»–ä»¬ä¸æ–­ sbrk</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NCHILD<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// ...</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">int</span> status <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NCHILD<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    n <span class="token operator">=</span> <span class="token function">ntas</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> m <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"test1 OK\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">else</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"test1 FAIL\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œçš„ ntas å¾ˆç¥å¥‡ï¼Œæˆ‘èŠ±äº†è›®é•¿æ—¶é—´æ‰å¼„æ˜ç™½å®ƒæ˜¯æ€ä¹ˆè·å–é”çš„è‡ªæ—‹æ¬¡æ•°çš„ã€‚æ„Ÿå…´è¶£çš„è¯å¯ä»¥çœ‹çœ‹ï¼Œä¸æ„Ÿå…´è¶£çš„è¯è®°ä½å®ƒæœ€ç»ˆå€ŸåŠ©äº† spinlock.c çš„ statslock æ¥è·å–é”çš„è‡ªæ—‹æ€»æ¬¡æ•°å°±è¡Œã€‚</p><p>é¦–å…ˆ ntas è°ƒç”¨äº† statisticsï¼Œçœ‹å‘ statistics.cï¼Œå®ƒåœ¨è¯»å– statistics æ–‡ä»¶ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">statistics</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">int</span> sz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> fd<span class="token punctuation">,</span> i<span class="token punctuation">,</span> n<span class="token punctuation">;</span>    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"statistics"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"stats: open failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> sz<span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf <span class="token operator">+</span> i<span class="token punctuation">,</span> sz <span class="token operator">-</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        i <span class="token operator">+=</span> n<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> i<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é‚£ statistics æ–‡ä»¶åœ¨å“ªå‘¢ï¼Ÿstatistics æ–‡ä»¶åœ¨ init.c é‡Œè¢«åˆå§‹åŒ–ã€‚æˆ‘ä»¬åœ¨å†…æ ¸çš„ stats.c çš„ statsinit é‡Œåˆå§‹åŒ–äº† STATSï¼ŒæŠŠå¯¹å®ƒçš„è¯»è®¾ç½®ä¸ºè°ƒç”¨ statsreadï¼Œå¹¶åœ¨ statsread é‡Œè°ƒç”¨ spinlock.c é‡Œçš„ statslock. æ³¨æ„è¿™é‡Œæœ‰å†…æ ¸çš„ stats.c å’Œç”¨æˆ·çš„ stats.cï¼Œæˆ‘ä»¬è¯´çš„æ˜¯å‰è€…ã€‚</p><p>æ€»ä¹‹ statistics å‡½æ•°ä¼šè¯»å– statisticsï¼Œå¯¹ statistics çš„è¯»ä¼šè°ƒç”¨ statsreadï¼Œstatsread åœ¨ statistics è¢«è¯»å®Œåä¼šè°ƒç”¨ statslock æ¥æ›´æ–°å†…å®¹ã€‚</p><p>æˆ‘ä»¬å½“ç„¶ä¼šé—®ä¸ºä»€ä¹ˆè¦ç»•è¿™ä¹ˆå¤§ä¸€åœˆï¼Œç›´æ¥è¯»spinlock.cé‡Œçš„ä¸œè¥¿ä¸è¡Œå—ï¼Ÿè¿™æ˜¯å› ä¸ºç”¨æˆ·å’Œå†…æ ¸æœ‰éš”ç¦»ã€‚statistics æ˜¯ç”¨æˆ·æ€çš„å‡½æ•°ï¼Œä¸èƒ½ä¹Ÿä¸åº”è¯¥ç›´æ¥è¯»å†…æ ¸çš„ spinlock.c é‡Œçš„æ•°æ®ã€‚</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab7-lock/user_kernel.png" alt=""></p><p>test3 åˆ™æ˜¯ test1 å’Œ test2 çš„æ•´åˆé«˜æ¸…é‡åˆ¶è±ªååŠ å¼ºç‰ˆã€‚æˆ‘çš„ä»£ç èƒ½é€šè¿‡ 2023 å¹´å’Œ 2025 å¹´ç‰ˆæœ¬çš„å®Œæ•´æµ‹è¯•ï¼Œä½†ä¸èƒ½ç¨³å®šé€šè¿‡ 2024 ç‰ˆæœ¬çš„ test3ï¼ˆå¤§éƒ¨åˆ†æ—¶é—´è¿‡ä¸äº†ï¼Œè¿æ°”å¥½èƒ½è¿‡ï¼‰ã€‚</p><p>2023 å¹´çš„ç‰ˆæœ¬æ²¡æœ‰è¿™ç§æ•´åˆæµ‹è¯•ï¼Œ2025 å¹´çš„ç‰ˆæœ¬å†™çš„æ˜¯ n-m &lt; (NCHILD4-1)*10000ï¼Œæ„Ÿè§‰ 2025 æ¯” 2024 çš„æµ‹è¯•æ›´åˆç†ï¼Œé‚£å°±è®¤ä¸ºæˆ‘çš„ä»£ç å·²ç»æ»¡è¶³è¦æ±‚äº†å§ã€‚</p><p>ç„¶åæˆ‘ä»¬ä¸Šä»£ç ã€‚å…ˆæ”¾åœ¨åˆå§‹åŒ–çš„éƒ¨åˆ†å’Œ kfreeï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">spinlock</span> lock<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">run</span> <span class="token operator">*</span>freelist<span class="token punctuation">;</span><span class="token punctuation">&#125;</span> kmems<span class="token punctuation">[</span>NCPU<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">char</span> kmemlockname<span class="token punctuation">[</span>NCPU<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token keyword">int</span> STOLEN_NUM <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">kinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ncpu<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">snprintf</span><span class="token punctuation">(</span>kmemlockname<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>kmemlockname<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"kmem_%d"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">initlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmems<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">,</span> kmemlockname<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">freerange</span><span class="token punctuation">(</span>end<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>PHYSTOP<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">freerange</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>pa_start<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>pa_end<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>    p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">PGROUNDUP</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>pa_start<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> p <span class="token operator">+</span> PGSIZE <span class="token operator">&lt;=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa_end<span class="token punctuation">;</span> p <span class="token operator">+=</span> PGSIZE<span class="token punctuation">)</span>        <span class="token function">kfree</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">kfree</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>pa<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">run</span> <span class="token operator">*</span>r<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>pa <span class="token operator">%</span> PGSIZE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa <span class="token operator">&lt;</span> end <span class="token operator">||</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>pa <span class="token operator">>=</span> PHYSTOP<span class="token punctuation">)</span>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"kfree"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// Fill with junk to catch dangling refs.</span>    <span class="token function">memset</span><span class="token punctuation">(</span>pa<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>    r <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">run</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa<span class="token punctuation">;</span>    <span class="token function">push_off</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> id <span class="token operator">=</span> <span class="token function">cpuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmems<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    r<span class="token operator">-></span>next <span class="token operator">=</span> kmems<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>freelist<span class="token punctuation">;</span>    kmems<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>freelist <span class="token operator">=</span> r<span class="token punctuation">;</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmems<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">pop_off</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä»£ç æ€è·¯å¾ˆæ¸…æ™°ï¼Œæ¯ä¸ª CPU ä¸€ä¸ªè‡ªå·±çš„ç©ºé—²é“¾è¡¨ï¼Œkfree æŠŠé‡Šæ”¾æ‰çš„å—åŠ åˆ°å½“å‰ CPU çš„é“¾è¡¨ä¸Šã€‚</p><p>æˆ‘è¿˜è¯•äº†ä¸‹åœ¨ kinit ç»“å°¾æ‰“å°å‡ºæ¯ä¸ª CPU çš„ç©ºé—²å—é“¾è¡¨é•¿åº¦ï¼Œç„¶åå‘ç°æ‰€æœ‰çš„ç©ºé—²å—éƒ½åœ¨ä¸€ä¸ª CPU é‚£é‡Œã€‚åŸæœ¬æˆ‘è¿˜ä»¥ä¸º freerange çš„è¿‡ç¨‹ä¸­æ¯ä¸ª CPU éƒ½ä¼šè·‘ä¸€è·‘ kfreeï¼Œç„¶åè®©ç©ºé—²å—å‡åŒ€åˆ†å¸ƒåœ¨å„ä¸ª CPU ä¸Šå‘¢ã€‚</p><p>ç„¶åæˆ‘ä»¬çœ‹çœ‹ kallocï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">kalloc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// We can consistently pass the 2025 tests, but occasionally fail the 2024</span>    <span class="token comment">// test3. I think this is good enough, so we won't continue further.</span>    <span class="token keyword">struct</span> <span class="token class-name">run</span> <span class="token operator">*</span>r<span class="token punctuation">;</span>    <span class="token function">push_off</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> id <span class="token operator">=</span> <span class="token function">cpuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmems<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    r <span class="token operator">=</span> kmems<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>freelist<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        kmems<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>freelist <span class="token operator">=</span> r<span class="token operator">-></span>next<span class="token punctuation">;</span>        <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmems<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// There isn't a fixed acquire order for CPU locks</span>        <span class="token comment">// so release the lock before acquiring other locks to avoid deadlock</span>        <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmems<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">struct</span> <span class="token class-name">run</span> <span class="token operator">*</span>stolen_head <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">struct</span> <span class="token class-name">run</span> <span class="token operator">*</span>stolen_end <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token comment">// Steal STOLEN_NUM pages from another CPU's free list</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token punctuation">(</span>id <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">+</span> ncpu<span class="token punctuation">)</span> <span class="token operator">%</span> ncpu<span class="token punctuation">;</span> i <span class="token operator">!=</span> id<span class="token punctuation">;</span>             i <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">+</span> ncpu<span class="token punctuation">)</span> <span class="token operator">%</span> ncpu<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmems<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>kmems<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>freelist<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmems<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            stolen_head <span class="token operator">=</span> kmems<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>freelist<span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">(</span>kmems<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>freelist<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>cnt <span class="token operator">&lt;</span> STOLEN_NUM<span class="token punctuation">)</span><span class="token punctuation">;</span>                 cnt<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                stolen_end <span class="token operator">=</span> kmems<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>freelist<span class="token punctuation">;</span>                kmems<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>freelist <span class="token operator">=</span> stolen_end<span class="token operator">-></span>next<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            stolen_end<span class="token operator">-></span>next <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmems<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>stolen_head<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmems<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>            stolen_end<span class="token operator">-></span>next <span class="token operator">=</span> kmems<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>freelist<span class="token punctuation">;</span>            kmems<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>freelist <span class="token operator">=</span> stolen_head<span class="token punctuation">;</span>            r <span class="token operator">=</span> kmems<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>freelist<span class="token punctuation">;</span>            kmems<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>freelist <span class="token operator">=</span> r<span class="token operator">-></span>next<span class="token punctuation">;</span>            <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmems<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">pop_off</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">)</span>        <span class="token function">memset</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>r<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// fill with junk</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>r<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œæ¯”è¾ƒ trickky çš„å°±æ˜¯ else é‡Œçªƒå–åˆ«çš„ CPU çš„å—çš„éƒ¨åˆ†ã€‚é¦–å…ˆå¦‚æˆ‘çš„æ³¨é‡Šæ‰€è¨€ï¼Œå„ä¸ª CPU çš„ kmem lock æ²¡æœ‰å›ºå®šçš„è·å–é¡ºåºï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å…ˆé‡Šæ”¾è‡ªå·±çš„ kmem lock å†å¼€å·ï¼Œä¿è¯åŒä¸€æ—¶é—´åªæ‹¿ç€ä¸€ä¸ª CPU çš„ kmem lockï¼Œä¸ç„¶æœ‰æ­»é”é£é™©ã€‚</p><p>ç„¶åæˆ‘ä»¬ä»å½“å‰ CPU å¼€å§‹å¾€åéå†ï¼Œæ‰¾åˆ°åˆé€‚çš„ CPU ä»¥åå°±æŠ“å®ƒçš„é”ç„¶åå· STOLEN_NUM ä¸ªå—æš‚å­˜åœ¨ stolen_head è¿™ä¸ªé“¾è¡¨é‡Œï¼Œå·å®Œä»¥åé‡Šæ”¾å®ƒçš„é”å¹¶æŠ“è‡ªå·±çš„é”å†æŠŠé“¾è¡¨æ¥åˆ°è‡ªå·±å¤´ä¸Šã€‚</p><p>è¿™æ ·ä¸€æ¥çªƒå–å’Œæ–°å¢å—éƒ½æ˜¯åŸå­æ€§çš„ï¼Œä¸ä¼šæœ‰å¹¶å‘é—®é¢˜ã€‚</p><p>æˆ‘æµ‹å‡ºæ¥è®¾ç½® STOLEN_NUM ä¸º 1 æˆ– 8 æ—¶æ•ˆæœæœ€å¥½ï¼Œæ›´å¤§åè€Œæ•ˆæœæ¬ ä½³ï¼ŒæŒºç¥å¥‡çš„ã€‚</p><h1 id="Buffer-cache"><a href="#Buffer-cache" class="headerlink" title="Buffer cache"></a>Buffer cache</h1><p>æ–‡ä»¶ç³»ç»Ÿçš„ç¼“å­˜å±‚ä¹Ÿæœ‰ä¸€ä¸ªè¾ƒæ¿€çƒˆçš„é”ç«äº‰ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æŠŠç¼“å­˜é“¾è¡¨æ‹†åˆ†æˆè‹¥å¹²ä¸ªå°çš„é“¾è¡¨ï¼Œç»™æ¯ä¸ªé“¾è¡¨è®¾ç½®å•ç‹¬çš„é”æ¥ç¼“è§£ç«äº‰ã€‚</p><p>é‚£ä¹ˆæ€ä¹ˆæ‹†åˆ†é“¾è¡¨å‘¢ï¼Ÿæˆ‘ä»¬çŸ¥é“æ¯ä¸ª block æœ‰ blocknoï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥æŠŠ block æ”¾åˆ°ç¼–å·ä¸º hash(blockno) çš„é“¾è¡¨ä¸­ã€‚åŸºæœ¬æ€è·¯å°±æ˜¯è¿™æ ·ï¼Œæ¥ä¸‹æ¥çœ‹ä»£ç å§ï¼Œé¦–å…ˆæ˜¯åˆå§‹åŒ–éƒ¨åˆ†ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BUCKET_SIZE</span> <span class="token expression"><span class="token number">13</span></span></span><span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">spinlock</span>        steal_lock<span class="token punctuation">;</span> <span class="token comment">// steal lock, only one process is stealing at a time</span>    <span class="token keyword">struct</span> <span class="token class-name">buf</span> buf<span class="token punctuation">[</span>NBUF<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">buf</span> head<span class="token punctuation">;</span><span class="token punctuation">&#125;</span> bcache<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">spinlock</span> lock<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">buf</span> head<span class="token punctuation">;</span><span class="token punctuation">&#125;</span> buckets<span class="token punctuation">[</span>BUCKET_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>uint <span class="token function">hash</span><span class="token punctuation">(</span>uint blockno<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> blockno <span class="token operator">%</span> BUCKET_SIZE<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">binit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">buf</span> <span class="token operator">*</span>b<span class="token punctuation">;</span>    <span class="token function">initlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>steal_lock<span class="token punctuation">,</span> <span class="token string">"bcache"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> BUCKET_SIZE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">initlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">,</span> <span class="token string">"bcache.bucket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// Put all buffers into bucket[0] initially</span>    <span class="token keyword">struct</span> <span class="token class-name">buf</span> <span class="token operator">*</span>cur<span class="token punctuation">;</span>    cur <span class="token operator">=</span> <span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>head<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>b <span class="token operator">=</span> bcache<span class="token punctuation">.</span>buf<span class="token punctuation">;</span> b <span class="token operator">&lt;</span> bcache<span class="token punctuation">.</span>buf <span class="token operator">+</span> NBUF<span class="token punctuation">;</span> b<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        cur<span class="token operator">-></span>next <span class="token operator">=</span> b<span class="token punctuation">;</span>        b<span class="token operator">-></span>prev <span class="token operator">=</span> cur<span class="token punctuation">;</span>        <span class="token function">initsleeplock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token operator">-></span>lock<span class="token punctuation">,</span> <span class="token string">"buffer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        cur <span class="token operator">=</span> b<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œä¸»è¦æ˜¯å¯¹é“¾è¡¨åšäº†ä¸‹æ‹†åˆ†ã€‚è¿™é‡Œçš„ steal_lock å’Œæ¥ä¸‹æ¥çš„ bget ç›¸å…³ï¼Œä¸»è¦æ˜¯ä¸ºäº†é˜²æ­¢ä¸‹é¢è¿™ç§æƒ…å†µï¼š</p><ol><li>è¿›ç¨‹ A å’Œè¿›ç¨‹ B éƒ½åœ¨è¯·æ±‚ blocknoï¼Œæˆ‘ä»¬ä»¤ dest = hash(blockno)</li><li>è¿›ç¨‹ A å’Œ B éƒ½æ²¡åœ¨ buckets[dest] æ‰¾åˆ°å—ï¼Œå¼€å§‹çªƒå–ã€‚</li><li>è¿›ç¨‹ B æ¯” A å…ˆçªƒå–åˆ°äº†ä¸€ä¸ªç©ºé—²å—ï¼ŒæŠŠå®ƒæ”¾è¿›äº† buckets[dest] å¹¶å¡«å…¥äº†æ•°æ®ã€‚</li><li>è¿›ç¨‹ A ä¹Ÿæ‰¾åˆ°äº†ä¸€ä¸ªç©ºé—²å—å¹¶æŠŠå®ƒæ”¾å…¥ buckets[dest] å¹¶å¡«å…¥æ•°æ®ã€‚</li><li>è¿™ä¼šå¯¼è‡´ä¸¤ä¸ª buf æœ‰ç›¸åŒçš„ blocknoï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚</li></ol><p>è¿™é‡Œçš„ steal_lock ä¿è¯åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªè¿›ç¨‹åœ¨è¯•å›¾çªƒå–åˆ«çš„ bucket çš„ buf. é…åˆåœ¨çªƒå–å‰å†æ¬¡æ£€æŸ¥ä¸€é bucket[dest] å°±èƒ½é¿å…ä¸Šè¿°æƒ…å†µçš„å‘ç”Ÿã€‚</p><p>æˆ‘ä»¬ç°åœ¨æ¥çœ‹çœ‹ bgetï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">buf</span> <span class="token operator">*</span><span class="token function">bget</span><span class="token punctuation">(</span>uint dev<span class="token punctuation">,</span> uint blockno<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">buf</span> <span class="token operator">*</span>b<span class="token punctuation">;</span>    uint dest <span class="token operator">=</span> <span class="token function">hash</span><span class="token punctuation">(</span>blockno<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>dest<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// Is the block already cached?</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>b <span class="token operator">=</span> buckets<span class="token punctuation">[</span>dest<span class="token punctuation">]</span><span class="token punctuation">.</span>head<span class="token punctuation">.</span>next<span class="token punctuation">;</span> b<span class="token punctuation">;</span> b <span class="token operator">=</span> b<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token operator">-></span>dev <span class="token operator">==</span> dev <span class="token operator">&amp;&amp;</span> b<span class="token operator">-></span>blockno <span class="token operator">==</span> blockno<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            b<span class="token operator">-></span>refcnt<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>dest<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">acquiresleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> b<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// --------------------ä¸‹é¢æ˜¯çªƒå–ä»£ç --------------------</span>    <span class="token comment">// Not cached.</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>dest<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>steal_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>dest<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// double check, other process might have stolen before we steal</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>b <span class="token operator">=</span> buckets<span class="token punctuation">[</span>dest<span class="token punctuation">]</span><span class="token punctuation">.</span>head<span class="token punctuation">.</span>next<span class="token punctuation">;</span> b<span class="token punctuation">;</span> b <span class="token operator">=</span> b<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token operator">-></span>dev <span class="token operator">==</span> dev <span class="token operator">&amp;&amp;</span> b<span class="token operator">-></span>blockno <span class="token operator">==</span> blockno<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            b<span class="token operator">-></span>refcnt<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>dest<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>steal_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">acquiresleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> b<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>dest<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// steal from another bucket</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> BUCKET_SIZE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// iterate through bucket to find a free buf</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>b <span class="token operator">=</span> buckets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>head<span class="token punctuation">.</span>next<span class="token punctuation">;</span> b<span class="token punctuation">;</span> b <span class="token operator">=</span> b<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token operator">-></span>refcnt <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// remove b from orig bucket</span>                b<span class="token operator">-></span>prev<span class="token operator">-></span>next <span class="token operator">=</span> b<span class="token operator">-></span>next<span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    b<span class="token operator">-></span>next<span class="token operator">-></span>prev <span class="token operator">=</span> b<span class="token operator">-></span>prev<span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                b<span class="token operator">-></span>prev <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                b<span class="token operator">-></span>next <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// put b into dest bucket</span>                <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>dest<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>                b<span class="token operator">-></span>prev <span class="token operator">=</span> <span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>dest<span class="token punctuation">]</span><span class="token punctuation">.</span>head<span class="token punctuation">;</span>                b<span class="token operator">-></span>next <span class="token operator">=</span> buckets<span class="token punctuation">[</span>dest<span class="token punctuation">]</span><span class="token punctuation">.</span>head<span class="token punctuation">.</span>next<span class="token punctuation">;</span>                b<span class="token operator">-></span>prev<span class="token operator">-></span>next <span class="token operator">=</span> b<span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    b<span class="token operator">-></span>next<span class="token operator">-></span>prev <span class="token operator">=</span> b<span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                b<span class="token operator">-></span>dev <span class="token operator">=</span> dev<span class="token punctuation">;</span>                b<span class="token operator">-></span>blockno <span class="token operator">=</span> blockno<span class="token punctuation">;</span>                b<span class="token operator">-></span>valid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                b<span class="token operator">-></span>refcnt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>                <span class="token function">acquiresleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>dest<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>steal_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> b<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"bget: no buffers"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¹Ÿæœ‰ä¸åŠ  steal_lock çš„å†™æ³•ï¼Œå¯ä»¥åœ¨å¡«å…¥æ•°æ®å‰æ£€æŸ¥ buckets[dest] ä¸­æ˜¯å¦æœ‰ blockno å¯¹åº”çš„ bufï¼Œå¦‚æœæœ‰å°±ä¸å¡«æ•°æ®è€Œæ˜¯æŠŠç©ºå—åŠ å…¥ buckets[dest]ï¼Œå¦‚æœæ²¡æœ‰å†å¡«æ•°æ®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">buf</span> <span class="token operator">*</span><span class="token function">bget</span><span class="token punctuation">(</span>uint dev<span class="token punctuation">,</span> uint blockno<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">buf</span> <span class="token operator">*</span>b<span class="token punctuation">;</span>    uint dest <span class="token operator">=</span> <span class="token function">hash</span><span class="token punctuation">(</span>blockno<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>dest<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// Is the block already cached?</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>b <span class="token operator">=</span> buckets<span class="token punctuation">[</span>dest<span class="token punctuation">]</span><span class="token punctuation">.</span>head<span class="token punctuation">.</span>next<span class="token punctuation">;</span> b<span class="token punctuation">;</span> b <span class="token operator">=</span> b<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token operator">-></span>dev <span class="token operator">==</span> dev <span class="token operator">&amp;&amp;</span> b<span class="token operator">-></span>blockno <span class="token operator">==</span> blockno<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            b<span class="token operator">-></span>refcnt<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>dest<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">acquiresleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> b<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// Not cached.</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>dest<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// steal from another bucket</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> BUCKET_SIZE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// iterate through bucket to find a free buf</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>b <span class="token operator">=</span> buckets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>head<span class="token punctuation">.</span>next<span class="token punctuation">;</span> b<span class="token punctuation">;</span> b <span class="token operator">=</span> b<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token operator">-></span>refcnt <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// remove b from orig bucket</span>                b<span class="token operator">-></span>prev<span class="token operator">-></span>next <span class="token operator">=</span> b<span class="token operator">-></span>next<span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    b<span class="token operator">-></span>next<span class="token operator">-></span>prev <span class="token operator">=</span> b<span class="token operator">-></span>prev<span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                b<span class="token operator">-></span>prev <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                b<span class="token operator">-></span>next <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// put b into dest bucket</span>                <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>dest<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>                b<span class="token operator">-></span>prev <span class="token operator">=</span> <span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>dest<span class="token punctuation">]</span><span class="token punctuation">.</span>head<span class="token punctuation">;</span>                b<span class="token operator">-></span>next <span class="token operator">=</span> buckets<span class="token punctuation">[</span>dest<span class="token punctuation">]</span><span class="token punctuation">.</span>head<span class="token punctuation">.</span>next<span class="token punctuation">;</span>                b<span class="token operator">-></span>prev<span class="token operator">-></span>next <span class="token operator">=</span> b<span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    b<span class="token operator">-></span>next<span class="token operator">-></span>prev <span class="token operator">=</span> b<span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token comment">// double check, other process might have stolen before we steal</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">buf</span> <span class="token operator">*</span>check <span class="token operator">=</span> buckets<span class="token punctuation">[</span>dest<span class="token punctuation">]</span><span class="token punctuation">.</span>head<span class="token punctuation">.</span>next<span class="token punctuation">;</span> check<span class="token punctuation">;</span>                     check <span class="token operator">=</span> check<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>check<span class="token operator">-></span>dev <span class="token operator">==</span> dev <span class="token operator">&amp;&amp;</span> check<span class="token operator">-></span>blockno <span class="token operator">==</span> blockno<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                        check<span class="token operator">-></span>refcnt<span class="token operator">++</span><span class="token punctuation">;</span>                        <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>dest<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token function">acquiresleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>check<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">return</span> check<span class="token punctuation">;</span>                    <span class="token punctuation">&#125;</span>                <span class="token punctuation">&#125;</span>                b<span class="token operator">-></span>dev <span class="token operator">=</span> dev<span class="token punctuation">;</span>                b<span class="token operator">-></span>blockno <span class="token operator">=</span> blockno<span class="token punctuation">;</span>                b<span class="token operator">-></span>valid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                b<span class="token operator">-></span>refcnt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>                <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>dest<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">acquiresleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> b<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"bget: no buffers"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ€åå‡ ä¸ªè¦æ”¹çš„å‡½æ•°æŠŠåŸæœ¬çš„é”æ¢æˆ bucket çš„é”å°±å¯ä»¥äº†ã€‚</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">brelse</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">buf</span> <span class="token operator">*</span>b<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">holdingsleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"brelse"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">releasesleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    uint idx <span class="token operator">=</span> <span class="token function">hash</span><span class="token punctuation">(</span>b<span class="token operator">-></span>blockno<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    b<span class="token operator">-></span>refcnt<span class="token operator">--</span><span class="token punctuation">;</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">bpin</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">buf</span> <span class="token operator">*</span>b<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    uint idx <span class="token operator">=</span> <span class="token function">hash</span><span class="token punctuation">(</span>b<span class="token operator">-></span>blockno<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    b<span class="token operator">-></span>refcnt<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">bunpin</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">buf</span> <span class="token operator">*</span>b<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    uint idx <span class="token operator">=</span> <span class="token function">hash</span><span class="token punctuation">(</span>b<span class="token operator">-></span>blockno<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    b<span class="token operator">-></span>refcnt<span class="token operator">--</span><span class="token punctuation">;</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buckets<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="Read-write-lock"><a href="#Read-write-lock" class="headerlink" title="Read-write lock"></a>Read-write lock</h1><p>æˆ‘è¿˜æŠ½ç©ºåšäº†ä¸‹ 2025 ç‰ˆæœ¬æ–°å¢çš„ Read-write lockï¼Œè¿™è¦æ±‚æˆ‘ä»¬å®ç°ä¸€ä¸ªè¯»å†™é”ã€‚è¯»å†™é”æŠŠç”¨æˆ·åˆ†ä¸ºè¯»è€…å’Œå†™è€…ï¼ŒåŒä¸€æ—¶é—´å¯ä»¥æœ‰å¤šä¸ªè¯»è€…æˆ–ä¸€ä¸ªå†™è€…æŒæœ‰è¯»å†™é”ã€‚å¦å¤–åœ¨è¿™é“é¢˜é‡Œï¼Œå¦‚æœè¯»è€…å’Œå†™è€…åŒæ—¶åœ¨ç­‰å¾…ï¼Œå†™è€…ä¼˜å…ˆæŒé”ã€‚</p><p>æˆ‘çš„å®ç°æ€è·¯è¿˜æ˜¯æ¯”è¾ƒæœ´ç´ çš„ï¼Œæˆ‘ä»¬å…ˆçœ‹æ•°æ®ç»“æ„å§ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">rwspinlock</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">spinlock</span> l<span class="token punctuation">;</span>    <span class="token keyword">int</span> readers<span class="token punctuation">;</span>    <span class="token keyword">int</span> writer_active<span class="token punctuation">;</span> <span class="token comment">// 0 or 1</span>    <span class="token keyword">int</span> waiting_writers<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¯»è€…ä»…åœ¨æ²¡æœ‰å†™è€…æŒé”ä¸”æ²¡æœ‰å†™è€…åœ¨ç­‰å¾…æ—¶æ‰èƒ½æŒé”ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ writer_active å’Œ waiting_writers ä¸¤ä¸ªå­—æ®µï¼›å†™è€…ä»…åœ¨æ²¡æœ‰åˆ«çš„å†™è€…æŒé”ä¸”æ²¡æœ‰è¯»è€…æŒé”æ—¶æ‰èƒ½æŒé”ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿéœ€è¦ readers å­—æ®µã€‚è¿™é‡Œçš„ spinlock åˆ™æ˜¯ä¸ºäº†ä¿æŠ¤è¿™äº›å…±äº«æ•°æ®ã€‚</p><p>å…¶å®ä¹Ÿå¯ä»¥ä¸ç”¨ spinlock è€Œå…¨ç”¨åŸå­è¯­å¥å†™ï¼Œä½†æˆ‘æ„Ÿè§‰å¤ªéš¾äº†å°±æ²¡è¿™ä¹ˆåšã€‚</p><p>å‡½æ•°çš„å®ç°æ€è·¯ä¹Ÿæ¯”è¾ƒæœ´ç´ ï¼Œå¯ä»¥ç›´æ¥çœ‹ä»£ç ã€‚è¦æ³¨æ„æˆ‘ä»¬è¢«è¦æ±‚å®ç°è‡ªæ—‹ç‰ˆæœ¬çš„è¯»å†™é”ï¼Œæ‰€ä»¥åœ¨ acquire çš„æ¡ä»¶ä¸æ»¡è¶³æ—¶æˆ‘ä»¬ä¸èƒ½ sleepï¼Œè€Œåº”é‡Šæ”¾é”ç„¶åä¸æ–­å¾ªç¯ã€‚</p><p>ç°å®é‡Œä¹Ÿå­˜åœ¨ç¡çœ ç‰ˆæœ¬çš„è¯»å†™é”ï¼Œä¸è¿‡è¿™å’Œæˆ‘ä»¬çš„ lab æ²¡å…³ç³»ã€‚</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">read_acquire_inner</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">rwspinlock</span> <span class="token operator">*</span>rwlk<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlk<span class="token operator">-></span>l<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>rwlk<span class="token operator">-></span>writer_active <span class="token operator">||</span> rwlk<span class="token operator">-></span>waiting_writers <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlk<span class="token operator">-></span>l<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">continue</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    rwlk<span class="token operator">-></span>readers<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlk<span class="token operator">-></span>l<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">read_release_inner</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">rwspinlock</span> <span class="token operator">*</span>rwlk<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlk<span class="token operator">-></span>l<span class="token punctuation">)</span><span class="token punctuation">;</span>  rwlk<span class="token operator">-></span>readers<span class="token operator">--</span><span class="token punctuation">;</span>  <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlk<span class="token operator">-></span>l<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">write_acquire_inner</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">rwspinlock</span> <span class="token operator">*</span>rwlk<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlk<span class="token operator">-></span>l<span class="token punctuation">)</span><span class="token punctuation">;</span>  rwlk<span class="token operator">-></span>waiting_writers<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlk<span class="token operator">-></span>l<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlk<span class="token operator">-></span>l<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>rwlk<span class="token operator">-></span>readers <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">||</span> rwlk<span class="token operator">-></span>writer_active<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlk<span class="token operator">-></span>l<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">continue</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    rwlk<span class="token operator">-></span>waiting_writers<span class="token operator">--</span><span class="token punctuation">;</span>    rwlk<span class="token operator">-></span>writer_active <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlk<span class="token operator">-></span>l<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">write_release_inner</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">rwspinlock</span> <span class="token operator">*</span>rwlk<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlk<span class="token operator">-></span>l<span class="token punctuation">)</span><span class="token punctuation">;</span>  rwlk<span class="token operator">-></span>writer_active <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlk<span class="token operator">-></span>l<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œæ˜¯ initrwlock çš„ä»£ç </p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">initrwlock</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">rwspinlock</span> <span class="token operator">*</span>rwlk<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// Replace this with your implementation.</span>  <span class="token function">initlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlk<span class="token operator">-></span>l<span class="token punctuation">,</span> <span class="token string">"rwlk"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  rwlk<span class="token operator">-></span>readers <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  rwlk<span class="token operator">-></span>waiting_writers <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  rwlk<span class="token operator">-></span>writer_active <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æµ‹è¯•æ—¶æˆ‘ä»¬é‡åˆ°äº†ä¸€ä¸ªç¥å¥‡çš„ç°è±¡ï¼Œåœ¨ make qemu åç¬¬ä¸€æ¬¡è¿è¡Œ rwlktest æ€»æ˜¯èƒ½é€šè¿‡çš„ï¼Œè€Œä¹‹åè¿è¡Œæ€»æ˜¯ä¸èƒ½é€šè¿‡çš„ã€‚é‡æ–° make qemu ä»¥åè¿˜æ˜¯ç¬¬ä¸€æ¬¡è¿è¡Œèƒ½é€šè¿‡ï¼Œåç»­è¿è¡Œæ— æ³•é€šè¿‡ã€‚</p><p>ç»è¿‡æ¼«é•¿çš„ debug æ—¶å…‰ï¼Œæˆ‘ä»¬å‘ç°é—®é¢˜å‡ºåœ¨ä¸‹é¢çš„æµ‹è¯•å‡½æ•°ä¸Šï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">rwspinlock_test_step</span><span class="token punctuation">(</span>uint step<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>msg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">static</span> uint barrier<span class="token punctuation">;</span>  <span class="token keyword">const</span> uint ncpu <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>  <span class="token function">__atomic_fetch_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>barrier<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> __ATOMIC_ACQ_REL<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">__atomic_load_n</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>barrier<span class="token punctuation">,</span> __ATOMIC_RELAXED<span class="token punctuation">)</span> <span class="token operator">&lt;</span> ncpu <span class="token operator">*</span> step<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// spin</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">cpuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"rwspinlock_test: step %d: %s\n"</span><span class="token punctuation">,</span> step<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™ä¸ªå‡½æ•°çš„è®¾è®¡åŸæ„åº”è¯¥æ˜¯èµ·è¿™ä¸¤ä¸ªä½œç”¨ï¼š</p><ol><li>åŒæ­¥ CPUï¼Œä¿è¯å››ä¸ª CPU éƒ½åˆ°è¾¾äº†è¿™é‡Œå†ç»§ç»­å¾€ä¸‹è¿è¡Œ</li><li>æ‰“å°å½“å‰è¿è¡Œåˆ°çš„æµ‹è¯•ç¼–å·ï¼ˆstepï¼‰</li></ol><p>è¿™ä¸ªå‡½æ•°é€šè¿‡ä¸‹é¢çš„ä»£ç å®ç° CPU åŒæ­¥ã€‚å®ƒè®© barrier åŸå­æ€§åœ°åŠ ä¸€ï¼Œè¡¨ç¤ºä¸€ä¸ª CPU è·‘åˆ°äº†è¿™é‡Œï¼Œç„¶åå¦‚æœå››ä¸ª CPU ä¸­è¿˜æœ‰äººæ²¡æ¥å°±è‡ªæ—‹ç­‰å¾…ã€‚</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">__atomic_fetch_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>barrier<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> __ATOMIC_ACQ_REL<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">__atomic_load_n</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>barrier<span class="token punctuation">,</span> __ATOMIC_RELAXED<span class="token punctuation">)</span> <span class="token operator">&lt;</span> ncpu <span class="token operator">*</span> step<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// spin</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸ºäº†ä¿è¯ barrier è¢«å››ä¸ª CPU å…±äº«ï¼Œbarrier è¢«è®¾ç½®ä¸ºé™æ€å˜é‡ static uint barrier. ä½†æµ‹è¯•ä»£ç åˆæ²¡åœ¨æµ‹è¯•å¼€å§‹æ—¶æŠŠå®ƒé‡ç½®ä¸º 0ï¼Œæ‰€ä»¥å°±å‡ºç°äº†è¿™ç§ç¬¬ä¸€æ¬¡æµ‹è¯•èƒ½é€šè¿‡ï¼Œä¹‹åçš„æµ‹è¯•ä¸èƒ½é€šè¿‡çš„æƒ…å†µã€‚</p><p>ç¬¬ä¸€æ¬¡æµ‹è¯•æ—¶ï¼Œbarrier æ˜¯åˆå§‹å€¼ 0ï¼Œæ‰€ä»¥ä¸€åˆ‡æ­£å¸¸ï¼›ä¹‹åçš„æµ‹è¯•é‡Œ barrier ä¿ç•™äº†ä¹‹å‰çš„å€¼ï¼Œwhile çš„æ¡ä»¶å§‹ç»ˆä¸ºå‡ï¼Œäºæ˜¯è¿™ç§åŒæ­¥åŠŸèƒ½ä¹Ÿå°±å®Œå…¨å¤±æ•ˆäº†ã€‚åœ¨åŒæ­¥åŠŸèƒ½å¤±æ•ˆåï¼Œè·‘å¾—å¿«çš„ CPU éƒ½è·‘å®Œ 30 ä¸ª steps äº†ï¼Œè·‘å¾—æ…¢çš„ CPU å¯èƒ½è¿˜åœ¨ç¬¬ 8 ä¸ª step æŒ£æ‰ï¼Œè¿™å°±è®© rwlktest ä¹Ÿè·Ÿç€å¤±æ•ˆäº†ã€‚</p><p>æ°”æ°›éƒ½åˆ°è¿™å„¿äº†ï¼Œä¸ç»™ä¸ªä¿®å¤ä¹Ÿä¸å¥½æ„æ€ğŸ« ğŸ« ç”¨ä¸‹é¢çš„ä»£ç å°±è¡Œäº†</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">rwspinlock_test_step</span><span class="token punctuation">(</span>uint step<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>msg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">static</span> uint count<span class="token punctuation">;</span>  <span class="token keyword">static</span> uint sense<span class="token punctuation">;</span>  <span class="token keyword">const</span> uint ncpu <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>  <span class="token keyword">int</span> local_sense <span class="token operator">=</span> <span class="token function">__atomic_load_n</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sense<span class="token punctuation">,</span> __ATOMIC_RELAXED<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__atomic_fetch_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>count<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> __ATOMIC_ACQ_REL<span class="token punctuation">)</span> <span class="token operator">==</span> ncpu <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// Let the last reached CPU reset values and print message</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"rwspinlock_test: step %d: %s\n"</span><span class="token punctuation">,</span> step<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">__atomic_store_n</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>count<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> __ATOMIC_RELAXED<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">__atomic_store_n</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sense<span class="token punctuation">,</span> <span class="token operator">!</span>local_sense<span class="token punctuation">,</span> __ATOMIC_RELEASE<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">__atomic_load_n</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sense<span class="token punctuation">,</span> __ATOMIC_ACQUIRE<span class="token punctuation">)</span> <span class="token operator">==</span> local_sense<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token comment">// spin</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>count å’Œ sense æ˜¯å…±äº«çš„å˜é‡ï¼Œæ‰€ä»¥è¦ç”¨åŸå­è¯­å¥è¯»å†™ã€‚__ATOMIC_RELAXED ä¹‹ç±»çš„ä¸œè¥¿æ˜¯å¯¹å†…å­˜é¡ºåºï¼ˆmemory ordersï¼‰çš„é™åˆ¶ï¼Œè¿™èƒ½é˜²æ­¢æŒ‡ä»¤é‡æ’ï¼Œå…·ä½“å¯ä»¥çœ‹ <a href="https://gcc.gnu.org/onlinedocs/gcc/_005f_005fatomic-Builtins.html">https://gcc.gnu.org/onlinedocs/gcc/_005f_005fatomic-Builtins.html</a>.</p><p>å‘ç°è¿™ä¸ª bug ä»¥åæˆ‘ä¹Ÿç»™ 6S081 çš„å®˜æ–¹å‘äº†é‚®ä»¶ï¼Œæ²¡æƒ³åˆ°è¿˜çœŸæ”¶åˆ°å›å¤äº†ï¼ä»–ä»¬è¯´åŠ å…¥äº†ä¸€ä¸ªç±»ä¼¼çš„ä¿®å¤ï¼Œä¼šåœ¨ 2026 å¹´çš„ç‰ˆæœ¬æ›´æ–°ã€‚æ„Ÿè§‰è‡ªå·±å¯¹ MIT çš„æ»¤é•œæ›´åšäº†ï¼ˆï¼‰</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;è¿™ä¸ª lab è®©æˆ‘ä»¬ç†Ÿæ‚‰å¯¹é”çš„ä½¿ç”¨ã€‚é™¤äº† 2024 çš„é¢˜å¤–æˆ‘è¿˜é¡ºä¾¿åšäº†ä¸‹ 2025 æ–°å¢çš„è¯»å†™é”ï¼ˆ2025 å¹´ç”¨ Read-write lock æ¢æ‰äº† Buffer cacheï¼‰ï¼Œè®©æˆ‘ä»¬ä¾æ¬¡æ¥çœ‹çœ‹è¿™å‡ é“é¢˜ã€‚&lt;/p&gt;
&lt;h1 id=&quot;Memory-allocator&quot;&gt;&lt;a</summary>
      
    
    
    
    <category term="å…¬å¼€è¯¾" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/"/>
    
    <category term="MIT-6.S081" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/MIT-6-S081/"/>
    
    <category term="Labs" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/MIT-6-S081/Labs/"/>
    
    
  </entry>
  
  <entry>
    <title>Lab 6 Networking</title>
    <link href="http://rinevard.github.io/wiki/learning/open-course/MIT-6.S081/Labs/lab6-net/"/>
    <id>http://rinevard.github.io/wiki/learning/open-course/MIT-6.S081/Labs/lab6-net/</id>
    <published>2025-11-08T23:41:29.000Z</published>
    <updated>2025-11-08T23:58:14.625Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™ä¸ª lab åˆ†ä¸¤ä¸ªéƒ¨åˆ†ï¼Œç¬¬ä¸€éƒ¨åˆ†æ˜¯è¡¥å…¨ E1000 ç½‘å¡é©±åŠ¨çš„æ•°æ®åŒ…æ”¶å‘ç›¸å…³ä»£ç ï¼Œç¬¬äºŒéƒ¨åˆ†æ˜¯æ·»åŠ ä»£ç å®Œæˆ UDP åŒ…çš„æ¥æ”¶ã€‚åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬åº”è¯¥å…ˆå»æŠŠè®²ç½‘ç»œçš„ lecture çœ‹æ‰ï¼Œå› ä¸ºé‡Œé¢æ¶‰åŠäº†å¾ˆå¤šç›¸å…³å†…å®¹ã€‚ä½ å¯èƒ½ä¼šç–‘æƒ‘ä¸ºä»€ä¹ˆè¯¾ç¨‹æŠŠ lab å®‰æ’åœ¨ lec å‰é¢ï¼Œæˆ‘åœ¨æœ¬æ–‡çš„æ–‡æœ«åæ§½é‡Œå†™äº†å¯èƒ½çš„åŸå› ã€‚</p><p>è®©æˆ‘ä»¬è¿›å…¥æ­£é¢˜ã€‚</p><h1 id="E1000-ç½‘å¡é©±åŠ¨"><a href="#E1000-ç½‘å¡é©±åŠ¨" class="headerlink" title="E1000 ç½‘å¡é©±åŠ¨"></a>E1000 ç½‘å¡é©±åŠ¨</h1><p>æˆ‘ä»¬åœ¨ç¼–å†™ä»£ç æ—¶è¦å›ç­”ä¸¤ä¸ªé—®é¢˜â€”â€”æˆ‘ä»¬å¦‚ä½•å€ŸåŠ©ç½‘å¡æ¥æ”¶æ•°æ®ï¼Œåˆå¦‚ä½•å‘é€æ•°æ®ï¼Ÿæˆ‘ä»¬å¯¹ç…§æ–‡æ¡£ç¬¬ä¸‰ç« æ¥åˆ†æä¸€ä¸‹ï¼Œç„¶ååœ¨åˆ†æçš„ç»“å°¾åˆ†åˆ«ç»™å‡º e1000_recv å’Œ e1000_transmit çš„ä»£ç ï¼š</p><ol><li><p>æˆ‘ä»¬å¦‚ä½•å€ŸåŠ©ç½‘å¡æ¥æ”¶æ•°æ®ï¼Ÿ</p><p> æˆ‘ä»¬åœ¨åˆå§‹åŒ–é‡Œè®¾ç½®äº† RDTRï¼Œè¿™è®©ç½‘å¡åœ¨æ”¶åˆ°åŒ…æ—¶å‘å‡ºä¸­æ–­ï¼Œè¿™ä¸€éƒ¨åˆ†å’Œæ–‡æ¡£çš„ 3.2.8 Receive Interrupts æœ‰å…³ï¼š</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// ask e1000 for receive interrupts.</span>regs<span class="token punctuation">[</span>E1000_RDTR<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// interrupt after every received packet (no timer)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p> æˆ‘ä»¬è¿˜åœ¨åˆå§‹åŒ–é‡Œè®¾ç½®äº† RDBALï¼Œè¿™è®©ç½‘å¡åœ¨æ”¶åˆ°åŒ…æ—¶æŠŠæ•°æ®æ”¾åˆ° rx_ring ä¸­ï¼š</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// [E1000 14.4] Receive initialization</span><span class="token function">memset</span><span class="token punctuation">(</span>rx_ring<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>rx_ring<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> RX_RING_SIZE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    rx_bufs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">kalloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rx_bufs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"e1000"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    rx_ring<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>addr <span class="token operator">=</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>rx_bufs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>regs<span class="token punctuation">[</span>E1000_RDBAL<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>rx_ring<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p> å…·ä½“æ¥è¯´ï¼Œå®ƒä¼šæŠŠåŒ…æ”¾åˆ° rx_ring[RDH] é‡Œï¼Œæˆ‘ä»¬åˆ™ç”¨ RDT æ¥è¯»å–ã€‚</p><p> ä¸‹å›¾æ˜¯ rx_ring çš„ç¤ºæ„å›¾ï¼Œç¡¬ä»¶å¯å‘ [HEAD, TAIL) ä¸­å†™å…¥å†…å®¹ï¼Œ TAIL å¤„ç•™ç©ºä»¥åŒºåˆ†ç©ºç¯å’Œæ»¡ç¯ã€‚</p><p> <img src="/images/learning/open-course/MIT-6.S081/labs/lab6-net/rxring.png" alt=""></p><p> ç½‘å¡ä¼ æ¥çš„æ•°æ®æ ¼å¼åœ¨ e1000_dev.h é‡Œå®šä¹‰ï¼Œå¯å‚è€ƒæ–‡æ¡£ 3.2.3 Receive Descriptor Formatï¼š</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">rx_desc</span> <span class="token punctuation">&#123;</span>    uint64 addr<span class="token punctuation">;</span>   <span class="token comment">/* Address of the descriptor's data buffer */</span>    uint16 length<span class="token punctuation">;</span> <span class="token comment">/* Length of data DMAed into data buffer */</span>    uint16 csum<span class="token punctuation">;</span>   <span class="token comment">/* Packet checksum */</span>    uint8 status<span class="token punctuation">;</span>  <span class="token comment">/* Descriptor status */</span>    uint8 errors<span class="token punctuation">;</span>  <span class="token comment">/* Descriptor Errors */</span>    uint16 special<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p> ç½‘å¡å‘å‡ºä¸­æ–­åï¼Œå†…æ ¸ä¼šè°ƒç”¨ e1000_intrï¼Œe1000_intr åˆä¼šè¿›ä¸€æ­¥è°ƒç”¨ e1000_recv. </p><p> å¯¹ç…§ rx_ring çš„ç¤ºæ„å›¾ï¼Œæˆ‘ä»¬å°±çŸ¥é“ e1000_recv åº”è¯¥å» rx_ring[RDT + 1] å¤„è¯»å–æ•°æ®ï¼Œç›´åˆ°è¯»åˆ°æ— æ•ˆæ•°æ®ä¸ºæ­¢ã€‚å‚è€ƒæ–‡æ¡£çš„ 3.2.3.1 Receive Descriptor Status Fieldï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ® rx_desc çš„ status çš„ DD ä½å¾—çŸ¥æ•°æ®æ˜¯å¦æœ‰æ•ˆã€‚</p><p> æ€»ä¹‹ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">e1000_recv</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//</span>    <span class="token comment">// Your code here.</span>    <span class="token comment">//</span>    <span class="token comment">// Check for packets that have arrived from the e1000</span>    <span class="token comment">// Create and deliver a buf for each packet (using net_rx()).</span>    <span class="token comment">//</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>e1000_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    uint32 idx <span class="token operator">=</span> <span class="token punctuation">(</span>regs<span class="token punctuation">[</span>E1000_RDT<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> RX_RING_SIZE<span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>rx_ring<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>status <span class="token operator">&amp;</span> E1000_RXD_STAT_DD<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">char</span> <span class="token operator">*</span>recv_buf <span class="token operator">=</span> rx_bufs<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> buflen <span class="token operator">=</span> rx_ring<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>        rx_bufs<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">kalloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rx_bufs<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"e1000"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        rx_ring<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>addr <span class="token operator">=</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>rx_bufs<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span>        rx_ring<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        idx <span class="token operator">=</span> <span class="token punctuation">(</span>idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> RX_RING_SIZE<span class="token punctuation">;</span>        <span class="token comment">// net_rx could call e1000_transmit, so release lock before calling it</span>        <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>e1000_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">net_rx</span><span class="token punctuation">(</span>recv_buf<span class="token punctuation">,</span> buflen<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>e1000_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// set RDT to the last processed index</span>    regs<span class="token punctuation">[</span>E1000_RDT<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>idx <span class="token operator">+</span> RX_RING_SIZE <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> RX_RING_SIZE<span class="token punctuation">;</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>e1000_lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p> è¿™é‡Œçš„ <code>regs[E1000_RDT] = (idx + RX_RING_SIZE - 1) % RX_RING_SIZE</code> å¯èƒ½æ¯”è¾ƒ trickyï¼Œæ€»ä¹‹å°±æ˜¯ RDT åº”è¯¥æŒ‡åœ¨æœ€åä¸€ä¸ªè¢«å–å‡ºçš„æè¿°ç¬¦å¤„ä»¥å®ç°ç•™ç©ºã€‚</p></li><li><p>æˆ‘ä»¬å¦‚ä½•å€ŸåŠ©ç½‘å¡å‘é€æ•°æ®ï¼Ÿ</p><p> å¦‚æ–‡æ¡£ 3.4.3 Transmit Interrupts æ‰€å†™ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è®¾ç½®ç½‘å¡åœ¨ä¼ è¾“å®Œæˆæ—¶å‘ç”Ÿä¸­æ–­ï¼Œä¸è¿‡åœ¨ xv6 é‡Œæˆ‘ä»¬æ²¡æœ‰è¿™ä¹ˆè®¾ç½®ï¼Œæ‰€ä»¥å‘é€æˆåŠŸä¸ä¼šä¸­æ–­ã€‚</p><p> ä¸è¯»å–æ•°æ®è¦æŠŠ rx_ring çš„ä½ç½®å‘Šè¯‰ç½‘å¡ç±»ä¼¼ï¼Œæˆ‘ä»¬è¦æŠŠ tx_ring çš„ä½ç½®åœ¨åˆå§‹åŒ–é‡Œå‘Šè¯‰ç½‘å¡ï¼š</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// [E1000 14.5] Transmit initialization</span><span class="token function">memset</span><span class="token punctuation">(</span>tx_ring<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tx_ring<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> TX_RING_SIZE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    tx_ring<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>status <span class="token operator">=</span> E1000_TXD_STAT_DD<span class="token punctuation">;</span>    tx_bufs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>regs<span class="token punctuation">[</span>E1000_TDBAL<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>tx_ring<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p> æˆ‘ä»¬ä¼šæŠŠæ•°æ®æ”¾åˆ° tx_ring[TDT] é‡Œï¼Œç½‘å¡ä¼šè‡ªåŠ¨èµ°åŠ¨ TDH ç›´åˆ°è¿½ä¸Š TDT.</p><p> ä¸‹å›¾æ˜¯ rx_ring çš„ç¤ºæ„å›¾ï¼ŒTAIL æŒ‡å‘ç¡¬ä»¶èƒ½å¤Ÿå¤„ç†çš„æœ€åä¸€ä¸ªæè¿°ç¬¦ä¹‹åçš„ä½ç½®ï¼Œè¿™ä¹Ÿæ˜¯è½¯ä»¶å†™å…¥ç¬¬ä¸€ä¸ªæ–°æè¿°ç¬¦çš„ä½ç½®ã€‚ä¸ rx_ring ä¸åŒï¼Œtx_ring æ— ç•™ç©ºã€‚</p><p> <img src="/images/learning/open-course/MIT-6.S081/labs/lab6-net/txring.png" alt=""></p><p> ä¼ ç»™ç½‘å¡çš„æ•°æ®ç»“æ„ä¹Ÿåœ¨ e1000_dev.h é‡Œå®šä¹‰ï¼Œå¯å‚è€ƒæ–‡æ¡£ 3.3.2 Transmit Descriptorsï¼š</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">tx_desc</span> <span class="token punctuation">&#123;</span>    uint64 addr<span class="token punctuation">;</span>    uint16 length<span class="token punctuation">;</span>    uint8 cso<span class="token punctuation">;</span>    uint8 cmd<span class="token punctuation">;</span>    uint8 status<span class="token punctuation">;</span>    uint8 css<span class="token punctuation">;</span>    uint16 special<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p> å¯¹ç…§ tx_ring çš„ç¤ºæ„å›¾ï¼Œæˆ‘ä»¬è¦æŠŠæ•°æ®å­˜åœ¨ tx_ring[TDT] é‡Œã€‚è¦æ³¨æ„å¦‚æœ TDT æŒ‡å‘çš„å†…å®¹å·²ç»è¢«ç½‘å¡æˆåŠŸå‘é€äº†ï¼ˆå¯ä»¥é€šè¿‡ status çš„ DD ä½æ¥åˆ¤æ–­ï¼‰ï¼Œæˆ‘ä»¬è¦é‡Šæ”¾ TDT æŒ‡å‘çš„å†…å­˜ä»¥é¿å…å†…å­˜æ³„æ¼ï¼›å¦å¤–æˆ‘ä»¬è¿˜è¦æ›´æ–° cmd ä½ï¼Œå…·ä½“å¯ä»¥å‚è€ƒ 3.3.3.1 Transmit Descriptor Command Field Format. æ€»ä¹‹ä¸‹é¢æ˜¯ä»£ç ï¼š</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">e1000_transmit</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//</span>    <span class="token comment">// Your code here.</span>    <span class="token comment">//</span>    <span class="token comment">// buf contains an ethernet frame; program it into</span>    <span class="token comment">// the TX descriptor ring so that the e1000 sends it. Stash</span>    <span class="token comment">// a pointer so that it can be freed after send completes.</span>    <span class="token comment">//</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>e1000_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    uint32 idx <span class="token operator">=</span> regs<span class="token punctuation">[</span>E1000_TDT<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>tx_ring<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>status <span class="token operator">&amp;</span> E1000_TXD_STAT_DD<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>e1000_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// free old buf that has been sent away</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>tx_ring<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>addr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">kfree</span><span class="token punctuation">(</span>tx_bufs<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    tx_bufs<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> buf<span class="token punctuation">;</span>    tx_ring<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>addr <span class="token operator">=</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>tx_bufs<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span>    tx_ring<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">=</span> len<span class="token punctuation">;</span>    tx_ring<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>cmd <span class="token operator">=</span> E1000_TXD_CMD_EOP <span class="token operator">|</span> E1000_TXD_CMD_RS<span class="token punctuation">;</span>    tx_ring<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    regs<span class="token punctuation">[</span>E1000_TDT<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> TX_RING_SIZE<span class="token punctuation">;</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>e1000_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><h1 id="UDP-åŒ…çš„æ¥æ”¶"><a href="#UDP-åŒ…çš„æ¥æ”¶" class="headerlink" title="UDP åŒ…çš„æ¥æ”¶"></a>UDP åŒ…çš„æ¥æ”¶</h1><p>æˆ‘ä»¬å…ˆæ¥æ¢³ç†ä¸€ä¸‹æ•´ä¸ªæ”¶ä¿¡æµç¨‹æ˜¯æ€æ ·çš„ï¼šå¤–éƒ¨ä¼šå‘ packet ç»™ç½‘å¡ï¼Œç½‘å¡åœ¨æ”¶åˆ°åä¼šå¼•å‘ä¸­æ–­ï¼Œå†…æ ¸å‘ç°ä¸­æ–­ç”±ç½‘å¡å¼•å‘å°±ä¼šè°ƒç”¨ <code>e1000_intr</code>ï¼Œä¹‹å packet ä¼šè¢«å‘ç»™ <code>net_rx</code> æ¥è®©å†…æ ¸åšè¿›ä¸€æ­¥å¤„ç†ã€‚å¦‚æœ <code>net_rx</code> å‘ç°è¿™æ˜¯ä¸€ä¸ª IP packet å°±ä¼šè¿›ä¸€æ­¥è°ƒç”¨ <code>ip_rx</code>ï¼Œç„¶åå°±åˆ°æˆ‘ä»¬çš„å·¥ä½œäº†ã€‚</p><p>æˆ‘ä»¬åªéœ€è¦å¤„ç† ETH-IP-UDP åµŒå¥—çš„ packetï¼Œè®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹å®ƒçš„ç»“æ„ï¼š</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab6-net/packet.png" alt=""></p><p>å…·ä½“çš„ packet header çš„å®šä¹‰åœ¨ net.h é‡Œã€‚</p><p>æ€»ä¹‹æˆ‘ä»¬è¦å®ç° recvã€bindã€ip_rx è¿™ä¸‰ä¸ªå‡½æ•°ã€‚åº”ç”¨ä¼šè°ƒç”¨ bind æ¥ç›‘å¬ä¸€ä¸ªç«¯å£ï¼Œå½“ç«¯å£è¢«ç›‘å¬æ—¶æˆ‘ä»¬éœ€è¦ä¿å­˜åˆ°è¾¾è¿™ä¸ªç«¯å£çš„æ•°æ®åŒ…ï¼Œæ‰€ä»¥è¦åœ¨ <code>net.h</code> ä¸­å®šä¹‰å¦‚ä¸‹çš„æ•°æ®ç»“æ„ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_LISTEN_PORTS</span> <span class="token expression"><span class="token number">128</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PACKET_RING_SIZE</span> <span class="token expression"><span class="token number">16</span> </span><span class="token comment">// for any given port, no more than 16 packets should be saved</span></span><span class="token keyword">struct</span> <span class="token class-name">listener</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> used<span class="token punctuation">;</span>    <span class="token keyword">int</span> port<span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>packet_ring<span class="token punctuation">[</span>PACKET_RING_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> head<span class="token punctuation">;</span> <span class="token comment">// used by writer</span>    <span class="token keyword">int</span> tail<span class="token punctuation">;</span> <span class="token comment">// used by reader</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œçš„ used å­—æ®µå¯èƒ½æœ‰ç‚¹å¥‡æ€ªï¼Œæˆ‘æ¥è§£é‡Šä¸€ä¸‹ï¼šæˆ‘ä»¬å¸Œæœ›æ¯å½“ä¸€ä¸ªåº”ç”¨è°ƒç”¨ bindï¼Œæˆ‘ä»¬å°±æ–°å¢ä¸€ä¸ª listenerï¼Œä½†ç”±äº C è¯­è¨€å®ç°åŠ¨æ€æ•°ç»„å¾ˆéº»çƒ¦ï¼Œæ‰€ä»¥æˆ‘ä»¬é€‰æ‹©åˆ›å»ºé™æ€å¤§å°çš„ listeners æ•°ç»„ã€‚é‚£ä¸ºä»€ä¹ˆä¸ç”¨é“¾è¡¨å‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬æ–°å¢å†…å­˜çš„æ‰‹æ®µåªæœ‰ kallocï¼Œè€Œä¸€æ•´ä¸ªé¡µå¯¹ä¸€ä¸ª listener æ¥è¯´å¤ªå¤§äº†ã€‚</p><p>struct listener é‡Œçš„ used å­—æ®µå°±æ˜¯ä¸ºäº†åˆ¤æ–­ listeners æ•°ç»„é‡Œçš„æŸä¸ª listener æ˜¯å¦å·²ç»è¢«ä½¿ç”¨ã€‚</p><p>æˆ‘ä»¬è¦åœ¨ net.c é‡Œåˆå§‹åŒ– listeners æ•°ç»„ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">listener</span> listeners<span class="token punctuation">[</span>MAX_LISTEN_PORTS<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">netinit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">initlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netlock<span class="token punctuation">,</span> <span class="token string">"netlock"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX_LISTEN_PORTS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        listeners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>used <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> PACKET_RING_SIZE<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            listeners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>packet_ring<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ¥ä¸‹æ¥æˆ‘ä»¬åˆ†æä¸€ä¸‹æ¯ä¸ªå‡½æ•°è¦åšä»€ä¹ˆï¼Œå†ç»™å‡ºä»£ç ï¼š</p><ol><li><p>recv(int dport, int *src, short *sport, char *buf, int maxlen)</p><p> æ¥æ”¶åˆ°è¾¾ dport ç«¯å£çš„ UDP packet. å¦‚æœåˆ°è¾¾äº†å¤šä¸ªï¼Œå–å‡ºç¬¬ä¸€ä¸ª packetï¼›å¦‚æœæ²¡æœ‰ä¸œè¥¿åˆ°è¾¾ï¼Œç­‰å¾…ç›´åˆ°æœ‰ä¸œè¥¿åˆ°è¾¾ã€‚</p><p> æœ¬å‡½æ•°æŠŠå–å‡ºçš„ packet é‡Œ 32 ä½çš„æº IP åœ°å€å¤åˆ¶åˆ° *srcï¼ŒUDP æºç«¯å£å·å¤åˆ¶åˆ° *sportï¼Œpayload çš„è‡³å¤š maxlen ä¸ªå­—èŠ‚å¤åˆ¶åˆ° buf. æˆåŠŸåˆ™è¿”å›å¤åˆ¶çš„ payload å­—èŠ‚æ•°ï¼Œå¤±è´¥è¿”å› -1.</p><p> æ³¨æ„ç½‘ç»œå­—èŠ‚åºå’Œç³»ç»Ÿå­—èŠ‚åºä¸åŒï¼Œè¦ç”¨ <code>ntohs</code> å’Œ <code>ntohl</code> æ¥é€†è½¬å­—èŠ‚åºã€‚</p><p> å¦å¤–ï¼Œè¿™é‡Œçš„å„ä¸ªæŒ‡é’ˆæ˜¯ç”¨æˆ·ç©ºé—´çš„è™šæ‹Ÿåœ°å€ï¼Œæˆ‘ä»¬è¦ç”¨ copyout æŠŠ packet é‡Œçš„å†…å®¹ï¼ˆå®ƒä»¬åœ¨å†…æ ¸ç©ºé—´ï¼‰å¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´ã€‚</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c">uint64 <span class="token function">sys_recv</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//</span>    <span class="token comment">// Your code here.</span>    <span class="token comment">//</span>    <span class="token keyword">struct</span> <span class="token class-name">proc</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>    <span class="token keyword">int</span> dport<span class="token punctuation">;</span>    uint64 src<span class="token punctuation">;</span>    uint64 sport<span class="token punctuation">;</span>    uint64 buf<span class="token punctuation">;</span>    <span class="token keyword">int</span> maxlen<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">listener</span> <span class="token operator">*</span>listener <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    p <span class="token operator">=</span> <span class="token function">myproc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">argint</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>dport<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">argaddr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">argaddr</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>sport<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">argaddr</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">argint</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>maxlen<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// find listener related to dport</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netlock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX_LISTEN_PORTS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        listener <span class="token operator">=</span> <span class="token operator">&amp;</span>listeners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>listener<span class="token operator">-></span>used <span class="token operator">&amp;&amp;</span> listener<span class="token operator">-></span>port <span class="token operator">==</span> dport<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        listener <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>listener<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">goto</span> bad<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// return the earliest waiting packet or wait until a packet arrives</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>listener<span class="token operator">-></span>packet_ring<span class="token punctuation">[</span>listener<span class="token operator">-></span>tail<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// extract a packet from the ring</span>            <span class="token keyword">char</span> <span class="token operator">*</span>packet <span class="token operator">=</span> listener<span class="token operator">-></span>packet_ring<span class="token punctuation">[</span>listener<span class="token operator">-></span>tail<span class="token punctuation">]</span><span class="token punctuation">;</span>            listener<span class="token operator">-></span>packet_ring<span class="token punctuation">[</span>listener<span class="token operator">-></span>tail<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            listener<span class="token operator">-></span>tail <span class="token operator">=</span> <span class="token punctuation">(</span>listener<span class="token operator">-></span>tail <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> PACKET_RING_SIZE<span class="token punctuation">;</span>            <span class="token comment">// extract data from the packet</span>            <span class="token keyword">struct</span> <span class="token class-name">ip</span> <span class="token operator">*</span>ip_packet <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ip</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>packet <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">eth</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">struct</span> <span class="token class-name">udp</span> <span class="token operator">*</span>udp_packet <span class="token operator">=</span>                <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">udp</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>packet <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">eth</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ip</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">void</span> <span class="token operator">*</span>payload <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>udp_packet<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">udp</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// re-arrange the bytes</span>            uint32 src_ip <span class="token operator">=</span> <span class="token function">ntohl</span><span class="token punctuation">(</span>ip_packet<span class="token operator">-></span>ip_src<span class="token punctuation">)</span><span class="token punctuation">;</span>            uint16 src_port <span class="token operator">=</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>udp_packet<span class="token operator">-></span>sport<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copyout</span><span class="token punctuation">(</span>p<span class="token operator">-></span>pagetable<span class="token punctuation">,</span> src<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>src_ip<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>src_ip<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span>                <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">kfree</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">goto</span> bad<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copyout</span><span class="token punctuation">(</span>p<span class="token operator">-></span>pagetable<span class="token punctuation">,</span> sport<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>src_port<span class="token punctuation">,</span>                        <span class="token keyword">sizeof</span><span class="token punctuation">(</span>src_port<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">kfree</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">goto</span> bad<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">// copy at most maxlen bytes of the payload and free the packet</span>            uint16 buflen <span class="token operator">=</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>udp_packet<span class="token operator">-></span>ulen<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">udp</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            uint64 cplen <span class="token operator">=</span> <span class="token punctuation">(</span>buflen <span class="token operator">></span> maxlen<span class="token punctuation">)</span> <span class="token operator">?</span> maxlen <span class="token operator">:</span> buflen<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copyout</span><span class="token punctuation">(</span>p<span class="token operator">-></span>pagetable<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> cplen<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">kfree</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">goto</span> bad<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token function">kfree</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netlock<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> cplen<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// wait until a packet arrives</span>            <span class="token function">sleep</span><span class="token punctuation">(</span>listener<span class="token operator">-></span>packet_ring<span class="token punctuation">,</span> <span class="token operator">&amp;</span>netlock<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">goto</span> bad<span class="token punctuation">;</span>bad<span class="token operator">:</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netlock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>bind(int port)</p><p> è¿›ç¨‹åœ¨è°ƒç”¨ recv å‰åº”å½“å…ˆè°ƒç”¨ bind æ¥ç›‘å¬ç‰¹å®šç«¯å£ï¼Œbind è¢«è°ƒç”¨æ—¶åº”è¯¥è¦åˆå§‹åŒ– port å¯¹åº”çš„å¾…å¤„ç†åŒºã€‚</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c">uint64 <span class="token function">sys_bind</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//</span>    <span class="token comment">// Your code here.</span>    <span class="token comment">//</span>    <span class="token keyword">int</span> port<span class="token punctuation">;</span>    <span class="token function">argint</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netlock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// return error if repeated binding</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX_LISTEN_PORTS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>listeners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>used <span class="token operator">&amp;&amp;</span> listeners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>port <span class="token operator">==</span> port<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">goto</span> bad<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX_LISTEN_PORTS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>listeners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>used<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// use the first unused listener for port</span>            listeners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>used <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>            listeners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>port <span class="token operator">=</span> port<span class="token punctuation">;</span>            listeners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>head <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            listeners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>tail <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netlock<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">goto</span> bad<span class="token punctuation">;</span>bad<span class="token operator">:</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netlock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>ip_rx(char *buf, int len)</p><p> e1000_recv ä¼šæŠŠ packet è½¬å‘ç»™ net_rxï¼Œnet_rx åœ¨å‘ç°æ”¶åˆ°çš„ packet æ˜¯ IP packet æ—¶ä¼šæŠŠ packet è½¬å‘ç»™ ip_rx.</p><p> æˆ‘ä»¬éœ€è¦æ£€æŸ¥ destination port æ˜¯å¦åœ¨æ­£åœ¨è¢«ç›‘å¬ï¼Œå¦‚æœæœªç›‘å¬æˆ–å¾…å¤„ç†åŒºå·²æ»¡å°±ä¸¢å¼ƒåŒ…ï¼Œå¦åˆ™å­˜åˆ°å¾…å¤„ç†åŒºã€‚</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">ip_rx</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// don't delete this printf; make grade depends on it.</span>    <span class="token keyword">static</span> <span class="token keyword">int</span> seen_ip <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>seen_ip <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ip_rx: received an IP packet\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    seen_ip <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token comment">//</span>    <span class="token comment">// Your code here.</span>    <span class="token comment">//</span>    <span class="token keyword">struct</span> <span class="token class-name">udp</span> <span class="token operator">*</span>udp_packet<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">listener</span> <span class="token operator">*</span>listener <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    udp_packet <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">udp</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>buf <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">eth</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ip</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netlock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX_LISTEN_PORTS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        listener <span class="token operator">=</span> <span class="token operator">&amp;</span>listeners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token comment">// try best to save packet in listener related to dport</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>listener<span class="token operator">-></span>used <span class="token operator">&amp;&amp;</span> listener<span class="token operator">-></span>port <span class="token operator">==</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>udp_packet<span class="token operator">-></span>dport<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">int</span> head <span class="token operator">=</span> listener<span class="token operator">-></span>head<span class="token punctuation">;</span>            <span class="token comment">// if ring is full, drop the incoming packet</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>listener<span class="token operator">-></span>packet_ring<span class="token punctuation">[</span>head<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">kfree</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netlock<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">// save packet in listener</span>            listener<span class="token operator">-></span>packet_ring<span class="token punctuation">[</span>head<span class="token punctuation">]</span> <span class="token operator">=</span> buf<span class="token punctuation">;</span>            listener<span class="token operator">-></span>head <span class="token operator">=</span> <span class="token punctuation">(</span>head <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> PACKET_RING_SIZE<span class="token punctuation">;</span>            <span class="token function">wakeup</span><span class="token punctuation">(</span>listener<span class="token operator">-></span>packet_ring<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netlock<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">kfree</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netlock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><p>ç„¶åæˆ‘ä»¬å°±ä¸‹ç­äº†ï¼</p><h1 id="æ‚ä¸ƒæ‚å…«å°çŸ¥è¯†"><a href="#æ‚ä¸ƒæ‚å…«å°çŸ¥è¯†" class="headerlink" title="æ‚ä¸ƒæ‚å…«å°çŸ¥è¯†"></a>æ‚ä¸ƒæ‚å…«å°çŸ¥è¯†</h1><h2 id="æ‰€æœ‰æƒè½¬ç§»"><a href="#æ‰€æœ‰æƒè½¬ç§»" class="headerlink" title="æ‰€æœ‰æƒè½¬ç§»"></a>æ‰€æœ‰æƒè½¬ç§»</h2><p>çœ‹ä¸€çœ¼ e1000_recv çš„ä»£ç ï¼Œæˆ‘ä»¬ä¼šå‘ç°å®ƒè°ƒç”¨äº† kallocï¼Œå´æ²¡æœ‰åœ¨å†…éƒ¨æ˜¾å¼é‡Šæ”¾æ–°å»ºçš„å†…å­˜ï¼Œè¿™æ˜¯å†…å­˜æ³„æ¼å—ï¼Ÿ</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">e1000_recv</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//</span>    <span class="token comment">// Your code here.</span>    <span class="token comment">//</span>    <span class="token comment">// Check for packets that have arrived from the e1000</span>    <span class="token comment">// Create and deliver a buf for each packet (using net_rx()).</span>    <span class="token comment">//</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>e1000_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    uint32 idx <span class="token operator">=</span> <span class="token punctuation">(</span>regs<span class="token punctuation">[</span>E1000_RDT<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> RX_RING_SIZE<span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>rx_ring<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>status <span class="token operator">&amp;</span> E1000_RXD_STAT_DD<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">char</span> <span class="token operator">*</span>recv_buf <span class="token operator">=</span> rx_bufs<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// åœ¨è¿™é‡Œå–å‡º</span>        <span class="token keyword">int</span> buflen <span class="token operator">=</span> rx_ring<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>        rx_bufs<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">kalloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// åœ¨è¿™é‡Œåˆ†é…æ–°å†…å­˜</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rx_bufs<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"e1000"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        rx_ring<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>addr <span class="token operator">=</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>rx_bufs<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span>        rx_ring<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        idx <span class="token operator">=</span> <span class="token punctuation">(</span>idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> RX_RING_SIZE<span class="token punctuation">;</span>        <span class="token comment">// net_rx could call e1000_transmit, so release lock before calling it</span>        <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>e1000_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">net_rx</span><span class="token punctuation">(</span>recv_buf<span class="token punctuation">,</span> buflen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// åœ¨è¿™é‡Œè½¬ç§»æ‰€æœ‰æƒ</span>        <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>e1000_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// set RDT to the last processed index</span>    regs<span class="token punctuation">[</span>E1000_RDT<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>idx <span class="token operator">+</span> RX_RING_SIZE <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> RX_RING_SIZE<span class="token punctuation">;</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>e1000_lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™å¹¶ä¸æ˜¯å†…å­˜æ³„æ¼ï¼Œè€Œæ˜¯ä¸€ç§æ‰€æœ‰æƒè½¬ç§»ã€‚å¯¹æ¯ä¸ªæ–°å»ºçš„ <code>rx_bufs[idx] = kalloc()</code>ï¼Œæˆ‘ä»¬éƒ½ä¼šåœ¨æœªæ¥é€šè¿‡ <code>recv_buf = rx_bufs[idx]</code> æŠŠå®ƒå–å‡ºï¼Œå¹¶æŠŠå…¶æ‰€æœ‰æƒé€šè¿‡ <code>net_rx(recv_buf, buflen)</code> è½¬ç§»ç»™ <code>net_rx</code>. ä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>net_rx</code> è´Ÿè´£é‡Šæ”¾ä¼ å…¥çš„ buf.</p><p>è€Œ <code>net_rx</code> ä¹Ÿå¯èƒ½æŠŠ buf çš„æ‰€æœ‰æƒè½¬ç§»ç»™ <code>app_rx</code> æˆ– <code>ip_rx</code>.</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">net_rx</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">eth</span> <span class="token operator">*</span>eth <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">eth</span> <span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">>=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">eth</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">arp</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>        <span class="token function">ntohs</span><span class="token punctuation">(</span>eth<span class="token operator">-></span>type<span class="token punctuation">)</span> <span class="token operator">==</span> ETHTYPE_ARP<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">arp_rx</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">>=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">eth</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ip</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>               <span class="token function">ntohs</span><span class="token punctuation">(</span>eth<span class="token operator">-></span>type<span class="token punctuation">)</span> <span class="token operator">==</span> ETHTYPE_IP<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">ip_rx</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token function">kfree</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™å’Œ C++ é‡Œçš„ move è¯­ä¹‰ç±»ä¼¼ï¼Œéƒ½æ˜¯â€œè½¬ç§»æ‰€æœ‰æƒâ€ã€‚</p><h2 id="ä»€ä¹ˆæ˜¯-attribute-packed"><a href="#ä»€ä¹ˆæ˜¯-attribute-packed" class="headerlink" title="ä»€ä¹ˆæ˜¯ attribute((packed))"></a>ä»€ä¹ˆæ˜¯ <strong>attribute((packed))</strong></h2><p>net.h é‡Œæœ‰ packet header çš„å®šä¹‰ï¼Œè¿™é‡Œ struct eth é‡Œçš„ <code>__attribute((packed))__</code> æ˜¯åœ¨å‘ŠçŸ¥ç¼–è¯‘å™¨å–æ¶ˆå†…å­˜å¯¹é½ä¼˜åŒ–ï¼Œè®©ç»“æ„ä½“æˆå‘˜ç´§å‡‘æ’åˆ—ã€‚</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">eth</span> <span class="token punctuation">&#123;</span>    uint8 dhost<span class="token punctuation">[</span>ETHADDR_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>    uint8 shost<span class="token punctuation">[</span>ETHADDR_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>    uint16 type<span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>packed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿˜è®°å¾—å¯¹é½ä¼˜åŒ–æ˜¯ä»€ä¹ˆå—ï¼Ÿä¸ºäº†æé«˜ CPU è®¿é—®å†…å­˜çš„æ•ˆç‡ï¼Œç»“æ„ä½“ä¸­çš„æ¯ä¸ªæˆå‘˜çš„èµ·å§‹åœ°å€ç›¸å¯¹äºç»“æ„ä½“èµ·å§‹åœ°å€çš„åç§»é‡éœ€è¦æ˜¯è¯¥æˆå‘˜è‡ªèº«å¤§å°çš„æ•´æ•°å€ã€‚å¦‚æœä¸æ˜¯ï¼Œç¼–è¯‘å™¨ä¼šåœ¨å‰ä¸€ä¸ªæˆå‘˜åé¢å¡«å……ä¸€äº›ç©ºç™½å­—èŠ‚ã€‚</p><p>æ¯”å¦‚å¯¹ä¸‹é¢çš„ç»“æ„ä½“ï¼Œsizeof(struct Test) æ˜¯ 12 å­—èŠ‚ï¼Œè€Œä¸æ˜¯æˆå‘˜å¤§å°ä¹‹å’Œçš„ 1 + 4 + 1 = 6 å­—èŠ‚ã€‚</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">Test</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">char</span> c1<span class="token punctuation">;</span>    <span class="token keyword">int</span> i<span class="token punctuation">;</span>    <span class="token keyword">char</span> c2<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="æ–‡æœ«åæ§½"><a href="#æ–‡æœ«åæ§½" class="headerlink" title="æ–‡æœ«åæ§½"></a>æ–‡æœ«åæ§½</h1><p>Lab Net ç»å†äº†ä¸å°‘å˜è¿ï¼Œåœ¨ 2019 å’Œ 2020 å¹´å®ƒè¿˜æ˜¯è¯¾ç¨‹çš„æœ€åä¸€ä¸ª labï¼Œè€Œä» 2021 å¹´å¼€å§‹å®ƒå°±è¢«ç§»åˆ°äº†è¯¾ç¨‹ä¸­æœŸï¼Œè€Œç½‘ç»œ lec åˆ™ä¸€ç›´åœ¨è¯¾ç¨‹åæœŸï¼Œæ‰€ä»¥å°±é€ æˆäº† lab å’Œ lec çš„é”™ä½ã€‚</p><p><a href="https://pdos.csail.mit.edu/6.828/2023/labs/net.html">2023 å¹´ç‰ˆæœ¬çš„ Net Lab</a> åªè¦æ±‚å®ç° Part One è€Œä¸”æ ‡æ³¨çš„éš¾åº¦è¿˜æ˜¯ hardï¼Œ2024 å¹´å°±å˜æˆäº† moderate è¿˜æ–°åŠ äº†ä¸€ä¸ª Part Twoï¼Œæœç„¶è¯¾ç¨‹éš¾åº¦ä¹Ÿæ˜¯ä¼šé€šè´§è†¨èƒ€çš„ğŸ« ğŸ« </p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;è¿™ä¸ª lab åˆ†ä¸¤ä¸ªéƒ¨åˆ†ï¼Œç¬¬ä¸€éƒ¨åˆ†æ˜¯è¡¥å…¨ E1000 ç½‘å¡é©±åŠ¨çš„æ•°æ®åŒ…æ”¶å‘ç›¸å…³ä»£ç ï¼Œç¬¬äºŒéƒ¨åˆ†æ˜¯æ·»åŠ ä»£ç å®Œæˆ UDP åŒ…çš„æ¥æ”¶ã€‚åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬åº”è¯¥å…ˆå»æŠŠè®²ç½‘ç»œçš„ lecture çœ‹æ‰ï¼Œå› ä¸ºé‡Œé¢æ¶‰åŠäº†å¾ˆå¤šç›¸å…³å†…å®¹ã€‚ä½ å¯èƒ½ä¼šç–‘æƒ‘ä¸ºä»€ä¹ˆè¯¾ç¨‹æŠŠ lab å®‰æ’åœ¨ lec å‰é¢ï¼Œæˆ‘åœ¨æœ¬</summary>
      
    
    
    
    <category term="å…¬å¼€è¯¾" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/"/>
    
    <category term="MIT-6.S081" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/MIT-6-S081/"/>
    
    <category term="Labs" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/MIT-6-S081/Labs/"/>
    
    
  </entry>
  
  <entry>
    <title>é€è¿‡æœ›è¿œé•œç»™æœˆäº®æ‹ç…§</title>
    <link href="http://rinevard.github.io/wiki/others/thoughts/moon/"/>
    <id>http://rinevard.github.io/wiki/others/thoughts/moon/</id>
    <published>2025-11-05T14:10:15.000Z</published>
    <updated>2025-11-05T15:01:12.376Z</updated>
    
    <content type="html"><![CDATA[<p>ä»Šå¤©æ‹¿å‡ºäº†æˆ‘è€—è´¹ 200 å…ƒå·¨èµ„ä¹°çš„æ£®æ—äººæœ›è¿œé•œè¯•ç€çœ‹æœˆäº®ï¼</p><p><img src="/images/others/random_thoughts/moon/telescope.jpg" alt="7x50"></p><p>åœ¨æ‹¿èµ·æœ›è¿œé•œçœ‹å‘æœˆäº®ä¹‹å‰çœŸçš„å¾ˆéš¾æƒ³è±¡ï¼Œä¸€ä¸ªä¸¤ç™¾å…ƒçš„æœ›è¿œé•œå°±èƒ½è®©æˆ‘çœ‹æ¸…æœˆæµ·ã€æœˆé™†ã€ç¬¬è°·ç¯å½¢å±±ã€‚ä¸è¿‡å¦‚æœæˆ‘åªæ˜¯åœ¨è¿™é‡Œé«˜è°ˆé˜”è®ºçš„è¯ï¼Œè¯»è€…ï¼ˆè¿™ç¯‡æ–‡ç« çœŸçš„å­˜åœ¨è¯»è€…å—ï¼‰ä¸€å®šæ„Ÿå—ä¸åˆ°è¿™ç§å¥‡å¦™çš„ä½“éªŒçš„ï¼Œé‚£æˆ‘å°±ä¸Šå›¾å§ï¼</p><p><img src="/images/others/random_thoughts/moon/square_moon.png" alt="æœˆäº®"></p><p>æˆ‘ä»¬ä¼šæ³¨æ„åˆ°å®ƒæ˜¯é»‘ä¸€å—ç™½ä¸€å—çš„ã€‚é»‘çš„å°±æ˜¯æœˆæµ·ï¼Œå®ƒä»¬æ˜¯å¤ä»£ç«å±±å–·å‘åç„æ­¦å²©å½¢æˆçš„å¹³åŸï¼Œç„æ­¦å²©é¢œè‰²è¾ƒæ·±ï¼Œåå°„é˜³å…‰çš„èƒ½åŠ›å¼±ï¼Œæ‰€ä»¥çœ‹èµ·æ¥æ˜¯æš—ç°è‰²çš„ã€‚è€Œç™½çš„åˆ™æ˜¯æœˆé™†ï¼Œä¸»è¦ç”±ä¸€ç§å«åšæ–œé•¿å²©çš„æµ…è‰²å²©çŸ³æ„æˆï¼Œçœ‹èµ·æ¥æ›´æ˜äº®ã€‚</p><p>è€Œå›¾ç‰‡äº”ç‚¹åŠæ–¹å‘ä¸Šçš„é‚£ä¸ªè¾å°„çŠ¶çš„ä¸œè¥¿å°±æ˜¯ç¬¬è°·å‘ï¼ï¼ˆçœ‹èµ·æ¥æœ‰ç‚¹åƒæ˜Ÿé™…æ‹“è’çš„å®‡å®™ä¹‹çœ¼å‘¢ï¼‰</p><p>ä¸è¿‡è¿™æ˜¯ PS è°ƒæ•´åçš„å›¾ï¼Œä¸»è¦æ˜¯æ‹‰é«˜äº†æ›å…‰ã€æ‹‰ä½äº†é«˜å…‰ã€æ‹‰é«˜äº†çº¹ç†å’Œæ¸…æ™°åº¦ï¼Œä¸‹é¢æ˜¯ç›´æ¥æ‹å‡ºæ¥çš„å›¾ï¼ˆå½“ç„¶ä¸æ˜¯åŸå›¾ï¼ŒåŸå›¾ 20mb æ„Ÿè§‰æ”¾è¿™é‡Œå°±å¤ªå¤§äº†ï¼‰ï¼š</p><p><img src="/images/others/random_thoughts/moon/moon_origin.jpg" alt="æœˆäº®å…¸è—ç‰ˆ"></p><p>æ¥ä¸‹æ¥çœ‹çœ‹æˆ‘æ˜¯æ€ä¹ˆæ‹å‡ºæ¥çš„å§ï¼ç›´æ¥æ‹¿ç€æ‰‹æœºå¯¹ç€æœ›è¿œé•œæ‹åªèƒ½æ‹å‡ºæ¥ä¸€ä¸ªå°å…‰çƒï¼Œæ­£ç¡®çš„åšæ³•æ˜¯è°ƒåˆ°ä¸“ä¸šæ¨¡å¼ç„¶åè°ƒæ•´å‚æ•°ï¼Œæˆ‘çš„K80è‡³å°Šç‰ˆæœ‰è¿™äº›å‚æ•°å¯è°ƒï¼š</p><ol><li>S - å¿«é—¨é€Ÿåº¦ï¼ˆShutter Speedï¼‰</li><li>ISO - æ„Ÿå…‰åº¦</li><li>WB - ç™½å¹³è¡¡</li><li>F - å¯¹ç„¦ï¼ˆFocusï¼‰</li></ol><p>ç›´æ¥æ‹åªèƒ½æ‹å‡ºå°å…‰çƒæ˜¯å› ä¸ºæ‰‹æœºæ‹ç…§é»˜è®¤æ˜¯è‡ªåŠ¨æ¨¡å¼ï¼Œè‡ªåŠ¨æ¨¡å¼çœ‹åˆ°æ•´ä¸ªç”»é¢éƒ½æ˜¯é»‘è‰²çš„ï¼ˆä¼—æ‰€å‘¨çŸ¥å¤œç©ºæ˜¯é»‘çš„ï¼‰å°±ä¼šåŠªåŠ›è°ƒèŠ‚è‡ªåŠ¨æ›å…‰ï¼Œæœ€åå¯¼è‡´è¿‡æ›ã€‚</p><p>ä¸ºäº†é¿å…è¿‡æ›ï¼Œæˆ‘ä»¬è¦åœ¨ä¸“ä¸šæ¨¡å¼é‡ŒæŠŠ S æé«˜ã€ISO é™ä½ã€‚æ€»ä¹‹æˆ‘æœ€åçš„å‚æ•°è®¾ç½®æ˜¯è¿™æ ·çš„ï¼šS: 1/160, ISO: 100, WB: æ²¡è°ƒ, F: æ‹‰åˆ°æœ€å³è¾¹ã€‚ç„¶åå°±èƒ½æ„‰å¿«åœ°æ‹ç…§äº†ï¼</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;ä»Šå¤©æ‹¿å‡ºäº†æˆ‘è€—è´¹ 200 å…ƒå·¨èµ„ä¹°çš„æ£®æ—äººæœ›è¿œé•œè¯•ç€çœ‹æœˆäº®ï¼&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/others/random_thoughts/moon/telescope.jpg&quot; alt=&quot;7x50&quot;&gt;&lt;/p&gt;
&lt;p&gt;åœ¨æ‹¿èµ·æœ›è¿œé•œçœ‹å‘æœˆäº®ä¹‹å‰çœŸçš„å¾ˆéš¾æƒ³è±¡ï¼Œ</summary>
      
    
    
    
    <category term="æ‚è°ˆ" scheme="http://rinevard.github.io/categories/%E6%9D%82%E8%B0%88/"/>
    
    <category term="ç¢ç¢å¿µ" scheme="http://rinevard.github.io/categories/%E6%9D%82%E8%B0%88/%E7%A2%8E%E7%A2%8E%E5%BF%B5/"/>
    
    
  </entry>
  
  <entry>
    <title>Lab 5 Copy-on-Write Fork</title>
    <link href="http://rinevard.github.io/wiki/learning/open-course/MIT-6.S081/Labs/lab5-cow/"/>
    <id>http://rinevard.github.io/wiki/learning/open-course/MIT-6.S081/Labs/lab5-cow/</id>
    <published>2025-11-03T13:56:22.000Z</published>
    <updated>2025-11-03T13:57:01.187Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™ä¸ª Lab è¦æ±‚æˆ‘ä»¬å®ç° cow forkï¼Œè¿™æ˜¯ä¸€ä¸ªå¸¸è§çš„èŠ‚çœå†…å­˜çš„æ‰‹æ®µã€‚</p><p>æ€»è€Œè¨€ä¹‹ï¼Œå°±æ˜¯åœ¨ fork æ—¶æŠŠçˆ¶å­çš„è™šæ‹Ÿå†…å­˜éƒ½æ˜ å°„åˆ°åŸæœ¬çš„çˆ¶è¿›ç¨‹çš„ç‰©ç†å†…å­˜ä¸Šï¼Œå¹¶å°†å…¶è®¾ä¸ºâ€œä»…è¯»â€ã€‚å½“æœ‰è¿›ç¨‹å°è¯•å†™å®ƒä¼šè§¦å‘ page faultï¼Œè¿™æ—¶æˆ‘ä»¬æ‰æ–°å»ºç‰©ç†é¡µï¼Œç„¶åè°ƒæ•´å°è¯•å†™çš„è¿›ç¨‹çš„é¡µè¡¨ï¼Œå°†å¯¹åº”è™šæ‹Ÿé¡µæ˜ å°„åˆ°æ–°å»ºçš„ç‰©ç†é¡µä¸Šã€‚</p><p>è¿™ä¸ª Lab ä¼¼ä¹æ²¡æœ‰å¤ª tricky çš„åœ°æ–¹ï¼Œæ¥ä¸‹æ¥æˆ‘ä¼šè‡ªé—®è‡ªç­”ä¸€ä¸‹ï¼Œåªè¦èƒ½æŠŠè¿™é‡Œçš„ç­”æ¡ˆæƒ³æ˜ç™½åŸºæœ¬å°±èƒ½å†™å¯¹ä»£ç äº†ï¼š</p><ol><li><p>æ€ä¹ˆè®©åªè¯»é¡µæ­£ç¡®åªè¯»ï¼Œè€Œä¸èƒ½è¢«å†™ï¼Ÿ</p><p> æˆ‘ä»¬é€šè¿‡ç»™ PTE è®¾ç½®ä¸€ä¸ª COW ä½æ¥åˆ¤æ–­æ˜¯å¦æ˜¯åªè¯». COW ä¸º 1 è¡¨ç¤ºè¿™ä¸ª PTE åŸæœ¬åº”è¯¥æ˜¯å¯å†™çš„ï¼Œä½†ç°åœ¨è¢«ä¸´æ—¶æ ‡è®°ä¸ºåªè¯»ï¼Œå› ä¸ºå¯¹åº”çš„ç‰©ç†é¡µæ­£åœ¨è¢«å¤šä¸ªè¿›ç¨‹å…±äº«ã€‚</p></li><li><p>ä»€ä¹ˆæ—¶å€™æ–°å»ºç‰©ç†é¡µï¼Ÿæˆ‘ä»¬ä¼šä¸ä¼šå¤šå»ºäº†ä¸å¿…è¦çš„ç‰©ç†é¡µï¼Ÿ</p><p> æˆ‘ä»¬ç»´æŠ¤å¯¹æ¯ä¸ªç‰©ç†é¡µçš„å¼•ç”¨è®¡æ•°ï¼Œå½“å¼•ç”¨è®¡æ•°ä¸º 1 æ—¶å°±æŠŠ COW é‡è®¾ä¸º 0ï¼ˆå› ä¸ºè¿™ä¸ªç‰©ç†é¡µä¸å†è¢«å¤šä¸ªè¿›ç¨‹å…±äº«ï¼‰ï¼ŒæŠŠ W ä½é‡æ–°è®¾ä¸º 1.</p></li><li><p>ä»€ä¹ˆæ—¶å€™é‡Šæ”¾ç‰©ç†é¡µï¼Ÿ</p><p> è°ƒç”¨ kfree æ—¶ï¼Œå¦‚æœå¼•ç”¨è®¡æ•°å¤§äº 1ï¼Œå°†å¼•ç”¨è®¡æ•° -1 ç„¶åä¸åŠ¨ï¼›å¦‚æœå¼•ç”¨è®¡æ•° == 1ï¼Œé‡Šæ”¾ç‰©ç†é¡µã€‚</p></li></ol><p>ç„¶åå°±ä¸Šä»£ç å§ã€‚</p><h1 id="ç‰©ç†å†…å­˜å±‚çš„åŸºå»ºä»£ç "><a href="#ç‰©ç†å†…å­˜å±‚çš„åŸºå»ºä»£ç " class="headerlink" title="ç‰©ç†å†…å­˜å±‚çš„åŸºå»ºä»£ç "></a>ç‰©ç†å†…å­˜å±‚çš„åŸºå»ºä»£ç </h1><p>é¦–å…ˆåœ¨ kalloc.c é‡Œæ–°å»ºä¸€ä¸ªæ•°æ®ç»“æ„ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">spinlock</span> lock<span class="token punctuation">;</span>    <span class="token keyword">int</span> refcnt<span class="token punctuation">[</span>PHYSTOP <span class="token operator">/</span> PGSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> kref<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œæœ‰é”æ˜¯å› ä¸ºæˆ‘ä»¬ä¸å¸Œæœ›å¤šä¸ªè¿›ç¨‹åŒæ—¶è¯»å†™ refcnt. æˆ‘ä»¬è¦åœ¨ kinit é‡Œåˆå§‹åŒ–é”ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">kinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">initlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmem<span class="token punctuation">.</span>lock<span class="token punctuation">,</span> <span class="token string">"kmem"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">initlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kref<span class="token punctuation">.</span>lock<span class="token punctuation">,</span> <span class="token string">"kref"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">freerange</span><span class="token punctuation">(</span>end<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>PHYSTOP<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶åæˆ‘ä»¬æä¾›ä¸‰ä¸ªæ¥å£ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">kaddref</span><span class="token punctuation">(</span>uint64 pa<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kref<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    kref<span class="token punctuation">.</span>refcnt<span class="token punctuation">[</span>pa <span class="token operator">/</span> PGSIZE<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kref<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">kdecref</span><span class="token punctuation">(</span>uint64 pa<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kref<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>kref<span class="token punctuation">.</span>refcnt<span class="token punctuation">[</span>pa <span class="token operator">/</span> PGSIZE<span class="token punctuation">]</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        kref<span class="token punctuation">.</span>refcnt<span class="token punctuation">[</span>pa <span class="token operator">/</span> PGSIZE<span class="token punctuation">]</span> <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kref<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">kgetref</span><span class="token punctuation">(</span>uint64 pa<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> ref<span class="token punctuation">;</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kref<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    ref <span class="token operator">=</span> kref<span class="token punctuation">.</span>refcnt<span class="token punctuation">[</span>pa <span class="token operator">/</span> PGSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kref<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> ref<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¹‹åå°±èƒ½ä¿®æ”¹ kfree å’Œ kalloc äº†ï¼Œè¿™é‡Œæˆ‘æä¾›çš„ kfree æ˜¯æœ‰å¹¶å‘é£é™©çš„ï¼Œå…·ä½“å¯ä»¥çœ‹æ³¨é‡Šï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">kfree</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>pa<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">run</span> <span class="token operator">*</span>r<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>pa <span class="token operator">%</span> PGSIZE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa <span class="token operator">&lt;</span> end <span class="token operator">||</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>pa <span class="token operator">>=</span> PHYSTOP<span class="token punctuation">)</span>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"kfree"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// è¿™é‡Œæœ‰æ½œåœ¨çš„å¹¶å‘é£é™©, å¦‚æœå¤šä¸ªå…±äº«äº†ç‰©ç†é¡µçš„è¿›ç¨‹åŒæ—¶ kfree è¿™ä¸ªç‰©ç†é¡µ,</span>    <span class="token comment">// é‚£ä¹ˆ if (kgetref((uint64)pa) == 0) ä¸‹çš„è¯­å¥å°±æœ‰å¯èƒ½è¢«å¤šä¸ªè¿›ç¨‹è¿›å…¥.</span>    <span class="token comment">// æƒ³ä¿®æ­£ä¹Ÿä¸éš¾, ä¸è°ƒç”¨å‡½æ•°è€Œæ˜¯æ‰‹åŠ¨è¯·æ±‚é”, åœ¨å’Œ refcnt äº¤äº’å®Œåé‡Šæ”¾é”å°±è¡Œ.</span>    <span class="token comment">// ä¸è¿‡ä»‹äºæµ‹è¯•ä»£ç å·²ç»è¿‡äº†, æˆ‘ä»¬å°±ä¸æ”¹åŠ¨äº†</span>    <span class="token function">kdecref</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>pa<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// Free physical memory only when no other reference exists</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">kgetref</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>pa<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// Fill with junk to catch dangling refs.</span>        <span class="token function">memset</span><span class="token punctuation">(</span>pa<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>        r <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">run</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa<span class="token punctuation">;</span>        <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmem<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>        r<span class="token operator">-></span>next <span class="token operator">=</span> kmem<span class="token punctuation">.</span>freelist<span class="token punctuation">;</span>        kmem<span class="token punctuation">.</span>freelist <span class="token operator">=</span> r<span class="token punctuation">;</span>        <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmem<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">kalloc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">run</span> <span class="token operator">*</span>r<span class="token punctuation">;</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmem<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    r <span class="token operator">=</span> kmem<span class="token punctuation">.</span>freelist<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">)</span>        kmem<span class="token punctuation">.</span>freelist <span class="token operator">=</span> r<span class="token operator">-></span>next<span class="token punctuation">;</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmem<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">)</span>        <span class="token function">kaddref</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">)</span>        <span class="token function">memset</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>r<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// fill with junk</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>r<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="COW-ç­–ç•¥å®ç°"><a href="#COW-ç­–ç•¥å®ç°" class="headerlink" title="COW ç­–ç•¥å®ç°"></a>COW ç­–ç•¥å®ç°</h1><p>ç„¶åæˆ‘ä»¬çœ‹å‘ trap.cï¼Œåœ¨ usertrap é‡ŒåŠ å…¥é¡µé”™è¯¯çš„åˆ†æ”¯ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">r_scause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// ...</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>which_dev <span class="token operator">=</span> <span class="token function">devintr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// ...</span><span class="token punctuation">&#125;</span> <span class="token comment">// è¿™é‡Œæ˜¯åŠ å…¥çš„åˆ†æ”¯</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">r_scause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">writefault</span><span class="token punctuation">(</span>p<span class="token operator">-></span>pagetable<span class="token punctuation">,</span> <span class="token function">r_stval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// copy on write</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// ...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ¥ç€æˆ‘ä»¬åˆ° vm.c é‡Œå®ç° writefaultï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// return 0 if error, and physical address if successful.</span>uint64 <span class="token function">writefault</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">,</span> uint64 va<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">pte_t</span> <span class="token operator">*</span>pte<span class="token punctuation">;</span>    uint64 pa<span class="token punctuation">;</span>    uint flags<span class="token punctuation">;</span>    <span class="token keyword">int</span> refcnt<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">proc</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">myproc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>va <span class="token operator">>=</span> p<span class="token operator">-></span>sz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    va <span class="token operator">=</span> <span class="token function">PGROUNDDOWN</span><span class="token punctuation">(</span>va<span class="token punctuation">)</span><span class="token punctuation">;</span>    pte <span class="token operator">=</span> <span class="token function">walk</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> va<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>pte <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    flags <span class="token operator">=</span> <span class="token function">PTE_FLAGS</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> PTE_COW<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// read-only page</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    pa <span class="token operator">=</span> <span class="token function">PTE2PA</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>refcnt <span class="token operator">=</span> <span class="token function">kgetref</span><span class="token punctuation">(</span>pa<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// no process ref this page</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>refcnt <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// only one process ref this page, change it to a regular writeable page</span>        <span class="token operator">*</span>pte <span class="token operator">&amp;=</span> <span class="token punctuation">(</span><span class="token operator">~</span>PTE_COW<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">*</span>pte <span class="token operator">|=</span> <span class="token punctuation">(</span>PTE_W<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> pa<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// copy on write</span>        <span class="token keyword">char</span> <span class="token operator">*</span>mem<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mem <span class="token operator">=</span> <span class="token function">kalloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">memmove</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">*</span>pte <span class="token operator">&amp;=</span> <span class="token punctuation">(</span><span class="token operator">~</span>PTE_V<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// make mappages work</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mappages</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> va<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">,</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>mem<span class="token punctuation">,</span> flags<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">kfree</span><span class="token punctuation">(</span>mem<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token operator">*</span>pte <span class="token operator">&amp;=</span> <span class="token punctuation">(</span><span class="token operator">~</span>PTE_COW<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">*</span>pte <span class="token operator">|=</span> <span class="token punctuation">(</span>PTE_W<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">kdecref</span><span class="token punctuation">(</span>pa<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> pa<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶ååœ¨ uvmcopy é‡ŒåŠ å…¥æŠŠå¤šä¸ªè™šæ‹Ÿå†…å­˜æ˜ å°„åˆ°ç›¸åŒç‰©ç†å†…å­˜çš„æœºåˆ¶ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">uvmcopy</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> old<span class="token punctuation">,</span> <span class="token class-name">pagetable_t</span> new<span class="token punctuation">,</span> uint64 sz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">pte_t</span> <span class="token operator">*</span>pte<span class="token punctuation">;</span>    uint64 pa<span class="token punctuation">,</span> i<span class="token punctuation">;</span>    uint flags<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> sz<span class="token punctuation">;</span> i <span class="token operator">+=</span> PGSIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pte <span class="token operator">=</span> <span class="token function">walk</span><span class="token punctuation">(</span>old<span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmcopy: pte should exist"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmcopy: page not present"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        pa <span class="token operator">=</span> <span class="token function">PTE2PA</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>        flags <span class="token operator">=</span> <span class="token function">PTE_FLAGS</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mappages</span><span class="token punctuation">(</span>new<span class="token punctuation">,</span> i<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">,</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>pa<span class="token punctuation">,</span> flags<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">goto</span> err<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> PTE_W<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">pte_t</span> <span class="token operator">*</span>new_pte <span class="token operator">=</span> <span class="token function">walk</span><span class="token punctuation">(</span>new<span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">*</span>pte <span class="token operator">&amp;=</span> <span class="token punctuation">(</span><span class="token operator">~</span>PTE_W<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">*</span>new_pte <span class="token operator">&amp;=</span> <span class="token punctuation">(</span><span class="token operator">~</span>PTE_W<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">*</span>pte <span class="token operator">|=</span> <span class="token punctuation">(</span>PTE_COW<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">*</span>new_pte <span class="token operator">|=</span> <span class="token punctuation">(</span>PTE_COW<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">kaddref</span><span class="token punctuation">(</span>pa<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>err<span class="token operator">:</span>    <span class="token function">uvmunmap</span><span class="token punctuation">(</span>new<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> i <span class="token operator">/</span> PGSIZE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ€åæ”¹æ”¹ copyout å°±å¯ä»¥ä¸‹ç­äº†ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">copyout</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">,</span> uint64 dstva<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>src<span class="token punctuation">,</span> uint64 len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    uint64 n<span class="token punctuation">,</span> va0<span class="token punctuation">,</span> pa0<span class="token punctuation">;</span>    <span class="token class-name">pte_t</span> <span class="token operator">*</span>pte<span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>len <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        va0 <span class="token operator">=</span> <span class="token function">PGROUNDDOWN</span><span class="token punctuation">(</span>dstva<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>va0 <span class="token operator">>=</span> MAXVA<span class="token punctuation">)</span>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        pte <span class="token operator">=</span> <span class="token function">walk</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> va0<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pte <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_U<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_W<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_COW<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">writefault</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> va0<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// copy on write</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        pa0 <span class="token operator">=</span> <span class="token function">PTE2PA</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>        n <span class="token operator">=</span> PGSIZE <span class="token operator">-</span> <span class="token punctuation">(</span>dstva <span class="token operator">-</span> va0<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">></span> len<span class="token punctuation">)</span>            n <span class="token operator">=</span> len<span class="token punctuation">;</span>        <span class="token function">memmove</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>pa0 <span class="token operator">+</span> <span class="token punctuation">(</span>dstva <span class="token operator">-</span> va0<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> src<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>        len <span class="token operator">-=</span> n<span class="token punctuation">;</span>        src <span class="token operator">+=</span> n<span class="token punctuation">;</span>        dstva <span class="token operator">=</span> va0 <span class="token operator">+</span> PGSIZE<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç­‰ç­‰ï¼Œå…ˆåˆ«æ€¥ç€ä¸‹ç­ï¼Œcopyout æ˜¯åšä»€ä¹ˆçš„ï¼Ÿä¸ºä»€ä¹ˆå®ƒçœ‹èµ·æ¥ç‹¬æ ‘ä¸€å¸œï¼Œè¦æˆ‘ä»¬æ‰‹åŠ¨è°ƒç”¨å¤„ç†å†™æ•…éšœçš„å‡½æ•°ï¼Œè€Œä¸æ˜¯è‡ªåŠ¨è§¦å‘å†™æ•…éšœç„¶åè‡ªåŠ¨è¢«å¤„ç†ï¼Ÿ</p><p>çœ‹çœ‹ä»£ç å¯ä»¥å‘ç°ï¼Œå®ƒæ²¡æœ‰é€šè¿‡ç”¨æˆ·é¡µè¡¨æ¥â€œå†™â€å†…å­˜ï¼Œè€Œæ˜¯é€šè¿‡ç”¨æˆ·é¡µè¡¨æ‹¿åˆ°ç‰©ç†åœ°å€ï¼Œå†é€šè¿‡å†…æ ¸é¡µè¡¨å†™å†…å­˜ã€‚åœ¨è¿™é‡Œï¼Œç¡¬ä»¶åªæ£€æŸ¥å†…æ ¸é¡µè¡¨çš„æƒé™ï¼Œè€Œä¸æ£€æŸ¥ç”¨æˆ·é¡µè¡¨ PTE çš„ PTE_W/COWï¼Œå› æ­¤è‡ªç„¶ä¸ä¼šè§¦å‘å†™æ•…éšœã€‚</p><p>æ€»ä¹‹å°±ä¸‹ç­äº†ï¼Œç„¶åæ”¾å¼ å›¾å›¾å§</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab5-cow/wtf_i_just_want_video_game.png" alt=""></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;è¿™ä¸ª Lab è¦æ±‚æˆ‘ä»¬å®ç° cow forkï¼Œè¿™æ˜¯ä¸€ä¸ªå¸¸è§çš„èŠ‚çœå†…å­˜çš„æ‰‹æ®µã€‚&lt;/p&gt;
&lt;p&gt;æ€»è€Œè¨€ä¹‹ï¼Œå°±æ˜¯åœ¨ fork æ—¶æŠŠçˆ¶å­çš„è™šæ‹Ÿå†…å­˜éƒ½æ˜ å°„åˆ°åŸæœ¬çš„çˆ¶è¿›ç¨‹çš„ç‰©ç†å†…å­˜ä¸Šï¼Œå¹¶å°†å…¶è®¾ä¸ºâ€œä»…è¯»â€ã€‚å½“æœ‰è¿›ç¨‹å°è¯•å†™å®ƒä¼šè§¦å‘ page faultï¼Œè¿™æ—¶æˆ‘ä»¬æ‰æ–°å»ºç‰©ç†é¡µï¼Œç„¶åè°ƒæ•´å°è¯•å†™</summary>
      
    
    
    
    <category term="å…¬å¼€è¯¾" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/"/>
    
    <category term="MIT-6.S081" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/MIT-6-S081/"/>
    
    <category term="Labs" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/MIT-6-S081/Labs/"/>
    
    
  </entry>
  
  <entry>
    <title>Lab 4 Traps</title>
    <link href="http://rinevard.github.io/wiki/learning/open-course/MIT-6.S081/Labs/lab4-traps/"/>
    <id>http://rinevard.github.io/wiki/learning/open-course/MIT-6.S081/Labs/lab4-traps/</id>
    <published>2025-10-30T14:28:22.000Z</published>
    <updated>2025-10-30T14:38:20.127Z</updated>
    
    <content type="html"><![CDATA[<h1 id="RISC-V-assembly"><a href="#RISC-V-assembly" class="headerlink" title="RISC-V assembly"></a><strong>RISC-V assembly</strong></h1><p>åœ¨ lab å¼€å§‹æ—¶ï¼Œæˆ‘ä»¬è¦ç®€å•å›ç­”ä¸€äº›é—®é¢˜ã€‚è¿™é‡Œåªç®€å•èŠèŠæœ€åä¸¤é“ï¼š</p><ol><li><p>ä¸‹é¢çš„ä»£ç ä¼šæ‰“å°ä»€ä¹ˆï¼Ÿ</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0x00646c72</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"H%x Wo%s"</span><span class="token punctuation">,</span> <span class="token number">57616</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p> 57616 è½¬æ¢åˆ°åå…­è¿›åˆ¶æ˜¯ E110ï¼Œæ‰€ä»¥ç©ºæ ¼å‰æ‰“å°çš„æ˜¯ HE110.</p><p> RISC-V ä½¿ç”¨å°ç«¯æ³•ï¼Œæ‰€ä»¥ <code>i</code> åœ¨å†…å­˜ä¸­çš„å­˜å‚¨æ˜¯ <code>72 6c 64 00</code>ï¼Œæ‰€ä»¥ç©ºæ ¼åæ‰“å°çš„æ˜¯ rld.</p><p> æ€»ä¹‹æˆ‘ä»¬æ‰“å°äº† HE110, World!ï¼ˆä»¥åå’±å°±ç”¨è¿™ä¸ªå»æ°´è´´</p></li><li><p>ä¸‹é¢çš„ä»£ç åœ¨ â€œy=â€ åä¼šæ‰“å°ä»€ä¹ˆï¼Ÿ</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"x=%d y=%d"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p> æˆ‘ä»¬æ²¡æœ‰ä¼ å…¥ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šæŠŠå¯„å­˜å™¨ a2 é‡Œçš„ä¸œè¥¿å½“ä½œ int æ¥æ‰“å°ã€‚</p></li></ol><h1 id="Backtrace"><a href="#Backtrace" class="headerlink" title="Backtrace"></a>Backtrace</h1><p>è¿™é‡Œè¦æ±‚æˆ‘ä»¬å®ç°ä¸€ä¸ª backtrace å‡½æ•°ï¼Œæ‰“å°å‡ºå½“å‰è°ƒç”¨æ ˆã€‚</p><h2 id="è§£æ³•"><a href="#è§£æ³•" class="headerlink" title="è§£æ³•"></a>è§£æ³•</h2><p>æˆ‘ä»¬å…ˆæ¥å›é¡¾ä¸€ä¸‹ xv6 çš„æ ˆç»“æ„ï¼š</p><pre class="line-numbers language-none"><code class="language-none">                 .                 .    +-&gt;          .    |   +-----------------+   |    |   | return address  |   |    |   |   previous fp ------+    |   | saved registers |    |   | local variables |    |   |       ...       | &lt;-+    |   +-----------------+   |    |   | return address  |   |    +------ previous fp   |   |        | saved registers |   |        | local variables |   |    +-&gt; |       ...       |   |    |   +-----------------+   |    |   | return address  |   |    |   |   previous fp ------+    |   | saved registers |    |   | local variables |    |   |       ...       | &lt;-+    |   +-----------------+   |    |   | return address  |   |    +------ previous fp   |   |        | saved registers |   |        | local variables |   |$fp --&gt; |       ...       |   |        +-----------------+   |        | return address  |   |        |   previous fp ------+        | saved registers |$sp --&gt; | local variables |        +-----------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥æ¦‚æ‹¬ç®—æ³•æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>æ‰¾åˆ°å½“å‰ stack frame çš„ fpï¼Œè¿™åœ¨åˆå§‹åŒ–æ—¶å°±æ˜¯æ‰¾åˆ°å¯„å­˜å™¨ s0 é‡Œå­˜å‚¨çš„æŒ‡é’ˆã€‚</li><li>æ‰¾åˆ°å½“å‰ stack frame çš„ previous fpï¼Œåˆ¤æ–­ previous fp å’Œå½“å‰ fp æ˜¯å¦åœ¨ä¸€ä¸ª page å†…<ol><li>å¦‚æœåœ¨ï¼Œç”¨ %p æ‰“å°è¿™ä¸ª frame å­˜å‚¨çš„è·³è½¬å€¼ï¼Œç„¶åç»§ç»­å¾ªç¯</li><li>å¦‚æœä¸åœ¨å°±ç»“æŸå¾ªç¯</li></ol></li></ol><p>æ€»ä¹‹ä»£ç å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">backtrace</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    uint64 fp <span class="token operator">=</span> <span class="token function">r_fp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"backtrace:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>uint64 cur_fp <span class="token operator">=</span> fp<span class="token punctuation">;</span> <span class="token function">PGROUNDDOWN</span><span class="token punctuation">(</span>cur_fp<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">PGROUNDDOWN</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>         cur_fp <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>uint64 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>cur_fp <span class="token operator">-</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        uint64 ret_addr <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>uint64 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>cur_fp <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%p\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>ret_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="å’Œ-CSAPP-ä»‹ç»çš„æ ˆç»“æ„çš„å¯¹æ¯”"><a href="#å’Œ-CSAPP-ä»‹ç»çš„æ ˆç»“æ„çš„å¯¹æ¯”" class="headerlink" title="å’Œ CSAPP ä»‹ç»çš„æ ˆç»“æ„çš„å¯¹æ¯”"></a>å’Œ CSAPP ä»‹ç»çš„æ ˆç»“æ„çš„å¯¹æ¯”</h2><p>æˆ‘ä»¬ä¼šæ³¨æ„åˆ° xv6 çš„æ ˆç»“æ„å’Œ CSAPP é‡Œä»‹ç»çš„ç•¥æœ‰å·®å¼‚ï¼Œä¸»è¦æ˜¯ CSAPP çš„æ ˆå¸§ä¸åŒ…å« <code>previous fp</code>ã€‚ä¸‹é¢çš„æ˜¯ CSAPP ä»‹ç»çš„æ ˆç»“æ„</p><pre class="line-numbers language-none"><code class="language-none">é«˜åœ°å€            |  å‚æ•°7                |            |  å‚æ•°8                |            |  ...                 |  â† è°ƒç”¨å‰push            |  è¿”å›åœ°å€             |  â† callæŒ‡ä»¤è‡ªåŠ¨push            |  ä¿å­˜çš„å¯„å­˜å™¨å€¼        |  â† åˆšè¿›å…¥å‡½æ•°æ—¶push            |  æœ¬åœ°å˜é‡1            |            |  æœ¬åœ°å˜é‡2            |            |  ...                 |   â† å½“å‰rspæŒ‡å‘è¿™é‡Œä½åœ°å€<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸‹é¢æˆ‘ä»¬æ¥ç¼–è¯‘ CSAPP ä¹¦ä¸­çš„ä¸€æ®µä»£ç ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">long</span> <span class="token function">caller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">long</span> arg1 <span class="token operator">=</span> <span class="token number">534</span><span class="token punctuation">;</span>    <span class="token keyword">long</span> arg2 <span class="token operator">=</span> <span class="token number">1057</span><span class="token punctuation">;</span>    <span class="token keyword">long</span> sum <span class="token operator">=</span> <span class="token function">swap_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>arg1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>arg2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">long</span> diff <span class="token operator">=</span> arg1 <span class="token operator">-</span> arg2<span class="token punctuation">;</span>    <span class="token keyword">return</span> sum <span class="token operator">*</span> diff<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œæ˜¯ CSAPP ä¹¦ä¸Šç»™å‡ºçš„ç¼–è¯‘ç»“æœï¼š</p><pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token label function">caller:</span>    subq    <span class="token number">$16</span>, <span class="token operator">%</span><span class="token register variable">rsp</span>       <span class="token comment">; Allocate 16 bytes for stack frame</span>    movq    <span class="token number">$534</span>, (<span class="token operator">%</span><span class="token register variable">rsp</span>)    <span class="token comment">; Store 534 in arg1</span>    movq    <span class="token number">$1057</span>, <span class="token number">8</span>(<span class="token operator">%</span><span class="token register variable">rsp</span>)  <span class="token comment">; Store 1057 in arg2</span>    leaq    <span class="token number">8</span>(<span class="token operator">%</span><span class="token register variable">rsp</span>), <span class="token operator">%</span><span class="token register variable">rsi</span>   <span class="token comment">; Compute &amp;arg2 as second argument</span>    movq    <span class="token operator">%</span><span class="token register variable">rsp</span>, <span class="token operator">%</span><span class="token register variable">rdi</span>      <span class="token comment">; Compute &amp;arg1 as first argument</span>    call    swap_add        <span class="token comment">; Call swap_add(&amp;arg1, &amp;arg2)</span>    movq    (<span class="token operator">%</span><span class="token register variable">rsp</span>), <span class="token operator">%</span><span class="token register variable">rdx</span>    <span class="token comment">; Get arg1</span>    subq    <span class="token number">8</span>(<span class="token operator">%</span><span class="token register variable">rsp</span>), <span class="token operator">%</span><span class="token register variable">rdx</span>   <span class="token comment">; Compute diff = arg1 - arg2</span>    imulq   <span class="token operator">%</span><span class="token register variable">rdx</span>, <span class="token operator">%</span><span class="token register variable">rax</span>      <span class="token comment">; Compute sum * diff</span>    addq    <span class="token number">$16</span>, <span class="token operator">%</span><span class="token register variable">rsp</span>       <span class="token comment">; Deallocate stack frame</span>    ret                     <span class="token comment">; Return</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œåˆ™æ˜¯åœ¨ xv6 é‡Œå¾—åˆ°çš„ç¼–è¯‘ç»“æœï¼š</p><pre class="line-numbers language-none"><code class="language-none">0000000000000034 &lt;caller&gt;:long caller()  34:1141                addisp,sp,-16  36:e422                sds0,8(sp)  38:0800                addis0,sp,16  3a:000cb537            luia0,0xcb  3e:25d50513            addia0,a0,605 # cb25d &lt;base+0xca24d&gt;  42:6422                lds0,8(sp)  44:0141                addisp,sp,16  46:8082                ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥æ³¨æ„åˆ° CSAPP åªæ˜¯æŠŠå±€éƒ¨å˜é‡ arg1 å’Œ arg2 å­˜å‚¨åœ¨äº†æ ˆä¸­ï¼Œè€Œ xv6 çš„ <code>sd s0,8(sp)</code> æŠŠè°ƒç”¨è€…çš„æ ˆå¸§æŒ‡é’ˆå‹å…¥äº†æ ˆä¸­ã€‚</p><p>äº§ç”Ÿè¿™ç§å·®å¼‚çš„åŸå› æ˜¯ç¼–è¯‘å™¨çš„ä¼˜åŒ–ï¼ŒCSAPP é‡Œçš„ç¼–è¯‘å™¨è®¤ä¸ºé€šè¿‡ <code>subq $16, %rsp</code> å’Œ <code>addq $16, %rsp</code> å°±èƒ½å®Œæˆè¿™ä¸ªå‡½æ•°çš„å·¥ä½œï¼Œæ‰€ä»¥æ²¡æœ‰å­˜å‚¨æ ˆå¸§æŒ‡é’ˆï¼›xv6 åˆ™ä¸ºäº†æ–¹ä¾¿æ•™å­¦ï¼ŒåŒ…å«äº†æ ˆå¸§æŒ‡é’ˆã€‚</p><h1 id="Alarm"><a href="#Alarm" class="headerlink" title="Alarm"></a>Alarm</h1><p>è¿™é‡Œæˆ‘ä»¬è¦å®ç°ä¸€ä¸ªå«åš <code>sigalarm(interval, handler)</code> çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå®ƒä¼šæ¯éš” interval ä¸ª ticks è°ƒç”¨ä¸€æ¬¡ handler. </p><p>æ¯ä¸ª tick éƒ½ä¼šäº§ç”Ÿä¸€ä¸ªä¸­æ–­ï¼Œæˆ‘ä»¬è¦åšçš„å°±æ˜¯æ¯ä¸­æ–­è‹¥å¹²æ¬¡è°ƒç”¨ä¸€ä¸‹ handler.</p><p>æˆ‘ä»¬è¿˜éœ€è¦å®ç° <code>sigreturn</code>ï¼Œå®ƒæ˜¯ä¸€ä¸ªè¾…åŠ© <code>sigalarm</code> æ­£ç¡®å·¥ä½œçš„ç³»ç»Ÿè°ƒç”¨ã€‚æˆ‘ä»¬æœ‰è¿™æ ·çš„ promiseâ€”â€”ç”¨æˆ·åœ¨è°ƒç”¨ <code>sigalram</code> æ—¶æä¾›çš„ handler å‡½æ•°å¿…é¡»åœ¨ç»“å°¾è°ƒç”¨ <code>sigreturn</code>ã€‚æ€»ä¹‹ï¼Œ<code>sigreturn</code> çš„å·¥ä½œä¸»è¦æ˜¯æŠŠç”¨æˆ·è¿›ç¨‹çŠ¶æ€æ¢å¤åˆ°è¢«ä¸­æ–­æ—¶çš„çŠ¶æ€ã€‚</p><h2 id="å¼€å·¥ï¼"><a href="#å¼€å·¥ï¼" class="headerlink" title="å¼€å·¥ï¼"></a>å¼€å·¥ï¼</h2><p>æˆ‘ä»¬å¯ä»¥æŒ‰ä¸‹é¢çš„æµç¨‹å®Œæˆä»»åŠ¡ï¼š</p><ol><li><p>åœ¨å¼€å§‹ä¹‹å‰ï¼š</p><p> åœ¨ <code>usys.pl</code> ç­‰åœ°æ–¹åšä¸€äº›åŸºå»ºæ¥æŠŠä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨åŠ å…¥åˆ°ç³»ç»Ÿé‡Œ</p></li><li><p>æ¯éš”è‹¥å¹² ticks è°ƒç”¨ä¸€æ¬¡ handlerï¼š</p><p> åœ¨ <code>proc.h</code> é‡ŒåŠ å…¥å­˜å‚¨ intervalã€handler ä»¥åŠè·ç¦»ä¸Šä¸€æ¬¡è°ƒç”¨ handler è¿‡å»çš„ ticks çš„å­—æ®µ</p><p> åœ¨ <code>sysproc.c</code> é‡Œå®ç° <code>sys_sigalarm</code>ï¼Œå®ƒè®°å½•å¹¶å­˜å‚¨ç”¨æˆ·ä¼ è¿›æ¥çš„ interval å’Œ handler</p><p> åœ¨ <code>trap.c</code> çš„ <code>usertrap</code> é‡ŒåŠ å…¥å¯¹ handler çš„è°ƒç”¨ã€‚è¿˜è®°å¾—å—ï¼Œå½“æ‰§è¡Œ SERT æ—¶ï¼Œç¨‹åºè®¡æ•°å™¨ pc è¢«è®¾ç½®ä¸ºå­˜å‚¨åœ¨ sepc å¯„å­˜å™¨ä¸­çš„å€¼ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ä¿®æ”¹ <code>p-&gt;trapframe-&gt;epc</code>.</p></li><li><p>æŠŠç”¨æˆ·è¿›ç¨‹çŠ¶æ€æ¢å¤åˆ°è¢«ä¸­æ–­æ—¶çš„çŠ¶æ€ï¼š</p><p> æˆ‘ä»¬éœ€è¦ä¿å­˜çš„æ˜¯ç”¨æˆ·ä¸­æ–­æ—¶çš„ <code>struct trapframe</code>. æ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨ proc.h é‡Œæ–°å¢ <code>struct trapframe alarm_tf</code> å­—æ®µï¼Œåœ¨ handler è¢«è°ƒç”¨æ—¶æŠŠ p-&gt;trapframe å¤åˆ¶åˆ° alarm_tfï¼Œå¹¶åœ¨ <code>sys_sigreturn</code> è¢«è°ƒç”¨æ—¶æŠŠ alarm_tf å¤åˆ¶å› p-&gt;trapframe.</p></li></ol><p>æˆ‘ä»¬å°±ç›´æ¥æ”¾æœ€ç»ˆä»£ç äº†ã€‚</p><p>é¦–å…ˆåœ¨ proc.h çš„ struct proc é‡Œæ–°å¢è¿™äº›å­—æ®µï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> alarm_freq<span class="token punctuation">;</span>              <span class="token comment">// How many ticks to call alarm_handler once</span>uint64 alarm_handler<span class="token punctuation">;</span>        <span class="token comment">// Handler's user virtual address</span><span class="token keyword">int</span> tick_from_last<span class="token punctuation">;</span>          <span class="token comment">// How many ticks have passed since the last call</span><span class="token keyword">int</span> is_alarming<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">trapframe</span> alarm_tf<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶ååœ¨ sys_proc.c é‡ŒæŠŠç”¨æˆ·ä¼ å…¥çš„ interval å’Œ handler ä¿å­˜ä¸‹æ¥ï¼Œå¹¶åˆå§‹åŒ–ä¸€äº›å’Œè°ƒç”¨ handler ç›¸å…³çš„å˜é‡ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">uint64 <span class="token function">sys_sigalarm</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> ticks<span class="token punctuation">;</span>    uint64 handler<span class="token punctuation">;</span>    <span class="token function">argint</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>ticks<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">argaddr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">myproc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>alarm_freq <span class="token operator">=</span> ticks<span class="token punctuation">;</span>    <span class="token function">myproc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>alarm_handler <span class="token operator">=</span> handler<span class="token punctuation">;</span>    <span class="token function">myproc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>tick_from_last <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">myproc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>is_alarming <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¹‹åä¿®æ”¹ trap.c å®Œæˆå¯¹ handler çš„è°ƒç”¨ä»¥åŠå¯¹ç”¨æˆ·è¿›ç¨‹çŠ¶æ€çš„ä¿å­˜ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span>which_dev <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-></span>alarm_freq <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>p<span class="token operator">-></span>is_alarming <span class="token operator">&amp;&amp;</span> p<span class="token operator">-></span>tick_from_last <span class="token operator">>=</span> p<span class="token operator">-></span>alarm_freq <span class="token operator">&amp;&amp;</span>            p<span class="token operator">-></span>tick_from_last <span class="token operator">%</span> p<span class="token operator">-></span>alarm_freq <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            p<span class="token operator">-></span>is_alarming <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token function">memmove</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token operator">-></span>alarm_tf<span class="token punctuation">,</span> p<span class="token operator">-></span>trapframe<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token operator">-></span>trapframe<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            p<span class="token operator">-></span>trapframe<span class="token operator">-></span>epc <span class="token operator">=</span> p<span class="token operator">-></span>alarm_handler<span class="token punctuation">;</span>            p<span class="token operator">-></span>tick_from_last <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            p<span class="token operator">-></span>tick_from_last <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ€ååœ¨è¿”å›æ—¶é‡ç½®ç”¨æˆ·è¿›ç¨‹çŠ¶æ€ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">uint64 <span class="token function">sys_sigreturn</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">proc</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">myproc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">memmove</span><span class="token punctuation">(</span>p<span class="token operator">-></span>trapframe<span class="token punctuation">,</span> <span class="token operator">&amp;</span>p<span class="token operator">-></span>alarm_tf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token operator">-></span>trapframe<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    p<span class="token operator">-></span>is_alarming <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> p<span class="token operator">-></span>alarm_tf<span class="token punctuation">.</span>a0<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="ä¸€äº›å°æƒ³æ³•"><a href="#ä¸€äº›å°æƒ³æ³•" class="headerlink" title="ä¸€äº›å°æƒ³æ³•"></a>ä¸€äº›å°æƒ³æ³•</h2><p>ä¸ºä»€ä¹ˆè¯´â€œPrevent re-entrant calls to the handlerâ€”-if a handler hasnâ€™t returned yet, the kernel shouldnâ€™t call it again. test2 tests this.â€ï¼Œå³ä¸èƒ½åœ¨ä¸Šæ¬¡å¯¹ handler çš„è°ƒç”¨å®Œæˆå‰è¿›è¡Œä¸‹æ¬¡è°ƒç”¨ï¼Ÿæˆ‘çŒœæ˜¯å› ä¸ºæˆ‘ä»¬ä¼šä¿å­˜è°ƒç”¨å‰çš„ç”¨æˆ·è¿›ç¨‹çŠ¶æ€ï¼Œè€Œåœ¨ä¸Šæ¬¡ handler å®Œæˆå‰å†æ¬¡è°ƒç”¨ handler å°±ä¼šä¿å­˜ä¸Šæ¬¡ handler æ­£åœ¨æ‰§è¡Œæ—¶çš„ç”¨æˆ·è¿›ç¨‹çŠ¶æ€ï¼Œè¿™ä¼šè¦†ç›–æœ€å¼€å§‹çš„ç”¨æˆ·è¿›ç¨‹çŠ¶æ€ã€‚</p><p>å†è¯´å¥é¢˜å¤–è¯ï¼Œæ„Ÿè§‰ Page Tables çš„ hard çš„éš¾åº¦æ¯”è¿™ä¸ªéš¾ä¸å°‘â€¦â€¦æœç„¶ All hards are hard, but some hards are harder than othersğŸ« ğŸ« </p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;RISC-V-assembly&quot;&gt;&lt;a href=&quot;#RISC-V-assembly&quot; class=&quot;headerlink&quot; title=&quot;RISC-V assembly&quot;&gt;&lt;/a&gt;&lt;strong&gt;RISC-V assembly&lt;/strong&gt;&lt;/h1&gt;&lt;p&gt;åœ¨</summary>
      
    
    
    
    <category term="å…¬å¼€è¯¾" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/"/>
    
    <category term="MIT-6.S081" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/MIT-6-S081/"/>
    
    <category term="Labs" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/MIT-6-S081/Labs/"/>
    
    
  </entry>
  
  <entry>
    <title>Lab 3 Page Tables</title>
    <link href="http://rinevard.github.io/wiki/learning/open-course/MIT-6.S081/Labs/lab3-pagetable/"/>
    <id>http://rinevard.github.io/wiki/learning/open-course/MIT-6.S081/Labs/lab3-pagetable/</id>
    <published>2025-10-28T08:28:22.000Z</published>
    <updated>2025-10-28T08:29:01.912Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Inspect-a-user-process-page-table"><a href="#Inspect-a-user-process-page-table" class="headerlink" title="Inspect a user-process page table"></a><strong>Inspect a user-process page table</strong></h1><p>è¿™é“é¢˜è®©æˆ‘ä»¬è§£é‡Šä¸€ä¸‹ <code>print_pgtbl</code> çš„æ‰“å°ç»“æœï¼Œé¦–å…ˆè®©æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒæ‰“å°äº†ä»€ä¹ˆï¼š</p><pre class="line-numbers language-none"><code class="language-none">print_pgtbl startingva 0x0 pte 0x21FCD85B pa 0x87F36000 perm 0x5Bva 0x1000 pte 0x21FD141B pa 0x87F45000 perm 0x1Bva 0x2000 pte 0x21FD1017 pa 0x87F44000 perm 0x17va 0x3000 pte 0x21FD4007 pa 0x87F50000 perm 0x7va 0x4000 pte 0x21FC70D7 pa 0x87F1C000 perm 0xD7va 0x5000 pte 0x0 pa 0x0 perm 0x0va 0x6000 pte 0x0 pa 0x0 perm 0x0va 0x7000 pte 0x0 pa 0x0 perm 0x0va 0x8000 pte 0x0 pa 0x0 perm 0x0va 0x9000 pte 0x0 pa 0x0 perm 0x0va 0xFFFF6000 pte 0x0 pa 0x0 perm 0x0va 0xFFFF7000 pte 0x0 pa 0x0 perm 0x0va 0xFFFF8000 pte 0x0 pa 0x0 perm 0x0va 0xFFFF9000 pte 0x0 pa 0x0 perm 0x0va 0xFFFFA000 pte 0x0 pa 0x0 perm 0x0va 0xFFFFB000 pte 0x0 pa 0x0 perm 0x0va 0xFFFFC000 pte 0x0 pa 0x0 perm 0x0va 0xFFFFD000 pte 0x0 pa 0x0 perm 0x0va 0xFFFFE000 pte 0x21FC94C7 pa 0x87F25000 perm 0xC7va 0xFFFFF000 pte 0x2000184B pa 0x80006000 perm 0x4Bprint_pgtbl: OK<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç»“åˆ <code>print_pgtbl</code> çš„å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ <code>pgtbltest</code> éå†äº†ç”¨æˆ·è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´å¼€å¤´å’Œæœ«å°¾çš„ä¸€äº›åœ°å€ï¼Œå¹¶æ‰“å°å‡ºå®ƒä»¬å¯¹åº”çš„ PTEã€ç‰©ç†åœ°å€ã€æƒé™ä½ã€‚è®©æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ PTE çš„ç»“æ„ï¼š</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab3-pagetable/pte.png" alt=""></p><p>ç„¶åæˆ‘ä»¬ä»¥ <code>va 0x4000 pte 0x21FC70D7 pa 0x87F1C000 perm 0xD7</code> ä¸ºä¾‹ï¼Œè§£æä¸€ä¸‹å…¶æ‰“å°çš„å†…å®¹ã€‚é¦–å…ˆæˆ‘ä»¬ä» PTE ä¸­æå–å‡º Physical Page Numberï¼ˆPPNï¼‰å’Œæƒé™ä½ï¼š</p><pre class="line-numbers language-none"><code class="language-none">&#x2F;&#x2F; æ‰“å° PPN&#x2F;&#x2F; è™šæ‹Ÿåœ°å€çš„æœ«å°¾ 12 ä½æ˜¯ 0, æ‰€ä»¥ç‰©ç†åœ°å€åç§»é‡ä¸º 0&#x2F;&#x2F; ç‰©ç†åœ°å€ä¸º ((pte &gt;&gt; 10) &lt;&lt; 12) + 0 å³ 0x87f1c000(gdb) p &#x2F;x (0x21FC70D7 &gt;&gt; 10)$17 &#x3D; 0x87f1c&#x2F;&#x2F; æ„é€ ä¸€ä¸ªæœ«å°¾ 10 ä½ä¸º 1 çš„é‡, æ–¹ä¾¿åç»­å–å‡ºæƒé™ä½(gdb) set $mask &#x3D; ((1 &lt;&lt; 10) - 1)(gdb) p &#x2F;t $mask$18 &#x3D; 1111111111&#x2F;&#x2F; åˆ†åˆ«ç”¨äºŒè¿›åˆ¶å’Œåå…­è¿›åˆ¶æ‰“å°æƒé™ä½(gdb) p &#x2F;t (0x21FC70D7 &amp; $mask)$19 &#x3D; 11010111(gdb) p &#x2F;x (0x21FC70D7 &amp; $mask)$20 &#x3D; 0xd7<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ£€éªŒå¯çŸ¥å’Œ <code>print_pgtbl</code> çš„æ‰“å°ç»“æœä¸€è‡´ã€‚å¯¹ç…§æƒé™ä½çš„æœ«äº”ä½ 10111 å’Œ PTE çš„æœ«å°¾äº”ä½ UXWRVï¼Œå¯çŸ¥è¿™é‡Œæ˜¯ç”¨æˆ·å†…å­˜ã€ä¸å¯æ‰§è¡Œã€å¯å†™ã€å¯è¯»ã€åˆæ³•ã€‚</p><p>æˆ‘ä»¬å¯ä»¥å†æ£€æŸ¥ä¸€ä¸‹ <code>va 0xFFFFF000 pte 0x2000184B pa 0x80006000 perm 0x4B</code>ï¼Œä¼šå‘ç°å®ƒçš„æƒé™ä½æœ«äº”ä½æ˜¯ 01011ï¼Œè¯´æ˜è¿™é‡Œæ˜¯éç”¨æˆ·å†…å­˜ã€å¯ä»¥æ‰§è¡Œã€ä¸å¯å†™ã€å¯è¯»ã€åˆæ³•ã€‚</p><p>å¯¹ç…§ä¸‹é¢çš„ç”¨æˆ·è¿›ç¨‹è™šæ‹Ÿå†…å­˜ç©ºé—´å›¾å¯çŸ¥æˆ‘ä»¬åˆ†æçš„ç¬¬ä¸€æ®µè™šæ‹Ÿåœ°å€ <code>0x4000</code> å¤§çº¦åœ¨å¼€å¤´ä½ç½®ï¼Œç¡®å®æ˜¯ç”¨æˆ·çš„ä¸œè¥¿ï¼›è€Œåˆ†æçš„ç¬¬äºŒæ®µ <code>0xFFFFF000</code> åˆ™åœ¨æ¥è¿‘æœ«å°¾çš„ä½ç½®ï¼Œç”¨äºå­˜å‚¨ç³»ç»Ÿè°ƒç”¨ç›¸å…³çš„é™·é˜±ä»£ç ã€‚</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab3-pagetable/user_addr_space.png" alt=""></p><p>æˆ‘ä»¬è¿˜å¯ä»¥è¿›ä¸€æ­¥æ‰“å°ä¸€ä¸‹å†…å­˜é‡Œçš„å€¼ã€‚å¯åŠ¨ gdbï¼Œç”¨ <code>file user/_pgtbltest</code> åŠ è½½ç¬¦å·è¡¨ï¼Œç„¶ååœ¨ <code>main</code> è®¾ç½®æ–­ç‚¹ï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½åœ¨åŠ è½½ç”¨æˆ·é¡µè¡¨æ—¶æ‰“å°å„ä¸ªè™šæ‹Ÿåœ°å€çš„å€¼ï¼š</p><pre class="line-numbers language-none"><code class="language-none">(gdb) p *0x0$7 &#x3D; -335146751(gdb) p *0x1000$8 &#x3D; 72(gdb) p *0x5000Cannot access memory at address 0x5000(gdb) p *0xFFFFE000Cannot access memory at address 0xffffe000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯¹ç…§æœ€å¼€å§‹çš„ <code>print_pgtbl</code> çš„æ‰“å°ç»“æœï¼ˆå…³æ³¨å…¶æƒé™ä½ï¼‰ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬èƒ½æ­£ç¡®æ‰“å° <code>0x0</code> å’Œ <code>0x1000</code> ï¼Œå®ƒä»¬æ˜¯ç”¨æˆ·å†…å­˜ã€å¯è¯»ã€åˆæ³•çš„è™šæ‹Ÿåœ°å€çš„å†…å®¹ã€‚è€Œ <code>0x5000</code> æ˜¯ä¸åˆæ³•çš„åœ°å€æ‰€ä»¥æ— æ³•æ‰“å°ï¼Œ<code>0xFFFFE000</code> æ˜¯éç”¨æˆ·å†…å­˜ï¼ˆå†…æ ¸å†…å­˜ï¼‰æ‰€ä»¥æ— æ³•æ‰“å°ã€‚</p><h1 id="Speed-up-system-calls"><a href="#Speed-up-system-calls" class="headerlink" title="Speed up system calls"></a>Speed up system calls</h1><p>è¿™é“é¢˜è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç‰¹æ®Šçš„å†…å­˜é¡µå¹¶æŠŠè¿›ç¨‹ pid å­˜å‚¨åœ¨é‡Œé¢ï¼Œè¿™æ ·æˆ‘ä»¬åœ¨è·å– pid æ—¶å°±ä¸å¿…åšç³»ç»Ÿè°ƒç”¨ <code>getpid</code>ï¼Œè€Œæ˜¯å¯ä»¥ç›´æ¥è°ƒç”¨ <code>ugetpid</code>ï¼Œä»è€Œæ— éœ€é™·å…¥å†…æ ¸ä»¥æé«˜æ•ˆç‡ã€‚</p><p>æç¤ºé‡Œè¯´æˆ‘ä»¬åˆ›å»ºçš„è¿™ä¸ªé¡µé¢ä¼šå’Œ <code>trapframe</code> æœ‰å¾ˆå¤šç›¸ä¼¼ä¹‹å¤„â€”â€”å®ƒä»¬éƒ½åœ¨è¿›ç¨‹åˆå§‹åŒ–æ—¶è‡ªåŠ¨åˆ›å»ºï¼Œåœ¨è¿›ç¨‹é€€å‡ºæ—¶è‡ªåŠ¨é‡Šæ”¾ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥å®Œæˆä»»åŠ¡ï¼š</p><ol><li>å®šä¹‰ <code>usyscall</code>ï¼šåœ¨ <code>struct proc</code> é‡Œæ·»åŠ  <code>struct usyscall *usyscall</code></li><li><p>è¿›ç¨‹åˆå§‹åŒ–æ—¶åˆ›å»ºé¡µé¢ï¼šé˜…è¯» <code>fork</code> çš„ä»£ç å¯ä»¥çŸ¥é“æˆ‘ä»¬è°ƒç”¨ <code>allocproc</code> ä»¥åˆ›å»ºè¿›ç¨‹ã€‚</p><p> åœ¨ <code>allocproc</code> é‡Œï¼Œæˆ‘ä»¬ç”¨ <code>kalloc</code> ç»™ <code>trapframe</code> åˆ†é…äº†ä¸€ä¸ªç‰©ç†é¡µï¼Œç„¶åè°ƒç”¨ <code>proc_pagetable</code> æ¥åšé¡µè¡¨æ˜ å°„ã€‚</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">proc</span> <span class="token operator">*</span><span class="token function">allocproc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// ...</span>    <span class="token comment">// Allocate a trapframe page.</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token operator">-></span>trapframe <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">trapframe</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">kalloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">freeproc</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// An empty user page table.</span>    p<span class="token operator">-></span>pagetable <span class="token operator">=</span> <span class="token function">proc_pagetable</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p> æ‰€ä»¥ç…§è‘«èŠ¦ç”»ç“¢å°±è¡Œï¼Œå…ˆåœ¨ <code>allocproc</code> é‡ŒåŠ å…¥ç»™ <code>usyscall</code> åˆ†é…ç‰©ç†é¡µçš„ä»£ç ï¼ˆè®°å¾—æŠŠ <code>pid</code> å­˜è¿›å»ï¼‰ï¼š</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// Allocate a usyscall page</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token operator">-></span>usyscall <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">usyscall</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">kalloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">freeproc</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>p<span class="token operator">-></span>usyscall<span class="token operator">-></span>pid <span class="token operator">=</span> p<span class="token operator">-></span>pid<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p> ç„¶ååœ¨ <code>proc_pagetable</code> åŠ å…¥é¡µè¡¨æ˜ å°„çš„ä»£ç ï¼š</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// map the usyscall page just below the trapframe page, for</span><span class="token comment">// data sharing between userspace and the kernel</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mappages</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> USYSCALL<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">,</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span><span class="token punctuation">(</span>p<span class="token operator">-></span>usyscall<span class="token punctuation">)</span><span class="token punctuation">,</span>             PTE_R <span class="token operator">|</span> PTE_U<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">uvmunmap</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> TRAPFRAME<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">uvmunmap</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> TRAMPOLINE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">uvmfree</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>é€€å‡ºæ—¶é‡Šæ”¾ï¼šæˆ‘ä»¬çŸ¥é“è¿›ç¨‹è°ƒç”¨ <code>exit</code> æ¥ä¸‹ç­ï¼Œä½†å…¶å®è°ƒç”¨ <code>exit</code> åè¿›ç¨‹å¹¶æ²¡æœ‰ç«‹å³é”€æ¯è‡ªèº«ï¼Œè€Œæ˜¯è¿›å…¥ ZOMBIE æ€ç­‰å¾…çˆ¶è¿›ç¨‹çš„ <code>wait</code> æ¥å›æ”¶ã€‚å…·ä½“å¯ä»¥çœ‹çœ‹ <code>proc.c</code>ï¼Œè¿™é‡Œä¸å¤šèµ˜è¿°ã€‚</p><p> æ€»ä¹‹çœ‹å‘ <code>wait</code> å‡½æ•°ï¼Œå¯ä»¥å‘ç°æˆ‘ä»¬è°ƒç”¨ <code>freeproc</code> æ¥é‡Šæ”¾è¿›ç¨‹ã€‚</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">freeproc</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">proc</span> <span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-></span>trapframe<span class="token punctuation">)</span>        <span class="token function">kfree</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token operator">-></span>trapframe<span class="token punctuation">)</span><span class="token punctuation">;</span>    p<span class="token operator">-></span>trapframe <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-></span>pagetable<span class="token punctuation">)</span>        <span class="token function">proc_freepagetable</span><span class="token punctuation">(</span>p<span class="token operator">-></span>pagetable<span class="token punctuation">,</span> p<span class="token operator">-></span>sz<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p> å¯¹ç…§ä»£ç å¯¹ <code>trapframe</code> çš„å¤„ç†ï¼Œæˆ‘ä»¬è¦åœ¨ <code>freeproc</code> é‡ŒåŠ å…¥é‡Šæ”¾ç‰©ç†é¡µçš„ä»£ç ï¼š</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-></span>usyscall<span class="token punctuation">)</span>    <span class="token function">kfree</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token operator">-></span>usyscall<span class="token punctuation">)</span><span class="token punctuation">;</span>p<span class="token operator">-></span>usyscall <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p> ç„¶åä¿®æ”¹ <code>proc_freepagetable</code> ä»¥åˆ é™¤é¡µè¡¨æ˜ å°„ï¼š</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">uvmunmap</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> USYSCALL<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ol><p>é—²ç€ä¹Ÿæ˜¯é—²ç€ï¼Œä¸å¦‚å’Œæˆ‘ä¸€èµ·çœ‹çœ‹ <code>uvmfree</code> ä¸ºä»€ä¹ˆæ²¡æœ‰è‡ªåŠ¨é‡Šæ”¾ <code>trapframe</code> å’Œ <code>usyscall</code>ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">uvmfree</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">,</span> uint64 sz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>sz <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token function">uvmunmap</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">PGROUNDUP</span><span class="token punctuation">(</span>sz<span class="token punctuation">)</span> <span class="token operator">/</span> PGSIZE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">freewalk</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™æ®µä»£ç è°ƒç”¨ <code>uvmunmap</code> æ¥é‡Šæ”¾æ‰€æœ‰åœ¨é¡µè¡¨é‡Œæœ‰è®°å½•çš„ç‰©ç†é¡µï¼Œç„¶åè°ƒç”¨ <code>freewalk</code> æ¥é‡Šæ”¾é¡µè¡¨è‡ªèº«ã€‚</p><p>è¿™é‡Œçš„ <code>uvmunmap(pagetable, 0, PGROUNDUP(sz) / PGSIZE, 1)</code> è¡¨ç¤ºé‡Šæ”¾è™šæ‹Ÿåœ°å€ä» <code>0</code> åˆ° <code>0 + PGROUNDUP(sz) / PGSIZE</code> çš„å†…å®¹ï¼Œå³é‡Šæ”¾ç”¨æˆ·å†…å­˜çš„å†…å®¹ã€‚</p><p>ä½† <code>trapframe</code> å’Œ <code>usyscall</code> ä¸æ˜¯ç”¨æˆ·å†…å­˜çš„å†…å®¹ï¼Œå®ƒä»¬è¢«å­˜æ”¾åœ¨è™šæ‹Ÿåœ°å€çš„é¡¶éƒ¨ï¼ˆåˆ†åˆ«åœ¨ TRAPFRAME å’Œ USYSCALLï¼‰ï¼Œæ‰€ä»¥å®ƒä»¬æ²¡æœ‰è¢«é‡Šæ”¾ã€‚</p><h1 id="Print-a-page-table"><a href="#Print-a-page-table" class="headerlink" title="Print a page table"></a>Print a page table</h1><p>å…ˆæ¥çœ‹çœ‹æ‰“å°ç»“æœå§ï¼š</p><pre class="line-numbers language-none"><code class="language-none">page table 0x0000000087f22000 ..0x0000000000000000: pte 0x0000000021fc7801 pa 0x0000000087f1e000 .. ..0x0000000000000000: pte 0x0000000021fc7401 pa 0x0000000087f1d000 .. .. ..0x0000000000000000: pte 0x0000000021fc7c5b pa 0x0000000087f1f000 .. .. ..0x0000000000001000: pte 0x0000000021fc701b pa 0x0000000087f1c000 .. .. ..0x0000000000002000: pte 0x0000000021fc6cd7 pa 0x0000000087f1b000 .. .. ..0x0000000000003000: pte 0x0000000021fc6807 pa 0x0000000087f1a000 .. .. ..0x0000000000004000: pte 0x0000000021fc64d7 pa 0x0000000087f19000 ..0xffffffffc0000000: pte 0x0000000021fc8401 pa 0x0000000087f21000 .. ..0xffffffffffe00000: pte 0x0000000021fc8001 pa 0x0000000087f20000 .. .. ..0xffffffffffffd000: pte 0x0000000021fd4c13 pa 0x0000000087f53000 .. .. ..0xffffffffffffe000: pte 0x0000000021fd00c7 pa 0x0000000087f40000 .. .. ..0xfffffffffffff000: pte 0x000000002000184b pa 0x0000000080006000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç»“æœæ¯” 2024 çš„ä½œä¸šæ–‡æ¡£å¤šäº†ä¸€è¡Œ</p><pre class="line-numbers language-none"><code class="language-none">.. .. ..0x0000000000000000: pte 0x0000000021fc7c5b pa 0x0000000087f1f000<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è¿™æ˜¯æ­£ç¡®è¡¨ç°ã€‚2024 çš„ä½œä¸šæ–‡æ¡£è¿™é‡Œå†™é”™äº†ï¼Œ2025 çš„ç‰ˆæœ¬å°±åŠ å…¥äº†è¿™è¡Œã€‚</p><p>å¦‚æç¤ºæ‰€è¨€ï¼Œè¿™ä¸ªå‡½æ•°å’Œ <code>freewalk</code> å¾ˆåƒï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ <code>freewalk</code>ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">freewalk</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// there are 2^9 = 512 PTEs in a page table.</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">512</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">pte_t</span> pte <span class="token operator">=</span> pagetable<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pte <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>pte <span class="token operator">&amp;</span> <span class="token punctuation">(</span>PTE_R <span class="token operator">|</span> PTE_W <span class="token operator">|</span> PTE_X<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// this PTE points to a lower-level page table.</span>            uint64 child <span class="token operator">=</span> <span class="token function">PTE2PA</span><span class="token punctuation">(</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">freewalk</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span><span class="token punctuation">)</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>            pagetable<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pte <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"freewalk: leaf"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">kfree</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>pagetable<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å®ƒéå† L0 çº§é¡µè¡¨çš„ 512 ä¸ª PTEï¼Œå¯¹æ¯ä¸ª PTEï¼Œç”¨ <code>PTE2PA(pte)</code> æ‰¾åˆ°å®ƒæŒ‡å‘çš„æ¬¡çº§é¡µè¡¨çš„ç‰©ç†åœ°å€ï¼Œç„¶åé€’å½’ã€‚å®ƒå¿½ç•¥äº†å¶å­ PTEï¼Œåœ¨æ‰“å°æ—¶æˆ‘ä»¬ä¸éœ€è¦å¿½ç•¥å¶å­ã€‚</p><p>æˆ‘ä»¬å†æ¥çœ‹çœ‹æ‰“å°ç»“æœçš„å½¢å¼</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token punctuation">.</span><span class="token punctuation">.</span> è™šæ‹Ÿåœ°å€<span class="token operator">:</span> pte PTEçš„å€¼ pa ç‰©ç†åœ°å€çš„å€¼<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å‚è€ƒ <code>freewalk</code> æˆ‘ä»¬å°±èƒ½æ‹¿åˆ° PTEï¼Œè°ƒç”¨ <code>PTE2PA</code> å°±èƒ½å¾—åˆ° <code>pa</code>ï¼Œä½†æ€ä¹ˆè·å¾—è™šæ‹Ÿåœ°å€å‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹çœ‹è™šæ‹Ÿåœ°å€çš„ç¿»è¯‘ï¼š</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab3-pagetable/addr_translation.png" alt=""></p><p>ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œå¦‚æœæŠŠ Offset ç½®é›¶ï¼Œæˆ‘ä»¬éœ€è¦ L2ã€L1ã€L0 é¡µè¡¨çš„ PTE çš„ç´¢å¼•æ¥ç¡®å®šè™šæ‹Ÿåœ°å€ã€‚ä½†æˆ‘ä»¬å½“ç„¶æœ‰åŠæ³•è·å¾—è¿™äº›ç´¢å¼•ï¼Œæˆ‘ä»¬ä¸æ˜¯åœ¨éå†é¡µè¡¨å—ï¼Œ<code>for (int i = 0; i &lt; 512; i++)</code> é‡Œçš„ <code>i</code> å°±æ˜¯æˆ‘ä»¬éœ€è¦çš„ç´¢å¼•ï¼æ‰€ä»¥å¦‚æœæˆ‘ä»¬çš„ç´¢å¼•æ˜¯ <code>i, j, k</code>ï¼Œæˆ‘ä»¬æ‰“å°çš„è™šæ‹Ÿåœ°å€å°±æ˜¯ <code>((i &lt;&lt; 30) + (j &lt;&lt; 21) + (k &lt;&lt; 12))</code></p><p>å¤§è‡´æ€è·¯å°±æ˜¯è¿™æ ·ã€‚è¿˜æœ‰ä¸€äº›å°ç»†èŠ‚ï¼š</p><ol><li>ä½œä¸šæ–‡æ¡£é‡Œåœ¨éå† L2 å’Œ L1 çº§é¡µè¡¨æ—¶ä¹Ÿæ‰“å°äº†è™šæ‹Ÿåœ°å€ï¼Œè¿™é‡Œæ‰“å°çš„åœ°å€æ˜¯æŠŠæ¬¡çº§ç´¢å¼•å½“ä½œé›¶ç®—å‡ºçš„åœ°å€ã€‚æ¯”å¦‚å¦‚æœæˆ‘ä»¬åœ¨éå† L1 é¡µè¡¨ï¼ŒL2 é¡µè¡¨çš„ç´¢å¼•æ˜¯ <code>i</code>ï¼ŒL1 é¡µè¡¨çš„ç´¢å¼•æ˜¯ <code>j</code>ï¼Œæ‰“å°çš„å°±æ˜¯ <code>((i &lt;&lt; 30) + (j &lt;&lt; 21) + (0 &lt;&lt; 12))</code></li><li>ä¸ºäº†åœ¨é€’å½’æ—¶å¾—çŸ¥ä¸Šä¸€çº§é¡µè¡¨çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬åŠ å…¥äº† <code>father_va</code> ç”¨äºè®°å½•ä¸Šä¸€çº§çš„è™šæ‹Ÿåœ°å€</li><li>ç¬¦å·æ‹“å±•ç”¨äº†ä¸€äº› tricky çš„æ€§è´¨ï¼Œåœ¨ 255 &lt;&lt; 30 é‚£è¡Œçš„æ³¨é‡Šé‡Œå†™çš„åº”è¯¥è¿˜ç®—æ¸…æ¥š</li></ol><p>æ€»ä¹‹å¯ä»¥å†™å‡ºä¸‹é¢çš„ä»£ç ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">const</span> <span class="token keyword">int</span> MAX_LEVEL <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">_vmprint_helper</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">,</span> uint64 father_va<span class="token punctuation">,</span> <span class="token keyword">int</span> level<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// there are 2^9 = 512 PTEs in a page table.</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">512</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">pte_t</span> pte <span class="token operator">=</span> pagetable<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pte <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> level<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> MAX_LEVEL<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">" .."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">// 255 &lt;&lt; 30 is automatically sign extended to 0xffffffffc0000000</span>            uint64 va <span class="token operator">=</span> father_va <span class="token operator">+</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">12</span> <span class="token operator">+</span> <span class="token number">9</span> <span class="token operator">*</span> level<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%p: pte %p pa %p\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>va<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>pte<span class="token punctuation">,</span>                   <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">PTE2PA</span><span class="token punctuation">(</span>pte<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// this PTE points to a lower-level page table.</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>level <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">_vmprint_helper</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span><span class="token punctuation">)</span><span class="token function">PTE2PA</span><span class="token punctuation">(</span>pte<span class="token punctuation">)</span><span class="token punctuation">,</span> va<span class="token punctuation">,</span> level <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">vmprint</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"page table %p\n"</span><span class="token punctuation">,</span> pagetable<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">_vmprint_helper</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MAX_LEVEL<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="Use-superpages"><a href="#Use-superpages" class="headerlink" title="Use superpages"></a><strong>Use superpages</strong></h1><p>è¿™é“é¢˜è®©æˆ‘ä»¬ç»™ xv6 åŠ å…¥è¶…çº§é¡µã€‚å½“ç”¨æˆ·è¯·æ±‚ä¸€å—è¶…è¿‡ 2MB çš„å†…å­˜ï¼Œæˆ‘ä»¬å°±åˆ†é…è¶…çº§é¡µè€Œéå¤§é‡çš„å°é¡µæ¥ä¼˜åŒ–æ€§èƒ½ã€‚</p><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹æ™®é€šé¡µå’Œè¶…çº§é¡µå„è‡ªæ˜¯å¦‚ä½•ç¿»è¯‘è™šæ‹Ÿåœ°å€çš„ï¼š</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab3-pagetable/regular_vs_super.png" alt=""></p><ol><li><p>æ™®é€šé¡µï¼š</p><p> æ™®é€šé¡µåœ¨ç¿»è¯‘æ—¶æŠŠè™šæ‹Ÿåœ°å€åˆ†æˆ L2, L1, L0, Offset å››ä¸ªéƒ¨åˆ†ã€‚å‰ä¸‰è€…ç”¨äºåœ¨ä¸åŒçº§åˆ«çš„é¡µè¡¨é‡Œåšåç§»æ‰¾åˆ°ä¸‹ä¸€ä¸ªé¡µçš„å¼€å¤´çš„ç‰©ç†åœ°å€ï¼ˆä¸€ä¸ª Page Directory ä¹Ÿæ˜¯ä¸€ä¸ªé¡µï¼‰ï¼ŒOffset åˆ™ç”¨äºè®¡ç®—æœ€ç»ˆçš„ç‰©ç†åœ°å€åç§»ã€‚</p><p> Sv39 è§„å®š PPN å®½åº¦ä¸º 44 ä½ï¼ŒOffset å®½åº¦ 12 ä½ï¼Œä¸€ä¸ªæ™®é€šé¡µçš„å¤§å°å°±æ˜¯ $2^{12}$ bytes = 4KB.</p><p> åœ¨æ‰¾åˆ°äº† L0 leaf åï¼Œæˆ‘ä»¬å°±èƒ½ç”¨ <code>(PPN &lt;&lt; 12) + Offest</code> æ¥è®¡ç®—è™šæ‹Ÿåœ°å€å¯¹åº”çš„ç‰©ç†åœ°å€äº†ã€‚</p></li><li><p>è¶…çº§é¡µï¼š</p><p> è¶…çº§é¡µåˆ™æŠŠè™šæ‹Ÿåœ°å€åˆ†æˆ L2, L1, Offset ä¸‰ä¸ªéƒ¨åˆ†ã€‚</p><p> Sv39 è§„å®šè¶…çº§é¡µçš„ Offset ä¸º 21 ä½ï¼Œè¿™æ˜¯æŠŠåŸæœ¬çš„ L0 å’Œ Offset åˆå¹¶æˆäº†ä¸€ä¸ª 21 ä½çš„ Offsetã€‚è¶…çº§é¡µå¤§å°å°±æ˜¯ $2^{21}$ bytes å³ 2MB.</p><p> è¶…çº§é¡µæ˜¯ 2MB å¯¹é½çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ $56 - \log (2097152) = 35$ ä½æ¥æè¿°ä¸€ä¸ªè¶…çº§é¡µçš„å¼€å¤´ï¼Œæ‰€ä»¥è¶…çº§é¡µå¯¹åº”çš„ L1 leaf å­˜å‚¨çš„ PPN çš„æœ«å°¾ 9 ä½ä¸º 0. è¿™é‡Œæœ‰ $2097152$ æ˜¯å› ä¸º 2MB = 2097152 bytes.</p><p> åœ¨æ‰¾åˆ° L1 leaf åï¼Œæˆ‘ä»¬åŒæ ·ç”¨ <code>(PPN &lt;&lt; 12) + Offest</code> æ¥è®¡ç®—è™šæ‹Ÿåœ°å€å¯¹åº”çš„ç‰©ç†åœ°å€ã€‚</p></li></ol><h2 id="æµ‹è¯•ä»£ç "><a href="#æµ‹è¯•ä»£ç " class="headerlink" title="æµ‹è¯•ä»£ç "></a>æµ‹è¯•ä»£ç </h2><p>éµå¾ªæç¤ºï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ <code>superpg_test</code> åšäº†ä»€ä¹ˆã€‚è¦è¯´æ˜çš„æ˜¯ï¼Œ2024 ç‰ˆæœ¬çš„æµ‹è¯•ä¸å…¨é¢è€Œä¸”æœ‰ bugâ€”â€”åœ¨ <code>supercheck</code> å‡½æ•°çš„æœ«å°¾çš„ for å¾ªç¯é‡Œï¼Œæ¡ä»¶åº”è¯¥æ˜¯ <code>i &lt; 512 * PGSIZE</code> è€Œé <code>i &lt; 512</code>ï¼Œåº”è¯¥æ”¹æˆä¸‹é¢è¿™æ ·ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// check whether different va are mapped to different pa</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">512</span> <span class="token operator">*</span> PGSIZE<span class="token punctuation">;</span> i <span class="token operator">+=</span> PGSIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>s <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> i<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">512</span> <span class="token operator">*</span> PGSIZE<span class="token punctuation">;</span> i <span class="token operator">+=</span> PGSIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>s <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">!=</span> i<span class="token punctuation">)</span>        <span class="token function">err</span><span class="token punctuation">(</span><span class="token string">"wrong value"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ€»ä¹‹æˆ‘ä»¬ä¸‹é¢åˆ†æ 2025 ç‰ˆæœ¬çš„æµ‹è¯•ã€‚2025 ç‰ˆæœ¬çš„æµ‹è¯•å…±åŒ…æ‹¬ <code>supercheck</code>ã€<code>superpg_fork</code> å’Œ <code>superpg_free</code> ä¸‰ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨ <code>supercheck</code>ã€‚<code>supercheck</code> åˆ¤æ–­ä» <code>end</code> ä¹‹åç¬¬ä¸€ä¸ªå¯¹é½è¶…çº§é¡µçš„åœ°å€å¼€å§‹æ˜¯å¦æ˜¯è¶…çº§é¡µï¼Œå…·ä½“çš„åˆ¤æ–­æ–¹æ³•å¯ä»¥å‚è€ƒä¸‹é¢çš„æ³¨é‡Šï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">supercheck</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>end<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">pte_t</span> last_pte <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    uint64 a <span class="token operator">=</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>end<span class="token punctuation">;</span>    uint64 s <span class="token operator">=</span> <span class="token function">SUPERPGROUNDUP</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// Check that virtual address up to the next superpage boundary are mapped to PTE</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> a <span class="token operator">&lt;</span> s<span class="token punctuation">;</span> a <span class="token operator">+=</span> PGSIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">pte_t</span> pte <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">pte_t</span><span class="token punctuation">)</span><span class="token function">pgpte</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pte <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">err</span><span class="token punctuation">(</span><span class="token string">"no pte"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// Check that all virtual address in the superpage share the same valid PTE</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>uint64 p <span class="token operator">=</span> s<span class="token punctuation">;</span> p <span class="token operator">&lt;</span> s <span class="token operator">+</span> <span class="token number">512</span> <span class="token operator">*</span> PGSIZE<span class="token punctuation">;</span> p <span class="token operator">+=</span> PGSIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">pte_t</span> pte <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">pte_t</span><span class="token punctuation">)</span><span class="token function">pgpte</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pte <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token function">err</span><span class="token punctuation">(</span><span class="token string">"no pte"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>last_pte <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> pte <span class="token operator">!=</span> last_pte<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">err</span><span class="token punctuation">(</span><span class="token string">"pte different"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pte <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span>pte <span class="token operator">&amp;</span> PTE_R<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span>pte <span class="token operator">&amp;</span> PTE_W<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">err</span><span class="token punctuation">(</span><span class="token string">"pte wrong"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        last_pte <span class="token operator">=</span> pte<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// Check that different va are mapped to different pa</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">512</span> <span class="token operator">*</span> PGSIZE<span class="token punctuation">;</span> i <span class="token operator">+=</span> PGSIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>s <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">512</span> <span class="token operator">*</span> PGSIZE<span class="token punctuation">;</span> i <span class="token operator">+=</span> PGSIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>s <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">!=</span> i<span class="token punctuation">)</span>            <span class="token function">err</span><span class="token punctuation">(</span><span class="token string">"wrong value"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶åæˆ‘ä»¬ç®€è¦æä¸€ä¸‹å¦å¤–ä¸¤ä¸ªå‡½æ•°çš„ä½œç”¨ï¼š</p><ol><li><code>superpg_fork</code> æ£€æŸ¥è¶…çº§é¡µåœ¨ <code>fork</code> åæ˜¯å¦è¢«æ­£ç¡®å¤åˆ¶ä¸ºè¶…çº§é¡µã€‚</li><li><code>superpg_free</code> æ£€æŸ¥ <code>sbrk</code> èƒ½å¦æ­£ç¡®é‡Šæ”¾æ•´ä¸ªè¶…çº§é¡µï¼Œä»¥åŠèƒ½å¦åœ¨é‡Šæ”¾è¶…çº§é¡µçš„éƒ¨åˆ†å†…å­˜æ—¶å°†è¶…çº§é¡µé€€åŒ–ä¸ºå¤šä¸ªæ™®é€šé¡µï¼ˆ2024 ç‰ˆæœ¬æ²¡æµ‹è¯•è¿™ä¸€ç‚¹ï¼Œä½†è¿™ä¸ªæ˜¯å¾ˆå€¼å¾—åšçš„åŠŸèƒ½ï¼‰ã€‚</li></ol><h2 id="sbrk-è°ƒç”¨é“¾"><a href="#sbrk-è°ƒç”¨é“¾" class="headerlink" title="sbrk è°ƒç”¨é“¾"></a>sbrk è°ƒç”¨é“¾</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬åˆ†æç”¨æˆ·åœ¨è°ƒç”¨ <code>sbrk</code> æ—¶å…·ä½“è°ƒç”¨äº†å“ªäº›å‡½æ•°ã€‚è¿™åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š</p><ol><li>åˆ†é…ï¼šsys_sbrk-&gt;growproc-&gt;uvmalloc -&gt; kalloc/kfree</li><li>é‡Šæ”¾ï¼šsys_sbrk -&gt; growproc -&gt; uvmdealloc -&gt; uvmunmap</li></ol><p>è¦æ³¨æ„çš„æ˜¯å½“åˆ†é…å†…å­˜å‡ºé”™æ—¶ï¼Œ<code>uvmalloc</code> ä¹Ÿä¼šè°ƒç”¨ <code>uvmdealloc</code>ã€‚</p><p>æˆ‘ä»¬ä»æœ€åº•å±‚å‡ºå‘ï¼Œå…ˆåœ¨ kalloc.c é‡Œå®Œæˆå¯¹è¶…çº§é¡µçš„æ”¯æŒã€‚è¿™åŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤ï¼š</p><ol><li><p>æ·»åŠ ä¸€ä¸ªè¶…çº§é¡µé“¾è¡¨</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">spinlock</span> lock<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">run</span> <span class="token operator">*</span>superlist<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">run</span> <span class="token operator">*</span>freelist<span class="token punctuation">;</span><span class="token punctuation">&#125;</span> kmem<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>åœ¨åˆå§‹åŒ–ä»£ç é‡Œåˆå§‹åŒ–è¿™ä¸ªè¶…çº§é¡µé“¾è¡¨</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">const</span> <span class="token keyword">int</span> MAX_SUPER <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">freerange</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>pa_start<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>pa_end<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>    p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">PGROUNDUP</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>pa_start<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> sz<span class="token punctuation">;</span>    <span class="token keyword">int</span> super_cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> p <span class="token operator">+</span> PGSIZE <span class="token operator">&lt;=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa_end<span class="token punctuation">;</span> p <span class="token operator">+=</span> sz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>super_cnt <span class="token operator">&lt;</span> MAX_SUPER <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>p <span class="token operator">%</span> SUPERPGSIZE <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>            p <span class="token operator">+</span> SUPERPGSIZE <span class="token operator">&lt;=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa_end<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            sz <span class="token operator">=</span> SUPERPGSIZE<span class="token punctuation">;</span>            <span class="token function">superfree</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>            super_cnt <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            sz <span class="token operator">=</span> PGSIZE<span class="token punctuation">;</span>            <span class="token function">kfree</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>æ·»åŠ  superalloc å’Œ superfree å‡½æ•°ï¼ˆç…§æŠ„ kalloc å’Œ kfreeï¼‰ï¼š</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">superalloc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">run</span> <span class="token operator">*</span>r<span class="token punctuation">;</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmem<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    r <span class="token operator">=</span> kmem<span class="token punctuation">.</span>superlist<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">)</span>        kmem<span class="token punctuation">.</span>superlist <span class="token operator">=</span> r<span class="token operator">-></span>next<span class="token punctuation">;</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmem<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">)</span>        <span class="token function">memset</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>r<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> SUPERPGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// fill with junk</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>r<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">superfree</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>pa<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">run</span> <span class="token operator">*</span>r<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>pa <span class="token operator">%</span> SUPERPGSIZE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa <span class="token operator">&lt;</span> end <span class="token operator">||</span>        <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>pa <span class="token operator">>=</span> PHYSTOP<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"superfree"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// Fill with junk to catch dangling refs.</span>    <span class="token function">memset</span><span class="token punctuation">(</span>pa<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> SUPERPGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>    r <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">run</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa<span class="token punctuation">;</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmem<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    r<span class="token operator">-></span>next <span class="token operator">=</span> kmem<span class="token punctuation">.</span>superlist<span class="token punctuation">;</span>    kmem<span class="token punctuation">.</span>superlist <span class="token operator">=</span> r<span class="token punctuation">;</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmem<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><p>è‡³æ­¤ï¼Œæœ€åº•å±‚çš„å·¥ä½œå°±åšå®Œäº†ã€‚</p><h2 id="åˆ†é…å†…å­˜"><a href="#åˆ†é…å†…å­˜" class="headerlink" title="åˆ†é…å†…å­˜"></a>åˆ†é…å†…å­˜</h2><p>å›é¡¾å†…å­˜åˆ†é…çš„è°ƒç”¨é“¾ï¼šsys_sbrk-&gt;growproc-&gt;uvmalloc -&gt; kalloc/kfreeï¼Œåœ¨å¼€å§‹ç¼–å†™ä»£ç ä¹‹å‰æˆ‘ä»¬å…ˆåˆ†æä¸€ä¸‹æ¯ä¸€å±‚çš„èŒè´£ã€‚</p><ol><li>sys_sbrk æ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œè´Ÿè´£ç³»ç»Ÿå’Œç”¨æˆ·çš„äº¤äº’</li><li>grow_proc æ˜¯è¿›ç¨‹æŠ½è±¡çš„ä¸€ä¸ªæ¥å£ï¼Œè´Ÿè´£ç®¡ç†è¿›ç¨‹çŠ¶æ€</li><li>uvmalloc æ˜¯è™šæ‹Ÿå†…å­˜å±‚ï¼Œè´Ÿè´£ç®¡ç†è¿›ç¨‹çœ¼ä¸­çš„â€œå†…å­˜â€ï¼Œç®¡ç†è™šæ‹Ÿåˆ°ç‰©ç†çš„æ˜ å°„</li><li>kalloc å’Œ kfree åˆ™æ˜¯ç‰©ç†å†…å­˜å±‚ï¼Œç®¡ç†ç‰©ç†å†…å­˜</li></ol><p>æˆ‘ä»¬åœ¨è¿™é‡Œè¦ä¿®æ”¹çš„æ˜¯ uvmalloc. ç®€å•è¯»ä¸‹å®ƒåŸæœ¬çš„ä»£ç å¯ä»¥å‘ç°å®ƒä¸»è¦è°ƒç”¨çš„æ˜¯ kalloc å’Œ mappages. åœ¨è¶…çº§é¡µä¸­ï¼Œå‰è€…å¯¹åº” superallocï¼Œè€Œå¯¹åè€…æˆ‘è‡ªå·±å†™äº†ä¸€ä¸ª mapsuperpages ä½œä¸ºå¯¹åº”ã€‚ä¸ºäº†è®© mapsuperpages è·‘èµ·æ¥ï¼Œæˆ‘è¿˜å†™äº†ä¸ª l1walk å‡½æ•°ç”¨äºæ‰¾åˆ°ä¸€ä¸ªè™šæ‹Ÿåœ°å€å¯¹åº”çš„ L1 PTE. å…ˆæ¥çœ‹çœ‹ l1walkï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">pte_t</span> <span class="token operator">*</span><span class="token function">l1walk</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">,</span> uint64 va<span class="token punctuation">,</span> <span class="token keyword">int</span> alloc<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>va <span class="token operator">>=</span> MAXVA<span class="token punctuation">)</span>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"walk"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">pte_t</span> <span class="token operator">*</span>pte <span class="token operator">=</span> <span class="token operator">&amp;</span>pagetable<span class="token punctuation">[</span><span class="token function">PX</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> va<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        pagetable <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">pagetable_t</span><span class="token punctuation">)</span><span class="token function">PTE2PA</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">&amp;</span>pagetable<span class="token punctuation">[</span><span class="token function">PX</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> va<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>alloc <span class="token operator">||</span> <span class="token punctuation">(</span>pagetable <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">pde_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">kalloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">memset</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">*</span>pte <span class="token operator">=</span> <span class="token function">PA2PTE</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">)</span> <span class="token operator">|</span> PTE_V<span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">&amp;</span>pagetable<span class="token punctuation">[</span><span class="token function">PX</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> va<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å®ƒå’Œ walk å‡½æ•°åŸºæœ¬ä¸€è‡´ï¼Œä¸è¿‡ walk æ˜¯è¿”å› leafï¼Œè€Œè¿™é‡Œçš„ l1walk è¿”å› L1 PTE.</p><p>ç„¶åçœ‹çœ‹ mapsuperpagesï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">mapsuperpages</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">,</span> uint64 va<span class="token punctuation">,</span> uint64 size<span class="token punctuation">,</span> uint64 pa<span class="token punctuation">,</span>                  <span class="token keyword">int</span> perm<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    uint64 a<span class="token punctuation">,</span> last<span class="token punctuation">;</span>    <span class="token class-name">pte_t</span> <span class="token operator">*</span>pte<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>va <span class="token operator">%</span> SUPERPGSIZE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"mapsuperpages: va not aligned"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>size <span class="token operator">%</span> SUPERPGSIZE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"mapsuperpages: size not aligned"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"mapsuperpages: size"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    a <span class="token operator">=</span> va<span class="token punctuation">;</span>    last <span class="token operator">=</span> va <span class="token operator">+</span> size <span class="token operator">-</span> SUPERPGSIZE<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pte <span class="token operator">=</span> <span class="token function">l1walk</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"mapsuperpages: l1walk failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span>            <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"mapsuperpages: remap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">*</span>pte <span class="token operator">=</span> <span class="token function">PA2PTE</span><span class="token punctuation">(</span>pa<span class="token punctuation">)</span> <span class="token operator">|</span> perm <span class="token operator">|</span> PTE_V <span class="token operator">|</span> PTE_R<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">==</span> last<span class="token punctuation">)</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        a <span class="token operator">+=</span> SUPERPGSIZE<span class="token punctuation">;</span>        pa <span class="token operator">+=</span> SUPERPGSIZE<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™åŸºæœ¬æ˜¯ç…§æŠ„ mappagesï¼Œåªæ˜¯æŠŠæ™®é€šé¡µæ”¹æˆäº†è¶…çº§é¡µã€‚</p><p>æœ€åçœ‹çœ‹æˆ‘ä»¬å¯¹ uvmalloc çš„ä¿®æ”¹ã€‚uvmalloc ä¸»è¦åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œç¬¬ä¸€éƒ¨åˆ†æ˜¯ç”¨ kalloc/superalloc è¯·æ±‚ç‰©ç†å†…å­˜ï¼Œç¬¬äºŒéƒ¨åˆ†æ˜¯ç”¨ mappages/mapsuperpages æŠŠè™šæ‹Ÿå†…å­˜æ˜ å°„åˆ°ç‰©ç†å†…å­˜ä¸Šã€‚</p><p>æˆ‘ä»¬åœ¨æ³¨é‡Šé‡Œæ ‡å‡ºäº†ä¿®æ”¹çš„åœ°æ–¹ï¼Œä¿®æ”¹ 1 å¯¹åº”è¯·æ±‚ç‰©ç†å†…å­˜çš„ç¬¬ä¸€éƒ¨åˆ†ï¼Œä¿®æ”¹ 2 å¯¹åº”åšæ˜ å°„çš„ç¬¬äºŒéƒ¨åˆ†ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">uint64 <span class="token function">uvmalloc</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">,</span> uint64 oldsz<span class="token punctuation">,</span> uint64 newsz<span class="token punctuation">,</span> <span class="token keyword">int</span> xperm<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>mem<span class="token punctuation">;</span>    uint64 a<span class="token punctuation">;</span>    <span class="token keyword">int</span> sz<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>newsz <span class="token operator">&lt;</span> oldsz<span class="token punctuation">)</span>        <span class="token keyword">return</span> oldsz<span class="token punctuation">;</span>    oldsz <span class="token operator">=</span> <span class="token function">PGROUNDUP</span><span class="token punctuation">(</span>oldsz<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>a <span class="token operator">=</span> oldsz<span class="token punctuation">;</span> a <span class="token operator">&lt;</span> newsz<span class="token punctuation">;</span> a <span class="token operator">+=</span> sz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// ä¿®æ”¹1ä»è¿™é‡Œå¼€å§‹</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">%</span> SUPERPGSIZE <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> a <span class="token operator">+</span> SUPERPGSIZE <span class="token operator">&lt;=</span> newsz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            sz <span class="token operator">=</span> SUPERPGSIZE<span class="token punctuation">;</span>            mem <span class="token operator">=</span> <span class="token function">superalloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// If no superpages, use regular pages</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>mem <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                sz <span class="token operator">=</span> PGSIZE<span class="token punctuation">;</span>                mem <span class="token operator">=</span> <span class="token function">kalloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            sz <span class="token operator">=</span> PGSIZE<span class="token punctuation">;</span>            mem <span class="token operator">=</span> <span class="token function">kalloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// ä¿®æ”¹1åˆ°è¿™é‡Œç»“æŸ</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mem <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">uvmdealloc</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> a<span class="token punctuation">,</span> oldsz<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">LAB_SYSCALL</span></span>        <span class="token function">memset</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sz<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>        <span class="token comment">// ä¿®æ”¹2ä»è¿™é‡Œå¼€å§‹</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>sz <span class="token operator">==</span> PGSIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mappages</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> a<span class="token punctuation">,</span> sz<span class="token punctuation">,</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>mem<span class="token punctuation">,</span>                         PTE_R <span class="token operator">|</span> PTE_U <span class="token operator">|</span> xperm<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">kfree</span><span class="token punctuation">(</span>mem<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">uvmdealloc</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> a<span class="token punctuation">,</span> oldsz<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mapsuperpages</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> a<span class="token punctuation">,</span> sz<span class="token punctuation">,</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>mem<span class="token punctuation">,</span>                              PTE_R <span class="token operator">|</span> PTE_U <span class="token operator">|</span> xperm<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">superfree</span><span class="token punctuation">(</span>mem<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">uvmdealloc</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> a<span class="token punctuation">,</span> oldsz<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// ä¿®æ”¹2åˆ°è¿™é‡Œç»“æŸ</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> newsz<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="é‡Šæ”¾å†…å­˜"><a href="#é‡Šæ”¾å†…å­˜" class="headerlink" title="é‡Šæ”¾å†…å­˜"></a>é‡Šæ”¾å†…å­˜</h2><p>åœ¨å®Œæˆäº†åˆ†é…å†…å­˜çš„å·¥ä½œåï¼Œæˆ‘ä»¬å°±èƒ½å†™é‡Šæ”¾å†…å­˜ç›¸å…³çš„ä»£ç äº†ã€‚</p><p>å›é¡¾è°ƒç”¨é“¾ï¼šsys_sbrk -&gt; growproc -&gt; uvmdealloc -&gt; uvmunmapï¼Œæˆ‘ä»¬è¦ä¿®æ”¹ uvmunmap. è¿™éƒ¨åˆ†ä»£ç æ¯”è¾ƒæ£˜æ‰‹ã€‚å®ƒåŸæœ¬åªæ˜¯åœ¨æŒ‰éƒ¨å°±ç­åœ°åˆ æ‰é¡µè¡¨é‡Œä» va å‡ºå‘çš„ npages ä¸ªç‰©ç†é¡µçš„æ˜ å°„ï¼Œå¹¶é€‰æ‹©æ€§é‡Šæ”¾ç‰©ç†å†…å­˜ï¼Œä½†åœ¨åŠ å…¥è¶…çº§é¡µåå®ƒéœ€è¦å®Œæˆè¿™äº›å·¥ä½œï¼š</p><ol><li>è®© <code>uint64 a</code> ä» <code>va</code> å‡ºå‘ï¼Œå¦‚æœé‡åˆ°äº†æ™®é€šé¡µï¼Œèµ°æ™®é€šé¡µçš„ unmap æµç¨‹ï¼Œç„¶å <code>a += PGSIZE</code></li><li>å¦‚æœé‡åˆ°äº†è¶…çº§é¡µï¼Œåˆ¤æ–­ <code>a</code> æ˜¯è¶…çº§é¡µçš„å¼€å¤´è¿˜æ˜¯è¶…çº§é¡µçš„ä¸­é—´<ol><li>å¦‚æœæ˜¯è¶…çº§é¡µçš„å¼€å¤´ï¼Œèµ°è¶…çº§é¡µçš„ unmap æµç¨‹ï¼ˆå’Œæ™®é€šé¡µ unmap åŸºæœ¬ä¸€è‡´ï¼‰ï¼Œç„¶å <code>a += SUPERPGSIZE</code></li><li>å¦‚æœæ˜¯è¶…çº§é¡µçš„ä¸­é—´ï¼ŒæŠŠè¶…çº§é¡µé€€åŒ–æˆè‹¥å¹²ä¸ªæ™®é€šé¡µï¼Œå†èµ°æ™®é€šé¡µé‡Šæ”¾æµç¨‹ï¼Œç„¶å <code>a += PGSIZE</code></li></ol></li></ol><p>è¿™é‡Œä¸»è¦æ˜¯ä¸Šé¢æ­¥éª¤ä¸­çš„ 2b çš„â€œé€€åŒ–â€æ¯”è¾ƒæ£˜æ‰‹ï¼Œæˆ‘æ˜¯æŠŠé¡µè¡¨é‡Œå¯¹åº”è¶…çº§é¡µçš„ L1 leaf è®¾ç½®æˆäº† invalidï¼Œç„¶åæŠŠè¶…çº§é¡µè§†ä½œå¤šä¸ªæ™®é€šé¡µçš„åˆå¹¶ï¼Œä»è¶…çº§é¡µçš„å¼€å¤´å‡ºå‘åšè‹¥å¹²æ¬¡ mappages ä»è€Œå®Œæˆé€€åŒ–ã€‚æ€è·¯å¯ä»¥å‚è€ƒä¸‹å›¾ï¼š</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab3-pagetable/super_demote.png" alt=""></p><p>è¿™é‡Œæ˜¯é€€åŒ–éƒ¨åˆ†çš„ä»£ç ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> perm <span class="token operator">=</span> <span class="token function">PTE_FLAGS</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>uint64 super_va_st <span class="token operator">=</span> <span class="token function">SUPERPGROUNDDOWN</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>uint64 super_pa_st <span class="token operator">=</span> <span class="token function">PTE2PA</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span>pte <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// Make pte invalid to make `mappages` work</span><span class="token keyword">for</span> <span class="token punctuation">(</span>uint64 super_va <span class="token operator">=</span> super_va_st<span class="token punctuation">,</span> super_pa <span class="token operator">=</span> super_pa_st<span class="token punctuation">;</span>     super_va <span class="token operator">&lt;</span> super_va_st <span class="token operator">+</span> SUPERPGSIZE<span class="token punctuation">;</span>     super_va <span class="token operator">+=</span> PGSIZE<span class="token punctuation">,</span> super_pa <span class="token operator">+=</span> PGSIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mappages</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> super_va<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">,</span> super_pa<span class="token punctuation">,</span> perm<span class="token punctuation">)</span> <span class="token operator">!=</span>        <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmunmap: mappages failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å½“ç„¶è¿™æ ·çš„é€€åŒ–æœ‰ä¸€ä¸ªæ½œåœ¨é£é™©â€”â€”æ¯ä¸ªè¿›ç¨‹çš„è¶…çº§é¡µä¸Šé™åœ¨è¿›ç¨‹å¯åŠ¨æ—¶å°±å†³å®šäº†ï¼Œæˆ‘ä»¬çš„é€€åŒ–ä¼šè®©æœ¬è¿›ç¨‹çš„è¶…çº§é¡µä¸Šé™å‡ä¸€ã€‚å¦‚æœæœ‰ä»€ä¹ˆè‡ªåŠ¨åˆå¹¶æ™®é€šé¡µä¸ºè¶…çº§é¡µçš„åŠŸèƒ½å°±å¥½äº†â€¦</p><p>å¦å¤–ï¼Œæˆ‘çš„ä»£ç æŠŠä¹‹å‰æ­¥éª¤é‡Œæè¿°çš„ 1 å’Œ 2b æ•´åˆäº†ä¸€ä¸‹ï¼ˆæ¯•ç«Ÿå®ƒä»¬æœ€åéƒ½èµ°çš„æ˜¯æ™®é€šé¡µé‡Šæ”¾æµç¨‹ï¼‰ï¼Œæ€»ä¹‹è¿™é‡Œæ˜¯å®Œæ•´ä»£ç ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">uvmunmap</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">,</span> uint64 va<span class="token punctuation">,</span> uint64 npages<span class="token punctuation">,</span> <span class="token keyword">int</span> do_free<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    uint64 a<span class="token punctuation">;</span>    <span class="token class-name">pte_t</span> <span class="token operator">*</span>pte<span class="token punctuation">;</span>    <span class="token keyword">int</span> sz<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>va <span class="token operator">%</span> PGSIZE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmunmap: not aligned"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>a <span class="token operator">=</span> va<span class="token punctuation">;</span> a <span class="token operator">&lt;</span> va <span class="token operator">+</span> npages <span class="token operator">*</span> PGSIZE<span class="token punctuation">;</span> a <span class="token operator">+=</span> sz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// If `a` corresponds to a superpage and the superpage starts at `a`,</span>        <span class="token comment">// free the superpage</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pte <span class="token operator">=</span> <span class="token function">l1walk</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">PTE_LEAF</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>            a <span class="token operator">%</span> SUPERPGSIZE <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            sz <span class="token operator">=</span> SUPERPGSIZE<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"va=%ld pte=%ld\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmunmap: not mapped"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>do_free<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                uint64 pa <span class="token operator">=</span> <span class="token function">PTE2PA</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">superfree</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token operator">*</span>pte <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            sz <span class="token operator">=</span> PGSIZE<span class="token punctuation">;</span>            <span class="token comment">// If `a` corresponds to a superpage but the superpage doesn't</span>            <span class="token comment">// start at `a`, demote the superpage into regular pages</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>pte <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">PTE_LEAF</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// Potential issue:</span>                <span class="token comment">// Each process has a max number of superpages defined as</span>                <span class="token comment">// `MAX_SUPER`. But whenever a superpage is demoted, the</span>                <span class="token comment">// process's max number of superpages permanently minus one,</span>                <span class="token comment">// since we view superpage as multiple regular pages.</span>                <span class="token comment">//</span>                <span class="token comment">// A possible solution is to kalloc multiple regular pages,</span>                <span class="token comment">// copy memory into them, and superfree the superpage.</span>                <span class="token keyword">int</span> perm <span class="token operator">=</span> <span class="token function">PTE_FLAGS</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>                uint64 super_va_st <span class="token operator">=</span> <span class="token function">SUPERPGROUNDDOWN</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>                uint64 super_pa_st <span class="token operator">=</span> <span class="token function">PTE2PA</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token operator">*</span>pte <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">)</span>                       <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// Make pte invalid to make `mappages` work</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span>uint64 super_va <span class="token operator">=</span> super_va_st<span class="token punctuation">,</span> super_pa <span class="token operator">=</span> super_pa_st<span class="token punctuation">;</span>                     super_va <span class="token operator">&lt;</span> super_va_st <span class="token operator">+</span> SUPERPGSIZE<span class="token punctuation">;</span>                     super_va <span class="token operator">+=</span> PGSIZE<span class="token punctuation">,</span> super_pa <span class="token operator">+=</span> PGSIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mappages</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> super_va<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">,</span> super_pa<span class="token punctuation">,</span> perm<span class="token punctuation">)</span> <span class="token operator">!=</span>                        <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmunmap: mappages failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">&#125;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">// Free the regular page that begins at `a`</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pte <span class="token operator">=</span> <span class="token function">walk</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>                <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmunmap: walk"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"va=%ld pte=%ld\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmunmap: not mapped"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PTE_FLAGS</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span> <span class="token operator">==</span> PTE_V<span class="token punctuation">)</span>                <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmunmap: not a leaf"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>do_free<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                uint64 pa <span class="token operator">=</span> <span class="token function">PTE2PA</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">kfree</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token operator">*</span>pte <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="fork"><a href="#fork" class="headerlink" title="fork"></a>fork</h2><p>æœ€è‰°éš¾çš„å·¥ä½œå·²ç»åšå®Œäº†ï¼Œæˆ‘ä»¬åªè¦ä¿®æ”¹ uvmcopy å°±èƒ½ä¸‹ç­äº†ï¼è¿™é‡Œçš„ä¿®æ”¹åªæ˜¯åŠ å…¥ä¸€ä¸ªç®€å•çš„åˆ†ç±»ï¼Œåœ¨é‡åˆ°æ™®é€šé¡µæ—¶èµ°æ™®é€šæµç¨‹ï¼Œé‡åˆ°è¶…çº§é¡µæ—¶èµ°è¶…çº§æµç¨‹ã€‚å’±å°±ç›´æ¥æ”¾ä»£ç äº†ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">uvmcopy</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> old<span class="token punctuation">,</span> <span class="token class-name">pagetable_t</span> new<span class="token punctuation">,</span> uint64 sz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">pte_t</span> <span class="token operator">*</span>pte<span class="token punctuation">;</span>    uint64 pa<span class="token punctuation">,</span> i<span class="token punctuation">;</span>    uint flags<span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>mem<span class="token punctuation">;</span>    <span class="token keyword">int</span> szinc<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> sz<span class="token punctuation">;</span> i <span class="token operator">+=</span> szinc<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// super page case</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pte <span class="token operator">=</span> <span class="token function">l1walk</span><span class="token punctuation">(</span>old<span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">PTE_LEAF</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            szinc <span class="token operator">=</span> SUPERPGSIZE<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>                <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmcopy: page not present"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            pa <span class="token operator">=</span> <span class="token function">PTE2PA</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>            flags <span class="token operator">=</span> <span class="token function">PTE_FLAGS</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mem <span class="token operator">=</span> <span class="token function">superalloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>                <span class="token keyword">goto</span> err<span class="token punctuation">;</span>            <span class="token function">memmove</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa<span class="token punctuation">,</span> SUPERPGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mapsuperpages</span><span class="token punctuation">(</span>new<span class="token punctuation">,</span> i<span class="token punctuation">,</span> SUPERPGSIZE<span class="token punctuation">,</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>mem<span class="token punctuation">,</span> flags<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">superfree</span><span class="token punctuation">(</span>mem<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">goto</span> err<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// regular page case</span>        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            szinc <span class="token operator">=</span> PGSIZE<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pte <span class="token operator">=</span> <span class="token function">walk</span><span class="token punctuation">(</span>old<span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>                <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmcopy: pte should exist"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>                <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmcopy: page not present"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            pa <span class="token operator">=</span> <span class="token function">PTE2PA</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>            flags <span class="token operator">=</span> <span class="token function">PTE_FLAGS</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mem <span class="token operator">=</span> <span class="token function">kalloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>                <span class="token keyword">goto</span> err<span class="token punctuation">;</span>            <span class="token function">memmove</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mappages</span><span class="token punctuation">(</span>new<span class="token punctuation">,</span> i<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">,</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>mem<span class="token punctuation">,</span> flags<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">kfree</span><span class="token punctuation">(</span>mem<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">goto</span> err<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>err<span class="token operator">:</span>    <span class="token function">uvmunmap</span><span class="token punctuation">(</span>new<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> i <span class="token operator">/</span> PGSIZE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Inspect-a-user-process-page-table&quot;&gt;&lt;a href=&quot;#Inspect-a-user-process-page-table&quot; class=&quot;headerlink&quot; title=&quot;Inspect a user-process pag</summary>
      
    
    
    
    <category term="å…¬å¼€è¯¾" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/"/>
    
    <category term="MIT-6.S081" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/MIT-6-S081/"/>
    
    <category term="Labs" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/MIT-6-S081/Labs/"/>
    
    
  </entry>
  
  <entry>
    <title>æ¢ç´¢æ—¥å¿—[3]</title>
    <link href="http://rinevard.github.io/wiki/others/thoughts/%E6%8E%A2%E7%B4%A2%E6%97%A5%E5%BF%973/"/>
    <id>http://rinevard.github.io/wiki/others/thoughts/%E6%8E%A2%E7%B4%A2%E6%97%A5%E5%BF%973/</id>
    <published>2025-10-27T13:56:16.000Z</published>
    <updated>2025-10-28T02:14:10.603Z</updated>
    
    <content type="html"><![CDATA[<p>ä¹¦æ¥ä¸Šä¸Šä¸Šå›ï¼ˆæ¢ç´¢æ—¥å¿—[0]ï¼‰ï¼Œä»Šå¤©å’Œä¸Šä¸Šæ¬¡å‚åŠ  Ludum Dare Compo ç»“è¯†çš„æœ‹å‹ä¸€èµ·åƒé¥­äº†ï¼Œéš¾é“è¯´æˆ‘å°±è¦å¤±å»ç¤¾æå±æ€§å’Œå®…å±æ€§äº†å—ï¼</p><p>æ€»ä¹‹å°±æ˜¯ä»–è¿™å‡ å¤©æ¥åŒ—äº¬ç©ï¼Œæˆ‘å°±é¼“èµ·å‹‡æ°”é—®ä»–è¦ä¸è¦æ¥æ‰¾æˆ‘ç©ï¼ˆå…¶å®å¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯ä¸ºäº†æ°´ä¸€ç¯‡æ¢ç´¢æ—¥å¿—ï¼Œæ¢ç´¢æ—¥å¿—é©±åŠ¨æ¢ç´¢ï¼‰ï¼Œç„¶åä»Šå¤©å°±ä¸€èµ·åƒäº†æŠ«è¨è–¯æ¡ç‚¸é¸¡ã€‚</p><p><img src="/images/others/random_thoughts/explore3/rubatotree_food.jpg" alt="å¥½åƒçš„"></p><p>æ„Ÿè§‰è‡ªå·±å®…çš„å¾ˆå¤§åŸå› æ˜¯äº’è”ç½‘å¤ªæœ‰è¶£äº†ã€‚ä»Šå¤©ä¹Ÿæ²¡æœ‰å’Œä»–ä¸€èµ·åˆ°å¤„ç©ï¼ˆæ ¹æ®æˆ‘çš„ç»éªŒå’Œæƒ³è±¡ï¼Œäººä»¬ä¸€èˆ¬æ˜¯ä¼šåœ¨ç›¸èšæ—¶å»ä¸€äº›åœ°ç‚¹é—²é€›çš„ï¼‰ï¼Œè€Œæ˜¯åœ¨é¥­åº—è¾¹åƒé¥­è¾¹ç©æ¸¸æˆé¡ºä¾¿é—²èŠã€‚å’±è¿˜ç»™ä»–è¯•äº†è¯•æœ€è¿‘åšçš„æ–°åŸå‹ï¼ˆæ¢ç´¢æ—¥å¿—[2]ï¼Œæ„Ÿè§‰æ¢ç´¢æ—¥å¿—çš„ç›¸äº’å¼•ç”¨éƒ½å¯ä»¥å˜æˆèŠ‚ç‚¹å›¾äº†ï¼‰ï¼Œæ„Ÿè§‰è¿˜ä¸é”™ã€‚ç„¶åæˆ‘ä»¬å°±åœ¨é¥­åº—å¾…äº†ä¸¤ä¸ªå¤šå°æ—¶ï¼Œç›´åˆ°ä»–å»èµ¶é«˜é“å›å­¦æ ¡ã€‚</p><p>æˆ‘è¿˜è›®å–œæ¬¢è¿™æ ·çš„äº¤æµçš„ï¼Œæœç„¶è¿˜æ˜¯è¦ä¸»åŠ¨å»å’Œåˆ«äººç»“äº¤æ‰è¡Œã€‚å¥½è€¶ï¼Œè¿™åˆæ˜¯ä¸€ä¸ªæ°´æ¢ç´¢æ—¥å¿—çš„æœºä¼šã€‚ç­‰æˆ‘ä¸‹æ¬¡ gamejam çœ‹åˆ°å–œæ¬¢çš„æ¸¸æˆå°±å»æ‰¾ä½œè€…åŠ å¥½å‹ï¼ŒæˆåŠŸäº†å°±æ°´ä¸€ç¯‡ï¼Œå¤±è´¥äº†ä¹Ÿèƒ½æ°´ä¸€ç¯‡ã€‚å½“ç„¶ï¼Œå¦‚æœåªæ˜¯æŠŠèŒƒå›´å±€é™åœ¨æ¸¸æˆé¢†åŸŸä¹Ÿå¤ªç‹­çª„äº†ï¼Œä¸è¿‡ç­‰æˆ‘æ°´å®Œå†è¯´å§ã€‚</p><p>ä¸ºä»€ä¹ˆé…’åº—å«é…’åº—å‘¢ï¼Œå®ƒåœ¨å­—é¢ä¸Šçœ‹èµ·æ¥å¾ˆåƒé¥­åº—ï¼Œå´æ˜¯å±…ä½çš„åœ°æ–¹ã€‚æˆ‘ä¸Šç½‘æœäº†ä¸€ä¸‹ï¼ˆå¦‚æˆ‘æ‰€è¨€ï¼Œäº’è”ç½‘å¤ªæœ‰è¶£äº†ï¼‰ï¼Œè¿™æ˜¯å› ä¸ºå®ƒæ˜¯ä» â€œHotelâ€ ç¿»è¯‘è¿‡æ¥çš„ã€‚å¯¹æ¸…æœ«çš„ä¸­å›½ä¸Šå±‚ç¤¾ä¼šï¼Œâ€Hotelâ€ çš„ç¬¬ä¸€åŠŸèƒ½æ˜¯é¥®å®´ï¼Œè€Œéä½å®¿ã€‚ä¼ ç»Ÿä¸­å›½è´µäººå‡ºè¡Œéƒ½å¸¦ç€ä»†äººï¼Œæ‰€ä»¥ â€œHotelâ€ çš„å°é—´å¯¹ä»–ä»¬å¹¶ä¸æ˜¯ä½å®¿çš„åœ°æ–¹ï¼Œè€Œåªæ˜¯èšå®´çš„åœ°æ–¹ï¼Œæ‰€ä»¥è¢«ç¿»è¯‘æˆäº†â€œé…’åº—â€ã€‚</p><p>æœ‰è¶£çš„ç”Ÿæ´»å¤ªå¤šäº†ï¼Œä¸€ä¸ªäººæ˜¯ä½“éªŒä¸è¿‡æ¥çš„ï¼Œæ‰€ä»¥è¦è®¤è¯†æ›´å¤šçš„ç»å†è¿‡æœ‰è¶£ç”Ÿæ´»çš„äººï¼Œæ‰èƒ½çœ‹åˆ°æ›´å¤šæœ‰è¶£çš„ä½“éªŒã€‚</p><p>åˆæˆ–è®¸äººä»¬åªæ˜¯å› ä¸ºç¢°å·§ç›¸é‡ï¼Œæ‰ç¢°å·§è®¤è¯†äº†å½¼æ­¤å§ã€‚</p><p>å½“ç„¶è¿˜æ˜¯è¦ç‚«è€€ä¸€ä¸‹æ”¶åˆ°çš„å°å¡ç‰‡çš„ï¼</p><p><img src="/images/others/random_thoughts/explore3/rubatotree_shielded_card.jpg" alt=""></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;ä¹¦æ¥ä¸Šä¸Šä¸Šå›ï¼ˆæ¢ç´¢æ—¥å¿—[0]ï¼‰ï¼Œä»Šå¤©å’Œä¸Šä¸Šæ¬¡å‚åŠ  Ludum Dare Compo ç»“è¯†çš„æœ‹å‹ä¸€èµ·åƒé¥­äº†ï¼Œéš¾é“è¯´æˆ‘å°±è¦å¤±å»ç¤¾æå±æ€§å’Œå®…å±æ€§äº†å—ï¼&lt;/p&gt;
&lt;p&gt;æ€»ä¹‹å°±æ˜¯ä»–è¿™å‡ å¤©æ¥åŒ—äº¬ç©ï¼Œæˆ‘å°±é¼“èµ·å‹‡æ°”é—®ä»–è¦ä¸è¦æ¥æ‰¾æˆ‘ç©ï¼ˆå…¶å®å¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯ä¸ºäº†æ°´ä¸€ç¯‡æ¢ç´¢æ—¥å¿—ï¼Œæ¢ç´¢æ—¥å¿—é©±åŠ¨æ¢ç´¢ï¼‰ï¼Œ</summary>
      
    
    
    
    <category term="æ‚è°ˆ" scheme="http://rinevard.github.io/categories/%E6%9D%82%E8%B0%88/"/>
    
    <category term="ç¢ç¢å¿µ" scheme="http://rinevard.github.io/categories/%E6%9D%82%E8%B0%88/%E7%A2%8E%E7%A2%8E%E5%BF%B5/"/>
    
    
  </entry>
  
  <entry>
    <title>æ¢ç´¢æ—¥å¿—[2]</title>
    <link href="http://rinevard.github.io/wiki/others/thoughts/%E6%8E%A2%E7%B4%A2%E6%97%A5%E5%BF%972/"/>
    <id>http://rinevard.github.io/wiki/others/thoughts/%E6%8E%A2%E7%B4%A2%E6%97%A5%E5%BF%972/</id>
    <published>2025-10-27T13:56:15.000Z</published>
    <updated>2025-10-28T02:16:47.945Z</updated>
    
    <content type="html"><![CDATA[<p>é™ªè·‘äº† Supercell ä¸¾åŠçš„ Global AI Game Hack. è™½ç„¶æ„Ÿè§‰è‡ªå·±åšçš„æ¸¸æˆå¹¶ä¸æ¯”è·å¥–ä½œå“å·®ï¼Œä½†æ— æ‰€è°“äº†ï¼Œæˆ‘åšå‡ºäº†è‡ªå·±æ»¡æ„çš„ä½œå“ã€‚</p><p><img src="/images/others/random_thoughts/explore2/wtf.png" alt=""></p><p>åªæ˜¯é™ªè·‘æ˜¯ç§°ä¸ä¸Šæ¢ç´¢çš„ï¼ˆåˆä¸æ˜¯ç¬¬ä¸€æ¬¡é™ªè·‘äº†ï¼‰ã€‚è¿™æ¬¡ä¸»è¦æ˜¯å°è¯•åšäº†ä»¥å‰æ„æ€è¿‡ï¼Œä½†æ„Ÿè§‰â€œè¿™æ ¹æœ¬åšä¸åˆ°ï¼â€çš„ä½œå“ï¼Œè€Œä¸”è¿˜åšå‡ºæ¥äº†ã€‚</p><p>æˆ‘ä»¬è¯¥æ€æ ·åšä¸€ä¸ªåŸºäº LLM çš„æ¸¸æˆï¼Ÿæˆ‘çš„ç¬¬ä¸€ä¸ªç­”æ¡ˆæ˜¯<a href="https://rinevard.itch.io/myriad-by-cards">ç‰Œç”Ÿä¸‡ç‰©</a>ï¼Œè¿™æ˜¯ä¸€ä¸ªæŠŠå¡ç‰Œæ”¾åˆ°ä¸€èµ·è®© AI åŸºäºå †åœ¨ä¸€èµ·çš„å¡ç‰Œè®²æ•…äº‹çš„æ¸¸æˆã€‚ä¸€äº›è¯•ç©çš„ç©å®¶è¿˜æŒºå–œæ¬¢è¿™ä¸ªæ¸¸æˆï¼Œä¸è¿‡ä»‹äº AI å¾ˆéš¾å†™å‡ºæœ‰æ„ä¹‰çš„æ•…äº‹ï¼Œæˆ‘ç®€å•æ”¹äº†æ”¹å°±æ²¡æœ‰ç»§ç»­åšä¸‹å»äº†ï¼ˆç°åœ¨å®ƒå«åšã€Šè¥¿è¡Œç‰Œå½•ã€‹ï¼‰ã€‚</p><p>è®©æˆ‘ä»¬å›åˆ°ä¹‹å‰çš„é—®é¢˜ï¼Œæˆ‘ä»¬è¯¥æ€æ ·åšä¸€ä¸ªåŸºäº LLM çš„æ¸¸æˆï¼Ÿæˆ‘ä»¬å½“ç„¶ä¼šæƒ³ï¼Œå¦‚æœè®©æ¯ä¸ª NPC éƒ½ç”± LLM é©±åŠ¨ï¼Œè¿™ä¸ªä¸–ç•Œå°±ä¼šæœ‰æ— ç©·çš„å¯èƒ½æ€§ã€‚è¿™æ˜¯æˆ‘ä¸€å¼€å§‹å°±åå¯¹çš„ç­”æ¡ˆã€‚æˆ‘è®¤ä¸º AI å›å¤çš„ä¿¡æ¯å¯†åº¦å¤ªä½ï¼Œè¿˜ä¼šèƒ¡ç¼–ä¹±é€ ï¼Œæ²¡æœ‰ä»»ä½•æ„ä¹‰ã€‚æ›´ä½•å†µä¸¤ä¸ª AI ä¹‹é—´èŠäº†å‡ å¥å°±ä¼šå¼€å§‹ç›¸äº’å¤è¯»äº†ã€‚ä¸è¿‡åæ¥ç©åˆ°äº†ä¸€ä¸ª AI ä¼šç›¸äº’äº¤äº’èŠå¤©çš„æ¸¸æˆï¼Œäº²èº«è¿›å…¥ä¸€ä¸ª NPC æœ‰è‡ªå·±çš„ç”Ÿæ´»çš„æ¸¸æˆæ„Ÿè§‰è¶…é…·ï¼å½“ç„¶æˆ‘è¿˜æ˜¯ä¸è®¤ä¸ºè¿™ä¸ªä¸œè¥¿æœ‰ä»€ä¹ˆæ‹“å±•ç©ºé—´ï¼Œä¸è¿‡ç¡®å®æŒºé…·çš„ã€‚</p><p>é‚£è¿™æ¬¡æˆ‘çš„ç­”æ¡ˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘æƒ³å¸¦æ¥å°½å¯èƒ½å¤šçš„å¯èƒ½æ€§ï¼Œè®©ç©å®¶èƒ½åšåˆ°ä»–ä»¬èƒ½æƒ³åˆ°çš„å¤§éƒ¨åˆ†äº‹æƒ…ã€‚ä»¥å‰æˆ‘ç©åˆ°è¿‡å…è®¸è‡ªå®šä¹‰è§„åˆ™çš„ LLM æ¸¸æˆï¼Œä½†ä½œè€…çš„å®ç°æ–¹æ³•æ˜¯è®© LLM æ‹¼å‡‘ä¸€å †é¢„åˆ¶çš„è§„åˆ™ç»„ä»¶ï¼Œäºæ˜¯ç»å¸¸å‡ºç°â€œæˆ‘æƒ³è¦è¿™ä¸ªè§„åˆ™ä½† AI å†™ä¸å‡ºæ¥â€çš„æƒ…å†µã€‚å› æ­¤æˆ‘æƒ³ï¼Œå¦‚æœè¦çœŸæ­£åšåˆ°å°½å¯èƒ½å¤šçš„å¯èƒ½æ€§ï¼Œå°±åªèƒ½æŠŠæ•´ä¸ªæ¸¸æˆçŠ¶æ€éƒ½äº¤ç»™ LLM ç®¡ç†ã€‚</p><p>å¬ä¸Šå»å°±åšä¸åˆ°ä¸æ˜¯å—ï¼Ÿæˆ‘æƒ³å‡ºè¿™ä¸ªæƒ³æ³•æ—¶ä¹Ÿæ„Ÿè§‰â€œè¿™æ ¹æœ¬åšä¸åˆ°ï¼æ–‡å­—å°±ç®—äº†ï¼ŒåŠ¨ç”»æ€ä¹ˆåŠï¼Ÿè¿˜æœ‰æ›´å¤šæ›´å¤šçš„ä¸œè¥¿æ€ä¹ˆåŠï¼Ÿâ€ï¼Œå› æ­¤æ²¡æœ‰å»åšã€‚ä½†å¦‚ä¸Šæ–‡æ‰€è¨€ï¼Œæˆ‘åœ¨è¿™æ¬¡ hackathon è¯•ç€åšäº†è¿™ä¸ªæƒ³æ³•ï¼ˆä¸ºä»€ä¹ˆå®ƒä¸å« gamejam è€Œå« hackathon å‘¢ï¼Œæ˜æ˜æ˜¯åšæ¸¸æˆâ€¦ï¼‰ã€‚</p><p>æˆ‘è§è¿‡çš„è®¸å¤šæ¸¸æˆè®¾è®¡èµ„æ–™éƒ½å‘Šè¯‰æˆ‘ï¼Œâ€œåŸå‹æ˜¯å¾ˆå¯èƒ½å¤±è´¥çš„ï¼Œæ‰¾åˆ°å¤±è´¥ä¹‹å¤„å°±æ˜¯åŸå‹åˆ¶ä½œçš„ç›®çš„ã€‚â€ä½†ä½ æˆ‘çš†çŸ¥æˆ‘ä»¬éƒ½æœ‰å¯¹å¤±è´¥çš„ææƒ§ã€‚åœ¨é¢å¯¹ä¸€ä¸ªçœ‹ä¸Šå»å°±åšä¸åˆ°çš„æ¦‚å¿µæ—¶ï¼Œæˆ‘å¯¹â€œå®ç°è¿™ä¸ªæ¦‚å¿µâ€çš„é¢„æœŸå°±æ˜¯å¤±è´¥ï¼Œå³ä½¿æ˜¯è¿™æ ·ä¹Ÿè¦åšä¸‹å»å—â€¦</p><p>å³ä½¿æ˜¯æœç€å¤±è´¥ä¹Ÿè¦åšä¸‹å»å—ï¼Ÿå‡ å‘¨å‰å‚åŠ çš„ Ludum Dare è¿˜æå‰ä¸€å¤©å‡ºç»“æœäº†ï¼Œæ’ä¸Šäº†è¿™ä¸ª hackathon çš„å¼€å¤´ï¼Œæˆ‘ä¹Ÿæ²¡æ‹¿åˆ°æ»¡æ„çš„æˆç»©ã€‚å³ä½¿æ˜¯è¿™æ ·ä¹Ÿè¦åšä¸‹å»å—ï¼Ÿæˆ‘æ˜¯ä¸æ˜¯æ ¹æœ¬åšä¸å‡ºæœ‰è¶£çš„æ¸¸æˆï¼Ÿ</p><p>æˆ‘çœ‹å‘äº† Jeremy Ryanï¼ŒHope Falters çš„ä½œè€…ï¼ˆè¿™æ˜¯æˆ‘æœ€å–œæ¬¢çš„æ¸¸æˆä¹‹ä¸€ï¼‰ï¼Œæƒ³çœ‹çœ‹ ta åœ¨æœ€å¼€å§‹æ—¶åšå‡ºçš„ä½œå“æ˜¯æ€æ ·çš„ã€‚æˆ‘çœ‹å‘äº†ä¸€äº›åˆ«çš„æˆ‘å–œæ¬¢çš„ä½œè€…ï¼Œæƒ³çœ‹çœ‹ä»–ä»¬åœ¨æœ€å¼€å§‹æ—¶åšå‡ºçš„ä½œå“æ˜¯æ€æ ·çš„ã€‚æˆ‘çœ‹å‘äº†ä¸€äº›åšäº†å¾ˆä¹…æ¸¸æˆä½†åšçš„è¿˜æ˜¯å¾ˆç³Ÿç³•ï¼Œä½†è¿˜æ˜¯åœ¨åšæ¸¸æˆçš„ä½œè€…ã€‚æˆ‘çœ‹å‘äº†å‡ ä¸ªå¹´é¾„å°äºæˆ‘ï¼Œæ’åä¹Ÿå°äºæˆ‘çš„ä½œè€…ã€‚å³ä½¿æ˜¯è¿™æ ·ä¹Ÿè¦åšä¸‹å»å—ï¼Ÿ</p><p>æ— æ‰€è°“äº†ï¼Œå³ä½¿æ˜¯è¿™æ ·ä¹Ÿè¦åšä¸‹å»ã€‚è€Œå¦‚å¼€å¤´æ‰€è¨€ï¼Œé™ªè·‘äº†ã€‚</p><p>ä½†è‡³å°‘æˆ‘çš„æœ‹å‹åœ¨ç©äº†æˆ‘çš„æ¸¸æˆä»¥åå‘å‡ºäº†â€œè¿™å±…ç„¶ä¼šé™ªè·‘å—â€çš„å£°éŸ³ï¼Œè‡³å°‘åœ¨è¯•ç©æ—¶å‡ ä¸ªç©å®¶éƒ½æŒºå–œæ¬¢çš„ï¼Œè¿™å°±å¥½äº†ã€‚</p><p>å—¯ï¼Œå³ä½¿è¦æ”¾å¼ƒï¼Œä¹Ÿè¦ç­‰åˆ°å¤§å®¶éƒ½ä¸å–œæ¬¢çš„é‚£å¤©å§ã€‚</p><p>ç»™è¿™ä¸ªæ¸¸æˆå‰ªè¾‘çš„ç¬¨è›‹å°è§†é¢‘ï¼Œå¯èƒ½ä¸ç¬¦åˆæ–‡ç« æ°›å›´ï¼Œæ…ç‚¹ï¼š<a href="https://youtu.be/P-J1xkifbYA">https://youtu.be/P-J1xkifbYA</a></p><p>è¯´å®Œæƒ…ç»ªä¸Šçš„æŒ£æ‰äº†ï¼Œä¸å¦¨å†æ¥èŠèŠè®¾è®¡ã€‚ä½ çŸ¥é“çš„ï¼Œæˆ‘ä¸€ç›´éƒ½å–œæ¬¢éšä¾¿èŠèŠæ¸¸æˆè®¾è®¡ä¸Šçš„ä¸œè¥¿ã€‚</p><p>åœ¨å¾—åˆ°äº†â€œæŠŠæ•´ä¸ªæ¸¸æˆçŠ¶æ€éƒ½äº¤ç»™ LLM ç®¡ç†â€è¿™ä¸ªæ¦‚å¿µåï¼Œæˆ‘è„‘æµ·ä¸­å°±å‘ˆç°å‡ºäº†è¿™ä¸ªæ¸¸æˆç°åœ¨çš„æ ·å­â€”â€”è®©ç©å®¶ç»„åˆè¯æ±‡æ¥åˆ›é€ é­”æ³•ï¼ŒLLM è§£æé­”æ³•å¹¶æ”¹å˜åœºé¢ã€‚ä¸è¿‡æˆ‘æ„Ÿè§‰è‡ªå·±ä»¥å‰çš„è®¾è®¡éƒ½æ˜¯é™¤äº†æ¦‚å¿µä¸€æ— æ˜¯å¤„çš„è®¾è®¡ï¼Œæ‰€ä»¥è¿™æ¬¡æƒ³è¯•è¯•ä¹‹å‰çœ‹åˆ°çš„â€œæ³¨é‡å¤–å›´è®¾è®¡â€çš„åšæ³•ã€‚</p><p>æ®æˆ‘ç†è§£ï¼Œå¤–å›´è®¾è®¡å°±æ˜¯åœ¨æ ¸å¿ƒæ¦‚å¿µä¹‹å¤–åšä¸€äº›è®¾è®¡æ¥å‘ˆç°è¿™ä¸ªæ¦‚å¿µçš„å¯èƒ½æ€§ã€‚æ¯”å¦‚è¯´ä¿„ç½—æ–¯æ–¹å—çš„æ¦‚å¿µå¯èƒ½æ˜¯â€œå‡‘æ»¡ä¸€è¡Œå°±æ¶ˆé™¤â€ï¼Œå¤–å›´è®¾è®¡å°±æ˜¯ä¸åŒå½¢çŠ¶çš„ç§¯æœ¨ã€‚å¦‚æœç§¯æœ¨åªæœ‰æ­£æ–¹å½¢å’Œé•¿æ¡ï¼Œæ¸¸æˆä¹Ÿèƒ½å·¥ä½œï¼Œä½†å°±æ²¡æœ‰ç°åœ¨è¿™ä¹ˆä¸°å¯Œçš„å¯èƒ½æ€§äº†ã€‚</p><p>è¿™æ¬¡æˆ‘åšçš„å¤–å›´è®¾è®¡åŒ…æ‹¬ç”¨äºæ©é¥°ç”Ÿæˆé€Ÿåº¦è¾ƒæ…¢çš„ TTS æ—ç™½ã€ä¸€äº›æ‰‹åŠ¨è®¾è®¡çš„é«˜æ¦‚å¿µè¯æ±‡ã€‚</p><p>å†™åˆ°è¿™é‡Œçªç„¶æœ‰äº›ç–‘æƒ‘ã€‚æ—¢ç„¶åœ¨å¾—åˆ°äº†è¿™ä¸ªâ€œLLM ç®¡ç†æ¸¸æˆçŠ¶æ€â€çš„æ¦‚å¿µåæˆ‘å°±æƒ³å‡ºäº†è¿™ä¸ªæ¸¸æˆç°åœ¨çš„æ ·å­ï¼Œé‚£æˆ‘ä¸ºä»€ä¹ˆä¼šæ„Ÿè§‰â€œè¿™æ ¹æœ¬åšä¸åˆ°â€å‘¢ï¼Ÿæˆ‘ä¸çŸ¥é“ï¼Œå¯èƒ½åªæ˜¯ææƒ§å¤±è´¥å§ã€‚</p><p>ã€Šæ¸¸æˆè®¾è®¡è‰ºæœ¯ã€‹å‘è¯»è€…å‘å‡ºçš„æœ€åä¸€ä¸ªé—®é¢˜æ˜¯ï¼šâ€œä¸ºä»€ä¹ˆæˆ‘è¦åšç°åœ¨åœ¨åšçš„äº‹â€ã€‚è´¯å½»ä¸€ä¸ªä¸»é¢˜çš„ä½œå“ä¼šå˜å¾—æ›´åŠ æœ‰åŠ›ï¼Œæˆ‘ä»¬æ¯ä¸ªäººä¹Ÿéƒ½æœ‰è‡ªå·±çš„ä¸»é¢˜ã€‚é‚£ä¹ˆæˆ‘ä¸ºä»€ä¹ˆè¦åšæ¸¸æˆï¼Œæˆ‘çš„ä¸»é¢˜åˆæ˜¯ä»€ä¹ˆï¼Ÿæˆ‘ä¼šå¯»æ‰¾ç­”æ¡ˆã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;é™ªè·‘äº† Supercell ä¸¾åŠçš„ Global AI Game Hack. è™½ç„¶æ„Ÿè§‰è‡ªå·±åšçš„æ¸¸æˆå¹¶ä¸æ¯”è·å¥–ä½œå“å·®ï¼Œä½†æ— æ‰€è°“äº†ï¼Œæˆ‘åšå‡ºäº†è‡ªå·±æ»¡æ„çš„ä½œå“ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/others/random_thoughts/explore2/wtf</summary>
      
    
    
    
    <category term="æ‚è°ˆ" scheme="http://rinevard.github.io/categories/%E6%9D%82%E8%B0%88/"/>
    
    <category term="ç¢ç¢å¿µ" scheme="http://rinevard.github.io/categories/%E6%9D%82%E8%B0%88/%E7%A2%8E%E7%A2%8E%E5%BF%B5/"/>
    
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•åœ¨ä¸ƒå¤©å†…åˆ¶ä½œæ¸¸æˆåŸå‹</title>
    <link href="http://rinevard.github.io/wiki/others/translation/%E4%B8%83%E5%A4%A9%E5%8E%9F%E5%9E%8B/"/>
    <id>http://rinevard.github.io/wiki/others/translation/%E4%B8%83%E5%A4%A9%E5%8E%9F%E5%9E%8B/</id>
    <published>2025-10-15T13:47:11.000Z</published>
    <updated>2025-10-15T14:10:39.846Z</updated>
    
    <content type="html"><![CDATA[<p>ç¿»è¯‘è‡ª <a href="http://miami.lgrace.com/documents/How%20to%20Prototype%20a%20Game%20in%20Under%207%20Days.pdf">How to Prototype a Game in Under 7 Days</a></p><p>æ¥è‡ªå››ä½åœ¨ä¸€ä¸ªå­¦æœŸå†…åšäº†è¶…è¿‡ 50 æ¬¾æ¸¸æˆçš„ç ”ç©¶ç”Ÿçš„å¿ƒå¾—</p><p>ä½œè€…ï¼šKyle Gabler, Kyle Gray, Matt Kucic å’Œ Shalin Shodhan</p><p><img src="/images/others/translation/how_to_prototype_seven_day/1_tower_of_goo.jpg" alt="&quot;é»é»ä¸–ç•Œ&quot;åœ¨ä¸Šçº¿æ•°æœˆå†…ä¸‹è½½é‡å°±è¶…è¿‡äº†10ä¸‡æ¬¡ã€‚"></p><p>è¿™é‡Œæœ‰ä¸€ä¸ªç–¯ç‹‚çš„æ¸¸æˆç‚¹å­ï¼šæ‹–åŠ¨é‚£äº›ä¼šè¯´åƒåœ¾è¯çš„ç²˜æ¶²çƒï¼Œå»ºé€ ä¸€åº§è¶Šæ¥è¶Šé«˜çš„å·¨å¡”ã€‚å®ƒä»¬è •åŠ¨ã€å’¯å’¯ç¬‘ï¼Œå¹¶çˆ¬ä¸Šå…„å¼Ÿä»¬çš„èƒŒå‘ä¸Šæ”€çˆ¬ã€‚ä½†è¦å°å¿ƒï¼è¿™æ˜¯ä¸€åœºä¸é‡åŠ›çš„æŒä¹…æˆ˜ã€‚å¦‚æœä½ å»ºé€ çš„å¡”å¤ªä¸ç¨³å®šï¼Œå®ƒå°±ä¼šå€’å¡Œã€‚</p><p>â€œé»é»ä¸–ç•Œâ€åœ¨ä¸Šçº¿æ•°æœˆå†…ä¸‹è½½é‡è¶…è¿‡äº†10ä¸‡æ¬¡ï¼Œåœ¨ä¸€æœ¬æ‚å¿—ä¸­è¢«èª‰ä¸ºâ€œæœˆåº¦ç½‘ç»œæ¸¸æˆâ€ï¼Œåœ¨G4é¢‘é“å’ŒGDCçš„å®éªŒæ€§æ¸¸æˆå·¥ä½œåŠä¸Šè¿›è¡Œäº†æ¼”ç¤ºï¼Œå¹¶ä¸”æ˜¯æˆ‘ä»¬åœ¨å¡å†…åŸºæ¢…éš†å¤§å­¦å¨±ä¹æŠ€æœ¯ä¸­å¿ƒçš„å®éªŒæ€§æ¸¸æˆé¡¹ç›®ä¸­æ‰€åˆ¶ä½œçš„äº”åå¤šæ¬¾æ¸¸æˆä¹‹ä¸€ã€‚</p><p>å’Œå…¶ä½™çš„æ¸¸æˆä¸€æ ·ï¼Œå®ƒä¹Ÿæ˜¯ç”±ä¸€ä¸ªäººåœ¨ä¸€å‘¨ä¹‹å†…å®Œæˆçš„ã€‚</p><p>è¯¥é¡¹ç›®å§‹äº2005å¹´æ˜¥å­£ï¼Œç›®æ ‡æ˜¯å°½å¯èƒ½å¤šåœ°å‘ç°æ–°çš„æ¸¸æˆç©æ³•å¹¶ç»™å®ƒä»¬åšåŸå‹ã€‚æˆ‘ä»¬å››åç ”ç©¶ç”Ÿç»„æˆäº†å›¢é˜Ÿï¼ŒæŠŠè‡ªå·±å…³åœ¨æˆ¿é—´é‡Œï¼Œä¸€ä¸ªå­¦æœŸéƒ½éµå®ˆç€ä¸‹é¢ä¸‰æ¡è§„åˆ™ï¼š</p><ol><li>æ¯ä¸ªæ¸¸æˆå¿…é¡»åœ¨ä¸ƒå¤©å†…å®Œæˆï¼Œ</li><li>æ¯ä¸ªæ¸¸æˆå¿…é¡»ç”±ä¸€ä¸ªäººå®Œæˆï¼Œ</li><li>æ¯ä¸ªæ¸¸æˆå¿…é¡»åŸºäºä¸€ä¸ªå…±åŒçš„ä¸»é¢˜ï¼Œä¾‹å¦‚â€œé‡åŠ›â€ã€â€œæ¤è¢«â€ã€â€œèœ‚ç¾¤â€ç­‰ã€‚</li></ol><p>éšç€é¡¹ç›®è¿›è¡Œï¼Œæˆ‘ä»¬å¯¹èœ‚æ‹¥è€Œè‡³çš„æµé‡ã€æ¸¸æˆæ‚å¿—çš„å…³æ³¨ä»¥åŠè¡Œä¸šä¸“ä¸šäººå£«å’Œå­¦è€…ä»¬éƒ½é—®ç€çš„åŒæ ·çš„é—®é¢˜æ„Ÿåˆ°æƒŠè®¶å’Œæ¿€åŠ¨ï¼šâ€œä½ ä»¬æ˜¯å¦‚ä½•è¿™ä¹ˆå¿«åœ°åˆ¶ä½œè¿™äº›æ¸¸æˆçš„ï¼Ÿâ€ä»¥åŠâ€œæˆ‘ä»¬è¯¥æ€ä¹ˆåšï¼Ÿâ€</p><p>æˆ‘ä»¬åœ¨è¿™é‡Œå°†ä¸€åˆ‡å…¨ç›˜æ‰˜å‡ºã€‚ç»“åˆä»¥ä¸‹çš„å»ºè®®ã€æŠ€å·§å’Œä¾‹å­ï¼Œæˆ‘ä»¬å°†è®¨è®ºé‚£äº›æœ‰ç”¨çš„å’Œæ²¡ç”¨çš„æ–¹æ³•ã€‚æˆ‘ä»¬å°†å‘ä½ å±•ç¤ºå¦‚ä½•è¿›å…¥å¿«é€ŸåŸå‹åˆ¶ä½œçš„æ€ç»´çŠ¶æ€ï¼Œå¦‚ä½•ç»„å»ºä¸€ä¸ªé«˜æ•ˆçš„å›¢é˜Ÿï¼Œä»¥åŠå¦‚æœä½ æƒ³è¿‡åˆ›é€ æ–°ä¸œè¥¿ä½†ä¸çŸ¥ä»ä½•ä¸‹æ‰‹æ—¶åº”è¯¥ä»å“ªé‡Œå¼€å§‹ã€‚æˆ‘ä»¬å¸Œæœ›è¿™äº›ç»è¿‡è®¤çœŸéªŒè¯çš„æŒ‡å—å¯¹ä½ çš„ä¸‹ä¸€ä¸ªé¡¹ç›®ï¼Œæ— è®ºå¤§å°ï¼Œèƒ½æ´¾ä¸Šç”¨åœºï¼</p><p>ä¸ºäº†ä¾¿äºé˜…è¯»ï¼Œæœ¬æ–‡çš„å»ºè®®å’ŒæŠ€å·§ä¼šè¢«åˆ†ä¸ºå››ä¸ªéƒ¨åˆ†ï¼šå‡†å¤‡ã€è®¾è®¡ã€å¼€å‘å’Œé€šç”¨çš„æŠ€å·§ã€‚ç¥ä½ é˜…è¯»æ„‰å¿«ï¼</p><h2 id="å‡†å¤‡ï¼šå¿«é€Ÿæ˜¯ä¸€ç§å¿ƒæ€"><a href="#å‡†å¤‡ï¼šå¿«é€Ÿæ˜¯ä¸€ç§å¿ƒæ€" class="headerlink" title="å‡†å¤‡ï¼šå¿«é€Ÿæ˜¯ä¸€ç§å¿ƒæ€"></a>å‡†å¤‡ï¼šå¿«é€Ÿæ˜¯ä¸€ç§å¿ƒæ€</h2><p>å¿«é€ŸåŸå‹ä¸ä»…æ˜¯å‰æœŸåˆ¶ä½œä¸­çš„ä¸€ä¸ªæœ‰ç”¨å·¥å…·â€”â€”å®ƒè¿˜å¯ä»¥æˆä¸ºä¸€ç§ç”Ÿæ´»æ–¹å¼ï¼æœ¬èŠ‚å°†å±•ç¤ºå¦‚ä½•å‡†å¤‡å¹¶å¼€å§‹åƒä¸€ä¸ªå¿«é€ŸåŸå‹åˆ¶ä½œè€…é‚£æ ·æ€è€ƒã€‚</p><h3 id="æ‹¥æŠ±å¤±è´¥çš„å¯èƒ½æ€§â€”â€”å®ƒé¼“åŠ±åˆ›é€ æ€§å†’é™©"><a href="#æ‹¥æŠ±å¤±è´¥çš„å¯èƒ½æ€§â€”â€”å®ƒé¼“åŠ±åˆ›é€ æ€§å†’é™©" class="headerlink" title="æ‹¥æŠ±å¤±è´¥çš„å¯èƒ½æ€§â€”â€”å®ƒé¼“åŠ±åˆ›é€ æ€§å†’é™©"></a>æ‹¥æŠ±å¤±è´¥çš„å¯èƒ½æ€§â€”â€”å®ƒé¼“åŠ±åˆ›é€ æ€§å†’é™©</h3><p>â€œé£é™©â€å¯¹æˆ‘ä»¬çš„å½±å“å¤ªå¤§äº†ã€‚æ®æˆ‘ä»¬æ‰€çŸ¥ï¼Œå¯¹å¤±è´¥çš„ææƒ§æ˜¯ç”µå½±IPæ”¹ç¼–æ¸¸æˆå’Œç»­ä½œé«˜è¾¾ä¸¤ä½æ•°çš„æ¸¸æˆä¸æ–­è¢«åˆ¶ä½œå‡ºæ¥çš„åŸå› ã€‚è¿™å°±åƒæ€»æ˜¯é€‰æ‹©å»éº¦å½“åŠ³ï¼Œè€Œä¸æ˜¯ä¸€å®¶æœªæ›¾æ¢ç´¢è¿‡çš„æ–°é¤å…â€”â€”æ€»æ˜¯ä¾èµ–äºä¸€ä¸ªä¼—æ‰€å‘¨çŸ¥çš„ã€å°šå¯çš„é€‰é¡¹ï¼Œè€Œä¸æ˜¯å†’é™©å°è¯•æœªçŸ¥ä½†å¯èƒ½ç¾å‘³çš„é€‰æ‹©ã€‚</p><p>ä¸€ä¸ªå¥½çš„å¿«é€ŸåŸå‹åˆ¶ä½œè€…ä¼šçŸ¥é“å¤±è´¥æ˜¯å¯ä»¥æ¥å—çš„ï¼æ‰¾åˆ°å¤±è´¥ä¹‹å¤„å°±æ˜¯åŸå‹åˆ¶ä½œçš„ç›®çš„ï¼Œæ‰€ä»¥å°½æƒ…å»åšå§ï¼å³ä½¿ä½ å¤±è´¥äº†ï¼Œä¹Ÿè¿˜ä¼šæœ‰æ— æ•°çš„æœºä¼šï¼Œè€Œä¸”å¾ˆå¯èƒ½ä½ æ€»èƒ½å­¦åˆ°äº›ä¸œè¥¿ã€‚åªæœ‰æ‹¥æŠ±å¤±è´¥ï¼Œæ‰å¯èƒ½åšå‡ºæœ‰ä»·å€¼çš„å®éªŒã€‚</p><p>Mr. Grayï¼šâ€œã€ŠMime After Mimeã€‹å’Œã€ŠA Mime to Killã€‹æ˜¯æˆ‘åšçš„ä¸¤æ¬¾åªæœ‰å£°éŸ³æ²¡æœ‰ç”»é¢çš„æ¸¸æˆã€‚å°½ç®¡å®ƒä»¬æ˜¯å½»å¤´å½»å°¾çš„å¤±è´¥å“ï¼Œä½†æ•´ä¸ªå›¢é˜Ÿéƒ½ä¸ºèƒ½å†’å¦‚æ­¤å¤§çš„é£é™©æ¥è¯æ˜çº¯éŸ³é¢‘æ¸¸æˆçš„å¤±è´¥è€Œæ„Ÿåˆ°å…´å¥‹ï¼Œæˆ‘å¯ä»¥è‡ªè±ªåœ°è¯´å®ƒä»¬æ˜¯æˆ‘åšçš„ã€‚éšç€æˆ‘åœ¨æ•´ä¸ªé¡¹ç›®ä¸­ç§¯ç´¯ç»éªŒï¼Œæˆ‘é€æ¸èƒ½è¿›è¡Œæ›´æœ‰é’ˆå¯¹æ€§çš„å†’é™©ï¼Œå®ƒä»¬å¸¦æ¥äº†æˆåŠŸçš„æ¸¸æˆã€‚â€</p><p><img src="/images/others/translation/how_to_prototype_seven_day/2_mine_after_mine_and_a_mime_to_kill.png" alt="&quot;Mime After Mime&quot;å’Œ&quot;A Mime to Kill&quot;â€”â€”çƒ­æƒ…æ‹¥æŠ±å¤±è´¥ã€‚"></p><h3 id="å¼ºåˆ¶ç¼©çŸ­å¼€å‘å‘¨æœŸï¼ˆæ›´å¤šæ—¶é—´-æ›´é«˜è´¨é‡ï¼‰"><a href="#å¼ºåˆ¶ç¼©çŸ­å¼€å‘å‘¨æœŸï¼ˆæ›´å¤šæ—¶é—´-æ›´é«˜è´¨é‡ï¼‰" class="headerlink" title="å¼ºåˆ¶ç¼©çŸ­å¼€å‘å‘¨æœŸï¼ˆæ›´å¤šæ—¶é—´ != æ›´é«˜è´¨é‡ï¼‰"></a>å¼ºåˆ¶ç¼©çŸ­å¼€å‘å‘¨æœŸï¼ˆæ›´å¤šæ—¶é—´ != æ›´é«˜è´¨é‡ï¼‰</h3><p>ä½ åªéœ€è¦å‡ å¤©æ—¶é—´ã€‚æœ‰ä¸€ç§å¾ˆè‡ªç„¶çš„æƒ³æ³•æ˜¯ï¼šâ€œæˆ‘ä»¬ä¸€å‘¨åšäº†ä¸€ä¸ªå¾ˆæ£’çš„æ¸¸æˆã€‚æ‰€ä»¥å¦‚æœæˆ‘ä»¬èŠ±ä¸¤å‘¨æ—¶é—´ï¼Œå®ƒä¼šå¥½ä¸Šä¸¤å€ï¼â€ã€‚å½“ç„¶ï¼Œäº‹å®å¹¶éå¦‚æ­¤ã€‚æˆ‘ä»¬å‘ç°ï¼Œé€šå¸¸ä»»ä½•æ¸¸æˆç‚¹å­éƒ½å¯ä»¥åœ¨ä¸åˆ°ä¸€å‘¨çš„æ—¶é—´å†…æœ‰æ•ˆåœ°è¿›è¡ŒåŸå‹è®¾è®¡ã€‚å¤šä½™çš„æ—¶é—´å¾€å¾€ä¼šäº§ç”Ÿé€’å‡çš„å›æŠ¥ã€‚ä¾‹å¦‚ï¼Œä¸€äº›åŸå‹åªç”¨äº†ä¸€ä¸ªæ™šä¸Šå°±å®Œæˆäº†ï¼Œè€Œå¦ä¸€äº›åˆ™å¤šèŠ±äº†ä¸€ä¸¤å‘¨çš„æ—¶é—´ã€‚ä»¤äººæƒŠè®¶çš„æ˜¯ï¼Œæˆ‘ä»¬å‘ç°å¼€å‘æ—¶é—´ä¸æ¸¸æˆæœ€ç»ˆçš„æˆåŠŸç¨‹åº¦ä¹‹é—´æ²¡æœ‰å…³è”ã€‚</p><p><img src="/images/others/translation/how_to_prototype_seven_day/3_left_and_right.jpg" alt="&quot;Attack of the Killer Swarm&quot;ï¼ˆå·¦ï¼‰åªç”¨äº†ä¸€å¤©æ—¶é—´å°±å®Œæˆäº†ï¼Œå¹¶å‡ºäººæ„æ–™åœ°æˆä¸ºè¯¥é¡¹ç›®ä¸­è¯„ä»·æœ€é«˜çš„æ¸¸æˆä¹‹ä¸€ã€‚&quot;Suburban Brawl&quot;ï¼ˆå³ï¼‰å¤šèŠ±äº†ä¸€å‘¨çš„æ—¶é—´ï¼Œä½†å˜å¾—è¿‡äºå¤æ‚ã€‚å¦‚æœæ²¡æœ‰èŠ±æ—¶é—´æ·»åŠ é‚£äº›å·¨å‹æ€æ‰‹æœºå™¨äººï¼Œå®ƒå¯èƒ½ä¼šæ›´æœ‰è¶£ã€‚"></p><h3 id="å¯¹åˆ›é€ çš„çº¦æŸè®©ä½ æ›´æƒ³åˆ›é€ "><a href="#å¯¹åˆ›é€ çš„çº¦æŸè®©ä½ æ›´æƒ³åˆ›é€ " class="headerlink" title="å¯¹åˆ›é€ çš„çº¦æŸè®©ä½ æ›´æƒ³åˆ›é€ "></a>å¯¹åˆ›é€ çš„çº¦æŸè®©ä½ æ›´æƒ³åˆ›é€ </h3><p>æˆ‘ä»¬æœ€æˆåŠŸçš„æ¸¸æˆéƒ½æºäºç‰¹å®šçš„ä¸»é¢˜æˆ–â€œç©å…·â€ï¼Œæ¯”å¦‚â€œé‡åŠ›â€ã€â€œèœ‚ç¾¤â€ï¼Œæˆ–è€…â€œåˆ¶ä½œä¸€æ¬¾ä¸»è¦é¢å‘å¥³æ€§ä¼‘é—²ç©å®¶çš„æ¸¸æˆâ€ã€‚ä¸çŸ¥ä¸ºä»€ä¹ˆï¼Œåœ¨æœ‰é™åˆ¶çš„æƒ…å†µä¸‹ï¼Œåˆ›é€ å˜å¾—æ›´å®¹æ˜“äº†ã€‚</p><p>æ­¤å¤–ï¼Œå½“ä¸€ä¸ªå›¢é˜Ÿçš„äººéƒ½å›´ç»•ä¸€ä¸ªç‰¹å®šä¸»é¢˜åŒæ—¶åšåŸå‹æ—¶ï¼Œæˆ‘ä»¬éƒ½å€¾å‘äºé¿å…ä½¿ç”¨é‚£äº›æ˜¾è€Œæ˜“è§çš„æœºåˆ¶ã€‚è¿™ç§æŒ‘æˆ˜è®©æˆ‘ä»¬å»æ¢ç´¢å¹¶æŒ–æ˜ä¸»é¢˜ä¸­æ‰€æœ‰å¯èƒ½çš„æ¸¸æˆç©æ³•ã€‚</p><p>åœ¨é¡¹ç›®åæœŸï¼Œæˆ‘ä»¬é€æ¸åç¦»äº†è¿™ç§æ¨¡å¼ï¼Œè¿™æœ€ç»ˆå¯¹æˆ‘ä»¬é€ æˆäº†æŸå®³ã€‚æ²¡æœ‰äº†ä¸»é¢˜çº¦æŸï¼Œæ¸¸æˆåˆ¶ä½œæ—¶é—´æ›´é•¿ï¼Œæ–¹å‘æ€§æ›´å·®ï¼Œå›¢é˜Ÿå‡èšåŠ›ä¹Ÿä¸‹é™äº†ã€‚é‚£ç§â€œæˆ‘ä»¬éƒ½åœ¨ä¸€æ¡èˆ¹ä¸Šâ€çš„æ„Ÿè§‰å‡å°‘äº†ï¼Œæ›´ç³Ÿç³•çš„æ˜¯ï¼Œæˆ‘ä»¬å¤±å»äº†é‚£ç§æ›¾æ¿€å‘é¢å¤–åˆ›é€ åŠ›å’ŒæŠ€å·§çš„å‹å¥½ç«äº‰æ„Ÿã€‚</p><p>æˆ‘ä»¬æ¢ç´¢è¿‡çš„ä¸€äº›ä¸»é¢˜æœ‰ï¼šâ€œé‡åŠ›â€ã€â€œå¼¹ç°§â€ã€â€œè¿›åŒ–â€ã€â€œå£°éŸ³â€ã€â€œæ•é£Ÿè€…ä¸çŒç‰©â€ã€â€œä»¤äººä¸Šç˜¾çš„æ¸¸æˆâ€ã€â€œç»˜ç”»â€ã€â€œæŒ‡æ•°å¢é•¿â€ã€â€œæ¤è¢«â€ã€â€œå¹³è¡¡â€ï¼Œä»¥åŠå…¶ä»–ä¸€äº›ä¸ªäººä¸»é¢˜ã€‚</p><p><img src="/images/others/translation/how_to_prototype_seven_day/4_gravity_head.jpg" alt="&quot;Gravity Head&quot;"></p><h3 id="ç»„å»ºä¸€æ”¯ä¼˜ç§€çš„å›¢é˜Ÿå’Œä¸€ä½å®¢è§‚çš„é¡¾é—®â€”â€”å¿ƒæ€ä¸æ‰ååŒç­‰é‡è¦"><a href="#ç»„å»ºä¸€æ”¯ä¼˜ç§€çš„å›¢é˜Ÿå’Œä¸€ä½å®¢è§‚çš„é¡¾é—®â€”â€”å¿ƒæ€ä¸æ‰ååŒç­‰é‡è¦" class="headerlink" title="ç»„å»ºä¸€æ”¯ä¼˜ç§€çš„å›¢é˜Ÿå’Œä¸€ä½å®¢è§‚çš„é¡¾é—®â€”â€”å¿ƒæ€ä¸æ‰ååŒç­‰é‡è¦"></a>ç»„å»ºä¸€æ”¯ä¼˜ç§€çš„å›¢é˜Ÿå’Œä¸€ä½å®¢è§‚çš„é¡¾é—®â€”â€”å¿ƒæ€ä¸æ‰ååŒç­‰é‡è¦</h3><p>å›¢é˜Ÿä¸­çš„æ¯ä¸ªæˆå‘˜éƒ½å¿…é¡»ç†Ÿæ‚‰æ¸¸æˆå¼€å‘çš„æ‰€æœ‰æ–¹é¢ã€‚æ¯ä¸ªäººéƒ½è´Ÿè´£è‡ªå·±çš„ç¼–ç¨‹ã€ç¾æœ¯ã€å£°éŸ³ä»¥åŠæœ€ç»ˆäº§å“ä¸­çš„å…¶ä»–ä¸€åˆ‡ã€‚ä½†èƒ½åŠ›å¹¶éä¸€åˆ‡ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œæ¯ä¸ªäººéƒ½å¿…é¡»ä»¥è¿™æ ·çš„ç†è§£æ¥å¯¹å¾…è¿™ç§å¼€å‘æ–¹å¼ï¼šè®¾è®¡æ˜¯è‡³é«˜æ— ä¸Šçš„â€”â€”ä»ç¾æœ¯åˆ°å·¥ç¨‹çš„ä¸€åˆ‡éƒ½åªæ˜¯ä¸ºæœ€ç»ˆè®¾è®¡æœåŠ¡ã€‚ä¸€ä¸ªæ·±è°™æ­¤é“çš„å¹³åº¸å·¥ç¨‹å¸ˆå¾ˆå¯èƒ½æ¯”ä¸€ä¸ªæ²¡æœ‰è¿™ç§å¿ƒæ€çš„ä¼˜ç§€å·¥ç¨‹å¸ˆæ›´æˆåŠŸã€‚</p><p>é¡¹ç›®é¡¾é—® Jesse Schell è¯´ï¼šâ€æˆ‘ä¸€ç›´ç—´è¿·äºäº§ç”Ÿæ–°æ¸¸æˆåˆ›æ„çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥å½“ Shalinã€Matt å’Œä¸¤ä½ Kyle æå‡ºè¿™ä¸ªé¡¹ç›®æ—¶ï¼Œæˆ‘è‡ªç„¶æ„Ÿåˆ°éå¸¸æ¿€åŠ¨ã€‚æˆ‘æŠŠå®ƒçœ‹ä½œä¸€ä¸ªåœ¨åˆ›é€ åŠ›æ–¹é¢è¿›è¡Œå¯¹ç…§å®éªŒçš„æœºä¼šï¼Œå¹¶å¸Œæœ›èƒ½å­¦åˆ°æœ‰ç”¨çš„æ¸¸æˆè®¾è®¡çŸ¥è¯†ã€‚ä½œä¸ºæŒ‡å¯¼è€å¸ˆï¼Œæˆ‘åŠªåŠ›ç¡®ä¿å›¢é˜Ÿå°è¯•å¤šç§ä¸åŒçš„æŠ€æœ¯ã€ä»é”™è¯¯ä¸­å­¦ä¹ ã€ä¸åœ¨è¡Œä¸é€šçš„æƒ³æ³•ä¸Šçº ç»“å¤ªä¹…ï¼Œå¹¶åŠªåŠ›ä¿è¯æ¯ä¸ªäººéƒ½åœ¨å¯»æ‰¾æœ€é€‚åˆè‡ªå·±çš„åˆ›ä½œè¿‡ç¨‹ã€‚â€</p><p>â€œæˆ‘å¯¹å¦‚ä½•æ”¹è¿›æ¸¸æˆæå‡ºè¿‡ä¸€äº›å»ºè®®ï¼Œä½†å¤§å¤šæ•°æ—¶å€™æˆ‘å°½é‡ä¸å¹²æ¶‰ã€‚æˆ‘æ„Ÿè§‰è‡ªå·±æœ‰ç‚¹åƒä¸ªå›­ä¸â€”â€”æˆ‘åšäº†ä¸€äº›æµ‡æ°´å’Œé™¤è‰çš„å·¥ä½œï¼Œä½†å¼€èŠ±ç»“æœå…¨é ä»–ä»¬ã€‚æ­£å¦‚è¿™ç¯‡è®ºæ–‡æ‰€ç¤ºï¼Œå›¢é˜Ÿèƒ½å¤Ÿå¾—å‡ºä¸€äº›éå¸¸æœ‰ç”¨çš„ç»“è®ºâ€”â€”å¹¶ä¸”æœ€ç»ˆåšå‡ºäº†ä¸€äº›å¥½æ¸¸æˆï¼å…³äºåˆ›ä½œè¿‡ç¨‹çš„ä¼˜åŒ–è¿˜æœ‰æ›´å¤šä¸œè¥¿éœ€è¦å­¦ä¹ ï¼Œå¡å†…åŸºæ¢…éš†å¤§å­¦å¨±ä¹æŠ€æœ¯ä¸­å¿ƒè®¡åˆ’ç»§ç»­è¿›è¡Œè¿™ä¸ªé¡¹ç›®ã€‚â€</p><p><img src="/images/others/translation/how_to_prototype_seven_day/5.jpg" alt="&quot;æˆ‘ä»¬çš„å›¢é˜Ÿï¼Œæ°¸è¿œçš„å®éªŒæ€§æœ‹å‹ï¼&quot;"></p><h3 id="å¹¶è¡Œå¼€å‘ä»¥æœ€å¤§åŒ–æ•ˆæœ"><a href="#å¹¶è¡Œå¼€å‘ä»¥æœ€å¤§åŒ–æ•ˆæœ" class="headerlink" title="å¹¶è¡Œå¼€å‘ä»¥æœ€å¤§åŒ–æ•ˆæœ"></a>å¹¶è¡Œå¼€å‘ä»¥æœ€å¤§åŒ–æ•ˆæœ</h3><p>é‚£ä¹ˆï¼Œä¸€æ—¦æˆ‘ä»¬ç»„å»ºäº†å›¢é˜Ÿï¼Œæˆ‘ä»¬åšäº†ä»€ä¹ˆï¼Ÿæˆ‘ä»¬å„è‡ªç‹¬ç«‹å·¥ä½œï¼è¿™å¬èµ·æ¥å¯èƒ½å¾ˆå¥‡æ€ªï¼Œä½†ç‹¬ç«‹å·¥ä½œçš„å¥½å¤„å®åœ¨å¤ªå¤§äº†ï¼Œä¸å®¹å¿½è§†ï¼š</p><ul><li>ç¼“è§£é£é™©ï¼šé€šè¿‡åŒæ—¶å¼€å‘å››ä¸ªåŸå‹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åšå‡ºå†’é™©çš„è®¾è®¡å†³ç­–æ—¶æ„Ÿåˆ°å®‰å¿ƒï¼Œå› ä¸ºè‡³å°‘æœ‰ä¸€ä¸¤ä¸ªå¯èƒ½ä¼šæˆåŠŸã€‚</li><li>å‹å¥½ç«äº‰ï¼šæ¯ä¸ªäººéƒ½å› åªä¸“æ³¨äºè‡ªå·±è€Œå—ç›Šã€‚å°±åƒèµ„æœ¬ä¸»ä¹‰ä¸€æ ·ï¼</li><li>æ›´å¹¿æ³›çš„ä¸»é¢˜æ¢ç´¢ï¼šæˆ‘ä»¬å››ä¸ªäººéƒ½ä¸“æ³¨äºåŒä¸€ä¸ªä¸»é¢˜ï¼Œè¿™è¿«ä½¿æˆ‘ä»¬æ·±å…¥æ€è€ƒä¸»é¢˜ã€‚å¦‚æœæˆ‘ä»¬éƒ½åšäº†ä¸€æ ·çš„æ¸¸æˆï¼Œé‚£è¯¥å¤šå°´å°¬å•Šï¼è¿™è¿«ä½¿æˆ‘ä»¬è¿›å…¥ä¸€äº›æœ‰ç›Šçš„åˆ›ä½œé¢†åŸŸï¼Œå¹¶è®©æˆ‘ä»¬é¿å…äº†æ˜¾è€Œæ˜“è§çš„åˆ‡å…¥ç‚¹ã€‚</li><li>åˆ†äº«ä¸å…³æ€€ï¼šè™½ç„¶æˆ‘ä»¬æ²¡æœ‰å…±äº«ä»£ç ï¼ˆå¯ä»¥å…±äº«ä¹Ÿå¯ä»¥ä¸å…±äº«ï¼‰ï¼Œä½†æˆ‘ä»¬å‘ç°åˆ†äº«æ¦‚å¿µå’Œç†è§£å¾ˆæœ‰å¸®åŠ©ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªå›¢é˜Ÿæˆå‘˜å‘ç°äº†ä¸€ç§è¡¨ç¤ºå¼¹ç°§ç³»ç»Ÿçš„æœ‰æ•ˆæ–¹æ³•ï¼Œæ¯ä¸ªäººéƒ½ä¼šå—ç›Šã€‚</li></ul><p>éšç€å‡ å‘¨è¿‡å»ï¼Œæˆ‘ä»¬å‘ç°å›¢é˜Ÿåˆä½œåœ¨æ¯ä¸ªå‘¨æœŸçš„å¼€å§‹å’Œç»“æŸæ—¶æœ€æœ‰ä»·å€¼ã€‚åœ¨æ¯ä¸ªå‘¨æœŸå¼€å§‹æ—¶ï¼Œå›¢é˜Ÿåˆä½œæœ‰åŠ©äºæç‚¼å’Œæ¯”è¾ƒæƒ³æ³•ã€‚ä¸€æ—¦è¿›å…¥å¼€å‘é˜¶æ®µï¼Œæˆ‘ä»¬å‘ç°åˆä½œæ›´å¤šæ˜¯ä¸€ç§å¹²æ‰°â€”â€”å› ä¸ºæ¯ä¸ªäººéƒ½å®Œå…¨æ²‰æµ¸åœ¨è‡ªå·±çš„å·¥ä½œä¸­ã€‚åˆ°æ¯ä¸ªå‘¨æœŸç»“æŸæ—¶ï¼Œæˆ‘ä»¬ä¼šå›åˆ°æˆ¿é—´é‡Œä¸€èµ·å·¥ä½œåˆ°å‡Œæ™¨ï¼Œä½“éªŒç«èµ›å¿«ç»“æŸçš„æ„Ÿè§‰ã€‚è¿™ç§åˆä½œä»·å€¼éšæ—¶é—´å˜åŒ–çš„å›¾è¡¨å¯èƒ½åƒè¿™æ ·ï¼š</p><p><img src="/images/others/translation/how_to_prototype_seven_day/6_time_to_value.jpg" alt="&quot;åˆä½œä»·å€¼&quot;éš&quot;æ—¶é—´&quot;çš„å˜åŒ–ã€‚"></p><h2 id="è®¾è®¡ï¼šå¤´è„‘é£æš´çš„ç¥è¯å’Œåˆ›é€ åŠ›"><a href="#è®¾è®¡ï¼šå¤´è„‘é£æš´çš„ç¥è¯å’Œåˆ›é€ åŠ›" class="headerlink" title="è®¾è®¡ï¼šå¤´è„‘é£æš´çš„ç¥è¯å’Œåˆ›é€ åŠ›"></a>è®¾è®¡ï¼šå¤´è„‘é£æš´çš„ç¥è¯å’Œåˆ›é€ åŠ›</h2><p>ä¸€ä¸ªå¥½ç‚¹å­å¯èƒ½åœ¨ç¬é—´äº§ç”Ÿï¼Œä½†ç­‰å¾…ç‚¹å­å¯èƒ½æ˜¯ä¸€ç§ç…ç†¬ã€‚æ²¡æœ‰åŠæ³•å¼ºè¿«ä¸€ä¸ªå¥½ç‚¹å­è¿¸å‘å‡ºæ¥ï¼Œä½†è¿™ä¸€éƒ¨åˆ†å†…å®¹åº”è¯¥èƒ½å¸®åŠ©ä½ åŸ¹å…»ä½ çš„åˆ›é€ åŠ›ã€‚</p><h3 id="æ­£å¼å¤´è„‘é£æš´çš„æˆåŠŸç‡ä¸º-0"><a href="#æ­£å¼å¤´è„‘é£æš´çš„æˆåŠŸç‡ä¸º-0" class="headerlink" title="æ­£å¼å¤´è„‘é£æš´çš„æˆåŠŸç‡ä¸º 0%"></a>æ­£å¼å¤´è„‘é£æš´çš„æˆåŠŸç‡ä¸º 0%</h3><p>æˆ‘ä»¬çœŸçš„å¾ˆåŠªåŠ›äº†â€”â€”å¤©å‘ï¼Œæˆ‘ä»¬çœŸçš„å¸Œæœ›å¤´è„‘é£æš´èƒ½å¥æ•ˆï¼æˆ‘ä»¬å®‰æ’äº†â€œå¤´è„‘é£æš´ä¼šè®®â€å’Œâ€œåœ†æ¡Œä¼šè®®â€ï¼Œæˆ‘ä»¬ç”¨ä¸åŒé¢œè‰²çš„è®°å·ç¬”åœ¨ç™½æ¿å’Œè¶…å¤§ä¾¿åˆ©è´´ä¸Šå†™ç”»ï¼Œæˆ‘ä»¬ç”šè‡³ç”¨äº†åƒâ€œè“å¤©â€è¿™æ ·çš„æ¿€åŠ±æ€§çŸ­è¯­æ¥å¸®åŠ©æˆ‘ä»¬æ‘†è„±æ€ç»´å®šåŠ¿ã€‚ä½†æœ€ç»ˆï¼Œåœ¨æˆ‘ä»¬åˆ›é€ çš„æ‰€æœ‰æ¸¸æˆä¸­ï¼Œæ²¡æœ‰ä¸€ä¸ªæ˜¯é€šè¿‡å¤§å®¶ååœ¨ä¸€èµ·è¿›è¡Œå¤´è„‘é£æš´ä¼šè®®å¾—å‡ºçš„ç»“æœã€‚</p><p>ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿæˆ‘ä»¬ä¹Ÿéå¸¸éœ‡æƒŠã€‚ä½†ç»è¿‡ä¸€ç•ªè°ƒæŸ¥ï¼Œæˆ‘ä»¬å‘ç°åˆ›é€ åŠ›ç¡®å®æ˜¯æ— æ³•è§„åˆ’çš„ã€‚ä½ ä¸èƒ½è¯´ï¼šâ€œå¤§å®¶4:15å¼€ä¸ªä¼šå¤´è„‘é£æš´ä¸€ä¸‹ï¼Œåˆ°5:00æˆ‘ä»¬å°±èƒ½æ‹¿å‡ºå››ä¸ªè¶…æ£’çš„æ¸¸æˆç‚¹å­ï¼â€</p><p>ä½†å¤´è„‘é£æš´å¹¶éæ— ç”¨ã€‚é€šè¿‡ç²¾å¿ƒç»„ç»‡å¤´è„‘é£æš´ä¼šè®®ï¼Œæˆ‘ä»¬ä»ç„¶å¯ä»¥æœŸå¾…ï¼ˆè‡³å°‘ï¼‰ä¸¤ä»¶åˆç†çš„äº‹æƒ…ã€‚ç¬¬ä¸€ï¼Œå½“ç„¶æ˜¯è®©æ‰€æœ‰äººéƒ½å¼€å§‹æ€è€ƒã€‚åœ¨å¼€å§‹æ€è€ƒåï¼Œè¿‡äº†ä¸€ä¼šå„¿ï¼Œæˆ–è®¸åœ¨å›å®¶çš„è·¯ä¸Šï¼Œæˆ–è®¸åœ¨æ´—æ¾¡æ—¶ï¼Œåˆæˆ–è®¸åœ¨é›ç‹—æ—¶ï¼Œä¸€ä¸ªç»å¦™çš„ç‚¹å­ä¼šåœ¨ä½ çš„è„‘æµ·ä¸­è¿¸å‘å‡ºæ¥ã€‚å½“ç„¶ï¼Œä¹Ÿæˆ–è®¸ä¸ä¼šã€‚ä½†æ®æˆ‘ä»¬æ‰€çŸ¥ï¼Œç¥ç§˜çš„å¤§è„‘åœ¨æˆ‘ä»¬æœ€ä¸ç»æ„é—´åšäº†å¤§é‡çš„æ€è€ƒã€‚</p><p>ç¬¬äºŒï¼Œå½“æœ‰å…·ä½“çš„ä¸œè¥¿å¯ä»¥è®¨è®ºæ—¶ï¼Œå¤´è„‘é£æš´å°±æœ‰ç”¨äº†ã€‚æ¯”å¦‚ï¼Œâ€œæˆ‘ä»¬å¦‚ä½•æ”¹è¿›è¿™ä¸ªï¼Ÿâ€æ¯”â€œè®©æˆ‘ä»¬éšä¾¿æƒ³ç‚¹ä»€ä¹ˆï¼â€æ›´å¥½ã€‚åˆå¦‚ï¼Œç»™å‡ºä¸€ä¸ªåŠæˆå½¢çš„ç‚¹å­å¹¶è®©å…¶ä»–äººæ¥å……å®å®ƒæ˜¯ç›¸å½“æœ‰ç”¨çš„ã€‚æ¯”èµ·åˆ›ä½œè€…ï¼Œäººä»¬æ›´é€‚åˆå½“è¯„è®ºå®¶ï¼Œä¸æ˜¯å—ï¼Ÿ</p><h3 id="æ”¶é›†æ¦‚å¿µè‰ºæœ¯å’ŒéŸ³ä¹ä»¥åˆ›é€ æƒ…ç»ªç›®æ ‡"><a href="#æ”¶é›†æ¦‚å¿µè‰ºæœ¯å’ŒéŸ³ä¹ä»¥åˆ›é€ æƒ…ç»ªç›®æ ‡" class="headerlink" title="æ”¶é›†æ¦‚å¿µè‰ºæœ¯å’ŒéŸ³ä¹ä»¥åˆ›é€ æƒ…ç»ªç›®æ ‡"></a>æ”¶é›†æ¦‚å¿µè‰ºæœ¯å’ŒéŸ³ä¹ä»¥åˆ›é€ æƒ…ç»ªç›®æ ‡</h3><p>ä½œä¸ºå¤´è„‘é£æš´çš„æ›¿ä»£å“ï¼Œæˆ‘ä»¬å‘ç°æ”¶é›†ä¸€äº›å…·æœ‰ä¸ªäººæ„ä¹‰çš„è‰ºæœ¯å’ŒéŸ³ä¹ç‰¹åˆ«æœ‰ç”¨ã€‚äººä»¬è¯„è®ºè¯´ï¼Œè®¸å¤šæ¸¸æˆå¦‚â€œGravity Headâ€å’Œâ€œOn a Rainy Dayâ€åˆ›é€ äº†å¼•äººå…¥èƒœçš„æ°›å›´å¹¶å…·æœ‰å¼ºçƒˆçš„æƒ…æ„Ÿå¸å¼•åŠ›ã€‚è¿™ä¸æ˜¯å¶ç„¶çš„ã€‚åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œé…ä¹å’ŒåˆæœŸç¾æœ¯å…±åŒåˆ›é€ äº†ä¸€ç§æ„Ÿå—ï¼Œæ¨åŠ¨äº†ç©æ³•ã€æ•…äº‹å’Œæœ€ç»ˆç¾æœ¯çš„è®¾å®šã€‚</p><p>Mr. Gablerï¼šâ€œã€Šé»é»ä¸–ç•Œã€‹çš„æƒ³æ³•æ˜¯æˆ‘åœ¨å›å®¶è·¯ä¸Šå¬ Astor Piazzolla çš„ã€ŠTango Apasionadoã€‹å¼€å¤´æ—¶äº§ç”Ÿçš„ï¼Œæˆ‘è„‘æµ·ä¸­æµ®ç°å‡ºä¸€ä¸ªæ—¥è½æ—¶åˆ†å°é•‡çš„æœ¦èƒ§æ™¯è±¡ï¼Œæ¯ä¸ªäººéƒ½ç¦»å¼€å®¶ï¼Œæ¬å‡ºæ¤…å­ã€æ¡Œå­å’Œä»»ä½•ä»–ä»¬èƒ½æ‰¾åˆ°çš„ä¸œè¥¿ï¼Œåœ¨å¸‚ä¸­å¿ƒå»ºé€ ä¸€åº§å·¨å¡”ã€‚æˆ‘ä¸çŸ¥é“ç¡®åˆ‡åŸå› ï¼Œä½†ä»–ä»¬æƒ³å¾€ä¸Šçˆ¬ï¼Œå†å¾€ä¸Šçˆ¬â€”â€”ä½†ä»–ä»¬ä¸æ˜¯å¾ˆå¥½çš„åœŸæœ¨å·¥ç¨‹å¸ˆï¼Œæ‰€ä»¥ä½ éœ€è¦å¸®åŠ©ä»–ä»¬ã€‚æœ€ç»ˆçš„åŸå‹å˜å¾—æ›´æ¬¢å¿«ä¸€äº›ï¼Œæˆ‘æŠŠéŸ³ä¹æ¢æˆäº† Piazzolla çš„æ›´æ¬¢å¿«çš„ã€ŠLibertangoã€‹ã€‚è¿™æ˜¯ä¸€ä¸ªåˆå§‹æƒ…ç»ªç›®æ ‡é€ å°±äº†æ•´ä¸ªæ¸¸æˆçš„ä¾‹å­ã€‚â€</p><p><img src="/images/others/translation/how_to_prototype_seven_day/7_goo_prototype.jpg" alt="æ¢æˆˆéŸ³ä¹å’Œçˆ¬å¾—è¶Šæ¥è¶Šé«˜çš„å°äººâ€¦â€¦"></p><h3 id="åœ¨è„‘ä¸­æ¨¡æ‹Ÿâ€”â€”åšåŸå‹çš„åŸå‹"><a href="#åœ¨è„‘ä¸­æ¨¡æ‹Ÿâ€”â€”åšåŸå‹çš„åŸå‹" class="headerlink" title="åœ¨è„‘ä¸­æ¨¡æ‹Ÿâ€”â€”åšåŸå‹çš„åŸå‹"></a>åœ¨è„‘ä¸­æ¨¡æ‹Ÿâ€”â€”åšåŸå‹çš„åŸå‹</h3><p>è¿™çœŸçš„å¾ˆç®€å•ï¼ä½ è¦åšçš„å°±æ˜¯æƒ³è±¡ä½ çš„æ¸¸æˆç©å®¶è¯´ï¼šâ€œå“‡ï¼â€ç„¶åå€’æ¨å¹¶å¡«è¡¥ç©ºç™½ã€‚æ˜¯ä»€ä¹ˆè®©ä»–ä»¬äº«å—ä½ çš„æ¸¸æˆï¼Ÿä»–ä»¬æ„Ÿå—åˆ°äº†ä»€ä¹ˆï¼Ÿæ¸¸æˆä¸­æ˜¯ä»€ä¹ˆè®©ä»–ä»¬æœ‰äº†è¿™ç§ä½“éªŒï¼Ÿ</p><p>å¯¹æˆ‘ä»¬çš„é‚£äº›æœ€æˆåŠŸçš„æ¸¸æˆæ¥è¯´ï¼Œæˆ‘ä»¬å¹¶ä¸å¯¹å®ƒä»¬å˜å¾—å¥½ç©æ„Ÿåˆ°æ„å¤–â€”â€”åœ¨æœ€å¥½çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åœ¨æ¥è§¦ä»»ä½•ä¸€è¡Œä»£ç ä¹‹å‰å°±çŸ¥é“è¿™ä¸ªæƒ³æ³•æ˜¯é è°±çš„ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»åœ¨æ€ç»´é‡Œæ¨¡æ‹Ÿè¿‡äº†æ¸¸æˆã€‚åä¹‹äº¦ç„¶ï¼Œæ²¡æœ‰ä¸€ä¸ªæ¸¸æˆæ˜¯å‡ºä¹æ„æ–™åœ°æˆåŠŸçš„ï¼Œæˆ‘ä»¬æ€»æ˜¯å…ˆçŸ¥å…ˆè§‰ã€‚ï¼ˆå¯æƒœçš„æ˜¯ï¼Œè¿™å¹¶æ²¡æœ‰é˜»æ­¢æˆ‘ä»¬å»è¿½æ±‚é‚£äº›åŠç”Ÿä¸ç†Ÿçš„æƒ³æ³•ã€‚ï¼‰</p><p>åœ¨ä½ çš„è„‘æµ·ä¸­æ¨¡æ‹Ÿä¹Ÿä½¿å¾—æœ€ç»ˆåŸå‹çš„å¼€å‘å˜å¾—éå¸¸å®¹æ˜“ï¼Œå› ä¸ºä½ ä¼šç¡®åˆ‡åœ°çŸ¥é“ä½ å°†è¦åšä»€ä¹ˆã€‚ä½ ä¸ä¼šä¸ºäº†åœ¨è®¾è®¡ä¸Šâ€œè¯•é”™â€æµªè´¹æ—¶é—´ä¿®æ”¹ä»£ç ã€‚</p><p>ä¸€ä½å›¢é˜Ÿæˆå‘˜æ‰¿è®¤ï¼šâ€æˆ‘ç»å¸¸åœ¨ä¸€å‘¨çš„å‰3ã€4å¤©é‡Œï¼Œåªæ˜¯ä¸ºäº†â€™çµæ„Ÿâ€™è€Œé—²é€›çœ‹ O-Zone éŸ³ä¹è§†é¢‘ã€å€’æŒ‚åœ¨æ‡’äººæ²™å‘ä¸Šå¬éŸ³ä¹ã€å¶å°”è¿è¡Œä¸€äº›ç³Ÿç³•çš„å¤§è„‘æ¨¡æ‹Ÿã€‚æœ€åå‘¨å››æˆ–å‘¨äº”æ¥ä¸´æ—¶ï¼Œæˆ‘ä¼šæ„Ÿåˆ°ææ…Œï¼Œå› ä¸ºæˆ‘ä»ç„¶ä¸çŸ¥é“å‘¨ä¸€è¦äº¤ä»€ä¹ˆï¼Œæ‰€ä»¥æˆ‘å°±ä¼šé‡‡çº³æœ€å¼ºçš„é‚£ä¸ªæƒ³æ³•ï¼Œå¹¶æ ¹æ®æœ¬å‘¨è‡ªå·±å–œæ¬¢ä¸Šçš„ä¸œè¥¿è¿›è¡Œè°ƒæ•´ï¼Œç›´åˆ°æ„Ÿè§‰åƒä¸€ä¸ªæœ‰è¶£çš„æ¸¸æˆï¼Œç„¶åæ¥ä¸‹æ¥å‡ å¤©ç†¬å¤œå†™ä»£ç å’Œç”»ç”»ã€‚å¯¹æˆ‘æ¥è¯´ï¼ˆæˆ‘æƒ³å¯¹æˆ‘ä»¬æ‰€æœ‰äººæ¥è¯´ï¼‰ï¼ŒèŠ±åœ¨â€™å‰æœŸåˆ¶ä½œâ€™ä¸Šçš„æ—¥å­æ— ç–‘æ¯”èŠ±åœ¨å®é™…å¼€å‘ä¸Šçš„æ—¥å­æ›´æœ‰ä»·å€¼ã€‚â€</p><p><img src="/images/others/translation/how_to_prototype_seven_day/8_rainy_day.jpg" alt="&quot;On a Rainy Day&quot;çš„æ—©æœŸçº¸ä¸ŠåŸå‹â€”â€”åœ¨è„‘ä¸­æ¨¡æ‹Ÿæ—¶å¾ˆæœ‰å¸®åŠ©ã€‚"></p><h2 id="å¼€å‘ï¼šæ²¡äººçŸ¥é“ä½ æ˜¯æ€ä¹ˆåšçš„ï¼Œä¹Ÿæ²¡äººåœ¨ä¹"><a href="#å¼€å‘ï¼šæ²¡äººçŸ¥é“ä½ æ˜¯æ€ä¹ˆåšçš„ï¼Œä¹Ÿæ²¡äººåœ¨ä¹" class="headerlink" title="å¼€å‘ï¼šæ²¡äººçŸ¥é“ä½ æ˜¯æ€ä¹ˆåšçš„ï¼Œä¹Ÿæ²¡äººåœ¨ä¹"></a>å¼€å‘ï¼šæ²¡äººçŸ¥é“ä½ æ˜¯æ€ä¹ˆåšçš„ï¼Œä¹Ÿæ²¡äººåœ¨ä¹</h2><p>ä¸€æ—¦ä½ æœ‰äº†ä¸€ä¸ªå¥½ç‚¹å­ï¼Œè¿™é‡Œæœ‰ä¸€äº›æŠ€å·§å¯ä»¥è®©ä½ è¿…é€Ÿåšå‡ºä¸€ä¸ª demoï¼</p><h3 id="å…ˆåšç©å…·"><a href="#å…ˆåšç©å…·" class="headerlink" title="å…ˆåšç©å…·"></a>å…ˆåšç©å…·</h3><p>ä»æ ¸å¿ƒæœºåˆ¶å¼€å§‹ã€‚æ— è®ºæ˜¯å¼¹ç°§ç³»ç»Ÿã€ç¾¤ä½“è¡Œä¸ºã€é‡åŠ›ç­‰ç­‰ï¼ŒèŠ±ä¸äº†å‡ ä¸ªå°æ—¶å°±èƒ½æŠŠæ¸¸æˆä¸»é¢˜åšå‡ºæ¥ã€‚è¿™ä¸ªâ€œç©å…·â€åº”è¯¥æ˜¯æ¸¸æˆçš„æ ¸å¿ƒæœºåˆ¶ã€‚å®ƒä¸éœ€è¦ä»»ä½•ç›®æ ‡æˆ–å†³ç­–ï¼Œæ²¡æœ‰è¾“èµ¢ï¼Œåªæ˜¯ä¸€ä¸ªå¥½ç©çš„ä¸œè¥¿ã€‚</p><p>Mr. Gablerï¼šâ€œå¯¹ã€ŠSuper Tummy Bubbleã€‹æ¥è¯´ï¼Œâ€˜ç©å…·â€™åªæ˜¯ä¸€å †æ‚¬æµ®åœ¨å°å®¹å™¨é‡Œçš„æ³¡æ³¡ã€‚æˆ‘ç©äº†ä¸€ä¼šå„¿è¿™ä¸ªç©å…·ï¼ŒæŠŠæ³¡æ³¡æ‰”æ¥æ‰”å»ï¼Œç„¶åè°ƒæ•´äº†ä¸€ä¸‹ç›´åˆ°æˆ‘æ„Ÿè§‰æ‰‹æŒ‡æˆ³è¿›æ³¡æ³¡é‡Œå¾ˆæœ‰è¶£ã€‚ä¹‹åï¼Œæ˜¯æ—¶å€™åŠ å…¥ä¸€äº›æ¸¸æˆæ€§äº†ã€‚åœ¨è¿™ä¸ªæ¸¸æˆé‡Œï¼Œæ¸¸æˆæ€§åŒ…æ‹¬å¯„ç”Ÿç€ä¸åŒè™«å­çš„æ³¡æ³¡ã€â€˜æˆ³ç ´â€™çš„æ¦‚å¿µã€â€˜è¿é”â€™çš„æ¦‚å¿µã€åˆ†æ•°è®¡æ•°å™¨ç­‰ã€‚â€</p><p><img src="/images/others/translation/how_to_prototype_seven_day/9_left_and_right.jpg" alt="&quot;Super Tummy Bubble&quot;â€”â€”ç©å…·ï¼ˆå·¦ï¼‰vs. æœ€ç»ˆåŸå‹ï¼ˆå³ï¼‰ã€‚"></p><h3 id="å¦‚æœèƒ½å·æ‡’ï¼Œé‚£å°±å·æ‡’"><a href="#å¦‚æœèƒ½å·æ‡’ï¼Œé‚£å°±å·æ‡’" class="headerlink" title="å¦‚æœèƒ½å·æ‡’ï¼Œé‚£å°±å·æ‡’"></a>å¦‚æœèƒ½å·æ‡’ï¼Œé‚£å°±å·æ‡’</h3><p>è¿™å¯ä»¥è¯´æ˜¯è¿™ä¸ªé¡¹ç›®æœ€é‡è¦çš„æ•™è®­ä¹‹ä¸€ã€‚é€šå¸¸â€œæ­£ç¡®â€çš„è§£å†³æ–¹æ¡ˆå¹¶éæœ€ä½³è§£å†³æ–¹æ¡ˆã€‚æœ‰ç­–ç•¥åœ°å·æ‡’ä¼šä¸ºä½ èŠ‚çœæ—¶é—´å’Œé‡‘é’±ï¼›å®ƒä¼šè®©ä½ çš„æ¸¸æˆæ›´å¿«ï¼Œä½ çš„ç‰™é½¿æ›´ç™½ã€‚å¤§èƒ†åœ°ã€ç»å¸¸åœ°å·æ‡’ï¼å¦‚æœä¸€ä¸ªç®€å•çš„é˜´å½±å’Œçƒ˜ç„™çº¹ç†åŒæ ·æœ‰æ•ˆï¼Œå°±ä¸è¦è®¾ç½®å¤æ‚çš„å…‰ç…§å’Œé˜´å½±ï¼ˆã€ŠDarwin Hillã€‹ï¼‰ã€‚å¦‚æœä½ å¯ä»¥ç”¨åŒæ ·çš„æ•ˆæœè’™æ··è¿‡å…³ï¼Œå°±ä¸è¦ä¸ºäº†åˆ†æç”¨æˆ·çš„ç»˜ç”»è€Œè®¾ç½®å¤æ‚çš„æ¨¡å¼è¯†åˆ«ç³»ç»Ÿï¼ˆã€ŠSuburban Brawlã€‹ï¼‰ã€‚å½“å¿«é€Ÿæ‹‰ä¼¸çš„ä½å›¾èƒ½æ›´å¿«æ›´å®¹æ˜“åœ°è¾¾åˆ°åŒæ ·æ•ˆæœæ—¶ï¼Œå°±ä¸è¦ç»˜åˆ¶æ ·æ¡æ›²çº¿æˆ–åˆ›å»ºè‡ªå·±çš„çŸ¢é‡è‰ºæœ¯åº“ï¼ˆã€Šé»é»ä¸–ç•Œã€‹ï¼‰ã€‚æˆ‘ä»¬å‘ç°ï¼Œè¿™æ¡è§„åˆ™ä¹Ÿæ˜¯ç”Ÿæ´»ä¸­ä¸€æ¡æå¥½çš„é€šç”¨æ³•åˆ™ã€‚æ‡’äººä»¬ï¼Œæ³¨æ„äº†ã€‚</p><p><img src="/images/others/translation/how_to_prototype_seven_day/10_left_mid_right.jpg" alt="&quot;Darwin Hill&quot;ã€&quot;Suburban Brawl&quot;ã€&quot;é»é»ä¸–ç•Œ&quot;â€”â€”éƒ½æ˜¯å‡çš„ï¼Œè€Œä¸”æ²¡äººæ³¨æ„åˆ°ã€‚å˜˜ï¼"></p><h3 id="åŠæ—¶æ­¢æŸï¼Œå‰²èˆå¿ƒå¤´ä¹‹çˆ±"><a href="#åŠæ—¶æ­¢æŸï¼Œå‰²èˆå¿ƒå¤´ä¹‹çˆ±" class="headerlink" title="åŠæ—¶æ­¢æŸï¼Œå‰²èˆå¿ƒå¤´ä¹‹çˆ±"></a>åŠæ—¶æ­¢æŸï¼Œå‰²èˆå¿ƒå¤´ä¹‹çˆ±</h3><p>åœ¨é¡¹ç›®å¼€å§‹æ—¶ï¼Œæˆ‘ä»¬æœ‰ä¸€ç§æƒ³è¦æŒ½æ•‘ä¸€åˆ‡çš„æ„¿æœ›â€”â€”å†å¤šèŠ±ä¸€ç‚¹æ—¶é—´å’Œç²¾åŠ›ï¼Œä¸€ä¸ªç³Ÿç³•çš„æ¸¸æˆè‚¯å®šä¼šå˜æˆå¤©æ‰ä¹‹ä½œï¼æˆ‘ä»¬æœ‰ä¸€ä¸ªè¿™æ ·çš„æ³¨å®šå¤±è´¥çš„åŸå‹â€”â€”å®ƒå§‹äºä¸€ä¸ªç¾ä¸½çš„å¼¹ç°§ç³»ç»Ÿã€‚å®ƒèƒ½æŒ¤å‹å’Œæ‹‰ä¼¸ï¼Œè®©ä½ æƒ³æŠ“ä½å®ƒå¹¶åˆ°å¤„æ‹‰æ‰¯ï¼Œä½†å®ƒå°±æ˜¯æ²¡æœ‰å˜æˆä¸€ä¸ªå¼•äººå…¥èƒœçš„æ¸¸æˆã€‚æœ€åˆçš„å¼¹ç°§ç³»ç»Ÿæœºåˆ¶åªèŠ±å‡ ä¸ªå°æ—¶å°±åˆ›å»ºå¥½äº†ï¼Œä½†éšåå®ƒå´è€—è´¹äº†æ•´æ•´ä¸€å‘¨çš„ç¼–ç å’Œé‡æ„æ—¶é—´ã€‚è¿™æ˜¯ä¸€æ¬¡å¯æ‚²çš„å°è¯•ï¼Œè¯•å›¾å¼ºè¡Œå°†è¿™ä¸ªæœºåˆ¶å˜æˆä¸€ä¸ªæ¸¸æˆã€‚</p><p>å¿«é€Ÿè¯†åˆ«èµ°ä¸é€šçš„æƒ³æ³•ã€åŠæ—¶æ­¢æŸå¹¶ç»§ç»­å‰è¿›éå¸¸é‡è¦ã€‚æˆ‘ä»¬å‘ç°ï¼Œé¡ºå…¶è‡ªç„¶æ¯”èŠ±æ—¶é—´è¯•å›¾æŒ½æ•‘ç°æœ‰çš„ä¸œè¥¿æ›´æœ‰ä»·å€¼ã€‚å¦‚æœä»¥åçµå…‰ä¸€é—ªï¼Œä½ æ€»å¯ä»¥å†å›æ¥ã€‚</p><p>Mr. Kucicï¼šâ€œæˆ‘çš„â€˜åœŸè±†â€™æœ€ç»ˆæˆä¸ºäº†ä¸€ä¸ªåœ¨ Flash ä¸­æ„å»ºçš„å®Œç¾çš„è½¯ä½“æ¨¡æ‹Ÿç³»ç»Ÿï¼Œå”¯ä¸€çš„é—®é¢˜æ˜¯å®ƒä¸€ç‚¹ä¹Ÿä¸å¥½ç©ã€‚å®ƒç»™æˆ‘å¸¦æ¥çš„å¤´ç—›æ¯”æ­»äº¡é‡‘å±è¿˜å¤šã€‚æˆ‘æµªè´¹äº†ä¸€å‘¨æ—¶é—´ï¼Œè€Œå®ƒç”šè‡³éƒ½ä¸èƒ½åŠ¨ã€‚ä½ å¾—çŸ¥é“ä»€ä¹ˆæ—¶å€™è¯¥ç»§ç»­ï¼Œä»€ä¹ˆæ—¶å€™è¯¥æ”¾å¼ƒã€‚â€</p><p><img src="/images/others/translation/how_to_prototype_seven_day/11_circle.png" alt="&quot;é©¬ç‰¹çš„åœŸè±†&quot;â€”â€”æ²æµ´åœ¨å®ƒçš„è£è€€ä¸­ã€‚"></p><h3 id="æ¼‚äº®çš„åŒ…è£…æ— æ³•æŒ½æ•‘ç³Ÿç³•çš„è®¾è®¡ï¼ˆæˆ–è€…è¯´ï¼Œâ€œçƒ‚æ³¥æ‰¶ä¸ä¸Šå¢™â€ï¼‰"><a href="#æ¼‚äº®çš„åŒ…è£…æ— æ³•æŒ½æ•‘ç³Ÿç³•çš„è®¾è®¡ï¼ˆæˆ–è€…è¯´ï¼Œâ€œçƒ‚æ³¥æ‰¶ä¸ä¸Šå¢™â€ï¼‰" class="headerlink" title="æ¼‚äº®çš„åŒ…è£…æ— æ³•æŒ½æ•‘ç³Ÿç³•çš„è®¾è®¡ï¼ˆæˆ–è€…è¯´ï¼Œâ€œçƒ‚æ³¥æ‰¶ä¸ä¸Šå¢™â€ï¼‰"></a>æ¼‚äº®çš„åŒ…è£…æ— æ³•æŒ½æ•‘ç³Ÿç³•çš„è®¾è®¡ï¼ˆæˆ–è€…è¯´ï¼Œâ€œçƒ‚æ³¥æ‰¶ä¸ä¸Šå¢™â€ï¼‰</h3><p>æˆ‘ä»¬å‘ç°æ¸¸æˆç©å®¶æ¯”ä½ æƒ³è±¡çš„è¦èªæ˜ï¼Œä»–ä»¬èƒ½çœ‹ç©¿ä½ æ˜¯å¦åœ¨è€èŠ±æ‹›ã€‚å¦‚æœæ¸¸æˆç©æ³•å¾ˆç³Ÿç³•ï¼Œé‚£å°±æ²¡æ•‘äº†â€”â€”ä¸–ç•Œä¸Šæ‰€æœ‰çš„ç¾æœ¯ã€éŸ³ä¹å’Œè”åŠ¨éƒ½æ— æ³•è®©å®ƒæˆä¸ºä¸€ä¸ªå¥½æ¸¸æˆã€‚è¿™å°±åƒæ˜¯ç»™ä¸€ä¸ªæ— è¶£çš„æ¸¸æˆæœºåˆ¶åŠ å…¥æœ€æ–°çš„3DåŠ¨ç”»ç”µå½±è§’è‰²ï¼Œæ²¡äººä¼šè¢«ç³Šå¼„ã€‚</p><p>Mr. Grayï¼šâ€œã€ŠSpin to Winã€‹çš„â€˜æ¸¸æˆç©æ³•â€™æ˜¯æ—‹è½¬ä½ çš„é¼ æ ‡æ¥è½¬åŠ¨å¤šä¸ªåœ†åœˆã€‚ä¸ºäº†æ©ç›–å®ƒä¸å¥½ç©çš„äº‹å®ï¼Œæˆ‘ç”¨60å¹´ä»£ã€ŠBewitchedã€‹é£æ ¼çš„è‰ºæœ¯å’ŒéŸ³ä¹ç»™æ¸¸æˆåšäº†æ¼‚äº®çš„åŒ…è£…ã€‚ä½†æ— è®ºæˆ‘æ€ä¹ˆæ‰“ç£¨è¿™ä¸ªæ¸¸æˆï¼Œå®ƒéƒ½æœ‰è¶£ä¸èµ·æ¥ã€‚å°½ç®¡æˆ‘ä»˜å‡ºäº†æ‰€æœ‰çš„çˆ±ï¼Œå®ƒè¿˜æ˜¯å¾ˆå¿«å°±æˆäº†ç½‘ç«™ä¸Šæœ€è¢«è®¨åŒçš„æ¸¸æˆä¹‹ä¸€ã€‚â€</p><p><img src="/images/others/translation/how_to_prototype_seven_day/12_spin_to_win.jpg" alt="&quot;Spin to Win&quot;â€”â€”ç››è£…æ‰“æ‰®å´æ— å¤„å¯å»ã€‚"></p><h3 id="ä½†æ•´ä½“ç¾å­¦å¾ˆé‡è¦ï¼åˆç†è¿ç”¨ç¾æœ¯ã€éŸ³æ•ˆå’ŒéŸ³ä¹"><a href="#ä½†æ•´ä½“ç¾å­¦å¾ˆé‡è¦ï¼åˆç†è¿ç”¨ç¾æœ¯ã€éŸ³æ•ˆå’ŒéŸ³ä¹" class="headerlink" title="ä½†æ•´ä½“ç¾å­¦å¾ˆé‡è¦ï¼åˆç†è¿ç”¨ç¾æœ¯ã€éŸ³æ•ˆå’ŒéŸ³ä¹"></a>ä½†æ•´ä½“ç¾å­¦å¾ˆé‡è¦ï¼åˆç†è¿ç”¨ç¾æœ¯ã€éŸ³æ•ˆå’ŒéŸ³ä¹</h3><p>è¿™å®é™…ä¸Šä¸æˆ‘ä»¬æœ€åˆçš„ä¸€ä¸ªå‡è®¾ç›¸åã€‚æˆ‘ä»¬å½“æ—¶è®¤ä¸ºç¾æœ¯å’ŒéŸ³æ•ˆæ ¹æœ¬ä¸ä¼šå¯¹åŸå‹æœ‰å½±å“ï¼Œä½†æˆ‘ä»¬é”™äº†ï¼ç©ä¸€ä¸ªç²¾å¿ƒæ‰“ç£¨çš„æ¸¸æˆå®é™…ä¸Šæ¯”ç©æœ‰ç€å®Œå…¨ç›¸åŒçš„ä»£ç ï¼Œä½†è‰ºæœ¯ç²—ç³™ã€éŸ³æ•ˆå·®çš„æ¸¸æˆæ„Ÿè§‰æ›´å¥½ã€‚ä¸è¿‡ï¼Œé‡è¦çš„æ˜¯è¦åšå‡ºä»¥ä¸‹åŒºåˆ†â€”â€”å•çº¯æ‰“ç£¨ç¾å­¦æ— æ³•æŒ½æ•‘ç³Ÿç³•çš„è®¾è®¡ï¼Œä½†å®ƒç¡®å®æœ‰èƒ½åŠ›è®©ä¸€ä¸ªå¥½æ¸¸æˆå˜å¾—æ›´å¥½ç©ã€‚è¿™å¹¶ä¸æ„å‘³ç€ä½ éœ€è¦æå…¶ç²¾ç¾çš„å›¾å½¢æˆ–ç¯ç»•å£°ã€‚è¿™åªæ˜¯è¯´ä½ å¯ä»¥é€šè¿‡å°†æ‰€æœ‰ä¸œè¥¿ç´§å¯†ç»“åˆèµ·æ¥è€Œå—ç›Šã€‚è®°ä½ï¼Œå³ä½¿æ˜¯â€œè¹©è„šâ€ä¹Ÿå¯ä»¥æ˜¯ä¸€ç§ç´§å¯†ç»“åˆçš„ç¾å­¦ï¼Œåªè¦ä½ ä»¥æ­£ç¡®çš„æ–¹å¼å‘ˆç°å®ƒã€‚</p><p><img src="/images/others/translation/how_to_prototype_seven_day/13_unrealeased_tree.jpg" alt="ä¸€ä¸ªæœªå‘å¸ƒçš„åŸå‹â€”â€”ä¸å¤æ‚çš„ç¾æœ¯ä¹Ÿèƒ½åœ¨æ„å›¾ä¸Šæ„Ÿè§‰åšå®ã€‚"></p><h3 id="æ²¡äººå…³å¿ƒä½ çš„ä»£ç è´¨é‡"><a href="#æ²¡äººå…³å¿ƒä½ çš„ä»£ç è´¨é‡" class="headerlink" title="æ²¡äººå…³å¿ƒä½ çš„ä»£ç è´¨é‡"></a>æ²¡äººå…³å¿ƒä½ çš„ä»£ç è´¨é‡</h3><p>å†æ¬¡å¼ºè°ƒï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œä¸€ä¸ªä¼Ÿå¤§çš„å·¥ç¨‹å¸ˆä¸ä¸€å®šèƒ½æˆä¸ºä¸€ä¸ªä¼Ÿå¤§çš„åŸå‹åˆ¶ä½œè€…ã€‚â€æ­£ç¡®â€å’Œâ€å¯å¤ç”¨â€çš„æ–¹æ¡ˆé€šå¸¸ä¸æ˜¯æˆ‘ä»¬åœ¨å¿«é€Ÿã€ä¸€æ¬¡æ€§ä»£ç ä¸­æ‰€å¯»æ±‚çš„ã€‚å¯¹äºæ¯ä¸ªé—®é¢˜ï¼Œä½ åº”è¯¥èƒ½å¤Ÿæƒ³å‡ºä¸€å¤§å †è§£å†³æ–¹æ¡ˆï¼Œå¹¶é€‰æ‹©é‚£ä¸ªèƒ½æœ€å¿«åšå®Œçš„æ–¹æ¡ˆã€‚ç”¨æˆ·æ°¸è¿œä¸ä¼šçœ‹åˆ°ä½ ä¼Ÿå¤§çš„ä»£ç ï¼Œä»–ä»¬ä¹Ÿä¸åœ¨ä¹ã€‚</p><p>Mr. Shodhanï¼šâ€œä»£ç çš„è¿‡åº¦è®¾è®¡å¾ˆå®¹æ˜“è®©æˆ‘ä»¬åšå‡ºä¸€äº›é€šç”¨å·¥å…·æˆ–æŠ€æœ¯æ¼”ç¤ºï¼Œä½†ä»–ä»¬å¹¶ä¸å¯ç©ã€‚è¿™å°±åƒæ˜¯ä¸€ä¸ªæ‘‡æ»šæ˜æ˜Ÿæ²‰æµ¸åœ¨è‡ªå·±çš„è‰ºæœ¯ä¸­ï¼Œè€Œè§‚ä¼—åœ¨æ‰“å“ˆæ¬ ï¼å¯¹â€˜è¿›åŒ–â€™é‚£ä¸ªä¸»é¢˜ï¼Œæˆ‘ç”¨ç»†åˆ†æ›²é¢å’Œå¡é€šæ¸²æŸ“æ•ˆæœåšäº†ä¸€ä¸ªç¨‹åºï¼Œé€šè¿‡æ‚äº¤ç¥–å…ˆæ ‘æ¥è¿›åŒ–3Dæ¨¡å‹ã€‚è¿™é‡Œæœ‰å¾ˆå¤šå¾ˆé…·çš„æŠ€æœ¯ï¼Œä½†å®Œå…¨æ²¡æœ‰æ¸¸æˆæ€§ï¼â€</p><p><img src="/images/others/translation/how_to_prototype_seven_day/14_evolution_tree.png" alt="&quot;è¿›åŒ–æ ‘&quot;â€”â€”æ‰€æœ‰è¿™äº›æŠ€æœ¯åŠ èµ·æ¥å¹¶ä¸ç­‰äºä¹è¶£ã€‚"></p><p><img src="/images/others/translation/how_to_prototype_seven_day/15_rubber_ball.jpg" alt="ä¸€ä¸ªæ©¡èƒ¶çƒã€‚å°å¿ƒï¼Œ3DæŠ€æœ¯ï¼"></p><h2 id="é€šç”¨çš„æŠ€å·§ï¼šå…³äºè¥é€ å¤šæ±ä¹è¶£çš„æ•™ç¨‹"><a href="#é€šç”¨çš„æŠ€å·§ï¼šå…³äºè¥é€ å¤šæ±ä¹è¶£çš„æ•™ç¨‹" class="headerlink" title="é€šç”¨çš„æŠ€å·§ï¼šå…³äºè¥é€ å¤šæ±ä¹è¶£çš„æ•™ç¨‹"></a>é€šç”¨çš„æŠ€å·§ï¼šå…³äºè¥é€ å¤šæ±ä¹è¶£çš„æ•™ç¨‹</h2><p>é™¤äº†åœ¨åŸå‹åˆ¶ä½œæ–¹é¢å¸å–äº†æƒ¨ç—›çš„æ•™è®­å¤–ï¼Œæˆ‘ä»¬è¿˜å¶ç„¶å‘ç°äº†ä¸€äº›é€šç”¨çš„å‡†åˆ™ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›æ˜¾è‘—å¢åŠ â€œä¹è¶£â€çš„å‡†åˆ™ã€‚</p><h3 id="å¤æ‚ä¸ä¸€å®šæœ‰è¶£"><a href="#å¤æ‚ä¸ä¸€å®šæœ‰è¶£" class="headerlink" title="å¤æ‚ä¸ä¸€å®šæœ‰è¶£"></a>å¤æ‚ä¸ä¸€å®šæœ‰è¶£</h3><p>å¦‚æœäººç±»ä»¥â€œçƒå’Œå¹³é¢â€è¿™ä¸ªä¸»é¢˜çš„å˜ä½“æ¥å¨±ä¹è‡ªå·±æ•°åƒå¹´ï¼Œæˆ‘ä»¬å¯èƒ½åœ¨è¿™äº›æ–°å¥‡çš„è§†é¢‘æ¸¸æˆä¸Šåšå¾—å¤ªè¿‡å¤´äº†ã€‚æˆ‘ä»¬å®Œå…¨å¯èƒ½ç”¨åŸºæœ¬çš„å…ƒç´ æ¥è·å¾—ä¹è¶£ã€‚æƒ³æƒ³ã€Šä¿„ç½—æ–¯æ–¹å—ã€‹ã€ã€Šåƒè±†äººã€‹ä»¥åŠä»»ä½•ç»å…¸çš„è¡—æœºæ¸¸æˆã€‚å°±åƒç½—å¯†æ¬§ä¸æœ±ä¸½å¶çš„çˆ±æƒ…æ•…äº‹åŸå‹ä¸€æ ·ï¼Œè¿™äº›æ¸¸æˆçš„æœºåˆ¶å¦‚æ­¤ä¹‹å¥½ï¼Œä»¥è‡³äºå‡ åå¹´åæˆ‘ä»¬ä»åœ¨ä½¿ç”¨å®ƒä»¬ã€‚é•œå¤´å…‰æ™•ã€å‡¹å‡¸è´´å›¾ã€æ³›å…‰å’Œå…¶ä»–æƒŠäººçš„æ–°æŠ€æœ¯æ˜¯ä¸é”™ï¼Œä½†å®ƒä»¬ä¸ä¼šè®©ä½ çš„æ¸¸æˆæ›´æœ‰è¶£ã€‚ç”¨ä¸€ä¸ªç®€å•çš„åŸå‹å‘è‡ªå·±è¯æ˜ä½ çš„æ ¸å¿ƒæœºåˆ¶å€¼å¾—ä¸€åšï¼Œåœ¨ä½ ç¡®ä¿¡ä¹‹åï¼ŒæŠŠå®ƒå˜å¾—æ¼‚äº®ã€‚</p><h3 id="åˆ›é€ ä¸€ç§æ‹¥æœ‰æ„Ÿæ¥è®©ç©å®¶ä¸æ–­é‡ç©"><a href="#åˆ›é€ ä¸€ç§æ‹¥æœ‰æ„Ÿæ¥è®©ç©å®¶ä¸æ–­é‡ç©" class="headerlink" title="åˆ›é€ ä¸€ç§æ‹¥æœ‰æ„Ÿæ¥è®©ç©å®¶ä¸æ–­é‡ç©"></a>åˆ›é€ ä¸€ç§æ‹¥æœ‰æ„Ÿæ¥è®©ç©å®¶ä¸æ–­é‡ç©</h3><p>æˆ‘ä»¬å¶ç„¶å‘ç°ï¼Œæœ€å…·é‡ç©ä»·å€¼çš„æ¸¸æˆæ˜¯é‚£äº›ä¸åˆ›é€ æˆ–è‡ªå®šä¹‰ç›¸å…³çš„æ¸¸æˆã€‚ä¾‹å¦‚ï¼Œâ€œç”¨æ‰‹å’Œé›¨ä¼åˆ¶ä½œä¸€æ£µä»¤äººæ¯›éª¨æ‚šç„¶çš„æ ‘â€ï¼Œæˆ–è€…â€œç”»ä½ è‡ªå·±çš„æˆ¿å­â€ï¼Œæˆ–è€…â€œå»ºé€ ä½ è‡ªå·±çš„å¡”â€ï¼Œæˆ–è€…â€œè¿›åŒ–ä½ è‡ªå·±çš„çªå˜ç”Ÿç‰©ç§æ—â€ã€‚æ˜¾ç„¶æˆ‘ä»¬èƒ½åœ¨è®¸å¤šåœ°æ–¹ä¸­è§åˆ°è¿™ç§ç°è±¡â€”â€”æ¸¸æˆé‡Œçš„æè„¸åŠŸèƒ½ã€è‡ªå®šä¹‰çš„æ‰‹æœºé“ƒå£°ã€ä¹ƒè‡³é‚£äº›â€œä¸ä¼—ä¸åŒï¼Œè¡¨è¾¾è‡ªæˆ‘â€çš„å¹¿å‘Šã€‚æ‰€ä»¥ï¼Œè·³ä¸Šè¿™è¶Ÿæ½®æµå§ï¼åˆ›é€ ä¸€ç§æ‹¥æœ‰æ„Ÿï¼Œè®©ä»–ä»¬ä¸æ–­é‡ç©ã€‚</p><p><img src="/images/others/translation/how_to_prototype_seven_day/16_darwin_hill.jpg" alt="&quot;Darwin Hill&quot;â€”â€”æ¯ä¸ªäººä¸ä¼—ä¸åŒã€‚"></p><h3 id="â€œå®éªŒæ€§â€ä¸æ„å‘³ç€â€å¤æ‚â€"><a href="#â€œå®éªŒæ€§â€ä¸æ„å‘³ç€â€å¤æ‚â€" class="headerlink" title="â€œå®éªŒæ€§â€ä¸æ„å‘³ç€â€å¤æ‚â€"></a>â€œå®éªŒæ€§â€ä¸æ„å‘³ç€â€å¤æ‚â€</h3><p>åœ¨é¡¹ç›®æ—©æœŸï¼Œæˆ‘ä»¬åˆ¶ä½œçš„è®¸å¤šæ¸¸æˆéƒ½å¤ªè¿‡å¤æ‚ã€‚å®ƒä»¬çš„ç”¨æˆ·ç•Œé¢ä»¤äººå›°æƒ‘ï¼Œè€Œä¸”æŒ‰é”®æ˜ å°„åˆ°çš„åŠ¨ä½œä¹Ÿä¸è‡ªç„¶æˆ–ä¸ç›´è§‚ã€‚é™¤éæˆ‘ä»¬èƒ½æœ€å°åŒ–ç©å®¶ç†è§£æ¸¸æˆä¹‹å‰çš„ç–‘æƒ‘æ—¶é—´ï¼Œå¦åˆ™ç©å®¶ä¼šæ„Ÿåˆ°æ²®ä¸§ï¼Œå†ä¹Ÿä¸ç©è¿™ä¸ªæ¸¸æˆï¼Œç”šè‡³å†ä¹Ÿä¸æ¥æˆ‘ä»¬ç½‘ç«™ã€‚å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬å‘ç°æ—¢å¯ä»¥åšåˆ°â€å®éªŒæ€§â€ï¼Œåˆå¯ä»¥ä¿æŒæ˜“äºç†è§£ã€‚</p><p>Mr. Shodhanï¼šâ€œæˆ‘çš„ç¬¬ä¸€è½®æ¸¸æˆâ€˜Spaceball Munchâ€™æ˜¯è€æ¸¸æˆâ€˜Gorillasâ€™çš„3Dç‰ˆæœ¬ï¼Œåœ¨é‚£ä¸ªæ¸¸æˆé‡Œï¼Œä½ æŒ‡å®šä¸€ä¸ªè§’åº¦å’Œé€Ÿåº¦ï¼Œè®©ä¸€ä¸ªçŒ©çŒ©å‘å¦ä¸€ä¸ªçŒ©çŒ©æ‰”é¦™è•‰ã€‚ç°åœ¨ä½ ä¸ä»…åœ¨3Dç¯å¢ƒä¸­ï¼Œæ›´æ˜¯ç”¨ç€å¼§å½¢è§†è§’ï¼Œè¿˜åœ¨ä¸€ä¸ªçƒå½¢åœºåœ°ä¸Šè¿›è¡Œæ¸¸æˆã€‚æ‰€ä»¥ä½ è¦è€ƒè™‘ä¸¤ä¸ªè§’åº¦å’Œä¸€ä¸ªé€Ÿåº¦ã€‚å¦å¤–ï¼Œå®ƒç°åœ¨ä¹Ÿä¸å†æ˜¯ä¸€ä¸ªç¦»æ•£çš„å›åˆåˆ¶æ¸¸æˆï¼Œè€Œæ˜¯éœ€è¦æ§åˆ¶ä¸€ä¸ªè¿ç»­çš„ç²’å­æµï¼ŒåŒæ—¶å¿…é¡»å‡»ä¸­æ‰€æœ‰è¿™äº›ç§»åŠ¨çš„ç‰©ä½“ã€‚è¿™å¼ æˆªå›¾å±•ç¤ºäº†è¿™ç§æ¯«æ— æ„ä¹‰çš„å¤æ‚åº¦â€</p><p><img src="/images/others/translation/how_to_prototype_seven_day/17_spaceball_munch.jpg" alt="&quot;Spaceball Munch&quot;â€”â€”æˆ‘ä»¬æ€ä¹ˆèƒ½çŸ¥é“ï¼Ÿï¼"></p><h3 id="æœç€ä¸€ä¸ªæ˜ç¡®å®šä¹‰çš„ç›®æ ‡å‰è¿›"><a href="#æœç€ä¸€ä¸ªæ˜ç¡®å®šä¹‰çš„ç›®æ ‡å‰è¿›" class="headerlink" title="æœç€ä¸€ä¸ªæ˜ç¡®å®šä¹‰çš„ç›®æ ‡å‰è¿›"></a>æœç€ä¸€ä¸ªæ˜ç¡®å®šä¹‰çš„ç›®æ ‡å‰è¿›</h3><p>äººä»¬å¾ˆå®¹æ˜“å¿˜è®°è®¾ç½®ä¸€ä¸ªæ˜ç¡®å®šä¹‰çš„ç›®æ ‡ã€‚æ²¡æœ‰æ¸¸æˆç›®æ ‡ï¼Œä¸€ä¸ªåŸå‹å°±åªæ˜¯ä¸€ä¸ªç©å…·ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªæ¸¸æˆã€‚å‡ºäºæŸç§åŸå› ï¼Œäººä»¬ä¼¼ä¹å–œæ¬¢æœ‰å¤±è´¥çš„æœºä¼šã€‚ä¸€ä¸ªç›®æ ‡å¯ä»¥æ˜¯ä»»ä½•äº‹æƒ…â€”â€”æ¯”å¦‚â€œåœ¨xæ—¶é—´å†…æ”¶é›†xä¸ªå°éƒ¨ä»¶â€ï¼Œæˆ–è€…â€œä¿æŒç³»ç»Ÿç¨³å®šâ€ï¼Œæˆ–è€…â€œåœ¨ä¸ç¢°åˆ°ä»»ä½•åä¸œè¥¿çš„æƒ…å†µä¸‹ç©¿è¶Šä¸€ä¸ªç©ºé—´â€ã€‚ä½†æ‰¾åˆ°ä¸€ä¸ªä¸è®©äººè§‰å¾—ç‰µå¼ºçš„ç›®æ ‡è¿˜æ˜¯å¾ˆéš¾çš„ï¼ˆæ¯”å¦‚æ—¶é™ä¸€èˆ¬å°±å¾ˆç‰µå¼ºï¼‰ã€‚æˆ‘ä»¬å‘ç°ï¼Œæœ€å¥½çš„ç›®æ ‡æ˜¯æ¸¸æˆç©æ³•ä¸­å›ºæœ‰çš„éƒ¨åˆ†ï¼Œæ¯”å¦‚åœ¨ã€Šé»é»ä¸–ç•Œã€‹ä¸­ï¼Œéšå«çš„ç›®æ ‡å°±æ˜¯ç®€å•åœ°â€œå‘ä¸Šå»ºé€ â€ã€‚</p><p><img src="/images/others/translation/how_to_prototype_seven_day/18_tower_of_goo.jpg" alt="&quot;é»é»ä¸–ç•Œ&quot;â€”â€”æœç€ä¸€ä¸ªç›®æ ‡â€¦â€¦ä»¥åŠæ›´è¿œçš„åœ°æ–¹å»ºé€ ï¼"></p><h3 id="è®©å®ƒå¤šæ±ï¼"><a href="#è®©å®ƒå¤šæ±ï¼" class="headerlink" title="è®©å®ƒå¤šæ±ï¼"></a>è®©å®ƒå¤šæ±ï¼</h3><p>å¤šæ±ï¼ˆJuicyï¼‰æ˜¯æˆ‘ä»¬ç”¨æ¥å½¢å®¹æŒç»­ä¸”ä¸°å¯Œçš„ç”¨æˆ·åé¦ˆçš„æœ¯è¯­ã€‚ä¸€ä¸ªå¤šæ±çš„æ¸¸æˆå…ƒç´ åœ¨ä½ è§¦æ‘¸å®ƒæ—¶ä¼šå¼¹è·³ã€æ‰­åŠ¨ã€å–·å°„å¹¶å‘å‡ºä¸€ç‚¹å£°éŸ³ã€‚ä¸€ä¸ªå¤šæ±çš„æ¸¸æˆå¾ˆæ´»æ³¼ï¼Œå®ƒå¯¹ä½ åšçš„æ¯ä»¶äº‹éƒ½æœ‰ååº”â€”â€”ä¸€ç‚¹ç‚¹è¾“å…¥å°±ä¼šäº§ç”Ÿå¤§é‡çš„å›åº”å’Œè¿é”ååº”ï¼Œè¿™è®©ç©å®¶æ„Ÿè§‰è‡ªå·±æŒæ§ç€ä¸–ç•Œã€‚å®ƒä¹Ÿåœ¨äº’åŠ¨æ—¶ä¸æ–­è®©ç©å®¶çŸ¥é“è‡ªå·±æ­£åœ¨åšä»€ä¹ˆï¼Œå¼•å¯¼ä»–ä»¬äº†è§£æ¸¸æˆè§„åˆ™ã€‚</p><p>ä½ å¯èƒ½ç»å†è¿‡çš„ä¸€äº›å¤šæ±çš„ä¾‹å­å¯èƒ½åŒ…æ‹¬ï¼š</p><ul><li>ã€ŠAlien Hominidã€‹ï¼šéå¸¸å¤¸å¼ çš„æ•Œäººçˆ†ç‚¸å’Œè¡€æ¶²é£æº…ã€‚</li><li>ã€Šé©¬é‡Œå¥¥å…„å¼Ÿã€‹ï¼šåœ¨ä¸€ä¸ªå……æ»¡é‡‘å¸çš„æˆ¿é—´é‡Œå¼¹è·³ï¼Œå®å½“å£°å¾ˆè®©äººæ»¡è¶³ã€‚</li><li>å¼¹ç æœºï¼šä¸€è‚¡æ°¸æ— æ­¢å¢ƒçš„çƒæµå…¨åœ¨ä½ çš„æ§åˆ¶ä¹‹ä¸‹ã€‚</li><li>ã€Šè¶…çº§æ–¹å—æˆ˜å£«2 Turboã€‹ï¼šè¿å‡»æ—¶ï¼ŒåŠ¨ç”»å’Œç‰¹æ•ˆå±‚å‡ºä¸ç©·ã€‚</li></ul><p><img src="/images/others/translation/how_to_prototype_seven_day/19_left_mid_right.jpg" alt="å¤šæ±çš„æ„Ÿè§‰å¾ˆæ£’ï¼ä½ ç®€ç›´åœä¸ä¸‹æ¥ã€‚"></p><h2 id="æœ€åçš„æƒ³æ³•"><a href="#æœ€åçš„æƒ³æ³•" class="headerlink" title="æœ€åçš„æƒ³æ³•"></a>æœ€åçš„æƒ³æ³•</h2><p>è¿™æ¬¡å…³äºå®éªŒæ€§æ¸¸æˆé¡¹ç›®çš„å›¢é˜Ÿåˆä½œæ˜¯ä¸€ä»¶éå¸¸æ„‰å¿«çš„äº‹ã€‚æˆ‘ä»¬å¸Œæœ›ä¸‹æ¬¡å½“ä½ å°è¯•ä¸€äº›æ–°çš„æˆ–æœ‰ç‚¹ç–¯ç‹‚çš„ä¸œè¥¿æ—¶ï¼Œè¿™äº›å»ºè®®å’ŒæŠ€å·§èƒ½å¯¹ä½ æœ‰æ‰€å¸®åŠ©ã€‚è°çŸ¥é“å‘¢ï¼Œä½ ä»Šå¤©æ—©ä¸Šæœ‰çš„é‚£ä¸ªå°æƒ³æ³•å¯èƒ½å°±æ˜¯ä¸‹ä¸€ä¸ªç¥ä½œã€‚å¬é›†ä¸€äº›æœ‹å‹æˆ–è€…å•å¹²ï¼Œå¿«å»å°è¯•å¹¶åˆ¶ä½œåŸå‹å§ï¼ä½ å¯èƒ½ä¼šç»™è‡ªå·±ä¸€ä¸ªæƒŠå–œã€‚</p><p>æˆ‘ä»¬çš„é¡¾é—®å‹å¥½åœ°æŒ‡å‡ºï¼Œâ€œå¿«é€ŸåŸå‹å¯èƒ½å¾ˆåƒæ€€ä¸€ä¸ªå­©å­ã€‚æ²¡äººæŒ‡æœ›æ¯æ¬¡éƒ½èƒ½èµ¢ï¼Œä½†ä½ æ€»æ˜¯å­¦åˆ°æ–°ä¸œè¥¿ï¼Œè€Œä¸”è¿™é€šå¸¸å¾ˆæœ‰è¶£ï¼â€</p><p>ç¥ä½ åŸå‹åˆ¶ä½œæ„‰å¿«ï¼</p><p><img src="/images/others/translation/how_to_prototype_seven_day/20_final.jpg" alt=""></p><p>æ­¤é¡µé¢è½¬è½½è‡ª Gamasutra ç½‘ç«™ï¼š<br><a href="http://www.gamasutra.com/features/20051026/gabler_01.shtml">http://www.gamasutra.com/features/20051026/gabler_01.shtml</a></p><h2 id="ä¾¿æ·æ¸…å•ï¼"><a href="#ä¾¿æ·æ¸…å•ï¼" class="headerlink" title="ä¾¿æ·æ¸…å•ï¼"></a>ä¾¿æ·æ¸…å•ï¼</h2><ol><li><p>å‡†å¤‡ï¼šå¿«é€Ÿæ˜¯ä¸€ç§å¿ƒæ€</p><ul><li>æ‹¥æŠ±å¤±è´¥çš„å¯èƒ½æ€§â€”â€”å®ƒé¼“åŠ±åˆ›é€ æ€§å†’é™©</li><li>å¼ºåˆ¶ç¼©çŸ­å¼€å‘å‘¨æœŸï¼ˆæ›´å¤šæ—¶é—´ != æ›´é«˜è´¨é‡ï¼‰</li><li>å¯¹åˆ›é€ çš„çº¦æŸè®©ä½ æ›´æƒ³åˆ›é€ </li><li>ç»„å»ºä¸€æ”¯ä¼˜ç§€çš„å›¢é˜Ÿå’Œä¸€ä½å®¢è§‚çš„é¡¾é—®â€”â€”å¿ƒæ€ä¸æ‰ååŒç­‰é‡è¦</li><li>å¹¶è¡Œå¼€å‘ä»¥æœ€å¤§åŒ–æ•ˆæœ</li></ul></li><li><p>è®¾è®¡ï¼šå¤´è„‘é£æš´çš„ç¥è¯å’Œåˆ›é€ åŠ›</p><ul><li>æ­£å¼å¤´è„‘é£æš´çš„æˆåŠŸç‡ä¸º 0%</li><li>æ”¶é›†æ¦‚å¿µè‰ºæœ¯å’ŒéŸ³ä¹ä»¥åˆ›é€ æƒ…ç»ªç›®æ ‡</li><li>åœ¨è„‘ä¸­æ¨¡æ‹Ÿâ€”â€”åšåŸå‹çš„åŸå‹</li></ul></li><li><p>å¼€å‘ï¼šæ²¡äººçŸ¥é“ä½ æ˜¯æ€ä¹ˆåšçš„ï¼Œä¹Ÿæ²¡äººåœ¨ä¹</p><ul><li>å…ˆåšç©å…·</li><li>å¦‚æœèƒ½å·æ‡’ï¼Œé‚£å°±å·æ‡’</li><li>åŠæ—¶æ­¢æŸï¼Œå‰²èˆå¿ƒå¤´ä¹‹çˆ±</li><li>æ¼‚äº®çš„åŒ…è£…æ— æ³•æŒ½æ•‘ç³Ÿç³•çš„è®¾è®¡ï¼ˆæˆ–è€…è¯´ï¼Œâ€çƒ‚æ³¥æ‰¶ä¸ä¸Šå¢™â€ï¼‰</li><li>ä½†æ•´ä½“ç¾å­¦å¾ˆé‡è¦ï¼åˆç†è¿ç”¨ç¾æœ¯ã€éŸ³æ•ˆå’ŒéŸ³ä¹</li><li>æ²¡äººå…³å¿ƒä½ çš„ä»£ç è´¨é‡</li></ul></li><li><p>é€šç”¨çš„æŠ€å·§ï¼šå…³äºè¥é€ å¤šæ±ä¹è¶£çš„æ•™ç¨‹</p><ul><li>å¤æ‚ä¸ä¸€å®šæœ‰è¶£</li><li>åˆ›é€ ä¸€ç§æ‹¥æœ‰æ„Ÿæ¥è®©ç©å®¶ä¸æ–­é‡ç©</li><li>â€œå®éªŒæ€§â€ä¸æ„å‘³ç€â€å¤æ‚â€</li><li>æœç€ä¸€ä¸ªæ˜ç¡®å®šä¹‰çš„ç›®æ ‡å‰è¿›</li><li>è®©å®ƒå¤šæ±ï¼</li></ul></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;ç¿»è¯‘è‡ª &lt;a href=&quot;http://miami.lgrace.com/documents/How%20to%20Prototype%20a%20Game%20in%20Under%207%20Days.pdf&quot;&gt;How to Prototype a Game in Un</summary>
      
    
    
    
    <category term="æ‚è°ˆ" scheme="http://rinevard.github.io/categories/%E6%9D%82%E8%B0%88/"/>
    
    <category term="ç¿»è¯‘" scheme="http://rinevard.github.io/categories/%E6%9D%82%E8%B0%88/%E7%BF%BB%E8%AF%91/"/>
    
    
  </entry>
  
  <entry>
    <title>Lab 2.1 ç³»ç»Ÿè°ƒç”¨æµç¨‹â€”â€”ä»¥sleepä¸ºä¾‹</title>
    <link href="http://rinevard.github.io/wiki/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/"/>
    <id>http://rinevard.github.io/wiki/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/</id>
    <published>2025-10-15T08:02:38.000Z</published>
    <updated>2025-10-19T03:44:03.330Z</updated>
    
    <content type="html"><![CDATA[<p>æˆ‘ä»¬çŸ¥é“åº”ç”¨ç¨‹åºåœ¨User modeä¸‹è¿è¡Œï¼Œè€Œç³»ç»Ÿå‡½æ•°çš„æ‰§è¡Œéœ€è¦Supervisor modeï¼Œé‚£åœ¨ç³»ç»Ÿè°ƒç”¨æ—¶ï¼ŒUser modeæ˜¯æ€ä¹ˆè¿›å…¥Supervisor modeçš„å‘¢ï¼Ÿæˆ‘ä»¬ä»¥sleepçš„æ‰§è¡Œä¸ºä¾‹ï¼Œçœ‹çœ‹éƒ½å‘ç”Ÿäº†ä»€ä¹ˆã€‚é¦–å…ˆæˆ‘ä»¬ç”¨ <code>git checkout util</code> åˆ‡æ¢åˆ° util åˆ†æ”¯ä¸Šã€‚</p><p>åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬è¦å…ˆç®€ä»‹ä¸€ä¸‹<strong>ECALL</strong>æŒ‡ä»¤å’Œ<strong>stvec</strong>ï¼ˆSupervisor Trap Vector Base Address Registerï¼‰å¯„å­˜å™¨ã€‚</p><p>ECALL ä¼šè§¦å‘ä¸€ä¸ªå¼‚å¸¸ï¼Œå¦‚æœæˆ‘ä»¬åœ¨ç”¨æˆ·æ€è§¦å‘è¿™ä¸ªå¼‚å¸¸ï¼Œç¨‹åºè®¡æ•°å™¨ pc å°±ä¼šæ ¹æ® stvec è¿›è¡Œè·³è½¬ï¼Œåˆ°è¾¾å¼‚å¸¸å¤„ç†å¤„ã€‚</p><p>ä»¥ä¸‹æ˜¯ <a href="https://www.scs.stanford.edu/~zyedidia/docs/riscv/riscv-privileged.pdf">risc-v æ‰‹å†Œ</a> å¯¹ ECALL çš„è§£é‡Šï¼š</p><blockquote><p>When executed in U-mode, S-mode, or M-mode, it generates an environment-call-from-U-mode exception, environment-call-from-S-mode exception, or environment-call-from-M-mode exception, respectively, and performs no other operation.</p></blockquote><blockquote><p>å¦‚æœåœ¨ U-mode æ‰§è¡Œï¼ŒECALL æŒ‡ä»¤ä¼šäº§ç”Ÿä¸€ä¸ªæ¥è‡ª U-mode çš„ç¯å¢ƒè°ƒç”¨å¼‚å¸¸ï¼›å¦‚æœåœ¨ S-mode æ‰§è¡Œï¼Œåˆ™äº§ç”Ÿæ¥è‡ª S-mode çš„ç¯å¢ƒè°ƒç”¨å¼‚å¸¸ï¼›å¦‚æœåœ¨ M-mode æ‰§è¡Œï¼Œåˆ™äº§ç”Ÿæ¥è‡ª M-mode çš„ç¯å¢ƒè°ƒç”¨å¼‚å¸¸ã€‚</p></blockquote><p>ä»¥ä¸‹æ˜¯ risc-v æ‰‹å†Œå¯¹ stvec å¯„å­˜å™¨çš„ç®€ä»‹ï¼š</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/stvec.png" alt=""></p><p>BASEæ˜¯4å­—èŠ‚å¯¹é½çš„ï¼ˆRISC-V æ‰‹å†Œ P80ï¼‰ï¼Œæ‰€ä»¥åœ¨MODE == 0æ—¶ï¼Œæˆ‘ä»¬è·³è½¬åˆ°çš„åœ°å€æ˜¯ <code>(stvec &gt;&gt; 2) &lt;&lt; 2</code>ï¼Œè€Œç”±äº MODE == 0ï¼Œè¿™ä¸ªå€¼å°±æ˜¯ stvec ï¼›åœ¨MODE == 1æ—¶ï¼Œæˆ‘ä»¬è½¬åˆ°çš„åœ°å€æ˜¯ <code>(stvec &gt;&gt; 2) &lt;&lt; 2 + 4*cause</code></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥å¼€å§‹çœ‹çœ‹ç³»ç»Ÿè°ƒç”¨æ—¶ç©¶ç«Ÿå‘ç”Ÿäº†ä»€ä¹ˆï¼æˆ‘ä»¬ä¼šä»¥sleepä¸ºä¾‹ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬æ‰“å¼€gdb-multiarchï¼ˆå‚è€ƒ Note 0 çš„â€ç”¨ç»ˆç«¯è°ƒè¯•â€œï¼‰ï¼Œç„¶åç”¨ <code>set prompt \\001\\033[1;33m\\002(gdb) \\001\\033[0m\\002</code> æ¥é«˜äº® â€œ(gdb)â€ ä»¥æ–¹ä¾¿è§‚å¯Ÿè‡ªå·±çš„è¾“å…¥ã€‚</p><p>ç”¨ <code>file user/_sleep</code> åˆ‡æ¢åˆ°ç”¨æˆ·ç¬¦å·è¡¨ï¼Œæ¥ç€ç”¨<code>c</code>è¿è¡Œåˆ°xv6çš„shellå¯åŠ¨ã€‚</p><p>è§‚å¯Ÿå³è¾¹çš„ç»ˆç«¯å¯ä»¥çœ‹åˆ°shellå·²ç»æˆåŠŸå¯åŠ¨äº†ã€‚</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/debug_start.png" alt=""></p><p>ç„¶åæˆ‘ä»¬åœ¨gdbé‡ŒæŒ‰ä¸‹ctrl+cæ¥ä¸­æ–­ï¼Œå¹¶ç”¨ <code>b main</code> è®¾ç½®æ–­ç‚¹ï¼Œå†ä½¿ç”¨ <code>layout split</code> è®©gdbæ˜¾ç¤ºå‡ºæºç å’Œæ±‡ç¼–ä»£ç ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬åœ¨gdbé‡Œè¾“å…¥ <code>c</code> ä»¥è®©xv6ç»§ç»­æ‰§è¡Œï¼Œå¦åˆ™xv6çš„shellä¼šå¤„äºæš‚åœçŠ¶æ€ï¼Œä¸èƒ½å¤„ç†è¾“å…¥ã€‚</p><p>ç„¶ååœ¨xv6çš„shellé‡Œæ‰§è¡Œ <code>sleep 1</code> ï¼Œå®ƒä¼šåœ¨æ–­ç‚¹å¤„åœä¸‹ã€‚</p><p>è§‚å¯Ÿå·¦è¾¹çš„gdbï¼Œå¯ä»¥çœ‹åˆ°å®ƒåœåœ¨äº†sleep.cçš„mainå‡½æ•°ã€‚</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/sleep_main.png" alt=""></p><p>éšä¾¿æ‰§è¡Œä¸€ä¸‹ç›´åˆ°åˆ°è¾¾sleepè¿™è¡Œï¼Œ<code>n</code> è¡¨ç¤ºæ‰§è¡Œä¸€è¡Œcè¯­è¨€ï¼Œ<code>si</code>è¡¨ç¤ºæ‰§è¡Œä¸€ä¸ªæ±‡ç¼–è¯­å¥ã€‚</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/sleep_jal_atoi.png" alt=""></p><p>æˆ‘ä»¬ç”¨<code>si</code>è¿›å…¥atoiï¼Œç„¶åäº¤æ›¿ç€ç”¨<code>n</code>å’Œ<code>si</code>ï¼Œåœ¨å¿«åˆ°returnæ—¶ç”¨<code>si</code>ï¼Œå°±èƒ½ç¦»å¼€atoiå›åˆ°sleep.cã€‚</p><p>è§‚å¯Ÿå·¦è¾¹çš„gdbï¼Œå’Œä¸Šå›¾ç›¸æ¯”ï¼Œè™½ç„¶cè¯­è¨€çš„ä½ç½®æ²¡æœ‰å˜åŒ–ï¼Œä½†æ±‡ç¼–ä»£ç çš„ä½ç½®æ˜¯æœ‰å˜åŒ–çš„ã€‚</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/sleep_jal_sleep.png" alt=""></p><p>ä¹‹åç”¨<code>si</code>ï¼Œä¼šå‘ç°æˆ‘ä»¬è·³è½¬åˆ°äº† <code>usys.S</code>ï¼Œå®ƒæŠŠsleepçš„ç³»ç»Ÿè°ƒç”¨å·æ”¾åˆ°å¯„å­˜å™¨a7é‡Œï¼Œç„¶åå€ŸåŠ©ecallæ¥æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ã€‚</p><p>è§‚å¯Ÿå·¦è¾¹çš„gdbå‘ç°æˆ‘ä»¬å·²ç»è¿›å…¥äº†<code>usys.S</code></p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/usys_enter.png" alt=""></p><p>å¦‚æœæˆ‘ä»¬ç›´æ¥ç”¨å‡ ä¸ª<code>si</code>ï¼Œä¼šå‘ç°<code>ecall</code>å¹¶æ²¡æœ‰åƒ<code>jal</code>ä¹‹ç±»çš„è·³è½¬è¯­å¥ä¸€æ ·å¸¦æˆ‘ä»¬åˆ°ä¸€äº›ç¥å¥‡çš„åœ°æ–¹ï¼Œè€Œæ˜¯ç›´æ¥åˆ°äº†ä¸‹ä¸€è¡Œã€‚è¿™æ˜¯å› ä¸º<code>ecall</code>ä¸æ˜¯è·³è½¬ï¼Œè€Œæ˜¯æŠ›å‡ºäº†ä¸€ä¸ªå¼‚å¸¸ï¼Œå†…æ ¸è‡ªåŠ¨å¤„ç†äº†å¼‚å¸¸ã€‚</p><p>è¿™æ ·çœ‹æ¥ï¼Œæˆ‘ä»¬è¦æ‰¾åˆ°è¿™ä¸ªå¼‚å¸¸çš„å¼€å§‹å¤„å¹¶è®¾ç½®æ–­ç‚¹æ‰è¡Œã€‚è¿˜è®°å¾—æˆ‘ä»¬ä¹‹å‰è¯´è¿‡<code>ecall</code>æŠ›å‡ºå¼‚å¸¸æ—¶pcä¼šè·³è½¬åˆ°å“ªé‡Œå—ï¼Ÿç­”æ¡ˆæ˜¯å®ƒä¼šæ ¹æ®å¯„å­˜å™¨stvecçš„å€¼è¿›è¡Œè·³è½¬ã€‚è®©æˆ‘ä»¬å€ŸåŠ©<code>p /x $stvec</code>çœ‹çœ‹stvecçš„å€¼ã€‚</p><p>è§‚å¯Ÿå·¦è¾¹çš„gdbï¼Œå‘ç°stvecçš„å€¼æ˜¯ 0x3ffffff000ï¼Œè‡³å°‘åœ¨æˆ‘è¿™é‡Œæ˜¯è¿™æ ·ã€‚</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/print_stvec.png" alt=""></p><p>å›é¡¾ä¸€ä¸‹stvecå¯„å­˜å™¨çš„ç»“æ„å’ŒåŠŸèƒ½ï¼Œä¼šå‘ç°æ‰§è¡Œecallåï¼Œpcä¼šè·³è½¬åˆ°BASEæ‰€åœ¨çš„åœ°å€ã€‚æˆ‘ä»¬ä¹‹å‰è¯´è¿‡ï¼ŒBASEæ˜¯4å­—èŠ‚å¯¹é½çš„ï¼ˆRISC-V æ‰‹å†Œ P80ï¼‰ï¼Œæ‰€ä»¥åœ¨MODE == 0æ—¶ï¼Œæˆ‘ä»¬è·³è½¬åˆ°çš„åœ°å€æ˜¯ <code>(stvec &gt;&gt; 2) &lt;&lt; 2</code>ï¼Œè€Œç”±äº MODE == 0ï¼Œè¿™ä¸ªå€¼å°±æ˜¯ stvecã€‚</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/stvec.png" alt=""></p><p>æˆ‘ä»¬æ¥ä¸‹æ¥æŠŠæ–­ç‚¹è®¾ç½®åœ¨è¿™ä¸ªå€¼ï¼Œç„¶åç”¨<code>si</code>åˆ°è¾¾<code>ecall</code>è¯­å¥å¤„</p><p>è§‚å¯Ÿå·¦è¾¹çš„gdbï¼Œæˆ‘ä»¬ç°åœ¨å·²ç»åœ¨<code>ecall</code>è¿™é‡Œäº†ã€‚</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/break_ecall_target.png" alt=""></p><p>å¦‚æœæˆ‘ä»¬çš„æ“ä½œæ­£ç¡®ï¼Œæ¥ä¸‹æ¥çš„<code>si</code>ä¼šè§¦å‘ä¸€ä¸ªå¼‚å¸¸å¯¼è‡´æˆ‘ä»¬è·³è½¬åˆ° 0x3ffffff000 å¹¶è§¦å‘æ–­ç‚¹ï¼Œå¸Œæœ›æˆ‘ä»¬æ²¡æœ‰ç¿»è½¦~</p><p>è§‚å¯Ÿå·¦è¾¹çš„gdbï¼Œå‘ç°æˆ‘ä»¬æˆåŠŸè·³è½¬åˆ°äº†ä¸€ä¸ªæœªçŸ¥çš„åœ°æ–¹ï¼</p><p>æŒ‰æˆ‘çš„ç†è§£ï¼Œç”±äºæˆ‘ä»¬åœ¨U-modeä¸‹æ‰§è¡Œecallä»¥è§¦å‘å¼‚å¸¸ï¼Œæ‰€ä»¥æˆ‘ä»¬ç°åœ¨å·²ç»è¿›å…¥äº†S-modeã€‚ä¸è¿‡æˆ‘ç¿»äº†å¾ˆå¤šèµ„æ–™è¿˜æ˜¯æ²¡æœ‰æ‰¾åˆ°èƒ½æ˜ç¡®æ”¯æŒè¿™ä¸€ç‚¹çš„è¯æ®ï¼ˆä¹Ÿæ²¡æœ‰æ‰¾åˆ°æ˜ç¡®åå¯¹çš„è¯æ®ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä¿ç•™æˆ‘çš„è§‚ç‚¹ã€‚</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/ecall.png" alt=""></p><p>æ€»ä¹‹ä¸€åˆ‡é¡ºåˆ©ï¼è®©æˆ‘ä»¬æš‚åœä¸€ä¸‹ï¼Œæƒ³æƒ³è¿™ä¸ª 0x3ffffff000 çš„åœ°å€ä»£è¡¨ä»€ä¹ˆã€‚åœ¨å†…æ ¸å¯åŠ¨æ—¶é€šè¿‡<code>file kernel/kernel</code> åŠ è½½å†…æ ¸ç¬¦å·è¡¨å¹¶åœ¨<code>usertrapret</code>è®¾ç½®æ–­ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç° 0x3ffffff000 è¿™ä¸ªåœ°å€å’Œ <code>kernel/trap.c</code> é‡Œçš„<code>trampoline_uservec</code> ç›¸ç­‰ã€‚</p><p>trampolineæ˜¯ä»€ä¹ˆï¼Ÿtrampolineæ˜¯åœ¨è¿›ç¨‹è™šæ‹Ÿå†…å­˜çš„é¡¶éƒ¨çš„ä¸€å—ç©ºé—´ï¼Œæ˜ å°„åˆ°çš„ç‰©ç†åœ°å€å­˜æ”¾ç€è·³è½¬è¿›å’Œè·³è½¬å‡ºå†…æ ¸çš„ä»£ç ã€‚çœ‹èµ·æ¥åœ¨åšç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œæˆ‘ä»¬é€šè¿‡ecallè·³è½¬è¿›å†…æ ¸ã€‚è¿™æ ·ä¸€åˆ‡éƒ½è¯´å¾—é€šäº†~</p><p>è®©æˆ‘ä»¬æ‰“å¼€trampoline.Sï¼Œå¯¹æ¯”å·¦è¾¹gdbæ˜¾ç¤ºçš„ä»£ç å’Œå³è¾¹çš„trampoline.Sï¼Œä¼šå‘ç°å®ƒä»¬ç¡®å®èƒ½å¯¹ä¸Šï¼</p><p>å¥½å§ï¼Œä¹Ÿä¸æ˜¯å®Œå…¨èƒ½å¯¹ä¸Šï¼Œä½ ä¼šæ³¨æ„åˆ°å³è¾¹çš„ <code>li a0,TRAPFRAME</code> åœ¨å·¦è¾¹ä¼¼ä¹å¯¹åº”äº†ä¸‰æ¡è¯­å¥ï¼Œè¿™æ˜¯æ€ä¹ˆå›äº‹å‘¢ï¼Ÿå®é™…ä¸Šï¼Œ<code>li</code> æ˜¯RISC-V æ±‡ç¼–ä¸­çš„ä¼ªæŒ‡ä»¤ï¼Œå®é™…æ‰§è¡Œæ—¶ï¼Œ<code>li</code> ä¼šè¢«æ±‡ç¼–å™¨ç¿»è¯‘ä¸ºä¸€æ¡æˆ–å¤šæ¡çœŸæ­£çš„ RISC-V æŒ‡ä»¤ã€‚</p><p>å—¯ï¼Œè¿™æ ·å°±èƒ½å¯¹ä¸Šäº†ï¼</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/trapoline_enter.png" alt=""></p><p>è¯»ä¸€è¯»trampoline.Sï¼Œæˆ‘ä»¬å‘ç°å®ƒä¼šæŠŠç”¨æˆ·è¿›ç¨‹çš„å¯„å­˜å™¨ç­‰ä¿¡æ¯ä¿å­˜åˆ°trapframeé‡Œï¼Œç„¶åè·³è½¬åˆ°å†…æ ¸çš„usertrapå‡½æ•°ã€‚</p><p>å› æ­¤æ¥ä¸‹æ¥æˆ‘ä»¬è¦ç”¨<code>file kernel/kernel</code>æŠŠç¬¦å·è¡¨åˆ‡æ¢åˆ°kernelï¼Œå†ç”¨<code>si n</code> æ¥ä¸€æ¬¡æ‰§è¡Œå¤šæ¡æ±‡ç¼–è¯­å¥ï¼Œç›´åˆ°æŒ‡ä»¤<code>jr</code>å¤„ï¼š</p><p>æ¯”è¾ƒå·¦è¾¹å’Œå³è¾¹ï¼Œå‘ç°å®ƒä»¬çš„æ±‡ç¼–ä»£ç ç¡®å®èƒ½å¯¹ä¸Šï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¦å‡†å¤‡è·³è½¬äº†ã€‚</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/trapoline_jump.png" alt=""></p><p>é™·é˜±ï¼Œå¯åŠ¨ï¼</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/usertrap_enter.png" alt=""></p><p>å¦‚æœä½ å‘ç°ä½ çš„gdbæ²¡æœ‰é¡ºåˆ©æ˜¾ç¤ºå‡ºcè¯­è¨€ä»£ç ï¼Œå¯èƒ½æ˜¯ä½ å¿˜è®°åˆ‡æ¢ç¬¦å·è¡¨åˆ°å†…æ ¸äº†ï¼Œç”¨<code>file kernel/kernel</code>æ¥åˆ‡æ¢ï¼Œç„¶åè¡¥ä¸€ä¸ª<code>si</code>å°±èƒ½æ˜¾ç¤ºå‡ºæ¥äº†ã€‚</p><p>ç”±äºä¸€åˆ‡æ­£å¸¸ï¼Œæˆ‘ä»¬å¯ä»¥ä¸€è·¯æŒ‰<code>n</code>ç›´åˆ°åˆ°è¾¾syscallè¿™é‡Œã€‚</p><p>æ¯”è¾ƒå·¦è¾¹å’Œå³è¾¹çš„ä»£ç ï¼Œå®ƒä»¬æ˜¯èƒ½å¯¹åº”ä¸Šçš„ã€‚æ¥ä¸‹æ¥è®©æˆ‘ä»¬å‡†å¤‡è¿›å…¥<code>syscall</code></p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/usertrap_jump.png" alt=""></p><p>æˆ‘ä»¬ç”¨<code>s</code>è¿›å…¥syscallå‡½æ•°ã€‚<code>n</code>å’Œ<code>s</code>éƒ½ä¼šæ‰§è¡Œå½“å‰è¡Œï¼Œä¸è¿‡å¦‚æœå½“å‰è¡Œæ˜¯å‡½æ•°ï¼Œ<code>n</code>ä¸ä¼šè¿›å…¥å‡½æ•°ï¼Œè€Œ<code>s</code>ä¼šã€‚</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/syscall_enter.png" alt=""></p><p>syscallå‡½æ•°ä»trapframeä¸­å–å‡ºç³»ç»Ÿè°ƒç”¨å·ï¼Œç„¶åè°ƒç”¨å®ƒã€‚è¿˜è®°å¾—å—ï¼Œæˆ‘ä»¬è°ƒç”¨ç³»ç»Ÿå‡½æ•°æ—¶å…ˆè¿›å…¥äº†usys.Sï¼Œç„¶åæŠŠç³»ç»Ÿè°ƒç”¨å·ä¿å­˜åˆ°äº†a7ã€‚ä¹‹åç”±äºæˆ‘ä»¬è½¬å…¥äº†å†…æ ¸ï¼Œæˆ‘ä»¬åœ¨trapoline.Sé‡ŒæŠŠæ‰€æœ‰çš„ç”¨æˆ·ç©ºé—´çš„å¯„å­˜å™¨éƒ½ä¿å­˜åˆ°äº†trapframeä¸­ã€‚</p><p>æ€»ä¹‹æˆ‘ä»¬åœ¨è¿™é‡Œè°ƒç”¨äº†sys_sleepï¼Œæˆ‘ä»¬è¿›å…¥å®ƒçœ‹çœ‹ã€‚</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/syssleep_enter.png" alt=""></p><p>å¯ä»¥å‘ç°å®ƒå°±æ˜¯çœŸæ­£å¹²æ´»çš„åœ°æ–¹ï¼å®ƒéå¸¸å¿ å®åœ°æ‰§è¡Œäº†sleepçš„é€»è¾‘ã€‚</p><p>æˆ‘ä»¬å¯ä»¥æ³¨æ„åˆ° n å°±æ˜¯å­˜æ”¾ç€æˆ‘ä»¬æœ€å¼€å§‹ä¼ å…¥çš„å‚æ•°çš„å˜é‡ï¼Œå†…æ ¸é€šè¿‡argintæ¥æ‰¾åˆ°æˆ‘ä»¬ä¸€å¼€å§‹ä¼ å…¥çš„å‚æ•°ã€‚argintçš„æ€è·¯å’Œæˆ‘ä»¬ä¹‹å‰æ‰¾åˆ°ç³»ç»Ÿè°ƒç”¨å·ç±»ä¼¼ï¼Œä¹Ÿæ˜¯ä»trapframeä¸­æ‰¾åˆ°å­˜æ”¾ç€ä¼ å…¥å‚æ•°çš„å¯„å­˜å™¨ã€‚</p><p>è®©æˆ‘ä»¬ç»§ç»­å¾€åï¼Œçœ‹çœ‹åœ¨æ‰§è¡Œå®Œé€»è¾‘ä»¥åå‘ç”Ÿäº†ä»€ä¹ˆå§ã€‚</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/syssleep_return.png" alt=""></p><p>å›åˆ°<code>usertrap</code>ï¼Œæˆ‘ä»¬ä¸€è·¯å¾€ä¸‹åˆ°è¾¾<code>usertrapret</code>ï¼Œç„¶åç”¨<code>s</code>è¿›å…¥å®ƒã€‚</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/usertrapret_enter.png" alt=""></p><p>çœ‹å‡½æ•°åä¸Šé¢çš„æ³¨é‡Šå°±èƒ½å‘ç°å®ƒä¼šå¸¦æˆ‘ä»¬å›åˆ°ç”¨æˆ·ç©ºé—´ã€‚</p><p>æˆ‘ä»¬ç”¨<code>n</code>ä¸€è·¯è¿è¡Œåˆ°åº•ï¼Œå†çœ‹çœ‹æ³¨é‡Šï¼Œå‘ç°æ³¨é‡Šè¯´æˆ‘ä»¬ä¼šè·³è½¬åˆ°trampoline.Sã€‚</p><p>è§‚å¯Ÿå·¦è¾¹çš„gdbï¼Œ<code>p /x trampoline_userret</code> æ²¡æœ‰æ‰“å°å€¼æ˜¯å› ä¸ºtrampoline_userretè¢«ç¼–è¯‘å™¨ä¼˜åŒ–æ‰äº†ï¼Œæˆ‘ä»¬è¦æ‰‹åŠ¨æŠŠå®ƒçš„è¡¨è¾¾å¼å†™å‡ºæ¥å†æ‰“å°ï¼Œæ€»ä¹‹æˆ‘ä»¬æ‰“å°å‡ºäº† 0x3ffffff09cã€‚</p><p>åœ¨é‚£é‡Œè®¾ä¸ªæ–­ç‚¹ï¼Œç„¶åå‡†å¤‡ç»§ç»­ã€‚</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/usertrapret_break.png" alt=""></p><p>å¤šæŒ‰å‡ ä¸ª<code>si</code> åˆ°è¾¾è·³è½¬è¯­å¥å¤„ï¼Œä¸å‡ºæ„å¤–çš„è¯å†ç”¨ä¸€æ¬¡<code>si</code> å°±ä¼šå¸¦æˆ‘ä»¬è¿›å…¥trapoline.Sçš„userretéƒ¨åˆ†äº†ã€‚</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/usertrapret_jump.png" alt=""></p><p>ä¸€åˆ‡çš„ä¸€åˆ‡éƒ½ç¬¦åˆé¢„æœŸï¼Œæˆ‘ä»¬æˆåŠŸè¿›å…¥äº†trampoline.Sã€‚</p><p>å¯¹æ¯”å·¦å³çš„æ±‡ç¼–ä»£ç å¯ä»¥å‘ç°å®ƒä»¬æ˜¯å¯¹åº”çš„ã€‚ä¸ä¹‹å‰ç›¸åŒï¼Œ<code>li</code>è¢«å±•å¼€äº†ã€‚</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/trapoline_enter_again.png" alt=""></p><p>ç„¶åæˆ‘ä»¬ä¸€è·¯æŒ‰<code>si</code>åˆ°è¾¾<code>sret</code>è¯­å¥å¤„ã€‚<code>sret</code>ä¼šåšä»€ä¹ˆå‘¢ï¼Ÿè®©æˆ‘ä»¬çœ‹çœ‹riscvæ‰‹å†Œï¼š</p><blockquote><p>The SRET instruction is used to return from a trap taken into S-mode. [â€¦] When executing SRET, the privilege level is set to the value in the SPP field of the sstatus register; [â€¦] the pc is set to the value stored in the sepc register.</p></blockquote><blockquote><p><code>SRET</code> æŒ‡ä»¤ç”¨äºä»è¿›å…¥ S-mode çš„é™·é˜±ä¸­è¿”å›ã€‚[â€¦] å½“æ‰§è¡Œ <code>SRET</code> æ—¶ï¼Œç‰¹æƒçº§åˆ«è¢«è®¾ç½®ä¸º<code>sstatus</code> å¯„å­˜å™¨ä¸­ <code>SPP</code> å­—æ®µçš„å€¼ï¼›[â€¦] ç¨‹åºè®¡æ•°å™¨ pc è¢«è®¾ç½®ä¸ºå­˜å‚¨åœ¨ <code>sepc</code> å¯„å­˜å™¨ä¸­çš„å€¼ã€‚</p></blockquote><p>æˆ‘ä»¬å€ŸåŠ© <code>p /x sepc</code> æ‰“å°è¿™ä¸ªå¯„å­˜å™¨çš„å€¼çœ‹çœ‹~ï¼ˆè¯·å¿½è§†å·¦å›¾é‡Œæˆ‘ä¹‹å‰å†™æˆspecçš„æ‰‹è¯¯ï¼‰</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/trapoline_ret_user.png" alt=""></p><p>0x342æ˜¯ä»€ä¹ˆï¼Ÿå¦‚æœä½ è®°å¿†åŠ›å¾ˆå¥½çš„è¯ï¼Œä¼šå‘ç°å®ƒæ°å¥½å°±æ˜¯usys.Sé‡Œçš„<code>ret</code>é‚£è¡Œï¼</p><p>ï¼ˆè¿™é¬¼æ‰è®°å¾—ä½å•Šå–‚ï¼‰</p><p>æ€»ä¹‹æˆ‘ä»¬çœ‹çœ‹ä¹‹å‰çš„æˆªå›¾å§ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°0x342ç¡®å®æ˜¯reté‚£è¡Œï¼Œå°±æ˜¯ä¸‹é¢çš„æˆªå›¾ä¸­é«˜äº®çš„æ±‡ç¼–ä»£ç ä¸‹é¢é‚£è¡Œã€‚</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/hello_world_again.png" alt=""></p><p>æˆ‘ä»¬ç”¨<code>b *0x342</code>è®¾ä¸ªæ–­ç‚¹åœ¨é‚£é‡Œï¼Œç„¶åæ‰§è¡Œ<code>si</code> ï¼Œæˆ‘ä»¬å›åˆ°äº†ç”¨æˆ·ç©ºé—´ï¼åŒæ—¶ï¼Œ<code>sret</code>ä¹Ÿè®©æˆ‘ä»¬å›åˆ°äº†U-modeã€‚</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/return_to_user.png" alt=""></p><p>ç”¨<code>file user/_sleep</code>åˆ‡æ¢ç¬¦å·è¡¨ï¼Œå†æ‰§è¡Œ<code>si</code>ï¼Œæˆ‘ä»¬å›æ¥äº†ã€‚</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/im_back.png" alt=""></p><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å®Œæˆäº†ä¸€ä¸ªå®Œæ•´çš„ç³»ç»Ÿè°ƒç”¨ã€‚</p><p>æ€»ç»“ä¸€ä¸‹ï¼Œå½“æˆ‘ä»¬è¿›è¡Œç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œæˆ‘ä»¬å…ˆè¿›å…¥usys.Sï¼Œç„¶åecallè§¦å‘å¼‚å¸¸å¹¶è·³è½¬åˆ°trapoline.Sçš„uservecå¤„ï¼Œä¹‹ååˆ°è¾¾trap.cçš„usertrapå‡½æ•°ï¼Œå®ƒä¼šè°ƒç”¨syscallå‡½æ•°ä»¥æ‰§è¡Œç³»ç»Ÿå‡½æ•°çš„é€»è¾‘ï¼Œæ‰§è¡Œå®Œåè¿›å…¥usertrapretå‡½æ•°ï¼Œå†è·³è½¬åˆ°trapoline.Sçš„userretå¤„ï¼Œæœ€åå›åˆ°usys.Sï¼Œå†å›åˆ°ç”¨æˆ·çš„ä»£ç é‡Œã€‚</p><p>ç¬¬ä¸€æ¬¡è·³è½¬åˆ°trapoline.Sä¸»è¦æ˜¯ä¿å­˜äº†ç”¨æˆ·çš„å„ä¸ªå¯„å­˜å™¨åˆ°trapframeï¼Œç¬¬äºŒæ¬¡è·³è½¬æ˜¯ä»trapframeä¸­æ¢å¤äº†è¿™äº›å¯„å­˜å™¨ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;æˆ‘ä»¬çŸ¥é“åº”ç”¨ç¨‹åºåœ¨User modeä¸‹è¿è¡Œï¼Œè€Œç³»ç»Ÿå‡½æ•°çš„æ‰§è¡Œéœ€è¦Supervisor modeï¼Œé‚£åœ¨ç³»ç»Ÿè°ƒç”¨æ—¶ï¼ŒUser modeæ˜¯æ€ä¹ˆè¿›å…¥Supervisor modeçš„å‘¢ï¼Ÿæˆ‘ä»¬ä»¥sleepçš„æ‰§è¡Œä¸ºä¾‹ï¼Œçœ‹çœ‹éƒ½å‘ç”Ÿäº†ä»€ä¹ˆã€‚é¦–å…ˆæˆ‘ä»¬ç”¨ &lt;code&gt;git checkout u</summary>
      
    
    
    
    <category term="å…¬å¼€è¯¾" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/"/>
    
    <category term="MIT-6.S081" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/MIT-6-S081/"/>
    
    <category term="Labs" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/MIT-6-S081/Labs/"/>
    
    
  </entry>
  
  <entry>
    <title>Lab 2 System calls</title>
    <link href="http://rinevard.github.io/wiki/learning/open-course/MIT-6.S081/Labs/lab2-syscall/"/>
    <id>http://rinevard.github.io/wiki/learning/open-course/MIT-6.S081/Labs/lab2-syscall/</id>
    <published>2025-10-15T07:54:38.000Z</published>
    <updated>2025-10-15T08:10:39.024Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬å›é¡¾ä¸€ä¸‹æ€ä¹ˆå¯åŠ¨è°ƒè¯•æ¨¡å¼ï¼š</p><p>åœ¨ä¸€ä¸ªç»ˆç«¯é‡Œæ‰§è¡Œ <code>make qemu-gdb</code> ï¼Œ<code>make qemu-gdb CPUS=1</code> å¯ä»¥åªä½¿ç”¨ä¸€ä¸ªæ ¸å¿ƒï¼Œæ¯”èµ·å¤šçº¿ç¨‹æ›´ä¾¿äºè°ƒè¯•ã€‚</p><p>åœ¨å¦ä¸€ä¸ªç»ˆç«¯é‡Œæ‰§è¡Œ <code>gdb-multiarch kernel/kernel</code> ï¼Œè¿›å…¥ gdb åæ‰§è¡Œ <code>target remote localhost:26001</code>ï¼Œè¿™é‡Œçš„ç«¯å£å·ä¸ä¸€å®šæ˜¯ 26001ï¼Œçœ‹ <code>make qemu-gdb CPUS=1</code> çš„æ‰“å°ç»“æœå°±è¡Œã€‚</p><p>è¿™æ ·å°±è¿›å…¥è°ƒè¯•æ¨¡å¼äº†ã€‚å¦å¤–ï¼Œæˆ‘ä¹ æƒ¯ç”¨ <code>set prompt \001\033[1;33m\002(gdb) \001\033[0m\002</code> æ¥é«˜äº® â€œ(gdb)â€ è¿™å‡ ä¸ªå­—ã€‚</p><h1 id="Using-gdb"><a href="#Using-gdb" class="headerlink" title="Using gdb"></a>Using gdb</h1><p>lab å¼€å¤´è®©æˆ‘ä»¬ç†Ÿæ‚‰ä¸€ä¸‹ gdb çš„ä½¿ç”¨ã€‚å¯åŠ¨è°ƒè¯•æ¨¡å¼ä»¥åæŒ‰éƒ¨å°±ç­å°±èƒ½å®Œæˆï¼Œæˆ‘ä»¬è¿™é‡Œè®°å½•ä¸€ä¸‹å¸¸ç”¨çš„ä¸€äº› gdb æŒ‡ä»¤ï¼š</p><pre class="line-numbers language-none"><code class="language-none">c æˆ– continue - ç»§ç»­æ‰§è¡Œç›´åˆ°é‡åˆ°ä¸‹ä¸€ä¸ªæ–­ç‚¹n æˆ– next - å•æ­¥æ‰§è¡Œ,ä¼šè·³è¿‡å‡½æ•°è°ƒç”¨s æˆ– step - å•æ­¥æ‰§è¡Œ,ä¼šè¿›å…¥å‡½æ•°å†…éƒ¨si - æ‰§è¡Œä¸€æ¡æ±‡ç¼–æŒ‡ä»¤finish - è¿è¡Œåˆ°å½“å‰å‡½æ•°è¿”å›ä¸ºæ­¢p &#x2F;x $mstatus - ä»¥åå…­è¿›åˆ¶æ‰“å°CPUå½“å‰æ¨¡å¼backtraceï¼ˆç¼©å†™btï¼‰ - æ˜¾ç¤ºå‡½æ•°è°ƒç”¨æ ˆset prompt \\001\\033[1;33m\\002(gdb) \\001\\033[0m\\002 - é«˜äº®(gdb)until - è¿è¡Œåˆ°æŒ‡å®šè¡Œå·ä¸ºæ­¢<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="System-call-tracing"><a href="#System-call-tracing" class="headerlink" title="System call tracing"></a>System call tracing</h1><p>è¿™é“é¢˜è®©æˆ‘ä»¬å®ç°ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼ŒæŒ‰ç€ hints æŒ‰éƒ¨å°±ç­å°±èƒ½åšæ‰ã€‚å”¯ä¸€è¦æ³¨æ„çš„æ˜¯åœ¨ syscall é‡Œæ‰“å° trace ç›¸å…³çš„å†…å®¹æ—¶è¦æŠŠç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼ ret ä»åŸæœ¬çš„ <code>uint64</code> è½¬æ¢ä¸º <code>long long</code>ï¼Œå¦åˆ™å¯¹é‚£äº›å¯èƒ½è¿”å› -1 çš„ç³»ç»Ÿè°ƒç”¨ï¼Œæˆ‘ä»¬æ— æ³•æ­£ç¡®æ‰“å° -1.</p><p>åœ¨ç…§ç€ hints å®ç°ä¹‹åï¼Œçœ‹çœ‹ç³»ç»Ÿè°ƒç”¨æ˜¯å¦‚ä½•è¿›è¡Œçš„ä¹Ÿæ˜¯æ›´æœ‰è¶£çš„äº‹æƒ…ã€‚æˆ‘åœ¨ <a href="/wiki/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/" title="Lab 2.1 ç³»ç»Ÿè°ƒç”¨æµç¨‹â€”â€”ä»¥sleepä¸ºä¾‹">Lab 2.1 ç³»ç»Ÿè°ƒç”¨æµç¨‹â€”â€”ä»¥sleepä¸ºä¾‹</a> ä¸­å†™å¾—è¿˜æŒºè¯¦ç»†çš„ï¼Œè¿™é‡Œä¸å¤šèµ˜è¿°ç»†èŠ‚ã€‚</p><p>ç®€è€Œè¨€ä¹‹ï¼Œå½“æˆ‘ä»¬è¿›è¡Œç³»ç»Ÿè°ƒç”¨æ—¶ï¼š</p><ol><li>è¿›å…¥ç”± <code>usys.pl</code> ç”Ÿæˆçš„ <code>usys.S</code> </li><li>ecall è§¦å‘å¼‚å¸¸å¹¶è·³è½¬åˆ° <code>trapoline.S</code> çš„ uservec å¤„</li><li>åˆ°è¾¾ <code>trap.c</code> çš„ usertrap å‡½æ•°ï¼Œå®ƒä¼šè°ƒç”¨ syscall å‡½æ•°ä»¥æ‰§è¡Œç³»ç»Ÿå‡½æ•°çš„é€»è¾‘</li><li>ç³»ç»Ÿå‡½æ•°æ‰§è¡Œå®Œæˆåè¿›å…¥usertrapretå‡½æ•°</li><li>è·³è½¬åˆ° <code>trapoline.S</code> çš„userretå¤„</li><li>æœ€åå›åˆ° <code>usys.S</code></li><li>å›åˆ°ç”¨æˆ·çš„ä»£ç é‡Œã€‚</li></ol><p>è®©æˆ‘ä»¬æ ¹æ®è¿™ä¸ªæµç¨‹æ¥çœ‹çœ‹ hints çš„æ¯ä¸€æ­¥çš„åŸå› ï¼š</p><ol><li>æŠŠ <code>$U/_trace</code> åŠ å…¥åˆ° Makefile ä¸­æ˜¯ä¸ºäº†ç¼–è¯‘æ—¶è¯†åˆ«åˆ° <code>trace</code>ã€‚</li><li>åœ¨ <code>user.h</code> é‡ŒåŠ å…¥ <code>trace</code> æ˜¯ä¸ºäº†è®©ç”¨æˆ·çš„ <code>trace.c</code> è¯†åˆ«åˆ° <code>trace</code> è¿™ä¸ªå‡½æ•°ã€‚</li><li>åœ¨ <code>usys.pl</code> é‡ŒåŠ å…¥ <code>trace</code> æ˜¯ä¸ºäº†è®© <code>usys.pl</code> åœ¨ç”Ÿæˆçš„ <code>usys.S</code> é‡ŒåŠ å…¥ <code>trace</code> ç›¸å…³çš„å†…å®¹ï¼Œå®ƒæ˜¯æˆ‘ä»¬è¿›è¡Œç³»ç»Ÿè°ƒç”¨æ—¶çš„ç¬¬ä¸€ç«™ã€‚</li><li>åœ¨ <code>syscall.h</code> é‡ŒåŠ å…¥ <code>trace</code> æ˜¯å› ä¸ºæˆ‘ä»¬é€šè¿‡å¯„å­˜å™¨é‡Œå­˜å‚¨çš„æ•´æ•°ç¡®å®šè°ƒç”¨çš„ç³»ç»Ÿå‡½æ•°ï¼Œå¾ˆå¤šåœ°æ–¹éƒ½ä½¿ç”¨äº†è¿™ä¸ªæ–‡ä»¶é‡Œå®šä¹‰çš„å¸¸é‡ã€‚</li><li>åœ¨ <code>syscall.c</code> å’Œ <code>sysproc.c</code> é‡ŒåŠ å…¥çš„å‡½æ•°åˆ™æ˜¯å®é™…çš„é€»è¾‘éƒ¨åˆ†ï¼Œç”± syscall å‡½æ•°è°ƒç”¨ã€‚</li></ol><h1 id="Attack-xv6"><a href="#Attack-xv6" class="headerlink" title="Attack xv6"></a>Attack xv6</h1><p>åœ¨ xv6 çš„ syscall åˆ†æ”¯ä¸Šæœ‰ä¸€ä¸ªæ¼æ´â€”â€”è¿›ç¨‹è¢«å›æ”¶åï¼Œå®ƒæ›¾ç»ä½¿ç”¨çš„ç‰©ç†å†…å­˜ä¸ä¼šè¢«é‡ç½®ä¸ºåƒåœ¾æ•°æ®ï¼Œè€Œæ˜¯ä¿æŒä¹‹å‰çš„çŠ¶æ€ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ‰“ç ´å†…å­˜éš”ç¦»ï¼Œè®¿é—®åˆ«çš„å·²ç»è¢«å›æ”¶çš„è¿›ç¨‹çš„å†…å­˜ã€‚</p><p>æˆ‘ä»¬çœ‹å‘ <code>secret.c</code>ï¼Œä¼šå‘ç°å®ƒè¯·æ±‚äº† 32 ä¸ªç‰©ç†é¡µå¤§å°çš„ç‰©ç†å†…å­˜ï¼Œç„¶åæŠŠä¸€ä¸²å­—ç¬¦æ”¾åœ¨äº†æŸä¸ªç‰©ç†é¡µçš„å¼€å¤´ã€‚æ‰€ä»¥æˆ‘ä»¬åªè¦åœ¨ <code>attck.c</code> é‡Œä¹Ÿè¯·æ±‚ä¸€äº›ç‰©ç†é¡µï¼Œç„¶åæ‰¾åˆ°è¿™ä¸²å­—ç¬¦ä¸²å°±è¡Œã€‚</p><p>æˆ‘ä»¬å…ˆè¯·æ±‚ 32 ä¸ªç‰©ç†é¡µç„¶åä¾æ¬¡æ‰“å°å‡ºæ¯ä¸ªç‰©ç†é¡µå¼€å¤´çš„ä¸€ä¸²å­—ç¬¦ï¼Œç»“æœå¦‚ä¸‹ï¼š</p><pre class="line-numbers language-none"><code class="language-none">ç¬¬ 1 é¡µ: ï¿½ï¿½ç¬¬ 2 é¡µ: ï¿½              ç¬¬ 3 é¡µ:  ï¿½ç¬¬ 4 é¡µ: ï¿½ï¿½             ç¬¬ 5 é¡µ: ï¿½ç¬¬ 6 é¡µ: 0ï¿½             ç¬¬ 7 é¡µ:  ï¿½ç¬¬ 8 é¡µ: ï¿½              ç¬¬ 9 é¡µ: ï¿½ï¿½&#x2F;cea.aeç¬¬ 10 é¡µ: @ï¿½7ï¿½Gï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½fï¿½ï¿½ï¿½13ï¿½ï¿½fvâ¦3              ç¬¬ 11 é¡µ: Pï¿½#4ï¿½ï¿½&quot;ï¿½ï¿½ï¿½ï¿½ï¿½&#96;Bdaaï¿½ï¿½qï¿½&quot;ï¿½                                                                                 ï¿½ï¿½ç¬¬ 12 é¡µ: ï¿½ï¿½ï¿½ attackte              ç¬¬ 13 é¡µ: pï¿½ç¬¬ 14 é¡µ: &#96;ï¿½            ç¬¬ 15 é¡µ:  ï¿½ï¿½ï¿½ç¬¬ 16 é¡µ: ï¿½ï¿½7ï¿½Gï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½fï¿½ï¿½ï¿½13ï¿½ï¿½fvâ¦3              ç¬¬ 17 é¡µ: ï¿½ï¿½very very secret pw is: &#x2F;cea.aeç¬¬ 18 é¡µ: ï¿½ï¿½            ç¬¬ 19 é¡µ: pï¿½ç¬¬ 20 é¡µ: 0ï¿½            ç¬¬ 21 é¡µ: 0ï¿½ï¿½ç¬¬ 22 é¡µ: @ï¿½ï¿½           ç¬¬ 23 é¡µ: Pï¿½ï¿½ç¬¬ 24 é¡µ: ï¿½ï¿½            ç¬¬ 25 é¡µ: ï¿½ï¿½ï¿½ç¬¬ 26 é¡µ: Pï¿½            ç¬¬ 27 é¡µ: @ï¿½ç¬¬ 28 é¡µ: 0ï¿½            ç¬¬ 29 é¡µ: ï¿½ï¿½&amp;ï¿½Jï¿½ï¿½ï¿½ï¿½lEï¿½&#96;*&amp;ï¿½Jï¿½               ç¬¬ 31 é¡µ: ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½?ï¿½ï¿½ï¿½ç¬¬ 32 é¡µ: ï¿½ï¿½ï¿½          <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥æ³¨æ„åˆ°å¤§å¤šæ•°éƒ½æ˜¯ä¹±ç ï¼Œè¿™æ˜¯å› ä¸ºå†…å­˜é‡Œæœ‰éæ–‡æœ¬çš„äºŒè¿›åˆ¶æ•°æ®ï¼Œå®ƒä»¬ä¸èƒ½è¢«å½“ä½œæ–‡æœ¬è¾“å‡ºã€‚</p><p>å½“ç„¶ï¼Œæˆ‘ä»¬ä¼šæ³¨æ„åˆ°ç¬¬ 17 é¡µæœ‰ â€œvery very secret pw is: /cea.aeâ€ï¼Œå®ƒä¸ <code>secret.c</code> å†™å…¥çš„å†…å®¹å”¯ä¸€çš„åŒºåˆ«æ˜¯å°‘äº† â€œmy very â€ è¿™å…«ä¸ªå­—ç¬¦ã€‚ä¸ºä»€ä¹ˆä¼šæœ‰å…«ä¸ªå­—ç¬¦çš„å·®å¼‚å‘¢ï¼Ÿ</p><p>çœ‹å‘ <code>kallc.c</code> çš„ <code>kfree</code>ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">kfree</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>pa<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">run</span> <span class="token operator">*</span>r<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>pa <span class="token operator">%</span> PGSIZE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa <span class="token operator">&lt;</span> end <span class="token operator">||</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>pa <span class="token operator">>=</span> PHYSTOP<span class="token punctuation">)</span>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"kfree"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">LAB_SYSCALL</span></span>    <span class="token comment">// Fill with junk to catch dangling refs.</span>    <span class="token function">memset</span><span class="token punctuation">(</span>pa<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>    r <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">run</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa<span class="token punctuation">;</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmem<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    r<span class="token operator">-></span>next <span class="token operator">=</span> kmem<span class="token punctuation">.</span>freelist<span class="token punctuation">;</span>    kmem<span class="token punctuation">.</span>freelist <span class="token operator">=</span> r<span class="token punctuation">;</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmem<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç»“åˆ <code>struct run</code> çš„å®šä¹‰ï¼Œå°±èƒ½çŸ¥é“ <code>r-&gt;next = kmem.freelist</code> è¿™å¥è¯­å¥æ˜¯æŠŠä¸€ä¸ªæŒ‡é’ˆæ”¾åœ¨äº†è¾“å…¥çš„ç‰©ç†åœ°å€çš„å‰å…«ä¸ª bytes ä¸­ã€‚è¿™æ­£æ˜¯ä¹‹å‰å…«ä¸ªå­—ç¬¦çš„å·®å¼‚çš„ç”±æ¥ã€‚</p><p>æ€»ç»“ä¸€ä¸‹ï¼Œåœ¨è¿è¡Œ <code>secret.c</code> çš„è¿›ç¨‹è¢«å›æ”¶åï¼Œå…¶ä¸­åŒ…å« â€œmy very very very secret pw is: /cea.aeâ€ çš„ç‰©ç†é¡µçš„å¼€å¤´å…«ä¸ª bytes è¢«æŒ‡é’ˆè¦†ç›–ï¼Œæ‰€ä»¥åªå‰©ä¸‹äº† â€œ[8 bytes æŒ‡é’ˆ]very very secret pw is: /cea.aeâ€. æ‰€ä»¥æˆ‘ä»¬å¤šè¯·æ±‚å‡ ä¸ªæ–°çš„ç‰©ç†é¡µç„¶åéå†å®ƒä»¬ï¼Œç”¨å‰ç¼€ â€œvery very secret pw is: â€ æ¥åŒ¹é…å°±è¡Œã€‚</p><p>æˆ‘ä»¬åœ¨æ–‡æœ«ä¼šæ›´å…·ä½“åœ°è®²è®²è¿›ç¨‹è¢«å›æ”¶çš„è¿‡ç¨‹ï¼Œä½†å…ˆè®©æˆ‘ä»¬æ¥çœ‹çœ‹ä»£ç ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">strncmp</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>str1<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>str2<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// kalloc.c çš„ kfree å‡½æ•°é‡ŒæŠŠç‰©ç†é¡µçš„å¼€å¤´æ¢æˆäº†ä¸€ä¸ªæŒ‡é’ˆ.</span><span class="token comment">// æ‰€ä»¥æˆ‘ä»¬ä¸¢å¤±äº†å¼€å¤´çš„ sizeof(æŒ‡é’ˆ) ä¸ªå­—ç¬¦.</span><span class="token keyword">const</span> <span class="token keyword">int</span> overwrite_len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>end<span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>prefix <span class="token operator">=</span> <span class="token string">"my very very very secret pw is: "</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> cmplen <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span> <span class="token operator">-</span> overwrite_len<span class="token punctuation">;</span>    <span class="token comment">// éå†æ–°æ’å…¥çš„32ä¸ªç‰©ç†é¡µ</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">32</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        end <span class="token operator">=</span> <span class="token function">sbrk</span><span class="token punctuation">(</span>PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span>end <span class="token operator">+</span> overwrite_len<span class="token punctuation">,</span> prefix <span class="token operator">+</span> overwrite_len<span class="token punctuation">,</span> cmplen<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> end <span class="token operator">+</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡ŒæŠŠå†…å®¹å†™è¿›æ–‡ä»¶æè¿°ç¬¦ 2 æ˜¯å› ä¸º <code>attacktest.c</code> é‡Œå¼€äº†ä¸€ä¸ªç®¡é“ï¼Œè¿è¡Œ <code>attack.c</code> çš„è¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦ 2 è¿æ¥ç€ç®¡é“å†™ç«¯ï¼Œè¿è¡Œ <code>attacktest.c</code> çš„è¿›ç¨‹åˆ™åœ¨è¯»å–ç®¡é“è¯»ç«¯ã€‚ä¸‹é¢çš„ä»£ç å°±æ˜¯æŠŠ <code>attack.c</code> çš„æ–‡ä»¶æè¿°ç¬¦ 2 è¿æ¥åˆ°ç®¡é“å†™ç«¯çš„ä»£ç ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">close</span><span class="token punctuation">(</span>fds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">dup</span><span class="token punctuation">(</span>fds<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>newargv<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"attack"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token function">exec</span><span class="token punctuation">(</span>newargv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> newargv<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"exec %s failed\n"</span><span class="token punctuation">,</span> newargv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="è¿›ç¨‹è¢«å›æ”¶çš„è¿‡ç¨‹"><a href="#è¿›ç¨‹è¢«å›æ”¶çš„è¿‡ç¨‹" class="headerlink" title="è¿›ç¨‹è¢«å›æ”¶çš„è¿‡ç¨‹"></a>è¿›ç¨‹è¢«å›æ”¶çš„è¿‡ç¨‹</h1><p>ä¸€ä¸ªè¿›ç¨‹è°ƒç”¨ exit(int) åä¼šè¿›å…¥ ZOMBIE çŠ¶æ€ï¼Œä½†å¹¶ä¸ç«‹å³é‡Šæ”¾ç‰©ç†å†…å­˜ï¼Œè€Œæ˜¯ä¼šå”¤é†’å…¶çˆ¶è¿›ç¨‹ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token keyword">int</span> status<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// æˆ‘ä»¬åœ¨è¿™é‡Œçœç•¥äº†å¾ˆå¤šä»£ç ï¼Œæœ‰å…´è¶£å¯ä»¥è‡ªå·±çœ‹ proc.c</span>    <span class="token function">wakeup</span><span class="token punctuation">(</span>p<span class="token operator">-></span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>    p<span class="token operator">-></span>state <span class="token operator">=</span> ZOMBIE<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>çˆ¶è¿›ç¨‹è°ƒç”¨ wait(uint64) ä¼šæ‰¾åˆ° ZOMBIE å­è¿›ç¨‹å¹¶è°ƒç”¨ <code>freeproc</code> æ¥å›æ”¶å®ƒï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">wait</span><span class="token punctuation">(</span>uint64 addr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// æˆ‘ä»¬åœ¨è¿™é‡Œçœç•¥äº†å¾ˆå¤šä»£ç ï¼Œæœ‰å…´è¶£å¯ä»¥è‡ªå·±çœ‹ proc.c</span>    <span class="token keyword">struct</span> <span class="token class-name">proc</span> <span class="token operator">*</span>pp<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">proc</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">myproc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>pp <span class="token operator">=</span> proc<span class="token punctuation">;</span> pp <span class="token operator">&lt;</span> <span class="token operator">&amp;</span>proc<span class="token punctuation">[</span>NPROC<span class="token punctuation">]</span><span class="token punctuation">;</span> pp<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>pp<span class="token operator">-></span>parent <span class="token operator">==</span> p <span class="token operator">&amp;&amp;</span> pp<span class="token operator">-></span>state <span class="token operator">==</span> ZOMBIE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// Found one.</span>                pid <span class="token operator">=</span> pp<span class="token operator">-></span>pid<span class="token punctuation">;</span>                <span class="token function">freeproc</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> pid<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// Wait for a child to exit.</span>        <span class="token function">sleep</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wait_lock<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// DOC: wait-sleep</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>freeproc åˆ™åˆè°ƒç”¨ <code>proc_freepagetable</code> æ¥å›æ”¶ç‰©ç†å†…å­˜ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// Free a process's page table, and free the</span><span class="token comment">// physical memory it refers to.</span><span class="token keyword">void</span> <span class="token function">proc_freepagetable</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">,</span> uint64 sz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">uvmunmap</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> TRAMPOLINE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">uvmunmap</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> TRAPFRAME<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">uvmfree</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> sz<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…¶ä¸­çš„ <code>uvmfree(pagetable, sz)</code> å°±åœ¨é‡Šæ”¾ç‰©ç†å†…å­˜äº†ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// Free user memory pages,</span><span class="token comment">// then free page-table pages.</span><span class="token keyword">void</span> <span class="token function">uvmfree</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">,</span> uint64 sz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>sz <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token function">uvmunmap</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">PGROUNDUP</span><span class="token punctuation">(</span>sz<span class="token punctuation">)</span> <span class="token operator">/</span> PGSIZE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">freewalk</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è®©æˆ‘ä»¬çœ‹å‘ <code>uvmunmap</code>ï¼Œå®ƒè·å–æ¯ä¸€é¡µçš„ç‰©ç†åœ°å€ç„¶åè°ƒç”¨ <code>kfree</code>ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// Remove npages of mappings starting from va. va must be</span><span class="token comment">// page-aligned. The mappings must exist.</span><span class="token comment">// Optionally free the physical memory.</span><span class="token keyword">void</span> <span class="token function">uvmunmap</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">,</span> uint64 va<span class="token punctuation">,</span> uint64 npages<span class="token punctuation">,</span> <span class="token keyword">int</span> do_free<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    uint64 a<span class="token punctuation">;</span>    <span class="token class-name">pte_t</span> <span class="token operator">*</span>pte<span class="token punctuation">;</span>    <span class="token keyword">int</span> sz<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>va <span class="token operator">%</span> PGSIZE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmunmap: not aligned"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>a <span class="token operator">=</span> va<span class="token punctuation">;</span> a <span class="token operator">&lt;</span> va <span class="token operator">+</span> npages <span class="token operator">*</span> PGSIZE<span class="token punctuation">;</span> a <span class="token operator">+=</span> sz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        sz <span class="token operator">=</span> PGSIZE<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pte <span class="token operator">=</span> <span class="token function">walk</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmunmap: walk"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"va=%ld pte=%ld\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmunmap: not mapped"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PTE_FLAGS</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span> <span class="token operator">==</span> PTE_V<span class="token punctuation">)</span>            <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmunmap: not a leaf"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>do_free<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            uint64 pa <span class="token operator">=</span> <span class="token function">PTE2PA</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">kfree</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token operator">*</span>pte <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ›´ç»†èŠ‚çš„é‡Šæ”¾ trapframeã€é‡Šæ”¾é¡µè¡¨æˆ‘ä»¬å°±ä¸åœ¨è¿™é‡Œå¤šè¯´äº†ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬å›é¡¾ä¸€ä¸‹æ€ä¹ˆå¯åŠ¨è°ƒè¯•æ¨¡å¼ï¼š&lt;/p&gt;
&lt;p&gt;åœ¨ä¸€ä¸ªç»ˆç«¯é‡Œæ‰§è¡Œ &lt;code&gt;make qemu-gdb&lt;/code&gt; ï¼Œ&lt;code&gt;make qemu-gdb CPUS=1&lt;/code&gt; å¯ä»¥åªä½¿ç”¨ä¸€ä¸ªæ ¸å¿ƒï¼Œæ¯”èµ·å¤šçº¿ç¨‹æ›´ä¾¿äºè°ƒè¯•ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨å¦ä¸€ä¸ªç»ˆç«¯é‡Œæ‰§</summary>
      
    
    
    
    <category term="å…¬å¼€è¯¾" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/"/>
    
    <category term="MIT-6.S081" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/MIT-6-S081/"/>
    
    <category term="Labs" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/MIT-6-S081/Labs/"/>
    
    
  </entry>
  
  <entry>
    <title>æ¢ç´¢æ—¥å¿—[1]</title>
    <link href="http://rinevard.github.io/wiki/others/thoughts/%E6%8E%A2%E7%B4%A2%E6%97%A5%E5%BF%971/"/>
    <id>http://rinevard.github.io/wiki/others/thoughts/%E6%8E%A2%E7%B4%A2%E6%97%A5%E5%BF%971/</id>
    <published>2025-10-13T12:11:11.000Z</published>
    <updated>2025-10-27T13:34:23.367Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸çŸ¥é“äººä»¬å¹³å¸¸æ˜¯æ€æ ·ä¸ä»–äººç›¸è¯†çš„ã€‚è®¸ä¹…ä»¥å‰æˆ‘å°±åœ¨æƒ³ï¼Œè‡ªå·±çš„ç¤¾äº¤æ–¹å¼æ˜¯å¦æœ‰ç‚¹ä¸å¤ªåƒä¸€èˆ¬äººç±»ğŸ« ğŸ« å’±æ›´åå¥½é‚£ç§â€œå¤§å®¶ä¸€èµ·åšä¸€ä»¶éƒ½æ„Ÿå…´è¶£çš„äº‹æƒ…ç„¶åæ¸æ¸å°±è®¤è¯†äº†â€çš„ç¤¾äº¤æ–¹å¼ï¼Œä½†ä¼¼ä¹è¿™ç§åšæ³•ç›¸å¯¹å°‘è§ï¼Œè€Œä¸”æˆ‘ä»¥å‰ä¹Ÿæ²¡æ€ä¹ˆå› æ­¤è®¤è¯†åˆ°æ–°æœ‹å‹ã€‚</p><p>åœ¨ä¸çŸ­çš„è´¨ç–‘æœŸåï¼Œæ¸æ¸åœ°ä¹Ÿå‘ç°è‡ªå·±ä¹Ÿæ˜¯èƒ½ç”¨è¿™ç§æ–¹æ³•äº¤åˆ°æœ‹å‹çš„ï¼Œè‡³å°‘æ˜¯èƒ½ç»“è¯†äººç±»çš„ã€‚æ¯”å¦‚è¯´è¿™æ¬¡çš„æ¢ç´¢æ—¥å¿—å°±å’Œ GMTK Jam åœ¨å°çº¢ä¹¦æ‹‰åˆ°çš„ç¾æœ¯åŒå­¦æœ‰å…³ï¼ˆèµç¾å°çº¢ä¹¦å–µ</p><p>â€œæˆ‘å¯¹æ™®é€šçš„äººç±»æ²¡æœ‰å…´è¶£ã€‚ä½ ä»¬ä¹‹ä¸­å¦‚æœæœ‰ç”»ç”»äººã€éŸ³ä¹äººã€éŸ³æ•ˆäººæˆ–è€…å¼‚ä¸–ç•Œäººå°±æ¥æ‰¾æˆ‘å§ï¼â€è™½ç„¶æˆ‘ä¸æ˜¯è¿™ä¹ˆæ‹‰äººçš„ï¼ˆæ²¡äººä¼šè¿™ä¹ˆæ‹‰äººå§ï¼ï¼‰ï¼Œä½†æ€»ä¹‹å°±æ˜¯æ‹‰åˆ°äº†è¿™ä½ä¸­ä¼ çš„ç¾æœ¯åŒå­¦ä¸€èµ·æ¥gamejamï¼Œè¿™æ˜¯å…«æœˆçš„äº‹äº†ã€‚</p><p>ä»Šå¤©é¹°è§’åœ¨ä¸­ä¼ å¼€äº†ä¸ªå®£è®²ä¼šï¼Œå’±ä½œä¸ºèµ„æ·±ç²¥ç²¥äººå½“ç„¶æƒ³å»å¬å¬çœ‹ã€‚è®¿å®¢è¿›ä¸­ä¼ éœ€è¦æ‰¾æ ¡å†…åŒå­¦æˆ–è€å¸ˆé¢„çº¦ï¼Œäºæ˜¯å’±å°±æ‰¾äº†è¿™ä½ç¾æœ¯åŒå­¦ç„¶åæˆåŠŸè¿›å…¥ä¸­ä¼ äº†ã€‚</p><p><img src="/images/others/random_thoughts/explore1/cuc_arknights.jpg" alt=""></p><p>ä¸€èˆ¬æ¥è¯´æ•…äº‹åº”è¯¥è·Œå®•èµ·ä¼ï¼Œæ¯”æ–¹è¯´æˆ‘ä»¬èµ·ç è¦å†™å†™åœ¨ä¸­ä¼ é‡åˆ°çš„è¶£äº‹ï¼Œç„¶åå†™å†™æœ‰ä»€ä¹ˆç³Ÿç³•çš„åœ°æ–¹ï¼Œç„¶åå†åä¸½æ”¶åœºï¼Œä¸è¿‡äº‹æƒ…å°±æ˜¯å¾ˆå¹³å¹³æ·¡æ·¡ã€‚é¹°è§’çš„å®£è®²ä¼šå¾ˆæ™®é€šï¼Œè™½ç„¶å‘äº†ç‚¹å‘¨è¾¹ä½†æˆ‘å¹¶æ²¡æœ‰æŠ½ä¸­æœ‰è¶£çš„å¥–å“ï¼Œä¸­ä¼ çš„é¥­æ¯”åŒ—ç†çš„å¥½åƒï¼Œä½†å¥½åƒå¾—ä¸å¤šã€‚</p><p><img src="/images/others/random_thoughts/explore1/cuc_food.jpg" alt=""></p><p>å¯æˆ‘ç¡®å®ä»æ¥æ²¡æœ‰å»å¤–æ ¡ç©çš„ç»å†ï¼Œæ›´åˆ«è¯´è¦æ‰¾å¤–æ ¡åŒå­¦é¢„çº¦æ‰èƒ½è¿›çš„å­¦æ ¡äº†ğŸ« ğŸ« å’±èƒ½ä»ç¤¾æè¿›åŒ–æˆç°åœ¨è¿™æ ·èƒ½ä¸»åŠ¨æ‹‰äººç»„é˜Ÿè¿˜èƒ½è”ç³»åˆ«äººå·²ç»å¾ˆå¥½äº†ä¸æ˜¯å—ï¼ˆï¼‰</p><p>æ¢ç´¢ä¹Ÿä¸æ˜¯æ¬¡æ¬¡æœ‰è¶£ï¼Œå€’ä¸å¦‚è¯´æ¢ç´¢çš„ç»“æœæ™®æ™®é€šé€šæ‰æ˜¯ç†æ‰€åº”å½“çš„å§ã€‚ç°åœ¨æ˜¯æ™šä¸Šåç‚¹äº”ååˆ†ï¼Œæˆ‘åœ¨è‰¯ä¹¡å¤§å­¦åŸåŒ—çš„åœ°é“ç«™æ²¡æœ‰æ‘†æ¸¡è½¦ï¼Œè¦éª‘è½¦å›å­¦æ ¡äº†ã€‚</p><p><img src="/images/others/random_thoughts/explore1/cuc_tree.jpg" alt=""></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;ä¸çŸ¥é“äººä»¬å¹³å¸¸æ˜¯æ€æ ·ä¸ä»–äººç›¸è¯†çš„ã€‚è®¸ä¹…ä»¥å‰æˆ‘å°±åœ¨æƒ³ï¼Œè‡ªå·±çš„ç¤¾äº¤æ–¹å¼æ˜¯å¦æœ‰ç‚¹ä¸å¤ªåƒä¸€èˆ¬äººç±»ğŸ« ğŸ« å’±æ›´åå¥½é‚£ç§â€œå¤§å®¶ä¸€èµ·åšä¸€ä»¶éƒ½æ„Ÿå…´è¶£çš„äº‹æƒ…ç„¶åæ¸æ¸å°±è®¤è¯†äº†â€çš„ç¤¾äº¤æ–¹å¼ï¼Œä½†ä¼¼ä¹è¿™ç§åšæ³•ç›¸å¯¹å°‘è§ï¼Œè€Œä¸”æˆ‘ä»¥å‰ä¹Ÿæ²¡æ€ä¹ˆå› æ­¤è®¤è¯†åˆ°æ–°æœ‹å‹ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨ä¸çŸ­çš„è´¨ç–‘æœŸåï¼Œæ¸æ¸åœ°ä¹Ÿå‘ç°</summary>
      
    
    
    
    <category term="æ‚è°ˆ" scheme="http://rinevard.github.io/categories/%E6%9D%82%E8%B0%88/"/>
    
    <category term="ç¢ç¢å¿µ" scheme="http://rinevard.github.io/categories/%E6%9D%82%E8%B0%88/%E7%A2%8E%E7%A2%8E%E5%BF%B5/"/>
    
    
  </entry>
  
  <entry>
    <title>Assignment 7 Path Tracing</title>
    <link href="http://rinevard.github.io/wiki/learning/open-course/GAMES101/Hw/Hw7-path-tracing/"/>
    <id>http://rinevard.github.io/wiki/learning/open-course/GAMES101/Hw/Hw7-path-tracing/</id>
    <published>2025-10-10T14:10:44.000Z</published>
    <updated>2025-10-10T15:04:14.905Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¤§è‡´æµç¨‹"><a href="#å¤§è‡´æµç¨‹" class="headerlink" title="å¤§è‡´æµç¨‹"></a>å¤§è‡´æµç¨‹</h1><p>è¿™æ¬¡çš„ä½œä¸šæŒºéš¾çš„ã€‚é¦–å…ˆæˆ‘ä»¬æ¥å¯¹ç…§å…¬å¼è§£é‡Šä¸€ä¸‹å¤§è‡´çš„ä»£ç æµç¨‹ï¼š</p><p>$$<br>\begin{align*}<br>L_o(p, \vec{\omega_o})<br>= &amp;L_e(p, \vec{\omega_o}) + \int_{\Omega} f_r(p, \vec{\omega_i}, \vec{\omega_o}) L_i(p, \vec{\omega_i}) (\vec{\omega_i} \cdot n) d\omega_i<br>\<br>= &amp;L_e(p, \vec{\omega_o}) + \int_{\Omega_{å…‰æºæ–¹å‘}} f_r(p, \vec{\omega_i}, \vec{\omega_o}) L_i(p, \vec{\omega_i}) (\vec{\omega_i} \cdot n) d\omega_i<br>\<br>&amp;+ \int_{\Omega_{éå…‰æºæ–¹å‘}} f_r(p, \vec{\omega_i}, \vec{\omega_o}) L_i(p, \vec{\omega_i}) (\vec{\omega_i} \cdot n) d\omega_i</p><p>\end{align*}<br>$$</p><ol><li>å¦‚æœç‚¹ $p$ æ˜¯å…‰æºï¼Œç›´æ¥è¿”å›å…¶è‡ªå‘å…‰é¡¹ $L_e$.</li><li>éšæœºé‡‡æ ·ä¸€ä¸ªå…‰æºæ–¹å‘ $w_s$ï¼Œæ ¹æ®å…¬å¼è®¡ç®— $L_\text{direct}$.</li><li><p>éšæœºé‡‡æ ·ä¸€ä¸ªæ–¹å‘ $w_i$ï¼ŒæŒ‰è½®ç›˜èµŒå†³å®šæ˜¯å¦ç»“æŸå¼¹å°„ã€‚</p><p> å¦‚æœä¸ç»“æŸä¸” $w_i$ æ²¡æ‰“åˆ°å…‰æºï¼Œæ ¹æ®å…¬å¼è®¡ç®— $L_\text{indirect}$.</p></li><li><p>è¿”å› $L_\text{direct}+L_\text{indirect}$</p></li></ol><p>ç„¶åæ”¾ä»£ç ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">Vector3f <span class="token class-name">Scene</span><span class="token double-colon punctuation">::</span><span class="token function">castRay</span><span class="token punctuation">(</span><span class="token keyword">const</span> Ray <span class="token operator">&amp;</span>ray<span class="token punctuation">,</span> <span class="token keyword">int</span> depth<span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">&#123;</span>    Intersection shade_point_inter <span class="token operator">=</span> <span class="token function">intersect</span><span class="token punctuation">(</span>ray<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shade_point_inter<span class="token punctuation">.</span>happened<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token function">Vector3f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// ----------------Contribution from emission----------------</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>shade_point_inter<span class="token punctuation">.</span>m<span class="token operator">-></span><span class="token function">hasEmission</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// Light source doesn't reflect light, so we return here</span>        <span class="token keyword">return</span> shade_point_inter<span class="token punctuation">.</span>m<span class="token operator">-></span><span class="token function">getEmission</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// ----------------Contribution from the light source----------------</span>    Vector3f wo <span class="token operator">=</span> <span class="token operator">-</span><span class="token function">normalize</span><span class="token punctuation">(</span>ray<span class="token punctuation">.</span>direction<span class="token punctuation">)</span><span class="token punctuation">;</span>    Vector3f normal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>shade_point_inter<span class="token punctuation">.</span>normal<span class="token punctuation">)</span><span class="token punctuation">;</span>    Vector3f l_direct <span class="token operator">=</span> <span class="token function">Vector3f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Intersection light_sample<span class="token punctuation">;</span>    <span class="token keyword">float</span> pdf_light<span class="token punctuation">;</span>    <span class="token function">sampleLight</span><span class="token punctuation">(</span>light_sample<span class="token punctuation">,</span> pdf_light<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// If the ray is not blocked in the middle, compute its contribution</span>    Vector3f light_normal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>light_sample<span class="token punctuation">.</span>normal<span class="token punctuation">)</span><span class="token punctuation">;</span>    Vector3f shade_point <span class="token operator">=</span> shade_point_inter<span class="token punctuation">.</span>coords<span class="token punctuation">;</span>    Vector3f ws <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>light_sample<span class="token punctuation">.</span>coords <span class="token operator">-</span> shade_point<span class="token punctuation">)</span><span class="token punctuation">;</span>    Vector3f direct_ray_origin <span class="token operator">=</span> shade_point <span class="token operator">+</span> ws <span class="token operator">*</span> EPSILON<span class="token punctuation">;</span>    Ray <span class="token function">ray_to_light</span><span class="token punctuation">(</span>direct_ray_origin<span class="token punctuation">,</span> ws<span class="token punctuation">)</span><span class="token punctuation">;</span>    Intersection inter_between_light <span class="token operator">=</span> <span class="token function">intersect</span><span class="token punctuation">(</span>ray_to_light<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>inter_between_light<span class="token punctuation">.</span>happened<span class="token punctuation">)</span> <span class="token operator">||</span> inter_between_light<span class="token punctuation">.</span>distance <span class="token operator">></span> <span class="token punctuation">(</span>light_sample<span class="token punctuation">.</span>coords <span class="token operator">-</span> direct_ray_origin<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">norm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> EPSILON<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        l_direct <span class="token operator">=</span> light_sample<span class="token punctuation">.</span>emit <span class="token operator">*</span> shade_point_inter<span class="token punctuation">.</span>m<span class="token operator">-></span><span class="token function">eval</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> wo<span class="token punctuation">,</span> normal<span class="token punctuation">)</span> \        <span class="token operator">*</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token function">dotProduct</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> normal<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">)</span> <span class="token operator">*</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token function">dotProduct</span><span class="token punctuation">(</span><span class="token operator">-</span>ws<span class="token punctuation">,</span> light_normal<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">)</span> \        <span class="token operator">/</span> std<span class="token double-colon punctuation">::</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token punctuation">(</span>light_sample<span class="token punctuation">.</span>coords <span class="token operator">-</span> direct_ray_origin<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">norm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> pdf_light<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// ----------------Contribution from other reflectors----------------</span>    Vector3f l_indirect <span class="token operator">=</span> <span class="token function">Vector3f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// Russian Roulette test</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">get_random_float</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> RussianRoulette<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        Vector3f wi <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>shade_point_inter<span class="token punctuation">.</span>m<span class="token operator">-></span><span class="token function">sample</span><span class="token punctuation">(</span>wo<span class="token punctuation">,</span> normal<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Vector3f indirect_ray_origin <span class="token operator">=</span> shade_point <span class="token operator">+</span> wi <span class="token operator">*</span> EPSILON<span class="token punctuation">;</span>        Ray <span class="token function">reflected_ray</span><span class="token punctuation">(</span>indirect_ray_origin<span class="token punctuation">,</span> wi<span class="token punctuation">)</span><span class="token punctuation">;</span>        Intersection reflected_inter <span class="token operator">=</span> <span class="token function">intersect</span><span class="token punctuation">(</span>reflected_ray<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// If reflected_ray hitting a non-emitting object, compute its contribution </span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>reflected_inter<span class="token punctuation">.</span>happened <span class="token operator">&amp;&amp;</span> reflected_inter<span class="token punctuation">.</span>m<span class="token operator">-></span><span class="token function">hasEmission</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            l_indirect <span class="token operator">=</span> <span class="token function">Vector3f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            l_indirect <span class="token operator">=</span> <span class="token function">castRay</span><span class="token punctuation">(</span>reflected_ray<span class="token punctuation">,</span> depth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> shade_point_inter<span class="token punctuation">.</span>m<span class="token operator">-></span><span class="token function">eval</span><span class="token punctuation">(</span>wi<span class="token punctuation">,</span> wo<span class="token punctuation">,</span> normal<span class="token punctuation">)</span> \            <span class="token operator">*</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token function">dotProduct</span><span class="token punctuation">(</span>wi<span class="token punctuation">,</span> normal<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">)</span> \            <span class="token operator">/</span> <span class="token punctuation">(</span>shade_point_inter<span class="token punctuation">.</span>m<span class="token operator">-></span><span class="token function">pdf</span><span class="token punctuation">(</span>wi<span class="token punctuation">,</span> wo<span class="token punctuation">,</span> normal<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> RussianRoulette<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> l_direct <span class="token operator">+</span> l_indirect<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å†æ¥çœ‹çœ‹å›¾</p><p><img src="/images/learning/open-course/GAMES101/Assignments/hw7/screenshot.png" alt=""></p><h1 id="ä»£ç ç»†èŠ‚"><a href="#ä»£ç ç»†èŠ‚" class="headerlink" title="ä»£ç ç»†èŠ‚"></a>ä»£ç ç»†èŠ‚</h1><p>æ¥ä¸‹æ¥æˆ‘ä»¬å†èŠèŠå…·ä½“çš„ä»£ç ç»†èŠ‚ã€‚è‡ªå‘å…‰é¡¹æ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬ç•¥è¿‡ã€‚</p><h2 id="L-text-direct"><a href="#L-text-direct" class="headerlink" title="$L_\text{direct}$"></a>$L_\text{direct}$</h2><p>ç›´æ¥å…‰éƒ¨åˆ†ã€‚é¦–å…ˆè¦æ³¨æ„çš„æ˜¯ï¼Œå„ä¸ªå°„çº¿ $w_i, w_o, w_s$ éƒ½æ˜¯ä»ç€è‰²ç‚¹æŒ‡å‘å¤–çš„å•ä½æ–¹å‘å‘é‡ã€‚è¿™æ˜¯ä¸€ä¸ªå›¾å½¢å­¦é‡Œå¸¸ç”¨çš„çº¦å®šï¼Œæ‰€ä»¥ä¸è¦é—®ä¸ºä»€ä¹ˆä¸æ˜¯æŒ‡å‘å†…äº†ï¼ˆï¼‰</p><p><img src="/images/learning/open-course/GAMES101/Assignments/hw7/wiwodir.png" alt=""></p><p>ç„¶ååœ¨å‘å‡ºå°„çº¿æ—¶ï¼Œæœ€å¥½åšä¸€ä¸ªå¾®å°çš„åç§»ä»¥é¿å…å‘å‡ºçš„å°„çº¿å’Œç€è‰²ç‚¹å¹³é¢ç›¸äº¤ã€‚è¿™å°±æ˜¯æˆ‘ä»¬ <code>direct_ray_origin = shade_point + ws * EPSILON</code> åšäº†åŠ æ³•çš„åŸå› ã€‚</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">Vector3f wo <span class="token operator">=</span> <span class="token operator">-</span><span class="token function">normalize</span><span class="token punctuation">(</span>ray<span class="token punctuation">.</span>direction<span class="token punctuation">)</span><span class="token punctuation">;</span>Vector3f normal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>shade_point_inter<span class="token punctuation">.</span>normal<span class="token punctuation">)</span><span class="token punctuation">;</span>Vector3f l_direct <span class="token operator">=</span> <span class="token function">Vector3f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Intersection light_sample<span class="token punctuation">;</span><span class="token keyword">float</span> pdf_light<span class="token punctuation">;</span><span class="token function">sampleLight</span><span class="token punctuation">(</span>light_sample<span class="token punctuation">,</span> pdf_light<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// If the ray is not blocked in the middle, compute its contribution</span>Vector3f light_normal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>light_sample<span class="token punctuation">.</span>normal<span class="token punctuation">)</span><span class="token punctuation">;</span>Vector3f shade_point <span class="token operator">=</span> shade_point_inter<span class="token punctuation">.</span>coords<span class="token punctuation">;</span>Vector3f ws <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>light_sample<span class="token punctuation">.</span>coords <span class="token operator">-</span> shade_point<span class="token punctuation">)</span><span class="token punctuation">;</span>Vector3f direct_ray_origin <span class="token operator">=</span> shade_point <span class="token operator">+</span> ws <span class="token operator">*</span> EPSILON<span class="token punctuation">;</span>Ray <span class="token function">ray_to_light</span><span class="token punctuation">(</span>direct_ray_origin<span class="token punctuation">,</span> ws<span class="token punctuation">)</span><span class="token punctuation">;</span>Intersection inter_between_light <span class="token operator">=</span> <span class="token function">intersect</span><span class="token punctuation">(</span>ray_to_light<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>inter_between_light<span class="token punctuation">.</span>happened<span class="token punctuation">)</span> <span class="token operator">||</span> inter_between_light<span class="token punctuation">.</span>distance <span class="token operator">></span> <span class="token punctuation">(</span>light_sample<span class="token punctuation">.</span>coords <span class="token operator">-</span> direct_ray_origin<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">norm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> EPSILON<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    l_direct <span class="token operator">=</span> light_sample<span class="token punctuation">.</span>emit <span class="token operator">*</span> shade_point_inter<span class="token punctuation">.</span>m<span class="token operator">-></span><span class="token function">eval</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> wo<span class="token punctuation">,</span> normal<span class="token punctuation">)</span> \    <span class="token operator">*</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token function">dotProduct</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> normal<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">)</span> <span class="token operator">*</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token function">dotProduct</span><span class="token punctuation">(</span><span class="token operator">-</span>ws<span class="token punctuation">,</span> light_normal<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">)</span> \    <span class="token operator">/</span> std<span class="token double-colon punctuation">::</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token punctuation">(</span>light_sample<span class="token punctuation">.</span>coords <span class="token operator">-</span> direct_ray_origin<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">norm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> pdf_light<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦å¤–ï¼Œæˆ‘ä»¬æœ‰ä»å…‰æºé‡‡æ ·è®¡ç®—ç›´æ¥å…‰çš„å…¬å¼ï¼š</p><p>$$<br>\begin{align*}<br>&amp;\int_{\Omega_{å…‰æºæ–¹å‘}} f_r(p, \vec{\omega_i}, \vec{\omega_o}) L_i(p, \vec{\omega_i}) (\vec{\omega_i} \cdot n) d\omega_i<br>\<br>=&amp;\int_{A} f_r(p, \vec{\omega_i}, \vec{\omega_o}) L_i(p, \vec{\omega_i}) \frac{\cos\theta\cos\theta_i}{\lVert pâ€™-p \rVert^2} dA </p><p>\end{align*}<br>$$</p><p>ç”¨è’™ç‰¹å¡ç½—è¿‘ä¼¼å°±æ˜¯ä»£ç é‡Œå†™çš„ä¸œè¥¿äº†ã€‚</p><p><img src="/images/learning/open-course/GAMES101/Assignments/hw7/nee.png" alt=""></p><h2 id="L-text-indirect"><a href="#L-text-indirect" class="headerlink" title="$L_\text{indirect}$"></a>$L_\text{indirect}$</h2><p>é—´æ¥éƒ¨åˆ†ã€‚é¦–å…ˆè¦åšä¿„ç½—æ–¯è½®ç›˜èµŒï¼Œç„¶åè¦æ£€æŸ¥æ‰“åˆ°çš„æ˜¯å¦æ˜¯å…‰æºã€‚</p><p>å¦‚æœé€šè¿‡äº†è½®ç›˜èµŒï¼Œè€Œä¸”æ‰“åˆ°çš„ä¸æ˜¯å…‰æºï¼Œå°±è¦è®¡ç®—é—´æ¥å…‰ã€‚</p><p>ä¸ç›´æ¥å…‰ä¸€æ ·ï¼Œæˆ‘ä»¬è¦åšå¾®å°åç§»ï¼Œè¿™å°±æ˜¯ <code>indirect_ray_origin = shade_point + wi * EPSILON</code> .</p><p>ç„¶åå¥—å…¬å¼å°±è¡Œã€‚</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">Vector3f l_indirect <span class="token operator">=</span> <span class="token function">Vector3f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Russian Roulette test</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">get_random_float</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> RussianRoulette<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    Vector3f wi <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>shade_point_inter<span class="token punctuation">.</span>m<span class="token operator">-></span><span class="token function">sample</span><span class="token punctuation">(</span>wo<span class="token punctuation">,</span> normal<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Vector3f indirect_ray_origin <span class="token operator">=</span> shade_point <span class="token operator">+</span> wi <span class="token operator">*</span> EPSILON<span class="token punctuation">;</span>    Ray <span class="token function">reflected_ray</span><span class="token punctuation">(</span>indirect_ray_origin<span class="token punctuation">,</span> wi<span class="token punctuation">)</span><span class="token punctuation">;</span>    Intersection reflected_inter <span class="token operator">=</span> <span class="token function">intersect</span><span class="token punctuation">(</span>reflected_ray<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// If reflected_ray hitting a non-emitting object, compute its contribution </span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>reflected_inter<span class="token punctuation">.</span>happened <span class="token operator">&amp;&amp;</span> reflected_inter<span class="token punctuation">.</span>m<span class="token operator">-></span><span class="token function">hasEmission</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        l_indirect <span class="token operator">=</span> <span class="token function">Vector3f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        l_indirect <span class="token operator">=</span> <span class="token function">castRay</span><span class="token punctuation">(</span>reflected_ray<span class="token punctuation">,</span> depth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> shade_point_inter<span class="token punctuation">.</span>m<span class="token operator">-></span><span class="token function">eval</span><span class="token punctuation">(</span>wi<span class="token punctuation">,</span> wo<span class="token punctuation">,</span> normal<span class="token punctuation">)</span> \        <span class="token operator">*</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token function">dotProduct</span><span class="token punctuation">(</span>wi<span class="token punctuation">,</span> normal<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">)</span> \        <span class="token operator">/</span> <span class="token punctuation">(</span>shade_point_inter<span class="token punctuation">.</span>m<span class="token operator">-></span><span class="token function">pdf</span><span class="token punctuation">(</span>wi<span class="token punctuation">,</span> wo<span class="token punctuation">,</span> normal<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> RussianRoulette<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç»“æœå¯¹ EPSILON æŒºæ•æ„Ÿçš„ï¼Œå¯ä»¥æŠŠ EPSILON é€‚å½“è°ƒå¤§ç‚¹ï¼Œæˆ‘ç”¨çš„æ˜¯ <code>0.00020</code> .</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;å¤§è‡´æµç¨‹&quot;&gt;&lt;a href=&quot;#å¤§è‡´æµç¨‹&quot; class=&quot;headerlink&quot; title=&quot;å¤§è‡´æµç¨‹&quot;&gt;&lt;/a&gt;å¤§è‡´æµç¨‹&lt;/h1&gt;&lt;p&gt;è¿™æ¬¡çš„ä½œä¸šæŒºéš¾çš„ã€‚é¦–å…ˆæˆ‘ä»¬æ¥å¯¹ç…§å…¬å¼è§£é‡Šä¸€ä¸‹å¤§è‡´çš„ä»£ç æµç¨‹ï¼š&lt;/p&gt;
&lt;p&gt;$$&lt;br&gt;&#92;begin{align*}&lt;br&gt;</summary>
      
    
    
    
    <category term="å…¬å¼€è¯¾" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/"/>
    
    <category term="GAMES101" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/GAMES101/"/>
    
    <category term="Assignments" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/GAMES101/Assignments/"/>
    
    
  </entry>
  
  <entry>
    <title>Note 6 BRDF and Rendering Eequation</title>
    <link href="http://rinevard.github.io/wiki/learning/open-course/GAMES101/Notes/Note6-BRDF-and-renderingequation/"/>
    <id>http://rinevard.github.io/wiki/learning/open-course/GAMES101/Notes/Note6-BRDF-and-renderingequation/</id>
    <published>2025-10-10T13:45:28.000Z</published>
    <updated>2025-10-10T14:49:51.245Z</updated>
    
    <content type="html"><![CDATA[<p>æˆ‘ä»¬ä¹‹å‰å·²ç»å­¦è¿‡äº† Blinn-Phong å…‰ç…§æ¨¡å‹ï¼Œä½†å®ƒåªæ˜¯ä¸€ä¸ªå¯å‘å¼æ¨¡å‹ï¼Œåœ¨ç‰©ç†ä¸Šæ˜¯ä¸æ­£ç¡®çš„ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ç‰©ç†ä¸Šæ­£ç¡®çš„å…‰ç…§æ˜¯æ€æ ·çš„ï¼Œä»¥åŠå¦‚ä½•ç”¨è®¡ç®—æœºè¿‘ä¼¼æ±‚è§£æ¥è¿‘æ­£ç¡®çš„å…‰ç…§ã€‚</p><h1 id="è¾å°„åº¦é‡å­¦"><a href="#è¾å°„åº¦é‡å­¦" class="headerlink" title="è¾å°„åº¦é‡å­¦"></a>è¾å°„åº¦é‡å­¦</h1><p>åœ¨äº†è§£å…‰ç…§çš„ç‰©ç†æ¨¡å‹ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ä¸€äº›ç‰©ç†é‡ã€‚æœ€å…³é”®çš„ç‰©ç†é‡æœ‰å››ä¸ªï¼Œåˆ†åˆ«æ˜¯</p><ol><li>Radiant flux/power $\Phi$ï¼Œå•ä½ $W$.</li><li>Radiant intensity $I$ï¼Œå•ä½ $\frac{W}{\text{sr}}$.</li><li>Irradiance $E$ï¼Œå•ä½ $\frac{W}{m^2}$.</li><li>Radiance $L$ï¼Œå•ä½ $\frac{W}{\text{sr}\cdot m^2}$.</li></ol><p>æ¥ä¸‹æ¥è®©æˆ‘ä»¬çœ‹çœ‹å®ƒä»¬çš„å…·ä½“å®šä¹‰ã€‚</p><h2 id="Radiant-flux-power-Phi"><a href="#Radiant-flux-power-Phi" class="headerlink" title="Radiant flux/power $\Phi$"></a>Radiant flux/power $\Phi$</h2><p>Radiant flux/power ç¬¦å· $\Phi$ï¼Œå•ä½ $W$.</p><p>å®šä¹‰ä¸º</p><p>$$<br>\Phi = \frac{dQ}{dt}<br>$$</p><h2 id="Radiant-intensity-I"><a href="#Radiant-intensity-I" class="headerlink" title="Radiant intensity $I$"></a>Radiant intensity $I$</h2><p>Radiant Intensity ç¬¦å· $I$ï¼Œå•ä½ $\frac{W}{\text{sr}}$ï¼Œè¡¨ç¤ºæŸä¸ªå®šç‚¹æ¥æ”¶/ç©¿è¿‡/å‘å‡ºçš„ï¼Œåœ¨æŒ‡å®šæ–¹å‘ $\vec{\omega}$ ä¸Šçš„ï¼Œå•ä½ç«‹ä½“è§’çš„ Power.</p><p>å®šä¹‰ä¸º</p><p>$$<br>I(\vec{\omega})=\frac{d\Phi}{d\omega}<br>$$</p><p>è¿™é‡Œçš„ç¬¦å·ç•¥æ˜¾æ··ä¹±ã€‚å·¦è¾¹çš„å‚æ•° $\vec{\omega}$ æ˜¯ä¸€ä¸ªæ–¹å‘å‘é‡ï¼Œå³è¾¹çš„ $d\omega$ åˆ™æ˜¯è¿™ä¸ªæ–¹å‘ä¸Šç«‹ä½“è§’çš„å¾®åˆ†ã€‚</p><p>æˆ‘ä»¬çŸ¥é“æ–¹å‘å‘é‡ $\vec{\omega}$ ä¹Ÿèƒ½åœ¨çƒåæ ‡ä¸‹è¢«è¡¨ç¤ºä¸º $(\theta,\varphi)$ã€‚å¯¹ç»™å®šçš„ $(\theta,\varphi)$ï¼Œæˆ‘ä»¬å¯ä»¥ç®—å‡ºå…¶åœ¨çƒé¢ä¸Šçš„é¢ç§¯å¾®åˆ†ï¼Œä¹Ÿèƒ½è¿›ä¸€æ­¥æ±‚å‡ºç«‹ä½“è§’å¾®åˆ† $d\omega$ï¼Œå¦‚ä¸‹æ‰€ç¤º</p><p>$$<br>\begin{align<em>}<br>&amp;dA=r^2 \sin \theta \space d\theta \space d\varphi<br>\<br>&amp;d\omega=\frac{dA}{r^2}=\sin \theta \space d\theta \space d\varphi<br>\end{align</em>}<br>$$</p><p>ä¸‹å›¾æ˜¯å¯¹  Solid angle å’Œ Radiant Intensity ä¸¤ä¸ªæ¦‚å¿µçš„å›¾è§£</p><p><img src="/images/learning/open-course/GAMES101/Notes/note6/solid_angle_and_intensity.png" alt=""></p><h2 id="Irradiance-E"><a href="#Irradiance-E" class="headerlink" title="Irradiance $E$"></a>Irradiance $E$</h2><p>Irradiance ç¬¦å· $E$ï¼Œå•ä½ $\frac{W}{m^2}$.</p><p>è¡¨ç¤ºç‚¹ $x$ å‘¨å›´å•ä½é¢ç§¯æ¥æ”¶/ç©¿è¿‡/å‘å‡ºçš„ Powerï¼Œå®šä¹‰ä¸º</p><p>$$<br>E(x)=\frac{d\Phi}{dA}<br>$$</p><p>ä¸‹å›¾è®¡ç®—å¹¶å¯¹æ¯”äº†å¹³è¡Œå…‰ç©¿è¿‡ä¸¤ä¸ªä¸åŒæˆªé¢æ—¶çš„ irradianceï¼šå‚ç›´æˆªé¢ $A$ï¼Œä»¥åŠä¸å‚ç›´æ–¹å‘æˆ $\theta$ è§’çš„å€¾æ–œæˆªé¢ $Aâ€™$ã€‚</p><p>å…¶ä¸­ $\Phi=\Phiâ€™$ æ˜¯å› ä¸ºèƒ½é‡å®ˆæ’ï¼Œå…‰æŸç©¿è¿‡ä»»ä½•ä¸€ä¸ªå®Œæ•´æˆªé¢çš„åŠŸç‡æ˜¯å›ºå®šçš„ã€‚</p><p><img src="/images/learning/open-course/GAMES101/Notes/note6/irradiance.png" alt=""></p><h2 id="Radiance-L"><a href="#Radiance-L" class="headerlink" title="Radiance $L$"></a>Radiance $L$</h2><p>Radiance $L$ çš„å•ä½æ˜¯ $\frac{W}{\text{sr}\cdot \space m^2}$ï¼Œè¡¨ç¤ºè¡¨é¢æŸç‚¹ $x$ å‘¨å›´å•ä½æŠ•å½±é¢ç§¯æ¥æ”¶/ç©¿è¿‡/å‘å‡ºçš„ï¼Œåœ¨æŒ‡å®šæ–¹å‘ $\vec{w}$ ä¸Šçš„ï¼Œå•ä½ç«‹ä½“è§’çš„ radiant flux.</p><p>å®šä¹‰ä¸º</p><p>$$<br>L(x,\vec{\omega})=\frac{d^2\Phi}{d\omega ds}=\frac{d^2\Phi}{d\omega ds_{0}\cos\theta}<br>$$</p><p>è¿™é‡Œçš„ $ds$ æ˜¯æŠ•å½±å‰é¢ç§¯ï¼Œ$ds_0 \cos\theta$ æ˜¯æŠ•å½±é¢ç§¯ã€‚</p><p>ä¸‹å›¾æ˜¯å¯¹ Irradiance å’Œ Radianceçš„å›¾è§£</p><p><img src="/images/learning/open-course/GAMES101/Notes/note6/irradiance_and_radiance.png" alt=""></p><h1 id="BRDFå’Œæè´¨"><a href="#BRDFå’Œæè´¨" class="headerlink" title="BRDFå’Œæè´¨"></a>BRDFå’Œæè´¨</h1><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥çœ‹çœ‹å…‰ç…§çš„ç‰©ç†æ¨¡å‹äº†ï¼Œå…¶ä¸­æœ€å…³é”®çš„æ˜¯ BRDFï¼Œå³åŒå‘åå°„åˆ†å¸ƒå‡½æ•°ã€‚å®ƒå®šä¹‰äº†ä»æ–¹å‘ $\vec{\omega_i}$ å°„å…¥çš„å…‰çº¿æ‰“åˆ°æŸä¸ªè¡¨é¢ä¸Šåå°„åˆ° $\vec{\omega_r}$ æ–¹å‘çš„å¼ºåº¦ï¼š</p><p>$$<br>f_r(p,\vec{\omega_i}, \vec{\omega_r}) = \frac{dL_r(p,\vec{\omega_r})}{dE_i(p,\vec{\omega_i})}<br>$$</p><p>ä½ å¯èƒ½ä¼šç–‘æƒ‘ä¸ºä»€ä¹ˆä¹‹å‰æˆ‘ä»¬è¯´ $E$ æ˜¯å…³äº $x$ çš„å‡½æ•°ï¼Œç°åœ¨å´é™¤äº†åæ ‡ $p$ å¤–è¿˜å¤šäº†ä¸€ä¸ªæ–¹å‘å‚æ•° $\omega_i$ï¼Œè¿™æ˜¯å› ä¸º BRDF é‡Œçš„ $E$ æ˜¯å¾®åˆ†ã€‚å…·ä½“å¯ä»¥çœ‹çœ‹ä¸‹é¢è¿™ä¸ªå¼å­ï¼š</p><p>$$<br>E(x) = \int_{\Omega} L_i(x,\vec{\omega_i}) \cos\theta_i d\omega_i<br>\<br>dE_i(x, \vec{\omega_i}) = L_i(x, \vec{\omega_i}) \cos\theta_i d\omega_i</p><p>$$</p><p>ä½ å¯èƒ½è¿˜ä¼šç–‘æƒ‘ï¼Œä¸ºä»€ä¹ˆåˆ†æ¯ç”¨ $E$ å‘¢ï¼Ÿå’Œåˆ†æ¯ä¸€æ ·ç»Ÿä¸€ç”¨ $L$ ä¸æ˜¯æ›´ä¼˜é›…å—ï¼Ÿ</p><p>æ® <a href="https://www.zhihu.com/question/28476602/answer/41003204">https://www.zhihu.com/question/28476602/answer/41003204</a> è¿™ä¸ªç­”æ¡ˆæ‰€è¯´ï¼Œæµ‹é‡å‡ºå°„çš„ Radiance $L$ å¾ˆæ–¹ä¾¿ï¼Œä½†æµ‹é‡å…¥å°„çš„ Irradiance $L$ å¾ˆå›°éš¾ï¼Œè€Œæµ‹é‡å…¥å°„çš„ $dE$ æŒºæ–¹ä¾¿ï¼Œå› æ­¤æˆ‘ä»¬å°±ä½¿ç”¨äº† $\frac{dL}{dE}$.</p><p>æˆ‘ä»¬æŠŠä¸Šé¢çš„ $dE_i(x,\vec{\omega_i})$ ä»£å…¥ BRDFï¼Œå°±å¾—åˆ°äº†</p><p>$$<br>f_r(p,\vec{\omega_i}, \vec{\omega_r}) = \frac{dL_r(p,\vec{\omega_r})}{L_i(x,\vec{w_i})\cos\theta_i dw_i}<br>$$</p><p>ç‰©ä½“çš„æè´¨å°±ç”¨ BSDFï¼ˆåå°„çš„BRDF+æŠ˜å°„çš„BTDFï¼‰è¡¨ç¤ºã€‚æˆ‘ä»¬è¿™é‡ŒåªèŠ BRDFï¼Œå› ä¸º BTDF å’Œ BRDF æ¥è¿‘ã€‚BRDF çš„è·å–åŒ…æ‹¬ä½†ä¸é™äºè¿™ä¸¤ç§æ–¹å¼ï¼š</p><ol><li>ç°å®æµ‹é‡ã€‚æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°è®¸å¤šåŒ…å«å¤§é‡ BRDF æµ‹é‡æ•°æ®çš„æ•°æ®é›†ï¼Œæ¯”å¦‚ MERL æ•°æ®é›†ã€‚</li><li>å¾®è¡¨é¢æ¨¡å‹ã€‚ç”¨ç²—ç³™åº¦ã€é‡‘å±åº¦ç­‰å‚æ•°æ¥æ„å»ºå¯å‘å¼çš„ BRDF å‡½æ•°ã€‚</li></ol><p>è¿˜å€¼å¾—ä¸€æçš„æ˜¯ï¼Œç”± Helmholtz Reciprocity Principleï¼Œæœ‰</p><p>$$<br>f_r(p,\vec{\omega_i}, \vec{\omega_o}) = f_r(p,\vec{\omega_o}, \vec{\omega_i})<br>$$</p><p>ä¹Ÿå°±æ˜¯è¯´äº¤æ¢å…¥å°„å‡ºå°„æ–¹å‘ï¼ŒBRDF å‡½æ•° $f_r$ ä¸å˜ã€‚</p><h1 id="æ¸²æŸ“æ–¹ç¨‹"><a href="#æ¸²æŸ“æ–¹ç¨‹" class="headerlink" title="æ¸²æŸ“æ–¹ç¨‹"></a>æ¸²æŸ“æ–¹ç¨‹</h1><p>ç°åœ¨æˆ‘ä»¬å…ˆçœ‹çœ‹åå°„æ–¹ç¨‹ï¼Œå†çœ‹çœ‹æ¸²æŸ“æ–¹ç¨‹ã€‚</p><p>åå°„æ–¹ç¨‹æ˜¯é€šè¿‡ BRDF æ±‚å‡º $L_r$ çš„æ–¹ç¨‹ï¼Œå¯¹ BRDF çš„å…¬å¼ç§¯åˆ†ä¸€ä¸‹å°±è¡Œï¼š</p><p>$$<br>L_r(p, \vec{\omega_r}) = \int_{\Omega} f_r(p, \vec{\omega_i}, \vec{\omega_r}) L_i(p, \vec{\omega_i}) (\vec{\omega_i} \cdot \vec{n}) d\omega_i</p><p>$$</p><p>å…¶ä¸­ $\vec{n}$ æ˜¯ç‚¹ $p$ å¤„çš„æ³•çº¿æ–¹å‘ï¼Œ$\vec{\omega_i} \cdot \vec{n}$ æ˜¯ BRDF å®šä¹‰é‡Œçš„ $\cos\theta_i$.</p><p>è€Œæ¸²æŸ“æ–¹ç¨‹ï¼Œä¸è€ƒè™‘æŠ˜å°„ï¼Œåªæ˜¯æ¯”åå°„æ–¹ç¨‹å¤šäº†ä¸€ä¸ªè‡ªå‘å…‰é¡¹ï¼š</p><p>$$<br>L_o(p, \vec{\omega_o}) = L_e(p, \vec{\omega_o}) + \int_{\Omega} f_r(p, \vec{\omega_i}, \vec{\omega_o}) L_i(p, \vec{\omega_i}) (\vec{\omega_i} \cdot n) d\omega_i<br>$$</p><p>ä½ å¯èƒ½ä¼šå¥½å¥‡å³ä¾§çš„ $L_i(p,\vec{\omega_i}<br>)$ æ€ä¹ˆæ±‚å‡ºæ¥ã€‚ç”±èƒ½é‡å®ˆæ’ï¼Œæˆ‘ä»¬å¯ä»¥ä» $p$ å‡ºå‘é¡ºç€ $-\vec{\omega_i}$ æ‰¾åˆ°ç¬¬ä¸€ä¸ªäº¤ç‚¹ $q$ï¼Œç„¶åå°±æœ‰</p><p>$$<br>L_i(p,\vec{\omega_i})=L_o(q,-\vec{\omega_i})<br>$$</p><h1 id="å®é™…ç®—æ³•"><a href="#å®é™…ç®—æ³•" class="headerlink" title="å®é™…ç®—æ³•"></a>å®é™…ç®—æ³•</h1><p>ç”±ä¸Šå¯çŸ¥ï¼Œæˆ‘ä»¬è¦æ±‚è§£ä¸‹é¢çš„æ–¹ç¨‹ï¼š</p><p>$$<br>L_o(p, \vec{\omega_o}) = L_e(p, \vec{\omega_o}) + \int_{\Omega} f_r(p, \vec{\omega_i}, \vec{\omega_o}) L_o(\text{raycast}(p, -\vec{\omega_i}), -\vec{\omega_i}) (\vec{\omega_i} \cdot n) d\vec{\omega_i}<br>$$</p><p>è¿™æ˜¯ä¸€ä¸ªç§¯åˆ†ï¼Œè¿˜æ˜¯ä¸€ä¸ªé€’å½’ï¼Œæˆ‘ä»¬å…ˆç”¨è’™ç‰¹å¡ç½—ç®—æ³•è¿‘ä¼¼ç§¯åˆ†ï¼Œå¾—åˆ°</p><p>$$<br>L_o(p, \vec{\omega_o}) \approx L_e(p, \vec{\omega_o}) +<br>\frac{1}{N}\sum_{k=1}^{N}\frac{f_r(p, \vec{\omega_i}^{(k)}, \vec{\omega_o}) L_o(\text{raycast}(p, -\vec{\omega_i}^{(k)}), -\vec{\omega_i}^{(k)}) (\vec{\omega_i} ^{(k)}\cdot n) }<br>{p(\vec{\omega_i}^{(k)})}<br>$$</p><p>å…¶ä¸­ $\vec{\omega_i}^{(k)}$ æ˜¯éšæœºé‡‡æ ·çš„æ–¹å‘å‘é‡ï¼Œ$p(\vec{\omega_i}^{(k)})$ æ˜¯é‡‡æ ·åˆ°å®ƒçš„æ¦‚ç‡ã€‚</p><p>æœ‰äº†è¿™ä¸ªæ±‚å’Œï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹é€’å½’äº†ï¼Œå¤§è‡´ç®—æ³•å¦‚ä¸‹ï¼š</p><ol><li>ä» $p$ å°„å‡ºæœéšæœºæ–¹å‘ $\vec{\omega_i}<br>^{(k)}$ çš„å°„çº¿ï¼Œæ‰“åˆ° $q^{(k)}$.</li><li>è®¡ç®— $L_o(q,-w_i^{(k)})$ï¼Œç„¶åä»£å…¥å¼å­ï¼Œæ±‚å¾— $L_o(p,\vec{\omega_o})$ã€‚</li></ol><p>ç­‰ç­‰ï¼Œè¿™ä¸æ˜¯æ— é™é€’å½’å—ï¼Ÿç¡®å®å¦‚æ­¤ã€‚æ‰€ä»¥æˆ‘ä»¬ä¼šå‡è®¾å¦‚æœå°„çº¿æ‰“åˆ°äº†å…‰æºå°±åªè¿”å›è‡ªå‘å…‰é¡¹ $L_e$.</p><p>ä½†è¿™ä¸è¿˜æ˜¯å¾ˆå¤æ‚å—ï¼Œå‡è®¾æˆ‘ä»¬å¯¹æ¯ä¸ªç‚¹å‘å°„ $10$ æ¡å°„çº¿ï¼Œå¼¹å°„ä»¥åå°±è¦å‘å°„ $10^2$ ä¸ªï¼Œå†å¼¹å°„å°±è¦ $10^3$ ä¸ªï¼</p><p>æ²¡é”™ï¼Œæ‰€ä»¥æˆ‘ä»¬åªå¯¹æ¯ä¸ªç‚¹å‘å‡º $1$ æ¡å°„çº¿å¹¶è®¡ç®—å…¶å¼¹å°„åçš„å®Œæ•´è·¯å¾„ï¼Œç„¶åå¯¹æ¯ä¸ªç‚¹è¿½è¸ªå¤šæ¡è·¯å¾„å¹¶å–å¹³å‡ã€‚è™½ç„¶è¿™ä¸å®Œå…¨ç¬¦åˆä¸Šé¢çš„å…¬å¼ï¼Œä½†å¾ˆæœ‰æ•ˆã€‚</p><p>è®©æˆ‘ä»¬æ¥çœ‹çœ‹æ–°çš„ç®—æ³•å§ï¼š</p><ol><li>å¦‚æœç‚¹ $p$ æ˜¯å…‰æºï¼Œç›´æ¥è¿”å›å…¶è‡ªå‘å…‰é¡¹ã€‚</li><li>éšæœºé‡‡æ ·ä¸€ä¸ªæ–¹å‘ $w_i$ï¼Œä» $p$ å‘å‡ºä¸€æ¡æœå‘ $w_i$ çš„å°„çº¿ï¼Œæ‰“åˆ°ç‚¹ $q$.</li><li>è®¡ç®—ç‚¹ $q$ çš„ $L_o(q,-w_i)$ï¼Œä»£å…¥å…¬å¼ï¼Œæ±‚å¾— $L_o(p,w_o)$.</li><li>å¯¹æ±‚å¾—çš„å¤šä¸ª $L_o(p,w_o)$ å–å¹³å‡ã€‚</li></ol><p>è¿™ä¸ªç®—æ³•å½“ç„¶å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–ï¼Œæ¯”å¦‚è¯´ä¸Šé¢è¿˜æ˜¯æœ‰æ½œåœ¨çš„æ— é™å¼¹å°„é£é™©ï¼Œæ‰€ä»¥è¦ç”¨ä¿„ç½—æ–¯è½®ç›˜èµŒæ¥åœ¨æ¯æ¬¡å¼¹å°„æ—¶éƒ½æœ‰éšæœºæ¦‚ç‡åœæ­¢å¼¹å°„ï¼ˆè¿™è¢«ç§°ä½œRRï¼‰ï¼›åˆæ¯”å¦‚ä¸Šé¢æ‰“åˆ°å…‰æºçš„æ¦‚ç‡å¤ªä½ï¼Œæ‰€ä»¥å¯ä»¥ä»å…‰æºé‡‡æ ·å°„çº¿ï¼ˆè¿™è¢«ç§°ä½œNEEï¼‰ã€‚ä¸è¿‡è¿™äº›ä¸œè¥¿å°±ç•™åˆ°ä½œä¸š 7 çš„è§£æé‡Œå†è¯´å§ã€‚</p><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p>Stanford CS348B, Spring 2022ï¼š<a href="https://gfxcourses.stanford.edu/cs348b/spring22">https://gfxcourses.stanford.edu/cs348b/spring22</a></p><p>å¤šä¼¦å¤šå¤§å­¦å›¾å½¢å­¦è®²ä¹‰ï¼š<a href="https://www.dgp.toronto.edu/public_user/elf/2522/light.pdf">https://www.dgp.toronto.edu/public_user/elf/2522/light.pdf</a></p><p>Introduction to Radiometry and Photometry</p><p>UE4 çš„ BRDF å®ç°ï¼š<a href="https://blog.selfshadow.com/publications/s2013-shading-course/karis/s2013_pbs_epic_notes_v2.pdf">https://blog.selfshadow.com/publications/s2013-shading-course/karis/s2013_pbs_epic_notes_v2.pdf</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;æˆ‘ä»¬ä¹‹å‰å·²ç»å­¦è¿‡äº† Blinn-Phong å…‰ç…§æ¨¡å‹ï¼Œä½†å®ƒåªæ˜¯ä¸€ä¸ªå¯å‘å¼æ¨¡å‹ï¼Œåœ¨ç‰©ç†ä¸Šæ˜¯ä¸æ­£ç¡®çš„ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ç‰©ç†ä¸Šæ­£ç¡®çš„å…‰ç…§æ˜¯æ€æ ·çš„ï¼Œä»¥åŠå¦‚ä½•ç”¨è®¡ç®—æœºè¿‘ä¼¼æ±‚è§£æ¥è¿‘æ­£ç¡®çš„å…‰ç…§ã€‚&lt;/p&gt;
&lt;h1 id=&quot;è¾å°„åº¦é‡å­¦&quot;&gt;&lt;a href=&quot;#è¾å°„åº¦é‡å­¦&quot; class=&quot;head</summary>
      
    
    
    
    <category term="å…¬å¼€è¯¾" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/"/>
    
    <category term="GAMES101" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/GAMES101/"/>
    
    <category term="Notes" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/GAMES101/Notes/"/>
    
    
  </entry>
  
  <entry>
    <title>æ¢ç´¢æ—¥å¿—[0]</title>
    <link href="http://rinevard.github.io/wiki/others/thoughts/%E6%8E%A2%E7%B4%A2%E6%97%A5%E5%BF%970/"/>
    <id>http://rinevard.github.io/wiki/others/thoughts/%E6%8E%A2%E7%B4%A2%E6%97%A5%E5%BF%970/</id>
    <published>2025-10-10T12:10:11.000Z</published>
    <updated>2025-10-27T13:33:04.965Z</updated>
    
    <content type="html"><![CDATA[<p>ç¬¬äºŒæ¬¡å‚åŠ äº† Ludum Dareï¼Œç¬¬äºŒæ¬¡å‚åŠ äº† Compo èµ›é“ã€‚Compo è¦æ±‚å•äººä»é›¶å¼€å§‹åœ¨ 48 å°æ—¶å†…åšå‡ºä¸€ä¸ªèƒ½ç©çš„ä¸œè¥¿ã€‚ä¸è§‰å¾—è¿™å¾ˆé…·å—ï¼Œä½œä¸ºä¸€ä¸ªç©å®¶æˆ‘è§‰å¾—è¿™å¤ªé…·äº†ï¼Œå¾ˆç¬¦åˆæˆ‘å¯¹æå®¢çš„æƒ³è±¡ã€‚</p><p>ä¸Šä¸€æ¬¡å‚åŠ  Compo ç»“è¯†äº†ä¸€ä½å¾ˆæœ‰è¶£çš„æœ‹å‹ï¼Œæ‰€ä»¥è¿™æ¬¡åˆå‚åŠ äº† Compo è€Œä¸æ˜¯ç»„é˜Ÿçš„ Jamã€‚ä¸è¿‡è¿™æ¬¡ä¼¼ä¹è‡³å°‘åˆ°ç°åœ¨ä¸ºæ­¢è¿˜æ²¡ç»“è¯†åˆ°å¾ˆæœ‰è¶£çš„æœ‹å‹ï¼ˆï¼‰</p><p>ä»ä¸Šå­¦æœŸå°±å¼€å§‹æƒ³ï¼Œå¤§å­¦çš„æ¯å¤©éƒ½å¤ªç›¸ä¼¼ï¼Œæ—¥å¤ä¸€æ—¥ã€‚å› æ­¤æƒ³æ¯å‘¨éƒ½åšä¸€äº›æ²¡åšè¿‡çš„äº‹æƒ…ã€‚è™½ç„¶æ²¡åšæŒå¾ˆä¹…ï¼Œä½†æˆ‘æƒ³è¿™ç¡®å®æ˜¯å€¼å¾—åšçš„ã€‚æ‰€ä»¥ä»ç°åœ¨å¼€å§‹ç®€å•å†™å†™æ¢ç´¢æ—¥å¿—å§ï¼Œæ—¶ä¸æ—¶æ¢ç´¢ä¸€ä¸‹ã€‚</p><p>è¿™æ¬¡é™¤äº†è‡ªå·±å‚åŠ ä¹‹å¤–ï¼Œè¿˜å’Œå¢¨é±¼æ¸¸ç ”ç¤¾çš„åŒå­¦ä»¬ä¸€èµ·ç»„ç»‡äº†ä¸€ä¸ªæ´»åŠ¨ï¼Œå’Œç¤¾å›¢çš„å¤§å®¶ä¸€èµ·å‚åŠ äº†è¿™åœº gamejamï¼Œå’±ä»¬ç¤¾å›¢æœ€åä¸€å…±åšäº†å››ä¸ªæ¸¸æˆã€‚æˆ‘åšäº† <a href="https://ldjam.com/events/ludum-dare/58/swarm-surge">SwarmSurge</a>.</p><p><img src="/images/others/random_thoughts/explore0/swarm_surge.jpg" alt="Swarm Surge"></p><p>æ€æ ·çš„ç”Ÿæ´»å€¼å¾—æˆ‘è¿‡ï¼Œæˆ‘è¯¥è¿‡æ€æ ·çš„ç”Ÿæ´»ï¼Ÿæˆ‘ç¡®å®è¿˜æ²¡æƒ³æ˜ç™½ã€‚Jam æ˜¯ç”Ÿæ´»é‡Œä¸ºæ•°ä¸å¤šçš„ä¸€æŠ¹å¥‡å¹»è‰²å½©ï¼ŒæƒŠè‰³åˆçŸ­æš‚ã€‚åœ¨æœ‰è¶£çš„æ•…äº‹ç»“æŸä¹‹åï¼Œæˆ‘ä»¬åˆè¯¥åšä»€ä¹ˆï¼Œåˆè¯¥å»å¾€ä½•æ–¹ï¼Ÿ</p><p>ä¹Ÿéš¾æ€ªä¼šå–œæ¬¢å‡‰å®«æ˜¥æ—¥ã€‚è™½ç„¶å¥¹æ€§æ ¼æ¶åŠ£æƒ³ä¸€å‡ºæ˜¯ä¸€å‡ºï¼Œä½†å¥¹æ˜¯è®©ä¸–ç•Œå˜å¾—æ›´çƒ­é—¹çš„å‡‰å®«æ˜¥æ—¥å›¢å›¢é•¿ï¼é˜¿è™šæ›¾é—®è‡ªå·±ï¼šâ€œå¯¹è¿™ç§è¶…ä¹å¸¸è¯†çš„å­¦å›­ç”Ÿæ´»ï¼Œä½ å°±ä¸è§‰å¾—å¿«ä¹å—ï¼Ÿâ€ä»–çš„å›ç­”æ˜¯ï¼šâ€œå½“ç„¶å¿«ä¹äº†ï¼Œåˆ«é—®æˆ‘è¿™ç§æ˜æ‘†ç€çš„äº‹æƒ…ã€‚â€</p><p>å¯¹è¿™äº›å¥‡å¹»è‰²å½©ï¼Œæˆ‘éš¾é“ä¸æ„Ÿè§‰å¿«ä¹å—ï¼Ÿå½“ç„¶å¿«ä¹äº†ã€‚æˆ‘ä¼šä¸€ç›´æ¢ç´¢ä¸‹å»ï¼Œå³ä½¿æ¯å¤©éƒ½æ˜¯æŸä¸ªé›¨æ—¥ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;ç¬¬äºŒæ¬¡å‚åŠ äº† Ludum Dareï¼Œç¬¬äºŒæ¬¡å‚åŠ äº† Compo èµ›é“ã€‚Compo è¦æ±‚å•äººä»é›¶å¼€å§‹åœ¨ 48 å°æ—¶å†…åšå‡ºä¸€ä¸ªèƒ½ç©çš„ä¸œè¥¿ã€‚ä¸è§‰å¾—è¿™å¾ˆé…·å—ï¼Œä½œä¸ºä¸€ä¸ªç©å®¶æˆ‘è§‰å¾—è¿™å¤ªé…·äº†ï¼Œå¾ˆç¬¦åˆæˆ‘å¯¹æå®¢çš„æƒ³è±¡ã€‚&lt;/p&gt;
&lt;p&gt;ä¸Šä¸€æ¬¡å‚åŠ  Compo ç»“è¯†äº†ä¸€ä½å¾ˆæœ‰è¶£çš„æœ‹å‹ï¼Œæ‰€ä»¥è¿™æ¬¡åˆå‚</summary>
      
    
    
    
    <category term="æ‚è°ˆ" scheme="http://rinevard.github.io/categories/%E6%9D%82%E8%B0%88/"/>
    
    <category term="ç¢ç¢å¿µ" scheme="http://rinevard.github.io/categories/%E6%9D%82%E8%B0%88/%E7%A2%8E%E7%A2%8E%E5%BF%B5/"/>
    
    
  </entry>
  
  <entry>
    <title>Note 5 RayTracing</title>
    <link href="http://rinevard.github.io/wiki/learning/open-course/GAMES101/Notes/Note5-RayTracing/"/>
    <id>http://rinevard.github.io/wiki/learning/open-course/GAMES101/Notes/Note5-RayTracing/</id>
    <published>2025-09-25T13:48:28.000Z</published>
    <updated>2025-09-25T13:51:26.850Z</updated>
    
    <content type="html"><![CDATA[<p>æ¸²æŸ“å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªå¤§ç±»ï¼šobject-order rendering å’Œ Image-order rendering. å‰è€…ä»¥åœºæ™¯ä¸­çš„ç‰©ä½“ï¼ˆé€šå¸¸æ˜¯å¦‚ä¸‰è§’å½¢ï¼‰ä¸ºåŸºæœ¬å•ä½è¿›è¡Œè¿­ä»£ï¼Œéå†åœºæ™¯ä¸­çš„æ¯ä¸€ä¸ªç‰©ä½“ï¼Œç„¶åç¡®å®šè¯¥ç‰©ä½“ä¼šå½±å“å±å¹•ä¸Šçš„å“ªäº›åƒç´ ï¼›åè€…ä»¥å±å¹•ä¸Šçš„åƒç´ ä¸ºåŸºæœ¬å•ä½è¿›è¡Œè¿­ä»£ï¼Œéå†è¾“å‡ºå›¾åƒä¸­çš„æ¯ä¸€ä¸ªåƒç´ ï¼Œç„¶åå¯¹äºæ¯ä¸ªåƒç´ ï¼Œå®ƒä¼šæ‰¾å‡ºåœºæ™¯ä¸­çš„å“ªä¸ªç‰©ä½“æˆ–ç‰©ä½“çš„å“ªä¸ªéƒ¨åˆ†å†³å®šäº†è¯¥åƒç´ çš„é¢œè‰²ã€‚</p><p>æˆ‘ä»¬ä¹‹å‰å­¦çš„å…‰æ …åŒ–æ˜¯å‰è€…ï¼Œè€Œæˆ‘ä»¬æ¥ä¸‹æ¥è¦ä»‹ç»çš„å…‰çº¿è¿½è¸ªå°±æ˜¯åè€…ã€‚</p><h1 id="å…‰çº¿è¿½è¸ª"><a href="#å…‰çº¿è¿½è¸ª" class="headerlink" title="å…‰çº¿è¿½è¸ª"></a>å…‰çº¿è¿½è¸ª</h1><h2 id="åŸºæœ¬æ€æƒ³"><a href="#åŸºæœ¬æ€æƒ³" class="headerlink" title="åŸºæœ¬æ€æƒ³"></a>åŸºæœ¬æ€æƒ³</h2><p>å…‰çº¿è¿½è¸ªçš„æ€æƒ³åŸºäºå…‰è·¯å¯é€†â€”â€”æ—¢ç„¶å…‰è·¯å¯é€†ï¼Œé‚£ä¹ˆæ‰“åˆ°æ‘„åƒæœºé‡Œçš„å…‰å°±å¯ä»¥çœ‹ä½œä»æ‘„åƒæœºå‘å‡ºçš„å°„çº¿ï¼Œæˆ‘ä»¬åªè¦æ‰“å‡ºå°„çº¿ç„¶åè®¡ç®—å°„çº¿æ‰“åˆ°çš„ç‚¹çš„é¢œè‰²å°±å¥½äº†ã€‚</p><p>å…¶å®åŸºæœ¬æ€è·¯çœŸçš„å°±æ˜¯è¿™ä¹ˆç®€å•ï¼å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬ä»çœ¼ç›é‡Œå‘å‡ºç»è¿‡æ¯ä¸ªåƒç´ çš„å°„çº¿ï¼Œç„¶åå°„çº¿æ‰“åˆ°ç‰©ä½“ä¸Šå°±å¾—åˆ°äº†ç‰©ä½“çš„åŸºæœ¬é¢œè‰²ã€‚è€Œå°„çº¿è¿˜ä¼šåå°„ã€æŠ˜å°„ï¼Œæˆ‘ä»¬è®¡ç®—åå°„ã€æŠ˜å°„åçš„å°„çº¿æ‰“åˆ°çš„é¢œè‰²ï¼Œå†åŠ åˆ°åŸºæœ¬é¢œè‰²ä¸Šï¼Œå°±å¾—åˆ°äº†è¿™ä¸ªåƒç´ çš„é¢œè‰²ã€‚</p><p><img src="/images/learning/open-course/GAMES101/Notes/note5/ray_tracing.png" alt=""></p><p>å…‰çº¿è¿½è¸ªä¹Ÿè‡ªç„¶åœ°ç”Ÿæˆäº†é˜´å½±â€”â€”å¦‚æœå°„çº¿æ‰“ä¸­çš„ç‚¹å’Œå…‰æºçš„è¿çº¿é—´æœ‰ç‰©ä½“é®æŒ¡ï¼Œè¿™ç‚¹å°±æ˜¯é˜´å½±ï¼Œå¦åˆ™å°±ä¸æ˜¯é˜´å½±ã€‚</p><h2 id="ç¢°æ’æ£€æµ‹"><a href="#ç¢°æ’æ£€æµ‹" class="headerlink" title="ç¢°æ’æ£€æµ‹"></a>ç¢°æ’æ£€æµ‹</h2><p>æ—¢ç„¶å¦‚æ­¤ï¼Œæˆ‘ä»¬åªè¦æ£€æµ‹å°„çº¿å’Œä¸‰è§’å½¢çš„ç¢°æ’å°±å¥½äº†ã€‚æˆ‘ä»¬å¯ä»¥ç”¨ä¸‹é¢çš„ MÃ¶ller Trumbore Algorithm æ¥åšæ£€æµ‹ï¼Œå…¶æ€è·¯æ˜¯è§£ â€œç›´çº¿ä¸Šçš„ç‚¹ = ä¸‰è§’å½¢é‡å¿ƒåæ ‡è¡¨ç¤ºâ€ è¿™ä¸ªæ–¹ç¨‹ï¼š</p><p>è€ƒè™‘å°„çº¿ $\vec{O} + t\vec{D}$ å’Œä¸‰è§’å½¢ $P_0, P_1, P_2$ï¼Œæˆ‘ä»¬è¦è§£æ–¹ç¨‹</p><p>$$<br>\vec{O} + t\vec{D} = (1-b_1-b_2)\vec{P_0} + b_1\vec{P_1} + b_2\vec{P_2}<br>$$</p><p>è¿™æ˜¯ä¸€ä¸ªçº¿æ€§æ–¹ç¨‹ç»„ï¼Œè§£ä¸º</p><p>$$<br>\begin{bmatrix} t \ b_1 \ b_2 \end{bmatrix} = \frac{1}{\vec{S_1} \cdot \vec{E_1}} \begin{bmatrix} \vec{S_2} \cdot \vec{E_2} \ \vec{S_1} \cdot \vec{S} \ \vec{S_2} \cdot \vec{D} \end{bmatrix}<br>$$</p><p>å…¶ä¸­</p><p>$$<br>\begin{aligned}<br>\vec{E_1} &amp;= \vec{P_1} - \vec{P_0} \<br>\vec{E_2} &amp;= \vec{P_2} - \vec{P_0} \<br>\vec{S} &amp;= \vec{O} - \vec{P_0} \<br>\vec{S_1} &amp;= \vec{D} \times \vec{E_2} \<br>\vec{S_2} &amp;= \vec{S} \times \vec{E_1}<br>\end{aligned}<br>$$</p><h1 id="æ€§èƒ½ä¼˜åŒ–"><a href="#æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–"></a>æ€§èƒ½ä¼˜åŒ–</h1><p>åœ¨åšå°„çº¿å’Œä¸‰è§’å½¢çš„ç¢°æ’æ£€æµ‹æ—¶ï¼Œç®€å•åœ°éå†åœºæ™¯é‡Œçš„æ¯ä¸ªä¸‰è§’å½¢æ˜¾ç„¶å¤ªæ…¢äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨åŒ…å›´ç›’æ¥ä¼˜åŒ–ã€‚å¦‚æœä¸€ä¸ªå°„çº¿æ²¡æœ‰ç¢°åˆ°åŒ…å›´ç›’ï¼Œè‡ªç„¶å°±ä¸ä¼šç¢°åˆ°ç›’å­é‡Œçš„ç‰©ä½“ï¼›å¦‚æœç¢°åˆ°äº†ï¼Œå†å’Œç›’å­é‡Œçš„ç‰©ä½“åšç¢°æ’æ£€æµ‹ã€‚</p><h2 id="å¸¸è§åŒ…å›´ç›’"><a href="#å¸¸è§åŒ…å›´ç›’" class="headerlink" title="å¸¸è§åŒ…å›´ç›’"></a>å¸¸è§åŒ…å›´ç›’</h2><p>åŒ…å›´ç›’æœ‰ä¸¤ç§æ€è·¯ï¼Œä¸€ç§æ˜¯åŸºäºç©ºé—´çš„åˆ’åˆ†ï¼Œå¦ä¸€ç§æ˜¯åŸºäºç‰©ä½“çš„åˆ’åˆ†ã€‚å‰è€…çš„ä»£è¡¨åŒ…æ‹¬å››å‰æ ‘ã€å…«å‰æ ‘ï¼›åè€…çš„ä»£è¡¨æ˜¯ BVH.</p><p>å››å‰æ ‘ã€å…«å‰æ ‘æŠŠç©ºé—´è¿›è¡Œå¹³åˆ†ï¼Œå½“ä¸€ä¸ªåŒºåŸŸé‡Œè¿˜å‰©è¾ƒå¤šç‰©ä½“æ—¶å°±å†åœ¨è¿™ä¸ªåŒºåŸŸé‡Œå¹³åˆ†ä¸€æ¬¡ã€‚</p><p><img src="/images/learning/open-course/GAMES101/Notes/note5/octree.png" alt=""></p><p>BVH ä¸ºæ¯ç»„ç‰©ä½“å»ºç«‹åŒ…å›´ç›’ï¼Œç„¶åå†æŠŠçˆ¶åŒ…å›´ç›’åˆ’åˆ†æˆå­åŒ…å›´ç›’ã€‚</p><p><img src="/images/learning/open-course/GAMES101/Notes/note5/bvh.png" alt=""></p><h2 id="å°„çº¿å’ŒåŒ…å›´ç›’çš„ç¢°æ’æ£€æµ‹"><a href="#å°„çº¿å’ŒåŒ…å›´ç›’çš„ç¢°æ’æ£€æµ‹" class="headerlink" title="å°„çº¿å’ŒåŒ…å›´ç›’çš„ç¢°æ’æ£€æµ‹"></a>å°„çº¿å’ŒåŒ…å›´ç›’çš„ç¢°æ’æ£€æµ‹</h2><p>åŒ…å›´ç›’æœ‰å…­ä¸ªé¢ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠç›¸å¯¹çš„é¢åˆ’åˆ†æˆä¸€ç»„ä»è€Œå¾—åˆ°ä¸‰ç»„é¢ã€‚è®¡ç®—å°„çº¿ $\vec{O} + t\vec{D}$ ä¸è¿™ä¸‰ç»„é¢çš„äº¤ç‚¹åï¼Œæˆ‘ä»¬ä¼šå¾—åˆ° $[t_{x, \text{enter}}, t_{x, \text{exit}}],[t_{y, \text{enter}}, t_{y, \text{exit}}],[t_{z, \text{enter}}, t_{z, \text{exit}}]$ï¼Œä¹‹åè®¡ç®—ä¸‹é¢çš„äº¤é›†ï¼š</p><p>$$<br>[t_\text{raymin},t_\text{raymax}]\cap[t_{x, \text{enter}}, t_{x, \text{exit}}]\cap[t_{y, \text{enter}}, t_{y, \text{exit}}]\cap[t_{z, \text{enter}}, t_{z, \text{exit}}]<br>$$</p><p>å¦‚æœäº¤é›†ä¸ºç©ºåˆ™æ— äº¤ç‚¹ï¼Œå¦åˆ™æœ‰äº¤ç‚¹ã€‚</p><p>ä¸ºäº†æ–¹ä¾¿è®¡ç®—ï¼ŒåŒ…å›´ç›’ä¸€èˆ¬æ˜¯ä¸åæ ‡è½´å¹³è¡Œçš„ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;æ¸²æŸ“å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªå¤§ç±»ï¼šobject-order rendering å’Œ Image-order rendering. å‰è€…ä»¥åœºæ™¯ä¸­çš„ç‰©ä½“ï¼ˆé€šå¸¸æ˜¯å¦‚ä¸‰è§’å½¢ï¼‰ä¸ºåŸºæœ¬å•ä½è¿›è¡Œè¿­ä»£ï¼Œéå†åœºæ™¯ä¸­çš„æ¯ä¸€ä¸ªç‰©ä½“ï¼Œç„¶åç¡®å®šè¯¥ç‰©ä½“ä¼šå½±å“å±å¹•ä¸Šçš„å“ªäº›åƒç´ ï¼›åè€…ä»¥å±å¹•ä¸Šçš„åƒç´ ä¸ºåŸºæœ¬å•ä½è¿›è¡Œè¿­ä»£ï¼Œ</summary>
      
    
    
    
    <category term="å…¬å¼€è¯¾" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/"/>
    
    <category term="GAMES101" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/GAMES101/"/>
    
    <category term="Notes" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/GAMES101/Notes/"/>
    
    
  </entry>
  
</feed>
