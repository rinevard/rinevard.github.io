<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Rinevard</title>
  
  
  <link href="http://rinevard.github.io/atom.xml" rel="self"/>
  
  <link href="http://rinevard.github.io/"/>
  <updated>2025-10-30T14:38:20.127Z</updated>
  <id>http://rinevard.github.io/</id>
  
  <author>
    <name>Rinevard</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Lab 4 Traps</title>
    <link href="http://rinevard.github.io/wiki/learning/open-course/MIT-6.S081/Labs/lab4-traps/"/>
    <id>http://rinevard.github.io/wiki/learning/open-course/MIT-6.S081/Labs/lab4-traps/</id>
    <published>2025-10-30T14:28:22.000Z</published>
    <updated>2025-10-30T14:38:20.127Z</updated>
    
    <content type="html"><![CDATA[<h1 id="RISC-V-assembly"><a href="#RISC-V-assembly" class="headerlink" title="RISC-V assembly"></a><strong>RISC-V assembly</strong></h1><p>åœ¨ lab å¼€å§‹æ—¶ï¼Œæˆ‘ä»¬è¦ç®€å•å›ç­”ä¸€äº›é—®é¢˜ã€‚è¿™é‡Œåªç®€å•èŠèŠæœ€åä¸¤é“ï¼š</p><ol><li><p>ä¸‹é¢çš„ä»£ç ä¼šæ‰“å°ä»€ä¹ˆï¼Ÿ</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0x00646c72</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"H%x Wo%s"</span><span class="token punctuation">,</span> <span class="token number">57616</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p> 57616 è½¬æ¢åˆ°åå…­è¿›åˆ¶æ˜¯ E110ï¼Œæ‰€ä»¥ç©ºæ ¼å‰æ‰“å°çš„æ˜¯ HE110.</p><p> RISC-V ä½¿ç”¨å°ç«¯æ³•ï¼Œæ‰€ä»¥ <code>i</code> åœ¨å†…å­˜ä¸­çš„å­˜å‚¨æ˜¯ <code>72 6c 64 00</code>ï¼Œæ‰€ä»¥ç©ºæ ¼åæ‰“å°çš„æ˜¯ rld.</p><p> æ€»ä¹‹æˆ‘ä»¬æ‰“å°äº† HE110, World!ï¼ˆä»¥åå’±å°±ç”¨è¿™ä¸ªå»æ°´è´´</p></li><li><p>ä¸‹é¢çš„ä»£ç åœ¨ â€œy=â€ åä¼šæ‰“å°ä»€ä¹ˆï¼Ÿ</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"x=%d y=%d"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p> æˆ‘ä»¬æ²¡æœ‰ä¼ å…¥ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šæŠŠå¯„å­˜å™¨ a2 é‡Œçš„ä¸œè¥¿å½“ä½œ int æ¥æ‰“å°ã€‚</p></li></ol><h1 id="Backtrace"><a href="#Backtrace" class="headerlink" title="Backtrace"></a>Backtrace</h1><p>è¿™é‡Œè¦æ±‚æˆ‘ä»¬å®ç°ä¸€ä¸ª backtrace å‡½æ•°ï¼Œæ‰“å°å‡ºå½“å‰è°ƒç”¨æ ˆã€‚</p><h2 id="è§£æ³•"><a href="#è§£æ³•" class="headerlink" title="è§£æ³•"></a>è§£æ³•</h2><p>æˆ‘ä»¬å…ˆæ¥å›é¡¾ä¸€ä¸‹ xv6 çš„æ ˆç»“æ„ï¼š</p><pre class="line-numbers language-none"><code class="language-none">                 .                 .    +-&gt;          .    |   +-----------------+   |    |   | return address  |   |    |   |   previous fp ------+    |   | saved registers |    |   | local variables |    |   |       ...       | &lt;-+    |   +-----------------+   |    |   | return address  |   |    +------ previous fp   |   |        | saved registers |   |        | local variables |   |    +-&gt; |       ...       |   |    |   +-----------------+   |    |   | return address  |   |    |   |   previous fp ------+    |   | saved registers |    |   | local variables |    |   |       ...       | &lt;-+    |   +-----------------+   |    |   | return address  |   |    +------ previous fp   |   |        | saved registers |   |        | local variables |   |$fp --&gt; |       ...       |   |        +-----------------+   |        | return address  |   |        |   previous fp ------+        | saved registers |$sp --&gt; | local variables |        +-----------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥æ¦‚æ‹¬ç®—æ³•æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>æ‰¾åˆ°å½“å‰ stack frame çš„ fpï¼Œè¿™åœ¨åˆå§‹åŒ–æ—¶å°±æ˜¯æ‰¾åˆ°å¯„å­˜å™¨ s0 é‡Œå­˜å‚¨çš„æŒ‡é’ˆã€‚</li><li>æ‰¾åˆ°å½“å‰ stack frame çš„ previous fpï¼Œåˆ¤æ–­ previous fp å’Œå½“å‰ fp æ˜¯å¦åœ¨ä¸€ä¸ª page å†…<ol><li>å¦‚æœåœ¨ï¼Œç”¨ %p æ‰“å°è¿™ä¸ª frame å­˜å‚¨çš„è·³è½¬å€¼ï¼Œç„¶åç»§ç»­å¾ªç¯</li><li>å¦‚æœä¸åœ¨å°±ç»“æŸå¾ªç¯</li></ol></li></ol><p>æ€»ä¹‹ä»£ç å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">backtrace</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    uint64 fp <span class="token operator">=</span> <span class="token function">r_fp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"backtrace:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>uint64 cur_fp <span class="token operator">=</span> fp<span class="token punctuation">;</span> <span class="token function">PGROUNDDOWN</span><span class="token punctuation">(</span>cur_fp<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">PGROUNDDOWN</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>         cur_fp <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>uint64 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>cur_fp <span class="token operator">-</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        uint64 ret_addr <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>uint64 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>cur_fp <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%p\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>ret_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="å’Œ-CSAPP-ä»‹ç»çš„æ ˆç»“æ„çš„å¯¹æ¯”"><a href="#å’Œ-CSAPP-ä»‹ç»çš„æ ˆç»“æ„çš„å¯¹æ¯”" class="headerlink" title="å’Œ CSAPP ä»‹ç»çš„æ ˆç»“æ„çš„å¯¹æ¯”"></a>å’Œ CSAPP ä»‹ç»çš„æ ˆç»“æ„çš„å¯¹æ¯”</h2><p>æˆ‘ä»¬ä¼šæ³¨æ„åˆ° xv6 çš„æ ˆç»“æ„å’Œ CSAPP é‡Œä»‹ç»çš„ç•¥æœ‰å·®å¼‚ï¼Œä¸»è¦æ˜¯ CSAPP çš„æ ˆå¸§ä¸åŒ…å« <code>previous fp</code>ã€‚ä¸‹é¢çš„æ˜¯ CSAPP ä»‹ç»çš„æ ˆç»“æ„</p><pre class="line-numbers language-none"><code class="language-none">é«˜åœ°å€            |  å‚æ•°7                |            |  å‚æ•°8                |            |  ...                 |  â† è°ƒç”¨å‰push            |  è¿”å›åœ°å€             |  â† callæŒ‡ä»¤è‡ªåŠ¨push            |  ä¿å­˜çš„å¯„å­˜å™¨å€¼        |  â† åˆšè¿›å…¥å‡½æ•°æ—¶push            |  æœ¬åœ°å˜é‡1            |            |  æœ¬åœ°å˜é‡2            |            |  ...                 |   â† å½“å‰rspæŒ‡å‘è¿™é‡Œä½åœ°å€<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸‹é¢æˆ‘ä»¬æ¥ç¼–è¯‘ CSAPP ä¹¦ä¸­çš„ä¸€æ®µä»£ç ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">long</span> <span class="token function">caller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">long</span> arg1 <span class="token operator">=</span> <span class="token number">534</span><span class="token punctuation">;</span>    <span class="token keyword">long</span> arg2 <span class="token operator">=</span> <span class="token number">1057</span><span class="token punctuation">;</span>    <span class="token keyword">long</span> sum <span class="token operator">=</span> <span class="token function">swap_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>arg1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>arg2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">long</span> diff <span class="token operator">=</span> arg1 <span class="token operator">-</span> arg2<span class="token punctuation">;</span>    <span class="token keyword">return</span> sum <span class="token operator">*</span> diff<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œæ˜¯ CSAPP ä¹¦ä¸Šç»™å‡ºçš„ç¼–è¯‘ç»“æœï¼š</p><pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token label function">caller:</span>    subq    <span class="token number">$16</span>, <span class="token operator">%</span><span class="token register variable">rsp</span>       <span class="token comment">; Allocate 16 bytes for stack frame</span>    movq    <span class="token number">$534</span>, (<span class="token operator">%</span><span class="token register variable">rsp</span>)    <span class="token comment">; Store 534 in arg1</span>    movq    <span class="token number">$1057</span>, <span class="token number">8</span>(<span class="token operator">%</span><span class="token register variable">rsp</span>)  <span class="token comment">; Store 1057 in arg2</span>    leaq    <span class="token number">8</span>(<span class="token operator">%</span><span class="token register variable">rsp</span>), <span class="token operator">%</span><span class="token register variable">rsi</span>   <span class="token comment">; Compute &amp;arg2 as second argument</span>    movq    <span class="token operator">%</span><span class="token register variable">rsp</span>, <span class="token operator">%</span><span class="token register variable">rdi</span>      <span class="token comment">; Compute &amp;arg1 as first argument</span>    call    swap_add        <span class="token comment">; Call swap_add(&amp;arg1, &amp;arg2)</span>    movq    (<span class="token operator">%</span><span class="token register variable">rsp</span>), <span class="token operator">%</span><span class="token register variable">rdx</span>    <span class="token comment">; Get arg1</span>    subq    <span class="token number">8</span>(<span class="token operator">%</span><span class="token register variable">rsp</span>), <span class="token operator">%</span><span class="token register variable">rdx</span>   <span class="token comment">; Compute diff = arg1 - arg2</span>    imulq   <span class="token operator">%</span><span class="token register variable">rdx</span>, <span class="token operator">%</span><span class="token register variable">rax</span>      <span class="token comment">; Compute sum * diff</span>    addq    <span class="token number">$16</span>, <span class="token operator">%</span><span class="token register variable">rsp</span>       <span class="token comment">; Deallocate stack frame</span>    ret                     <span class="token comment">; Return</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œåˆ™æ˜¯åœ¨ xv6 é‡Œå¾—åˆ°çš„ç¼–è¯‘ç»“æœï¼š</p><pre class="line-numbers language-none"><code class="language-none">0000000000000034 &lt;caller&gt;:long caller()  34:1141                addisp,sp,-16  36:e422                sds0,8(sp)  38:0800                addis0,sp,16  3a:000cb537            luia0,0xcb  3e:25d50513            addia0,a0,605 # cb25d &lt;base+0xca24d&gt;  42:6422                lds0,8(sp)  44:0141                addisp,sp,16  46:8082                ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥æ³¨æ„åˆ° CSAPP åªæ˜¯æŠŠå±€éƒ¨å˜é‡ arg1 å’Œ arg2 å­˜å‚¨åœ¨äº†æ ˆä¸­ï¼Œè€Œ xv6 çš„ <code>sd s0,8(sp)</code> æŠŠè°ƒç”¨è€…çš„æ ˆå¸§æŒ‡é’ˆå‹å…¥äº†æ ˆä¸­ã€‚</p><p>äº§ç”Ÿè¿™ç§å·®å¼‚çš„åŸå› æ˜¯ç¼–è¯‘å™¨çš„ä¼˜åŒ–ï¼ŒCSAPP é‡Œçš„ç¼–è¯‘å™¨è®¤ä¸ºé€šè¿‡ <code>subq $16, %rsp</code> å’Œ <code>addq $16, %rsp</code> å°±èƒ½å®Œæˆè¿™ä¸ªå‡½æ•°çš„å·¥ä½œï¼Œæ‰€ä»¥æ²¡æœ‰å­˜å‚¨æ ˆå¸§æŒ‡é’ˆï¼›xv6 åˆ™ä¸ºäº†æ–¹ä¾¿æ•™å­¦ï¼ŒåŒ…å«äº†æ ˆå¸§æŒ‡é’ˆã€‚</p><h1 id="Alarm"><a href="#Alarm" class="headerlink" title="Alarm"></a>Alarm</h1><p>è¿™é‡Œæˆ‘ä»¬è¦å®ç°ä¸€ä¸ªå«åš <code>sigalarm(interval, handler)</code> çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå®ƒä¼šæ¯éš” interval ä¸ª ticks è°ƒç”¨ä¸€æ¬¡ handler. </p><p>æ¯ä¸ª tick éƒ½ä¼šäº§ç”Ÿä¸€ä¸ªä¸­æ–­ï¼Œæˆ‘ä»¬è¦åšçš„å°±æ˜¯æ¯ä¸­æ–­è‹¥å¹²æ¬¡è°ƒç”¨ä¸€ä¸‹ handler.</p><p>æˆ‘ä»¬è¿˜éœ€è¦å®ç° <code>sigreturn</code>ï¼Œå®ƒæ˜¯ä¸€ä¸ªè¾…åŠ© <code>sigalarm</code> æ­£ç¡®å·¥ä½œçš„ç³»ç»Ÿè°ƒç”¨ã€‚æˆ‘ä»¬æœ‰è¿™æ ·çš„ promiseâ€”â€”ç”¨æˆ·åœ¨è°ƒç”¨ <code>sigalram</code> æ—¶æä¾›çš„ handler å‡½æ•°å¿…é¡»åœ¨ç»“å°¾è°ƒç”¨ <code>sigreturn</code>ã€‚æ€»ä¹‹ï¼Œ<code>sigreturn</code> çš„å·¥ä½œä¸»è¦æ˜¯æŠŠç”¨æˆ·è¿›ç¨‹çŠ¶æ€æ¢å¤åˆ°è¢«ä¸­æ–­æ—¶çš„çŠ¶æ€ã€‚</p><h2 id="å¼€å·¥ï¼"><a href="#å¼€å·¥ï¼" class="headerlink" title="å¼€å·¥ï¼"></a>å¼€å·¥ï¼</h2><p>æˆ‘ä»¬å¯ä»¥æŒ‰ä¸‹é¢çš„æµç¨‹å®Œæˆä»»åŠ¡ï¼š</p><ol><li><p>åœ¨å¼€å§‹ä¹‹å‰ï¼š</p><p> åœ¨ <code>usys.pl</code> ç­‰åœ°æ–¹åšä¸€äº›åŸºå»ºæ¥æŠŠä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨åŠ å…¥åˆ°ç³»ç»Ÿé‡Œ</p></li><li><p>æ¯éš”è‹¥å¹² ticks è°ƒç”¨ä¸€æ¬¡ handlerï¼š</p><p> åœ¨ <code>proc.h</code> é‡ŒåŠ å…¥å­˜å‚¨ intervalã€handler ä»¥åŠè·ç¦»ä¸Šä¸€æ¬¡è°ƒç”¨ handler è¿‡å»çš„ ticks çš„å­—æ®µ</p><p> åœ¨ <code>sysproc.c</code> é‡Œå®ç° <code>sys_sigalarm</code>ï¼Œå®ƒè®°å½•å¹¶å­˜å‚¨ç”¨æˆ·ä¼ è¿›æ¥çš„ interval å’Œ handler</p><p> åœ¨ <code>trap.c</code> çš„ <code>usertrap</code> é‡ŒåŠ å…¥å¯¹ handler çš„è°ƒç”¨ã€‚è¿˜è®°å¾—å—ï¼Œå½“æ‰§è¡Œ SERT æ—¶ï¼Œç¨‹åºè®¡æ•°å™¨ pc è¢«è®¾ç½®ä¸ºå­˜å‚¨åœ¨ sepc å¯„å­˜å™¨ä¸­çš„å€¼ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ä¿®æ”¹ <code>p-&gt;trapframe-&gt;epc</code>.</p></li><li><p>æŠŠç”¨æˆ·è¿›ç¨‹çŠ¶æ€æ¢å¤åˆ°è¢«ä¸­æ–­æ—¶çš„çŠ¶æ€ï¼š</p><p> æˆ‘ä»¬éœ€è¦ä¿å­˜çš„æ˜¯ç”¨æˆ·ä¸­æ–­æ—¶çš„ <code>struct trapframe</code>. æ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨ proc.h é‡Œæ–°å¢ <code>struct trapframe alarm_tf</code> å­—æ®µï¼Œåœ¨ handler è¢«è°ƒç”¨æ—¶æŠŠ p-&gt;trapframe å¤åˆ¶åˆ° alarm_tfï¼Œå¹¶åœ¨ <code>sys_sigreturn</code> è¢«è°ƒç”¨æ—¶æŠŠ alarm_tf å¤åˆ¶å› p-&gt;trapframe.</p></li></ol><p>æˆ‘ä»¬å°±ç›´æ¥æ”¾æœ€ç»ˆä»£ç äº†ã€‚</p><p>é¦–å…ˆåœ¨ proc.h çš„ struct proc é‡Œæ–°å¢è¿™äº›å­—æ®µï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> alarm_freq<span class="token punctuation">;</span>              <span class="token comment">// How many ticks to call alarm_handler once</span>uint64 alarm_handler<span class="token punctuation">;</span>        <span class="token comment">// Handler's user virtual address</span><span class="token keyword">int</span> tick_from_last<span class="token punctuation">;</span>          <span class="token comment">// How many ticks have passed since the last call</span><span class="token keyword">int</span> is_alarming<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">trapframe</span> alarm_tf<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶ååœ¨ sys_proc.c é‡ŒæŠŠç”¨æˆ·ä¼ å…¥çš„ interval å’Œ handler ä¿å­˜ä¸‹æ¥ï¼Œå¹¶åˆå§‹åŒ–ä¸€äº›å’Œè°ƒç”¨ handler ç›¸å…³çš„å˜é‡ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">uint64 <span class="token function">sys_sigalarm</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> ticks<span class="token punctuation">;</span>    uint64 handler<span class="token punctuation">;</span>    <span class="token function">argint</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>ticks<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">argaddr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">myproc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>alarm_freq <span class="token operator">=</span> ticks<span class="token punctuation">;</span>    <span class="token function">myproc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>alarm_handler <span class="token operator">=</span> handler<span class="token punctuation">;</span>    <span class="token function">myproc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>tick_from_last <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">myproc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>is_alarming <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¹‹åä¿®æ”¹ trap.c å®Œæˆå¯¹ handler çš„è°ƒç”¨ä»¥åŠå¯¹ç”¨æˆ·è¿›ç¨‹çŠ¶æ€çš„ä¿å­˜ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span>which_dev <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-></span>alarm_freq <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>p<span class="token operator">-></span>is_alarming <span class="token operator">&amp;&amp;</span> p<span class="token operator">-></span>tick_from_last <span class="token operator">>=</span> p<span class="token operator">-></span>alarm_freq <span class="token operator">&amp;&amp;</span>            p<span class="token operator">-></span>tick_from_last <span class="token operator">%</span> p<span class="token operator">-></span>alarm_freq <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            p<span class="token operator">-></span>is_alarming <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token function">memmove</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token operator">-></span>alarm_tf<span class="token punctuation">,</span> p<span class="token operator">-></span>trapframe<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token operator">-></span>trapframe<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            p<span class="token operator">-></span>trapframe<span class="token operator">-></span>epc <span class="token operator">=</span> p<span class="token operator">-></span>alarm_handler<span class="token punctuation">;</span>            p<span class="token operator">-></span>tick_from_last <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            p<span class="token operator">-></span>tick_from_last <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ€ååœ¨è¿”å›æ—¶é‡ç½®ç”¨æˆ·è¿›ç¨‹çŠ¶æ€ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">uint64 <span class="token function">sys_sigreturn</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">proc</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">myproc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">memmove</span><span class="token punctuation">(</span>p<span class="token operator">-></span>trapframe<span class="token punctuation">,</span> <span class="token operator">&amp;</span>p<span class="token operator">-></span>alarm_tf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token operator">-></span>trapframe<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    p<span class="token operator">-></span>is_alarming <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> p<span class="token operator">-></span>alarm_tf<span class="token punctuation">.</span>a0<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="ä¸€äº›å°æƒ³æ³•"><a href="#ä¸€äº›å°æƒ³æ³•" class="headerlink" title="ä¸€äº›å°æƒ³æ³•"></a>ä¸€äº›å°æƒ³æ³•</h2><p>ä¸ºä»€ä¹ˆè¯´â€œPrevent re-entrant calls to the handlerâ€”â€”if a handler hasnâ€™t returned yet, the kernel shouldnâ€™t call it again. test2 tests this.â€ï¼Œå³ä¸èƒ½åœ¨ä¸Šæ¬¡å¯¹ handler çš„è°ƒç”¨å®Œæˆå‰è¿›è¡Œä¸‹æ¬¡è°ƒç”¨ï¼Ÿæˆ‘çŒœæ˜¯å› ä¸ºæˆ‘ä»¬ä¼šä¿å­˜è°ƒç”¨å‰çš„ç”¨æˆ·è¿›ç¨‹çŠ¶æ€ï¼Œè€Œåœ¨ä¸Šæ¬¡ handler å®Œæˆå‰å†æ¬¡è°ƒç”¨ handler å°±ä¼šä¿å­˜ä¸Šæ¬¡ handler æ­£åœ¨æ‰§è¡Œæ—¶çš„ç”¨æˆ·è¿›ç¨‹çŠ¶æ€ï¼Œè¿™ä¼šè¦†ç›–æœ€å¼€å§‹çš„ç”¨æˆ·è¿›ç¨‹çŠ¶æ€ã€‚</p><p>å†è¯´å¥é¢˜å¤–è¯ï¼Œæ„Ÿè§‰ Page Tables çš„ hard çš„éš¾åº¦æ¯”è¿™ä¸ªéš¾ä¸å°‘â€¦â€¦æœç„¶ All hards are hard, but some hards are harder than othersğŸ« ğŸ« </p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;RISC-V-assembly&quot;&gt;&lt;a href=&quot;#RISC-V-assembly&quot; class=&quot;headerlink&quot; title=&quot;RISC-V assembly&quot;&gt;&lt;/a&gt;&lt;strong&gt;RISC-V assembly&lt;/strong&gt;&lt;/h1&gt;&lt;p&gt;åœ¨</summary>
      
    
    
    
    <category term="å…¬å¼€è¯¾" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/"/>
    
    <category term="MIT-6.S081" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/MIT-6-S081/"/>
    
    <category term="Labs" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/MIT-6-S081/Labs/"/>
    
    
  </entry>
  
  <entry>
    <title>Lab 3 Page Tables</title>
    <link href="http://rinevard.github.io/wiki/learning/open-course/MIT-6.S081/Labs/lab3-pagetable/"/>
    <id>http://rinevard.github.io/wiki/learning/open-course/MIT-6.S081/Labs/lab3-pagetable/</id>
    <published>2025-10-28T08:28:22.000Z</published>
    <updated>2025-10-28T08:29:01.912Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Inspect-a-user-process-page-table"><a href="#Inspect-a-user-process-page-table" class="headerlink" title="Inspect a user-process page table"></a><strong>Inspect a user-process page table</strong></h1><p>è¿™é“é¢˜è®©æˆ‘ä»¬è§£é‡Šä¸€ä¸‹ <code>print_pgtbl</code> çš„æ‰“å°ç»“æœï¼Œé¦–å…ˆè®©æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒæ‰“å°äº†ä»€ä¹ˆï¼š</p><pre class="line-numbers language-none"><code class="language-none">print_pgtbl startingva 0x0 pte 0x21FCD85B pa 0x87F36000 perm 0x5Bva 0x1000 pte 0x21FD141B pa 0x87F45000 perm 0x1Bva 0x2000 pte 0x21FD1017 pa 0x87F44000 perm 0x17va 0x3000 pte 0x21FD4007 pa 0x87F50000 perm 0x7va 0x4000 pte 0x21FC70D7 pa 0x87F1C000 perm 0xD7va 0x5000 pte 0x0 pa 0x0 perm 0x0va 0x6000 pte 0x0 pa 0x0 perm 0x0va 0x7000 pte 0x0 pa 0x0 perm 0x0va 0x8000 pte 0x0 pa 0x0 perm 0x0va 0x9000 pte 0x0 pa 0x0 perm 0x0va 0xFFFF6000 pte 0x0 pa 0x0 perm 0x0va 0xFFFF7000 pte 0x0 pa 0x0 perm 0x0va 0xFFFF8000 pte 0x0 pa 0x0 perm 0x0va 0xFFFF9000 pte 0x0 pa 0x0 perm 0x0va 0xFFFFA000 pte 0x0 pa 0x0 perm 0x0va 0xFFFFB000 pte 0x0 pa 0x0 perm 0x0va 0xFFFFC000 pte 0x0 pa 0x0 perm 0x0va 0xFFFFD000 pte 0x0 pa 0x0 perm 0x0va 0xFFFFE000 pte 0x21FC94C7 pa 0x87F25000 perm 0xC7va 0xFFFFF000 pte 0x2000184B pa 0x80006000 perm 0x4Bprint_pgtbl: OK<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç»“åˆ <code>print_pgtbl</code> çš„å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ <code>pgtbltest</code> éå†äº†ç”¨æˆ·è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´å¼€å¤´å’Œæœ«å°¾çš„ä¸€äº›åœ°å€ï¼Œå¹¶æ‰“å°å‡ºå®ƒä»¬å¯¹åº”çš„ PTEã€ç‰©ç†åœ°å€ã€æƒé™ä½ã€‚è®©æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ PTE çš„ç»“æ„ï¼š</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab3-pagetable/pte.png" alt=""></p><p>ç„¶åæˆ‘ä»¬ä»¥ <code>va 0x4000 pte 0x21FC70D7 pa 0x87F1C000 perm 0xD7</code> ä¸ºä¾‹ï¼Œè§£æä¸€ä¸‹å…¶æ‰“å°çš„å†…å®¹ã€‚é¦–å…ˆæˆ‘ä»¬ä» PTE ä¸­æå–å‡º Physical Page Numberï¼ˆPPNï¼‰å’Œæƒé™ä½ï¼š</p><pre class="line-numbers language-none"><code class="language-none">&#x2F;&#x2F; æ‰“å° PPN&#x2F;&#x2F; è™šæ‹Ÿåœ°å€çš„æœ«å°¾ 12 ä½æ˜¯ 0, æ‰€ä»¥ç‰©ç†åœ°å€åç§»é‡ä¸º 0&#x2F;&#x2F; ç‰©ç†åœ°å€ä¸º ((pte &gt;&gt; 10) &lt;&lt; 12) + 0 å³ 0x87f1c000(gdb) p &#x2F;x (0x21FC70D7 &gt;&gt; 10)$17 &#x3D; 0x87f1c&#x2F;&#x2F; æ„é€ ä¸€ä¸ªæœ«å°¾ 10 ä½ä¸º 1 çš„é‡, æ–¹ä¾¿åç»­å–å‡ºæƒé™ä½(gdb) set $mask &#x3D; ((1 &lt;&lt; 10) - 1)(gdb) p &#x2F;t $mask$18 &#x3D; 1111111111&#x2F;&#x2F; åˆ†åˆ«ç”¨äºŒè¿›åˆ¶å’Œåå…­è¿›åˆ¶æ‰“å°æƒé™ä½(gdb) p &#x2F;t (0x21FC70D7 &amp; $mask)$19 &#x3D; 11010111(gdb) p &#x2F;x (0x21FC70D7 &amp; $mask)$20 &#x3D; 0xd7<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ£€éªŒå¯çŸ¥å’Œ <code>print_pgtbl</code> çš„æ‰“å°ç»“æœä¸€è‡´ã€‚å¯¹ç…§æƒé™ä½çš„æœ«äº”ä½ 10111 å’Œ PTE çš„æœ«å°¾äº”ä½ UXWRVï¼Œå¯çŸ¥è¿™é‡Œæ˜¯ç”¨æˆ·å†…å­˜ã€ä¸å¯æ‰§è¡Œã€å¯å†™ã€å¯è¯»ã€åˆæ³•ã€‚</p><p>æˆ‘ä»¬å¯ä»¥å†æ£€æŸ¥ä¸€ä¸‹ <code>va 0xFFFFF000 pte 0x2000184B pa 0x80006000 perm 0x4B</code>ï¼Œä¼šå‘ç°å®ƒçš„æƒé™ä½æœ«äº”ä½æ˜¯ 01011ï¼Œè¯´æ˜è¿™é‡Œæ˜¯éç”¨æˆ·å†…å­˜ã€å¯ä»¥æ‰§è¡Œã€ä¸å¯å†™ã€å¯è¯»ã€åˆæ³•ã€‚</p><p>å¯¹ç…§ä¸‹é¢çš„ç”¨æˆ·è¿›ç¨‹è™šæ‹Ÿå†…å­˜ç©ºé—´å›¾å¯çŸ¥æˆ‘ä»¬åˆ†æçš„ç¬¬ä¸€æ®µè™šæ‹Ÿåœ°å€ <code>0x4000</code> å¤§çº¦åœ¨å¼€å¤´ä½ç½®ï¼Œç¡®å®æ˜¯ç”¨æˆ·çš„ä¸œè¥¿ï¼›è€Œåˆ†æçš„ç¬¬äºŒæ®µ <code>0xFFFFF000</code> åˆ™åœ¨æ¥è¿‘æœ«å°¾çš„ä½ç½®ï¼Œç”¨äºå­˜å‚¨ç³»ç»Ÿè°ƒç”¨ç›¸å…³çš„é™·é˜±ä»£ç ã€‚</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab3-pagetable/user_addr_space.png" alt=""></p><p>æˆ‘ä»¬è¿˜å¯ä»¥è¿›ä¸€æ­¥æ‰“å°ä¸€ä¸‹å†…å­˜é‡Œçš„å€¼ã€‚å¯åŠ¨ gdbï¼Œç”¨ <code>file user/_pgtbltest</code> åŠ è½½ç¬¦å·è¡¨ï¼Œç„¶ååœ¨ <code>main</code> è®¾ç½®æ–­ç‚¹ï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½åœ¨åŠ è½½ç”¨æˆ·é¡µè¡¨æ—¶æ‰“å°å„ä¸ªè™šæ‹Ÿåœ°å€çš„å€¼ï¼š</p><pre class="line-numbers language-none"><code class="language-none">(gdb) p *0x0$7 &#x3D; -335146751(gdb) p *0x1000$8 &#x3D; 72(gdb) p *0x5000Cannot access memory at address 0x5000(gdb) p *0xFFFFE000Cannot access memory at address 0xffffe000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯¹ç…§æœ€å¼€å§‹çš„ <code>print_pgtbl</code> çš„æ‰“å°ç»“æœï¼ˆå…³æ³¨å…¶æƒé™ä½ï¼‰ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬èƒ½æ­£ç¡®æ‰“å° <code>0x0</code> å’Œ <code>0x1000</code> ï¼Œå®ƒä»¬æ˜¯ç”¨æˆ·å†…å­˜ã€å¯è¯»ã€åˆæ³•çš„è™šæ‹Ÿåœ°å€çš„å†…å®¹ã€‚è€Œ <code>0x5000</code> æ˜¯ä¸åˆæ³•çš„åœ°å€æ‰€ä»¥æ— æ³•æ‰“å°ï¼Œ<code>0xFFFFE000</code> æ˜¯éç”¨æˆ·å†…å­˜ï¼ˆå†…æ ¸å†…å­˜ï¼‰æ‰€ä»¥æ— æ³•æ‰“å°ã€‚</p><h1 id="Speed-up-system-calls"><a href="#Speed-up-system-calls" class="headerlink" title="Speed up system calls"></a>Speed up system calls</h1><p>è¿™é“é¢˜è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç‰¹æ®Šçš„å†…å­˜é¡µå¹¶æŠŠè¿›ç¨‹ pid å­˜å‚¨åœ¨é‡Œé¢ï¼Œè¿™æ ·æˆ‘ä»¬åœ¨è·å– pid æ—¶å°±ä¸å¿…åšç³»ç»Ÿè°ƒç”¨ <code>getpid</code>ï¼Œè€Œæ˜¯å¯ä»¥ç›´æ¥è°ƒç”¨ <code>ugetpid</code>ï¼Œä»è€Œæ— éœ€é™·å…¥å†…æ ¸ä»¥æé«˜æ•ˆç‡ã€‚</p><p>æç¤ºé‡Œè¯´æˆ‘ä»¬åˆ›å»ºçš„è¿™ä¸ªé¡µé¢ä¼šå’Œ <code>trapframe</code> æœ‰å¾ˆå¤šç›¸ä¼¼ä¹‹å¤„â€”â€”å®ƒä»¬éƒ½åœ¨è¿›ç¨‹åˆå§‹åŒ–æ—¶è‡ªåŠ¨åˆ›å»ºï¼Œåœ¨è¿›ç¨‹é€€å‡ºæ—¶è‡ªåŠ¨é‡Šæ”¾ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥å®Œæˆä»»åŠ¡ï¼š</p><ol><li>å®šä¹‰ <code>usyscall</code>ï¼šåœ¨ <code>struct proc</code> é‡Œæ·»åŠ  <code>struct usyscall *usyscall</code></li><li><p>è¿›ç¨‹åˆå§‹åŒ–æ—¶åˆ›å»ºé¡µé¢ï¼šé˜…è¯» <code>fork</code> çš„ä»£ç å¯ä»¥çŸ¥é“æˆ‘ä»¬è°ƒç”¨ <code>allocproc</code> ä»¥åˆ›å»ºè¿›ç¨‹ã€‚</p><p> åœ¨ <code>allocproc</code> é‡Œï¼Œæˆ‘ä»¬ç”¨ <code>kalloc</code> ç»™ <code>trapframe</code> åˆ†é…äº†ä¸€ä¸ªç‰©ç†é¡µï¼Œç„¶åè°ƒç”¨ <code>proc_pagetable</code> æ¥åšé¡µè¡¨æ˜ å°„ã€‚</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">proc</span> <span class="token operator">*</span><span class="token function">allocproc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// ...</span>    <span class="token comment">// Allocate a trapframe page.</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token operator">-></span>trapframe <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">trapframe</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">kalloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">freeproc</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// An empty user page table.</span>    p<span class="token operator">-></span>pagetable <span class="token operator">=</span> <span class="token function">proc_pagetable</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p> æ‰€ä»¥ç…§è‘«èŠ¦ç”»ç“¢å°±è¡Œï¼Œå…ˆåœ¨ <code>allocproc</code> é‡ŒåŠ å…¥ç»™ <code>usyscall</code> åˆ†é…ç‰©ç†é¡µçš„ä»£ç ï¼ˆè®°å¾—æŠŠ <code>pid</code> å­˜è¿›å»ï¼‰ï¼š</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// Allocate a usyscall page</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token operator">-></span>usyscall <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">usyscall</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">kalloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">freeproc</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>p<span class="token operator">-></span>usyscall<span class="token operator">-></span>pid <span class="token operator">=</span> p<span class="token operator">-></span>pid<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p> ç„¶ååœ¨ <code>proc_pagetable</code> åŠ å…¥é¡µè¡¨æ˜ å°„çš„ä»£ç ï¼š</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// map the usyscall page just below the trapframe page, for</span><span class="token comment">// data sharing between userspace and the kernel</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mappages</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> USYSCALL<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">,</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span><span class="token punctuation">(</span>p<span class="token operator">-></span>usyscall<span class="token punctuation">)</span><span class="token punctuation">,</span>             PTE_R <span class="token operator">|</span> PTE_U<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">uvmunmap</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> TRAPFRAME<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">uvmunmap</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> TRAMPOLINE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">uvmfree</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>é€€å‡ºæ—¶é‡Šæ”¾ï¼šæˆ‘ä»¬çŸ¥é“è¿›ç¨‹è°ƒç”¨ <code>exit</code> æ¥ä¸‹ç­ï¼Œä½†å…¶å®è°ƒç”¨ <code>exit</code> åè¿›ç¨‹å¹¶æ²¡æœ‰ç«‹å³é”€æ¯è‡ªèº«ï¼Œè€Œæ˜¯è¿›å…¥ ZOMBIE æ€ç­‰å¾…çˆ¶è¿›ç¨‹çš„ <code>wait</code> æ¥å›æ”¶ã€‚å…·ä½“å¯ä»¥çœ‹çœ‹ <code>proc.c</code>ï¼Œè¿™é‡Œä¸å¤šèµ˜è¿°ã€‚</p><p> æ€»ä¹‹çœ‹å‘ <code>wait</code> å‡½æ•°ï¼Œå¯ä»¥å‘ç°æˆ‘ä»¬è°ƒç”¨ <code>freeproc</code> æ¥é‡Šæ”¾è¿›ç¨‹ã€‚</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">freeproc</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">proc</span> <span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-></span>trapframe<span class="token punctuation">)</span>        <span class="token function">kfree</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token operator">-></span>trapframe<span class="token punctuation">)</span><span class="token punctuation">;</span>    p<span class="token operator">-></span>trapframe <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-></span>pagetable<span class="token punctuation">)</span>        <span class="token function">proc_freepagetable</span><span class="token punctuation">(</span>p<span class="token operator">-></span>pagetable<span class="token punctuation">,</span> p<span class="token operator">-></span>sz<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p> å¯¹ç…§ä»£ç å¯¹ <code>trapframe</code> çš„å¤„ç†ï¼Œæˆ‘ä»¬è¦åœ¨ <code>freeproc</code> é‡ŒåŠ å…¥é‡Šæ”¾ç‰©ç†é¡µçš„ä»£ç ï¼š</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-></span>usyscall<span class="token punctuation">)</span>    <span class="token function">kfree</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token operator">-></span>usyscall<span class="token punctuation">)</span><span class="token punctuation">;</span>p<span class="token operator">-></span>usyscall <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p> ç„¶åä¿®æ”¹ <code>proc_freepagetable</code> ä»¥åˆ é™¤é¡µè¡¨æ˜ å°„ï¼š</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">uvmunmap</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> USYSCALL<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ol><p>é—²ç€ä¹Ÿæ˜¯é—²ç€ï¼Œä¸å¦‚å’Œæˆ‘ä¸€èµ·çœ‹çœ‹ <code>uvmfree</code> ä¸ºä»€ä¹ˆæ²¡æœ‰è‡ªåŠ¨é‡Šæ”¾ <code>trapframe</code> å’Œ <code>usyscall</code>ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">uvmfree</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">,</span> uint64 sz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>sz <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token function">uvmunmap</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">PGROUNDUP</span><span class="token punctuation">(</span>sz<span class="token punctuation">)</span> <span class="token operator">/</span> PGSIZE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">freewalk</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™æ®µä»£ç è°ƒç”¨ <code>uvmunmap</code> æ¥é‡Šæ”¾æ‰€æœ‰åœ¨é¡µè¡¨é‡Œæœ‰è®°å½•çš„ç‰©ç†é¡µï¼Œç„¶åè°ƒç”¨ <code>freewalk</code> æ¥é‡Šæ”¾é¡µè¡¨è‡ªèº«ã€‚</p><p>è¿™é‡Œçš„ <code>uvmunmap(pagetable, 0, PGROUNDUP(sz) / PGSIZE, 1)</code> è¡¨ç¤ºé‡Šæ”¾è™šæ‹Ÿåœ°å€ä» <code>0</code> åˆ° <code>0 + PGROUNDUP(sz) / PGSIZE</code> çš„å†…å®¹ï¼Œå³é‡Šæ”¾ç”¨æˆ·å†…å­˜çš„å†…å®¹ã€‚</p><p>ä½† <code>trapframe</code> å’Œ <code>usyscall</code> ä¸æ˜¯ç”¨æˆ·å†…å­˜çš„å†…å®¹ï¼Œå®ƒä»¬è¢«å­˜æ”¾åœ¨è™šæ‹Ÿåœ°å€çš„é¡¶éƒ¨ï¼ˆåˆ†åˆ«åœ¨ TRAPFRAME å’Œ USYSCALLï¼‰ï¼Œæ‰€ä»¥å®ƒä»¬æ²¡æœ‰è¢«é‡Šæ”¾ã€‚</p><h1 id="Print-a-page-table"><a href="#Print-a-page-table" class="headerlink" title="Print a page table"></a>Print a page table</h1><p>å…ˆæ¥çœ‹çœ‹æ‰“å°ç»“æœå§ï¼š</p><pre class="line-numbers language-none"><code class="language-none">page table 0x0000000087f22000 ..0x0000000000000000: pte 0x0000000021fc7801 pa 0x0000000087f1e000 .. ..0x0000000000000000: pte 0x0000000021fc7401 pa 0x0000000087f1d000 .. .. ..0x0000000000000000: pte 0x0000000021fc7c5b pa 0x0000000087f1f000 .. .. ..0x0000000000001000: pte 0x0000000021fc701b pa 0x0000000087f1c000 .. .. ..0x0000000000002000: pte 0x0000000021fc6cd7 pa 0x0000000087f1b000 .. .. ..0x0000000000003000: pte 0x0000000021fc6807 pa 0x0000000087f1a000 .. .. ..0x0000000000004000: pte 0x0000000021fc64d7 pa 0x0000000087f19000 ..0xffffffffc0000000: pte 0x0000000021fc8401 pa 0x0000000087f21000 .. ..0xffffffffffe00000: pte 0x0000000021fc8001 pa 0x0000000087f20000 .. .. ..0xffffffffffffd000: pte 0x0000000021fd4c13 pa 0x0000000087f53000 .. .. ..0xffffffffffffe000: pte 0x0000000021fd00c7 pa 0x0000000087f40000 .. .. ..0xfffffffffffff000: pte 0x000000002000184b pa 0x0000000080006000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç»“æœæ¯” 2024 çš„ä½œä¸šæ–‡æ¡£å¤šäº†ä¸€è¡Œ</p><pre class="line-numbers language-none"><code class="language-none">.. .. ..0x0000000000000000: pte 0x0000000021fc7c5b pa 0x0000000087f1f000<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è¿™æ˜¯æ­£ç¡®è¡¨ç°ã€‚2024 çš„ä½œä¸šæ–‡æ¡£è¿™é‡Œå†™é”™äº†ï¼Œ2025 çš„ç‰ˆæœ¬å°±åŠ å…¥äº†è¿™è¡Œã€‚</p><p>å¦‚æç¤ºæ‰€è¨€ï¼Œè¿™ä¸ªå‡½æ•°å’Œ <code>freewalk</code> å¾ˆåƒï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ <code>freewalk</code>ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">freewalk</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// there are 2^9 = 512 PTEs in a page table.</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">512</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">pte_t</span> pte <span class="token operator">=</span> pagetable<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pte <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>pte <span class="token operator">&amp;</span> <span class="token punctuation">(</span>PTE_R <span class="token operator">|</span> PTE_W <span class="token operator">|</span> PTE_X<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// this PTE points to a lower-level page table.</span>            uint64 child <span class="token operator">=</span> <span class="token function">PTE2PA</span><span class="token punctuation">(</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">freewalk</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span><span class="token punctuation">)</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>            pagetable<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pte <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"freewalk: leaf"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">kfree</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>pagetable<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å®ƒéå† L0 çº§é¡µè¡¨çš„ 512 ä¸ª PTEï¼Œå¯¹æ¯ä¸ª PTEï¼Œç”¨ <code>PTE2PA(pte)</code> æ‰¾åˆ°å®ƒæŒ‡å‘çš„æ¬¡çº§é¡µè¡¨çš„ç‰©ç†åœ°å€ï¼Œç„¶åé€’å½’ã€‚å®ƒå¿½ç•¥äº†å¶å­ PTEï¼Œåœ¨æ‰“å°æ—¶æˆ‘ä»¬ä¸éœ€è¦å¿½ç•¥å¶å­ã€‚</p><p>æˆ‘ä»¬å†æ¥çœ‹çœ‹æ‰“å°ç»“æœçš„å½¢å¼</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token punctuation">.</span><span class="token punctuation">.</span> è™šæ‹Ÿåœ°å€<span class="token operator">:</span> pte PTEçš„å€¼ pa ç‰©ç†åœ°å€çš„å€¼<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å‚è€ƒ <code>freewalk</code> æˆ‘ä»¬å°±èƒ½æ‹¿åˆ° PTEï¼Œè°ƒç”¨ <code>PTE2PA</code> å°±èƒ½å¾—åˆ° <code>pa</code>ï¼Œä½†æ€ä¹ˆè·å¾—è™šæ‹Ÿåœ°å€å‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹çœ‹è™šæ‹Ÿåœ°å€çš„ç¿»è¯‘ï¼š</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab3-pagetable/addr_translation.png" alt=""></p><p>ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œå¦‚æœæŠŠ Offset ç½®é›¶ï¼Œæˆ‘ä»¬éœ€è¦ L2ã€L1ã€L0 é¡µè¡¨çš„ PTE çš„ç´¢å¼•æ¥ç¡®å®šè™šæ‹Ÿåœ°å€ã€‚ä½†æˆ‘ä»¬å½“ç„¶æœ‰åŠæ³•è·å¾—è¿™äº›ç´¢å¼•ï¼Œæˆ‘ä»¬ä¸æ˜¯åœ¨éå†é¡µè¡¨å—ï¼Œ<code>for (int i = 0; i &lt; 512; i++)</code> é‡Œçš„ <code>i</code> å°±æ˜¯æˆ‘ä»¬éœ€è¦çš„ç´¢å¼•ï¼æ‰€ä»¥å¦‚æœæˆ‘ä»¬çš„ç´¢å¼•æ˜¯ <code>i, j, k</code>ï¼Œæˆ‘ä»¬æ‰“å°çš„è™šæ‹Ÿåœ°å€å°±æ˜¯ <code>((i &lt;&lt; 30) + (j &lt;&lt; 21) + (k &lt;&lt; 12))</code></p><p>å¤§è‡´æ€è·¯å°±æ˜¯è¿™æ ·ã€‚è¿˜æœ‰ä¸€äº›å°ç»†èŠ‚ï¼š</p><ol><li>ä½œä¸šæ–‡æ¡£é‡Œåœ¨éå† L2 å’Œ L1 çº§é¡µè¡¨æ—¶ä¹Ÿæ‰“å°äº†è™šæ‹Ÿåœ°å€ï¼Œè¿™é‡Œæ‰“å°çš„åœ°å€æ˜¯æŠŠæ¬¡çº§ç´¢å¼•å½“ä½œé›¶ç®—å‡ºçš„åœ°å€ã€‚æ¯”å¦‚å¦‚æœæˆ‘ä»¬åœ¨éå† L1 é¡µè¡¨ï¼ŒL2 é¡µè¡¨çš„ç´¢å¼•æ˜¯ <code>i</code>ï¼ŒL1 é¡µè¡¨çš„ç´¢å¼•æ˜¯ <code>j</code>ï¼Œæ‰“å°çš„å°±æ˜¯ <code>((i &lt;&lt; 30) + (j &lt;&lt; 21) + (0 &lt;&lt; 12))</code></li><li>ä¸ºäº†åœ¨é€’å½’æ—¶å¾—çŸ¥ä¸Šä¸€çº§é¡µè¡¨çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬åŠ å…¥äº† <code>father_va</code> ç”¨äºè®°å½•ä¸Šä¸€çº§çš„è™šæ‹Ÿåœ°å€</li><li>ç¬¦å·æ‹“å±•ç”¨äº†ä¸€äº› tricky çš„æ€§è´¨ï¼Œåœ¨ 255 &lt;&lt; 30 é‚£è¡Œçš„æ³¨é‡Šé‡Œå†™çš„åº”è¯¥è¿˜ç®—æ¸…æ¥š</li></ol><p>æ€»ä¹‹å¯ä»¥å†™å‡ºä¸‹é¢çš„ä»£ç ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">const</span> <span class="token keyword">int</span> MAX_LEVEL <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">_vmprint_helper</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">,</span> uint64 father_va<span class="token punctuation">,</span> <span class="token keyword">int</span> level<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// there are 2^9 = 512 PTEs in a page table.</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">512</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">pte_t</span> pte <span class="token operator">=</span> pagetable<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pte <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> level<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> MAX_LEVEL<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">" .."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">// 255 &lt;&lt; 30 is automatically sign extended to 0xffffffffc0000000</span>            uint64 va <span class="token operator">=</span> father_va <span class="token operator">+</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">12</span> <span class="token operator">+</span> <span class="token number">9</span> <span class="token operator">*</span> level<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%p: pte %p pa %p\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>va<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>pte<span class="token punctuation">,</span>                   <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">PTE2PA</span><span class="token punctuation">(</span>pte<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// this PTE points to a lower-level page table.</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>level <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">_vmprint_helper</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span><span class="token punctuation">)</span><span class="token function">PTE2PA</span><span class="token punctuation">(</span>pte<span class="token punctuation">)</span><span class="token punctuation">,</span> va<span class="token punctuation">,</span> level <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">vmprint</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"page table %p\n"</span><span class="token punctuation">,</span> pagetable<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">_vmprint_helper</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MAX_LEVEL<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="Use-superpages"><a href="#Use-superpages" class="headerlink" title="Use superpages"></a><strong>Use superpages</strong></h1><p>è¿™é“é¢˜è®©æˆ‘ä»¬ç»™ xv6 åŠ å…¥è¶…çº§é¡µã€‚å½“ç”¨æˆ·è¯·æ±‚ä¸€å—è¶…è¿‡ 2MB çš„å†…å­˜ï¼Œæˆ‘ä»¬å°±åˆ†é…è¶…çº§é¡µè€Œéå¤§é‡çš„å°é¡µæ¥ä¼˜åŒ–æ€§èƒ½ã€‚</p><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹æ™®é€šé¡µå’Œè¶…çº§é¡µå„è‡ªæ˜¯å¦‚ä½•ç¿»è¯‘è™šæ‹Ÿåœ°å€çš„ï¼š</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab3-pagetable/regular_vs_super.png" alt=""></p><ol><li><p>æ™®é€šé¡µï¼š</p><p> æ™®é€šé¡µåœ¨ç¿»è¯‘æ—¶æŠŠè™šæ‹Ÿåœ°å€åˆ†æˆ L2, L1, L0, Offset å››ä¸ªéƒ¨åˆ†ã€‚å‰ä¸‰è€…ç”¨äºåœ¨ä¸åŒçº§åˆ«çš„é¡µè¡¨é‡Œåšåç§»æ‰¾åˆ°ä¸‹ä¸€ä¸ªé¡µçš„å¼€å¤´çš„ç‰©ç†åœ°å€ï¼ˆä¸€ä¸ª Page Directory ä¹Ÿæ˜¯ä¸€ä¸ªé¡µï¼‰ï¼ŒOffset åˆ™ç”¨äºè®¡ç®—æœ€ç»ˆçš„ç‰©ç†åœ°å€åç§»ã€‚</p><p> Sv39 è§„å®š PPN å®½åº¦ä¸º 44 ä½ï¼ŒOffset å®½åº¦ 12 ä½ï¼Œä¸€ä¸ªæ™®é€šé¡µçš„å¤§å°å°±æ˜¯ $2^{12}$ bytes = 4KB.</p><p> åœ¨æ‰¾åˆ°äº† L0 leaf åï¼Œæˆ‘ä»¬å°±èƒ½ç”¨ <code>(PPN &lt;&lt; 12) + Offest</code> æ¥è®¡ç®—è™šæ‹Ÿåœ°å€å¯¹åº”çš„ç‰©ç†åœ°å€äº†ã€‚</p></li><li><p>è¶…çº§é¡µï¼š</p><p> è¶…çº§é¡µåˆ™æŠŠè™šæ‹Ÿåœ°å€åˆ†æˆ L2, L1, Offset ä¸‰ä¸ªéƒ¨åˆ†ã€‚</p><p> Sv39 è§„å®šè¶…çº§é¡µçš„ Offset ä¸º 21 ä½ï¼Œè¿™æ˜¯æŠŠåŸæœ¬çš„ L0 å’Œ Offset åˆå¹¶æˆäº†ä¸€ä¸ª 21 ä½çš„ Offsetã€‚è¶…çº§é¡µå¤§å°å°±æ˜¯ $2^{21}$ bytes å³ 2MB.</p><p> è¶…çº§é¡µæ˜¯ 2MB å¯¹é½çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ $56 - \log (2097152) = 35$ ä½æ¥æè¿°ä¸€ä¸ªè¶…çº§é¡µçš„å¼€å¤´ï¼Œæ‰€ä»¥è¶…çº§é¡µå¯¹åº”çš„ L1 leaf å­˜å‚¨çš„ PPN çš„æœ«å°¾ 9 ä½ä¸º 0. è¿™é‡Œæœ‰ $2097152$ æ˜¯å› ä¸º 2MB = 2097152 bytes.</p><p> åœ¨æ‰¾åˆ° L1 leaf åï¼Œæˆ‘ä»¬åŒæ ·ç”¨ <code>(PPN &lt;&lt; 12) + Offest</code> æ¥è®¡ç®—è™šæ‹Ÿåœ°å€å¯¹åº”çš„ç‰©ç†åœ°å€ã€‚</p></li></ol><h2 id="æµ‹è¯•ä»£ç "><a href="#æµ‹è¯•ä»£ç " class="headerlink" title="æµ‹è¯•ä»£ç "></a>æµ‹è¯•ä»£ç </h2><p>éµå¾ªæç¤ºï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ <code>superpg_test</code> åšäº†ä»€ä¹ˆã€‚è¦è¯´æ˜çš„æ˜¯ï¼Œ2024 ç‰ˆæœ¬çš„æµ‹è¯•ä¸å…¨é¢è€Œä¸”æœ‰ bugâ€”â€”åœ¨ <code>supercheck</code> å‡½æ•°çš„æœ«å°¾çš„ for å¾ªç¯é‡Œï¼Œæ¡ä»¶åº”è¯¥æ˜¯ <code>i &lt; 512 * PGSIZE</code> è€Œé <code>i &lt; 512</code>ï¼Œåº”è¯¥æ”¹æˆä¸‹é¢è¿™æ ·ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// check whether different va are mapped to different pa</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">512</span> <span class="token operator">*</span> PGSIZE<span class="token punctuation">;</span> i <span class="token operator">+=</span> PGSIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>s <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> i<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">512</span> <span class="token operator">*</span> PGSIZE<span class="token punctuation">;</span> i <span class="token operator">+=</span> PGSIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>s <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">!=</span> i<span class="token punctuation">)</span>        <span class="token function">err</span><span class="token punctuation">(</span><span class="token string">"wrong value"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ€»ä¹‹æˆ‘ä»¬ä¸‹é¢åˆ†æ 2025 ç‰ˆæœ¬çš„æµ‹è¯•ã€‚2025 ç‰ˆæœ¬çš„æµ‹è¯•å…±åŒ…æ‹¬ <code>supercheck</code>ã€<code>superpg_fork</code> å’Œ <code>superpg_free</code> ä¸‰ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨ <code>supercheck</code>ã€‚<code>supercheck</code> åˆ¤æ–­ä» <code>end</code> ä¹‹åç¬¬ä¸€ä¸ªå¯¹é½è¶…çº§é¡µçš„åœ°å€å¼€å§‹æ˜¯å¦æ˜¯è¶…çº§é¡µï¼Œå…·ä½“çš„åˆ¤æ–­æ–¹æ³•å¯ä»¥å‚è€ƒä¸‹é¢çš„æ³¨é‡Šï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">supercheck</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>end<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">pte_t</span> last_pte <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    uint64 a <span class="token operator">=</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>end<span class="token punctuation">;</span>    uint64 s <span class="token operator">=</span> <span class="token function">SUPERPGROUNDUP</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// Check that virtual address up to the next superpage boundary are mapped to PTE</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> a <span class="token operator">&lt;</span> s<span class="token punctuation">;</span> a <span class="token operator">+=</span> PGSIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">pte_t</span> pte <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">pte_t</span><span class="token punctuation">)</span><span class="token function">pgpte</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pte <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">err</span><span class="token punctuation">(</span><span class="token string">"no pte"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// Check that all virtual address in the superpage share the same valid PTE</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>uint64 p <span class="token operator">=</span> s<span class="token punctuation">;</span> p <span class="token operator">&lt;</span> s <span class="token operator">+</span> <span class="token number">512</span> <span class="token operator">*</span> PGSIZE<span class="token punctuation">;</span> p <span class="token operator">+=</span> PGSIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">pte_t</span> pte <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">pte_t</span><span class="token punctuation">)</span><span class="token function">pgpte</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pte <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token function">err</span><span class="token punctuation">(</span><span class="token string">"no pte"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>last_pte <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> pte <span class="token operator">!=</span> last_pte<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">err</span><span class="token punctuation">(</span><span class="token string">"pte different"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pte <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span>pte <span class="token operator">&amp;</span> PTE_R<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span>pte <span class="token operator">&amp;</span> PTE_W<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">err</span><span class="token punctuation">(</span><span class="token string">"pte wrong"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        last_pte <span class="token operator">=</span> pte<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// Check that different va are mapped to different pa</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">512</span> <span class="token operator">*</span> PGSIZE<span class="token punctuation">;</span> i <span class="token operator">+=</span> PGSIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>s <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">512</span> <span class="token operator">*</span> PGSIZE<span class="token punctuation">;</span> i <span class="token operator">+=</span> PGSIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>s <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">!=</span> i<span class="token punctuation">)</span>            <span class="token function">err</span><span class="token punctuation">(</span><span class="token string">"wrong value"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶åæˆ‘ä»¬ç®€è¦æä¸€ä¸‹å¦å¤–ä¸¤ä¸ªå‡½æ•°çš„ä½œç”¨ï¼š</p><ol><li><code>superpg_fork</code> æ£€æŸ¥è¶…çº§é¡µåœ¨ <code>fork</code> åæ˜¯å¦è¢«æ­£ç¡®å¤åˆ¶ä¸ºè¶…çº§é¡µã€‚</li><li><code>superpg_free</code> æ£€æŸ¥ <code>sbrk</code> èƒ½å¦æ­£ç¡®é‡Šæ”¾æ•´ä¸ªè¶…çº§é¡µï¼Œä»¥åŠèƒ½å¦åœ¨é‡Šæ”¾è¶…çº§é¡µçš„éƒ¨åˆ†å†…å­˜æ—¶å°†è¶…çº§é¡µé€€åŒ–ä¸ºå¤šä¸ªæ™®é€šé¡µï¼ˆ2024 ç‰ˆæœ¬æ²¡æµ‹è¯•è¿™ä¸€ç‚¹ï¼Œä½†è¿™ä¸ªæ˜¯å¾ˆå€¼å¾—åšçš„åŠŸèƒ½ï¼‰ã€‚</li></ol><h2 id="sbrk-è°ƒç”¨é“¾"><a href="#sbrk-è°ƒç”¨é“¾" class="headerlink" title="sbrk è°ƒç”¨é“¾"></a>sbrk è°ƒç”¨é“¾</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬åˆ†æç”¨æˆ·åœ¨è°ƒç”¨ <code>sbrk</code> æ—¶å…·ä½“è°ƒç”¨äº†å“ªäº›å‡½æ•°ã€‚è¿™åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š</p><ol><li>åˆ†é…ï¼šsys_sbrk-&gt;growproc-&gt;uvmalloc -&gt; kalloc/kfree</li><li>é‡Šæ”¾ï¼šsys_sbrk -&gt; growproc -&gt; uvmdealloc -&gt; uvmunmap</li></ol><p>è¦æ³¨æ„çš„æ˜¯å½“åˆ†é…å†…å­˜å‡ºé”™æ—¶ï¼Œ<code>uvmalloc</code> ä¹Ÿä¼šè°ƒç”¨ <code>uvmdealloc</code>ã€‚</p><p>æˆ‘ä»¬ä»æœ€åº•å±‚å‡ºå‘ï¼Œå…ˆåœ¨ kalloc.c é‡Œå®Œæˆå¯¹è¶…çº§é¡µçš„æ”¯æŒã€‚è¿™åŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤ï¼š</p><ol><li><p>æ·»åŠ ä¸€ä¸ªè¶…çº§é¡µé“¾è¡¨</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">spinlock</span> lock<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">run</span> <span class="token operator">*</span>superlist<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">run</span> <span class="token operator">*</span>freelist<span class="token punctuation">;</span><span class="token punctuation">&#125;</span> kmem<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>åœ¨åˆå§‹åŒ–ä»£ç é‡Œåˆå§‹åŒ–è¿™ä¸ªè¶…çº§é¡µé“¾è¡¨</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">const</span> <span class="token keyword">int</span> MAX_SUPER <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">freerange</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>pa_start<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>pa_end<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>    p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">PGROUNDUP</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>pa_start<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> sz<span class="token punctuation">;</span>    <span class="token keyword">int</span> super_cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> p <span class="token operator">+</span> PGSIZE <span class="token operator">&lt;=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa_end<span class="token punctuation">;</span> p <span class="token operator">+=</span> sz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>super_cnt <span class="token operator">&lt;</span> MAX_SUPER <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>p <span class="token operator">%</span> SUPERPGSIZE <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>            p <span class="token operator">+</span> SUPERPGSIZE <span class="token operator">&lt;=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa_end<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            sz <span class="token operator">=</span> SUPERPGSIZE<span class="token punctuation">;</span>            <span class="token function">superfree</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>            super_cnt <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            sz <span class="token operator">=</span> PGSIZE<span class="token punctuation">;</span>            <span class="token function">kfree</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>æ·»åŠ  superalloc å’Œ superfree å‡½æ•°ï¼ˆç…§æŠ„ kalloc å’Œ kfreeï¼‰ï¼š</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">superalloc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">run</span> <span class="token operator">*</span>r<span class="token punctuation">;</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmem<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    r <span class="token operator">=</span> kmem<span class="token punctuation">.</span>superlist<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">)</span>        kmem<span class="token punctuation">.</span>superlist <span class="token operator">=</span> r<span class="token operator">-></span>next<span class="token punctuation">;</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmem<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">)</span>        <span class="token function">memset</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>r<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> SUPERPGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// fill with junk</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>r<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">superfree</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>pa<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">run</span> <span class="token operator">*</span>r<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>pa <span class="token operator">%</span> SUPERPGSIZE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa <span class="token operator">&lt;</span> end <span class="token operator">||</span>        <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>pa <span class="token operator">>=</span> PHYSTOP<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"superfree"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// Fill with junk to catch dangling refs.</span>    <span class="token function">memset</span><span class="token punctuation">(</span>pa<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> SUPERPGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>    r <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">run</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa<span class="token punctuation">;</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmem<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    r<span class="token operator">-></span>next <span class="token operator">=</span> kmem<span class="token punctuation">.</span>superlist<span class="token punctuation">;</span>    kmem<span class="token punctuation">.</span>superlist <span class="token operator">=</span> r<span class="token punctuation">;</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmem<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><p>è‡³æ­¤ï¼Œæœ€åº•å±‚çš„å·¥ä½œå°±åšå®Œäº†ã€‚</p><h2 id="åˆ†é…å†…å­˜"><a href="#åˆ†é…å†…å­˜" class="headerlink" title="åˆ†é…å†…å­˜"></a>åˆ†é…å†…å­˜</h2><p>å›é¡¾å†…å­˜åˆ†é…çš„è°ƒç”¨é“¾ï¼šsys_sbrk-&gt;growproc-&gt;uvmalloc -&gt; kalloc/kfreeï¼Œåœ¨å¼€å§‹ç¼–å†™ä»£ç ä¹‹å‰æˆ‘ä»¬å…ˆåˆ†æä¸€ä¸‹æ¯ä¸€å±‚çš„èŒè´£ã€‚</p><ol><li>sys_sbrk æ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œè´Ÿè´£ç³»ç»Ÿå’Œç”¨æˆ·çš„äº¤äº’</li><li>grow_proc æ˜¯è¿›ç¨‹æŠ½è±¡çš„ä¸€ä¸ªæ¥å£ï¼Œè´Ÿè´£ç®¡ç†è¿›ç¨‹çŠ¶æ€</li><li>uvmalloc æ˜¯è™šæ‹Ÿå†…å­˜å±‚ï¼Œè´Ÿè´£ç®¡ç†è¿›ç¨‹çœ¼ä¸­çš„â€œå†…å­˜â€ï¼Œç®¡ç†è™šæ‹Ÿåˆ°ç‰©ç†çš„æ˜ å°„</li><li>kalloc å’Œ kfree åˆ™æ˜¯ç‰©ç†å†…å­˜å±‚ï¼Œç®¡ç†ç‰©ç†å†…å­˜</li></ol><p>æˆ‘ä»¬åœ¨è¿™é‡Œè¦ä¿®æ”¹çš„æ˜¯ uvmalloc. ç®€å•è¯»ä¸‹å®ƒåŸæœ¬çš„ä»£ç å¯ä»¥å‘ç°å®ƒä¸»è¦è°ƒç”¨çš„æ˜¯ kalloc å’Œ mappages. åœ¨è¶…çº§é¡µä¸­ï¼Œå‰è€…å¯¹åº” superallocï¼Œè€Œå¯¹åè€…æˆ‘è‡ªå·±å†™äº†ä¸€ä¸ª mapsuperpages ä½œä¸ºå¯¹åº”ã€‚ä¸ºäº†è®© mapsuperpages è·‘èµ·æ¥ï¼Œæˆ‘è¿˜å†™äº†ä¸ª l1walk å‡½æ•°ç”¨äºæ‰¾åˆ°ä¸€ä¸ªè™šæ‹Ÿåœ°å€å¯¹åº”çš„ L1 PTE. å…ˆæ¥çœ‹çœ‹ l1walkï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">pte_t</span> <span class="token operator">*</span><span class="token function">l1walk</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">,</span> uint64 va<span class="token punctuation">,</span> <span class="token keyword">int</span> alloc<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>va <span class="token operator">>=</span> MAXVA<span class="token punctuation">)</span>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"walk"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">pte_t</span> <span class="token operator">*</span>pte <span class="token operator">=</span> <span class="token operator">&amp;</span>pagetable<span class="token punctuation">[</span><span class="token function">PX</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> va<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        pagetable <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">pagetable_t</span><span class="token punctuation">)</span><span class="token function">PTE2PA</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">&amp;</span>pagetable<span class="token punctuation">[</span><span class="token function">PX</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> va<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>alloc <span class="token operator">||</span> <span class="token punctuation">(</span>pagetable <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">pde_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">kalloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">memset</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">*</span>pte <span class="token operator">=</span> <span class="token function">PA2PTE</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">)</span> <span class="token operator">|</span> PTE_V<span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">&amp;</span>pagetable<span class="token punctuation">[</span><span class="token function">PX</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> va<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å®ƒå’Œ walk å‡½æ•°åŸºæœ¬ä¸€è‡´ï¼Œä¸è¿‡ walk æ˜¯è¿”å› leafï¼Œè€Œè¿™é‡Œçš„ l1walk è¿”å› L1 PTE.</p><p>ç„¶åçœ‹çœ‹ mapsuperpagesï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">mapsuperpages</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">,</span> uint64 va<span class="token punctuation">,</span> uint64 size<span class="token punctuation">,</span> uint64 pa<span class="token punctuation">,</span>                  <span class="token keyword">int</span> perm<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    uint64 a<span class="token punctuation">,</span> last<span class="token punctuation">;</span>    <span class="token class-name">pte_t</span> <span class="token operator">*</span>pte<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>va <span class="token operator">%</span> SUPERPGSIZE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"mapsuperpages: va not aligned"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>size <span class="token operator">%</span> SUPERPGSIZE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"mapsuperpages: size not aligned"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"mapsuperpages: size"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    a <span class="token operator">=</span> va<span class="token punctuation">;</span>    last <span class="token operator">=</span> va <span class="token operator">+</span> size <span class="token operator">-</span> SUPERPGSIZE<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pte <span class="token operator">=</span> <span class="token function">l1walk</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"mapsuperpages: l1walk failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span>            <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"mapsuperpages: remap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">*</span>pte <span class="token operator">=</span> <span class="token function">PA2PTE</span><span class="token punctuation">(</span>pa<span class="token punctuation">)</span> <span class="token operator">|</span> perm <span class="token operator">|</span> PTE_V <span class="token operator">|</span> PTE_R<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">==</span> last<span class="token punctuation">)</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        a <span class="token operator">+=</span> SUPERPGSIZE<span class="token punctuation">;</span>        pa <span class="token operator">+=</span> SUPERPGSIZE<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™åŸºæœ¬æ˜¯ç…§æŠ„ mappagesï¼Œåªæ˜¯æŠŠæ™®é€šé¡µæ”¹æˆäº†è¶…çº§é¡µã€‚</p><p>æœ€åçœ‹çœ‹æˆ‘ä»¬å¯¹ uvmalloc çš„ä¿®æ”¹ã€‚uvmalloc ä¸»è¦åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œç¬¬ä¸€éƒ¨åˆ†æ˜¯ç”¨ kalloc/superalloc è¯·æ±‚ç‰©ç†å†…å­˜ï¼Œç¬¬äºŒéƒ¨åˆ†æ˜¯ç”¨ mappages/mapsuperpages æŠŠè™šæ‹Ÿå†…å­˜æ˜ å°„åˆ°ç‰©ç†å†…å­˜ä¸Šã€‚</p><p>æˆ‘ä»¬åœ¨æ³¨é‡Šé‡Œæ ‡å‡ºäº†ä¿®æ”¹çš„åœ°æ–¹ï¼Œä¿®æ”¹ 1 å¯¹åº”è¯·æ±‚ç‰©ç†å†…å­˜çš„ç¬¬ä¸€éƒ¨åˆ†ï¼Œä¿®æ”¹ 2 å¯¹åº”åšæ˜ å°„çš„ç¬¬äºŒéƒ¨åˆ†ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">uint64 <span class="token function">uvmalloc</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">,</span> uint64 oldsz<span class="token punctuation">,</span> uint64 newsz<span class="token punctuation">,</span> <span class="token keyword">int</span> xperm<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>mem<span class="token punctuation">;</span>    uint64 a<span class="token punctuation">;</span>    <span class="token keyword">int</span> sz<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>newsz <span class="token operator">&lt;</span> oldsz<span class="token punctuation">)</span>        <span class="token keyword">return</span> oldsz<span class="token punctuation">;</span>    oldsz <span class="token operator">=</span> <span class="token function">PGROUNDUP</span><span class="token punctuation">(</span>oldsz<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>a <span class="token operator">=</span> oldsz<span class="token punctuation">;</span> a <span class="token operator">&lt;</span> newsz<span class="token punctuation">;</span> a <span class="token operator">+=</span> sz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// ä¿®æ”¹1ä»è¿™é‡Œå¼€å§‹</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">%</span> SUPERPGSIZE <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> a <span class="token operator">+</span> SUPERPGSIZE <span class="token operator">&lt;=</span> newsz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            sz <span class="token operator">=</span> SUPERPGSIZE<span class="token punctuation">;</span>            mem <span class="token operator">=</span> <span class="token function">superalloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// If no superpages, use regular pages</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>mem <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                sz <span class="token operator">=</span> PGSIZE<span class="token punctuation">;</span>                mem <span class="token operator">=</span> <span class="token function">kalloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            sz <span class="token operator">=</span> PGSIZE<span class="token punctuation">;</span>            mem <span class="token operator">=</span> <span class="token function">kalloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// ä¿®æ”¹1åˆ°è¿™é‡Œç»“æŸ</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mem <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">uvmdealloc</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> a<span class="token punctuation">,</span> oldsz<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">LAB_SYSCALL</span></span>        <span class="token function">memset</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sz<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>        <span class="token comment">// ä¿®æ”¹2ä»è¿™é‡Œå¼€å§‹</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>sz <span class="token operator">==</span> PGSIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mappages</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> a<span class="token punctuation">,</span> sz<span class="token punctuation">,</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>mem<span class="token punctuation">,</span>                         PTE_R <span class="token operator">|</span> PTE_U <span class="token operator">|</span> xperm<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">kfree</span><span class="token punctuation">(</span>mem<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">uvmdealloc</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> a<span class="token punctuation">,</span> oldsz<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mapsuperpages</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> a<span class="token punctuation">,</span> sz<span class="token punctuation">,</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>mem<span class="token punctuation">,</span>                              PTE_R <span class="token operator">|</span> PTE_U <span class="token operator">|</span> xperm<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">superfree</span><span class="token punctuation">(</span>mem<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">uvmdealloc</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> a<span class="token punctuation">,</span> oldsz<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// ä¿®æ”¹2åˆ°è¿™é‡Œç»“æŸ</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> newsz<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="é‡Šæ”¾å†…å­˜"><a href="#é‡Šæ”¾å†…å­˜" class="headerlink" title="é‡Šæ”¾å†…å­˜"></a>é‡Šæ”¾å†…å­˜</h2><p>åœ¨å®Œæˆäº†åˆ†é…å†…å­˜çš„å·¥ä½œåï¼Œæˆ‘ä»¬å°±èƒ½å†™é‡Šæ”¾å†…å­˜ç›¸å…³çš„ä»£ç äº†ã€‚</p><p>å›é¡¾è°ƒç”¨é“¾ï¼šsys_sbrk -&gt; growproc -&gt; uvmdealloc -&gt; uvmunmapï¼Œæˆ‘ä»¬è¦ä¿®æ”¹ uvmunmap. è¿™éƒ¨åˆ†ä»£ç æ¯”è¾ƒæ£˜æ‰‹ã€‚å®ƒåŸæœ¬åªæ˜¯åœ¨æŒ‰éƒ¨å°±ç­åœ°åˆ æ‰é¡µè¡¨é‡Œä» va å‡ºå‘çš„ npages ä¸ªç‰©ç†é¡µçš„æ˜ å°„ï¼Œå¹¶é€‰æ‹©æ€§é‡Šæ”¾ç‰©ç†å†…å­˜ï¼Œä½†åœ¨åŠ å…¥è¶…çº§é¡µåå®ƒéœ€è¦å®Œæˆè¿™äº›å·¥ä½œï¼š</p><ol><li>è®© <code>uint64 a</code> ä» <code>va</code> å‡ºå‘ï¼Œå¦‚æœé‡åˆ°äº†æ™®é€šé¡µï¼Œèµ°æ™®é€šé¡µçš„ unmap æµç¨‹ï¼Œç„¶å <code>a += PGSIZE</code></li><li>å¦‚æœé‡åˆ°äº†è¶…çº§é¡µï¼Œåˆ¤æ–­ <code>a</code> æ˜¯è¶…çº§é¡µçš„å¼€å¤´è¿˜æ˜¯è¶…çº§é¡µçš„ä¸­é—´<ol><li>å¦‚æœæ˜¯è¶…çº§é¡µçš„å¼€å¤´ï¼Œèµ°è¶…çº§é¡µçš„ unmap æµç¨‹ï¼ˆå’Œæ™®é€šé¡µ unmap åŸºæœ¬ä¸€è‡´ï¼‰ï¼Œç„¶å <code>a += SUPERPGSIZE</code></li><li>å¦‚æœæ˜¯è¶…çº§é¡µçš„ä¸­é—´ï¼ŒæŠŠè¶…çº§é¡µé€€åŒ–æˆè‹¥å¹²ä¸ªæ™®é€šé¡µï¼Œå†èµ°æ™®é€šé¡µé‡Šæ”¾æµç¨‹ï¼Œç„¶å <code>a += PGSIZE</code></li></ol></li></ol><p>è¿™é‡Œä¸»è¦æ˜¯ä¸Šé¢æ­¥éª¤ä¸­çš„ 2b çš„â€œé€€åŒ–â€æ¯”è¾ƒæ£˜æ‰‹ï¼Œæˆ‘æ˜¯æŠŠé¡µè¡¨é‡Œå¯¹åº”è¶…çº§é¡µçš„ L1 leaf è®¾ç½®æˆäº† invalidï¼Œç„¶åæŠŠè¶…çº§é¡µè§†ä½œå¤šä¸ªæ™®é€šé¡µçš„åˆå¹¶ï¼Œä»è¶…çº§é¡µçš„å¼€å¤´å‡ºå‘åšè‹¥å¹²æ¬¡ mappages ä»è€Œå®Œæˆé€€åŒ–ã€‚æ€è·¯å¯ä»¥å‚è€ƒä¸‹å›¾ï¼š</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab3-pagetable/super_demote.png" alt=""></p><p>è¿™é‡Œæ˜¯é€€åŒ–éƒ¨åˆ†çš„ä»£ç ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> perm <span class="token operator">=</span> <span class="token function">PTE_FLAGS</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>uint64 super_va_st <span class="token operator">=</span> <span class="token function">SUPERPGROUNDDOWN</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>uint64 super_pa_st <span class="token operator">=</span> <span class="token function">PTE2PA</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span>pte <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// Make pte invalid to make `mappages` work</span><span class="token keyword">for</span> <span class="token punctuation">(</span>uint64 super_va <span class="token operator">=</span> super_va_st<span class="token punctuation">,</span> super_pa <span class="token operator">=</span> super_pa_st<span class="token punctuation">;</span>     super_va <span class="token operator">&lt;</span> super_va_st <span class="token operator">+</span> SUPERPGSIZE<span class="token punctuation">;</span>     super_va <span class="token operator">+=</span> PGSIZE<span class="token punctuation">,</span> super_pa <span class="token operator">+=</span> PGSIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mappages</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> super_va<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">,</span> super_pa<span class="token punctuation">,</span> perm<span class="token punctuation">)</span> <span class="token operator">!=</span>        <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmunmap: mappages failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å½“ç„¶è¿™æ ·çš„é€€åŒ–æœ‰ä¸€ä¸ªæ½œåœ¨é£é™©â€”â€”æ¯ä¸ªè¿›ç¨‹çš„è¶…çº§é¡µä¸Šé™åœ¨è¿›ç¨‹å¯åŠ¨æ—¶å°±å†³å®šäº†ï¼Œæˆ‘ä»¬çš„é€€åŒ–ä¼šè®©æœ¬è¿›ç¨‹çš„è¶…çº§é¡µä¸Šé™å‡ä¸€ã€‚å¦‚æœæœ‰ä»€ä¹ˆè‡ªåŠ¨åˆå¹¶æ™®é€šé¡µä¸ºè¶…çº§é¡µçš„åŠŸèƒ½å°±å¥½äº†â€¦</p><p>å¦å¤–ï¼Œæˆ‘çš„ä»£ç æŠŠä¹‹å‰æ­¥éª¤é‡Œæè¿°çš„ 1 å’Œ 2b æ•´åˆäº†ä¸€ä¸‹ï¼ˆæ¯•ç«Ÿå®ƒä»¬æœ€åéƒ½èµ°çš„æ˜¯æ™®é€šé¡µé‡Šæ”¾æµç¨‹ï¼‰ï¼Œæ€»ä¹‹è¿™é‡Œæ˜¯å®Œæ•´ä»£ç ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">uvmunmap</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">,</span> uint64 va<span class="token punctuation">,</span> uint64 npages<span class="token punctuation">,</span> <span class="token keyword">int</span> do_free<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    uint64 a<span class="token punctuation">;</span>    <span class="token class-name">pte_t</span> <span class="token operator">*</span>pte<span class="token punctuation">;</span>    <span class="token keyword">int</span> sz<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>va <span class="token operator">%</span> PGSIZE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmunmap: not aligned"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>a <span class="token operator">=</span> va<span class="token punctuation">;</span> a <span class="token operator">&lt;</span> va <span class="token operator">+</span> npages <span class="token operator">*</span> PGSIZE<span class="token punctuation">;</span> a <span class="token operator">+=</span> sz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// If `a` corresponds to a superpage and the superpage starts at `a`,</span>        <span class="token comment">// free the superpage</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pte <span class="token operator">=</span> <span class="token function">l1walk</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">PTE_LEAF</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>            a <span class="token operator">%</span> SUPERPGSIZE <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            sz <span class="token operator">=</span> SUPERPGSIZE<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"va=%ld pte=%ld\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmunmap: not mapped"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>do_free<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                uint64 pa <span class="token operator">=</span> <span class="token function">PTE2PA</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">superfree</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token operator">*</span>pte <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            sz <span class="token operator">=</span> PGSIZE<span class="token punctuation">;</span>            <span class="token comment">// If `a` corresponds to a superpage but the superpage doesn't</span>            <span class="token comment">// start at `a`, demote the superpage into regular pages</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>pte <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">PTE_LEAF</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// Potential issue:</span>                <span class="token comment">// Each process has a max number of superpages defined as</span>                <span class="token comment">// `MAX_SUPER`. But whenever a superpage is demoted, the</span>                <span class="token comment">// process's max number of superpages permanently minus one,</span>                <span class="token comment">// since we view superpage as multiple regular pages.</span>                <span class="token comment">//</span>                <span class="token comment">// A possible solution is to kalloc multiple regular pages,</span>                <span class="token comment">// copy memory into them, and superfree the superpage.</span>                <span class="token keyword">int</span> perm <span class="token operator">=</span> <span class="token function">PTE_FLAGS</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>                uint64 super_va_st <span class="token operator">=</span> <span class="token function">SUPERPGROUNDDOWN</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>                uint64 super_pa_st <span class="token operator">=</span> <span class="token function">PTE2PA</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token operator">*</span>pte <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">)</span>                       <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// Make pte invalid to make `mappages` work</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span>uint64 super_va <span class="token operator">=</span> super_va_st<span class="token punctuation">,</span> super_pa <span class="token operator">=</span> super_pa_st<span class="token punctuation">;</span>                     super_va <span class="token operator">&lt;</span> super_va_st <span class="token operator">+</span> SUPERPGSIZE<span class="token punctuation">;</span>                     super_va <span class="token operator">+=</span> PGSIZE<span class="token punctuation">,</span> super_pa <span class="token operator">+=</span> PGSIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mappages</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> super_va<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">,</span> super_pa<span class="token punctuation">,</span> perm<span class="token punctuation">)</span> <span class="token operator">!=</span>                        <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmunmap: mappages failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">&#125;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">// Free the regular page that begins at `a`</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pte <span class="token operator">=</span> <span class="token function">walk</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>                <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmunmap: walk"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"va=%ld pte=%ld\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmunmap: not mapped"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PTE_FLAGS</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span> <span class="token operator">==</span> PTE_V<span class="token punctuation">)</span>                <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmunmap: not a leaf"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>do_free<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                uint64 pa <span class="token operator">=</span> <span class="token function">PTE2PA</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">kfree</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token operator">*</span>pte <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="fork"><a href="#fork" class="headerlink" title="fork"></a>fork</h2><p>æœ€è‰°éš¾çš„å·¥ä½œå·²ç»åšå®Œäº†ï¼Œæˆ‘ä»¬åªè¦ä¿®æ”¹ uvmcopy å°±èƒ½ä¸‹ç­äº†ï¼è¿™é‡Œçš„ä¿®æ”¹åªæ˜¯åŠ å…¥ä¸€ä¸ªç®€å•çš„åˆ†ç±»ï¼Œåœ¨é‡åˆ°æ™®é€šé¡µæ—¶èµ°æ™®é€šæµç¨‹ï¼Œé‡åˆ°è¶…çº§é¡µæ—¶èµ°è¶…çº§æµç¨‹ã€‚å’±å°±ç›´æ¥æ”¾ä»£ç äº†ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">uvmcopy</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> old<span class="token punctuation">,</span> <span class="token class-name">pagetable_t</span> new<span class="token punctuation">,</span> uint64 sz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">pte_t</span> <span class="token operator">*</span>pte<span class="token punctuation">;</span>    uint64 pa<span class="token punctuation">,</span> i<span class="token punctuation">;</span>    uint flags<span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>mem<span class="token punctuation">;</span>    <span class="token keyword">int</span> szinc<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> sz<span class="token punctuation">;</span> i <span class="token operator">+=</span> szinc<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// super page case</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pte <span class="token operator">=</span> <span class="token function">l1walk</span><span class="token punctuation">(</span>old<span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">PTE_LEAF</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            szinc <span class="token operator">=</span> SUPERPGSIZE<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>                <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmcopy: page not present"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            pa <span class="token operator">=</span> <span class="token function">PTE2PA</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>            flags <span class="token operator">=</span> <span class="token function">PTE_FLAGS</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mem <span class="token operator">=</span> <span class="token function">superalloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>                <span class="token keyword">goto</span> err<span class="token punctuation">;</span>            <span class="token function">memmove</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa<span class="token punctuation">,</span> SUPERPGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mapsuperpages</span><span class="token punctuation">(</span>new<span class="token punctuation">,</span> i<span class="token punctuation">,</span> SUPERPGSIZE<span class="token punctuation">,</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>mem<span class="token punctuation">,</span> flags<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">superfree</span><span class="token punctuation">(</span>mem<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">goto</span> err<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// regular page case</span>        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            szinc <span class="token operator">=</span> PGSIZE<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pte <span class="token operator">=</span> <span class="token function">walk</span><span class="token punctuation">(</span>old<span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>                <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmcopy: pte should exist"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>                <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmcopy: page not present"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            pa <span class="token operator">=</span> <span class="token function">PTE2PA</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>            flags <span class="token operator">=</span> <span class="token function">PTE_FLAGS</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mem <span class="token operator">=</span> <span class="token function">kalloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>                <span class="token keyword">goto</span> err<span class="token punctuation">;</span>            <span class="token function">memmove</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mappages</span><span class="token punctuation">(</span>new<span class="token punctuation">,</span> i<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">,</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>mem<span class="token punctuation">,</span> flags<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">kfree</span><span class="token punctuation">(</span>mem<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">goto</span> err<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>err<span class="token operator">:</span>    <span class="token function">uvmunmap</span><span class="token punctuation">(</span>new<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> i <span class="token operator">/</span> PGSIZE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Inspect-a-user-process-page-table&quot;&gt;&lt;a href=&quot;#Inspect-a-user-process-page-table&quot; class=&quot;headerlink&quot; title=&quot;Inspect a user-process pag</summary>
      
    
    
    
    <category term="å…¬å¼€è¯¾" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/"/>
    
    <category term="MIT-6.S081" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/MIT-6-S081/"/>
    
    <category term="Labs" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/MIT-6-S081/Labs/"/>
    
    
  </entry>
  
  <entry>
    <title>æ¢ç´¢æ—¥å¿—[3]</title>
    <link href="http://rinevard.github.io/wiki/others/thoughts/%E6%8E%A2%E7%B4%A2%E6%97%A5%E5%BF%973/"/>
    <id>http://rinevard.github.io/wiki/others/thoughts/%E6%8E%A2%E7%B4%A2%E6%97%A5%E5%BF%973/</id>
    <published>2025-10-27T13:56:16.000Z</published>
    <updated>2025-10-28T02:14:10.603Z</updated>
    
    <content type="html"><![CDATA[<p>ä¹¦æ¥ä¸Šä¸Šä¸Šå›ï¼ˆæ¢ç´¢æ—¥å¿—[0]ï¼‰ï¼Œä»Šå¤©å’Œä¸Šä¸Šæ¬¡å‚åŠ  Ludum Dare Compo ç»“è¯†çš„æœ‹å‹ä¸€èµ·åƒé¥­äº†ï¼Œéš¾é“è¯´æˆ‘å°±è¦å¤±å»ç¤¾æå±æ€§å’Œå®…å±æ€§äº†å—ï¼</p><p>æ€»ä¹‹å°±æ˜¯ä»–è¿™å‡ å¤©æ¥åŒ—äº¬ç©ï¼Œæˆ‘å°±é¼“èµ·å‹‡æ°”é—®ä»–è¦ä¸è¦æ¥æ‰¾æˆ‘ç©ï¼ˆå…¶å®å¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯ä¸ºäº†æ°´ä¸€ç¯‡æ¢ç´¢æ—¥å¿—ï¼Œæ¢ç´¢æ—¥å¿—é©±åŠ¨æ¢ç´¢ï¼‰ï¼Œç„¶åä»Šå¤©å°±ä¸€èµ·åƒäº†æŠ«è¨è–¯æ¡ç‚¸é¸¡ã€‚</p><p><img src="/images/others/random_thoughts/explore3/rubatotree_food.jpg" alt="å¥½åƒçš„"></p><p>æ„Ÿè§‰è‡ªå·±å®…çš„å¾ˆå¤§åŸå› æ˜¯äº’è”ç½‘å¤ªæœ‰è¶£äº†ã€‚ä»Šå¤©ä¹Ÿæ²¡æœ‰å’Œä»–ä¸€èµ·åˆ°å¤„ç©ï¼ˆæ ¹æ®æˆ‘çš„ç»éªŒå’Œæƒ³è±¡ï¼Œäººä»¬ä¸€èˆ¬æ˜¯ä¼šåœ¨ç›¸èšæ—¶å»ä¸€äº›åœ°ç‚¹é—²é€›çš„ï¼‰ï¼Œè€Œæ˜¯åœ¨é¥­åº—è¾¹åƒé¥­è¾¹ç©æ¸¸æˆé¡ºä¾¿é—²èŠã€‚å’±è¿˜ç»™ä»–è¯•äº†è¯•æœ€è¿‘åšçš„æ–°åŸå‹ï¼ˆæ¢ç´¢æ—¥å¿—[2]ï¼Œæ„Ÿè§‰æ¢ç´¢æ—¥å¿—çš„ç›¸äº’å¼•ç”¨éƒ½å¯ä»¥å˜æˆèŠ‚ç‚¹å›¾äº†ï¼‰ï¼Œæ„Ÿè§‰è¿˜ä¸é”™ã€‚ç„¶åæˆ‘ä»¬å°±åœ¨é¥­åº—å¾…äº†ä¸¤ä¸ªå¤šå°æ—¶ï¼Œç›´åˆ°ä»–å»èµ¶é«˜é“å›å­¦æ ¡ã€‚</p><p>æˆ‘è¿˜è›®å–œæ¬¢è¿™æ ·çš„äº¤æµçš„ï¼Œæœç„¶è¿˜æ˜¯è¦ä¸»åŠ¨å»å’Œåˆ«äººç»“äº¤æ‰è¡Œã€‚å¥½è€¶ï¼Œè¿™åˆæ˜¯ä¸€ä¸ªæ°´æ¢ç´¢æ—¥å¿—çš„æœºä¼šã€‚ç­‰æˆ‘ä¸‹æ¬¡ gamejam çœ‹åˆ°å–œæ¬¢çš„æ¸¸æˆå°±å»æ‰¾ä½œè€…åŠ å¥½å‹ï¼ŒæˆåŠŸäº†å°±æ°´ä¸€ç¯‡ï¼Œå¤±è´¥äº†ä¹Ÿèƒ½æ°´ä¸€ç¯‡ã€‚å½“ç„¶ï¼Œå¦‚æœåªæ˜¯æŠŠèŒƒå›´å±€é™åœ¨æ¸¸æˆé¢†åŸŸä¹Ÿå¤ªç‹­çª„äº†ï¼Œä¸è¿‡ç­‰æˆ‘æ°´å®Œå†è¯´å§ã€‚</p><p>ä¸ºä»€ä¹ˆé…’åº—å«é…’åº—å‘¢ï¼Œå®ƒåœ¨å­—é¢ä¸Šçœ‹èµ·æ¥å¾ˆåƒé¥­åº—ï¼Œå´æ˜¯å±…ä½çš„åœ°æ–¹ã€‚æˆ‘ä¸Šç½‘æœäº†ä¸€ä¸‹ï¼ˆå¦‚æˆ‘æ‰€è¨€ï¼Œäº’è”ç½‘å¤ªæœ‰è¶£äº†ï¼‰ï¼Œè¿™æ˜¯å› ä¸ºå®ƒæ˜¯ä» â€œHotelâ€ ç¿»è¯‘è¿‡æ¥çš„ã€‚å¯¹æ¸…æœ«çš„ä¸­å›½ä¸Šå±‚ç¤¾ä¼šï¼Œâ€Hotelâ€ çš„ç¬¬ä¸€åŠŸèƒ½æ˜¯é¥®å®´ï¼Œè€Œéä½å®¿ã€‚ä¼ ç»Ÿä¸­å›½è´µäººå‡ºè¡Œéƒ½å¸¦ç€ä»†äººï¼Œæ‰€ä»¥ â€œHotelâ€ çš„å°é—´å¯¹ä»–ä»¬å¹¶ä¸æ˜¯ä½å®¿çš„åœ°æ–¹ï¼Œè€Œåªæ˜¯èšå®´çš„åœ°æ–¹ï¼Œæ‰€ä»¥è¢«ç¿»è¯‘æˆäº†â€œé…’åº—â€ã€‚</p><p>æœ‰è¶£çš„ç”Ÿæ´»å¤ªå¤šäº†ï¼Œä¸€ä¸ªäººæ˜¯ä½“éªŒä¸è¿‡æ¥çš„ï¼Œæ‰€ä»¥è¦è®¤è¯†æ›´å¤šçš„ç»å†è¿‡æœ‰è¶£ç”Ÿæ´»çš„äººï¼Œæ‰èƒ½çœ‹åˆ°æ›´å¤šæœ‰è¶£çš„ä½“éªŒã€‚</p><p>åˆæˆ–è®¸äººä»¬åªæ˜¯å› ä¸ºç¢°å·§ç›¸é‡ï¼Œæ‰ç¢°å·§è®¤è¯†äº†å½¼æ­¤å§ã€‚</p><p>å½“ç„¶è¿˜æ˜¯è¦ç‚«è€€ä¸€ä¸‹æ”¶åˆ°çš„å°å¡ç‰‡çš„ï¼</p><p><img src="/images/others/random_thoughts/explore3/rubatotree_shielded_card.jpg" alt=""></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;ä¹¦æ¥ä¸Šä¸Šä¸Šå›ï¼ˆæ¢ç´¢æ—¥å¿—[0]ï¼‰ï¼Œä»Šå¤©å’Œä¸Šä¸Šæ¬¡å‚åŠ  Ludum Dare Compo ç»“è¯†çš„æœ‹å‹ä¸€èµ·åƒé¥­äº†ï¼Œéš¾é“è¯´æˆ‘å°±è¦å¤±å»ç¤¾æå±æ€§å’Œå®…å±æ€§äº†å—ï¼&lt;/p&gt;
&lt;p&gt;æ€»ä¹‹å°±æ˜¯ä»–è¿™å‡ å¤©æ¥åŒ—äº¬ç©ï¼Œæˆ‘å°±é¼“èµ·å‹‡æ°”é—®ä»–è¦ä¸è¦æ¥æ‰¾æˆ‘ç©ï¼ˆå…¶å®å¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯ä¸ºäº†æ°´ä¸€ç¯‡æ¢ç´¢æ—¥å¿—ï¼Œæ¢ç´¢æ—¥å¿—é©±åŠ¨æ¢ç´¢ï¼‰ï¼Œ</summary>
      
    
    
    
    <category term="æ‚è°ˆ" scheme="http://rinevard.github.io/categories/%E6%9D%82%E8%B0%88/"/>
    
    <category term="ç¢ç¢å¿µ" scheme="http://rinevard.github.io/categories/%E6%9D%82%E8%B0%88/%E7%A2%8E%E7%A2%8E%E5%BF%B5/"/>
    
    
  </entry>
  
  <entry>
    <title>æ¢ç´¢æ—¥å¿—[2]</title>
    <link href="http://rinevard.github.io/wiki/others/thoughts/%E6%8E%A2%E7%B4%A2%E6%97%A5%E5%BF%972/"/>
    <id>http://rinevard.github.io/wiki/others/thoughts/%E6%8E%A2%E7%B4%A2%E6%97%A5%E5%BF%972/</id>
    <published>2025-10-27T13:56:15.000Z</published>
    <updated>2025-10-28T02:16:47.945Z</updated>
    
    <content type="html"><![CDATA[<p>é™ªè·‘äº† Supercell ä¸¾åŠçš„ Global AI Game Hack. è™½ç„¶æ„Ÿè§‰è‡ªå·±åšçš„æ¸¸æˆå¹¶ä¸æ¯”è·å¥–ä½œå“å·®ï¼Œä½†æ— æ‰€è°“äº†ï¼Œæˆ‘åšå‡ºäº†è‡ªå·±æ»¡æ„çš„ä½œå“ã€‚</p><p><img src="/images/others/random_thoughts/explore2/wtf.png" alt=""></p><p>åªæ˜¯é™ªè·‘æ˜¯ç§°ä¸ä¸Šæ¢ç´¢çš„ï¼ˆåˆä¸æ˜¯ç¬¬ä¸€æ¬¡é™ªè·‘äº†ï¼‰ã€‚è¿™æ¬¡ä¸»è¦æ˜¯å°è¯•åšäº†ä»¥å‰æ„æ€è¿‡ï¼Œä½†æ„Ÿè§‰â€œè¿™æ ¹æœ¬åšä¸åˆ°ï¼â€çš„ä½œå“ï¼Œè€Œä¸”è¿˜åšå‡ºæ¥äº†ã€‚</p><p>æˆ‘ä»¬è¯¥æ€æ ·åšä¸€ä¸ªåŸºäº LLM çš„æ¸¸æˆï¼Ÿæˆ‘çš„ç¬¬ä¸€ä¸ªç­”æ¡ˆæ˜¯<a href="https://rinevard.itch.io/myriad-by-cards">ç‰Œç”Ÿä¸‡ç‰©</a>ï¼Œè¿™æ˜¯ä¸€ä¸ªæŠŠå¡ç‰Œæ”¾åˆ°ä¸€èµ·è®© AI åŸºäºå †åœ¨ä¸€èµ·çš„å¡ç‰Œè®²æ•…äº‹çš„æ¸¸æˆã€‚ä¸€äº›è¯•ç©çš„ç©å®¶è¿˜æŒºå–œæ¬¢è¿™ä¸ªæ¸¸æˆï¼Œä¸è¿‡ä»‹äº AI å¾ˆéš¾å†™å‡ºæœ‰æ„ä¹‰çš„æ•…äº‹ï¼Œæˆ‘ç®€å•æ”¹äº†æ”¹å°±æ²¡æœ‰ç»§ç»­åšä¸‹å»äº†ï¼ˆç°åœ¨å®ƒå«åšã€Šè¥¿è¡Œç‰Œå½•ã€‹ï¼‰ã€‚</p><p>è®©æˆ‘ä»¬å›åˆ°ä¹‹å‰çš„é—®é¢˜ï¼Œæˆ‘ä»¬è¯¥æ€æ ·åšä¸€ä¸ªåŸºäº LLM çš„æ¸¸æˆï¼Ÿæˆ‘ä»¬å½“ç„¶ä¼šæƒ³ï¼Œå¦‚æœè®©æ¯ä¸ª NPC éƒ½ç”± LLM é©±åŠ¨ï¼Œè¿™ä¸ªä¸–ç•Œå°±ä¼šæœ‰æ— ç©·çš„å¯èƒ½æ€§ã€‚è¿™æ˜¯æˆ‘ä¸€å¼€å§‹å°±åå¯¹çš„ç­”æ¡ˆã€‚æˆ‘è®¤ä¸º AI å›å¤çš„ä¿¡æ¯å¯†åº¦å¤ªä½ï¼Œè¿˜ä¼šèƒ¡ç¼–ä¹±é€ ï¼Œæ²¡æœ‰ä»»ä½•æ„ä¹‰ã€‚æ›´ä½•å†µä¸¤ä¸ª AI ä¹‹é—´èŠäº†å‡ å¥å°±ä¼šå¼€å§‹ç›¸äº’å¤è¯»äº†ã€‚ä¸è¿‡åæ¥ç©åˆ°äº†ä¸€ä¸ª AI ä¼šç›¸äº’äº¤äº’èŠå¤©çš„æ¸¸æˆï¼Œäº²èº«è¿›å…¥ä¸€ä¸ª NPC æœ‰è‡ªå·±çš„ç”Ÿæ´»çš„æ¸¸æˆæ„Ÿè§‰è¶…é…·ï¼å½“ç„¶æˆ‘è¿˜æ˜¯ä¸è®¤ä¸ºè¿™ä¸ªä¸œè¥¿æœ‰ä»€ä¹ˆæ‹“å±•ç©ºé—´ï¼Œä¸è¿‡ç¡®å®æŒºé…·çš„ã€‚</p><p>é‚£è¿™æ¬¡æˆ‘çš„ç­”æ¡ˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘æƒ³å¸¦æ¥å°½å¯èƒ½å¤šçš„å¯èƒ½æ€§ï¼Œè®©ç©å®¶èƒ½åšåˆ°ä»–ä»¬èƒ½æƒ³åˆ°çš„å¤§éƒ¨åˆ†äº‹æƒ…ã€‚ä»¥å‰æˆ‘ç©åˆ°è¿‡å…è®¸è‡ªå®šä¹‰è§„åˆ™çš„ LLM æ¸¸æˆï¼Œä½†ä½œè€…çš„å®ç°æ–¹æ³•æ˜¯è®© LLM æ‹¼å‡‘ä¸€å †é¢„åˆ¶çš„è§„åˆ™ç»„ä»¶ï¼Œäºæ˜¯ç»å¸¸å‡ºç°â€œæˆ‘æƒ³è¦è¿™ä¸ªè§„åˆ™ä½† AI å†™ä¸å‡ºæ¥â€çš„æƒ…å†µã€‚å› æ­¤æˆ‘æƒ³ï¼Œå¦‚æœè¦çœŸæ­£åšåˆ°å°½å¯èƒ½å¤šçš„å¯èƒ½æ€§ï¼Œå°±åªèƒ½æŠŠæ•´ä¸ªæ¸¸æˆçŠ¶æ€éƒ½äº¤ç»™ LLM ç®¡ç†ã€‚</p><p>å¬ä¸Šå»å°±åšä¸åˆ°ä¸æ˜¯å—ï¼Ÿæˆ‘æƒ³å‡ºè¿™ä¸ªæƒ³æ³•æ—¶ä¹Ÿæ„Ÿè§‰â€œè¿™æ ¹æœ¬åšä¸åˆ°ï¼æ–‡å­—å°±ç®—äº†ï¼ŒåŠ¨ç”»æ€ä¹ˆåŠï¼Ÿè¿˜æœ‰æ›´å¤šæ›´å¤šçš„ä¸œè¥¿æ€ä¹ˆåŠï¼Ÿâ€ï¼Œå› æ­¤æ²¡æœ‰å»åšã€‚ä½†å¦‚ä¸Šæ–‡æ‰€è¨€ï¼Œæˆ‘åœ¨è¿™æ¬¡ hackathon è¯•ç€åšäº†è¿™ä¸ªæƒ³æ³•ï¼ˆä¸ºä»€ä¹ˆå®ƒä¸å« gamejam è€Œå« hackathon å‘¢ï¼Œæ˜æ˜æ˜¯åšæ¸¸æˆâ€¦ï¼‰ã€‚</p><p>æˆ‘è§è¿‡çš„è®¸å¤šæ¸¸æˆè®¾è®¡èµ„æ–™éƒ½å‘Šè¯‰æˆ‘ï¼Œâ€œåŸå‹æ˜¯å¾ˆå¯èƒ½å¤±è´¥çš„ï¼Œæ‰¾åˆ°å¤±è´¥ä¹‹å¤„å°±æ˜¯åŸå‹åˆ¶ä½œçš„ç›®çš„ã€‚â€ä½†ä½ æˆ‘çš†çŸ¥æˆ‘ä»¬éƒ½æœ‰å¯¹å¤±è´¥çš„ææƒ§ã€‚åœ¨é¢å¯¹ä¸€ä¸ªçœ‹ä¸Šå»å°±åšä¸åˆ°çš„æ¦‚å¿µæ—¶ï¼Œæˆ‘å¯¹â€œå®ç°è¿™ä¸ªæ¦‚å¿µâ€çš„é¢„æœŸå°±æ˜¯å¤±è´¥ï¼Œå³ä½¿æ˜¯è¿™æ ·ä¹Ÿè¦åšä¸‹å»å—â€¦</p><p>å³ä½¿æ˜¯æœç€å¤±è´¥ä¹Ÿè¦åšä¸‹å»å—ï¼Ÿå‡ å‘¨å‰å‚åŠ çš„ Ludum Dare è¿˜æå‰ä¸€å¤©å‡ºç»“æœäº†ï¼Œæ’ä¸Šäº†è¿™ä¸ª hackathon çš„å¼€å¤´ï¼Œæˆ‘ä¹Ÿæ²¡æ‹¿åˆ°æ»¡æ„çš„æˆç»©ã€‚å³ä½¿æ˜¯è¿™æ ·ä¹Ÿè¦åšä¸‹å»å—ï¼Ÿæˆ‘æ˜¯ä¸æ˜¯æ ¹æœ¬åšä¸å‡ºæœ‰è¶£çš„æ¸¸æˆï¼Ÿ</p><p>æˆ‘çœ‹å‘äº† Jeremy Ryanï¼ŒHope Falters çš„ä½œè€…ï¼ˆè¿™æ˜¯æˆ‘æœ€å–œæ¬¢çš„æ¸¸æˆä¹‹ä¸€ï¼‰ï¼Œæƒ³çœ‹çœ‹ ta åœ¨æœ€å¼€å§‹æ—¶åšå‡ºçš„ä½œå“æ˜¯æ€æ ·çš„ã€‚æˆ‘çœ‹å‘äº†ä¸€äº›åˆ«çš„æˆ‘å–œæ¬¢çš„ä½œè€…ï¼Œæƒ³çœ‹çœ‹ä»–ä»¬åœ¨æœ€å¼€å§‹æ—¶åšå‡ºçš„ä½œå“æ˜¯æ€æ ·çš„ã€‚æˆ‘çœ‹å‘äº†ä¸€äº›åšäº†å¾ˆä¹…æ¸¸æˆä½†åšçš„è¿˜æ˜¯å¾ˆç³Ÿç³•ï¼Œä½†è¿˜æ˜¯åœ¨åšæ¸¸æˆçš„ä½œè€…ã€‚æˆ‘çœ‹å‘äº†å‡ ä¸ªå¹´é¾„å°äºæˆ‘ï¼Œæ’åä¹Ÿå°äºæˆ‘çš„ä½œè€…ã€‚å³ä½¿æ˜¯è¿™æ ·ä¹Ÿè¦åšä¸‹å»å—ï¼Ÿ</p><p>æ— æ‰€è°“äº†ï¼Œå³ä½¿æ˜¯è¿™æ ·ä¹Ÿè¦åšä¸‹å»ã€‚è€Œå¦‚å¼€å¤´æ‰€è¨€ï¼Œé™ªè·‘äº†ã€‚</p><p>ä½†è‡³å°‘æˆ‘çš„æœ‹å‹åœ¨ç©äº†æˆ‘çš„æ¸¸æˆä»¥åå‘å‡ºäº†â€œè¿™å±…ç„¶ä¼šé™ªè·‘å—â€çš„å£°éŸ³ï¼Œè‡³å°‘åœ¨è¯•ç©æ—¶å‡ ä¸ªç©å®¶éƒ½æŒºå–œæ¬¢çš„ï¼Œè¿™å°±å¥½äº†ã€‚</p><p>å—¯ï¼Œå³ä½¿è¦æ”¾å¼ƒï¼Œä¹Ÿè¦ç­‰åˆ°å¤§å®¶éƒ½ä¸å–œæ¬¢çš„é‚£å¤©å§ã€‚</p><p>ç»™è¿™ä¸ªæ¸¸æˆå‰ªè¾‘çš„ç¬¨è›‹å°è§†é¢‘ï¼Œå¯èƒ½ä¸ç¬¦åˆæ–‡ç« æ°›å›´ï¼Œæ…ç‚¹ï¼š<a href="https://youtu.be/P-J1xkifbYA">https://youtu.be/P-J1xkifbYA</a></p><p>è¯´å®Œæƒ…ç»ªä¸Šçš„æŒ£æ‰äº†ï¼Œä¸å¦¨å†æ¥èŠèŠè®¾è®¡ã€‚ä½ çŸ¥é“çš„ï¼Œæˆ‘ä¸€ç›´éƒ½å–œæ¬¢éšä¾¿èŠèŠæ¸¸æˆè®¾è®¡ä¸Šçš„ä¸œè¥¿ã€‚</p><p>åœ¨å¾—åˆ°äº†â€œæŠŠæ•´ä¸ªæ¸¸æˆçŠ¶æ€éƒ½äº¤ç»™ LLM ç®¡ç†â€è¿™ä¸ªæ¦‚å¿µåï¼Œæˆ‘è„‘æµ·ä¸­å°±å‘ˆç°å‡ºäº†è¿™ä¸ªæ¸¸æˆç°åœ¨çš„æ ·å­â€”â€”è®©ç©å®¶ç»„åˆè¯æ±‡æ¥åˆ›é€ é­”æ³•ï¼ŒLLM è§£æé­”æ³•å¹¶æ”¹å˜åœºé¢ã€‚ä¸è¿‡æˆ‘æ„Ÿè§‰è‡ªå·±ä»¥å‰çš„è®¾è®¡éƒ½æ˜¯é™¤äº†æ¦‚å¿µä¸€æ— æ˜¯å¤„çš„è®¾è®¡ï¼Œæ‰€ä»¥è¿™æ¬¡æƒ³è¯•è¯•ä¹‹å‰çœ‹åˆ°çš„â€œæ³¨é‡å¤–å›´è®¾è®¡â€çš„åšæ³•ã€‚</p><p>æ®æˆ‘ç†è§£ï¼Œå¤–å›´è®¾è®¡å°±æ˜¯åœ¨æ ¸å¿ƒæ¦‚å¿µä¹‹å¤–åšä¸€äº›è®¾è®¡æ¥å‘ˆç°è¿™ä¸ªæ¦‚å¿µçš„å¯èƒ½æ€§ã€‚æ¯”å¦‚è¯´ä¿„ç½—æ–¯æ–¹å—çš„æ¦‚å¿µå¯èƒ½æ˜¯â€œå‡‘æ»¡ä¸€è¡Œå°±æ¶ˆé™¤â€ï¼Œå¤–å›´è®¾è®¡å°±æ˜¯ä¸åŒå½¢çŠ¶çš„ç§¯æœ¨ã€‚å¦‚æœç§¯æœ¨åªæœ‰æ­£æ–¹å½¢å’Œé•¿æ¡ï¼Œæ¸¸æˆä¹Ÿèƒ½å·¥ä½œï¼Œä½†å°±æ²¡æœ‰ç°åœ¨è¿™ä¹ˆä¸°å¯Œçš„å¯èƒ½æ€§äº†ã€‚</p><p>è¿™æ¬¡æˆ‘åšçš„å¤–å›´è®¾è®¡åŒ…æ‹¬ç”¨äºæ©é¥°ç”Ÿæˆé€Ÿåº¦è¾ƒæ…¢çš„ TTS æ—ç™½ã€ä¸€äº›æ‰‹åŠ¨è®¾è®¡çš„é«˜æ¦‚å¿µè¯æ±‡ã€‚</p><p>å†™åˆ°è¿™é‡Œçªç„¶æœ‰äº›ç–‘æƒ‘ã€‚æ—¢ç„¶åœ¨å¾—åˆ°äº†è¿™ä¸ªâ€œLLM ç®¡ç†æ¸¸æˆçŠ¶æ€â€çš„æ¦‚å¿µåæˆ‘å°±æƒ³å‡ºäº†è¿™ä¸ªæ¸¸æˆç°åœ¨çš„æ ·å­ï¼Œé‚£æˆ‘ä¸ºä»€ä¹ˆä¼šæ„Ÿè§‰â€œè¿™æ ¹æœ¬åšä¸åˆ°â€å‘¢ï¼Ÿæˆ‘ä¸çŸ¥é“ï¼Œå¯èƒ½åªæ˜¯ææƒ§å¤±è´¥å§ã€‚</p><p>ã€Šæ¸¸æˆè®¾è®¡è‰ºæœ¯ã€‹å‘è¯»è€…å‘å‡ºçš„æœ€åä¸€ä¸ªé—®é¢˜æ˜¯ï¼šâ€œä¸ºä»€ä¹ˆæˆ‘è¦åšç°åœ¨åœ¨åšçš„äº‹â€ã€‚è´¯å½»ä¸€ä¸ªä¸»é¢˜çš„ä½œå“ä¼šå˜å¾—æ›´åŠ æœ‰åŠ›ï¼Œæˆ‘ä»¬æ¯ä¸ªäººä¹Ÿéƒ½æœ‰è‡ªå·±çš„ä¸»é¢˜ã€‚é‚£ä¹ˆæˆ‘ä¸ºä»€ä¹ˆè¦åšæ¸¸æˆï¼Œæˆ‘çš„ä¸»é¢˜åˆæ˜¯ä»€ä¹ˆï¼Ÿæˆ‘ä¼šå¯»æ‰¾ç­”æ¡ˆã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;é™ªè·‘äº† Supercell ä¸¾åŠçš„ Global AI Game Hack. è™½ç„¶æ„Ÿè§‰è‡ªå·±åšçš„æ¸¸æˆå¹¶ä¸æ¯”è·å¥–ä½œå“å·®ï¼Œä½†æ— æ‰€è°“äº†ï¼Œæˆ‘åšå‡ºäº†è‡ªå·±æ»¡æ„çš„ä½œå“ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/others/random_thoughts/explore2/wtf</summary>
      
    
    
    
    <category term="æ‚è°ˆ" scheme="http://rinevard.github.io/categories/%E6%9D%82%E8%B0%88/"/>
    
    <category term="ç¢ç¢å¿µ" scheme="http://rinevard.github.io/categories/%E6%9D%82%E8%B0%88/%E7%A2%8E%E7%A2%8E%E5%BF%B5/"/>
    
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•åœ¨ä¸ƒå¤©å†…åˆ¶ä½œæ¸¸æˆåŸå‹</title>
    <link href="http://rinevard.github.io/wiki/others/translation/%E4%B8%83%E5%A4%A9%E5%8E%9F%E5%9E%8B/"/>
    <id>http://rinevard.github.io/wiki/others/translation/%E4%B8%83%E5%A4%A9%E5%8E%9F%E5%9E%8B/</id>
    <published>2025-10-15T13:47:11.000Z</published>
    <updated>2025-10-15T14:10:39.846Z</updated>
    
    <content type="html"><![CDATA[<p>ç¿»è¯‘è‡ª <a href="http://miami.lgrace.com/documents/How%20to%20Prototype%20a%20Game%20in%20Under%207%20Days.pdf">How to Prototype a Game in Under 7 Days</a></p><p>æ¥è‡ªå››ä½åœ¨ä¸€ä¸ªå­¦æœŸå†…åšäº†è¶…è¿‡ 50 æ¬¾æ¸¸æˆçš„ç ”ç©¶ç”Ÿçš„å¿ƒå¾—</p><p>ä½œè€…ï¼šKyle Gabler, Kyle Gray, Matt Kucic å’Œ Shalin Shodhan</p><p><img src="/images/others/translation/how_to_prototype_seven_day/1_tower_of_goo.jpg" alt="&quot;é»é»ä¸–ç•Œ&quot;åœ¨ä¸Šçº¿æ•°æœˆå†…ä¸‹è½½é‡å°±è¶…è¿‡äº†10ä¸‡æ¬¡ã€‚"></p><p>è¿™é‡Œæœ‰ä¸€ä¸ªç–¯ç‹‚çš„æ¸¸æˆç‚¹å­ï¼šæ‹–åŠ¨é‚£äº›ä¼šè¯´åƒåœ¾è¯çš„ç²˜æ¶²çƒï¼Œå»ºé€ ä¸€åº§è¶Šæ¥è¶Šé«˜çš„å·¨å¡”ã€‚å®ƒä»¬è •åŠ¨ã€å’¯å’¯ç¬‘ï¼Œå¹¶çˆ¬ä¸Šå…„å¼Ÿä»¬çš„èƒŒå‘ä¸Šæ”€çˆ¬ã€‚ä½†è¦å°å¿ƒï¼è¿™æ˜¯ä¸€åœºä¸é‡åŠ›çš„æŒä¹…æˆ˜ã€‚å¦‚æœä½ å»ºé€ çš„å¡”å¤ªä¸ç¨³å®šï¼Œå®ƒå°±ä¼šå€’å¡Œã€‚</p><p>â€œé»é»ä¸–ç•Œâ€åœ¨ä¸Šçº¿æ•°æœˆå†…ä¸‹è½½é‡è¶…è¿‡äº†10ä¸‡æ¬¡ï¼Œåœ¨ä¸€æœ¬æ‚å¿—ä¸­è¢«èª‰ä¸ºâ€œæœˆåº¦ç½‘ç»œæ¸¸æˆâ€ï¼Œåœ¨G4é¢‘é“å’ŒGDCçš„å®éªŒæ€§æ¸¸æˆå·¥ä½œåŠä¸Šè¿›è¡Œäº†æ¼”ç¤ºï¼Œå¹¶ä¸”æ˜¯æˆ‘ä»¬åœ¨å¡å†…åŸºæ¢…éš†å¤§å­¦å¨±ä¹æŠ€æœ¯ä¸­å¿ƒçš„å®éªŒæ€§æ¸¸æˆé¡¹ç›®ä¸­æ‰€åˆ¶ä½œçš„äº”åå¤šæ¬¾æ¸¸æˆä¹‹ä¸€ã€‚</p><p>å’Œå…¶ä½™çš„æ¸¸æˆä¸€æ ·ï¼Œå®ƒä¹Ÿæ˜¯ç”±ä¸€ä¸ªäººåœ¨ä¸€å‘¨ä¹‹å†…å®Œæˆçš„ã€‚</p><p>è¯¥é¡¹ç›®å§‹äº2005å¹´æ˜¥å­£ï¼Œç›®æ ‡æ˜¯å°½å¯èƒ½å¤šåœ°å‘ç°æ–°çš„æ¸¸æˆç©æ³•å¹¶ç»™å®ƒä»¬åšåŸå‹ã€‚æˆ‘ä»¬å››åç ”ç©¶ç”Ÿç»„æˆäº†å›¢é˜Ÿï¼ŒæŠŠè‡ªå·±å…³åœ¨æˆ¿é—´é‡Œï¼Œä¸€ä¸ªå­¦æœŸéƒ½éµå®ˆç€ä¸‹é¢ä¸‰æ¡è§„åˆ™ï¼š</p><ol><li>æ¯ä¸ªæ¸¸æˆå¿…é¡»åœ¨ä¸ƒå¤©å†…å®Œæˆï¼Œ</li><li>æ¯ä¸ªæ¸¸æˆå¿…é¡»ç”±ä¸€ä¸ªäººå®Œæˆï¼Œ</li><li>æ¯ä¸ªæ¸¸æˆå¿…é¡»åŸºäºä¸€ä¸ªå…±åŒçš„ä¸»é¢˜ï¼Œä¾‹å¦‚â€œé‡åŠ›â€ã€â€œæ¤è¢«â€ã€â€œèœ‚ç¾¤â€ç­‰ã€‚</li></ol><p>éšç€é¡¹ç›®è¿›è¡Œï¼Œæˆ‘ä»¬å¯¹èœ‚æ‹¥è€Œè‡³çš„æµé‡ã€æ¸¸æˆæ‚å¿—çš„å…³æ³¨ä»¥åŠè¡Œä¸šä¸“ä¸šäººå£«å’Œå­¦è€…ä»¬éƒ½é—®ç€çš„åŒæ ·çš„é—®é¢˜æ„Ÿåˆ°æƒŠè®¶å’Œæ¿€åŠ¨ï¼šâ€œä½ ä»¬æ˜¯å¦‚ä½•è¿™ä¹ˆå¿«åœ°åˆ¶ä½œè¿™äº›æ¸¸æˆçš„ï¼Ÿâ€ä»¥åŠâ€œæˆ‘ä»¬è¯¥æ€ä¹ˆåšï¼Ÿâ€</p><p>æˆ‘ä»¬åœ¨è¿™é‡Œå°†ä¸€åˆ‡å…¨ç›˜æ‰˜å‡ºã€‚ç»“åˆä»¥ä¸‹çš„å»ºè®®ã€æŠ€å·§å’Œä¾‹å­ï¼Œæˆ‘ä»¬å°†è®¨è®ºé‚£äº›æœ‰ç”¨çš„å’Œæ²¡ç”¨çš„æ–¹æ³•ã€‚æˆ‘ä»¬å°†å‘ä½ å±•ç¤ºå¦‚ä½•è¿›å…¥å¿«é€ŸåŸå‹åˆ¶ä½œçš„æ€ç»´çŠ¶æ€ï¼Œå¦‚ä½•ç»„å»ºä¸€ä¸ªé«˜æ•ˆçš„å›¢é˜Ÿï¼Œä»¥åŠå¦‚æœä½ æƒ³è¿‡åˆ›é€ æ–°ä¸œè¥¿ä½†ä¸çŸ¥ä»ä½•ä¸‹æ‰‹æ—¶åº”è¯¥ä»å“ªé‡Œå¼€å§‹ã€‚æˆ‘ä»¬å¸Œæœ›è¿™äº›ç»è¿‡è®¤çœŸéªŒè¯çš„æŒ‡å—å¯¹ä½ çš„ä¸‹ä¸€ä¸ªé¡¹ç›®ï¼Œæ— è®ºå¤§å°ï¼Œèƒ½æ´¾ä¸Šç”¨åœºï¼</p><p>ä¸ºäº†ä¾¿äºé˜…è¯»ï¼Œæœ¬æ–‡çš„å»ºè®®å’ŒæŠ€å·§ä¼šè¢«åˆ†ä¸ºå››ä¸ªéƒ¨åˆ†ï¼šå‡†å¤‡ã€è®¾è®¡ã€å¼€å‘å’Œé€šç”¨çš„æŠ€å·§ã€‚ç¥ä½ é˜…è¯»æ„‰å¿«ï¼</p><h2 id="å‡†å¤‡ï¼šå¿«é€Ÿæ˜¯ä¸€ç§å¿ƒæ€"><a href="#å‡†å¤‡ï¼šå¿«é€Ÿæ˜¯ä¸€ç§å¿ƒæ€" class="headerlink" title="å‡†å¤‡ï¼šå¿«é€Ÿæ˜¯ä¸€ç§å¿ƒæ€"></a>å‡†å¤‡ï¼šå¿«é€Ÿæ˜¯ä¸€ç§å¿ƒæ€</h2><p>å¿«é€ŸåŸå‹ä¸ä»…æ˜¯å‰æœŸåˆ¶ä½œä¸­çš„ä¸€ä¸ªæœ‰ç”¨å·¥å…·â€”â€”å®ƒè¿˜å¯ä»¥æˆä¸ºä¸€ç§ç”Ÿæ´»æ–¹å¼ï¼æœ¬èŠ‚å°†å±•ç¤ºå¦‚ä½•å‡†å¤‡å¹¶å¼€å§‹åƒä¸€ä¸ªå¿«é€ŸåŸå‹åˆ¶ä½œè€…é‚£æ ·æ€è€ƒã€‚</p><h3 id="æ‹¥æŠ±å¤±è´¥çš„å¯èƒ½æ€§â€”â€”å®ƒé¼“åŠ±åˆ›é€ æ€§å†’é™©"><a href="#æ‹¥æŠ±å¤±è´¥çš„å¯èƒ½æ€§â€”â€”å®ƒé¼“åŠ±åˆ›é€ æ€§å†’é™©" class="headerlink" title="æ‹¥æŠ±å¤±è´¥çš„å¯èƒ½æ€§â€”â€”å®ƒé¼“åŠ±åˆ›é€ æ€§å†’é™©"></a>æ‹¥æŠ±å¤±è´¥çš„å¯èƒ½æ€§â€”â€”å®ƒé¼“åŠ±åˆ›é€ æ€§å†’é™©</h3><p>â€œé£é™©â€å¯¹æˆ‘ä»¬çš„å½±å“å¤ªå¤§äº†ã€‚æ®æˆ‘ä»¬æ‰€çŸ¥ï¼Œå¯¹å¤±è´¥çš„ææƒ§æ˜¯ç”µå½±IPæ”¹ç¼–æ¸¸æˆå’Œç»­ä½œé«˜è¾¾ä¸¤ä½æ•°çš„æ¸¸æˆä¸æ–­è¢«åˆ¶ä½œå‡ºæ¥çš„åŸå› ã€‚è¿™å°±åƒæ€»æ˜¯é€‰æ‹©å»éº¦å½“åŠ³ï¼Œè€Œä¸æ˜¯ä¸€å®¶æœªæ›¾æ¢ç´¢è¿‡çš„æ–°é¤å…â€”â€”æ€»æ˜¯ä¾èµ–äºä¸€ä¸ªä¼—æ‰€å‘¨çŸ¥çš„ã€å°šå¯çš„é€‰é¡¹ï¼Œè€Œä¸æ˜¯å†’é™©å°è¯•æœªçŸ¥ä½†å¯èƒ½ç¾å‘³çš„é€‰æ‹©ã€‚</p><p>ä¸€ä¸ªå¥½çš„å¿«é€ŸåŸå‹åˆ¶ä½œè€…ä¼šçŸ¥é“å¤±è´¥æ˜¯å¯ä»¥æ¥å—çš„ï¼æ‰¾åˆ°å¤±è´¥ä¹‹å¤„å°±æ˜¯åŸå‹åˆ¶ä½œçš„ç›®çš„ï¼Œæ‰€ä»¥å°½æƒ…å»åšå§ï¼å³ä½¿ä½ å¤±è´¥äº†ï¼Œä¹Ÿè¿˜ä¼šæœ‰æ— æ•°çš„æœºä¼šï¼Œè€Œä¸”å¾ˆå¯èƒ½ä½ æ€»èƒ½å­¦åˆ°äº›ä¸œè¥¿ã€‚åªæœ‰æ‹¥æŠ±å¤±è´¥ï¼Œæ‰å¯èƒ½åšå‡ºæœ‰ä»·å€¼çš„å®éªŒã€‚</p><p>Mr. Grayï¼šâ€œã€ŠMime After Mimeã€‹å’Œã€ŠA Mime to Killã€‹æ˜¯æˆ‘åšçš„ä¸¤æ¬¾åªæœ‰å£°éŸ³æ²¡æœ‰ç”»é¢çš„æ¸¸æˆã€‚å°½ç®¡å®ƒä»¬æ˜¯å½»å¤´å½»å°¾çš„å¤±è´¥å“ï¼Œä½†æ•´ä¸ªå›¢é˜Ÿéƒ½ä¸ºèƒ½å†’å¦‚æ­¤å¤§çš„é£é™©æ¥è¯æ˜çº¯éŸ³é¢‘æ¸¸æˆçš„å¤±è´¥è€Œæ„Ÿåˆ°å…´å¥‹ï¼Œæˆ‘å¯ä»¥è‡ªè±ªåœ°è¯´å®ƒä»¬æ˜¯æˆ‘åšçš„ã€‚éšç€æˆ‘åœ¨æ•´ä¸ªé¡¹ç›®ä¸­ç§¯ç´¯ç»éªŒï¼Œæˆ‘é€æ¸èƒ½è¿›è¡Œæ›´æœ‰é’ˆå¯¹æ€§çš„å†’é™©ï¼Œå®ƒä»¬å¸¦æ¥äº†æˆåŠŸçš„æ¸¸æˆã€‚â€</p><p><img src="/images/others/translation/how_to_prototype_seven_day/2_mine_after_mine_and_a_mime_to_kill.png" alt="&quot;Mime After Mime&quot;å’Œ&quot;A Mime to Kill&quot;â€”â€”çƒ­æƒ…æ‹¥æŠ±å¤±è´¥ã€‚"></p><h3 id="å¼ºåˆ¶ç¼©çŸ­å¼€å‘å‘¨æœŸï¼ˆæ›´å¤šæ—¶é—´-æ›´é«˜è´¨é‡ï¼‰"><a href="#å¼ºåˆ¶ç¼©çŸ­å¼€å‘å‘¨æœŸï¼ˆæ›´å¤šæ—¶é—´-æ›´é«˜è´¨é‡ï¼‰" class="headerlink" title="å¼ºåˆ¶ç¼©çŸ­å¼€å‘å‘¨æœŸï¼ˆæ›´å¤šæ—¶é—´ != æ›´é«˜è´¨é‡ï¼‰"></a>å¼ºåˆ¶ç¼©çŸ­å¼€å‘å‘¨æœŸï¼ˆæ›´å¤šæ—¶é—´ != æ›´é«˜è´¨é‡ï¼‰</h3><p>ä½ åªéœ€è¦å‡ å¤©æ—¶é—´ã€‚æœ‰ä¸€ç§å¾ˆè‡ªç„¶çš„æƒ³æ³•æ˜¯ï¼šâ€œæˆ‘ä»¬ä¸€å‘¨åšäº†ä¸€ä¸ªå¾ˆæ£’çš„æ¸¸æˆã€‚æ‰€ä»¥å¦‚æœæˆ‘ä»¬èŠ±ä¸¤å‘¨æ—¶é—´ï¼Œå®ƒä¼šå¥½ä¸Šä¸¤å€ï¼â€ã€‚å½“ç„¶ï¼Œäº‹å®å¹¶éå¦‚æ­¤ã€‚æˆ‘ä»¬å‘ç°ï¼Œé€šå¸¸ä»»ä½•æ¸¸æˆç‚¹å­éƒ½å¯ä»¥åœ¨ä¸åˆ°ä¸€å‘¨çš„æ—¶é—´å†…æœ‰æ•ˆåœ°è¿›è¡ŒåŸå‹è®¾è®¡ã€‚å¤šä½™çš„æ—¶é—´å¾€å¾€ä¼šäº§ç”Ÿé€’å‡çš„å›æŠ¥ã€‚ä¾‹å¦‚ï¼Œä¸€äº›åŸå‹åªç”¨äº†ä¸€ä¸ªæ™šä¸Šå°±å®Œæˆäº†ï¼Œè€Œå¦ä¸€äº›åˆ™å¤šèŠ±äº†ä¸€ä¸¤å‘¨çš„æ—¶é—´ã€‚ä»¤äººæƒŠè®¶çš„æ˜¯ï¼Œæˆ‘ä»¬å‘ç°å¼€å‘æ—¶é—´ä¸æ¸¸æˆæœ€ç»ˆçš„æˆåŠŸç¨‹åº¦ä¹‹é—´æ²¡æœ‰å…³è”ã€‚</p><p><img src="/images/others/translation/how_to_prototype_seven_day/3_left_and_right.jpg" alt="&quot;Attack of the Killer Swarm&quot;ï¼ˆå·¦ï¼‰åªç”¨äº†ä¸€å¤©æ—¶é—´å°±å®Œæˆäº†ï¼Œå¹¶å‡ºäººæ„æ–™åœ°æˆä¸ºè¯¥é¡¹ç›®ä¸­è¯„ä»·æœ€é«˜çš„æ¸¸æˆä¹‹ä¸€ã€‚&quot;Suburban Brawl&quot;ï¼ˆå³ï¼‰å¤šèŠ±äº†ä¸€å‘¨çš„æ—¶é—´ï¼Œä½†å˜å¾—è¿‡äºå¤æ‚ã€‚å¦‚æœæ²¡æœ‰èŠ±æ—¶é—´æ·»åŠ é‚£äº›å·¨å‹æ€æ‰‹æœºå™¨äººï¼Œå®ƒå¯èƒ½ä¼šæ›´æœ‰è¶£ã€‚"></p><h3 id="å¯¹åˆ›é€ çš„çº¦æŸè®©ä½ æ›´æƒ³åˆ›é€ "><a href="#å¯¹åˆ›é€ çš„çº¦æŸè®©ä½ æ›´æƒ³åˆ›é€ " class="headerlink" title="å¯¹åˆ›é€ çš„çº¦æŸè®©ä½ æ›´æƒ³åˆ›é€ "></a>å¯¹åˆ›é€ çš„çº¦æŸè®©ä½ æ›´æƒ³åˆ›é€ </h3><p>æˆ‘ä»¬æœ€æˆåŠŸçš„æ¸¸æˆéƒ½æºäºç‰¹å®šçš„ä¸»é¢˜æˆ–â€œç©å…·â€ï¼Œæ¯”å¦‚â€œé‡åŠ›â€ã€â€œèœ‚ç¾¤â€ï¼Œæˆ–è€…â€œåˆ¶ä½œä¸€æ¬¾ä¸»è¦é¢å‘å¥³æ€§ä¼‘é—²ç©å®¶çš„æ¸¸æˆâ€ã€‚ä¸çŸ¥ä¸ºä»€ä¹ˆï¼Œåœ¨æœ‰é™åˆ¶çš„æƒ…å†µä¸‹ï¼Œåˆ›é€ å˜å¾—æ›´å®¹æ˜“äº†ã€‚</p><p>æ­¤å¤–ï¼Œå½“ä¸€ä¸ªå›¢é˜Ÿçš„äººéƒ½å›´ç»•ä¸€ä¸ªç‰¹å®šä¸»é¢˜åŒæ—¶åšåŸå‹æ—¶ï¼Œæˆ‘ä»¬éƒ½å€¾å‘äºé¿å…ä½¿ç”¨é‚£äº›æ˜¾è€Œæ˜“è§çš„æœºåˆ¶ã€‚è¿™ç§æŒ‘æˆ˜è®©æˆ‘ä»¬å»æ¢ç´¢å¹¶æŒ–æ˜ä¸»é¢˜ä¸­æ‰€æœ‰å¯èƒ½çš„æ¸¸æˆç©æ³•ã€‚</p><p>åœ¨é¡¹ç›®åæœŸï¼Œæˆ‘ä»¬é€æ¸åç¦»äº†è¿™ç§æ¨¡å¼ï¼Œè¿™æœ€ç»ˆå¯¹æˆ‘ä»¬é€ æˆäº†æŸå®³ã€‚æ²¡æœ‰äº†ä¸»é¢˜çº¦æŸï¼Œæ¸¸æˆåˆ¶ä½œæ—¶é—´æ›´é•¿ï¼Œæ–¹å‘æ€§æ›´å·®ï¼Œå›¢é˜Ÿå‡èšåŠ›ä¹Ÿä¸‹é™äº†ã€‚é‚£ç§â€œæˆ‘ä»¬éƒ½åœ¨ä¸€æ¡èˆ¹ä¸Šâ€çš„æ„Ÿè§‰å‡å°‘äº†ï¼Œæ›´ç³Ÿç³•çš„æ˜¯ï¼Œæˆ‘ä»¬å¤±å»äº†é‚£ç§æ›¾æ¿€å‘é¢å¤–åˆ›é€ åŠ›å’ŒæŠ€å·§çš„å‹å¥½ç«äº‰æ„Ÿã€‚</p><p>æˆ‘ä»¬æ¢ç´¢è¿‡çš„ä¸€äº›ä¸»é¢˜æœ‰ï¼šâ€œé‡åŠ›â€ã€â€œå¼¹ç°§â€ã€â€œè¿›åŒ–â€ã€â€œå£°éŸ³â€ã€â€œæ•é£Ÿè€…ä¸çŒç‰©â€ã€â€œä»¤äººä¸Šç˜¾çš„æ¸¸æˆâ€ã€â€œç»˜ç”»â€ã€â€œæŒ‡æ•°å¢é•¿â€ã€â€œæ¤è¢«â€ã€â€œå¹³è¡¡â€ï¼Œä»¥åŠå…¶ä»–ä¸€äº›ä¸ªäººä¸»é¢˜ã€‚</p><p><img src="/images/others/translation/how_to_prototype_seven_day/4_gravity_head.jpg" alt="&quot;Gravity Head&quot;"></p><h3 id="ç»„å»ºä¸€æ”¯ä¼˜ç§€çš„å›¢é˜Ÿå’Œä¸€ä½å®¢è§‚çš„é¡¾é—®â€”â€”å¿ƒæ€ä¸æ‰ååŒç­‰é‡è¦"><a href="#ç»„å»ºä¸€æ”¯ä¼˜ç§€çš„å›¢é˜Ÿå’Œä¸€ä½å®¢è§‚çš„é¡¾é—®â€”â€”å¿ƒæ€ä¸æ‰ååŒç­‰é‡è¦" class="headerlink" title="ç»„å»ºä¸€æ”¯ä¼˜ç§€çš„å›¢é˜Ÿå’Œä¸€ä½å®¢è§‚çš„é¡¾é—®â€”â€”å¿ƒæ€ä¸æ‰ååŒç­‰é‡è¦"></a>ç»„å»ºä¸€æ”¯ä¼˜ç§€çš„å›¢é˜Ÿå’Œä¸€ä½å®¢è§‚çš„é¡¾é—®â€”â€”å¿ƒæ€ä¸æ‰ååŒç­‰é‡è¦</h3><p>å›¢é˜Ÿä¸­çš„æ¯ä¸ªæˆå‘˜éƒ½å¿…é¡»ç†Ÿæ‚‰æ¸¸æˆå¼€å‘çš„æ‰€æœ‰æ–¹é¢ã€‚æ¯ä¸ªäººéƒ½è´Ÿè´£è‡ªå·±çš„ç¼–ç¨‹ã€ç¾æœ¯ã€å£°éŸ³ä»¥åŠæœ€ç»ˆäº§å“ä¸­çš„å…¶ä»–ä¸€åˆ‡ã€‚ä½†èƒ½åŠ›å¹¶éä¸€åˆ‡ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œæ¯ä¸ªäººéƒ½å¿…é¡»ä»¥è¿™æ ·çš„ç†è§£æ¥å¯¹å¾…è¿™ç§å¼€å‘æ–¹å¼ï¼šè®¾è®¡æ˜¯è‡³é«˜æ— ä¸Šçš„â€”â€”ä»ç¾æœ¯åˆ°å·¥ç¨‹çš„ä¸€åˆ‡éƒ½åªæ˜¯ä¸ºæœ€ç»ˆè®¾è®¡æœåŠ¡ã€‚ä¸€ä¸ªæ·±è°™æ­¤é“çš„å¹³åº¸å·¥ç¨‹å¸ˆå¾ˆå¯èƒ½æ¯”ä¸€ä¸ªæ²¡æœ‰è¿™ç§å¿ƒæ€çš„ä¼˜ç§€å·¥ç¨‹å¸ˆæ›´æˆåŠŸã€‚</p><p>é¡¹ç›®é¡¾é—® Jesse Schell è¯´ï¼šâ€æˆ‘ä¸€ç›´ç—´è¿·äºäº§ç”Ÿæ–°æ¸¸æˆåˆ›æ„çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥å½“ Shalinã€Matt å’Œä¸¤ä½ Kyle æå‡ºè¿™ä¸ªé¡¹ç›®æ—¶ï¼Œæˆ‘è‡ªç„¶æ„Ÿåˆ°éå¸¸æ¿€åŠ¨ã€‚æˆ‘æŠŠå®ƒçœ‹ä½œä¸€ä¸ªåœ¨åˆ›é€ åŠ›æ–¹é¢è¿›è¡Œå¯¹ç…§å®éªŒçš„æœºä¼šï¼Œå¹¶å¸Œæœ›èƒ½å­¦åˆ°æœ‰ç”¨çš„æ¸¸æˆè®¾è®¡çŸ¥è¯†ã€‚ä½œä¸ºæŒ‡å¯¼è€å¸ˆï¼Œæˆ‘åŠªåŠ›ç¡®ä¿å›¢é˜Ÿå°è¯•å¤šç§ä¸åŒçš„æŠ€æœ¯ã€ä»é”™è¯¯ä¸­å­¦ä¹ ã€ä¸åœ¨è¡Œä¸é€šçš„æƒ³æ³•ä¸Šçº ç»“å¤ªä¹…ï¼Œå¹¶åŠªåŠ›ä¿è¯æ¯ä¸ªäººéƒ½åœ¨å¯»æ‰¾æœ€é€‚åˆè‡ªå·±çš„åˆ›ä½œè¿‡ç¨‹ã€‚â€</p><p>â€œæˆ‘å¯¹å¦‚ä½•æ”¹è¿›æ¸¸æˆæå‡ºè¿‡ä¸€äº›å»ºè®®ï¼Œä½†å¤§å¤šæ•°æ—¶å€™æˆ‘å°½é‡ä¸å¹²æ¶‰ã€‚æˆ‘æ„Ÿè§‰è‡ªå·±æœ‰ç‚¹åƒä¸ªå›­ä¸â€”â€”æˆ‘åšäº†ä¸€äº›æµ‡æ°´å’Œé™¤è‰çš„å·¥ä½œï¼Œä½†å¼€èŠ±ç»“æœå…¨é ä»–ä»¬ã€‚æ­£å¦‚è¿™ç¯‡è®ºæ–‡æ‰€ç¤ºï¼Œå›¢é˜Ÿèƒ½å¤Ÿå¾—å‡ºä¸€äº›éå¸¸æœ‰ç”¨çš„ç»“è®ºâ€”â€”å¹¶ä¸”æœ€ç»ˆåšå‡ºäº†ä¸€äº›å¥½æ¸¸æˆï¼å…³äºåˆ›ä½œè¿‡ç¨‹çš„ä¼˜åŒ–è¿˜æœ‰æ›´å¤šä¸œè¥¿éœ€è¦å­¦ä¹ ï¼Œå¡å†…åŸºæ¢…éš†å¤§å­¦å¨±ä¹æŠ€æœ¯ä¸­å¿ƒè®¡åˆ’ç»§ç»­è¿›è¡Œè¿™ä¸ªé¡¹ç›®ã€‚â€</p><p><img src="/images/others/translation/how_to_prototype_seven_day/5.jpg" alt="&quot;æˆ‘ä»¬çš„å›¢é˜Ÿï¼Œæ°¸è¿œçš„å®éªŒæ€§æœ‹å‹ï¼&quot;"></p><h3 id="å¹¶è¡Œå¼€å‘ä»¥æœ€å¤§åŒ–æ•ˆæœ"><a href="#å¹¶è¡Œå¼€å‘ä»¥æœ€å¤§åŒ–æ•ˆæœ" class="headerlink" title="å¹¶è¡Œå¼€å‘ä»¥æœ€å¤§åŒ–æ•ˆæœ"></a>å¹¶è¡Œå¼€å‘ä»¥æœ€å¤§åŒ–æ•ˆæœ</h3><p>é‚£ä¹ˆï¼Œä¸€æ—¦æˆ‘ä»¬ç»„å»ºäº†å›¢é˜Ÿï¼Œæˆ‘ä»¬åšäº†ä»€ä¹ˆï¼Ÿæˆ‘ä»¬å„è‡ªç‹¬ç«‹å·¥ä½œï¼è¿™å¬èµ·æ¥å¯èƒ½å¾ˆå¥‡æ€ªï¼Œä½†ç‹¬ç«‹å·¥ä½œçš„å¥½å¤„å®åœ¨å¤ªå¤§äº†ï¼Œä¸å®¹å¿½è§†ï¼š</p><ul><li>ç¼“è§£é£é™©ï¼šé€šè¿‡åŒæ—¶å¼€å‘å››ä¸ªåŸå‹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åšå‡ºå†’é™©çš„è®¾è®¡å†³ç­–æ—¶æ„Ÿåˆ°å®‰å¿ƒï¼Œå› ä¸ºè‡³å°‘æœ‰ä¸€ä¸¤ä¸ªå¯èƒ½ä¼šæˆåŠŸã€‚</li><li>å‹å¥½ç«äº‰ï¼šæ¯ä¸ªäººéƒ½å› åªä¸“æ³¨äºè‡ªå·±è€Œå—ç›Šã€‚å°±åƒèµ„æœ¬ä¸»ä¹‰ä¸€æ ·ï¼</li><li>æ›´å¹¿æ³›çš„ä¸»é¢˜æ¢ç´¢ï¼šæˆ‘ä»¬å››ä¸ªäººéƒ½ä¸“æ³¨äºåŒä¸€ä¸ªä¸»é¢˜ï¼Œè¿™è¿«ä½¿æˆ‘ä»¬æ·±å…¥æ€è€ƒä¸»é¢˜ã€‚å¦‚æœæˆ‘ä»¬éƒ½åšäº†ä¸€æ ·çš„æ¸¸æˆï¼Œé‚£è¯¥å¤šå°´å°¬å•Šï¼è¿™è¿«ä½¿æˆ‘ä»¬è¿›å…¥ä¸€äº›æœ‰ç›Šçš„åˆ›ä½œé¢†åŸŸï¼Œå¹¶è®©æˆ‘ä»¬é¿å…äº†æ˜¾è€Œæ˜“è§çš„åˆ‡å…¥ç‚¹ã€‚</li><li>åˆ†äº«ä¸å…³æ€€ï¼šè™½ç„¶æˆ‘ä»¬æ²¡æœ‰å…±äº«ä»£ç ï¼ˆå¯ä»¥å…±äº«ä¹Ÿå¯ä»¥ä¸å…±äº«ï¼‰ï¼Œä½†æˆ‘ä»¬å‘ç°åˆ†äº«æ¦‚å¿µå’Œç†è§£å¾ˆæœ‰å¸®åŠ©ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªå›¢é˜Ÿæˆå‘˜å‘ç°äº†ä¸€ç§è¡¨ç¤ºå¼¹ç°§ç³»ç»Ÿçš„æœ‰æ•ˆæ–¹æ³•ï¼Œæ¯ä¸ªäººéƒ½ä¼šå—ç›Šã€‚</li></ul><p>éšç€å‡ å‘¨è¿‡å»ï¼Œæˆ‘ä»¬å‘ç°å›¢é˜Ÿåˆä½œåœ¨æ¯ä¸ªå‘¨æœŸçš„å¼€å§‹å’Œç»“æŸæ—¶æœ€æœ‰ä»·å€¼ã€‚åœ¨æ¯ä¸ªå‘¨æœŸå¼€å§‹æ—¶ï¼Œå›¢é˜Ÿåˆä½œæœ‰åŠ©äºæç‚¼å’Œæ¯”è¾ƒæƒ³æ³•ã€‚ä¸€æ—¦è¿›å…¥å¼€å‘é˜¶æ®µï¼Œæˆ‘ä»¬å‘ç°åˆä½œæ›´å¤šæ˜¯ä¸€ç§å¹²æ‰°â€”â€”å› ä¸ºæ¯ä¸ªäººéƒ½å®Œå…¨æ²‰æµ¸åœ¨è‡ªå·±çš„å·¥ä½œä¸­ã€‚åˆ°æ¯ä¸ªå‘¨æœŸç»“æŸæ—¶ï¼Œæˆ‘ä»¬ä¼šå›åˆ°æˆ¿é—´é‡Œä¸€èµ·å·¥ä½œåˆ°å‡Œæ™¨ï¼Œä½“éªŒç«èµ›å¿«ç»“æŸçš„æ„Ÿè§‰ã€‚è¿™ç§åˆä½œä»·å€¼éšæ—¶é—´å˜åŒ–çš„å›¾è¡¨å¯èƒ½åƒè¿™æ ·ï¼š</p><p><img src="/images/others/translation/how_to_prototype_seven_day/6_time_to_value.jpg" alt="&quot;åˆä½œä»·å€¼&quot;éš&quot;æ—¶é—´&quot;çš„å˜åŒ–ã€‚"></p><h2 id="è®¾è®¡ï¼šå¤´è„‘é£æš´çš„ç¥è¯å’Œåˆ›é€ åŠ›"><a href="#è®¾è®¡ï¼šå¤´è„‘é£æš´çš„ç¥è¯å’Œåˆ›é€ åŠ›" class="headerlink" title="è®¾è®¡ï¼šå¤´è„‘é£æš´çš„ç¥è¯å’Œåˆ›é€ åŠ›"></a>è®¾è®¡ï¼šå¤´è„‘é£æš´çš„ç¥è¯å’Œåˆ›é€ åŠ›</h2><p>ä¸€ä¸ªå¥½ç‚¹å­å¯èƒ½åœ¨ç¬é—´äº§ç”Ÿï¼Œä½†ç­‰å¾…ç‚¹å­å¯èƒ½æ˜¯ä¸€ç§ç…ç†¬ã€‚æ²¡æœ‰åŠæ³•å¼ºè¿«ä¸€ä¸ªå¥½ç‚¹å­è¿¸å‘å‡ºæ¥ï¼Œä½†è¿™ä¸€éƒ¨åˆ†å†…å®¹åº”è¯¥èƒ½å¸®åŠ©ä½ åŸ¹å…»ä½ çš„åˆ›é€ åŠ›ã€‚</p><h3 id="æ­£å¼å¤´è„‘é£æš´çš„æˆåŠŸç‡ä¸º-0"><a href="#æ­£å¼å¤´è„‘é£æš´çš„æˆåŠŸç‡ä¸º-0" class="headerlink" title="æ­£å¼å¤´è„‘é£æš´çš„æˆåŠŸç‡ä¸º 0%"></a>æ­£å¼å¤´è„‘é£æš´çš„æˆåŠŸç‡ä¸º 0%</h3><p>æˆ‘ä»¬çœŸçš„å¾ˆåŠªåŠ›äº†â€”â€”å¤©å‘ï¼Œæˆ‘ä»¬çœŸçš„å¸Œæœ›å¤´è„‘é£æš´èƒ½å¥æ•ˆï¼æˆ‘ä»¬å®‰æ’äº†â€œå¤´è„‘é£æš´ä¼šè®®â€å’Œâ€œåœ†æ¡Œä¼šè®®â€ï¼Œæˆ‘ä»¬ç”¨ä¸åŒé¢œè‰²çš„è®°å·ç¬”åœ¨ç™½æ¿å’Œè¶…å¤§ä¾¿åˆ©è´´ä¸Šå†™ç”»ï¼Œæˆ‘ä»¬ç”šè‡³ç”¨äº†åƒâ€œè“å¤©â€è¿™æ ·çš„æ¿€åŠ±æ€§çŸ­è¯­æ¥å¸®åŠ©æˆ‘ä»¬æ‘†è„±æ€ç»´å®šåŠ¿ã€‚ä½†æœ€ç»ˆï¼Œåœ¨æˆ‘ä»¬åˆ›é€ çš„æ‰€æœ‰æ¸¸æˆä¸­ï¼Œæ²¡æœ‰ä¸€ä¸ªæ˜¯é€šè¿‡å¤§å®¶ååœ¨ä¸€èµ·è¿›è¡Œå¤´è„‘é£æš´ä¼šè®®å¾—å‡ºçš„ç»“æœã€‚</p><p>ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿæˆ‘ä»¬ä¹Ÿéå¸¸éœ‡æƒŠã€‚ä½†ç»è¿‡ä¸€ç•ªè°ƒæŸ¥ï¼Œæˆ‘ä»¬å‘ç°åˆ›é€ åŠ›ç¡®å®æ˜¯æ— æ³•è§„åˆ’çš„ã€‚ä½ ä¸èƒ½è¯´ï¼šâ€œå¤§å®¶4:15å¼€ä¸ªä¼šå¤´è„‘é£æš´ä¸€ä¸‹ï¼Œåˆ°5:00æˆ‘ä»¬å°±èƒ½æ‹¿å‡ºå››ä¸ªè¶…æ£’çš„æ¸¸æˆç‚¹å­ï¼â€</p><p>ä½†å¤´è„‘é£æš´å¹¶éæ— ç”¨ã€‚é€šè¿‡ç²¾å¿ƒç»„ç»‡å¤´è„‘é£æš´ä¼šè®®ï¼Œæˆ‘ä»¬ä»ç„¶å¯ä»¥æœŸå¾…ï¼ˆè‡³å°‘ï¼‰ä¸¤ä»¶åˆç†çš„äº‹æƒ…ã€‚ç¬¬ä¸€ï¼Œå½“ç„¶æ˜¯è®©æ‰€æœ‰äººéƒ½å¼€å§‹æ€è€ƒã€‚åœ¨å¼€å§‹æ€è€ƒåï¼Œè¿‡äº†ä¸€ä¼šå„¿ï¼Œæˆ–è®¸åœ¨å›å®¶çš„è·¯ä¸Šï¼Œæˆ–è®¸åœ¨æ´—æ¾¡æ—¶ï¼Œåˆæˆ–è®¸åœ¨é›ç‹—æ—¶ï¼Œä¸€ä¸ªç»å¦™çš„ç‚¹å­ä¼šåœ¨ä½ çš„è„‘æµ·ä¸­è¿¸å‘å‡ºæ¥ã€‚å½“ç„¶ï¼Œä¹Ÿæˆ–è®¸ä¸ä¼šã€‚ä½†æ®æˆ‘ä»¬æ‰€çŸ¥ï¼Œç¥ç§˜çš„å¤§è„‘åœ¨æˆ‘ä»¬æœ€ä¸ç»æ„é—´åšäº†å¤§é‡çš„æ€è€ƒã€‚</p><p>ç¬¬äºŒï¼Œå½“æœ‰å…·ä½“çš„ä¸œè¥¿å¯ä»¥è®¨è®ºæ—¶ï¼Œå¤´è„‘é£æš´å°±æœ‰ç”¨äº†ã€‚æ¯”å¦‚ï¼Œâ€œæˆ‘ä»¬å¦‚ä½•æ”¹è¿›è¿™ä¸ªï¼Ÿâ€æ¯”â€œè®©æˆ‘ä»¬éšä¾¿æƒ³ç‚¹ä»€ä¹ˆï¼â€æ›´å¥½ã€‚åˆå¦‚ï¼Œç»™å‡ºä¸€ä¸ªåŠæˆå½¢çš„ç‚¹å­å¹¶è®©å…¶ä»–äººæ¥å……å®å®ƒæ˜¯ç›¸å½“æœ‰ç”¨çš„ã€‚æ¯”èµ·åˆ›ä½œè€…ï¼Œäººä»¬æ›´é€‚åˆå½“è¯„è®ºå®¶ï¼Œä¸æ˜¯å—ï¼Ÿ</p><h3 id="æ”¶é›†æ¦‚å¿µè‰ºæœ¯å’ŒéŸ³ä¹ä»¥åˆ›é€ æƒ…ç»ªç›®æ ‡"><a href="#æ”¶é›†æ¦‚å¿µè‰ºæœ¯å’ŒéŸ³ä¹ä»¥åˆ›é€ æƒ…ç»ªç›®æ ‡" class="headerlink" title="æ”¶é›†æ¦‚å¿µè‰ºæœ¯å’ŒéŸ³ä¹ä»¥åˆ›é€ æƒ…ç»ªç›®æ ‡"></a>æ”¶é›†æ¦‚å¿µè‰ºæœ¯å’ŒéŸ³ä¹ä»¥åˆ›é€ æƒ…ç»ªç›®æ ‡</h3><p>ä½œä¸ºå¤´è„‘é£æš´çš„æ›¿ä»£å“ï¼Œæˆ‘ä»¬å‘ç°æ”¶é›†ä¸€äº›å…·æœ‰ä¸ªäººæ„ä¹‰çš„è‰ºæœ¯å’ŒéŸ³ä¹ç‰¹åˆ«æœ‰ç”¨ã€‚äººä»¬è¯„è®ºè¯´ï¼Œè®¸å¤šæ¸¸æˆå¦‚â€œGravity Headâ€å’Œâ€œOn a Rainy Dayâ€åˆ›é€ äº†å¼•äººå…¥èƒœçš„æ°›å›´å¹¶å…·æœ‰å¼ºçƒˆçš„æƒ…æ„Ÿå¸å¼•åŠ›ã€‚è¿™ä¸æ˜¯å¶ç„¶çš„ã€‚åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œé…ä¹å’ŒåˆæœŸç¾æœ¯å…±åŒåˆ›é€ äº†ä¸€ç§æ„Ÿå—ï¼Œæ¨åŠ¨äº†ç©æ³•ã€æ•…äº‹å’Œæœ€ç»ˆç¾æœ¯çš„è®¾å®šã€‚</p><p>Mr. Gablerï¼šâ€œã€Šé»é»ä¸–ç•Œã€‹çš„æƒ³æ³•æ˜¯æˆ‘åœ¨å›å®¶è·¯ä¸Šå¬ Astor Piazzolla çš„ã€ŠTango Apasionadoã€‹å¼€å¤´æ—¶äº§ç”Ÿçš„ï¼Œæˆ‘è„‘æµ·ä¸­æµ®ç°å‡ºä¸€ä¸ªæ—¥è½æ—¶åˆ†å°é•‡çš„æœ¦èƒ§æ™¯è±¡ï¼Œæ¯ä¸ªäººéƒ½ç¦»å¼€å®¶ï¼Œæ¬å‡ºæ¤…å­ã€æ¡Œå­å’Œä»»ä½•ä»–ä»¬èƒ½æ‰¾åˆ°çš„ä¸œè¥¿ï¼Œåœ¨å¸‚ä¸­å¿ƒå»ºé€ ä¸€åº§å·¨å¡”ã€‚æˆ‘ä¸çŸ¥é“ç¡®åˆ‡åŸå› ï¼Œä½†ä»–ä»¬æƒ³å¾€ä¸Šçˆ¬ï¼Œå†å¾€ä¸Šçˆ¬â€”â€”ä½†ä»–ä»¬ä¸æ˜¯å¾ˆå¥½çš„åœŸæœ¨å·¥ç¨‹å¸ˆï¼Œæ‰€ä»¥ä½ éœ€è¦å¸®åŠ©ä»–ä»¬ã€‚æœ€ç»ˆçš„åŸå‹å˜å¾—æ›´æ¬¢å¿«ä¸€äº›ï¼Œæˆ‘æŠŠéŸ³ä¹æ¢æˆäº† Piazzolla çš„æ›´æ¬¢å¿«çš„ã€ŠLibertangoã€‹ã€‚è¿™æ˜¯ä¸€ä¸ªåˆå§‹æƒ…ç»ªç›®æ ‡é€ å°±äº†æ•´ä¸ªæ¸¸æˆçš„ä¾‹å­ã€‚â€</p><p><img src="/images/others/translation/how_to_prototype_seven_day/7_goo_prototype.jpg" alt="æ¢æˆˆéŸ³ä¹å’Œçˆ¬å¾—è¶Šæ¥è¶Šé«˜çš„å°äººâ€¦â€¦"></p><h3 id="åœ¨è„‘ä¸­æ¨¡æ‹Ÿâ€”â€”åšåŸå‹çš„åŸå‹"><a href="#åœ¨è„‘ä¸­æ¨¡æ‹Ÿâ€”â€”åšåŸå‹çš„åŸå‹" class="headerlink" title="åœ¨è„‘ä¸­æ¨¡æ‹Ÿâ€”â€”åšåŸå‹çš„åŸå‹"></a>åœ¨è„‘ä¸­æ¨¡æ‹Ÿâ€”â€”åšåŸå‹çš„åŸå‹</h3><p>è¿™çœŸçš„å¾ˆç®€å•ï¼ä½ è¦åšçš„å°±æ˜¯æƒ³è±¡ä½ çš„æ¸¸æˆç©å®¶è¯´ï¼šâ€œå“‡ï¼â€ç„¶åå€’æ¨å¹¶å¡«è¡¥ç©ºç™½ã€‚æ˜¯ä»€ä¹ˆè®©ä»–ä»¬äº«å—ä½ çš„æ¸¸æˆï¼Ÿä»–ä»¬æ„Ÿå—åˆ°äº†ä»€ä¹ˆï¼Ÿæ¸¸æˆä¸­æ˜¯ä»€ä¹ˆè®©ä»–ä»¬æœ‰äº†è¿™ç§ä½“éªŒï¼Ÿ</p><p>å¯¹æˆ‘ä»¬çš„é‚£äº›æœ€æˆåŠŸçš„æ¸¸æˆæ¥è¯´ï¼Œæˆ‘ä»¬å¹¶ä¸å¯¹å®ƒä»¬å˜å¾—å¥½ç©æ„Ÿåˆ°æ„å¤–â€”â€”åœ¨æœ€å¥½çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åœ¨æ¥è§¦ä»»ä½•ä¸€è¡Œä»£ç ä¹‹å‰å°±çŸ¥é“è¿™ä¸ªæƒ³æ³•æ˜¯é è°±çš„ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»åœ¨æ€ç»´é‡Œæ¨¡æ‹Ÿè¿‡äº†æ¸¸æˆã€‚åä¹‹äº¦ç„¶ï¼Œæ²¡æœ‰ä¸€ä¸ªæ¸¸æˆæ˜¯å‡ºä¹æ„æ–™åœ°æˆåŠŸçš„ï¼Œæˆ‘ä»¬æ€»æ˜¯å…ˆçŸ¥å…ˆè§‰ã€‚ï¼ˆå¯æƒœçš„æ˜¯ï¼Œè¿™å¹¶æ²¡æœ‰é˜»æ­¢æˆ‘ä»¬å»è¿½æ±‚é‚£äº›åŠç”Ÿä¸ç†Ÿçš„æƒ³æ³•ã€‚ï¼‰</p><p>åœ¨ä½ çš„è„‘æµ·ä¸­æ¨¡æ‹Ÿä¹Ÿä½¿å¾—æœ€ç»ˆåŸå‹çš„å¼€å‘å˜å¾—éå¸¸å®¹æ˜“ï¼Œå› ä¸ºä½ ä¼šç¡®åˆ‡åœ°çŸ¥é“ä½ å°†è¦åšä»€ä¹ˆã€‚ä½ ä¸ä¼šä¸ºäº†åœ¨è®¾è®¡ä¸Šâ€œè¯•é”™â€æµªè´¹æ—¶é—´ä¿®æ”¹ä»£ç ã€‚</p><p>ä¸€ä½å›¢é˜Ÿæˆå‘˜æ‰¿è®¤ï¼šâ€æˆ‘ç»å¸¸åœ¨ä¸€å‘¨çš„å‰3ã€4å¤©é‡Œï¼Œåªæ˜¯ä¸ºäº†â€™çµæ„Ÿâ€™è€Œé—²é€›çœ‹ O-Zone éŸ³ä¹è§†é¢‘ã€å€’æŒ‚åœ¨æ‡’äººæ²™å‘ä¸Šå¬éŸ³ä¹ã€å¶å°”è¿è¡Œä¸€äº›ç³Ÿç³•çš„å¤§è„‘æ¨¡æ‹Ÿã€‚æœ€åå‘¨å››æˆ–å‘¨äº”æ¥ä¸´æ—¶ï¼Œæˆ‘ä¼šæ„Ÿåˆ°ææ…Œï¼Œå› ä¸ºæˆ‘ä»ç„¶ä¸çŸ¥é“å‘¨ä¸€è¦äº¤ä»€ä¹ˆï¼Œæ‰€ä»¥æˆ‘å°±ä¼šé‡‡çº³æœ€å¼ºçš„é‚£ä¸ªæƒ³æ³•ï¼Œå¹¶æ ¹æ®æœ¬å‘¨è‡ªå·±å–œæ¬¢ä¸Šçš„ä¸œè¥¿è¿›è¡Œè°ƒæ•´ï¼Œç›´åˆ°æ„Ÿè§‰åƒä¸€ä¸ªæœ‰è¶£çš„æ¸¸æˆï¼Œç„¶åæ¥ä¸‹æ¥å‡ å¤©ç†¬å¤œå†™ä»£ç å’Œç”»ç”»ã€‚å¯¹æˆ‘æ¥è¯´ï¼ˆæˆ‘æƒ³å¯¹æˆ‘ä»¬æ‰€æœ‰äººæ¥è¯´ï¼‰ï¼ŒèŠ±åœ¨â€™å‰æœŸåˆ¶ä½œâ€™ä¸Šçš„æ—¥å­æ— ç–‘æ¯”èŠ±åœ¨å®é™…å¼€å‘ä¸Šçš„æ—¥å­æ›´æœ‰ä»·å€¼ã€‚â€</p><p><img src="/images/others/translation/how_to_prototype_seven_day/8_rainy_day.jpg" alt="&quot;On a Rainy Day&quot;çš„æ—©æœŸçº¸ä¸ŠåŸå‹â€”â€”åœ¨è„‘ä¸­æ¨¡æ‹Ÿæ—¶å¾ˆæœ‰å¸®åŠ©ã€‚"></p><h2 id="å¼€å‘ï¼šæ²¡äººçŸ¥é“ä½ æ˜¯æ€ä¹ˆåšçš„ï¼Œä¹Ÿæ²¡äººåœ¨ä¹"><a href="#å¼€å‘ï¼šæ²¡äººçŸ¥é“ä½ æ˜¯æ€ä¹ˆåšçš„ï¼Œä¹Ÿæ²¡äººåœ¨ä¹" class="headerlink" title="å¼€å‘ï¼šæ²¡äººçŸ¥é“ä½ æ˜¯æ€ä¹ˆåšçš„ï¼Œä¹Ÿæ²¡äººåœ¨ä¹"></a>å¼€å‘ï¼šæ²¡äººçŸ¥é“ä½ æ˜¯æ€ä¹ˆåšçš„ï¼Œä¹Ÿæ²¡äººåœ¨ä¹</h2><p>ä¸€æ—¦ä½ æœ‰äº†ä¸€ä¸ªå¥½ç‚¹å­ï¼Œè¿™é‡Œæœ‰ä¸€äº›æŠ€å·§å¯ä»¥è®©ä½ è¿…é€Ÿåšå‡ºä¸€ä¸ª demoï¼</p><h3 id="å…ˆåšç©å…·"><a href="#å…ˆåšç©å…·" class="headerlink" title="å…ˆåšç©å…·"></a>å…ˆåšç©å…·</h3><p>ä»æ ¸å¿ƒæœºåˆ¶å¼€å§‹ã€‚æ— è®ºæ˜¯å¼¹ç°§ç³»ç»Ÿã€ç¾¤ä½“è¡Œä¸ºã€é‡åŠ›ç­‰ç­‰ï¼ŒèŠ±ä¸äº†å‡ ä¸ªå°æ—¶å°±èƒ½æŠŠæ¸¸æˆä¸»é¢˜åšå‡ºæ¥ã€‚è¿™ä¸ªâ€œç©å…·â€åº”è¯¥æ˜¯æ¸¸æˆçš„æ ¸å¿ƒæœºåˆ¶ã€‚å®ƒä¸éœ€è¦ä»»ä½•ç›®æ ‡æˆ–å†³ç­–ï¼Œæ²¡æœ‰è¾“èµ¢ï¼Œåªæ˜¯ä¸€ä¸ªå¥½ç©çš„ä¸œè¥¿ã€‚</p><p>Mr. Gablerï¼šâ€œå¯¹ã€ŠSuper Tummy Bubbleã€‹æ¥è¯´ï¼Œâ€˜ç©å…·â€™åªæ˜¯ä¸€å †æ‚¬æµ®åœ¨å°å®¹å™¨é‡Œçš„æ³¡æ³¡ã€‚æˆ‘ç©äº†ä¸€ä¼šå„¿è¿™ä¸ªç©å…·ï¼ŒæŠŠæ³¡æ³¡æ‰”æ¥æ‰”å»ï¼Œç„¶åè°ƒæ•´äº†ä¸€ä¸‹ç›´åˆ°æˆ‘æ„Ÿè§‰æ‰‹æŒ‡æˆ³è¿›æ³¡æ³¡é‡Œå¾ˆæœ‰è¶£ã€‚ä¹‹åï¼Œæ˜¯æ—¶å€™åŠ å…¥ä¸€äº›æ¸¸æˆæ€§äº†ã€‚åœ¨è¿™ä¸ªæ¸¸æˆé‡Œï¼Œæ¸¸æˆæ€§åŒ…æ‹¬å¯„ç”Ÿç€ä¸åŒè™«å­çš„æ³¡æ³¡ã€â€˜æˆ³ç ´â€™çš„æ¦‚å¿µã€â€˜è¿é”â€™çš„æ¦‚å¿µã€åˆ†æ•°è®¡æ•°å™¨ç­‰ã€‚â€</p><p><img src="/images/others/translation/how_to_prototype_seven_day/9_left_and_right.jpg" alt="&quot;Super Tummy Bubble&quot;â€”â€”ç©å…·ï¼ˆå·¦ï¼‰vs. æœ€ç»ˆåŸå‹ï¼ˆå³ï¼‰ã€‚"></p><h3 id="å¦‚æœèƒ½å·æ‡’ï¼Œé‚£å°±å·æ‡’"><a href="#å¦‚æœèƒ½å·æ‡’ï¼Œé‚£å°±å·æ‡’" class="headerlink" title="å¦‚æœèƒ½å·æ‡’ï¼Œé‚£å°±å·æ‡’"></a>å¦‚æœèƒ½å·æ‡’ï¼Œé‚£å°±å·æ‡’</h3><p>è¿™å¯ä»¥è¯´æ˜¯è¿™ä¸ªé¡¹ç›®æœ€é‡è¦çš„æ•™è®­ä¹‹ä¸€ã€‚é€šå¸¸â€œæ­£ç¡®â€çš„è§£å†³æ–¹æ¡ˆå¹¶éæœ€ä½³è§£å†³æ–¹æ¡ˆã€‚æœ‰ç­–ç•¥åœ°å·æ‡’ä¼šä¸ºä½ èŠ‚çœæ—¶é—´å’Œé‡‘é’±ï¼›å®ƒä¼šè®©ä½ çš„æ¸¸æˆæ›´å¿«ï¼Œä½ çš„ç‰™é½¿æ›´ç™½ã€‚å¤§èƒ†åœ°ã€ç»å¸¸åœ°å·æ‡’ï¼å¦‚æœä¸€ä¸ªç®€å•çš„é˜´å½±å’Œçƒ˜ç„™çº¹ç†åŒæ ·æœ‰æ•ˆï¼Œå°±ä¸è¦è®¾ç½®å¤æ‚çš„å…‰ç…§å’Œé˜´å½±ï¼ˆã€ŠDarwin Hillã€‹ï¼‰ã€‚å¦‚æœä½ å¯ä»¥ç”¨åŒæ ·çš„æ•ˆæœè’™æ··è¿‡å…³ï¼Œå°±ä¸è¦ä¸ºäº†åˆ†æç”¨æˆ·çš„ç»˜ç”»è€Œè®¾ç½®å¤æ‚çš„æ¨¡å¼è¯†åˆ«ç³»ç»Ÿï¼ˆã€ŠSuburban Brawlã€‹ï¼‰ã€‚å½“å¿«é€Ÿæ‹‰ä¼¸çš„ä½å›¾èƒ½æ›´å¿«æ›´å®¹æ˜“åœ°è¾¾åˆ°åŒæ ·æ•ˆæœæ—¶ï¼Œå°±ä¸è¦ç»˜åˆ¶æ ·æ¡æ›²çº¿æˆ–åˆ›å»ºè‡ªå·±çš„çŸ¢é‡è‰ºæœ¯åº“ï¼ˆã€Šé»é»ä¸–ç•Œã€‹ï¼‰ã€‚æˆ‘ä»¬å‘ç°ï¼Œè¿™æ¡è§„åˆ™ä¹Ÿæ˜¯ç”Ÿæ´»ä¸­ä¸€æ¡æå¥½çš„é€šç”¨æ³•åˆ™ã€‚æ‡’äººä»¬ï¼Œæ³¨æ„äº†ã€‚</p><p><img src="/images/others/translation/how_to_prototype_seven_day/10_left_mid_right.jpg" alt="&quot;Darwin Hill&quot;ã€&quot;Suburban Brawl&quot;ã€&quot;é»é»ä¸–ç•Œ&quot;â€”â€”éƒ½æ˜¯å‡çš„ï¼Œè€Œä¸”æ²¡äººæ³¨æ„åˆ°ã€‚å˜˜ï¼"></p><h3 id="åŠæ—¶æ­¢æŸï¼Œå‰²èˆå¿ƒå¤´ä¹‹çˆ±"><a href="#åŠæ—¶æ­¢æŸï¼Œå‰²èˆå¿ƒå¤´ä¹‹çˆ±" class="headerlink" title="åŠæ—¶æ­¢æŸï¼Œå‰²èˆå¿ƒå¤´ä¹‹çˆ±"></a>åŠæ—¶æ­¢æŸï¼Œå‰²èˆå¿ƒå¤´ä¹‹çˆ±</h3><p>åœ¨é¡¹ç›®å¼€å§‹æ—¶ï¼Œæˆ‘ä»¬æœ‰ä¸€ç§æƒ³è¦æŒ½æ•‘ä¸€åˆ‡çš„æ„¿æœ›â€”â€”å†å¤šèŠ±ä¸€ç‚¹æ—¶é—´å’Œç²¾åŠ›ï¼Œä¸€ä¸ªç³Ÿç³•çš„æ¸¸æˆè‚¯å®šä¼šå˜æˆå¤©æ‰ä¹‹ä½œï¼æˆ‘ä»¬æœ‰ä¸€ä¸ªè¿™æ ·çš„æ³¨å®šå¤±è´¥çš„åŸå‹â€”â€”å®ƒå§‹äºä¸€ä¸ªç¾ä¸½çš„å¼¹ç°§ç³»ç»Ÿã€‚å®ƒèƒ½æŒ¤å‹å’Œæ‹‰ä¼¸ï¼Œè®©ä½ æƒ³æŠ“ä½å®ƒå¹¶åˆ°å¤„æ‹‰æ‰¯ï¼Œä½†å®ƒå°±æ˜¯æ²¡æœ‰å˜æˆä¸€ä¸ªå¼•äººå…¥èƒœçš„æ¸¸æˆã€‚æœ€åˆçš„å¼¹ç°§ç³»ç»Ÿæœºåˆ¶åªèŠ±å‡ ä¸ªå°æ—¶å°±åˆ›å»ºå¥½äº†ï¼Œä½†éšåå®ƒå´è€—è´¹äº†æ•´æ•´ä¸€å‘¨çš„ç¼–ç å’Œé‡æ„æ—¶é—´ã€‚è¿™æ˜¯ä¸€æ¬¡å¯æ‚²çš„å°è¯•ï¼Œè¯•å›¾å¼ºè¡Œå°†è¿™ä¸ªæœºåˆ¶å˜æˆä¸€ä¸ªæ¸¸æˆã€‚</p><p>å¿«é€Ÿè¯†åˆ«èµ°ä¸é€šçš„æƒ³æ³•ã€åŠæ—¶æ­¢æŸå¹¶ç»§ç»­å‰è¿›éå¸¸é‡è¦ã€‚æˆ‘ä»¬å‘ç°ï¼Œé¡ºå…¶è‡ªç„¶æ¯”èŠ±æ—¶é—´è¯•å›¾æŒ½æ•‘ç°æœ‰çš„ä¸œè¥¿æ›´æœ‰ä»·å€¼ã€‚å¦‚æœä»¥åçµå…‰ä¸€é—ªï¼Œä½ æ€»å¯ä»¥å†å›æ¥ã€‚</p><p>Mr. Kucicï¼šâ€œæˆ‘çš„â€˜åœŸè±†â€™æœ€ç»ˆæˆä¸ºäº†ä¸€ä¸ªåœ¨ Flash ä¸­æ„å»ºçš„å®Œç¾çš„è½¯ä½“æ¨¡æ‹Ÿç³»ç»Ÿï¼Œå”¯ä¸€çš„é—®é¢˜æ˜¯å®ƒä¸€ç‚¹ä¹Ÿä¸å¥½ç©ã€‚å®ƒç»™æˆ‘å¸¦æ¥çš„å¤´ç—›æ¯”æ­»äº¡é‡‘å±è¿˜å¤šã€‚æˆ‘æµªè´¹äº†ä¸€å‘¨æ—¶é—´ï¼Œè€Œå®ƒç”šè‡³éƒ½ä¸èƒ½åŠ¨ã€‚ä½ å¾—çŸ¥é“ä»€ä¹ˆæ—¶å€™è¯¥ç»§ç»­ï¼Œä»€ä¹ˆæ—¶å€™è¯¥æ”¾å¼ƒã€‚â€</p><p><img src="/images/others/translation/how_to_prototype_seven_day/11_circle.png" alt="&quot;é©¬ç‰¹çš„åœŸè±†&quot;â€”â€”æ²æµ´åœ¨å®ƒçš„è£è€€ä¸­ã€‚"></p><h3 id="æ¼‚äº®çš„åŒ…è£…æ— æ³•æŒ½æ•‘ç³Ÿç³•çš„è®¾è®¡ï¼ˆæˆ–è€…è¯´ï¼Œâ€œçƒ‚æ³¥æ‰¶ä¸ä¸Šå¢™â€ï¼‰"><a href="#æ¼‚äº®çš„åŒ…è£…æ— æ³•æŒ½æ•‘ç³Ÿç³•çš„è®¾è®¡ï¼ˆæˆ–è€…è¯´ï¼Œâ€œçƒ‚æ³¥æ‰¶ä¸ä¸Šå¢™â€ï¼‰" class="headerlink" title="æ¼‚äº®çš„åŒ…è£…æ— æ³•æŒ½æ•‘ç³Ÿç³•çš„è®¾è®¡ï¼ˆæˆ–è€…è¯´ï¼Œâ€œçƒ‚æ³¥æ‰¶ä¸ä¸Šå¢™â€ï¼‰"></a>æ¼‚äº®çš„åŒ…è£…æ— æ³•æŒ½æ•‘ç³Ÿç³•çš„è®¾è®¡ï¼ˆæˆ–è€…è¯´ï¼Œâ€œçƒ‚æ³¥æ‰¶ä¸ä¸Šå¢™â€ï¼‰</h3><p>æˆ‘ä»¬å‘ç°æ¸¸æˆç©å®¶æ¯”ä½ æƒ³è±¡çš„è¦èªæ˜ï¼Œä»–ä»¬èƒ½çœ‹ç©¿ä½ æ˜¯å¦åœ¨è€èŠ±æ‹›ã€‚å¦‚æœæ¸¸æˆç©æ³•å¾ˆç³Ÿç³•ï¼Œé‚£å°±æ²¡æ•‘äº†â€”â€”ä¸–ç•Œä¸Šæ‰€æœ‰çš„ç¾æœ¯ã€éŸ³ä¹å’Œè”åŠ¨éƒ½æ— æ³•è®©å®ƒæˆä¸ºä¸€ä¸ªå¥½æ¸¸æˆã€‚è¿™å°±åƒæ˜¯ç»™ä¸€ä¸ªæ— è¶£çš„æ¸¸æˆæœºåˆ¶åŠ å…¥æœ€æ–°çš„3DåŠ¨ç”»ç”µå½±è§’è‰²ï¼Œæ²¡äººä¼šè¢«ç³Šå¼„ã€‚</p><p>Mr. Grayï¼šâ€œã€ŠSpin to Winã€‹çš„â€˜æ¸¸æˆç©æ³•â€™æ˜¯æ—‹è½¬ä½ çš„é¼ æ ‡æ¥è½¬åŠ¨å¤šä¸ªåœ†åœˆã€‚ä¸ºäº†æ©ç›–å®ƒä¸å¥½ç©çš„äº‹å®ï¼Œæˆ‘ç”¨60å¹´ä»£ã€ŠBewitchedã€‹é£æ ¼çš„è‰ºæœ¯å’ŒéŸ³ä¹ç»™æ¸¸æˆåšäº†æ¼‚äº®çš„åŒ…è£…ã€‚ä½†æ— è®ºæˆ‘æ€ä¹ˆæ‰“ç£¨è¿™ä¸ªæ¸¸æˆï¼Œå®ƒéƒ½æœ‰è¶£ä¸èµ·æ¥ã€‚å°½ç®¡æˆ‘ä»˜å‡ºäº†æ‰€æœ‰çš„çˆ±ï¼Œå®ƒè¿˜æ˜¯å¾ˆå¿«å°±æˆäº†ç½‘ç«™ä¸Šæœ€è¢«è®¨åŒçš„æ¸¸æˆä¹‹ä¸€ã€‚â€</p><p><img src="/images/others/translation/how_to_prototype_seven_day/12_spin_to_win.jpg" alt="&quot;Spin to Win&quot;â€”â€”ç››è£…æ‰“æ‰®å´æ— å¤„å¯å»ã€‚"></p><h3 id="ä½†æ•´ä½“ç¾å­¦å¾ˆé‡è¦ï¼åˆç†è¿ç”¨ç¾æœ¯ã€éŸ³æ•ˆå’ŒéŸ³ä¹"><a href="#ä½†æ•´ä½“ç¾å­¦å¾ˆé‡è¦ï¼åˆç†è¿ç”¨ç¾æœ¯ã€éŸ³æ•ˆå’ŒéŸ³ä¹" class="headerlink" title="ä½†æ•´ä½“ç¾å­¦å¾ˆé‡è¦ï¼åˆç†è¿ç”¨ç¾æœ¯ã€éŸ³æ•ˆå’ŒéŸ³ä¹"></a>ä½†æ•´ä½“ç¾å­¦å¾ˆé‡è¦ï¼åˆç†è¿ç”¨ç¾æœ¯ã€éŸ³æ•ˆå’ŒéŸ³ä¹</h3><p>è¿™å®é™…ä¸Šä¸æˆ‘ä»¬æœ€åˆçš„ä¸€ä¸ªå‡è®¾ç›¸åã€‚æˆ‘ä»¬å½“æ—¶è®¤ä¸ºç¾æœ¯å’ŒéŸ³æ•ˆæ ¹æœ¬ä¸ä¼šå¯¹åŸå‹æœ‰å½±å“ï¼Œä½†æˆ‘ä»¬é”™äº†ï¼ç©ä¸€ä¸ªç²¾å¿ƒæ‰“ç£¨çš„æ¸¸æˆå®é™…ä¸Šæ¯”ç©æœ‰ç€å®Œå…¨ç›¸åŒçš„ä»£ç ï¼Œä½†è‰ºæœ¯ç²—ç³™ã€éŸ³æ•ˆå·®çš„æ¸¸æˆæ„Ÿè§‰æ›´å¥½ã€‚ä¸è¿‡ï¼Œé‡è¦çš„æ˜¯è¦åšå‡ºä»¥ä¸‹åŒºåˆ†â€”â€”å•çº¯æ‰“ç£¨ç¾å­¦æ— æ³•æŒ½æ•‘ç³Ÿç³•çš„è®¾è®¡ï¼Œä½†å®ƒç¡®å®æœ‰èƒ½åŠ›è®©ä¸€ä¸ªå¥½æ¸¸æˆå˜å¾—æ›´å¥½ç©ã€‚è¿™å¹¶ä¸æ„å‘³ç€ä½ éœ€è¦æå…¶ç²¾ç¾çš„å›¾å½¢æˆ–ç¯ç»•å£°ã€‚è¿™åªæ˜¯è¯´ä½ å¯ä»¥é€šè¿‡å°†æ‰€æœ‰ä¸œè¥¿ç´§å¯†ç»“åˆèµ·æ¥è€Œå—ç›Šã€‚è®°ä½ï¼Œå³ä½¿æ˜¯â€œè¹©è„šâ€ä¹Ÿå¯ä»¥æ˜¯ä¸€ç§ç´§å¯†ç»“åˆçš„ç¾å­¦ï¼Œåªè¦ä½ ä»¥æ­£ç¡®çš„æ–¹å¼å‘ˆç°å®ƒã€‚</p><p><img src="/images/others/translation/how_to_prototype_seven_day/13_unrealeased_tree.jpg" alt="ä¸€ä¸ªæœªå‘å¸ƒçš„åŸå‹â€”â€”ä¸å¤æ‚çš„ç¾æœ¯ä¹Ÿèƒ½åœ¨æ„å›¾ä¸Šæ„Ÿè§‰åšå®ã€‚"></p><h3 id="æ²¡äººå…³å¿ƒä½ çš„ä»£ç è´¨é‡"><a href="#æ²¡äººå…³å¿ƒä½ çš„ä»£ç è´¨é‡" class="headerlink" title="æ²¡äººå…³å¿ƒä½ çš„ä»£ç è´¨é‡"></a>æ²¡äººå…³å¿ƒä½ çš„ä»£ç è´¨é‡</h3><p>å†æ¬¡å¼ºè°ƒï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œä¸€ä¸ªä¼Ÿå¤§çš„å·¥ç¨‹å¸ˆä¸ä¸€å®šèƒ½æˆä¸ºä¸€ä¸ªä¼Ÿå¤§çš„åŸå‹åˆ¶ä½œè€…ã€‚â€æ­£ç¡®â€å’Œâ€å¯å¤ç”¨â€çš„æ–¹æ¡ˆé€šå¸¸ä¸æ˜¯æˆ‘ä»¬åœ¨å¿«é€Ÿã€ä¸€æ¬¡æ€§ä»£ç ä¸­æ‰€å¯»æ±‚çš„ã€‚å¯¹äºæ¯ä¸ªé—®é¢˜ï¼Œä½ åº”è¯¥èƒ½å¤Ÿæƒ³å‡ºä¸€å¤§å †è§£å†³æ–¹æ¡ˆï¼Œå¹¶é€‰æ‹©é‚£ä¸ªèƒ½æœ€å¿«åšå®Œçš„æ–¹æ¡ˆã€‚ç”¨æˆ·æ°¸è¿œä¸ä¼šçœ‹åˆ°ä½ ä¼Ÿå¤§çš„ä»£ç ï¼Œä»–ä»¬ä¹Ÿä¸åœ¨ä¹ã€‚</p><p>Mr. Shodhanï¼šâ€œä»£ç çš„è¿‡åº¦è®¾è®¡å¾ˆå®¹æ˜“è®©æˆ‘ä»¬åšå‡ºä¸€äº›é€šç”¨å·¥å…·æˆ–æŠ€æœ¯æ¼”ç¤ºï¼Œä½†ä»–ä»¬å¹¶ä¸å¯ç©ã€‚è¿™å°±åƒæ˜¯ä¸€ä¸ªæ‘‡æ»šæ˜æ˜Ÿæ²‰æµ¸åœ¨è‡ªå·±çš„è‰ºæœ¯ä¸­ï¼Œè€Œè§‚ä¼—åœ¨æ‰“å“ˆæ¬ ï¼å¯¹â€˜è¿›åŒ–â€™é‚£ä¸ªä¸»é¢˜ï¼Œæˆ‘ç”¨ç»†åˆ†æ›²é¢å’Œå¡é€šæ¸²æŸ“æ•ˆæœåšäº†ä¸€ä¸ªç¨‹åºï¼Œé€šè¿‡æ‚äº¤ç¥–å…ˆæ ‘æ¥è¿›åŒ–3Dæ¨¡å‹ã€‚è¿™é‡Œæœ‰å¾ˆå¤šå¾ˆé…·çš„æŠ€æœ¯ï¼Œä½†å®Œå…¨æ²¡æœ‰æ¸¸æˆæ€§ï¼â€</p><p><img src="/images/others/translation/how_to_prototype_seven_day/14_evolution_tree.png" alt="&quot;è¿›åŒ–æ ‘&quot;â€”â€”æ‰€æœ‰è¿™äº›æŠ€æœ¯åŠ èµ·æ¥å¹¶ä¸ç­‰äºä¹è¶£ã€‚"></p><p><img src="/images/others/translation/how_to_prototype_seven_day/15_rubber_ball.jpg" alt="ä¸€ä¸ªæ©¡èƒ¶çƒã€‚å°å¿ƒï¼Œ3DæŠ€æœ¯ï¼"></p><h2 id="é€šç”¨çš„æŠ€å·§ï¼šå…³äºè¥é€ å¤šæ±ä¹è¶£çš„æ•™ç¨‹"><a href="#é€šç”¨çš„æŠ€å·§ï¼šå…³äºè¥é€ å¤šæ±ä¹è¶£çš„æ•™ç¨‹" class="headerlink" title="é€šç”¨çš„æŠ€å·§ï¼šå…³äºè¥é€ å¤šæ±ä¹è¶£çš„æ•™ç¨‹"></a>é€šç”¨çš„æŠ€å·§ï¼šå…³äºè¥é€ å¤šæ±ä¹è¶£çš„æ•™ç¨‹</h2><p>é™¤äº†åœ¨åŸå‹åˆ¶ä½œæ–¹é¢å¸å–äº†æƒ¨ç—›çš„æ•™è®­å¤–ï¼Œæˆ‘ä»¬è¿˜å¶ç„¶å‘ç°äº†ä¸€äº›é€šç”¨çš„å‡†åˆ™ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›æ˜¾è‘—å¢åŠ â€œä¹è¶£â€çš„å‡†åˆ™ã€‚</p><h3 id="å¤æ‚ä¸ä¸€å®šæœ‰è¶£"><a href="#å¤æ‚ä¸ä¸€å®šæœ‰è¶£" class="headerlink" title="å¤æ‚ä¸ä¸€å®šæœ‰è¶£"></a>å¤æ‚ä¸ä¸€å®šæœ‰è¶£</h3><p>å¦‚æœäººç±»ä»¥â€œçƒå’Œå¹³é¢â€è¿™ä¸ªä¸»é¢˜çš„å˜ä½“æ¥å¨±ä¹è‡ªå·±æ•°åƒå¹´ï¼Œæˆ‘ä»¬å¯èƒ½åœ¨è¿™äº›æ–°å¥‡çš„è§†é¢‘æ¸¸æˆä¸Šåšå¾—å¤ªè¿‡å¤´äº†ã€‚æˆ‘ä»¬å®Œå…¨å¯èƒ½ç”¨åŸºæœ¬çš„å…ƒç´ æ¥è·å¾—ä¹è¶£ã€‚æƒ³æƒ³ã€Šä¿„ç½—æ–¯æ–¹å—ã€‹ã€ã€Šåƒè±†äººã€‹ä»¥åŠä»»ä½•ç»å…¸çš„è¡—æœºæ¸¸æˆã€‚å°±åƒç½—å¯†æ¬§ä¸æœ±ä¸½å¶çš„çˆ±æƒ…æ•…äº‹åŸå‹ä¸€æ ·ï¼Œè¿™äº›æ¸¸æˆçš„æœºåˆ¶å¦‚æ­¤ä¹‹å¥½ï¼Œä»¥è‡³äºå‡ åå¹´åæˆ‘ä»¬ä»åœ¨ä½¿ç”¨å®ƒä»¬ã€‚é•œå¤´å…‰æ™•ã€å‡¹å‡¸è´´å›¾ã€æ³›å…‰å’Œå…¶ä»–æƒŠäººçš„æ–°æŠ€æœ¯æ˜¯ä¸é”™ï¼Œä½†å®ƒä»¬ä¸ä¼šè®©ä½ çš„æ¸¸æˆæ›´æœ‰è¶£ã€‚ç”¨ä¸€ä¸ªç®€å•çš„åŸå‹å‘è‡ªå·±è¯æ˜ä½ çš„æ ¸å¿ƒæœºåˆ¶å€¼å¾—ä¸€åšï¼Œåœ¨ä½ ç¡®ä¿¡ä¹‹åï¼ŒæŠŠå®ƒå˜å¾—æ¼‚äº®ã€‚</p><h3 id="åˆ›é€ ä¸€ç§æ‹¥æœ‰æ„Ÿæ¥è®©ç©å®¶ä¸æ–­é‡ç©"><a href="#åˆ›é€ ä¸€ç§æ‹¥æœ‰æ„Ÿæ¥è®©ç©å®¶ä¸æ–­é‡ç©" class="headerlink" title="åˆ›é€ ä¸€ç§æ‹¥æœ‰æ„Ÿæ¥è®©ç©å®¶ä¸æ–­é‡ç©"></a>åˆ›é€ ä¸€ç§æ‹¥æœ‰æ„Ÿæ¥è®©ç©å®¶ä¸æ–­é‡ç©</h3><p>æˆ‘ä»¬å¶ç„¶å‘ç°ï¼Œæœ€å…·é‡ç©ä»·å€¼çš„æ¸¸æˆæ˜¯é‚£äº›ä¸åˆ›é€ æˆ–è‡ªå®šä¹‰ç›¸å…³çš„æ¸¸æˆã€‚ä¾‹å¦‚ï¼Œâ€œç”¨æ‰‹å’Œé›¨ä¼åˆ¶ä½œä¸€æ£µä»¤äººæ¯›éª¨æ‚šç„¶çš„æ ‘â€ï¼Œæˆ–è€…â€œç”»ä½ è‡ªå·±çš„æˆ¿å­â€ï¼Œæˆ–è€…â€œå»ºé€ ä½ è‡ªå·±çš„å¡”â€ï¼Œæˆ–è€…â€œè¿›åŒ–ä½ è‡ªå·±çš„çªå˜ç”Ÿç‰©ç§æ—â€ã€‚æ˜¾ç„¶æˆ‘ä»¬èƒ½åœ¨è®¸å¤šåœ°æ–¹ä¸­è§åˆ°è¿™ç§ç°è±¡â€”â€”æ¸¸æˆé‡Œçš„æè„¸åŠŸèƒ½ã€è‡ªå®šä¹‰çš„æ‰‹æœºé“ƒå£°ã€ä¹ƒè‡³é‚£äº›â€œä¸ä¼—ä¸åŒï¼Œè¡¨è¾¾è‡ªæˆ‘â€çš„å¹¿å‘Šã€‚æ‰€ä»¥ï¼Œè·³ä¸Šè¿™è¶Ÿæ½®æµå§ï¼åˆ›é€ ä¸€ç§æ‹¥æœ‰æ„Ÿï¼Œè®©ä»–ä»¬ä¸æ–­é‡ç©ã€‚</p><p><img src="/images/others/translation/how_to_prototype_seven_day/16_darwin_hill.jpg" alt="&quot;Darwin Hill&quot;â€”â€”æ¯ä¸ªäººä¸ä¼—ä¸åŒã€‚"></p><h3 id="â€œå®éªŒæ€§â€ä¸æ„å‘³ç€â€å¤æ‚â€"><a href="#â€œå®éªŒæ€§â€ä¸æ„å‘³ç€â€å¤æ‚â€" class="headerlink" title="â€œå®éªŒæ€§â€ä¸æ„å‘³ç€â€å¤æ‚â€"></a>â€œå®éªŒæ€§â€ä¸æ„å‘³ç€â€å¤æ‚â€</h3><p>åœ¨é¡¹ç›®æ—©æœŸï¼Œæˆ‘ä»¬åˆ¶ä½œçš„è®¸å¤šæ¸¸æˆéƒ½å¤ªè¿‡å¤æ‚ã€‚å®ƒä»¬çš„ç”¨æˆ·ç•Œé¢ä»¤äººå›°æƒ‘ï¼Œè€Œä¸”æŒ‰é”®æ˜ å°„åˆ°çš„åŠ¨ä½œä¹Ÿä¸è‡ªç„¶æˆ–ä¸ç›´è§‚ã€‚é™¤éæˆ‘ä»¬èƒ½æœ€å°åŒ–ç©å®¶ç†è§£æ¸¸æˆä¹‹å‰çš„ç–‘æƒ‘æ—¶é—´ï¼Œå¦åˆ™ç©å®¶ä¼šæ„Ÿåˆ°æ²®ä¸§ï¼Œå†ä¹Ÿä¸ç©è¿™ä¸ªæ¸¸æˆï¼Œç”šè‡³å†ä¹Ÿä¸æ¥æˆ‘ä»¬ç½‘ç«™ã€‚å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬å‘ç°æ—¢å¯ä»¥åšåˆ°â€å®éªŒæ€§â€ï¼Œåˆå¯ä»¥ä¿æŒæ˜“äºç†è§£ã€‚</p><p>Mr. Shodhanï¼šâ€œæˆ‘çš„ç¬¬ä¸€è½®æ¸¸æˆâ€˜Spaceball Munchâ€™æ˜¯è€æ¸¸æˆâ€˜Gorillasâ€™çš„3Dç‰ˆæœ¬ï¼Œåœ¨é‚£ä¸ªæ¸¸æˆé‡Œï¼Œä½ æŒ‡å®šä¸€ä¸ªè§’åº¦å’Œé€Ÿåº¦ï¼Œè®©ä¸€ä¸ªçŒ©çŒ©å‘å¦ä¸€ä¸ªçŒ©çŒ©æ‰”é¦™è•‰ã€‚ç°åœ¨ä½ ä¸ä»…åœ¨3Dç¯å¢ƒä¸­ï¼Œæ›´æ˜¯ç”¨ç€å¼§å½¢è§†è§’ï¼Œè¿˜åœ¨ä¸€ä¸ªçƒå½¢åœºåœ°ä¸Šè¿›è¡Œæ¸¸æˆã€‚æ‰€ä»¥ä½ è¦è€ƒè™‘ä¸¤ä¸ªè§’åº¦å’Œä¸€ä¸ªé€Ÿåº¦ã€‚å¦å¤–ï¼Œå®ƒç°åœ¨ä¹Ÿä¸å†æ˜¯ä¸€ä¸ªç¦»æ•£çš„å›åˆåˆ¶æ¸¸æˆï¼Œè€Œæ˜¯éœ€è¦æ§åˆ¶ä¸€ä¸ªè¿ç»­çš„ç²’å­æµï¼ŒåŒæ—¶å¿…é¡»å‡»ä¸­æ‰€æœ‰è¿™äº›ç§»åŠ¨çš„ç‰©ä½“ã€‚è¿™å¼ æˆªå›¾å±•ç¤ºäº†è¿™ç§æ¯«æ— æ„ä¹‰çš„å¤æ‚åº¦â€</p><p><img src="/images/others/translation/how_to_prototype_seven_day/17_spaceball_munch.jpg" alt="&quot;Spaceball Munch&quot;â€”â€”æˆ‘ä»¬æ€ä¹ˆèƒ½çŸ¥é“ï¼Ÿï¼"></p><h3 id="æœç€ä¸€ä¸ªæ˜ç¡®å®šä¹‰çš„ç›®æ ‡å‰è¿›"><a href="#æœç€ä¸€ä¸ªæ˜ç¡®å®šä¹‰çš„ç›®æ ‡å‰è¿›" class="headerlink" title="æœç€ä¸€ä¸ªæ˜ç¡®å®šä¹‰çš„ç›®æ ‡å‰è¿›"></a>æœç€ä¸€ä¸ªæ˜ç¡®å®šä¹‰çš„ç›®æ ‡å‰è¿›</h3><p>äººä»¬å¾ˆå®¹æ˜“å¿˜è®°è®¾ç½®ä¸€ä¸ªæ˜ç¡®å®šä¹‰çš„ç›®æ ‡ã€‚æ²¡æœ‰æ¸¸æˆç›®æ ‡ï¼Œä¸€ä¸ªåŸå‹å°±åªæ˜¯ä¸€ä¸ªç©å…·ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªæ¸¸æˆã€‚å‡ºäºæŸç§åŸå› ï¼Œäººä»¬ä¼¼ä¹å–œæ¬¢æœ‰å¤±è´¥çš„æœºä¼šã€‚ä¸€ä¸ªç›®æ ‡å¯ä»¥æ˜¯ä»»ä½•äº‹æƒ…â€”â€”æ¯”å¦‚â€œåœ¨xæ—¶é—´å†…æ”¶é›†xä¸ªå°éƒ¨ä»¶â€ï¼Œæˆ–è€…â€œä¿æŒç³»ç»Ÿç¨³å®šâ€ï¼Œæˆ–è€…â€œåœ¨ä¸ç¢°åˆ°ä»»ä½•åä¸œè¥¿çš„æƒ…å†µä¸‹ç©¿è¶Šä¸€ä¸ªç©ºé—´â€ã€‚ä½†æ‰¾åˆ°ä¸€ä¸ªä¸è®©äººè§‰å¾—ç‰µå¼ºçš„ç›®æ ‡è¿˜æ˜¯å¾ˆéš¾çš„ï¼ˆæ¯”å¦‚æ—¶é™ä¸€èˆ¬å°±å¾ˆç‰µå¼ºï¼‰ã€‚æˆ‘ä»¬å‘ç°ï¼Œæœ€å¥½çš„ç›®æ ‡æ˜¯æ¸¸æˆç©æ³•ä¸­å›ºæœ‰çš„éƒ¨åˆ†ï¼Œæ¯”å¦‚åœ¨ã€Šé»é»ä¸–ç•Œã€‹ä¸­ï¼Œéšå«çš„ç›®æ ‡å°±æ˜¯ç®€å•åœ°â€œå‘ä¸Šå»ºé€ â€ã€‚</p><p><img src="/images/others/translation/how_to_prototype_seven_day/18_tower_of_goo.jpg" alt="&quot;é»é»ä¸–ç•Œ&quot;â€”â€”æœç€ä¸€ä¸ªç›®æ ‡â€¦â€¦ä»¥åŠæ›´è¿œçš„åœ°æ–¹å»ºé€ ï¼"></p><h3 id="è®©å®ƒå¤šæ±ï¼"><a href="#è®©å®ƒå¤šæ±ï¼" class="headerlink" title="è®©å®ƒå¤šæ±ï¼"></a>è®©å®ƒå¤šæ±ï¼</h3><p>å¤šæ±ï¼ˆJuicyï¼‰æ˜¯æˆ‘ä»¬ç”¨æ¥å½¢å®¹æŒç»­ä¸”ä¸°å¯Œçš„ç”¨æˆ·åé¦ˆçš„æœ¯è¯­ã€‚ä¸€ä¸ªå¤šæ±çš„æ¸¸æˆå…ƒç´ åœ¨ä½ è§¦æ‘¸å®ƒæ—¶ä¼šå¼¹è·³ã€æ‰­åŠ¨ã€å–·å°„å¹¶å‘å‡ºä¸€ç‚¹å£°éŸ³ã€‚ä¸€ä¸ªå¤šæ±çš„æ¸¸æˆå¾ˆæ´»æ³¼ï¼Œå®ƒå¯¹ä½ åšçš„æ¯ä»¶äº‹éƒ½æœ‰ååº”â€”â€”ä¸€ç‚¹ç‚¹è¾“å…¥å°±ä¼šäº§ç”Ÿå¤§é‡çš„å›åº”å’Œè¿é”ååº”ï¼Œè¿™è®©ç©å®¶æ„Ÿè§‰è‡ªå·±æŒæ§ç€ä¸–ç•Œã€‚å®ƒä¹Ÿåœ¨äº’åŠ¨æ—¶ä¸æ–­è®©ç©å®¶çŸ¥é“è‡ªå·±æ­£åœ¨åšä»€ä¹ˆï¼Œå¼•å¯¼ä»–ä»¬äº†è§£æ¸¸æˆè§„åˆ™ã€‚</p><p>ä½ å¯èƒ½ç»å†è¿‡çš„ä¸€äº›å¤šæ±çš„ä¾‹å­å¯èƒ½åŒ…æ‹¬ï¼š</p><ul><li>ã€ŠAlien Hominidã€‹ï¼šéå¸¸å¤¸å¼ çš„æ•Œäººçˆ†ç‚¸å’Œè¡€æ¶²é£æº…ã€‚</li><li>ã€Šé©¬é‡Œå¥¥å…„å¼Ÿã€‹ï¼šåœ¨ä¸€ä¸ªå……æ»¡é‡‘å¸çš„æˆ¿é—´é‡Œå¼¹è·³ï¼Œå®å½“å£°å¾ˆè®©äººæ»¡è¶³ã€‚</li><li>å¼¹ç æœºï¼šä¸€è‚¡æ°¸æ— æ­¢å¢ƒçš„çƒæµå…¨åœ¨ä½ çš„æ§åˆ¶ä¹‹ä¸‹ã€‚</li><li>ã€Šè¶…çº§æ–¹å—æˆ˜å£«2 Turboã€‹ï¼šè¿å‡»æ—¶ï¼ŒåŠ¨ç”»å’Œç‰¹æ•ˆå±‚å‡ºä¸ç©·ã€‚</li></ul><p><img src="/images/others/translation/how_to_prototype_seven_day/19_left_mid_right.jpg" alt="å¤šæ±çš„æ„Ÿè§‰å¾ˆæ£’ï¼ä½ ç®€ç›´åœä¸ä¸‹æ¥ã€‚"></p><h2 id="æœ€åçš„æƒ³æ³•"><a href="#æœ€åçš„æƒ³æ³•" class="headerlink" title="æœ€åçš„æƒ³æ³•"></a>æœ€åçš„æƒ³æ³•</h2><p>è¿™æ¬¡å…³äºå®éªŒæ€§æ¸¸æˆé¡¹ç›®çš„å›¢é˜Ÿåˆä½œæ˜¯ä¸€ä»¶éå¸¸æ„‰å¿«çš„äº‹ã€‚æˆ‘ä»¬å¸Œæœ›ä¸‹æ¬¡å½“ä½ å°è¯•ä¸€äº›æ–°çš„æˆ–æœ‰ç‚¹ç–¯ç‹‚çš„ä¸œè¥¿æ—¶ï¼Œè¿™äº›å»ºè®®å’ŒæŠ€å·§èƒ½å¯¹ä½ æœ‰æ‰€å¸®åŠ©ã€‚è°çŸ¥é“å‘¢ï¼Œä½ ä»Šå¤©æ—©ä¸Šæœ‰çš„é‚£ä¸ªå°æƒ³æ³•å¯èƒ½å°±æ˜¯ä¸‹ä¸€ä¸ªç¥ä½œã€‚å¬é›†ä¸€äº›æœ‹å‹æˆ–è€…å•å¹²ï¼Œå¿«å»å°è¯•å¹¶åˆ¶ä½œåŸå‹å§ï¼ä½ å¯èƒ½ä¼šç»™è‡ªå·±ä¸€ä¸ªæƒŠå–œã€‚</p><p>æˆ‘ä»¬çš„é¡¾é—®å‹å¥½åœ°æŒ‡å‡ºï¼Œâ€œå¿«é€ŸåŸå‹å¯èƒ½å¾ˆåƒæ€€ä¸€ä¸ªå­©å­ã€‚æ²¡äººæŒ‡æœ›æ¯æ¬¡éƒ½èƒ½èµ¢ï¼Œä½†ä½ æ€»æ˜¯å­¦åˆ°æ–°ä¸œè¥¿ï¼Œè€Œä¸”è¿™é€šå¸¸å¾ˆæœ‰è¶£ï¼â€</p><p>ç¥ä½ åŸå‹åˆ¶ä½œæ„‰å¿«ï¼</p><p><img src="/images/others/translation/how_to_prototype_seven_day/20_final.jpg" alt=""></p><p>æ­¤é¡µé¢è½¬è½½è‡ª Gamasutra ç½‘ç«™ï¼š<br><a href="http://www.gamasutra.com/features/20051026/gabler_01.shtml">http://www.gamasutra.com/features/20051026/gabler_01.shtml</a></p><h2 id="ä¾¿æ·æ¸…å•ï¼"><a href="#ä¾¿æ·æ¸…å•ï¼" class="headerlink" title="ä¾¿æ·æ¸…å•ï¼"></a>ä¾¿æ·æ¸…å•ï¼</h2><ol><li><p>å‡†å¤‡ï¼šå¿«é€Ÿæ˜¯ä¸€ç§å¿ƒæ€</p><ul><li>æ‹¥æŠ±å¤±è´¥çš„å¯èƒ½æ€§â€”â€”å®ƒé¼“åŠ±åˆ›é€ æ€§å†’é™©</li><li>å¼ºåˆ¶ç¼©çŸ­å¼€å‘å‘¨æœŸï¼ˆæ›´å¤šæ—¶é—´ != æ›´é«˜è´¨é‡ï¼‰</li><li>å¯¹åˆ›é€ çš„çº¦æŸè®©ä½ æ›´æƒ³åˆ›é€ </li><li>ç»„å»ºä¸€æ”¯ä¼˜ç§€çš„å›¢é˜Ÿå’Œä¸€ä½å®¢è§‚çš„é¡¾é—®â€”â€”å¿ƒæ€ä¸æ‰ååŒç­‰é‡è¦</li><li>å¹¶è¡Œå¼€å‘ä»¥æœ€å¤§åŒ–æ•ˆæœ</li></ul></li><li><p>è®¾è®¡ï¼šå¤´è„‘é£æš´çš„ç¥è¯å’Œåˆ›é€ åŠ›</p><ul><li>æ­£å¼å¤´è„‘é£æš´çš„æˆåŠŸç‡ä¸º 0%</li><li>æ”¶é›†æ¦‚å¿µè‰ºæœ¯å’ŒéŸ³ä¹ä»¥åˆ›é€ æƒ…ç»ªç›®æ ‡</li><li>åœ¨è„‘ä¸­æ¨¡æ‹Ÿâ€”â€”åšåŸå‹çš„åŸå‹</li></ul></li><li><p>å¼€å‘ï¼šæ²¡äººçŸ¥é“ä½ æ˜¯æ€ä¹ˆåšçš„ï¼Œä¹Ÿæ²¡äººåœ¨ä¹</p><ul><li>å…ˆåšç©å…·</li><li>å¦‚æœèƒ½å·æ‡’ï¼Œé‚£å°±å·æ‡’</li><li>åŠæ—¶æ­¢æŸï¼Œå‰²èˆå¿ƒå¤´ä¹‹çˆ±</li><li>æ¼‚äº®çš„åŒ…è£…æ— æ³•æŒ½æ•‘ç³Ÿç³•çš„è®¾è®¡ï¼ˆæˆ–è€…è¯´ï¼Œâ€çƒ‚æ³¥æ‰¶ä¸ä¸Šå¢™â€ï¼‰</li><li>ä½†æ•´ä½“ç¾å­¦å¾ˆé‡è¦ï¼åˆç†è¿ç”¨ç¾æœ¯ã€éŸ³æ•ˆå’ŒéŸ³ä¹</li><li>æ²¡äººå…³å¿ƒä½ çš„ä»£ç è´¨é‡</li></ul></li><li><p>é€šç”¨çš„æŠ€å·§ï¼šå…³äºè¥é€ å¤šæ±ä¹è¶£çš„æ•™ç¨‹</p><ul><li>å¤æ‚ä¸ä¸€å®šæœ‰è¶£</li><li>åˆ›é€ ä¸€ç§æ‹¥æœ‰æ„Ÿæ¥è®©ç©å®¶ä¸æ–­é‡ç©</li><li>â€œå®éªŒæ€§â€ä¸æ„å‘³ç€â€å¤æ‚â€</li><li>æœç€ä¸€ä¸ªæ˜ç¡®å®šä¹‰çš„ç›®æ ‡å‰è¿›</li><li>è®©å®ƒå¤šæ±ï¼</li></ul></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;ç¿»è¯‘è‡ª &lt;a href=&quot;http://miami.lgrace.com/documents/How%20to%20Prototype%20a%20Game%20in%20Under%207%20Days.pdf&quot;&gt;How to Prototype a Game in Un</summary>
      
    
    
    
    <category term="æ‚è°ˆ" scheme="http://rinevard.github.io/categories/%E6%9D%82%E8%B0%88/"/>
    
    <category term="ç¿»è¯‘" scheme="http://rinevard.github.io/categories/%E6%9D%82%E8%B0%88/%E7%BF%BB%E8%AF%91/"/>
    
    
  </entry>
  
  <entry>
    <title>Lab 2.1 ç³»ç»Ÿè°ƒç”¨æµç¨‹â€”â€”ä»¥sleepä¸ºä¾‹</title>
    <link href="http://rinevard.github.io/wiki/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/"/>
    <id>http://rinevard.github.io/wiki/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/</id>
    <published>2025-10-15T08:02:38.000Z</published>
    <updated>2025-10-19T03:44:03.330Z</updated>
    
    <content type="html"><![CDATA[<p>æˆ‘ä»¬çŸ¥é“åº”ç”¨ç¨‹åºåœ¨User modeä¸‹è¿è¡Œï¼Œè€Œç³»ç»Ÿå‡½æ•°çš„æ‰§è¡Œéœ€è¦Supervisor modeï¼Œé‚£åœ¨ç³»ç»Ÿè°ƒç”¨æ—¶ï¼ŒUser modeæ˜¯æ€ä¹ˆè¿›å…¥Supervisor modeçš„å‘¢ï¼Ÿæˆ‘ä»¬ä»¥sleepçš„æ‰§è¡Œä¸ºä¾‹ï¼Œçœ‹çœ‹éƒ½å‘ç”Ÿäº†ä»€ä¹ˆã€‚é¦–å…ˆæˆ‘ä»¬ç”¨ <code>git checkout util</code> åˆ‡æ¢åˆ° util åˆ†æ”¯ä¸Šã€‚</p><p>åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬è¦å…ˆç®€ä»‹ä¸€ä¸‹<strong>ECALL</strong>æŒ‡ä»¤å’Œ<strong>stvec</strong>ï¼ˆSupervisor Trap Vector Base Address Registerï¼‰å¯„å­˜å™¨ã€‚</p><p>ECALL ä¼šè§¦å‘ä¸€ä¸ªå¼‚å¸¸ï¼Œå¦‚æœæˆ‘ä»¬åœ¨ç”¨æˆ·æ€è§¦å‘è¿™ä¸ªå¼‚å¸¸ï¼Œç¨‹åºè®¡æ•°å™¨ pc å°±ä¼šæ ¹æ® stvec è¿›è¡Œè·³è½¬ï¼Œåˆ°è¾¾å¼‚å¸¸å¤„ç†å¤„ã€‚</p><p>ä»¥ä¸‹æ˜¯ <a href="https://www.scs.stanford.edu/~zyedidia/docs/riscv/riscv-privileged.pdf">risc-v æ‰‹å†Œ</a> å¯¹ ECALL çš„è§£é‡Šï¼š</p><blockquote><p>When executed in U-mode, S-mode, or M-mode, it generates an environment-call-from-U-mode exception, environment-call-from-S-mode exception, or environment-call-from-M-mode exception, respectively, and performs no other operation.</p><p>å¦‚æœåœ¨ U-mode æ‰§è¡Œï¼ŒECALL æŒ‡ä»¤ä¼šäº§ç”Ÿä¸€ä¸ªæ¥è‡ª U-mode çš„ç¯å¢ƒè°ƒç”¨å¼‚å¸¸ï¼›å¦‚æœåœ¨ S-mode æ‰§è¡Œï¼Œåˆ™äº§ç”Ÿæ¥è‡ª S-mode çš„ç¯å¢ƒè°ƒç”¨å¼‚å¸¸ï¼›å¦‚æœåœ¨ M-mode æ‰§è¡Œï¼Œåˆ™äº§ç”Ÿæ¥è‡ª M-mode çš„ç¯å¢ƒè°ƒç”¨å¼‚å¸¸ã€‚</p></blockquote><p>ä»¥ä¸‹æ˜¯ risc-v æ‰‹å†Œå¯¹ stvec å¯„å­˜å™¨çš„ç®€ä»‹ï¼š</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/stvec.png" alt=""></p><p>BASEæ˜¯4å­—èŠ‚å¯¹é½çš„ï¼ˆRISC-V æ‰‹å†Œ P80ï¼‰ï¼Œæ‰€ä»¥åœ¨MODE == 0æ—¶ï¼Œæˆ‘ä»¬è·³è½¬åˆ°çš„åœ°å€æ˜¯ <code>(stvec &gt;&gt; 2) &lt;&lt; 2</code>ï¼Œè€Œç”±äº MODE == 0ï¼Œè¿™ä¸ªå€¼å°±æ˜¯ stvec ï¼›åœ¨MODE == 1æ—¶ï¼Œæˆ‘ä»¬è½¬åˆ°çš„åœ°å€æ˜¯ <code>(stvec &gt;&gt; 2) &lt;&lt; 2 + 4*cause</code></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥å¼€å§‹çœ‹çœ‹ç³»ç»Ÿè°ƒç”¨æ—¶ç©¶ç«Ÿå‘ç”Ÿäº†ä»€ä¹ˆï¼æˆ‘ä»¬ä¼šä»¥sleepä¸ºä¾‹ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬æ‰“å¼€gdb-multiarchï¼ˆå‚è€ƒ Note 0 çš„â€ç”¨ç»ˆç«¯è°ƒè¯•â€œï¼‰ï¼Œç„¶åç”¨ <code>set prompt \\001\\033[1;33m\\002(gdb) \\001\\033[0m\\002</code> æ¥é«˜äº® â€œ(gdb)â€ ä»¥æ–¹ä¾¿è§‚å¯Ÿè‡ªå·±çš„è¾“å…¥ã€‚</p><p>ç”¨ <code>file user/_sleep</code> åˆ‡æ¢åˆ°ç”¨æˆ·ç¬¦å·è¡¨ï¼Œæ¥ç€ç”¨<code>c</code>è¿è¡Œåˆ°xv6çš„shellå¯åŠ¨ã€‚</p><p>è§‚å¯Ÿå³è¾¹çš„ç»ˆç«¯å¯ä»¥çœ‹åˆ°shellå·²ç»æˆåŠŸå¯åŠ¨äº†ã€‚</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/debug_start.png" alt=""></p><p>ç„¶åæˆ‘ä»¬åœ¨gdbé‡ŒæŒ‰ä¸‹ctrl+cæ¥ä¸­æ–­ï¼Œå¹¶ç”¨ <code>b main</code> è®¾ç½®æ–­ç‚¹ï¼Œå†ä½¿ç”¨ <code>layout split</code> è®©gdbæ˜¾ç¤ºå‡ºæºç å’Œæ±‡ç¼–ä»£ç ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬åœ¨gdbé‡Œè¾“å…¥ <code>c</code> ä»¥è®©xv6ç»§ç»­æ‰§è¡Œï¼Œå¦åˆ™xv6çš„shellä¼šå¤„äºæš‚åœçŠ¶æ€ï¼Œä¸èƒ½å¤„ç†è¾“å…¥ã€‚</p><p>ç„¶ååœ¨xv6çš„shellé‡Œæ‰§è¡Œ <code>sleep 1</code> ï¼Œå®ƒä¼šåœ¨æ–­ç‚¹å¤„åœä¸‹ã€‚</p><p>è§‚å¯Ÿå·¦è¾¹çš„gdbï¼Œå¯ä»¥çœ‹åˆ°å®ƒåœåœ¨äº†sleep.cçš„mainå‡½æ•°ã€‚</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/sleep_main.png" alt=""></p><p>éšä¾¿æ‰§è¡Œä¸€ä¸‹ç›´åˆ°åˆ°è¾¾sleepè¿™è¡Œï¼Œ<code>n</code> è¡¨ç¤ºæ‰§è¡Œä¸€è¡Œcè¯­è¨€ï¼Œ<code>si</code>è¡¨ç¤ºæ‰§è¡Œä¸€ä¸ªæ±‡ç¼–è¯­å¥ã€‚</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/sleep_jal_atoi.png" alt=""></p><p>æˆ‘ä»¬ç”¨<code>si</code>è¿›å…¥atoiï¼Œç„¶åäº¤æ›¿ç€ç”¨<code>n</code>å’Œ<code>si</code>ï¼Œåœ¨å¿«åˆ°returnæ—¶ç”¨<code>si</code>ï¼Œå°±èƒ½ç¦»å¼€atoiå›åˆ°sleep.cã€‚</p><p>è§‚å¯Ÿå·¦è¾¹çš„gdbï¼Œå’Œä¸Šå›¾ç›¸æ¯”ï¼Œè™½ç„¶cè¯­è¨€çš„ä½ç½®æ²¡æœ‰å˜åŒ–ï¼Œä½†æ±‡ç¼–ä»£ç çš„ä½ç½®æ˜¯æœ‰å˜åŒ–çš„ã€‚</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/sleep_jal_sleep.png" alt=""></p><p>ä¹‹åç”¨<code>si</code>ï¼Œä¼šå‘ç°æˆ‘ä»¬è·³è½¬åˆ°äº† <code>usys.S</code>ï¼Œå®ƒæŠŠsleepçš„ç³»ç»Ÿè°ƒç”¨å·æ”¾åˆ°å¯„å­˜å™¨a7é‡Œï¼Œç„¶åå€ŸåŠ©ecallæ¥æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ã€‚</p><p>è§‚å¯Ÿå·¦è¾¹çš„gdbå‘ç°æˆ‘ä»¬å·²ç»è¿›å…¥äº†<code>usys.S</code></p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/usys_enter.png" alt=""></p><p>å¦‚æœæˆ‘ä»¬ç›´æ¥ç”¨å‡ ä¸ª<code>si</code>ï¼Œä¼šå‘ç°<code>ecall</code>å¹¶æ²¡æœ‰åƒ<code>jal</code>ä¹‹ç±»çš„è·³è½¬è¯­å¥ä¸€æ ·å¸¦æˆ‘ä»¬åˆ°ä¸€äº›ç¥å¥‡çš„åœ°æ–¹ï¼Œè€Œæ˜¯ç›´æ¥åˆ°äº†ä¸‹ä¸€è¡Œã€‚è¿™æ˜¯å› ä¸º<code>ecall</code>ä¸æ˜¯è·³è½¬ï¼Œè€Œæ˜¯æŠ›å‡ºäº†ä¸€ä¸ªå¼‚å¸¸ï¼Œå†…æ ¸è‡ªåŠ¨å¤„ç†äº†å¼‚å¸¸ã€‚</p><p>è¿™æ ·çœ‹æ¥ï¼Œæˆ‘ä»¬è¦æ‰¾åˆ°è¿™ä¸ªå¼‚å¸¸çš„å¼€å§‹å¤„å¹¶è®¾ç½®æ–­ç‚¹æ‰è¡Œã€‚è¿˜è®°å¾—æˆ‘ä»¬ä¹‹å‰è¯´è¿‡<code>ecall</code>æŠ›å‡ºå¼‚å¸¸æ—¶pcä¼šè·³è½¬åˆ°å“ªé‡Œå—ï¼Ÿç­”æ¡ˆæ˜¯å®ƒä¼šæ ¹æ®å¯„å­˜å™¨stvecçš„å€¼è¿›è¡Œè·³è½¬ã€‚è®©æˆ‘ä»¬å€ŸåŠ©<code>p /x $stvec</code>çœ‹çœ‹stvecçš„å€¼ã€‚</p><p>è§‚å¯Ÿå·¦è¾¹çš„gdbï¼Œå‘ç°stvecçš„å€¼æ˜¯ 0x3ffffff000ï¼Œè‡³å°‘åœ¨æˆ‘è¿™é‡Œæ˜¯è¿™æ ·ã€‚</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/print_stvec.png" alt=""></p><p>å›é¡¾ä¸€ä¸‹stvecå¯„å­˜å™¨çš„ç»“æ„å’ŒåŠŸèƒ½ï¼Œä¼šå‘ç°æ‰§è¡Œecallåï¼Œpcä¼šè·³è½¬åˆ°BASEæ‰€åœ¨çš„åœ°å€ã€‚æˆ‘ä»¬ä¹‹å‰è¯´è¿‡ï¼ŒBASEæ˜¯4å­—èŠ‚å¯¹é½çš„ï¼ˆRISC-V æ‰‹å†Œ P80ï¼‰ï¼Œæ‰€ä»¥åœ¨MODE == 0æ—¶ï¼Œæˆ‘ä»¬è·³è½¬åˆ°çš„åœ°å€æ˜¯ <code>(stvec &gt;&gt; 2) &lt;&lt; 2</code>ï¼Œè€Œç”±äº MODE == 0ï¼Œè¿™ä¸ªå€¼å°±æ˜¯ stvecã€‚</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/stvec.png" alt=""></p><p>æˆ‘ä»¬æ¥ä¸‹æ¥æŠŠæ–­ç‚¹è®¾ç½®åœ¨è¿™ä¸ªå€¼ï¼Œç„¶åç”¨<code>si</code>åˆ°è¾¾<code>ecall</code>è¯­å¥å¤„</p><p>è§‚å¯Ÿå·¦è¾¹çš„gdbï¼Œæˆ‘ä»¬ç°åœ¨å·²ç»åœ¨<code>ecall</code>è¿™é‡Œäº†ã€‚</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/break_ecall_target.png" alt=""></p><p>å¦‚æœæˆ‘ä»¬çš„æ“ä½œæ­£ç¡®ï¼Œæ¥ä¸‹æ¥çš„<code>si</code>ä¼šè§¦å‘ä¸€ä¸ªå¼‚å¸¸å¯¼è‡´æˆ‘ä»¬è·³è½¬åˆ° 0x3ffffff000 å¹¶è§¦å‘æ–­ç‚¹ï¼Œå¸Œæœ›æˆ‘ä»¬æ²¡æœ‰ç¿»è½¦~</p><p>è§‚å¯Ÿå·¦è¾¹çš„gdbï¼Œå‘ç°æˆ‘ä»¬æˆåŠŸè·³è½¬åˆ°äº†ä¸€ä¸ªæœªçŸ¥çš„åœ°æ–¹ï¼</p><p>æŒ‰æˆ‘çš„ç†è§£ï¼Œç”±äºæˆ‘ä»¬åœ¨U-modeä¸‹æ‰§è¡Œecallä»¥è§¦å‘å¼‚å¸¸ï¼Œæ‰€ä»¥æˆ‘ä»¬ç°åœ¨å·²ç»è¿›å…¥äº†S-modeã€‚ä¸è¿‡æˆ‘ç¿»äº†å¾ˆå¤šèµ„æ–™è¿˜æ˜¯æ²¡æœ‰æ‰¾åˆ°èƒ½æ˜ç¡®æ”¯æŒè¿™ä¸€ç‚¹çš„è¯æ®ï¼ˆä¹Ÿæ²¡æœ‰æ‰¾åˆ°æ˜ç¡®åå¯¹çš„è¯æ®ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä¿ç•™æˆ‘çš„è§‚ç‚¹ã€‚</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/ecall.png" alt=""></p><p>æ€»ä¹‹ä¸€åˆ‡é¡ºåˆ©ï¼è®©æˆ‘ä»¬æš‚åœä¸€ä¸‹ï¼Œæƒ³æƒ³è¿™ä¸ª 0x3ffffff000 çš„åœ°å€ä»£è¡¨ä»€ä¹ˆã€‚åœ¨å†…æ ¸å¯åŠ¨æ—¶é€šè¿‡<code>file kernel/kernel</code> åŠ è½½å†…æ ¸ç¬¦å·è¡¨å¹¶åœ¨<code>usertrapret</code>è®¾ç½®æ–­ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç° 0x3ffffff000 è¿™ä¸ªåœ°å€å’Œ <code>kernel/trap.c</code> é‡Œçš„<code>trampoline_uservec</code> ç›¸ç­‰ã€‚</p><p>trampolineæ˜¯ä»€ä¹ˆï¼Ÿtrampolineæ˜¯åœ¨è¿›ç¨‹è™šæ‹Ÿå†…å­˜çš„é¡¶éƒ¨çš„ä¸€å—ç©ºé—´ï¼Œæ˜ å°„åˆ°çš„ç‰©ç†åœ°å€å­˜æ”¾ç€è·³è½¬è¿›å’Œè·³è½¬å‡ºå†…æ ¸çš„ä»£ç ã€‚çœ‹èµ·æ¥åœ¨åšç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œæˆ‘ä»¬é€šè¿‡ecallè·³è½¬è¿›å†…æ ¸ã€‚è¿™æ ·ä¸€åˆ‡éƒ½è¯´å¾—é€šäº†~</p><p>è®©æˆ‘ä»¬æ‰“å¼€trampoline.Sï¼Œå¯¹æ¯”å·¦è¾¹gdbæ˜¾ç¤ºçš„ä»£ç å’Œå³è¾¹çš„trampoline.Sï¼Œä¼šå‘ç°å®ƒä»¬ç¡®å®èƒ½å¯¹ä¸Šï¼</p><p>å¥½å§ï¼Œä¹Ÿä¸æ˜¯å®Œå…¨èƒ½å¯¹ä¸Šï¼Œä½ ä¼šæ³¨æ„åˆ°å³è¾¹çš„ <code>li a0,TRAPFRAME</code> åœ¨å·¦è¾¹ä¼¼ä¹å¯¹åº”äº†ä¸‰æ¡è¯­å¥ï¼Œè¿™æ˜¯æ€ä¹ˆå›äº‹å‘¢ï¼Ÿå®é™…ä¸Šï¼Œ<code>li</code> æ˜¯RISC-V æ±‡ç¼–ä¸­çš„ä¼ªæŒ‡ä»¤ï¼Œå®é™…æ‰§è¡Œæ—¶ï¼Œ<code>li</code> ä¼šè¢«æ±‡ç¼–å™¨ç¿»è¯‘ä¸ºä¸€æ¡æˆ–å¤šæ¡çœŸæ­£çš„ RISC-V æŒ‡ä»¤ã€‚</p><p>å—¯ï¼Œè¿™æ ·å°±èƒ½å¯¹ä¸Šäº†ï¼</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/trapoline_enter.png" alt=""></p><p>è¯»ä¸€è¯»trampoline.Sï¼Œæˆ‘ä»¬å‘ç°å®ƒä¼šæŠŠç”¨æˆ·è¿›ç¨‹çš„å¯„å­˜å™¨ç­‰ä¿¡æ¯ä¿å­˜åˆ°trapframeé‡Œï¼Œç„¶åè·³è½¬åˆ°å†…æ ¸çš„usertrapå‡½æ•°ã€‚</p><p>å› æ­¤æ¥ä¸‹æ¥æˆ‘ä»¬è¦ç”¨<code>file kernel/kernel</code>æŠŠç¬¦å·è¡¨åˆ‡æ¢åˆ°kernelï¼Œå†ç”¨<code>si n</code> æ¥ä¸€æ¬¡æ‰§è¡Œå¤šæ¡æ±‡ç¼–è¯­å¥ï¼Œç›´åˆ°æŒ‡ä»¤<code>jr</code>å¤„ï¼š</p><p>æ¯”è¾ƒå·¦è¾¹å’Œå³è¾¹ï¼Œå‘ç°å®ƒä»¬çš„æ±‡ç¼–ä»£ç ç¡®å®èƒ½å¯¹ä¸Šï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¦å‡†å¤‡è·³è½¬äº†ã€‚</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/trapoline_jump.png" alt=""></p><p>é™·é˜±ï¼Œå¯åŠ¨ï¼</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/usertrap_enter.png" alt=""></p><p>å¦‚æœä½ å‘ç°ä½ çš„gdbæ²¡æœ‰é¡ºåˆ©æ˜¾ç¤ºå‡ºcè¯­è¨€ä»£ç ï¼Œå¯èƒ½æ˜¯ä½ å¿˜è®°åˆ‡æ¢ç¬¦å·è¡¨åˆ°å†…æ ¸äº†ï¼Œç”¨<code>file kernel/kernel</code>æ¥åˆ‡æ¢ï¼Œç„¶åè¡¥ä¸€ä¸ª<code>si</code>å°±èƒ½æ˜¾ç¤ºå‡ºæ¥äº†ã€‚</p><p>ç”±äºä¸€åˆ‡æ­£å¸¸ï¼Œæˆ‘ä»¬å¯ä»¥ä¸€è·¯æŒ‰<code>n</code>ç›´åˆ°åˆ°è¾¾syscallè¿™é‡Œã€‚</p><p>æ¯”è¾ƒå·¦è¾¹å’Œå³è¾¹çš„ä»£ç ï¼Œå®ƒä»¬æ˜¯èƒ½å¯¹åº”ä¸Šçš„ã€‚æ¥ä¸‹æ¥è®©æˆ‘ä»¬å‡†å¤‡è¿›å…¥<code>syscall</code></p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/usertrap_jump.png" alt=""></p><p>æˆ‘ä»¬ç”¨<code>s</code>è¿›å…¥syscallå‡½æ•°ã€‚<code>n</code>å’Œ<code>s</code>éƒ½ä¼šæ‰§è¡Œå½“å‰è¡Œï¼Œä¸è¿‡å¦‚æœå½“å‰è¡Œæ˜¯å‡½æ•°ï¼Œ<code>n</code>ä¸ä¼šè¿›å…¥å‡½æ•°ï¼Œè€Œ<code>s</code>ä¼šã€‚</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/syscall_enter.png" alt=""></p><p>syscallå‡½æ•°ä»trapframeä¸­å–å‡ºç³»ç»Ÿè°ƒç”¨å·ï¼Œç„¶åè°ƒç”¨å®ƒã€‚è¿˜è®°å¾—å—ï¼Œæˆ‘ä»¬è°ƒç”¨ç³»ç»Ÿå‡½æ•°æ—¶å…ˆè¿›å…¥äº†usys.Sï¼Œç„¶åæŠŠç³»ç»Ÿè°ƒç”¨å·ä¿å­˜åˆ°äº†a7ã€‚ä¹‹åç”±äºæˆ‘ä»¬è½¬å…¥äº†å†…æ ¸ï¼Œæˆ‘ä»¬åœ¨trapoline.Sé‡ŒæŠŠæ‰€æœ‰çš„ç”¨æˆ·ç©ºé—´çš„å¯„å­˜å™¨éƒ½ä¿å­˜åˆ°äº†trapframeä¸­ã€‚</p><p>æ€»ä¹‹æˆ‘ä»¬åœ¨è¿™é‡Œè°ƒç”¨äº†sys_sleepï¼Œæˆ‘ä»¬è¿›å…¥å®ƒçœ‹çœ‹ã€‚</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/syssleep_enter.png" alt=""></p><p>å¯ä»¥å‘ç°å®ƒå°±æ˜¯çœŸæ­£å¹²æ´»çš„åœ°æ–¹ï¼å®ƒéå¸¸å¿ å®åœ°æ‰§è¡Œäº†sleepçš„é€»è¾‘ã€‚</p><p>æˆ‘ä»¬å¯ä»¥æ³¨æ„åˆ° n å°±æ˜¯å­˜æ”¾ç€æˆ‘ä»¬æœ€å¼€å§‹ä¼ å…¥çš„å‚æ•°çš„å˜é‡ï¼Œå†…æ ¸é€šè¿‡argintæ¥æ‰¾åˆ°æˆ‘ä»¬ä¸€å¼€å§‹ä¼ å…¥çš„å‚æ•°ã€‚argintçš„æ€è·¯å’Œæˆ‘ä»¬ä¹‹å‰æ‰¾åˆ°ç³»ç»Ÿè°ƒç”¨å·ç±»ä¼¼ï¼Œä¹Ÿæ˜¯ä»trapframeä¸­æ‰¾åˆ°å­˜æ”¾ç€ä¼ å…¥å‚æ•°çš„å¯„å­˜å™¨ã€‚</p><p>è®©æˆ‘ä»¬ç»§ç»­å¾€åï¼Œçœ‹çœ‹åœ¨æ‰§è¡Œå®Œé€»è¾‘ä»¥åå‘ç”Ÿäº†ä»€ä¹ˆå§ã€‚</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/syssleep_return.png" alt=""></p><p>å›åˆ°<code>usertrap</code>ï¼Œæˆ‘ä»¬ä¸€è·¯å¾€ä¸‹åˆ°è¾¾<code>usertrapret</code>ï¼Œç„¶åç”¨<code>s</code>è¿›å…¥å®ƒã€‚</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/usertrapret_enter.png" alt=""></p><p>çœ‹å‡½æ•°åä¸Šé¢çš„æ³¨é‡Šå°±èƒ½å‘ç°å®ƒä¼šå¸¦æˆ‘ä»¬å›åˆ°ç”¨æˆ·ç©ºé—´ã€‚</p><p>æˆ‘ä»¬ç”¨<code>n</code>ä¸€è·¯è¿è¡Œåˆ°åº•ï¼Œå†çœ‹çœ‹æ³¨é‡Šï¼Œå‘ç°æ³¨é‡Šè¯´æˆ‘ä»¬ä¼šè·³è½¬åˆ°trampoline.Sã€‚</p><p>è§‚å¯Ÿå·¦è¾¹çš„gdbï¼Œ<code>p /x trampoline_userret</code> æ²¡æœ‰æ‰“å°å€¼æ˜¯å› ä¸ºtrampoline_userretè¢«ç¼–è¯‘å™¨ä¼˜åŒ–æ‰äº†ï¼Œæˆ‘ä»¬è¦æ‰‹åŠ¨æŠŠå®ƒçš„è¡¨è¾¾å¼å†™å‡ºæ¥å†æ‰“å°ï¼Œæ€»ä¹‹æˆ‘ä»¬æ‰“å°å‡ºäº† 0x3ffffff09cã€‚</p><p>åœ¨é‚£é‡Œè®¾ä¸ªæ–­ç‚¹ï¼Œç„¶åå‡†å¤‡ç»§ç»­ã€‚</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/usertrapret_break.png" alt=""></p><p>å¤šæŒ‰å‡ ä¸ª<code>si</code> åˆ°è¾¾è·³è½¬è¯­å¥å¤„ï¼Œä¸å‡ºæ„å¤–çš„è¯å†ç”¨ä¸€æ¬¡<code>si</code> å°±ä¼šå¸¦æˆ‘ä»¬è¿›å…¥trapoline.Sçš„userretéƒ¨åˆ†äº†ã€‚</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/usertrapret_jump.png" alt=""></p><p>ä¸€åˆ‡çš„ä¸€åˆ‡éƒ½ç¬¦åˆé¢„æœŸï¼Œæˆ‘ä»¬æˆåŠŸè¿›å…¥äº†trampoline.Sã€‚</p><p>å¯¹æ¯”å·¦å³çš„æ±‡ç¼–ä»£ç å¯ä»¥å‘ç°å®ƒä»¬æ˜¯å¯¹åº”çš„ã€‚ä¸ä¹‹å‰ç›¸åŒï¼Œ<code>li</code>è¢«å±•å¼€äº†ã€‚</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/trapoline_enter_again.png" alt=""></p><p>ç„¶åæˆ‘ä»¬ä¸€è·¯æŒ‰<code>si</code>åˆ°è¾¾<code>sret</code>è¯­å¥å¤„ã€‚<code>sret</code>ä¼šåšä»€ä¹ˆå‘¢ï¼Ÿè®©æˆ‘ä»¬çœ‹çœ‹riscvæ‰‹å†Œï¼š</p><blockquote><p>The SRET instruction is used to return from a trap taken into S-mode. [â€¦] When executing SRET, the privilege level is set to the value in the SPP field of the sstatus register; [â€¦] the pc is set to the value stored in the sepc register.</p><p><code>SRET</code> æŒ‡ä»¤ç”¨äºä»è¿›å…¥ S-mode çš„é™·é˜±ä¸­è¿”å›ã€‚[â€¦] å½“æ‰§è¡Œ <code>SRET</code> æ—¶ï¼Œç‰¹æƒçº§åˆ«è¢«è®¾ç½®ä¸º<code>sstatus</code> å¯„å­˜å™¨ä¸­ <code>SPP</code> å­—æ®µçš„å€¼ï¼›[â€¦] ç¨‹åºè®¡æ•°å™¨ pc è¢«è®¾ç½®ä¸ºå­˜å‚¨åœ¨ <code>sepc</code> å¯„å­˜å™¨ä¸­çš„å€¼ã€‚</p></blockquote><p>æˆ‘ä»¬å€ŸåŠ© <code>p /x sepc</code> æ‰“å°è¿™ä¸ªå¯„å­˜å™¨çš„å€¼çœ‹çœ‹~ï¼ˆè¯·å¿½è§†å·¦å›¾é‡Œæˆ‘ä¹‹å‰å†™æˆspecçš„æ‰‹è¯¯ï¼‰</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/trapoline_ret_user.png" alt=""></p><p>0x342æ˜¯ä»€ä¹ˆï¼Ÿå¦‚æœä½ è®°å¿†åŠ›å¾ˆå¥½çš„è¯ï¼Œä¼šå‘ç°å®ƒæ°å¥½å°±æ˜¯usys.Sé‡Œçš„<code>ret</code>é‚£è¡Œï¼</p><p>ï¼ˆè¿™é¬¼æ‰è®°å¾—ä½å•Šå–‚ï¼‰</p><p>æ€»ä¹‹æˆ‘ä»¬çœ‹çœ‹ä¹‹å‰çš„æˆªå›¾å§ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°0x342ç¡®å®æ˜¯reté‚£è¡Œï¼Œå°±æ˜¯ä¸‹é¢çš„æˆªå›¾ä¸­é«˜äº®çš„æ±‡ç¼–ä»£ç ä¸‹é¢é‚£è¡Œã€‚</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/hello_world_again.png" alt=""></p><p>æˆ‘ä»¬ç”¨<code>b *0x342</code>è®¾ä¸ªæ–­ç‚¹åœ¨é‚£é‡Œï¼Œç„¶åæ‰§è¡Œ<code>si</code> ï¼Œæˆ‘ä»¬å›åˆ°äº†ç”¨æˆ·ç©ºé—´ï¼åŒæ—¶ï¼Œ<code>sret</code>ä¹Ÿè®©æˆ‘ä»¬å›åˆ°äº†U-modeã€‚</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/return_to_user.png" alt=""></p><p>ç”¨<code>file user/_sleep</code>åˆ‡æ¢ç¬¦å·è¡¨ï¼Œå†æ‰§è¡Œ<code>si</code>ï¼Œæˆ‘ä»¬å›æ¥äº†ã€‚</p><p><img src="/images/learning/open-course/MIT-6.S081/labs/lab2_1-syscall_process/im_back.png" alt=""></p><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å®Œæˆäº†ä¸€ä¸ªå®Œæ•´çš„ç³»ç»Ÿè°ƒç”¨ã€‚</p><p>æ€»ç»“ä¸€ä¸‹ï¼Œå½“æˆ‘ä»¬è¿›è¡Œç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œæˆ‘ä»¬å…ˆè¿›å…¥usys.Sï¼Œç„¶åecallè§¦å‘å¼‚å¸¸å¹¶è·³è½¬åˆ°trapoline.Sçš„uservecå¤„ï¼Œä¹‹ååˆ°è¾¾trap.cçš„usertrapå‡½æ•°ï¼Œå®ƒä¼šè°ƒç”¨syscallå‡½æ•°ä»¥æ‰§è¡Œç³»ç»Ÿå‡½æ•°çš„é€»è¾‘ï¼Œæ‰§è¡Œå®Œåè¿›å…¥usertrapretå‡½æ•°ï¼Œå†è·³è½¬åˆ°trapoline.Sçš„userretå¤„ï¼Œæœ€åå›åˆ°usys.Sï¼Œå†å›åˆ°ç”¨æˆ·çš„ä»£ç é‡Œã€‚</p><p>ç¬¬ä¸€æ¬¡è·³è½¬åˆ°trapoline.Sä¸»è¦æ˜¯ä¿å­˜äº†ç”¨æˆ·çš„å„ä¸ªå¯„å­˜å™¨åˆ°trapframeï¼Œç¬¬äºŒæ¬¡è·³è½¬æ˜¯ä»trapframeä¸­æ¢å¤äº†è¿™äº›å¯„å­˜å™¨ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;æˆ‘ä»¬çŸ¥é“åº”ç”¨ç¨‹åºåœ¨User modeä¸‹è¿è¡Œï¼Œè€Œç³»ç»Ÿå‡½æ•°çš„æ‰§è¡Œéœ€è¦Supervisor modeï¼Œé‚£åœ¨ç³»ç»Ÿè°ƒç”¨æ—¶ï¼ŒUser modeæ˜¯æ€ä¹ˆè¿›å…¥Supervisor modeçš„å‘¢ï¼Ÿæˆ‘ä»¬ä»¥sleepçš„æ‰§è¡Œä¸ºä¾‹ï¼Œçœ‹çœ‹éƒ½å‘ç”Ÿäº†ä»€ä¹ˆã€‚é¦–å…ˆæˆ‘ä»¬ç”¨ &lt;code&gt;git checkout u</summary>
      
    
    
    
    <category term="å…¬å¼€è¯¾" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/"/>
    
    <category term="MIT-6.S081" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/MIT-6-S081/"/>
    
    <category term="Labs" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/MIT-6-S081/Labs/"/>
    
    
  </entry>
  
  <entry>
    <title>Lab 2 System calls</title>
    <link href="http://rinevard.github.io/wiki/learning/open-course/MIT-6.S081/Labs/lab2-syscall/"/>
    <id>http://rinevard.github.io/wiki/learning/open-course/MIT-6.S081/Labs/lab2-syscall/</id>
    <published>2025-10-15T07:54:38.000Z</published>
    <updated>2025-10-15T08:10:39.024Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬å›é¡¾ä¸€ä¸‹æ€ä¹ˆå¯åŠ¨è°ƒè¯•æ¨¡å¼ï¼š</p><p>åœ¨ä¸€ä¸ªç»ˆç«¯é‡Œæ‰§è¡Œ <code>make qemu-gdb</code> ï¼Œ<code>make qemu-gdb CPUS=1</code> å¯ä»¥åªä½¿ç”¨ä¸€ä¸ªæ ¸å¿ƒï¼Œæ¯”èµ·å¤šçº¿ç¨‹æ›´ä¾¿äºè°ƒè¯•ã€‚</p><p>åœ¨å¦ä¸€ä¸ªç»ˆç«¯é‡Œæ‰§è¡Œ <code>gdb-multiarch kernel/kernel</code> ï¼Œè¿›å…¥ gdb åæ‰§è¡Œ <code>target remote localhost:26001</code>ï¼Œè¿™é‡Œçš„ç«¯å£å·ä¸ä¸€å®šæ˜¯ 26001ï¼Œçœ‹ <code>make qemu-gdb CPUS=1</code> çš„æ‰“å°ç»“æœå°±è¡Œã€‚</p><p>è¿™æ ·å°±è¿›å…¥è°ƒè¯•æ¨¡å¼äº†ã€‚å¦å¤–ï¼Œæˆ‘ä¹ æƒ¯ç”¨ <code>set prompt \001\033[1;33m\002(gdb) \001\033[0m\002</code> æ¥é«˜äº® â€œ(gdb)â€ è¿™å‡ ä¸ªå­—ã€‚</p><h1 id="Using-gdb"><a href="#Using-gdb" class="headerlink" title="Using gdb"></a>Using gdb</h1><p>lab å¼€å¤´è®©æˆ‘ä»¬ç†Ÿæ‚‰ä¸€ä¸‹ gdb çš„ä½¿ç”¨ã€‚å¯åŠ¨è°ƒè¯•æ¨¡å¼ä»¥åæŒ‰éƒ¨å°±ç­å°±èƒ½å®Œæˆï¼Œæˆ‘ä»¬è¿™é‡Œè®°å½•ä¸€ä¸‹å¸¸ç”¨çš„ä¸€äº› gdb æŒ‡ä»¤ï¼š</p><pre class="line-numbers language-none"><code class="language-none">c æˆ– continue - ç»§ç»­æ‰§è¡Œç›´åˆ°é‡åˆ°ä¸‹ä¸€ä¸ªæ–­ç‚¹n æˆ– next - å•æ­¥æ‰§è¡Œ,ä¼šè·³è¿‡å‡½æ•°è°ƒç”¨s æˆ– step - å•æ­¥æ‰§è¡Œ,ä¼šè¿›å…¥å‡½æ•°å†…éƒ¨si - æ‰§è¡Œä¸€æ¡æ±‡ç¼–æŒ‡ä»¤finish - è¿è¡Œåˆ°å½“å‰å‡½æ•°è¿”å›ä¸ºæ­¢p &#x2F;x $mstatus - ä»¥åå…­è¿›åˆ¶æ‰“å°CPUå½“å‰æ¨¡å¼backtraceï¼ˆç¼©å†™btï¼‰ - æ˜¾ç¤ºå‡½æ•°è°ƒç”¨æ ˆset prompt \\001\\033[1;33m\\002(gdb) \\001\\033[0m\\002 - é«˜äº®(gdb)until - è¿è¡Œåˆ°æŒ‡å®šè¡Œå·ä¸ºæ­¢<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="System-call-tracing"><a href="#System-call-tracing" class="headerlink" title="System call tracing"></a>System call tracing</h1><p>è¿™é“é¢˜è®©æˆ‘ä»¬å®ç°ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼ŒæŒ‰ç€ hints æŒ‰éƒ¨å°±ç­å°±èƒ½åšæ‰ã€‚å”¯ä¸€è¦æ³¨æ„çš„æ˜¯åœ¨ syscall é‡Œæ‰“å° trace ç›¸å…³çš„å†…å®¹æ—¶è¦æŠŠç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼ ret ä»åŸæœ¬çš„ <code>uint64</code> è½¬æ¢ä¸º <code>long long</code>ï¼Œå¦åˆ™å¯¹é‚£äº›å¯èƒ½è¿”å› -1 çš„ç³»ç»Ÿè°ƒç”¨ï¼Œæˆ‘ä»¬æ— æ³•æ­£ç¡®æ‰“å° -1.</p><p>åœ¨ç…§ç€ hints å®ç°ä¹‹åï¼Œçœ‹çœ‹ç³»ç»Ÿè°ƒç”¨æ˜¯å¦‚ä½•è¿›è¡Œçš„ä¹Ÿæ˜¯æ›´æœ‰è¶£çš„äº‹æƒ…ã€‚æˆ‘åœ¨ <a href="/wiki/learning/open-course/MIT-6.S081/Labs/lab2_1-syscall_process/" title="Lab 2.1 ç³»ç»Ÿè°ƒç”¨æµç¨‹â€”â€”ä»¥sleepä¸ºä¾‹">Lab 2.1 ç³»ç»Ÿè°ƒç”¨æµç¨‹â€”â€”ä»¥sleepä¸ºä¾‹</a> ä¸­å†™å¾—è¿˜æŒºè¯¦ç»†çš„ï¼Œè¿™é‡Œä¸å¤šèµ˜è¿°ç»†èŠ‚ã€‚</p><p>ç®€è€Œè¨€ä¹‹ï¼Œå½“æˆ‘ä»¬è¿›è¡Œç³»ç»Ÿè°ƒç”¨æ—¶ï¼š</p><ol><li>è¿›å…¥ç”± <code>usys.pl</code> ç”Ÿæˆçš„ <code>usys.S</code> </li><li>ecall è§¦å‘å¼‚å¸¸å¹¶è·³è½¬åˆ° <code>trapoline.S</code> çš„ uservec å¤„</li><li>åˆ°è¾¾ <code>trap.c</code> çš„ usertrap å‡½æ•°ï¼Œå®ƒä¼šè°ƒç”¨ syscall å‡½æ•°ä»¥æ‰§è¡Œç³»ç»Ÿå‡½æ•°çš„é€»è¾‘</li><li>ç³»ç»Ÿå‡½æ•°æ‰§è¡Œå®Œæˆåè¿›å…¥usertrapretå‡½æ•°</li><li>è·³è½¬åˆ° <code>trapoline.S</code> çš„userretå¤„</li><li>æœ€åå›åˆ° <code>usys.S</code></li><li>å›åˆ°ç”¨æˆ·çš„ä»£ç é‡Œã€‚</li></ol><p>è®©æˆ‘ä»¬æ ¹æ®è¿™ä¸ªæµç¨‹æ¥çœ‹çœ‹ hints çš„æ¯ä¸€æ­¥çš„åŸå› ï¼š</p><ol><li>æŠŠ <code>$U/_trace</code> åŠ å…¥åˆ° Makefile ä¸­æ˜¯ä¸ºäº†ç¼–è¯‘æ—¶è¯†åˆ«åˆ° <code>trace</code>ã€‚</li><li>åœ¨ <code>user.h</code> é‡ŒåŠ å…¥ <code>trace</code> æ˜¯ä¸ºäº†è®©ç”¨æˆ·çš„ <code>trace.c</code> è¯†åˆ«åˆ° <code>trace</code> è¿™ä¸ªå‡½æ•°ã€‚</li><li>åœ¨ <code>usys.pl</code> é‡ŒåŠ å…¥ <code>trace</code> æ˜¯ä¸ºäº†è®© <code>usys.pl</code> åœ¨ç”Ÿæˆçš„ <code>usys.S</code> é‡ŒåŠ å…¥ <code>trace</code> ç›¸å…³çš„å†…å®¹ï¼Œå®ƒæ˜¯æˆ‘ä»¬è¿›è¡Œç³»ç»Ÿè°ƒç”¨æ—¶çš„ç¬¬ä¸€ç«™ã€‚</li><li>åœ¨ <code>syscall.h</code> é‡ŒåŠ å…¥ <code>trace</code> æ˜¯å› ä¸ºæˆ‘ä»¬é€šè¿‡å¯„å­˜å™¨é‡Œå­˜å‚¨çš„æ•´æ•°ç¡®å®šè°ƒç”¨çš„ç³»ç»Ÿå‡½æ•°ï¼Œå¾ˆå¤šåœ°æ–¹éƒ½ä½¿ç”¨äº†è¿™ä¸ªæ–‡ä»¶é‡Œå®šä¹‰çš„å¸¸é‡ã€‚</li><li>åœ¨ <code>syscall.c</code> å’Œ <code>sysproc.c</code> é‡ŒåŠ å…¥çš„å‡½æ•°åˆ™æ˜¯å®é™…çš„é€»è¾‘éƒ¨åˆ†ï¼Œç”± syscall å‡½æ•°è°ƒç”¨ã€‚</li></ol><h1 id="Attack-xv6"><a href="#Attack-xv6" class="headerlink" title="Attack xv6"></a>Attack xv6</h1><p>åœ¨ xv6 çš„ syscall åˆ†æ”¯ä¸Šæœ‰ä¸€ä¸ªæ¼æ´â€”â€”è¿›ç¨‹è¢«å›æ”¶åï¼Œå®ƒæ›¾ç»ä½¿ç”¨çš„ç‰©ç†å†…å­˜ä¸ä¼šè¢«é‡ç½®ä¸ºåƒåœ¾æ•°æ®ï¼Œè€Œæ˜¯ä¿æŒä¹‹å‰çš„çŠ¶æ€ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ‰“ç ´å†…å­˜éš”ç¦»ï¼Œè®¿é—®åˆ«çš„å·²ç»è¢«å›æ”¶çš„è¿›ç¨‹çš„å†…å­˜ã€‚</p><p>æˆ‘ä»¬çœ‹å‘ <code>secret.c</code>ï¼Œä¼šå‘ç°å®ƒè¯·æ±‚äº† 32 ä¸ªç‰©ç†é¡µå¤§å°çš„ç‰©ç†å†…å­˜ï¼Œç„¶åæŠŠä¸€ä¸²å­—ç¬¦æ”¾åœ¨äº†æŸä¸ªç‰©ç†é¡µçš„å¼€å¤´ã€‚æ‰€ä»¥æˆ‘ä»¬åªè¦åœ¨ <code>attck.c</code> é‡Œä¹Ÿè¯·æ±‚ä¸€äº›ç‰©ç†é¡µï¼Œç„¶åæ‰¾åˆ°è¿™ä¸²å­—ç¬¦ä¸²å°±è¡Œã€‚</p><p>æˆ‘ä»¬å…ˆè¯·æ±‚ 32 ä¸ªç‰©ç†é¡µç„¶åä¾æ¬¡æ‰“å°å‡ºæ¯ä¸ªç‰©ç†é¡µå¼€å¤´çš„ä¸€ä¸²å­—ç¬¦ï¼Œç»“æœå¦‚ä¸‹ï¼š</p><pre class="line-numbers language-none"><code class="language-none">ç¬¬ 1 é¡µ: ï¿½ï¿½ç¬¬ 2 é¡µ: ï¿½              ç¬¬ 3 é¡µ:  ï¿½ç¬¬ 4 é¡µ: ï¿½ï¿½             ç¬¬ 5 é¡µ: ï¿½ç¬¬ 6 é¡µ: 0ï¿½             ç¬¬ 7 é¡µ:  ï¿½ç¬¬ 8 é¡µ: ï¿½              ç¬¬ 9 é¡µ: ï¿½ï¿½&#x2F;cea.aeç¬¬ 10 é¡µ: @ï¿½7ï¿½Gï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½fï¿½ï¿½ï¿½13ï¿½ï¿½fvâ¦3              ç¬¬ 11 é¡µ: Pï¿½#4ï¿½ï¿½&quot;ï¿½ï¿½ï¿½ï¿½ï¿½&#96;Bdaaï¿½ï¿½qï¿½&quot;ï¿½                                                                                 ï¿½ï¿½ç¬¬ 12 é¡µ: ï¿½ï¿½ï¿½ attackte              ç¬¬ 13 é¡µ: pï¿½ç¬¬ 14 é¡µ: &#96;ï¿½            ç¬¬ 15 é¡µ:  ï¿½ï¿½ï¿½ç¬¬ 16 é¡µ: ï¿½ï¿½7ï¿½Gï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½fï¿½ï¿½ï¿½13ï¿½ï¿½fvâ¦3              ç¬¬ 17 é¡µ: ï¿½ï¿½very very secret pw is: &#x2F;cea.aeç¬¬ 18 é¡µ: ï¿½ï¿½            ç¬¬ 19 é¡µ: pï¿½ç¬¬ 20 é¡µ: 0ï¿½            ç¬¬ 21 é¡µ: 0ï¿½ï¿½ç¬¬ 22 é¡µ: @ï¿½ï¿½           ç¬¬ 23 é¡µ: Pï¿½ï¿½ç¬¬ 24 é¡µ: ï¿½ï¿½            ç¬¬ 25 é¡µ: ï¿½ï¿½ï¿½ç¬¬ 26 é¡µ: Pï¿½            ç¬¬ 27 é¡µ: @ï¿½ç¬¬ 28 é¡µ: 0ï¿½            ç¬¬ 29 é¡µ: ï¿½ï¿½&amp;ï¿½Jï¿½ï¿½ï¿½ï¿½lEï¿½&#96;*&amp;ï¿½Jï¿½               ç¬¬ 31 é¡µ: ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½?ï¿½ï¿½ï¿½ç¬¬ 32 é¡µ: ï¿½ï¿½ï¿½          <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥æ³¨æ„åˆ°å¤§å¤šæ•°éƒ½æ˜¯ä¹±ç ï¼Œè¿™æ˜¯å› ä¸ºå†…å­˜é‡Œæœ‰éæ–‡æœ¬çš„äºŒè¿›åˆ¶æ•°æ®ï¼Œå®ƒä»¬ä¸èƒ½è¢«å½“ä½œæ–‡æœ¬è¾“å‡ºã€‚</p><p>å½“ç„¶ï¼Œæˆ‘ä»¬ä¼šæ³¨æ„åˆ°ç¬¬ 17 é¡µæœ‰ â€œvery very secret pw is: /cea.aeâ€ï¼Œå®ƒä¸ <code>secret.c</code> å†™å…¥çš„å†…å®¹å”¯ä¸€çš„åŒºåˆ«æ˜¯å°‘äº† â€œmy very â€ è¿™å…«ä¸ªå­—ç¬¦ã€‚ä¸ºä»€ä¹ˆä¼šæœ‰å…«ä¸ªå­—ç¬¦çš„å·®å¼‚å‘¢ï¼Ÿ</p><p>çœ‹å‘ <code>kallc.c</code> çš„ <code>kfree</code>ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">kfree</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>pa<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">run</span> <span class="token operator">*</span>r<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>pa <span class="token operator">%</span> PGSIZE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa <span class="token operator">&lt;</span> end <span class="token operator">||</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>pa <span class="token operator">>=</span> PHYSTOP<span class="token punctuation">)</span>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"kfree"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">LAB_SYSCALL</span></span>    <span class="token comment">// Fill with junk to catch dangling refs.</span>    <span class="token function">memset</span><span class="token punctuation">(</span>pa<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>    r <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">run</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa<span class="token punctuation">;</span>    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmem<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    r<span class="token operator">-></span>next <span class="token operator">=</span> kmem<span class="token punctuation">.</span>freelist<span class="token punctuation">;</span>    kmem<span class="token punctuation">.</span>freelist <span class="token operator">=</span> r<span class="token punctuation">;</span>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmem<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç»“åˆ <code>struct run</code> çš„å®šä¹‰ï¼Œå°±èƒ½çŸ¥é“ <code>r-&gt;next = kmem.freelist</code> è¿™å¥è¯­å¥æ˜¯æŠŠä¸€ä¸ªæŒ‡é’ˆæ”¾åœ¨äº†è¾“å…¥çš„ç‰©ç†åœ°å€çš„å‰å…«ä¸ª bytes ä¸­ã€‚è¿™æ­£æ˜¯ä¹‹å‰å…«ä¸ªå­—ç¬¦çš„å·®å¼‚çš„ç”±æ¥ã€‚</p><p>æ€»ç»“ä¸€ä¸‹ï¼Œåœ¨è¿è¡Œ <code>secret.c</code> çš„è¿›ç¨‹è¢«å›æ”¶åï¼Œå…¶ä¸­åŒ…å« â€œmy very very very secret pw is: /cea.aeâ€ çš„ç‰©ç†é¡µçš„å¼€å¤´å…«ä¸ª bytes è¢«æŒ‡é’ˆè¦†ç›–ï¼Œæ‰€ä»¥åªå‰©ä¸‹äº† â€œ[8 bytes æŒ‡é’ˆ]very very secret pw is: /cea.aeâ€. æ‰€ä»¥æˆ‘ä»¬å¤šè¯·æ±‚å‡ ä¸ªæ–°çš„ç‰©ç†é¡µç„¶åéå†å®ƒä»¬ï¼Œç”¨å‰ç¼€ â€œvery very secret pw is: â€ æ¥åŒ¹é…å°±è¡Œã€‚</p><p>æˆ‘ä»¬åœ¨æ–‡æœ«ä¼šæ›´å…·ä½“åœ°è®²è®²è¿›ç¨‹è¢«å›æ”¶çš„è¿‡ç¨‹ï¼Œä½†å…ˆè®©æˆ‘ä»¬æ¥çœ‹çœ‹ä»£ç ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">strncmp</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>str1<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>str2<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// kalloc.c çš„ kfree å‡½æ•°é‡ŒæŠŠç‰©ç†é¡µçš„å¼€å¤´æ¢æˆäº†ä¸€ä¸ªæŒ‡é’ˆ.</span><span class="token comment">// æ‰€ä»¥æˆ‘ä»¬ä¸¢å¤±äº†å¼€å¤´çš„ sizeof(æŒ‡é’ˆ) ä¸ªå­—ç¬¦.</span><span class="token keyword">const</span> <span class="token keyword">int</span> overwrite_len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>end<span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>prefix <span class="token operator">=</span> <span class="token string">"my very very very secret pw is: "</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> cmplen <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span> <span class="token operator">-</span> overwrite_len<span class="token punctuation">;</span>    <span class="token comment">// éå†æ–°æ’å…¥çš„32ä¸ªç‰©ç†é¡µ</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">32</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        end <span class="token operator">=</span> <span class="token function">sbrk</span><span class="token punctuation">(</span>PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span>end <span class="token operator">+</span> overwrite_len<span class="token punctuation">,</span> prefix <span class="token operator">+</span> overwrite_len<span class="token punctuation">,</span> cmplen<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> end <span class="token operator">+</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡ŒæŠŠå†…å®¹å†™è¿›æ–‡ä»¶æè¿°ç¬¦ 2 æ˜¯å› ä¸º <code>attacktest.c</code> é‡Œå¼€äº†ä¸€ä¸ªç®¡é“ï¼Œè¿è¡Œ <code>attack.c</code> çš„è¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦ 2 è¿æ¥ç€ç®¡é“å†™ç«¯ï¼Œè¿è¡Œ <code>attacktest.c</code> çš„è¿›ç¨‹åˆ™åœ¨è¯»å–ç®¡é“è¯»ç«¯ã€‚ä¸‹é¢çš„ä»£ç å°±æ˜¯æŠŠ <code>attack.c</code> çš„æ–‡ä»¶æè¿°ç¬¦ 2 è¿æ¥åˆ°ç®¡é“å†™ç«¯çš„ä»£ç ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">close</span><span class="token punctuation">(</span>fds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">dup</span><span class="token punctuation">(</span>fds<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>newargv<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"attack"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token function">exec</span><span class="token punctuation">(</span>newargv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> newargv<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"exec %s failed\n"</span><span class="token punctuation">,</span> newargv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="è¿›ç¨‹è¢«å›æ”¶çš„è¿‡ç¨‹"><a href="#è¿›ç¨‹è¢«å›æ”¶çš„è¿‡ç¨‹" class="headerlink" title="è¿›ç¨‹è¢«å›æ”¶çš„è¿‡ç¨‹"></a>è¿›ç¨‹è¢«å›æ”¶çš„è¿‡ç¨‹</h1><p>ä¸€ä¸ªè¿›ç¨‹è°ƒç”¨ exit(int) åä¼šè¿›å…¥ ZOMBIE çŠ¶æ€ï¼Œä½†å¹¶ä¸ç«‹å³é‡Šæ”¾ç‰©ç†å†…å­˜ï¼Œè€Œæ˜¯ä¼šå”¤é†’å…¶çˆ¶è¿›ç¨‹ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token keyword">int</span> status<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// æˆ‘ä»¬åœ¨è¿™é‡Œçœç•¥äº†å¾ˆå¤šä»£ç ï¼Œæœ‰å…´è¶£å¯ä»¥è‡ªå·±çœ‹ proc.c</span>    <span class="token function">wakeup</span><span class="token punctuation">(</span>p<span class="token operator">-></span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>    p<span class="token operator">-></span>state <span class="token operator">=</span> ZOMBIE<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>çˆ¶è¿›ç¨‹è°ƒç”¨ wait(uint64) ä¼šæ‰¾åˆ° ZOMBIE å­è¿›ç¨‹å¹¶è°ƒç”¨ <code>freeproc</code> æ¥å›æ”¶å®ƒï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">wait</span><span class="token punctuation">(</span>uint64 addr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// æˆ‘ä»¬åœ¨è¿™é‡Œçœç•¥äº†å¾ˆå¤šä»£ç ï¼Œæœ‰å…´è¶£å¯ä»¥è‡ªå·±çœ‹ proc.c</span>    <span class="token keyword">struct</span> <span class="token class-name">proc</span> <span class="token operator">*</span>pp<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">proc</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">myproc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>pp <span class="token operator">=</span> proc<span class="token punctuation">;</span> pp <span class="token operator">&lt;</span> <span class="token operator">&amp;</span>proc<span class="token punctuation">[</span>NPROC<span class="token punctuation">]</span><span class="token punctuation">;</span> pp<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>pp<span class="token operator">-></span>parent <span class="token operator">==</span> p <span class="token operator">&amp;&amp;</span> pp<span class="token operator">-></span>state <span class="token operator">==</span> ZOMBIE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// Found one.</span>                pid <span class="token operator">=</span> pp<span class="token operator">-></span>pid<span class="token punctuation">;</span>                <span class="token function">freeproc</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> pid<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// Wait for a child to exit.</span>        <span class="token function">sleep</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wait_lock<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// DOC: wait-sleep</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>freeproc åˆ™åˆè°ƒç”¨ <code>proc_freepagetable</code> æ¥å›æ”¶ç‰©ç†å†…å­˜ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// Free a process's page table, and free the</span><span class="token comment">// physical memory it refers to.</span><span class="token keyword">void</span> <span class="token function">proc_freepagetable</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">,</span> uint64 sz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">uvmunmap</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> TRAMPOLINE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">uvmunmap</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> TRAPFRAME<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">uvmfree</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> sz<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…¶ä¸­çš„ <code>uvmfree(pagetable, sz)</code> å°±åœ¨é‡Šæ”¾ç‰©ç†å†…å­˜äº†ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// Free user memory pages,</span><span class="token comment">// then free page-table pages.</span><span class="token keyword">void</span> <span class="token function">uvmfree</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">,</span> uint64 sz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>sz <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token function">uvmunmap</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">PGROUNDUP</span><span class="token punctuation">(</span>sz<span class="token punctuation">)</span> <span class="token operator">/</span> PGSIZE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">freewalk</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è®©æˆ‘ä»¬çœ‹å‘ <code>uvmunmap</code>ï¼Œå®ƒè·å–æ¯ä¸€é¡µçš„ç‰©ç†åœ°å€ç„¶åè°ƒç”¨ <code>kfree</code>ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// Remove npages of mappings starting from va. va must be</span><span class="token comment">// page-aligned. The mappings must exist.</span><span class="token comment">// Optionally free the physical memory.</span><span class="token keyword">void</span> <span class="token function">uvmunmap</span><span class="token punctuation">(</span><span class="token class-name">pagetable_t</span> pagetable<span class="token punctuation">,</span> uint64 va<span class="token punctuation">,</span> uint64 npages<span class="token punctuation">,</span> <span class="token keyword">int</span> do_free<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    uint64 a<span class="token punctuation">;</span>    <span class="token class-name">pte_t</span> <span class="token operator">*</span>pte<span class="token punctuation">;</span>    <span class="token keyword">int</span> sz<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>va <span class="token operator">%</span> PGSIZE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmunmap: not aligned"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>a <span class="token operator">=</span> va<span class="token punctuation">;</span> a <span class="token operator">&lt;</span> va <span class="token operator">+</span> npages <span class="token operator">*</span> PGSIZE<span class="token punctuation">;</span> a <span class="token operator">+=</span> sz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        sz <span class="token operator">=</span> PGSIZE<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pte <span class="token operator">=</span> <span class="token function">walk</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmunmap: walk"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_V<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"va=%ld pte=%ld\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmunmap: not mapped"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PTE_FLAGS</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span> <span class="token operator">==</span> PTE_V<span class="token punctuation">)</span>            <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"uvmunmap: not a leaf"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>do_free<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            uint64 pa <span class="token operator">=</span> <span class="token function">PTE2PA</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">kfree</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>pa<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token operator">*</span>pte <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ›´ç»†èŠ‚çš„é‡Šæ”¾ trapframeã€é‡Šæ”¾é¡µè¡¨æˆ‘ä»¬å°±ä¸åœ¨è¿™é‡Œå¤šè¯´äº†ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬å›é¡¾ä¸€ä¸‹æ€ä¹ˆå¯åŠ¨è°ƒè¯•æ¨¡å¼ï¼š&lt;/p&gt;
&lt;p&gt;åœ¨ä¸€ä¸ªç»ˆç«¯é‡Œæ‰§è¡Œ &lt;code&gt;make qemu-gdb&lt;/code&gt; ï¼Œ&lt;code&gt;make qemu-gdb CPUS=1&lt;/code&gt; å¯ä»¥åªä½¿ç”¨ä¸€ä¸ªæ ¸å¿ƒï¼Œæ¯”èµ·å¤šçº¿ç¨‹æ›´ä¾¿äºè°ƒè¯•ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨å¦ä¸€ä¸ªç»ˆç«¯é‡Œæ‰§</summary>
      
    
    
    
    <category term="å…¬å¼€è¯¾" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/"/>
    
    <category term="MIT-6.S081" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/MIT-6-S081/"/>
    
    <category term="Labs" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/MIT-6-S081/Labs/"/>
    
    
  </entry>
  
  <entry>
    <title>æ¢ç´¢æ—¥å¿—[1]</title>
    <link href="http://rinevard.github.io/wiki/others/thoughts/%E6%8E%A2%E7%B4%A2%E6%97%A5%E5%BF%971/"/>
    <id>http://rinevard.github.io/wiki/others/thoughts/%E6%8E%A2%E7%B4%A2%E6%97%A5%E5%BF%971/</id>
    <published>2025-10-13T12:11:11.000Z</published>
    <updated>2025-10-27T13:34:23.367Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸çŸ¥é“äººä»¬å¹³å¸¸æ˜¯æ€æ ·ä¸ä»–äººç›¸è¯†çš„ã€‚è®¸ä¹…ä»¥å‰æˆ‘å°±åœ¨æƒ³ï¼Œè‡ªå·±çš„ç¤¾äº¤æ–¹å¼æ˜¯å¦æœ‰ç‚¹ä¸å¤ªåƒä¸€èˆ¬äººç±»ğŸ« ğŸ« å’±æ›´åå¥½é‚£ç§â€œå¤§å®¶ä¸€èµ·åšä¸€ä»¶éƒ½æ„Ÿå…´è¶£çš„äº‹æƒ…ç„¶åæ¸æ¸å°±è®¤è¯†äº†â€çš„ç¤¾äº¤æ–¹å¼ï¼Œä½†ä¼¼ä¹è¿™ç§åšæ³•ç›¸å¯¹å°‘è§ï¼Œè€Œä¸”æˆ‘ä»¥å‰ä¹Ÿæ²¡æ€ä¹ˆå› æ­¤è®¤è¯†åˆ°æ–°æœ‹å‹ã€‚</p><p>åœ¨ä¸çŸ­çš„è´¨ç–‘æœŸåï¼Œæ¸æ¸åœ°ä¹Ÿå‘ç°è‡ªå·±ä¹Ÿæ˜¯èƒ½ç”¨è¿™ç§æ–¹æ³•äº¤åˆ°æœ‹å‹çš„ï¼Œè‡³å°‘æ˜¯èƒ½ç»“è¯†äººç±»çš„ã€‚æ¯”å¦‚è¯´è¿™æ¬¡çš„æ¢ç´¢æ—¥å¿—å°±å’Œ GMTK Jam åœ¨å°çº¢ä¹¦æ‹‰åˆ°çš„ç¾æœ¯åŒå­¦æœ‰å…³ï¼ˆèµç¾å°çº¢ä¹¦å–µ</p><p>â€œæˆ‘å¯¹æ™®é€šçš„äººç±»æ²¡æœ‰å…´è¶£ã€‚ä½ ä»¬ä¹‹ä¸­å¦‚æœæœ‰ç”»ç”»äººã€éŸ³ä¹äººã€éŸ³æ•ˆäººæˆ–è€…å¼‚ä¸–ç•Œäººå°±æ¥æ‰¾æˆ‘å§ï¼â€è™½ç„¶æˆ‘ä¸æ˜¯è¿™ä¹ˆæ‹‰äººçš„ï¼ˆæ²¡äººä¼šè¿™ä¹ˆæ‹‰äººå§ï¼ï¼‰ï¼Œä½†æ€»ä¹‹å°±æ˜¯æ‹‰åˆ°äº†è¿™ä½ä¸­ä¼ çš„ç¾æœ¯åŒå­¦ä¸€èµ·æ¥gamejamï¼Œè¿™æ˜¯å…«æœˆçš„äº‹äº†ã€‚</p><p>ä»Šå¤©é¹°è§’åœ¨ä¸­ä¼ å¼€äº†ä¸ªå®£è®²ä¼šï¼Œå’±ä½œä¸ºèµ„æ·±ç²¥ç²¥äººå½“ç„¶æƒ³å»å¬å¬çœ‹ã€‚è®¿å®¢è¿›ä¸­ä¼ éœ€è¦æ‰¾æ ¡å†…åŒå­¦æˆ–è€å¸ˆé¢„çº¦ï¼Œäºæ˜¯å’±å°±æ‰¾äº†è¿™ä½ç¾æœ¯åŒå­¦ç„¶åæˆåŠŸè¿›å…¥ä¸­ä¼ äº†ã€‚</p><p><img src="/images/others/random_thoughts/explore1/cuc_arknights.jpg" alt=""></p><p>ä¸€èˆ¬æ¥è¯´æ•…äº‹åº”è¯¥è·Œå®•èµ·ä¼ï¼Œæ¯”æ–¹è¯´æˆ‘ä»¬èµ·ç è¦å†™å†™åœ¨ä¸­ä¼ é‡åˆ°çš„è¶£äº‹ï¼Œç„¶åå†™å†™æœ‰ä»€ä¹ˆç³Ÿç³•çš„åœ°æ–¹ï¼Œç„¶åå†åä¸½æ”¶åœºï¼Œä¸è¿‡äº‹æƒ…å°±æ˜¯å¾ˆå¹³å¹³æ·¡æ·¡ã€‚é¹°è§’çš„å®£è®²ä¼šå¾ˆæ™®é€šï¼Œè™½ç„¶å‘äº†ç‚¹å‘¨è¾¹ä½†æˆ‘å¹¶æ²¡æœ‰æŠ½ä¸­æœ‰è¶£çš„å¥–å“ï¼Œä¸­ä¼ çš„é¥­æ¯”åŒ—ç†çš„å¥½åƒï¼Œä½†å¥½åƒå¾—ä¸å¤šã€‚</p><p><img src="/images/others/random_thoughts/explore1/cuc_food.jpg" alt=""></p><p>å¯æˆ‘ç¡®å®ä»æ¥æ²¡æœ‰å»å¤–æ ¡ç©çš„ç»å†ï¼Œæ›´åˆ«è¯´è¦æ‰¾å¤–æ ¡åŒå­¦é¢„çº¦æ‰èƒ½è¿›çš„å­¦æ ¡äº†ğŸ« ğŸ« å’±èƒ½ä»ç¤¾æè¿›åŒ–æˆç°åœ¨è¿™æ ·èƒ½ä¸»åŠ¨æ‹‰äººç»„é˜Ÿè¿˜èƒ½è”ç³»åˆ«äººå·²ç»å¾ˆå¥½äº†ä¸æ˜¯å—ï¼ˆï¼‰</p><p>æ¢ç´¢ä¹Ÿä¸æ˜¯æ¬¡æ¬¡æœ‰è¶£ï¼Œå€’ä¸å¦‚è¯´æ¢ç´¢çš„ç»“æœæ™®æ™®é€šé€šæ‰æ˜¯ç†æ‰€åº”å½“çš„å§ã€‚ç°åœ¨æ˜¯æ™šä¸Šåç‚¹äº”ååˆ†ï¼Œæˆ‘åœ¨è‰¯ä¹¡å¤§å­¦åŸåŒ—çš„åœ°é“ç«™æ²¡æœ‰æ‘†æ¸¡è½¦ï¼Œè¦éª‘è½¦å›å­¦æ ¡äº†ã€‚</p><p><img src="/images/others/random_thoughts/explore1/cuc_tree.jpg" alt=""></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;ä¸çŸ¥é“äººä»¬å¹³å¸¸æ˜¯æ€æ ·ä¸ä»–äººç›¸è¯†çš„ã€‚è®¸ä¹…ä»¥å‰æˆ‘å°±åœ¨æƒ³ï¼Œè‡ªå·±çš„ç¤¾äº¤æ–¹å¼æ˜¯å¦æœ‰ç‚¹ä¸å¤ªåƒä¸€èˆ¬äººç±»ğŸ« ğŸ« å’±æ›´åå¥½é‚£ç§â€œå¤§å®¶ä¸€èµ·åšä¸€ä»¶éƒ½æ„Ÿå…´è¶£çš„äº‹æƒ…ç„¶åæ¸æ¸å°±è®¤è¯†äº†â€çš„ç¤¾äº¤æ–¹å¼ï¼Œä½†ä¼¼ä¹è¿™ç§åšæ³•ç›¸å¯¹å°‘è§ï¼Œè€Œä¸”æˆ‘ä»¥å‰ä¹Ÿæ²¡æ€ä¹ˆå› æ­¤è®¤è¯†åˆ°æ–°æœ‹å‹ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨ä¸çŸ­çš„è´¨ç–‘æœŸåï¼Œæ¸æ¸åœ°ä¹Ÿå‘ç°</summary>
      
    
    
    
    <category term="æ‚è°ˆ" scheme="http://rinevard.github.io/categories/%E6%9D%82%E8%B0%88/"/>
    
    <category term="ç¢ç¢å¿µ" scheme="http://rinevard.github.io/categories/%E6%9D%82%E8%B0%88/%E7%A2%8E%E7%A2%8E%E5%BF%B5/"/>
    
    
  </entry>
  
  <entry>
    <title>Assignment 7 Path Tracing</title>
    <link href="http://rinevard.github.io/wiki/learning/open-course/GAMES101/Hw/Hw7-path-tracing/"/>
    <id>http://rinevard.github.io/wiki/learning/open-course/GAMES101/Hw/Hw7-path-tracing/</id>
    <published>2025-10-10T14:10:44.000Z</published>
    <updated>2025-10-10T15:04:14.905Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¤§è‡´æµç¨‹"><a href="#å¤§è‡´æµç¨‹" class="headerlink" title="å¤§è‡´æµç¨‹"></a>å¤§è‡´æµç¨‹</h1><p>è¿™æ¬¡çš„ä½œä¸šæŒºéš¾çš„ã€‚é¦–å…ˆæˆ‘ä»¬æ¥å¯¹ç…§å…¬å¼è§£é‡Šä¸€ä¸‹å¤§è‡´çš„ä»£ç æµç¨‹ï¼š</p><script type="math/tex; mode=display">\begin{align*}L_o(p, \vec{\omega_o}) = &L_e(p, \vec{\omega_o}) + \int_{\Omega} f_r(p, \vec{\omega_i}, \vec{\omega_o}) L_i(p, \vec{\omega_i}) (\vec{\omega_i} \cdot n) d\omega_i \\= &L_e(p, \vec{\omega_o}) + \int_{\Omega_{å…‰æºæ–¹å‘}} f_r(p, \vec{\omega_i}, \vec{\omega_o}) L_i(p, \vec{\omega_i}) (\vec{\omega_i} \cdot n) d\omega_i \\&+ \int_{\Omega_{éå…‰æºæ–¹å‘}} f_r(p, \vec{\omega_i}, \vec{\omega_o}) L_i(p, \vec{\omega_i}) (\vec{\omega_i} \cdot n) d\omega_i\end{align*}</script><ol><li>å¦‚æœç‚¹ $p$ æ˜¯å…‰æºï¼Œç›´æ¥è¿”å›å…¶è‡ªå‘å…‰é¡¹ $L_e$.</li><li>éšæœºé‡‡æ ·ä¸€ä¸ªå…‰æºæ–¹å‘ $w_s$ï¼Œæ ¹æ®å…¬å¼è®¡ç®— $L_\text{direct}$.</li><li><p>éšæœºé‡‡æ ·ä¸€ä¸ªæ–¹å‘ $w_i$ï¼ŒæŒ‰è½®ç›˜èµŒå†³å®šæ˜¯å¦ç»“æŸå¼¹å°„ã€‚</p><p> å¦‚æœä¸ç»“æŸä¸” $w_i$ æ²¡æ‰“åˆ°å…‰æºï¼Œæ ¹æ®å…¬å¼è®¡ç®— $L_\text{indirect}$.</p></li><li><p>è¿”å› $L_\text{direct}+L_\text{indirect}$</p></li></ol><p>ç„¶åæ”¾ä»£ç ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">Vector3f <span class="token class-name">Scene</span><span class="token double-colon punctuation">::</span><span class="token function">castRay</span><span class="token punctuation">(</span><span class="token keyword">const</span> Ray <span class="token operator">&amp;</span>ray<span class="token punctuation">,</span> <span class="token keyword">int</span> depth<span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">&#123;</span>    Intersection shade_point_inter <span class="token operator">=</span> <span class="token function">intersect</span><span class="token punctuation">(</span>ray<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shade_point_inter<span class="token punctuation">.</span>happened<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token function">Vector3f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// ----------------Contribution from emission----------------</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>shade_point_inter<span class="token punctuation">.</span>m<span class="token operator">-></span><span class="token function">hasEmission</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// Light source doesn't reflect light, so we return here</span>        <span class="token keyword">return</span> shade_point_inter<span class="token punctuation">.</span>m<span class="token operator">-></span><span class="token function">getEmission</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// ----------------Contribution from the light source----------------</span>    Vector3f wo <span class="token operator">=</span> <span class="token operator">-</span><span class="token function">normalize</span><span class="token punctuation">(</span>ray<span class="token punctuation">.</span>direction<span class="token punctuation">)</span><span class="token punctuation">;</span>    Vector3f normal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>shade_point_inter<span class="token punctuation">.</span>normal<span class="token punctuation">)</span><span class="token punctuation">;</span>    Vector3f l_direct <span class="token operator">=</span> <span class="token function">Vector3f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Intersection light_sample<span class="token punctuation">;</span>    <span class="token keyword">float</span> pdf_light<span class="token punctuation">;</span>    <span class="token function">sampleLight</span><span class="token punctuation">(</span>light_sample<span class="token punctuation">,</span> pdf_light<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// If the ray is not blocked in the middle, compute its contribution</span>    Vector3f light_normal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>light_sample<span class="token punctuation">.</span>normal<span class="token punctuation">)</span><span class="token punctuation">;</span>    Vector3f shade_point <span class="token operator">=</span> shade_point_inter<span class="token punctuation">.</span>coords<span class="token punctuation">;</span>    Vector3f ws <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>light_sample<span class="token punctuation">.</span>coords <span class="token operator">-</span> shade_point<span class="token punctuation">)</span><span class="token punctuation">;</span>    Vector3f direct_ray_origin <span class="token operator">=</span> shade_point <span class="token operator">+</span> ws <span class="token operator">*</span> EPSILON<span class="token punctuation">;</span>    Ray <span class="token function">ray_to_light</span><span class="token punctuation">(</span>direct_ray_origin<span class="token punctuation">,</span> ws<span class="token punctuation">)</span><span class="token punctuation">;</span>    Intersection inter_between_light <span class="token operator">=</span> <span class="token function">intersect</span><span class="token punctuation">(</span>ray_to_light<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>inter_between_light<span class="token punctuation">.</span>happened<span class="token punctuation">)</span> <span class="token operator">||</span> inter_between_light<span class="token punctuation">.</span>distance <span class="token operator">></span> <span class="token punctuation">(</span>light_sample<span class="token punctuation">.</span>coords <span class="token operator">-</span> direct_ray_origin<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">norm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> EPSILON<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        l_direct <span class="token operator">=</span> light_sample<span class="token punctuation">.</span>emit <span class="token operator">*</span> shade_point_inter<span class="token punctuation">.</span>m<span class="token operator">-></span><span class="token function">eval</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> wo<span class="token punctuation">,</span> normal<span class="token punctuation">)</span> \        <span class="token operator">*</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token function">dotProduct</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> normal<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">)</span> <span class="token operator">*</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token function">dotProduct</span><span class="token punctuation">(</span><span class="token operator">-</span>ws<span class="token punctuation">,</span> light_normal<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">)</span> \        <span class="token operator">/</span> std<span class="token double-colon punctuation">::</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token punctuation">(</span>light_sample<span class="token punctuation">.</span>coords <span class="token operator">-</span> direct_ray_origin<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">norm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> pdf_light<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// ----------------Contribution from other reflectors----------------</span>    Vector3f l_indirect <span class="token operator">=</span> <span class="token function">Vector3f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// Russian Roulette test</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">get_random_float</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> RussianRoulette<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        Vector3f wi <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>shade_point_inter<span class="token punctuation">.</span>m<span class="token operator">-></span><span class="token function">sample</span><span class="token punctuation">(</span>wo<span class="token punctuation">,</span> normal<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Vector3f indirect_ray_origin <span class="token operator">=</span> shade_point <span class="token operator">+</span> wi <span class="token operator">*</span> EPSILON<span class="token punctuation">;</span>        Ray <span class="token function">reflected_ray</span><span class="token punctuation">(</span>indirect_ray_origin<span class="token punctuation">,</span> wi<span class="token punctuation">)</span><span class="token punctuation">;</span>        Intersection reflected_inter <span class="token operator">=</span> <span class="token function">intersect</span><span class="token punctuation">(</span>reflected_ray<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// If reflected_ray hitting a non-emitting object, compute its contribution </span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>reflected_inter<span class="token punctuation">.</span>happened <span class="token operator">&amp;&amp;</span> reflected_inter<span class="token punctuation">.</span>m<span class="token operator">-></span><span class="token function">hasEmission</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            l_indirect <span class="token operator">=</span> <span class="token function">Vector3f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            l_indirect <span class="token operator">=</span> <span class="token function">castRay</span><span class="token punctuation">(</span>reflected_ray<span class="token punctuation">,</span> depth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> shade_point_inter<span class="token punctuation">.</span>m<span class="token operator">-></span><span class="token function">eval</span><span class="token punctuation">(</span>wi<span class="token punctuation">,</span> wo<span class="token punctuation">,</span> normal<span class="token punctuation">)</span> \            <span class="token operator">*</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token function">dotProduct</span><span class="token punctuation">(</span>wi<span class="token punctuation">,</span> normal<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">)</span> \            <span class="token operator">/</span> <span class="token punctuation">(</span>shade_point_inter<span class="token punctuation">.</span>m<span class="token operator">-></span><span class="token function">pdf</span><span class="token punctuation">(</span>wi<span class="token punctuation">,</span> wo<span class="token punctuation">,</span> normal<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> RussianRoulette<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> l_direct <span class="token operator">+</span> l_indirect<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å†æ¥çœ‹çœ‹å›¾</p><p><img src="/images/learning/open-course/GAMES101/Assignments/hw7/screenshot.png" alt=""></p><h1 id="ä»£ç ç»†èŠ‚"><a href="#ä»£ç ç»†èŠ‚" class="headerlink" title="ä»£ç ç»†èŠ‚"></a>ä»£ç ç»†èŠ‚</h1><p>æ¥ä¸‹æ¥æˆ‘ä»¬å†èŠèŠå…·ä½“çš„ä»£ç ç»†èŠ‚ã€‚è‡ªå‘å…‰é¡¹æ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬ç•¥è¿‡ã€‚</p><h2 id="L-text-direct"><a href="#L-text-direct" class="headerlink" title="$L_\text{direct}$"></a>$L_\text{direct}$</h2><p>ç›´æ¥å…‰éƒ¨åˆ†ã€‚é¦–å…ˆè¦æ³¨æ„çš„æ˜¯ï¼Œå„ä¸ªå°„çº¿ $w_i, w_o, w_s$ éƒ½æ˜¯ä»ç€è‰²ç‚¹æŒ‡å‘å¤–çš„å•ä½æ–¹å‘å‘é‡ã€‚è¿™æ˜¯ä¸€ä¸ªå›¾å½¢å­¦é‡Œå¸¸ç”¨çš„çº¦å®šï¼Œæ‰€ä»¥ä¸è¦é—®ä¸ºä»€ä¹ˆä¸æ˜¯æŒ‡å‘å†…äº†ï¼ˆï¼‰</p><p><img src="/images/learning/open-course/GAMES101/Assignments/hw7/wiwodir.png" alt=""></p><p>ç„¶ååœ¨å‘å‡ºå°„çº¿æ—¶ï¼Œæœ€å¥½åšä¸€ä¸ªå¾®å°çš„åç§»ä»¥é¿å…å‘å‡ºçš„å°„çº¿å’Œç€è‰²ç‚¹å¹³é¢ç›¸äº¤ã€‚è¿™å°±æ˜¯æˆ‘ä»¬ <code>direct_ray_origin = shade_point + ws * EPSILON</code> åšäº†åŠ æ³•çš„åŸå› ã€‚</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">Vector3f wo <span class="token operator">=</span> <span class="token operator">-</span><span class="token function">normalize</span><span class="token punctuation">(</span>ray<span class="token punctuation">.</span>direction<span class="token punctuation">)</span><span class="token punctuation">;</span>Vector3f normal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>shade_point_inter<span class="token punctuation">.</span>normal<span class="token punctuation">)</span><span class="token punctuation">;</span>Vector3f l_direct <span class="token operator">=</span> <span class="token function">Vector3f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Intersection light_sample<span class="token punctuation">;</span><span class="token keyword">float</span> pdf_light<span class="token punctuation">;</span><span class="token function">sampleLight</span><span class="token punctuation">(</span>light_sample<span class="token punctuation">,</span> pdf_light<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// If the ray is not blocked in the middle, compute its contribution</span>Vector3f light_normal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>light_sample<span class="token punctuation">.</span>normal<span class="token punctuation">)</span><span class="token punctuation">;</span>Vector3f shade_point <span class="token operator">=</span> shade_point_inter<span class="token punctuation">.</span>coords<span class="token punctuation">;</span>Vector3f ws <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>light_sample<span class="token punctuation">.</span>coords <span class="token operator">-</span> shade_point<span class="token punctuation">)</span><span class="token punctuation">;</span>Vector3f direct_ray_origin <span class="token operator">=</span> shade_point <span class="token operator">+</span> ws <span class="token operator">*</span> EPSILON<span class="token punctuation">;</span>Ray <span class="token function">ray_to_light</span><span class="token punctuation">(</span>direct_ray_origin<span class="token punctuation">,</span> ws<span class="token punctuation">)</span><span class="token punctuation">;</span>Intersection inter_between_light <span class="token operator">=</span> <span class="token function">intersect</span><span class="token punctuation">(</span>ray_to_light<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>inter_between_light<span class="token punctuation">.</span>happened<span class="token punctuation">)</span> <span class="token operator">||</span> inter_between_light<span class="token punctuation">.</span>distance <span class="token operator">></span> <span class="token punctuation">(</span>light_sample<span class="token punctuation">.</span>coords <span class="token operator">-</span> direct_ray_origin<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">norm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> EPSILON<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    l_direct <span class="token operator">=</span> light_sample<span class="token punctuation">.</span>emit <span class="token operator">*</span> shade_point_inter<span class="token punctuation">.</span>m<span class="token operator">-></span><span class="token function">eval</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> wo<span class="token punctuation">,</span> normal<span class="token punctuation">)</span> \    <span class="token operator">*</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token function">dotProduct</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> normal<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">)</span> <span class="token operator">*</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token function">dotProduct</span><span class="token punctuation">(</span><span class="token operator">-</span>ws<span class="token punctuation">,</span> light_normal<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">)</span> \    <span class="token operator">/</span> std<span class="token double-colon punctuation">::</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token punctuation">(</span>light_sample<span class="token punctuation">.</span>coords <span class="token operator">-</span> direct_ray_origin<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">norm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> pdf_light<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦å¤–ï¼Œæˆ‘ä»¬æœ‰ä»å…‰æºé‡‡æ ·è®¡ç®—ç›´æ¥å…‰çš„å…¬å¼ï¼š</p><script type="math/tex; mode=display">\begin{align*}&\int_{\Omega_{å…‰æºæ–¹å‘}} f_r(p, \vec{\omega_i}, \vec{\omega_o}) L_i(p, \vec{\omega_i}) (\vec{\omega_i} \cdot n) d\omega_i \\=&\int_{A} f_r(p, \vec{\omega_i}, \vec{\omega_o}) L_i(p, \vec{\omega_i}) \frac{\cos\theta\cos\theta_i}{\lVert p'-p \rVert^2} dA \end{align*}</script><p>ç”¨è’™ç‰¹å¡ç½—è¿‘ä¼¼å°±æ˜¯ä»£ç é‡Œå†™çš„ä¸œè¥¿äº†ã€‚</p><p><img src="/images/learning/open-course/GAMES101/Assignments/hw7/nee.png" alt=""></p><h2 id="L-text-indirect"><a href="#L-text-indirect" class="headerlink" title="$L_\text{indirect}$"></a>$L_\text{indirect}$</h2><p>é—´æ¥éƒ¨åˆ†ã€‚é¦–å…ˆè¦åšä¿„ç½—æ–¯è½®ç›˜èµŒï¼Œç„¶åè¦æ£€æŸ¥æ‰“åˆ°çš„æ˜¯å¦æ˜¯å…‰æºã€‚</p><p>å¦‚æœé€šè¿‡äº†è½®ç›˜èµŒï¼Œè€Œä¸”æ‰“åˆ°çš„ä¸æ˜¯å…‰æºï¼Œå°±è¦è®¡ç®—é—´æ¥å…‰ã€‚</p><p>ä¸ç›´æ¥å…‰ä¸€æ ·ï¼Œæˆ‘ä»¬è¦åšå¾®å°åç§»ï¼Œè¿™å°±æ˜¯ <code>indirect_ray_origin = shade_point + wi * EPSILON</code> .</p><p>ç„¶åå¥—å…¬å¼å°±è¡Œã€‚</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">Vector3f l_indirect <span class="token operator">=</span> <span class="token function">Vector3f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Russian Roulette test</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">get_random_float</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> RussianRoulette<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    Vector3f wi <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>shade_point_inter<span class="token punctuation">.</span>m<span class="token operator">-></span><span class="token function">sample</span><span class="token punctuation">(</span>wo<span class="token punctuation">,</span> normal<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Vector3f indirect_ray_origin <span class="token operator">=</span> shade_point <span class="token operator">+</span> wi <span class="token operator">*</span> EPSILON<span class="token punctuation">;</span>    Ray <span class="token function">reflected_ray</span><span class="token punctuation">(</span>indirect_ray_origin<span class="token punctuation">,</span> wi<span class="token punctuation">)</span><span class="token punctuation">;</span>    Intersection reflected_inter <span class="token operator">=</span> <span class="token function">intersect</span><span class="token punctuation">(</span>reflected_ray<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// If reflected_ray hitting a non-emitting object, compute its contribution </span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>reflected_inter<span class="token punctuation">.</span>happened <span class="token operator">&amp;&amp;</span> reflected_inter<span class="token punctuation">.</span>m<span class="token operator">-></span><span class="token function">hasEmission</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        l_indirect <span class="token operator">=</span> <span class="token function">Vector3f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        l_indirect <span class="token operator">=</span> <span class="token function">castRay</span><span class="token punctuation">(</span>reflected_ray<span class="token punctuation">,</span> depth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> shade_point_inter<span class="token punctuation">.</span>m<span class="token operator">-></span><span class="token function">eval</span><span class="token punctuation">(</span>wi<span class="token punctuation">,</span> wo<span class="token punctuation">,</span> normal<span class="token punctuation">)</span> \        <span class="token operator">*</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token function">dotProduct</span><span class="token punctuation">(</span>wi<span class="token punctuation">,</span> normal<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">)</span> \        <span class="token operator">/</span> <span class="token punctuation">(</span>shade_point_inter<span class="token punctuation">.</span>m<span class="token operator">-></span><span class="token function">pdf</span><span class="token punctuation">(</span>wi<span class="token punctuation">,</span> wo<span class="token punctuation">,</span> normal<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> RussianRoulette<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç»“æœå¯¹ EPSILON æŒºæ•æ„Ÿçš„ï¼Œå¯ä»¥æŠŠ EPSILON é€‚å½“è°ƒå¤§ç‚¹ï¼Œæˆ‘ç”¨çš„æ˜¯ <code>0.00020</code> .</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;å¤§è‡´æµç¨‹&quot;&gt;&lt;a href=&quot;#å¤§è‡´æµç¨‹&quot; class=&quot;headerlink&quot; title=&quot;å¤§è‡´æµç¨‹&quot;&gt;&lt;/a&gt;å¤§è‡´æµç¨‹&lt;/h1&gt;&lt;p&gt;è¿™æ¬¡çš„ä½œä¸šæŒºéš¾çš„ã€‚é¦–å…ˆæˆ‘ä»¬æ¥å¯¹ç…§å…¬å¼è§£é‡Šä¸€ä¸‹å¤§è‡´çš„ä»£ç æµç¨‹ï¼š&lt;/p&gt;
&lt;script type=&quot;math/tex; mod</summary>
      
    
    
    
    <category term="å…¬å¼€è¯¾" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/"/>
    
    <category term="GAMES101" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/GAMES101/"/>
    
    <category term="Assignments" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/GAMES101/Assignments/"/>
    
    
  </entry>
  
  <entry>
    <title>Note 6 BRDF and Rendering Eequation</title>
    <link href="http://rinevard.github.io/wiki/learning/open-course/GAMES101/Notes/Note6-BRDF-and-renderingequation/"/>
    <id>http://rinevard.github.io/wiki/learning/open-course/GAMES101/Notes/Note6-BRDF-and-renderingequation/</id>
    <published>2025-10-10T13:45:28.000Z</published>
    <updated>2025-10-10T14:49:51.245Z</updated>
    
    <content type="html"><![CDATA[<p>æˆ‘ä»¬ä¹‹å‰å·²ç»å­¦è¿‡äº† Blinn-Phong å…‰ç…§æ¨¡å‹ï¼Œä½†å®ƒåªæ˜¯ä¸€ä¸ªå¯å‘å¼æ¨¡å‹ï¼Œåœ¨ç‰©ç†ä¸Šæ˜¯ä¸æ­£ç¡®çš„ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ç‰©ç†ä¸Šæ­£ç¡®çš„å…‰ç…§æ˜¯æ€æ ·çš„ï¼Œä»¥åŠå¦‚ä½•ç”¨è®¡ç®—æœºè¿‘ä¼¼æ±‚è§£æ¥è¿‘æ­£ç¡®çš„å…‰ç…§ã€‚</p><h1 id="è¾å°„åº¦é‡å­¦"><a href="#è¾å°„åº¦é‡å­¦" class="headerlink" title="è¾å°„åº¦é‡å­¦"></a>è¾å°„åº¦é‡å­¦</h1><p>åœ¨äº†è§£å…‰ç…§çš„ç‰©ç†æ¨¡å‹ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ä¸€äº›ç‰©ç†é‡ã€‚æœ€å…³é”®çš„ç‰©ç†é‡æœ‰å››ä¸ªï¼Œåˆ†åˆ«æ˜¯</p><ol><li>Radiant flux/power $\Phi$ï¼Œå•ä½ $W$.</li><li>Radiant intensity $I$ï¼Œå•ä½ $\frac{W}{\text{sr}}$.</li><li>Irradiance $E$ï¼Œå•ä½ $\frac{W}{m^2}$.</li><li>Radiance $L$ï¼Œå•ä½ $\frac{W}{\text{sr}\cdot m^2}$.</li></ol><p>æ¥ä¸‹æ¥è®©æˆ‘ä»¬çœ‹çœ‹å®ƒä»¬çš„å…·ä½“å®šä¹‰ã€‚</p><h2 id="Radiant-flux-power-Phi"><a href="#Radiant-flux-power-Phi" class="headerlink" title="Radiant flux/power $\Phi$"></a>Radiant flux/power $\Phi$</h2><p>Radiant flux/power ç¬¦å· $\Phi$ï¼Œå•ä½ $W$.</p><p>å®šä¹‰ä¸º</p><script type="math/tex; mode=display">\Phi = \frac{dQ}{dt}</script><h2 id="Radiant-intensity-I"><a href="#Radiant-intensity-I" class="headerlink" title="Radiant intensity $I$"></a>Radiant intensity $I$</h2><p>Radiant Intensity ç¬¦å· $I$ï¼Œå•ä½ $\frac{W}{\text{sr}}$ï¼Œè¡¨ç¤ºæŸä¸ªå®šç‚¹æ¥æ”¶/ç©¿è¿‡/å‘å‡ºçš„ï¼Œåœ¨æŒ‡å®šæ–¹å‘ $\vec{\omega}$ ä¸Šçš„ï¼Œå•ä½ç«‹ä½“è§’çš„ Power.</p><p>å®šä¹‰ä¸º</p><script type="math/tex; mode=display">I(\vec{\omega})=\frac{d\Phi}{d\omega}</script><p>è¿™é‡Œçš„ç¬¦å·ç•¥æ˜¾æ··ä¹±ã€‚å·¦è¾¹çš„å‚æ•° $\vec{\omega}$ æ˜¯ä¸€ä¸ªæ–¹å‘å‘é‡ï¼Œå³è¾¹çš„ $d\omega$ åˆ™æ˜¯è¿™ä¸ªæ–¹å‘ä¸Šç«‹ä½“è§’çš„å¾®åˆ†ã€‚</p><p>æˆ‘ä»¬çŸ¥é“æ–¹å‘å‘é‡ $\vec{\omega}$ ä¹Ÿèƒ½åœ¨çƒåæ ‡ä¸‹è¢«è¡¨ç¤ºä¸º $(\theta,\varphi)$ã€‚å¯¹ç»™å®šçš„ $(\theta,\varphi)$ï¼Œæˆ‘ä»¬å¯ä»¥ç®—å‡ºå…¶åœ¨çƒé¢ä¸Šçš„é¢ç§¯å¾®åˆ†ï¼Œä¹Ÿèƒ½è¿›ä¸€æ­¥æ±‚å‡ºç«‹ä½“è§’å¾®åˆ† $d\omega$ï¼Œå¦‚ä¸‹æ‰€ç¤º</p><script type="math/tex; mode=display">\begin{align*}&dA=r^2 \sin \theta \space d\theta \space d\varphi\\&d\omega=\frac{dA}{r^2}=\sin \theta \space d\theta \space d\varphi\end{align*}</script><p>ä¸‹å›¾æ˜¯å¯¹  Solid angle å’Œ Radiant Intensity ä¸¤ä¸ªæ¦‚å¿µçš„å›¾è§£</p><p><img src="/images/learning/open-course/GAMES101/Notes/note6/solid_angle_and_intensity.png" alt=""></p><h2 id="Irradiance-E"><a href="#Irradiance-E" class="headerlink" title="Irradiance $E$"></a>Irradiance $E$</h2><p>Irradiance ç¬¦å· $E$ï¼Œå•ä½ $\frac{W}{m^2}$.</p><p>è¡¨ç¤ºç‚¹ $x$ å‘¨å›´å•ä½é¢ç§¯æ¥æ”¶/ç©¿è¿‡/å‘å‡ºçš„ Powerï¼Œå®šä¹‰ä¸º</p><script type="math/tex; mode=display">E(x)=\frac{d\Phi}{dA}</script><p>ä¸‹å›¾è®¡ç®—å¹¶å¯¹æ¯”äº†å¹³è¡Œå…‰ç©¿è¿‡ä¸¤ä¸ªä¸åŒæˆªé¢æ—¶çš„ irradianceï¼šå‚ç›´æˆªé¢ $A$ï¼Œä»¥åŠä¸å‚ç›´æ–¹å‘æˆ $\theta$ è§’çš„å€¾æ–œæˆªé¢ $Aâ€™$ã€‚</p><p>å…¶ä¸­ $\Phi=\Phiâ€™$ æ˜¯å› ä¸ºèƒ½é‡å®ˆæ’ï¼Œå…‰æŸç©¿è¿‡ä»»ä½•ä¸€ä¸ªå®Œæ•´æˆªé¢çš„åŠŸç‡æ˜¯å›ºå®šçš„ã€‚</p><p><img src="/images/learning/open-course/GAMES101/Notes/note6/irradiance.png" alt=""></p><h2 id="Radiance-L"><a href="#Radiance-L" class="headerlink" title="Radiance $L$"></a>Radiance $L$</h2><p>Radiance $L$ çš„å•ä½æ˜¯ $\frac{W}{\text{sr}\cdot \space m^2}$ï¼Œè¡¨ç¤ºè¡¨é¢æŸç‚¹ $x$ å‘¨å›´å•ä½æŠ•å½±é¢ç§¯æ¥æ”¶/ç©¿è¿‡/å‘å‡ºçš„ï¼Œåœ¨æŒ‡å®šæ–¹å‘ $\vec{w}$ ä¸Šçš„ï¼Œå•ä½ç«‹ä½“è§’çš„ radiant flux.</p><p>å®šä¹‰ä¸º</p><script type="math/tex; mode=display">L(x,\vec{\omega})=\frac{d^2\Phi}{d\omega ds}=\frac{d^2\Phi}{d\omega ds_{0}\cos\theta}</script><p>è¿™é‡Œçš„ $ds$ æ˜¯æŠ•å½±å‰é¢ç§¯ï¼Œ$ds_0 \cos\theta$ æ˜¯æŠ•å½±é¢ç§¯ã€‚</p><p>ä¸‹å›¾æ˜¯å¯¹ Irradiance å’Œ Radianceçš„å›¾è§£</p><p><img src="/images/learning/open-course/GAMES101/Notes/note6/irradiance_and_radiance.png" alt=""></p><h1 id="BRDFå’Œæè´¨"><a href="#BRDFå’Œæè´¨" class="headerlink" title="BRDFå’Œæè´¨"></a>BRDFå’Œæè´¨</h1><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥çœ‹çœ‹å…‰ç…§çš„ç‰©ç†æ¨¡å‹äº†ï¼Œå…¶ä¸­æœ€å…³é”®çš„æ˜¯ BRDFï¼Œå³åŒå‘åå°„åˆ†å¸ƒå‡½æ•°ã€‚å®ƒå®šä¹‰äº†ä»æ–¹å‘ $\vec{\omega_i}$ å°„å…¥çš„å…‰çº¿æ‰“åˆ°æŸä¸ªè¡¨é¢ä¸Šåå°„åˆ° $\vec{\omega_r}$ æ–¹å‘çš„å¼ºåº¦ï¼š</p><script type="math/tex; mode=display">f_r(p,\vec{\omega_i}, \vec{\omega_r}) = \frac{dL_r(p,\vec{\omega_r})}{dE_i(p,\vec{\omega_i})}</script><p>ä½ å¯èƒ½ä¼šç–‘æƒ‘ä¸ºä»€ä¹ˆä¹‹å‰æˆ‘ä»¬è¯´ $E$ æ˜¯å…³äº $x$ çš„å‡½æ•°ï¼Œç°åœ¨å´é™¤äº†åæ ‡ $p$ å¤–è¿˜å¤šäº†ä¸€ä¸ªæ–¹å‘å‚æ•° $\omega_i$ï¼Œè¿™æ˜¯å› ä¸º BRDF é‡Œçš„ $E$ æ˜¯å¾®åˆ†ã€‚å…·ä½“å¯ä»¥çœ‹çœ‹ä¸‹é¢è¿™ä¸ªå¼å­ï¼š</p><script type="math/tex; mode=display">E(x) = \int_{\Omega} L_i(x,\vec{\omega_i}) \cos\theta_i d\omega_i\\dE_i(x, \vec{\omega_i}) = L_i(x, \vec{\omega_i}) \cos\theta_i d\omega_i</script><p>ä½ å¯èƒ½è¿˜ä¼šç–‘æƒ‘ï¼Œä¸ºä»€ä¹ˆåˆ†æ¯ç”¨ $E$ å‘¢ï¼Ÿå’Œåˆ†æ¯ä¸€æ ·ç»Ÿä¸€ç”¨ $L$ ä¸æ˜¯æ›´ä¼˜é›…å—ï¼Ÿ</p><p>æ® <a href="https://www.zhihu.com/question/28476602/answer/41003204">https://www.zhihu.com/question/28476602/answer/41003204</a> è¿™ä¸ªç­”æ¡ˆæ‰€è¯´ï¼Œæµ‹é‡å‡ºå°„çš„ Radiance $L$ å¾ˆæ–¹ä¾¿ï¼Œä½†æµ‹é‡å…¥å°„çš„ Irradiance $L$ å¾ˆå›°éš¾ï¼Œè€Œæµ‹é‡å…¥å°„çš„ $dE$ æŒºæ–¹ä¾¿ï¼Œå› æ­¤æˆ‘ä»¬å°±ä½¿ç”¨äº† $\frac{dL}{dE}$.</p><p>æˆ‘ä»¬æŠŠä¸Šé¢çš„ $dE_i(x,\vec{\omega_i})$ ä»£å…¥ BRDFï¼Œå°±å¾—åˆ°äº†</p><script type="math/tex; mode=display">f_r(p,\vec{\omega_i}, \vec{\omega_r}) = \frac{dL_r(p,\vec{\omega_r})}{L_i(x,\vec{w_i})\cos\theta_i dw_i}</script><p>ç‰©ä½“çš„æè´¨å°±ç”¨ BSDFï¼ˆåå°„çš„BRDF+æŠ˜å°„çš„BTDFï¼‰è¡¨ç¤ºã€‚æˆ‘ä»¬è¿™é‡ŒåªèŠ BRDFï¼Œå› ä¸º BTDF å’Œ BRDF æ¥è¿‘ã€‚BRDF çš„è·å–åŒ…æ‹¬ä½†ä¸é™äºè¿™ä¸¤ç§æ–¹å¼ï¼š</p><ol><li>ç°å®æµ‹é‡ã€‚æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°è®¸å¤šåŒ…å«å¤§é‡ BRDF æµ‹é‡æ•°æ®çš„æ•°æ®é›†ï¼Œæ¯”å¦‚ MERL æ•°æ®é›†ã€‚</li><li>å¾®è¡¨é¢æ¨¡å‹ã€‚ç”¨ç²—ç³™åº¦ã€é‡‘å±åº¦ç­‰å‚æ•°æ¥æ„å»ºå¯å‘å¼çš„ BRDF å‡½æ•°ã€‚</li></ol><p>è¿˜å€¼å¾—ä¸€æçš„æ˜¯ï¼Œç”± Helmholtz Reciprocity Principleï¼Œæœ‰</p><script type="math/tex; mode=display">f_r(p,\vec{\omega_i}, \vec{\omega_o}) = f_r(p,\vec{\omega_o}, \vec{\omega_i})</script><p>ä¹Ÿå°±æ˜¯è¯´äº¤æ¢å…¥å°„å‡ºå°„æ–¹å‘ï¼ŒBRDF å‡½æ•° $f_r$ ä¸å˜ã€‚</p><h1 id="æ¸²æŸ“æ–¹ç¨‹"><a href="#æ¸²æŸ“æ–¹ç¨‹" class="headerlink" title="æ¸²æŸ“æ–¹ç¨‹"></a>æ¸²æŸ“æ–¹ç¨‹</h1><p>ç°åœ¨æˆ‘ä»¬å…ˆçœ‹çœ‹åå°„æ–¹ç¨‹ï¼Œå†çœ‹çœ‹æ¸²æŸ“æ–¹ç¨‹ã€‚</p><p>åå°„æ–¹ç¨‹æ˜¯é€šè¿‡ BRDF æ±‚å‡º $L_r$ çš„æ–¹ç¨‹ï¼Œå¯¹ BRDF çš„å…¬å¼ç§¯åˆ†ä¸€ä¸‹å°±è¡Œï¼š</p><script type="math/tex; mode=display">L_r(p, \vec{\omega_r}) = \int_{\Omega} f_r(p, \vec{\omega_i}, \vec{\omega_r}) L_i(p, \vec{\omega_i}) (\vec{\omega_i} \cdot \vec{n}) d\omega_i</script><p>å…¶ä¸­ $\vec{n}$ æ˜¯ç‚¹ $p$ å¤„çš„æ³•çº¿æ–¹å‘ï¼Œ$\vec{\omega_i} \cdot \vec{n}$ æ˜¯ BRDF å®šä¹‰é‡Œçš„ $\cos\theta_i$.</p><p>è€Œæ¸²æŸ“æ–¹ç¨‹ï¼Œä¸è€ƒè™‘æŠ˜å°„ï¼Œåªæ˜¯æ¯”åå°„æ–¹ç¨‹å¤šäº†ä¸€ä¸ªè‡ªå‘å…‰é¡¹ï¼š</p><script type="math/tex; mode=display">L_o(p, \vec{\omega_o}) = L_e(p, \vec{\omega_o}) + \int_{\Omega} f_r(p, \vec{\omega_i}, \vec{\omega_o}) L_i(p, \vec{\omega_i}) (\vec{\omega_i} \cdot n) d\omega_i</script><p>ä½ å¯èƒ½ä¼šå¥½å¥‡å³ä¾§çš„ $L_i(p,\vec{\omega_i}<br>)$ æ€ä¹ˆæ±‚å‡ºæ¥ã€‚ç”±èƒ½é‡å®ˆæ’ï¼Œæˆ‘ä»¬å¯ä»¥ä» $p$ å‡ºå‘é¡ºç€ $-\vec{\omega_i}$ æ‰¾åˆ°ç¬¬ä¸€ä¸ªäº¤ç‚¹ $q$ï¼Œç„¶åå°±æœ‰</p><script type="math/tex; mode=display">L_i(p,\vec{\omega_i})=L_o(q,-\vec{\omega_i})</script><h1 id="å®é™…ç®—æ³•"><a href="#å®é™…ç®—æ³•" class="headerlink" title="å®é™…ç®—æ³•"></a>å®é™…ç®—æ³•</h1><p>ç”±ä¸Šå¯çŸ¥ï¼Œæˆ‘ä»¬è¦æ±‚è§£ä¸‹é¢çš„æ–¹ç¨‹ï¼š</p><script type="math/tex; mode=display">L_o(p, \vec{\omega_o}) = L_e(p, \vec{\omega_o}) + \int_{\Omega} f_r(p, \vec{\omega_i}, \vec{\omega_o}) L_o(\text{raycast}(p, -\vec{\omega_i}), -\vec{\omega_i}) (\vec{\omega_i} \cdot n) d\vec{\omega_i}</script><p>è¿™æ˜¯ä¸€ä¸ªç§¯åˆ†ï¼Œè¿˜æ˜¯ä¸€ä¸ªé€’å½’ï¼Œæˆ‘ä»¬å…ˆç”¨è’™ç‰¹å¡ç½—ç®—æ³•è¿‘ä¼¼ç§¯åˆ†ï¼Œå¾—åˆ°</p><script type="math/tex; mode=display">L_o(p, \vec{\omega_o}) \approx L_e(p, \vec{\omega_o}) + \frac{1}{N}\sum_{k=1}^{N}\frac{f_r(p, \vec{\omega_i}^{(k)}, \vec{\omega_o}) L_o(\text{raycast}(p, -\vec{\omega_i}^{(k)}), -\vec{\omega_i}^{(k)}) (\vec{\omega_i} ^{(k)}\cdot n) }{p(\vec{\omega_i}^{(k)})}</script><p>å…¶ä¸­ $\vec{\omega_i}^{(k)}$ æ˜¯éšæœºé‡‡æ ·çš„æ–¹å‘å‘é‡ï¼Œ$p(\vec{\omega_i}^{(k)})$ æ˜¯é‡‡æ ·åˆ°å®ƒçš„æ¦‚ç‡ã€‚</p><p>æœ‰äº†è¿™ä¸ªæ±‚å’Œï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹é€’å½’äº†ï¼Œå¤§è‡´ç®—æ³•å¦‚ä¸‹ï¼š</p><ol><li>ä» $p$ å°„å‡ºæœéšæœºæ–¹å‘ $\vec{\omega_i}<br>^{(k)}$ çš„å°„çº¿ï¼Œæ‰“åˆ° $q^{(k)}$.</li><li>è®¡ç®— $L_o(q,-w_i^{(k)})$ï¼Œç„¶åä»£å…¥å¼å­ï¼Œæ±‚å¾— $L_o(p,\vec{\omega_o})$ã€‚</li></ol><p>ç­‰ç­‰ï¼Œè¿™ä¸æ˜¯æ— é™é€’å½’å—ï¼Ÿç¡®å®å¦‚æ­¤ã€‚æ‰€ä»¥æˆ‘ä»¬ä¼šå‡è®¾å¦‚æœå°„çº¿æ‰“åˆ°äº†å…‰æºå°±åªè¿”å›è‡ªå‘å…‰é¡¹ $L_e$.</p><p>ä½†è¿™ä¸è¿˜æ˜¯å¾ˆå¤æ‚å—ï¼Œå‡è®¾æˆ‘ä»¬å¯¹æ¯ä¸ªç‚¹å‘å°„ $10$ æ¡å°„çº¿ï¼Œå¼¹å°„ä»¥åå°±è¦å‘å°„ $10^2$ ä¸ªï¼Œå†å¼¹å°„å°±è¦ $10^3$ ä¸ªï¼</p><p>æ²¡é”™ï¼Œæ‰€ä»¥æˆ‘ä»¬åªå¯¹æ¯ä¸ªç‚¹å‘å‡º $1$ æ¡å°„çº¿å¹¶è®¡ç®—å…¶å¼¹å°„åçš„å®Œæ•´è·¯å¾„ï¼Œç„¶åå¯¹æ¯ä¸ªç‚¹è¿½è¸ªå¤šæ¡è·¯å¾„å¹¶å–å¹³å‡ã€‚è™½ç„¶è¿™ä¸å®Œå…¨ç¬¦åˆä¸Šé¢çš„å…¬å¼ï¼Œä½†å¾ˆæœ‰æ•ˆã€‚</p><p>è®©æˆ‘ä»¬æ¥çœ‹çœ‹æ–°çš„ç®—æ³•å§ï¼š</p><ol><li>å¦‚æœç‚¹ $p$ æ˜¯å…‰æºï¼Œç›´æ¥è¿”å›å…¶è‡ªå‘å…‰é¡¹ã€‚</li><li>éšæœºé‡‡æ ·ä¸€ä¸ªæ–¹å‘ $w_i$ï¼Œä» $p$ å‘å‡ºä¸€æ¡æœå‘ $w_i$ çš„å°„çº¿ï¼Œæ‰“åˆ°ç‚¹ $q$.</li><li>è®¡ç®—ç‚¹ $q$ çš„ $L_o(q,-w_i)$ï¼Œä»£å…¥å…¬å¼ï¼Œæ±‚å¾— $L_o(p,w_o)$.</li><li>å¯¹æ±‚å¾—çš„å¤šä¸ª $L_o(p,w_o)$ å–å¹³å‡ã€‚</li></ol><p>è¿™ä¸ªç®—æ³•å½“ç„¶å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–ï¼Œæ¯”å¦‚è¯´ä¸Šé¢è¿˜æ˜¯æœ‰æ½œåœ¨çš„æ— é™å¼¹å°„é£é™©ï¼Œæ‰€ä»¥è¦ç”¨ä¿„ç½—æ–¯è½®ç›˜èµŒæ¥åœ¨æ¯æ¬¡å¼¹å°„æ—¶éƒ½æœ‰éšæœºæ¦‚ç‡åœæ­¢å¼¹å°„ï¼ˆè¿™è¢«ç§°ä½œRRï¼‰ï¼›åˆæ¯”å¦‚ä¸Šé¢æ‰“åˆ°å…‰æºçš„æ¦‚ç‡å¤ªä½ï¼Œæ‰€ä»¥å¯ä»¥ä»å…‰æºé‡‡æ ·å°„çº¿ï¼ˆè¿™è¢«ç§°ä½œNEEï¼‰ã€‚ä¸è¿‡è¿™äº›ä¸œè¥¿å°±ç•™åˆ°ä½œä¸š 7 çš„è§£æé‡Œå†è¯´å§ã€‚</p><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p>Stanford CS348B, Spring 2022ï¼š<a href="https://gfxcourses.stanford.edu/cs348b/spring22">https://gfxcourses.stanford.edu/cs348b/spring22</a></p><p>å¤šä¼¦å¤šå¤§å­¦å›¾å½¢å­¦è®²ä¹‰ï¼š<a href="https://www.dgp.toronto.edu/public_user/elf/2522/light.pdf">https://www.dgp.toronto.edu/public_user/elf/2522/light.pdf</a></p><p>Introduction to Radiometry and Photometry</p><p>UE4 çš„ BRDF å®ç°ï¼š<a href="https://blog.selfshadow.com/publications/s2013-shading-course/karis/s2013_pbs_epic_notes_v2.pdf">https://blog.selfshadow.com/publications/s2013-shading-course/karis/s2013_pbs_epic_notes_v2.pdf</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;æˆ‘ä»¬ä¹‹å‰å·²ç»å­¦è¿‡äº† Blinn-Phong å…‰ç…§æ¨¡å‹ï¼Œä½†å®ƒåªæ˜¯ä¸€ä¸ªå¯å‘å¼æ¨¡å‹ï¼Œåœ¨ç‰©ç†ä¸Šæ˜¯ä¸æ­£ç¡®çš„ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ç‰©ç†ä¸Šæ­£ç¡®çš„å…‰ç…§æ˜¯æ€æ ·çš„ï¼Œä»¥åŠå¦‚ä½•ç”¨è®¡ç®—æœºè¿‘ä¼¼æ±‚è§£æ¥è¿‘æ­£ç¡®çš„å…‰ç…§ã€‚&lt;/p&gt;
&lt;h1 id=&quot;è¾å°„åº¦é‡å­¦&quot;&gt;&lt;a href=&quot;#è¾å°„åº¦é‡å­¦&quot; class=&quot;head</summary>
      
    
    
    
    <category term="å…¬å¼€è¯¾" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/"/>
    
    <category term="GAMES101" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/GAMES101/"/>
    
    <category term="Notes" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/GAMES101/Notes/"/>
    
    
  </entry>
  
  <entry>
    <title>æ¢ç´¢æ—¥å¿—[0]</title>
    <link href="http://rinevard.github.io/wiki/others/thoughts/%E6%8E%A2%E7%B4%A2%E6%97%A5%E5%BF%970/"/>
    <id>http://rinevard.github.io/wiki/others/thoughts/%E6%8E%A2%E7%B4%A2%E6%97%A5%E5%BF%970/</id>
    <published>2025-10-10T12:10:11.000Z</published>
    <updated>2025-10-27T13:33:04.965Z</updated>
    
    <content type="html"><![CDATA[<p>ç¬¬äºŒæ¬¡å‚åŠ äº† Ludum Dareï¼Œç¬¬äºŒæ¬¡å‚åŠ äº† Compo èµ›é“ã€‚Compo è¦æ±‚å•äººä»é›¶å¼€å§‹åœ¨ 48 å°æ—¶å†…åšå‡ºä¸€ä¸ªèƒ½ç©çš„ä¸œè¥¿ã€‚ä¸è§‰å¾—è¿™å¾ˆé…·å—ï¼Œä½œä¸ºä¸€ä¸ªç©å®¶æˆ‘è§‰å¾—è¿™å¤ªé…·äº†ï¼Œå¾ˆç¬¦åˆæˆ‘å¯¹æå®¢çš„æƒ³è±¡ã€‚</p><p>ä¸Šä¸€æ¬¡å‚åŠ  Compo ç»“è¯†äº†ä¸€ä½å¾ˆæœ‰è¶£çš„æœ‹å‹ï¼Œæ‰€ä»¥è¿™æ¬¡åˆå‚åŠ äº† Compo è€Œä¸æ˜¯ç»„é˜Ÿçš„ Jamã€‚ä¸è¿‡è¿™æ¬¡ä¼¼ä¹è‡³å°‘åˆ°ç°åœ¨ä¸ºæ­¢è¿˜æ²¡ç»“è¯†åˆ°å¾ˆæœ‰è¶£çš„æœ‹å‹ï¼ˆï¼‰</p><p>ä»ä¸Šå­¦æœŸå°±å¼€å§‹æƒ³ï¼Œå¤§å­¦çš„æ¯å¤©éƒ½å¤ªç›¸ä¼¼ï¼Œæ—¥å¤ä¸€æ—¥ã€‚å› æ­¤æƒ³æ¯å‘¨éƒ½åšä¸€äº›æ²¡åšè¿‡çš„äº‹æƒ…ã€‚è™½ç„¶æ²¡åšæŒå¾ˆä¹…ï¼Œä½†æˆ‘æƒ³è¿™ç¡®å®æ˜¯å€¼å¾—åšçš„ã€‚æ‰€ä»¥ä»ç°åœ¨å¼€å§‹ç®€å•å†™å†™æ¢ç´¢æ—¥å¿—å§ï¼Œæ—¶ä¸æ—¶æ¢ç´¢ä¸€ä¸‹ã€‚</p><p>è¿™æ¬¡é™¤äº†è‡ªå·±å‚åŠ ä¹‹å¤–ï¼Œè¿˜å’Œå¢¨é±¼æ¸¸ç ”ç¤¾çš„åŒå­¦ä»¬ä¸€èµ·ç»„ç»‡äº†ä¸€ä¸ªæ´»åŠ¨ï¼Œå’Œç¤¾å›¢çš„å¤§å®¶ä¸€èµ·å‚åŠ äº†è¿™åœº gamejamï¼Œå’±ä»¬ç¤¾å›¢æœ€åä¸€å…±åšäº†å››ä¸ªæ¸¸æˆã€‚æˆ‘åšäº† <a href="https://ldjam.com/events/ludum-dare/58/swarm-surge">SwarmSurge</a>.</p><p><img src="/images/others/random_thoughts/explore0/swarm_surge.jpg" alt="Swarm Surge"></p><p>æ€æ ·çš„ç”Ÿæ´»å€¼å¾—æˆ‘è¿‡ï¼Œæˆ‘è¯¥è¿‡æ€æ ·çš„ç”Ÿæ´»ï¼Ÿæˆ‘ç¡®å®è¿˜æ²¡æƒ³æ˜ç™½ã€‚Jam æ˜¯ç”Ÿæ´»é‡Œä¸ºæ•°ä¸å¤šçš„ä¸€æŠ¹å¥‡å¹»è‰²å½©ï¼ŒæƒŠè‰³åˆçŸ­æš‚ã€‚åœ¨æœ‰è¶£çš„æ•…äº‹ç»“æŸä¹‹åï¼Œæˆ‘ä»¬åˆè¯¥åšä»€ä¹ˆï¼Œåˆè¯¥å»å¾€ä½•æ–¹ï¼Ÿ</p><p>ä¹Ÿéš¾æ€ªä¼šå–œæ¬¢å‡‰å®«æ˜¥æ—¥ã€‚è™½ç„¶å¥¹æ€§æ ¼æ¶åŠ£æƒ³ä¸€å‡ºæ˜¯ä¸€å‡ºï¼Œä½†å¥¹æ˜¯è®©ä¸–ç•Œå˜å¾—æ›´çƒ­é—¹çš„å‡‰å®«æ˜¥æ—¥å›¢å›¢é•¿ï¼é˜¿è™šæ›¾é—®è‡ªå·±ï¼šâ€œå¯¹è¿™ç§è¶…ä¹å¸¸è¯†çš„å­¦å›­ç”Ÿæ´»ï¼Œä½ å°±ä¸è§‰å¾—å¿«ä¹å—ï¼Ÿâ€ä»–çš„å›ç­”æ˜¯ï¼šâ€œå½“ç„¶å¿«ä¹äº†ï¼Œåˆ«é—®æˆ‘è¿™ç§æ˜æ‘†ç€çš„äº‹æƒ…ã€‚â€</p><p>å¯¹è¿™äº›å¥‡å¹»è‰²å½©ï¼Œæˆ‘éš¾é“ä¸æ„Ÿè§‰å¿«ä¹å—ï¼Ÿå½“ç„¶å¿«ä¹äº†ã€‚æˆ‘ä¼šä¸€ç›´æ¢ç´¢ä¸‹å»ï¼Œå³ä½¿æ¯å¤©éƒ½æ˜¯æŸä¸ªé›¨æ—¥ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;ç¬¬äºŒæ¬¡å‚åŠ äº† Ludum Dareï¼Œç¬¬äºŒæ¬¡å‚åŠ äº† Compo èµ›é“ã€‚Compo è¦æ±‚å•äººä»é›¶å¼€å§‹åœ¨ 48 å°æ—¶å†…åšå‡ºä¸€ä¸ªèƒ½ç©çš„ä¸œè¥¿ã€‚ä¸è§‰å¾—è¿™å¾ˆé…·å—ï¼Œä½œä¸ºä¸€ä¸ªç©å®¶æˆ‘è§‰å¾—è¿™å¤ªé…·äº†ï¼Œå¾ˆç¬¦åˆæˆ‘å¯¹æå®¢çš„æƒ³è±¡ã€‚&lt;/p&gt;
&lt;p&gt;ä¸Šä¸€æ¬¡å‚åŠ  Compo ç»“è¯†äº†ä¸€ä½å¾ˆæœ‰è¶£çš„æœ‹å‹ï¼Œæ‰€ä»¥è¿™æ¬¡åˆå‚</summary>
      
    
    
    
    <category term="æ‚è°ˆ" scheme="http://rinevard.github.io/categories/%E6%9D%82%E8%B0%88/"/>
    
    <category term="ç¢ç¢å¿µ" scheme="http://rinevard.github.io/categories/%E6%9D%82%E8%B0%88/%E7%A2%8E%E7%A2%8E%E5%BF%B5/"/>
    
    
  </entry>
  
  <entry>
    <title>Note 5 RayTracing</title>
    <link href="http://rinevard.github.io/wiki/learning/open-course/GAMES101/Notes/Note5-RayTracing/"/>
    <id>http://rinevard.github.io/wiki/learning/open-course/GAMES101/Notes/Note5-RayTracing/</id>
    <published>2025-09-25T13:48:28.000Z</published>
    <updated>2025-09-25T13:51:26.850Z</updated>
    
    <content type="html"><![CDATA[<p>æ¸²æŸ“å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªå¤§ç±»ï¼šobject-order rendering å’Œ Image-order rendering. å‰è€…ä»¥åœºæ™¯ä¸­çš„ç‰©ä½“ï¼ˆé€šå¸¸æ˜¯å¦‚ä¸‰è§’å½¢ï¼‰ä¸ºåŸºæœ¬å•ä½è¿›è¡Œè¿­ä»£ï¼Œéå†åœºæ™¯ä¸­çš„æ¯ä¸€ä¸ªç‰©ä½“ï¼Œç„¶åç¡®å®šè¯¥ç‰©ä½“ä¼šå½±å“å±å¹•ä¸Šçš„å“ªäº›åƒç´ ï¼›åè€…ä»¥å±å¹•ä¸Šçš„åƒç´ ä¸ºåŸºæœ¬å•ä½è¿›è¡Œè¿­ä»£ï¼Œéå†è¾“å‡ºå›¾åƒä¸­çš„æ¯ä¸€ä¸ªåƒç´ ï¼Œç„¶åå¯¹äºæ¯ä¸ªåƒç´ ï¼Œå®ƒä¼šæ‰¾å‡ºåœºæ™¯ä¸­çš„å“ªä¸ªç‰©ä½“æˆ–ç‰©ä½“çš„å“ªä¸ªéƒ¨åˆ†å†³å®šäº†è¯¥åƒç´ çš„é¢œè‰²ã€‚</p><p>æˆ‘ä»¬ä¹‹å‰å­¦çš„å…‰æ …åŒ–æ˜¯å‰è€…ï¼Œè€Œæˆ‘ä»¬æ¥ä¸‹æ¥è¦ä»‹ç»çš„å…‰çº¿è¿½è¸ªå°±æ˜¯åè€…ã€‚</p><h1 id="å…‰çº¿è¿½è¸ª"><a href="#å…‰çº¿è¿½è¸ª" class="headerlink" title="å…‰çº¿è¿½è¸ª"></a>å…‰çº¿è¿½è¸ª</h1><h2 id="åŸºæœ¬æ€æƒ³"><a href="#åŸºæœ¬æ€æƒ³" class="headerlink" title="åŸºæœ¬æ€æƒ³"></a>åŸºæœ¬æ€æƒ³</h2><p>å…‰çº¿è¿½è¸ªçš„æ€æƒ³åŸºäºå…‰è·¯å¯é€†â€”â€”æ—¢ç„¶å…‰è·¯å¯é€†ï¼Œé‚£ä¹ˆæ‰“åˆ°æ‘„åƒæœºé‡Œçš„å…‰å°±å¯ä»¥çœ‹ä½œä»æ‘„åƒæœºå‘å‡ºçš„å°„çº¿ï¼Œæˆ‘ä»¬åªè¦æ‰“å‡ºå°„çº¿ç„¶åè®¡ç®—å°„çº¿æ‰“åˆ°çš„ç‚¹çš„é¢œè‰²å°±å¥½äº†ã€‚</p><p>å…¶å®åŸºæœ¬æ€è·¯çœŸçš„å°±æ˜¯è¿™ä¹ˆç®€å•ï¼å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬ä»çœ¼ç›é‡Œå‘å‡ºç»è¿‡æ¯ä¸ªåƒç´ çš„å°„çº¿ï¼Œç„¶åå°„çº¿æ‰“åˆ°ç‰©ä½“ä¸Šå°±å¾—åˆ°äº†ç‰©ä½“çš„åŸºæœ¬é¢œè‰²ã€‚è€Œå°„çº¿è¿˜ä¼šåå°„ã€æŠ˜å°„ï¼Œæˆ‘ä»¬è®¡ç®—åå°„ã€æŠ˜å°„åçš„å°„çº¿æ‰“åˆ°çš„é¢œè‰²ï¼Œå†åŠ åˆ°åŸºæœ¬é¢œè‰²ä¸Šï¼Œå°±å¾—åˆ°äº†è¿™ä¸ªåƒç´ çš„é¢œè‰²ã€‚</p><p><img src="/images/learning/open-course/GAMES101/Notes/note5/ray_tracing.png" alt=""></p><p>å…‰çº¿è¿½è¸ªä¹Ÿè‡ªç„¶åœ°ç”Ÿæˆäº†é˜´å½±â€”â€”å¦‚æœå°„çº¿æ‰“ä¸­çš„ç‚¹å’Œå…‰æºçš„è¿çº¿é—´æœ‰ç‰©ä½“é®æŒ¡ï¼Œè¿™ç‚¹å°±æ˜¯é˜´å½±ï¼Œå¦åˆ™å°±ä¸æ˜¯é˜´å½±ã€‚</p><h2 id="ç¢°æ’æ£€æµ‹"><a href="#ç¢°æ’æ£€æµ‹" class="headerlink" title="ç¢°æ’æ£€æµ‹"></a>ç¢°æ’æ£€æµ‹</h2><p>æ—¢ç„¶å¦‚æ­¤ï¼Œæˆ‘ä»¬åªè¦æ£€æµ‹å°„çº¿å’Œä¸‰è§’å½¢çš„ç¢°æ’å°±å¥½äº†ã€‚æˆ‘ä»¬å¯ä»¥ç”¨ä¸‹é¢çš„ MÃ¶ller Trumbore Algorithm æ¥åšæ£€æµ‹ï¼Œå…¶æ€è·¯æ˜¯è§£ â€œç›´çº¿ä¸Šçš„ç‚¹ = ä¸‰è§’å½¢é‡å¿ƒåæ ‡è¡¨ç¤ºâ€ è¿™ä¸ªæ–¹ç¨‹ï¼š</p><p>è€ƒè™‘å°„çº¿ $\vec{O} + t\vec{D}$ å’Œä¸‰è§’å½¢ $P_0, P_1, P_2$ï¼Œæˆ‘ä»¬è¦è§£æ–¹ç¨‹</p><script type="math/tex; mode=display">\vec{O} + t\vec{D} = (1-b_1-b_2)\vec{P_0} + b_1\vec{P_1} + b_2\vec{P_2}</script><p>è¿™æ˜¯ä¸€ä¸ªçº¿æ€§æ–¹ç¨‹ç»„ï¼Œè§£ä¸º</p><script type="math/tex; mode=display">\begin{bmatrix} t \\ b_1 \\ b_2 \end{bmatrix} = \frac{1}{\vec{S_1} \cdot \vec{E_1}} \begin{bmatrix} \vec{S_2} \cdot \vec{E_2} \\ \vec{S_1} \cdot \vec{S} \\ \vec{S_2} \cdot \vec{D} \end{bmatrix}</script><p>å…¶ä¸­</p><script type="math/tex; mode=display">\begin{aligned}\vec{E_1} &= \vec{P_1} - \vec{P_0} \\\vec{E_2} &= \vec{P_2} - \vec{P_0} \\\vec{S} &= \vec{O} - \vec{P_0} \\\vec{S_1} &= \vec{D} \times \vec{E_2} \\\vec{S_2} &= \vec{S} \times \vec{E_1}\end{aligned}</script><h1 id="æ€§èƒ½ä¼˜åŒ–"><a href="#æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–"></a>æ€§èƒ½ä¼˜åŒ–</h1><p>åœ¨åšå°„çº¿å’Œä¸‰è§’å½¢çš„ç¢°æ’æ£€æµ‹æ—¶ï¼Œç®€å•åœ°éå†åœºæ™¯é‡Œçš„æ¯ä¸ªä¸‰è§’å½¢æ˜¾ç„¶å¤ªæ…¢äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨åŒ…å›´ç›’æ¥ä¼˜åŒ–ã€‚å¦‚æœä¸€ä¸ªå°„çº¿æ²¡æœ‰ç¢°åˆ°åŒ…å›´ç›’ï¼Œè‡ªç„¶å°±ä¸ä¼šç¢°åˆ°ç›’å­é‡Œçš„ç‰©ä½“ï¼›å¦‚æœç¢°åˆ°äº†ï¼Œå†å’Œç›’å­é‡Œçš„ç‰©ä½“åšç¢°æ’æ£€æµ‹ã€‚</p><h2 id="å¸¸è§åŒ…å›´ç›’"><a href="#å¸¸è§åŒ…å›´ç›’" class="headerlink" title="å¸¸è§åŒ…å›´ç›’"></a>å¸¸è§åŒ…å›´ç›’</h2><p>åŒ…å›´ç›’æœ‰ä¸¤ç§æ€è·¯ï¼Œä¸€ç§æ˜¯åŸºäºç©ºé—´çš„åˆ’åˆ†ï¼Œå¦ä¸€ç§æ˜¯åŸºäºç‰©ä½“çš„åˆ’åˆ†ã€‚å‰è€…çš„ä»£è¡¨åŒ…æ‹¬å››å‰æ ‘ã€å…«å‰æ ‘ï¼›åè€…çš„ä»£è¡¨æ˜¯ BVH.</p><p>å››å‰æ ‘ã€å…«å‰æ ‘æŠŠç©ºé—´è¿›è¡Œå¹³åˆ†ï¼Œå½“ä¸€ä¸ªåŒºåŸŸé‡Œè¿˜å‰©è¾ƒå¤šç‰©ä½“æ—¶å°±å†åœ¨è¿™ä¸ªåŒºåŸŸé‡Œå¹³åˆ†ä¸€æ¬¡ã€‚</p><p><img src="/images/learning/open-course/GAMES101/Notes/note5/octree.png" alt=""></p><p>BVH ä¸ºæ¯ç»„ç‰©ä½“å»ºç«‹åŒ…å›´ç›’ï¼Œç„¶åå†æŠŠçˆ¶åŒ…å›´ç›’åˆ’åˆ†æˆå­åŒ…å›´ç›’ã€‚</p><p><img src="/images/learning/open-course/GAMES101/Notes/note5/bvh.png" alt=""></p><h2 id="å°„çº¿å’ŒåŒ…å›´ç›’çš„ç¢°æ’æ£€æµ‹"><a href="#å°„çº¿å’ŒåŒ…å›´ç›’çš„ç¢°æ’æ£€æµ‹" class="headerlink" title="å°„çº¿å’ŒåŒ…å›´ç›’çš„ç¢°æ’æ£€æµ‹"></a>å°„çº¿å’ŒåŒ…å›´ç›’çš„ç¢°æ’æ£€æµ‹</h2><p>åŒ…å›´ç›’æœ‰å…­ä¸ªé¢ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠç›¸å¯¹çš„é¢åˆ’åˆ†æˆä¸€ç»„ä»è€Œå¾—åˆ°ä¸‰ç»„é¢ã€‚è®¡ç®—å°„çº¿ $\vec{O} + t\vec{D}$ ä¸è¿™ä¸‰ç»„é¢çš„äº¤ç‚¹åï¼Œæˆ‘ä»¬ä¼šå¾—åˆ° $[t<em>{x, \text{enter}}, t</em>{x, \text{exit}}],[t<em>{y, \text{enter}}, t</em>{y, \text{exit}}],[t<em>{z, \text{enter}}, t</em>{z, \text{exit}}]$ï¼Œä¹‹åè®¡ç®—ä¸‹é¢çš„äº¤é›†ï¼š</p><script type="math/tex; mode=display">[t_\text{raymin},t_\text{raymax}]\cap[t_{x, \text{enter}}, t_{x, \text{exit}}]\cap[t_{y, \text{enter}}, t_{y, \text{exit}}]\cap[t_{z, \text{enter}}, t_{z, \text{exit}}]</script><p>å¦‚æœäº¤é›†ä¸ºç©ºåˆ™æ— äº¤ç‚¹ï¼Œå¦åˆ™æœ‰äº¤ç‚¹ã€‚</p><p>ä¸ºäº†æ–¹ä¾¿è®¡ç®—ï¼ŒåŒ…å›´ç›’ä¸€èˆ¬æ˜¯ä¸åæ ‡è½´å¹³è¡Œçš„ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;æ¸²æŸ“å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªå¤§ç±»ï¼šobject-order rendering å’Œ Image-order rendering. å‰è€…ä»¥åœºæ™¯ä¸­çš„ç‰©ä½“ï¼ˆé€šå¸¸æ˜¯å¦‚ä¸‰è§’å½¢ï¼‰ä¸ºåŸºæœ¬å•ä½è¿›è¡Œè¿­ä»£ï¼Œéå†åœºæ™¯ä¸­çš„æ¯ä¸€ä¸ªç‰©ä½“ï¼Œç„¶åç¡®å®šè¯¥ç‰©ä½“ä¼šå½±å“å±å¹•ä¸Šçš„å“ªäº›åƒç´ ï¼›åè€…ä»¥å±å¹•ä¸Šçš„åƒç´ ä¸ºåŸºæœ¬å•ä½è¿›è¡Œè¿­ä»£ï¼Œ</summary>
      
    
    
    
    <category term="å…¬å¼€è¯¾" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/"/>
    
    <category term="GAMES101" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/GAMES101/"/>
    
    <category term="Notes" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/GAMES101/Notes/"/>
    
    
  </entry>
  
  <entry>
    <title>Assignment 6 Bounding Box</title>
    <link href="http://rinevard.github.io/wiki/learning/open-course/GAMES101/Hw/Hw6-bounding-box/"/>
    <id>http://rinevard.github.io/wiki/learning/open-course/GAMES101/Hw/Hw6-bounding-box/</id>
    <published>2025-09-24T09:46:44.000Z</published>
    <updated>2025-09-24T12:56:28.461Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™æ¬¡çš„ä½œä¸šè¦æ±‚å®ç°ç”¨åŒ…å›´ç›’æ¥åŠ å¿«å…‰çº¿è¿½è¸ªï¼Œå†ç”¨ BVH ä¼˜åŒ–ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬è¦æŠŠ hw5 é‡Œçš„ä»£ç å¤åˆ¶è¿‡æ¥ï¼Œè®©æˆ‘ä¸è§£çš„æ˜¯ä»£ç é‡Œæ˜æ˜å·²ç»æä¾›äº† <code>rayTriangleIntersect</code> å‡½æ•°ï¼ŒPDF é‡Œå´è¿˜è¯´â€œå°†ä½ çš„å…‰çº¿-ä¸‰è§’å½¢ç›¸äº¤å‡½æ•°ç²˜è´´åˆ°æ­¤å¤„â€ï¼Œæ˜æ˜ç›´æ¥è°ƒç”¨å®ƒå°±å¥½äº†ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">inline</span> Intersection <span class="token class-name">Triangle</span><span class="token double-colon punctuation">::</span><span class="token function">getIntersection</span><span class="token punctuation">(</span>Ray ray<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    Intersection inter<span class="token punctuation">;</span>    <span class="token keyword">float</span> u<span class="token punctuation">,</span> v<span class="token punctuation">,</span> t<span class="token punctuation">;</span>    inter<span class="token punctuation">.</span>happened <span class="token operator">=</span> <span class="token function">rayTriangleIntersect</span><span class="token punctuation">(</span>v0<span class="token punctuation">,</span> v1<span class="token punctuation">,</span> v2<span class="token punctuation">,</span> ray<span class="token punctuation">.</span>origin<span class="token punctuation">,</span> ray<span class="token punctuation">.</span>direction<span class="token punctuation">,</span> t<span class="token punctuation">,</span> u<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>inter<span class="token punctuation">.</span>happened<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        inter<span class="token punctuation">.</span>coords <span class="token operator">=</span> ray<span class="token punctuation">.</span>origin <span class="token operator">+</span> t <span class="token operator">*</span> ray<span class="token punctuation">.</span>direction<span class="token punctuation">;</span>        inter<span class="token punctuation">.</span>normal <span class="token operator">=</span> normal<span class="token punctuation">;</span>        inter<span class="token punctuation">.</span>distance <span class="token operator">=</span> t<span class="token punctuation">;</span>        inter<span class="token punctuation">.</span>obj <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>        inter<span class="token punctuation">.</span>m <span class="token operator">=</span> m<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> inter<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶åæˆ‘ä¹Ÿä¸å¤ªå–œæ¬¢ä»£ç æ¡†æ¶å¯¹ <code>IntersectP</code> çš„å®šä¹‰ï¼Œåœ¨æˆ‘çœ‹æ¥æ—¢ç„¶å¦å¤–ä¸¤ä¸ªå‚æ•°èƒ½é€šè¿‡ <code>ray</code> ç®—å‡ºæ¥ï¼Œå°±å®Œå…¨æ²¡æœ‰ç†ç”±ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚</p><p>äºæ˜¯æˆ‘å°±æ”¹æˆäº†è¿™ä¸ªåªä¿ç•™ <code>ray</code> å‚æ•°çš„æ ·å­ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">inline</span> <span class="token keyword">bool</span> <span class="token class-name">Bounds3</span><span class="token double-colon punctuation">::</span><span class="token function">IntersectP</span><span class="token punctuation">(</span><span class="token keyword">const</span> Ray<span class="token operator">&amp;</span> ray<span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">&#123;</span>    <span class="token comment">// invDir: ray direction(x,y,z), invDir=(1.0/x,1.0/y,1.0/z), use this because Multiply is faster that Division</span>    <span class="token keyword">auto</span> tMinVec <span class="token operator">=</span> <span class="token punctuation">(</span>pMin <span class="token operator">-</span> ray<span class="token punctuation">.</span>origin<span class="token punctuation">)</span> <span class="token operator">*</span> ray<span class="token punctuation">.</span>direction_inv<span class="token punctuation">;</span>    <span class="token keyword">auto</span> tMaxVec <span class="token operator">=</span> <span class="token punctuation">(</span>pMax <span class="token operator">-</span> ray<span class="token punctuation">.</span>origin<span class="token punctuation">)</span> <span class="token operator">*</span> ray<span class="token punctuation">.</span>direction_inv<span class="token punctuation">;</span>    <span class="token keyword">float</span> tMinx <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span>tMinVec<span class="token punctuation">.</span>x<span class="token punctuation">,</span> tMaxVec<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>ray<span class="token punctuation">.</span>t_min<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">float</span> tMiny <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span>tMinVec<span class="token punctuation">.</span>y<span class="token punctuation">,</span> tMaxVec<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>ray<span class="token punctuation">.</span>t_min<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">float</span> tMinz <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span>tMinVec<span class="token punctuation">.</span>z<span class="token punctuation">,</span> tMaxVec<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>ray<span class="token punctuation">.</span>t_min<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">float</span> tMaxx <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span>tMinVec<span class="token punctuation">.</span>x<span class="token punctuation">,</span> tMaxVec<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>ray<span class="token punctuation">.</span>t_max<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">float</span> tMaxy <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span>tMinVec<span class="token punctuation">.</span>y<span class="token punctuation">,</span> tMaxVec<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>ray<span class="token punctuation">.</span>t_max<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">float</span> tMaxz <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span>tMinVec<span class="token punctuation">.</span>z<span class="token punctuation">,</span> tMaxVec<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>ray<span class="token punctuation">.</span>t_max<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">float</span> tMin <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>tMinx<span class="token punctuation">,</span> tMiny<span class="token punctuation">,</span> tMinz<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">float</span> tMax <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>tMaxx<span class="token punctuation">,</span> tMaxy<span class="token punctuation">,</span> tMaxz<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>tMin <span class="token operator">&lt;=</span> tMax<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ€è·¯å°±æ˜¯è®¡ç®—è¿™ä¸ªäº¤é›†ï¼š</p><script type="math/tex; mode=display">[t_\text{raymin},t_\text{raymax}]\cap[t_{x, \text{enter}}, t_{x, \text{exit}}]\cap[t_{y, \text{enter}}, t_{y, \text{exit}}]\cap[t_{z, \text{enter}}, t_{z, \text{exit}}]</script><p>å¯¹äºæœ€åçš„ <code>getIntersection</code>ï¼Œå° AI è¯´å¯ä»¥åœ¨å‘ç”Ÿç›¸äº¤æ—¶æ›´æ–° <code>ray</code> çš„ <code>t_max</code>ï¼Œç„¶ååœ¨å°„çº¿å’Œç›’å­çš„äº¤ç‚¹å¤§äº <code>t_max</code> æ—¶ä¸å†æ£€æµ‹ç›’å­å†…éƒ¨çš„ç›¸äº¤ï¼Œè¿™å¯ä»¥ä¼˜åŒ–æ€§èƒ½ã€‚æˆ‘è®¤ä¸ºä»–è¯´å¾—éå¸¸æœ‰é“ç†ï¼Œä½†æ”¹èµ·æ¥æœ‰ç‚¹éº»çƒ¦ï¼Œå°±ä¸æ”¹äº†ã€‚</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">Intersection <span class="token class-name">BVHAccel</span><span class="token double-colon punctuation">::</span><span class="token function">getIntersection</span><span class="token punctuation">(</span>BVHBuildNode<span class="token operator">*</span> node<span class="token punctuation">,</span> <span class="token keyword">const</span> Ray<span class="token operator">&amp;</span> ray<span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>node<span class="token operator">-></span>bounds<span class="token punctuation">.</span><span class="token function">IntersectP</span><span class="token punctuation">(</span>ray<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token function">Intersection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// leaf node checks ray's intersection with obj  </span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token operator">-></span>left <span class="token operator">==</span> <span class="token keyword">nullptr</span> <span class="token operator">&amp;&amp;</span> node<span class="token operator">-></span>right <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token operator">-></span>object <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token function">Intersection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> node<span class="token operator">-></span>object<span class="token operator">-></span><span class="token function">getIntersection</span><span class="token punctuation">(</span>ray<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>     <span class="token comment">// parent with only one child returns child's intersection</span>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token operator">-></span>left <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token function">getIntersection</span><span class="token punctuation">(</span>node<span class="token operator">-></span>right<span class="token punctuation">,</span> ray<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token operator">-></span>right <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token function">getIntersection</span><span class="token punctuation">(</span>node<span class="token operator">-></span>left<span class="token punctuation">,</span> ray<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>     <span class="token comment">// parent with two children returns the closer intersection</span>    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        Intersection inter1 <span class="token operator">=</span> <span class="token function">getIntersection</span><span class="token punctuation">(</span>node<span class="token operator">-></span>left<span class="token punctuation">,</span> ray<span class="token punctuation">)</span><span class="token punctuation">;</span>        Intersection inter2 <span class="token operator">=</span> <span class="token function">getIntersection</span><span class="token punctuation">(</span>node<span class="token operator">-></span>right<span class="token punctuation">,</span> ray<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inter1<span class="token punctuation">.</span>happened <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>inter2<span class="token punctuation">.</span>happened<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token function">Intersection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inter1<span class="token punctuation">.</span>happened<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> inter2<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inter2<span class="token punctuation">.</span>happened<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> inter1<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span>inter1<span class="token punctuation">.</span>distance <span class="token operator">&lt;</span> inter2<span class="token punctuation">.</span>distance<span class="token punctuation">)</span> <span class="token operator">?</span> inter1 <span class="token operator">:</span> inter2<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å’±è¿˜æ˜¯åœ¨æœ€åæ”¾æ”¾å›¾å›¾</p><p><img src="/images/learning/open-course/GAMES101/Assignments/hw6/bvh.png" alt=""></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;è¿™æ¬¡çš„ä½œä¸šè¦æ±‚å®ç°ç”¨åŒ…å›´ç›’æ¥åŠ å¿«å…‰çº¿è¿½è¸ªï¼Œå†ç”¨ BVH ä¼˜åŒ–ã€‚&lt;/p&gt;
&lt;p&gt;é¦–å…ˆæˆ‘ä»¬è¦æŠŠ hw5 é‡Œçš„ä»£ç å¤åˆ¶è¿‡æ¥ï¼Œè®©æˆ‘ä¸è§£çš„æ˜¯ä»£ç é‡Œæ˜æ˜å·²ç»æä¾›äº† &lt;code&gt;rayTriangleIntersect&lt;/code&gt; å‡½æ•°ï¼ŒPDF é‡Œå´è¿˜è¯´â€œå°†ä½ çš„å…‰çº¿-ä¸‰è§’å½¢ç›¸äº¤å‡½æ•°ç²˜è´´</summary>
      
    
    
    
    <category term="å…¬å¼€è¯¾" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/"/>
    
    <category term="GAMES101" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/GAMES101/"/>
    
    <category term="Assignments" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/GAMES101/Assignments/"/>
    
    
  </entry>
  
  <entry>
    <title>Assignment 5 Raytracing</title>
    <link href="http://rinevard.github.io/wiki/learning/open-course/GAMES101/Hw/Hw5-raytracing/"/>
    <id>http://rinevard.github.io/wiki/learning/open-course/GAMES101/Hw/Hw5-raytracing/</id>
    <published>2025-09-22T11:46:16.000Z</published>
    <updated>2025-09-26T04:09:50.574Z</updated>
    
    <content type="html"><![CDATA[<p>å¦‚æœåªæ˜¯å®ç°è¦æ±‚çš„è¯ï¼Œæ„Ÿè§‰è¿™ä¼šæ˜¯å¾ˆæ— èŠçš„ä¸€æ¬¡ä½œä¸šã€‚ä¸ºäº†è®©äº‹æƒ…æœ‰è¶£ä¸€ç‚¹ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ <code>castRay</code> å‡½æ•°çš„å®ç°å§ã€‚æˆ‘ä»¬ä¼šæŠŠä½œä¸šä»£ç æ”¾åœ¨æ–‡æœ«ã€‚</p><h1 id="castRay-å‡½æ•°çš„åˆ†æ"><a href="#castRay-å‡½æ•°çš„åˆ†æ" class="headerlink" title="castRay å‡½æ•°çš„åˆ†æ"></a>castRay å‡½æ•°çš„åˆ†æ</h1><p>castRay å‡½æ•°å®ç°äº†è¯¾ä¸Šè®²çš„å…‰çº¿è¿½è¸ªï¼Œå®ƒä» <code>orig</code> æ‰“å‡ºæœç€ <code>dir</code> æ–¹å‘çš„å°„çº¿ï¼Œå¹¶è¿”å›é¢œè‰²ã€‚å…¶å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š</p><ol><li><p>é¦–å…ˆï¼Œæ£€æŸ¥å½“å‰çš„é€’å½’æ·±åº¦<code>depth</code>ã€‚å½“<code>depth</code>è¶…è¿‡åœºæ™¯è®¾å®šçš„æœ€å¤§æ·±åº¦<code>scene.maxDepth</code>æ—¶ï¼Œå‡½æ•°è¿”å›é»‘è‰²ã€‚è¿™å°±æ˜¯å¼€å¤´çš„ä»£ç ï¼š</p> <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span>depth <span class="token operator">></span> scene<span class="token punctuation">.</span>maxDepth<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">Vector3f</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>ç„¶åï¼Œè®¡ç®—å°„çº¿æ˜¯å¦ä¸åœºæ™¯ä¸­çš„ä»»ä½•ç‰©ä½“ç›¸äº¤ã€‚å¦‚æœæ²¡æœ‰å‘ç”Ÿç›¸äº¤ï¼Œè¯´æ˜å°„çº¿å°„å‘äº†åœºæ™¯çš„èƒŒæ™¯ï¼Œå‡½æ•°å°†è¿”å›èƒŒæ™¯é¢œè‰²ã€‚</p></li><li><p>å¦‚æœå°„çº¿å‡»ä¸­äº†æŸä¸ªç‰©ä½“ï¼Œå‡½æ•°å°†æ ¹æ®è¯¥ç‰©ä½“çš„æè´¨ç±»å‹ï¼Œè¿›å…¥ä¸åŒçš„å¤„ç†åˆ†æ”¯è®¡ç®—é¢œè‰²ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ä¼šåˆ†æè¿™äº›åˆ†æ”¯ã€‚</p></li></ol><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç‰©ä½“è¢«åˆ†ä¸ºäº†ä¸‰ç§æè´¨ï¼Œåˆ†åˆ«æ˜¯æ—¢æœ‰é•œé¢åå°„åˆæœ‰æŠ˜å°„çš„ <code>REFLECTION_AND_REFRACTION</code>ã€åªæœ‰åå°„çš„ <code>REFLECTION</code>ã€åªæœ‰æ¼«åå°„çš„ <code>DIFFUSE_AND_GLOSSY</code>ã€‚<code>REFLECTION_AND_REFRACTION</code> å’Œ <code>REFLECTION</code> éƒ¨åˆ†çš„ä»£ç æ¯”è¾ƒç›¸ä¼¼ï¼Œæˆ‘ä»¬å°±å…ˆè®¨è®º <code>REFLECTION_AND_REFRACTION</code> çš„ä»£ç ï¼Œå†è®¨è®º <code>DIFFUSE_AND_GLOSSY</code> çš„ä»£ç ã€‚</p><h2 id="REFLECTION-AND-REFRACTION"><a href="#REFLECTION-AND-REFRACTION" class="headerlink" title="REFLECTION_AND_REFRACTION"></a>REFLECTION_AND_REFRACTION</h2><p>è¿™é‡Œçš„åå°„/æŠ˜å°„æè´¨è‡ªèº«æ˜¯æ²¡æœ‰é¢œè‰²çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒä»¬åªæ˜¾ç¤ºåå°„/æŠ˜å°„åå°„çº¿æ‰“åˆ°çš„ç‚¹çš„é¢œè‰²ã€‚æ‰€ä»¥ä»£ç æ€è·¯æ¯”è¾ƒç®€å•ï¼Œå¦‚æœå°„çº¿æ‰“åˆ°äº†è¿™ç§æè´¨çš„ç‰©ä½“ä¸Šï¼Œå®ƒä¼šåå°„/æŠ˜å°„ï¼Œæˆ‘ä»¬éœ€è¦è®¡ç®—å‡ºåå°„/æŠ˜å°„åçš„å°„çº¿æ‰“åˆ°çš„é¢œè‰²ï¼Œè¿™å°±å¯¹åº”ç€ä¸‹é¢çš„ä»£ç ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">Vector3f reflectionColor <span class="token operator">=</span> <span class="token function">castRay</span><span class="token punctuation">(</span>reflectionRayOrig<span class="token punctuation">,</span> reflectionDirection<span class="token punctuation">,</span> scene<span class="token punctuation">,</span> depth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Vector3f refractionColor <span class="token operator">=</span> <span class="token function">castRay</span><span class="token punctuation">(</span>refractionRayOrig<span class="token punctuation">,</span> refractionDirection<span class="token punctuation">,</span> scene<span class="token punctuation">,</span> depth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>ä»£ç é‡Œè¿˜è€ƒè™‘äº†è²æ¶…å°”æ•ˆåº”æ¥è®¡ç®—åå°„å’ŒæŠ˜å°„çš„æ¯”ä¾‹ã€‚è²æ¶…å°”æ•ˆåº”çš„å…¬å¼æœ‰ç‚¹å¤æ‚ï¼Œæˆ‘ä»¬å°±ä¸è®²è§£äº†ã€‚è¿™é‡Œçš„ <code>kr</code> å°±æ˜¯è²æ¶…å°”æ–¹ç¨‹ç®—å‡ºçš„åå°„ç³»æ•°ï¼Œè€Œç”±èƒ½é‡å®ˆæ’ï¼ŒæŠ˜å°„ç³»æ•°å°±æ˜¯ $1-\text{kr}$ã€‚</p><p><code>hitColor</code> å°±æ˜¯è¿™ä¸ªç‚¹çš„æœ€ç»ˆé¢œè‰²ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">float</span> kr <span class="token operator">=</span> <span class="token function">fresnel</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> N<span class="token punctuation">,</span> payload<span class="token operator">-></span>hit_obj<span class="token operator">-></span>ior<span class="token punctuation">)</span><span class="token punctuation">;</span>hitColor <span class="token operator">=</span> reflectionColor <span class="token operator">*</span> kr <span class="token operator">+</span> refractionColor <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> kr<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>æˆ‘ä»¬ä¹Ÿä¼šæ³¨æ„åˆ°ï¼Œä»£ç åœ¨å¼€å¤´å¯¹åå°„/æŠ˜å°„ç‚¹åšäº†ä¸€ä¸ªå°å°çš„åç§»ï¼Œè¿™ä¼¼ä¹æ˜¯ä¸ºäº†é¿å…åå°„/æŠ˜å°„æ—¶ç«‹å³æ‰“åˆ°è‡ªå·±ï¼ˆå’±ä¹Ÿä¸ç¡®å®šï¼Œè¿™æ˜¯çŒœæµ‹ï¼‰</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">Vector3f reflectionRayOrig <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">dotProduct</span><span class="token punctuation">(</span>reflectionDirection<span class="token punctuation">,</span> N<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span>                              hitPoint <span class="token operator">-</span> N <span class="token operator">*</span> scene<span class="token punctuation">.</span>epsilon <span class="token operator">:</span>                              hitPoint <span class="token operator">+</span> N <span class="token operator">*</span> scene<span class="token punctuation">.</span>epsilon<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä»¬éƒ½çœ‹åˆ°è²æ¶…å°”æ•ˆåº”çš„ä»£ç äº†ï¼Œä¸å¦‚å†çœ‹çœ‹çº¯åå°„/çº¯æŠ˜å°„çš„çƒæ˜¯æ€æ ·çš„ã€‚æ³¨æ„é è¿‘æˆ‘ä»¬è§‚å¯Ÿè€…çš„çƒï¼Œæˆ‘ä»¬å¯ä»¥å…ˆæŠŠ <code>kr</code> è®¾ä¸º 1 æ¥çœ‹çœ‹çº¯åå°„çš„ç»“æœï¼š</p><p><img src="/images/learning/open-course/GAMES101/Assignments/hw5/reflection_only.png" alt=""></p><p>å†æ¥çœ‹çœ‹çº¯æŠ˜å°„çš„ç»“æœï¼š</p><p><img src="/images/learning/open-course/GAMES101/Assignments/hw5/refraction_only.png" alt=""></p><p>ä¸æ–‡æœ«çš„å›¾æ¯”è¾ƒä¸€ä¸‹ï¼Œå°±ä¼šå‘ç°è²æ¶…å°”æ•ˆåº”ç¡®å®å°±æ˜¯åå°„å’ŒæŠ˜å°„çš„å åŠ ã€‚</p><h2 id="DIFFUSE-AND-GLOSSY"><a href="#DIFFUSE-AND-GLOSSY" class="headerlink" title="DIFFUSE_AND_GLOSSY"></a>DIFFUSE_AND_GLOSSY</h2><p>å†æ¥çœ‹çœ‹ <code>DIFFUSE_AND_GLOSSY</code> éƒ¨åˆ†ï¼Œè¿™é‡Œæ˜¯æ­£å¸¸çš„ Phong æ¨¡å‹ç€è‰²ã€‚å”¯ä¸€è¦æ³¨æ„çš„æ˜¯ï¼Œè¦åˆ¤æ–­å°„çº¿æ‰“åˆ°çš„ç‚¹å’Œå…‰æºä¹‹é—´æœ‰æ²¡æœ‰ç‰©ä½“é®æŒ¡ï¼Œå¦‚æœæœ‰é®æŒ¡è¿™é‡Œå°±æ˜¯é˜´å½±ã€‚</p><p>æˆ‘è®¤ä¸ºè¿™ä¸€éƒ¨åˆ†çš„ä»£ç æœ‰é—®é¢˜ï¼Œå®ƒåªè€ƒè™‘äº†æ¼«åå°„åˆ†é‡åœ¨ä¸åœ¨é˜´å½±é‡Œï¼Œè€Œæ²¡è€ƒè™‘é•œé¢åå°„åˆ†é‡ã€‚è¿™é‡Œæ˜¯åŸæœ¬çš„ä»£ç ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// æ¼«åå°„</span>lightAmt <span class="token operator">+=</span> inShadow <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> light<span class="token operator">-></span>intensity <span class="token operator">*</span> LdotN<span class="token punctuation">;</span><span class="token comment">// é•œé¢åå°„</span>Vector3f reflectionDirection <span class="token operator">=</span> <span class="token function">reflect</span><span class="token punctuation">(</span><span class="token operator">-</span>lightDir<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">;</span>specularColor <span class="token operator">+=</span> <span class="token function">powf</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0.f</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">dotProduct</span><span class="token punctuation">(</span>reflectionDirection<span class="token punctuation">,</span> dir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    payload<span class="token operator">-></span>hit_obj<span class="token operator">-></span>specularExponent<span class="token punctuation">)</span> <span class="token operator">*</span> light<span class="token operator">-></span>intensity<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘æƒ³æˆ‘ä»¬åº”è¯¥åšè¿™æ ·çš„ä¿®æ”¹ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inShadow<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// æ¼«åå°„</span>    lightAmt <span class="token operator">+=</span> light<span class="token operator">-></span>intensity <span class="token operator">*</span> LdotN<span class="token punctuation">;</span>        <span class="token comment">// é•œé¢åå°„</span>    Vector3f reflectionDirection <span class="token operator">=</span> <span class="token function">reflect</span><span class="token punctuation">(</span><span class="token operator">-</span>lightDir<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">;</span>    specularColor <span class="token operator">+=</span> <span class="token function">powf</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0.f</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">dotProduct</span><span class="token punctuation">(</span>reflectionDirection<span class="token punctuation">,</span> dir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        payload<span class="token operator">-></span>hit_obj<span class="token operator">-></span>specularExponent<span class="token punctuation">)</span> <span class="token operator">*</span> light<span class="token operator">-></span>intensity<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="ä½œä¸šä»£ç "><a href="#ä½œä¸šä»£ç " class="headerlink" title="ä½œä¸šä»£ç "></a>ä½œä¸šä»£ç </h1><p>æ¥ä¸‹æ¥å’±å°±ç›´æ¥æ”¾ä½œä¸šä»£ç äº†ã€‚</p><p>é¦–å…ˆæ˜¯ <code>rayTriangleIntersect</code>ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">bool</span> <span class="token function">rayTriangleIntersect</span><span class="token punctuation">(</span><span class="token keyword">const</span> Vector3f<span class="token operator">&amp;</span> v0<span class="token punctuation">,</span> <span class="token keyword">const</span> Vector3f<span class="token operator">&amp;</span> v1<span class="token punctuation">,</span> <span class="token keyword">const</span> Vector3f<span class="token operator">&amp;</span> v2<span class="token punctuation">,</span> <span class="token keyword">const</span> Vector3f<span class="token operator">&amp;</span> orig<span class="token punctuation">,</span>                          <span class="token keyword">const</span> Vector3f<span class="token operator">&amp;</span> dir<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">&amp;</span> tNear<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">&amp;</span> u<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">&amp;</span> v<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">auto</span> e1 <span class="token operator">=</span> v1 <span class="token operator">-</span> v0<span class="token punctuation">;</span>    <span class="token keyword">auto</span> e2 <span class="token operator">=</span> v2 <span class="token operator">-</span> v0<span class="token punctuation">;</span>    <span class="token keyword">auto</span> s <span class="token operator">=</span> orig <span class="token operator">-</span> v0<span class="token punctuation">;</span>    <span class="token keyword">auto</span> s1 <span class="token operator">=</span> <span class="token function">crossProduct</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> e2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">auto</span> s2 <span class="token operator">=</span> <span class="token function">crossProduct</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> e1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">auto</span> coefficient <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token function">dotProduct</span><span class="token punctuation">(</span>s1<span class="token punctuation">,</span> e1<span class="token punctuation">)</span><span class="token punctuation">;</span>    tNear <span class="token operator">=</span> coefficient <span class="token operator">*</span> <span class="token function">dotProduct</span><span class="token punctuation">(</span>s2<span class="token punctuation">,</span> e2<span class="token punctuation">)</span><span class="token punctuation">;</span>    u <span class="token operator">=</span> coefficient <span class="token operator">*</span> <span class="token function">dotProduct</span><span class="token punctuation">(</span>s1<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>    v <span class="token operator">=</span> coefficient <span class="token operator">*</span> <span class="token function">dotProduct</span><span class="token punctuation">(</span>s2<span class="token punctuation">,</span> dir<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>tNear <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>u <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>v <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> u <span class="token operator">-</span> v<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶åæ˜¯ <code>Render</code> çš„éƒ¨åˆ†ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> scene<span class="token punctuation">.</span>width<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// generate primary ray direction</span>    <span class="token keyword">float</span> x<span class="token punctuation">;</span>    <span class="token keyword">float</span> y<span class="token punctuation">;</span>    <span class="token comment">// I don't understand what are the guiding comments talking about.</span>    <span class="token comment">// Anyway, the code is assuming the distance between eye and screen is one, since abs(dir.z) == 1</span>    <span class="token comment">// With this assumption we can compute screen's width and height</span>    <span class="token comment">// Then we map x from [0, scene.width - 1] to [-screen_width / 2, screenwidth / 2]</span>    <span class="token comment">// and map y from [0, scene.height - 1] to [screen_height / 2, -screen_height / 2]</span>    <span class="token keyword">float</span> screen_height <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> scale<span class="token punctuation">;</span>    <span class="token keyword">float</span> screen_width <span class="token operator">=</span> imageAspectRatio <span class="token operator">*</span> screen_height<span class="token punctuation">;</span>        x <span class="token operator">=</span> <span class="token punctuation">(</span>screen_width <span class="token operator">/</span> <span class="token punctuation">(</span>scene<span class="token punctuation">.</span>width <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>screen_width <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    y <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">-</span>screen_height <span class="token operator">/</span> <span class="token punctuation">(</span>scene<span class="token punctuation">.</span>height <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>screen_height <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Vector3f dir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">Vector3f</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Don't forget to normalize this direction!</span>    framebuffer<span class="token punctuation">[</span>m<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">castRay</span><span class="token punctuation">(</span>eye_pos<span class="token punctuation">,</span> dir<span class="token punctuation">,</span> scene<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>çœ‹çœ‹ç»“æœå§ï¼å¦‚æœå’Œå‰é¢çš„çº¯åå°„/çº¯æŠ˜å°„å¯¹ç…§ï¼Œä¼šå‘ç°å‰é¢çš„çƒç¡®å®å°±æ˜¯åå°„å’ŒæŠ˜å°„çš„å åŠ ï¼ˆåå°„å¾ˆæ·¡ï¼Œä¸è¿‡ä»”ç»†çœ‹ä¹Ÿæ˜¯èƒ½çœ‹å‡ºæ¥çš„ï¼ï¼‰</p><p><img src="/images/learning/open-course/GAMES101/Assignments/hw5/binary.png" alt=""></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;å¦‚æœåªæ˜¯å®ç°è¦æ±‚çš„è¯ï¼Œæ„Ÿè§‰è¿™ä¼šæ˜¯å¾ˆæ— èŠçš„ä¸€æ¬¡ä½œä¸šã€‚ä¸ºäº†è®©äº‹æƒ…æœ‰è¶£ä¸€ç‚¹ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ &lt;code&gt;castRay&lt;/code&gt; å‡½æ•°çš„å®ç°å§ã€‚æˆ‘ä»¬ä¼šæŠŠä½œä¸šä»£ç æ”¾åœ¨æ–‡æœ«ã€‚&lt;/p&gt;
&lt;h1 id=&quot;castRay-å‡½æ•°çš„åˆ†æ&quot;&gt;&lt;a href=&quot;#castRay-å‡½æ•°çš„åˆ†æ&quot; cl</summary>
      
    
    
    
    <category term="å…¬å¼€è¯¾" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/"/>
    
    <category term="GAMES101" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/GAMES101/"/>
    
    <category term="Assignments" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/GAMES101/Assignments/"/>
    
    
  </entry>
  
  <entry>
    <title>Assignment 4 Geometry</title>
    <link href="http://rinevard.github.io/wiki/learning/open-course/GAMES101/Hw/Hw4-geometry/"/>
    <id>http://rinevard.github.io/wiki/learning/open-course/GAMES101/Hw/Hw4-geometry/</id>
    <published>2025-09-22T11:44:16.000Z</published>
    <updated>2025-09-22T11:44:41.718Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™æ¬¡ä½œä¸šè¿‡äºç®€å•ï¼Œæˆ‘ä»¬ç›´æ¥æ”¾ä»£ç ã€‚</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">cv<span class="token double-colon punctuation">::</span>Point2f <span class="token function">recursive_bezier</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>Point2f<span class="token operator">></span> <span class="token operator">&amp;</span>control_points<span class="token punctuation">,</span> <span class="token keyword">float</span> t<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// TODO: Implement de Casteljau's algorithm</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>control_points<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> t<span class="token punctuation">)</span> <span class="token operator">*</span> control_points<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> t <span class="token operator">*</span> control_points<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>Point2f<span class="token operator">></span> new_control_points <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> control_points<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        new_control_points<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> t<span class="token punctuation">)</span> <span class="token operator">*</span> control_points<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> t <span class="token operator">*</span> control_points<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token function">recursive_bezier</span><span class="token punctuation">(</span>new_control_points<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">bezier</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>Point2f<span class="token operator">></span> <span class="token operator">&amp;</span>control_points<span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span>Mat <span class="token operator">&amp;</span>window<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// TODO: Iterate through all t = 0 to t = 1 with small steps, and call de Casteljau's </span>    <span class="token comment">// recursive Bezier algorithm.</span>    <span class="token keyword">float</span> step <span class="token operator">=</span> <span class="token number">0.001</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">float</span> t <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> t <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span> t <span class="token operator">+=</span> step <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">auto</span> point <span class="token operator">=</span> <span class="token function">recursive_bezier</span><span class="token punctuation">(</span>control_points<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>        window<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">at</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>Vec3b<span class="token operator">></span></span></span><span class="token punctuation">(</span>point<span class="token punctuation">.</span>y<span class="token punctuation">,</span> point<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">255</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦å¤–ï¼Œç”±äºå’±ä»¥å‰åœ¨ Godot é‡Œå¯¼å…¥å­—ä½“æ—¶è§è¿‡å¤šé€šé“ç¬¦å·è·ç¦»åœºçš„è®¾ç½®ï¼Œè€Œä¸”å‘ç°å¼€å¯å¤šé€šé“ç¬¦å·è·ç¦»åœºçš„å­—ä½“æ˜¾ç¤ºæ¸…æ™°äº†ä¸€å¤§æˆªï¼Œæ‰€ä»¥æˆ‘æ‰¾äº†æ‰¾ä¸€äº›å…³äº SDF çš„èµ„æ–™ï¼Œæ„Ÿè§‰è¿™ä¸ªä¸é”™ï¼š<a href="https://www.xianlongok.site/post/4625ed6a/#SDF-font">åŠ¨æ€ SDF å­—ä½“æ¸²æŸ“æ–¹æ³• | åä¸‰</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;è¿™æ¬¡ä½œä¸šè¿‡äºç®€å•ï¼Œæˆ‘ä»¬ç›´æ¥æ”¾ä»£ç ã€‚&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-cpp&quot; data-language=&quot;cpp&quot;&gt;&lt;code class=&quot;language-cpp&quot;&gt;cv&lt;span class=&quot;token double-c</summary>
      
    
    
    
    <category term="å…¬å¼€è¯¾" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/"/>
    
    <category term="GAMES101" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/GAMES101/"/>
    
    <category term="Assignments" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/GAMES101/Assignments/"/>
    
    
  </entry>
  
  <entry>
    <title>Note 4 Geometry</title>
    <link href="http://rinevard.github.io/wiki/learning/open-course/GAMES101/Notes/Note4-Geometry/"/>
    <id>http://rinevard.github.io/wiki/learning/open-course/GAMES101/Notes/Note4-Geometry/</id>
    <published>2025-09-19T12:10:28.000Z</published>
    <updated>2025-09-19T12:13:54.595Z</updated>
    
    <content type="html"><![CDATA[<p>è¯¾ä¸Šåªæ˜¯ç®€å•æäº†ä¸‹å‡ ä½•ä¸“é¢˜ï¼Œæˆ‘ä¹Ÿè®¤ä¸ºè¿™ä¸ªä¸“é¢˜ç›¸è¾ƒäºåˆ«çš„å‡ ä¸ªæ²¡é‚£ä¹ˆé‡è¦ï¼Œæ‰€ä»¥åªæ˜¯è®°ä¸€ä¸‹éšå¼è¡¨ç¤ºå’Œå‚æ•°è¡¨ç¤ºçš„ç›¸å…³å†…å®¹ï¼Œå†ç®€å•æä¸€å¥ç½‘æ ¼å¤„ç†ã€‚</p><h1 id="éšå¼è¡¨ç¤ºå’Œå‚æ•°è¡¨ç¤º"><a href="#éšå¼è¡¨ç¤ºå’Œå‚æ•°è¡¨ç¤º" class="headerlink" title="éšå¼è¡¨ç¤ºå’Œå‚æ•°è¡¨ç¤º"></a>éšå¼è¡¨ç¤ºå’Œå‚æ•°è¡¨ç¤º</h1><p>å¯¹ä¸€ä¸ªå‡ ä½•å›¾å½¢ï¼Œæˆ‘ä»¬ä¸€èˆ¬æœ‰ä¸¤ç§è¡¨ç¤ºæ–¹æ³•ï¼Œä¸€ç§æ˜¯ç”¨æ™®é€šæ–¹ç¨‹ $f(x,y,z)=0$ æ¥è¡¨ç¤ºï¼Œå¦ä¸€ç§æ˜¯ç”¨å‚æ•°æ–¹ç¨‹ $g(u,v)=(x,y,z)$ æ¥è¡¨ç¤ºã€‚å‰è€…æ˜¯éšå¼è¡¨ç¤ºï¼Œå› ä¸ºä¸èƒ½æ–¹ä¾¿åœ°æ±‚å‡ºè¿™ä¸ªæ–¹ç¨‹è¡¨ç¤ºçš„æ‰€æœ‰ç‚¹ï¼›åè€…æ˜¯å‚æ•°è¡¨ç¤ºï¼Œé€šè¿‡å‚æ•° $(u,v)$ çš„å˜åŒ–å¯ä»¥è½»æ˜“æ±‚å‡ºè¿™ä¸ªæ–¹ç¨‹è¡¨ç¤ºçš„æ‰€æœ‰ç‚¹ã€‚</p><p>ä¸è¿‡éšå¼è¡¨ç¤ºä¹Ÿæœ‰ä¼˜ç‚¹ï¼Œå®ƒèƒ½å¾ˆæ–¹ä¾¿åœ°åˆ¤æ–­ä¸€ä¸ªç‚¹ $(x,y,z)$ æ˜¯å¦åœ¨æ›²çº¿ä¸Š / æ›²çº¿å†… / æ›²çº¿å¤–ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹éšå¼è¡¨ç¤ºå’Œå‚æ•°è¡¨ç¤ºçš„ä»£è¡¨åº”ç”¨ã€‚</p><h2 id="éšå¼è¡¨ç¤ºï¼šç¬¦å·è·ç¦»åœº"><a href="#éšå¼è¡¨ç¤ºï¼šç¬¦å·è·ç¦»åœº" class="headerlink" title="éšå¼è¡¨ç¤ºï¼šç¬¦å·è·ç¦»åœº"></a>éšå¼è¡¨ç¤ºï¼šç¬¦å·è·ç¦»åœº</h2><p>ç¬¦å·è·ç¦»åœºï¼ˆSigned Distance Filed, SDFï¼‰æ˜¯éšå¼è¡¨ç¤ºçš„ä»£è¡¨åº”ç”¨ä¹‹ä¸€ï¼Œè‡ª 2007 å¹´ Valve çš„è®ºæ–‡ä»¥æ¥ï¼Œå®ƒä¸€ç›´è¢«ç”¨äºæ¸¸æˆå†…çš„æ–‡æœ¬æ¸²æŸ“ã€‚è™½ç„¶ç°åœ¨ç”¨çš„æ›´å¤šæ˜¯å¤šé€šé“ç¬¦å·è·ç¦»åœºï¼ˆMSDFï¼‰ï¼Œä½†æˆ‘ä»¬è¿™é‡Œåªç®€å•ä»‹ç»ä¸‹ç¬¦å·è·ç¦»åœºï¼Œå› ä¸ºåè€…æ›´åŠ å¤æ‚ã€‚</p><p>ç¬¦å·è·ç¦»åœºå°±æ˜¯å¸¦ç¬¦å·çš„è·ç¦»åœºï¼Œå¯¹ç»™å®šçš„ç‚¹ $(u,v)$ï¼Œæˆ‘ä»¬è®°å½•å®ƒåˆ°å›¾å½¢çš„æœ€è¿‘è·ç¦»â€”â€”å¦‚æœå®ƒåœ¨å›¾å½¢å†…éƒ¨ï¼ˆå›¾å½¢çš„çº¿æ¡æ˜¯æœ‰å®½åº¦çš„ï¼Œè¿™ä¸ªå†…éƒ¨æŒ‡åœ¨çº¿æ¡å†…è€Œéå‡ ä½•é—­ç¯å†…ï¼‰ï¼Œè·ç¦»ä¸ºæ­£å€¼ï¼Œå¦åˆ™ä¸ºè´Ÿå€¼ã€‚</p><p>åœ¨ V ç¤¾çš„è®ºæ–‡ä¸­ï¼Œä»–ä»¬å…ˆå¯¹çŸ¢é‡æ–‡å­—åšäº†å…‰æ …åŒ–å¾—åˆ°äº† $4096\times 4096$ çš„å›¾åƒï¼Œç„¶ååŸºäºè¿™å¼ å›¾å¾—åˆ°äº† $64\times 64$ çš„ç¬¦å·è·ç¦»åœºã€‚</p><p>ä¸‹å›¾å±•ç¤ºäº†åŸå›¾å’Œç¬¦å·è·ç¦»åœºã€‚å›¾åƒä¸é€æ˜åº¦æ˜¯åœ¨ $[0,1]$ é—´çš„éè´Ÿæ•°ï¼Œä¸ºäº†å¯è§†åŒ–ç¬¦å·è·ç¦»åœºï¼Œæˆ‘ä»¬æŠŠè·ç¦»ä¸ºæ­£çš„å†…éƒ¨æ˜ å°„åˆ° $(0.5, 1]$ï¼Œè·ç¦»ä¸º $0$ çš„è¾¹ç¼˜è¢«æ˜ å°„åˆ° $0.5$ï¼Œè·ç¦»ä¸ºè´Ÿçš„å¤–éƒ¨æ˜ å°„åˆ° $[0, 0.5)$.</p><p><img src="/images/learning/open-course/GAMES101/Notes/note4/sdf.png" alt=""></p><p>å¾—åˆ°äº†ç¬¦å·è·ç¦»åœºä¹‹åï¼Œæˆ‘ä»¬å°±èƒ½å¯¹ä»»ä½•ä¸€ä¸ªç‚¹æ’å€¼å‡ºå®ƒä¸å›¾å½¢çš„è·ç¦»ï¼Œç„¶åæ ¹æ®è¿™ä¸ªè·ç¦»å†³å®šå®ƒæ˜¯å¦æ˜¾ç¤ºå‡ºæ¥ã€‚æˆ‘ä»¬ä¹‹å‰å·²ç»æè¿‡äº†è·ç¦»åˆ°ä¸é€æ˜åº¦çš„æ˜ å°„ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•è®¾ç½®ä¸€ä¸ªé˜ˆå€¼æ¥å†³å®šæ˜¯å¦æ˜¾ç¤ºæŸä¸ªåƒç´ ï¼š</p><pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl">baseColor<span class="token punctuation">.</span>a <span class="token operator">=</span> distAlphaMask <span class="token operator">>=</span> <span class="token number">0.5</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æˆ‘ä¸ªäººçš„æ€è€ƒæ˜¯ï¼Œä¸è¦å› ä¸ºæˆ‘ä»¬å¯è§†åŒ–äº†ç¬¦å·è·ç¦»åœºå°±æŠŠå®ƒå½“ä½œå›¾åƒã€‚å®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªè·ç¦»å‡½æ•° $d(u,v)$ï¼Œæˆ‘ä»¬çš„ $64\times 64$ çš„ SDF å›¾åƒçš„æ¯ä¸ªåƒç´ è¡¨ç¤ºçš„ä¸æ˜¯â€œå¹³å‡é¢œè‰²â€ï¼Œè€Œæ˜¯â€œåƒç´ ä¸­å¿ƒç‚¹åˆ°å›¾å½¢çš„è·ç¦»â€ã€‚è¦æŠŠå®ƒçœ‹ä½œç‚¹ï¼Œè€Œéæ–¹å—ã€‚</p><h2 id="å‚æ•°è¡¨ç¤ºï¼šè´å¡å°”æ›²çº¿å’Œæ›²é¢"><a href="#å‚æ•°è¡¨ç¤ºï¼šè´å¡å°”æ›²çº¿å’Œæ›²é¢" class="headerlink" title="å‚æ•°è¡¨ç¤ºï¼šè´å¡å°”æ›²çº¿å’Œæ›²é¢"></a>å‚æ•°è¡¨ç¤ºï¼šè´å¡å°”æ›²çº¿å’Œæ›²é¢</h2><p>è´å¡å°”æ›²çº¿å’Œæ›²é¢æ˜¯å‚æ•°è¡¨ç¤ºçš„å¾ˆå¥½ä¾‹å­ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹è®¡ç®—è´å¡å°”æ›²çº¿çš„å¸¸ç”¨ç®—æ³•å’Œä¸€èˆ¬å…¬å¼ã€‚</p><h3 id="è´å¡å°”æ›²çº¿"><a href="#è´å¡å°”æ›²çº¿" class="headerlink" title="è´å¡å°”æ›²çº¿"></a>è´å¡å°”æ›²çº¿</h3><p>å¸¸ç”¨çš„ç”Ÿæˆè´å¡å°”æ›²çº¿çš„ Casteljau Algorithm å¦‚ä¸‹ï¼Œæˆ‘ä»¬ä»¥å››ä¸ªç‚¹æ±‚ä¸‰é˜¶è´å¡å°”æ›²çº¿ä¸ºä¾‹ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">bezier</span><span class="token punctuation">(</span>t<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># ç¬¬ä¸€å±‚çº¿æ€§æ’å€¼</span>    p0_1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> t<span class="token punctuation">)</span> <span class="token operator">*</span> p0 <span class="token operator">+</span> t <span class="token operator">*</span> p1    p1_1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> t<span class="token punctuation">)</span> <span class="token operator">*</span> p1 <span class="token operator">+</span> t <span class="token operator">*</span> p2    p2_1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> t<span class="token punctuation">)</span> <span class="token operator">*</span> p2 <span class="token operator">+</span> t <span class="token operator">*</span> p3    <span class="token comment"># ç¬¬äºŒå±‚çº¿æ€§æ’å€¼</span>    p0_2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> t<span class="token punctuation">)</span> <span class="token operator">*</span> p0_1 <span class="token operator">+</span> t <span class="token operator">*</span> p1_1    p1_2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> t<span class="token punctuation">)</span> <span class="token operator">*</span> p1_1 <span class="token operator">+</span> t <span class="token operator">*</span> p2_1    <span class="token comment"># ç¬¬ä¸‰å±‚ï¼ˆæœ€åä¸€å±‚ï¼‰çº¿æ€§æ’å€¼</span>    p_final <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> t<span class="token punctuation">)</span> <span class="token operator">*</span> p0_2 <span class="token operator">+</span> t <span class="token operator">*</span> p1_2    <span class="token keyword">return</span> p_final<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>çœ‹çœ‹è¿™ä¸ªç®—æ³•ä¹Ÿå°±çŸ¥é“è´å¡å°”æ›²çº¿æ˜¯æ€ä¹ˆæ¥çš„äº†ã€‚</p><p>ä¸‰é˜¶å…¬å¼æ˜¯</p><script type="math/tex; mode=display">\mathbf{B}(t) = (1-t)^3 \mathbf{P}_0 + 3(1-t)^2 t \mathbf{P}_1 + 3(1-t) t^2 \mathbf{P}_2 + t^3 \mathbf{P}_3</script><p>ä¸€èˆ¬çš„ $n$ é˜¶å…¬å¼æ˜¯</p><script type="math/tex; mode=display">\mathbf{B}(t) = \sum_{i=0}^{m} \binom{m}{i} (1-t)^{m-i} t^i \mathbf{P}_i</script><p>ä¸‹å›¾ä¸­ï¼Œå·¦å›¾æ˜¯ Godot é‡Œçš„ Curveï¼Œå®ƒå°±ç”¨åˆ°äº†è´å¡å°”æ›²çº¿ï¼›å³å›¾è´å¡å°”æ›²çº¿çš„ç”Ÿæˆæ–¹æ³•ï¼Œå’Œä¸Šé¢æåˆ°çš„ Casteljau Algorithm ä¸€è‡´ã€‚</p><p><img src="/images/learning/open-course/GAMES101/Notes/note4/bezier.png" alt=""></p><p>å†çœ‹çœ‹å·¦å›¾ï¼Œæˆ‘ä»¬ä¼šå‘ç°å®ƒæ˜¯ç”±ä¸‰ä¸ªè´å¡å°”æ›²çº¿æ‹¼æ¥è€Œæˆçš„ï¼Œè€Œä¸”çœ‹èµ·æ¥å¾ˆå¹³æ»‘ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„â€œåˆ†æ®µè´å¡å°”æ›²çº¿â€ã€‚é«˜é˜¶è´å¡å°”æ›²çº¿ä¸å®¹æ˜“æ§åˆ¶ï¼Œæ‰€ä»¥æˆ‘ä»¬æ›´å€¾å‘äºæŠŠå‡ ä¸ªä½é˜¶è´å¡å°”æ›²çº¿æ‹¼æ¥èµ·æ¥å½¢æˆå¤æ‚æ›²çº¿ã€‚</p><h3 id="è´å¡å°”æ›²é¢"><a href="#è´å¡å°”æ›²é¢" class="headerlink" title="è´å¡å°”æ›²é¢"></a>è´å¡å°”æ›²é¢</h3><p>æˆ‘ä»¬åŒæ ·ç”¨ Casteljau Algorithm ç”Ÿæˆè´å¡å°”æ›²é¢ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">_de_casteljau_1d</span><span class="token punctuation">(</span>points<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""å¯¹ä¸€ç»´ç‚¹åºåˆ—æ‰§è¡Œ Casteljau ç®—æ³•ã€‚"""</span>    <span class="token keyword">while</span> <span class="token builtin">len</span><span class="token punctuation">(</span>points<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">:</span>        points <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> t<span class="token punctuation">)</span> <span class="token operator">*</span> p1 <span class="token operator">+</span> t <span class="token operator">*</span> p2 <span class="token keyword">for</span> p1<span class="token punctuation">,</span> p2 <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>points<span class="token punctuation">,</span> points<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>    <span class="token keyword">return</span> points<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token keyword">def</span> <span class="token function">bezier_surface</span><span class="token punctuation">(</span>control_points<span class="token punctuation">,</span> u<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""è®¡ç®—è´å¡å°”æ›²é¢ä¸Šçš„ä¸€ç‚¹ã€‚"""</span>    intermediate_points <span class="token operator">=</span> <span class="token punctuation">[</span>_de_casteljau_1d<span class="token punctuation">(</span>row<span class="token punctuation">,</span> u<span class="token punctuation">)</span> <span class="token keyword">for</span> row <span class="token keyword">in</span> control_points<span class="token punctuation">]</span>    final_point <span class="token operator">=</span> _de_casteljau_1d<span class="token punctuation">(</span>intermediate_points<span class="token punctuation">,</span> v<span class="token punctuation">)</span>    <span class="token keyword">return</span> final_point<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦‚ä¸‹å›¾ä¸­çš„å³å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬æœ¬è´¨ä¸Šæ˜¯å…ˆæ²¿ç€ä¸€ä¸ªè½´å‘ç”Ÿæˆä¸€ç»„è´å¡å°”æ›²çº¿ï¼Œå†åœ¨æ›²çº¿ä¸Šå–å€¼ç”Ÿæˆä¸€ç»„æ–°çš„æ§åˆ¶ç‚¹ï¼Œç„¶åç”¨è¿™ç»„æ–°æ§åˆ¶ç‚¹å®šä¹‰ä¸€æ¡æ–°çš„æ›²çº¿ï¼Œæœ€ååœ¨æ–°çš„æ›²çº¿ä¸Šå–å€¼å¾—åˆ°æ›²é¢ä¸Šçš„æœ€ç»ˆç‚¹ã€‚</p><p><img src="/images/learning/open-course/GAMES101/Notes/note4/bezier_surface.png" alt=""></p><h1 id="ç½‘æ ¼å¤„ç†"><a href="#ç½‘æ ¼å¤„ç†" class="headerlink" title="ç½‘æ ¼å¤„ç†"></a>ç½‘æ ¼å¤„ç†</h1><p>ç”Ÿæˆä¸‰è§’å½¢ç½‘æ ¼åï¼Œæˆ‘ä»¬ç»å¸¸è¿˜å¸Œæœ›åšä¸€äº›å¤„ç†ï¼Œæ¯”å¦‚ç»†åˆ†æ¥è®©æ¨¡å‹æ›´å…‰æ»‘ï¼›å‡å°‘ä¸‰è§’å½¢æ•°é‡æ¥ç®€åŒ–ç½‘æ ¼ã€‚ä¸‹é¢ç®€å•æä¸€ä¸‹ç½‘æ ¼ç»†åˆ†å’Œç½‘æ ¼ç®€åŒ–çš„å¸¸ç”¨ç®—æ³•ã€‚</p><p><img src="/images/learning/open-course/GAMES101/Notes/note4/mesh_operation.png" alt=""></p><h2 id="ç½‘æ ¼ç»†åˆ†"><a href="#ç½‘æ ¼ç»†åˆ†" class="headerlink" title="ç½‘æ ¼ç»†åˆ†"></a>ç½‘æ ¼ç»†åˆ†</h2><p>ç½‘æ ¼ç»†åˆ†ç®—æ³•çš„ç»å¯¹ä¸»æµæ˜¯ Catmull-Clark ç»†åˆ†ï¼ŒBlender çš„è¡¨é¢ç»†åˆ†ä¿®æ”¹å™¨çš„é»˜è®¤ç®—æ³•å°±æ˜¯è¿™ä¸ªã€‚å®ƒå¯ä»¥ç»†åˆ†ä»»æ„å½¢çŠ¶çš„å¤šè¾¹å½¢ï¼Œä½†åœ¨ç»†åˆ†å››è¾¹å½¢æ—¶æ•ˆæœæœ€å¥½ã€‚</p><p>è¯¾ä¸Šè¿˜æåˆ°äº†ç”¨äºç»†åˆ†ä¸‰è§’å½¢çš„ Loop ç»†åˆ†ï¼Œä¸è¿‡ä¸¤ä¸ªç»†åˆ†éƒ½åªæ˜¯ç®€å•æäº†ææ¦‚å¿µï¼Œæˆ‘ä»¬è¿™é‡Œä¸å¤šè®°ç¬”è®°ã€‚</p><h2 id="ç½‘æ ¼ç®€åŒ–"><a href="#ç½‘æ ¼ç®€åŒ–" class="headerlink" title="ç½‘æ ¼ç®€åŒ–"></a>ç½‘æ ¼ç®€åŒ–</h2><p>ç½‘æ ¼ç®€åŒ–çš„åŸºæœ¬æ€è·¯æ˜¯æ¯æ¬¡æŠŠä¸€æ¡è¾¹åç¼©æˆä¸€ä¸ªç‚¹ã€‚æˆ‘ä»¬ç”¨äºŒæ¬¡è¯¯å·®è¡¡é‡æ¯æ¡è¾¹åç¼©åå¼•å…¥çš„è¯¯å·®ï¼Œç„¶åé€‰æ‹©æœ€å°çš„è¾¹æ¥åç¼©ï¼Œä¹‹åé‡æ–°è®¡ç®—äºŒæ¬¡è¯¯å·®ï¼ˆå› ä¸ºåç¼©åå½¢çŠ¶ä¼šæ”¹å˜ï¼‰ï¼Œç„¶åå†æ¬¡é€‰æ‹©æœ€å°çš„è¾¹ï¼Œå¦‚æ­¤é‡å¤ã€‚è¿™æ˜¯ä¸ªè´ªå©ªç®—æ³•ï¼Œä½†èƒ½æ‹¿åˆ°ä¸é”™çš„ç»“æœã€‚</p><p>å…·ä½“å…¬å¼æˆ‘ä»¬ä¹Ÿä¸å†™ï¼Œå› ä¸ºè¯¾ä¸Šæ²¡è¯¦ç»†è®²ï¼Œæˆ‘ä¹Ÿä¸æ„Ÿå…´è¶£ï¼Œç”¨åˆ°çš„æ—¶å€™å»æŸ¥æŸ¥å°±å¥½äº†ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;è¯¾ä¸Šåªæ˜¯ç®€å•æäº†ä¸‹å‡ ä½•ä¸“é¢˜ï¼Œæˆ‘ä¹Ÿè®¤ä¸ºè¿™ä¸ªä¸“é¢˜ç›¸è¾ƒäºåˆ«çš„å‡ ä¸ªæ²¡é‚£ä¹ˆé‡è¦ï¼Œæ‰€ä»¥åªæ˜¯è®°ä¸€ä¸‹éšå¼è¡¨ç¤ºå’Œå‚æ•°è¡¨ç¤ºçš„ç›¸å…³å†…å®¹ï¼Œå†ç®€å•æä¸€å¥ç½‘æ ¼å¤„ç†ã€‚&lt;/p&gt;
&lt;h1 id=&quot;éšå¼è¡¨ç¤ºå’Œå‚æ•°è¡¨ç¤º&quot;&gt;&lt;a href=&quot;#éšå¼è¡¨ç¤ºå’Œå‚æ•°è¡¨ç¤º&quot; class=&quot;headerlink&quot; title</summary>
      
    
    
    
    <category term="å…¬å¼€è¯¾" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/"/>
    
    <category term="GAMES101" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/GAMES101/"/>
    
    <category term="Notes" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/GAMES101/Notes/"/>
    
    
  </entry>
  
  <entry>
    <title>Note 3 Shading</title>
    <link href="http://rinevard.github.io/wiki/learning/open-course/GAMES101/Notes/Note3-Shading/"/>
    <id>http://rinevard.github.io/wiki/learning/open-course/GAMES101/Notes/Note3-Shading/</id>
    <published>2025-09-17T04:10:28.000Z</published>
    <updated>2025-09-17T04:03:13.842Z</updated>
    
    <content type="html"><![CDATA[<h1 id="×™Ö°×”Ö´×™-××•Ö¹×¨"><a href="#×™Ö°×”Ö´×™-××•Ö¹×¨" class="headerlink" title="×™Ö°×”Ö´×™ ××•Ö¹×¨"></a>×™Ö°×”Ö´×™ ××•Ö¹×¨</h1><p>èµ·åˆï¼Œè®¡ç®—æœºçš„ä¸–ç•Œå°šæœªæ¸²æŸ“ï¼Œæ˜¾ç¤ºå™¨ä¸­ç©ºè™šæ··æ²Œï¼Œæ¸Šé¢é»‘æš—ã€‚</p><p>å”¯æœ‰é¡¶ç‚¹ä¸å¤šè¾¹å½¢æ‚¬äºè™šç©ºï¼Œä¸è§å…¶å½¢ï¼Œä¸è¾¨å…¶è‰²ã€‚</p><p>é‚£å£°éŸ³è¯´ï¼š<strong>â€œè¦æœ‰å…‰ã€‚â€</strong></p><p>å°±æœ‰äº†å…‰ã€‚</p><p>å…‰æ˜¯å¥½çš„ï¼Œäºæ˜¯é‚£å£°éŸ³å°†å…‰ä¸æš—åˆ†å¼€äº†ã€‚å…‰æ‰€ç…§ä¹‹å¤„ï¼Œç‰©ä½“çš„æ­£é¢å¾—ä»¥æ˜¾ç°ï¼›å…‰æ‰€ä¸è‡³çš„èƒŒé¢ï¼Œåˆ™å½’äºé˜´å½±ã€‚ä»æ­¤ï¼Œä¸‰ç»´çš„ä¸–ç•Œæœ‰äº†æ˜æš—ä¸å±‚æ¬¡ã€‚</p><p>è¿™å…‰å¹¶éä¸€ä½“ã€‚</p><p>é‚£æ™®ç…§ä¸‡ç‰©ï¼Œå‡åŒ€æ•£å¼€ï¼Œä½¿ç‰©ä½“æ˜¾å…¶æœ¬è‰²çš„ï¼Œç§°ä¹‹ä¸º<strong>æ¼«åå°„</strong>ã€‚</p><p>é‚£æ±‡äºä¸€ç‚¹ï¼Œé”åˆ©å¤ºç›®ï¼Œä½¿å…‰æ»‘ä¹‹ç‰©å°½æ˜¾å…¶è€€çš„ï¼Œç§°ä¹‹ä¸º<strong>é•œé¢åå°„</strong>ã€‚</p><p>é‚£å¼¥æ¼«äºç¯å¢ƒï¼Œå……ç›ˆäºé˜´å½±ï¼Œä½¿é»‘æš—ä¸è‡³å®Œå…¨åå™¬ä¸€åˆ‡çš„ï¼Œç§°ä¹‹ä¸º<strong>ç¯å¢ƒå…‰</strong>ã€‚</p><p>æœ‰æ¼«åå°„ï¼Œæœ‰é•œé¢åå°„ï¼Œæœ‰ç¯å¢ƒå…‰ï¼Œå…±åŒæ„æˆäº†è¿™è™šæ‹Ÿä¸–ç•Œçš„ç¬¬ä¸€ä¸ªç™½æ˜¼ã€‚</p><h2 id="æ¼«åå°„ï¼ˆDiffuse-Reflectionï¼‰"><a href="#æ¼«åå°„ï¼ˆDiffuse-Reflectionï¼‰" class="headerlink" title="æ¼«åå°„ï¼ˆDiffuse Reflectionï¼‰"></a>æ¼«åå°„ï¼ˆ<strong>Diffuse Reflectionï¼‰</strong></h2><p>åœ¨æ¼«åå°„ä¸­ï¼Œå…‰å‘å››é¢å…«æ–¹æ•£å»ï¼Œæ‰€ä»¥ç‰©ä½“æ¼«åå°„å‡ºçš„å…‰ä¸æ‘„åƒæœºä½ç½®æ— å…³ï¼Œè€Œä»…ä¸ä»¥ä¸‹å‡ é¡¹æœ‰å…³ï¼š</p><ol><li>å…‰å¼º $c_l$.</li><li>ç‰©ä½“æè´¨ $c_r$. ä¸åŒç‰©ä½“å¯¹å…‰çš„åå°„ç‡æ˜¯ä¸åŒçš„ï¼Œå³ä½¿æ˜¯åŒä¸€ä¸ªç‰©ä½“ä¹Ÿå¯¹ä¸åŒé¢œè‰²çš„å…‰æœ‰ä¸åŒåå°„ç‡ã€‚</li><li>ç‰©ä½“è¡¨é¢æ³•çº¿ $\mathbf{n}$.</li><li>å…‰æºæ–¹å‘ $\mathbf{l}$.</li></ol><p>æœ€ç»ˆç»“æœå¯ä»¥å†™æˆ </p><script type="math/tex; mode=display">L_d = c_r c_l \max (0, \mathbf{n} \cdot \mathbf{l})</script><p>ç”±äºå…‰å¼ºä¸€èˆ¬éšè·ç¦»è¡°å‡ï¼Œæ‰€ä»¥ $c_l$ ä¸€èˆ¬åæ¯”äºè·ç¦»çš„å¹³æ–¹ $r^2$. </p><h2 id="é•œé¢åå°„ï¼ˆSpecular-Reflectionï¼‰"><a href="#é•œé¢åå°„ï¼ˆSpecular-Reflectionï¼‰" class="headerlink" title="é•œé¢åå°„ï¼ˆSpecular Reflectionï¼‰"></a>é•œé¢åå°„ï¼ˆSpecular Reflectionï¼‰</h2><p>é•œé¢åå°„ä¸­ï¼Œå…‰ä¸»è¦å‘ä¸€ä¸ªæ–¹å‘åå°„ï¼Œæ‰€ä»¥é•œé¢åå°„çš„å…‰ä¸æ‘„åƒæœºä½ç½®æœ‰å…³ã€‚</p><script type="math/tex; mode=display">L_s = c_pc_l\max(0, \mathbf n \cdot \mathbf h)^p</script><p>å…¶ä¸­ $c_p$ æ˜¯è‡ªå®šä¹‰çš„ RGB å€¼ï¼Œå…è®¸æˆ‘ä»¬æ§åˆ¶é«˜å…‰é¢œè‰²ï¼ŒæŒ‡æ•° $p$ æ˜¯ä¸ºäº†ä¿è¯æˆ‘ä»¬åªåœ¨å°èŒƒå›´å†…çœ‹åˆ°é«˜å…‰ï¼Œ$p$ è¶Šå¤§è¿™ä¸ªé«˜å…‰å¯è§èŒƒå›´è¶Šå°ï¼Œè€Œ $\mathbf h$ çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><script type="math/tex; mode=display">\mathbf h = (\mathbf e + \mathbf l).\text{normalized()}</script><p>è¿˜æœ‰ä¸€ç§å†™æ³•æŠŠ $\mathbf n \cdot \mathbf h$ æ¢æˆäº† $\mathbf r \cdot \mathbf e$ï¼Œç®€å•è®¡ç®—å¯ä»¥å‘ç° $\mathbf<br>n$ å’Œ $\mathbf h$ çš„å¤¹è§’æ˜¯ $\mathbf r$ å’Œ $\mathbf e$ çš„å¤¹è§’çš„ä¸€åŠï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªå†™æ³•åœ¨æ€è·¯ä¸Šæ˜¯ä¸€æ ·çš„ï¼Œéƒ½åœ¨è€ƒè™‘åå°„å…‰æ–¹å‘å’Œæ‘„åƒæœºæ–¹å‘çš„å¤¹è§’ï¼Œä¸è¿‡åœ¨æ•°å€¼ä¸Šä¼šç•¥æœ‰å·®åˆ«ã€‚æœ¬æ–‡é‡‡ç”¨ $\mathbf n \cdot \mathbf h$ çš„å†™æ³•ã€‚</p><p><img src="/images/learning/open-course/GAMES101/Notes/note3/specular.png" alt=""></p><h2 id="ç¯å¢ƒå…‰ï¼ˆAmbient-Lightingï¼‰"><a href="#ç¯å¢ƒå…‰ï¼ˆAmbient-Lightingï¼‰" class="headerlink" title="ç¯å¢ƒå…‰ï¼ˆAmbient Lightingï¼‰"></a>ç¯å¢ƒå…‰ï¼ˆAmbient Lightingï¼‰</h2><p>å¦‚æœåªè€ƒè™‘æ¼«åå°„å’Œé•œé¢åå°„ï¼Œæˆ‘ä»¬ä¼šå‘ç°æ²¡æœ‰é¢æœå…‰æºçš„ç‰©ä½“å®Œå…¨æ˜¯é»‘è‰²çš„ï¼Œä½†ç°å®é‡Œæ˜¾ç„¶ä¸æ˜¯å¦‚æ­¤ã€‚è¿™æ˜¯å› ä¸ºåœ¨ç°å®é‡Œï¼Œå…‰ç»è¿‡å¤šæ¬¡åå°„è€Œç…§äº®äº†é‚£äº›æ²¡æœ‰é¢æœå…‰æºçš„ç‰©ä½“ã€‚æˆ‘ä»¬å¯ä»¥è¿‘ä¼¼åœ°è®¤ä¸ºæœ‰ä¸€ç§å……æ–¥ç€æ•´ä¸ªç©ºé—´çš„å…‰ï¼Œå¹¶æŠŠå®ƒå«åšç¯å¢ƒå…‰ï¼Œå…¬å¼å¦‚ä¸‹ï¼š</p><script type="math/tex; mode=display">L_a=c_r c_a</script><p>å…¶ä¸­ $c_a$ æ˜¯ç¯å¢ƒå…‰çš„å¼ºåº¦ã€‚</p><h2 id="å†¯æ°å…‰ç…§æ¨¡å‹"><a href="#å†¯æ°å…‰ç…§æ¨¡å‹" class="headerlink" title="å†¯æ°å…‰ç…§æ¨¡å‹"></a>å†¯æ°å…‰ç…§æ¨¡å‹</h2><p>ç»¼åˆæ¥çœ‹ï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº†<strong>å†¯æ°å…‰ç…§æ¨¡å‹</strong>ï¼Œå…¬å¼å¦‚ä¸‹ï¼š</p><script type="math/tex; mode=display">L=c_r(c_a+c_l\max{(0,\mathbf n \cdot \mathbf l)})+c_pc_l\max(0, \mathbf n \cdot \mathbf h)^p</script><p>å…¶ä¸­ </p><ol><li>$c_r$ æ˜¯ç‰©ä½“æè´¨ï¼Œè¡¨ç¤ºç‰©ä½“å¯¹å…‰çš„åå°„ç‡ï¼Œä¸€èˆ¬æ˜¯ä¸€ä¸ª Vector3f ç±»å‹çš„å€¼ï¼Œå› ä¸ºç‰©ä½“å¯¹ä¸åŒé¢œè‰²çš„å…‰æœ‰ä¸åŒåå°„ç‡ï¼›</li><li>$c_a$ æ˜¯ç¯å¢ƒå…‰å¼ºï¼Œä¸€èˆ¬æ˜¯ä¸€ä¸ª Vector3f ç±»å‹çš„å€¼ï¼›</li><li>$c_l$ æ˜¯å…‰å¼ºï¼Œä¸€èˆ¬ä¸ç‰©ä½“å’Œå…‰æºçš„è·ç¦»æˆåæ¯”ï¼Œä¸€èˆ¬æ˜¯ä¸€ä¸ª Vector3f ç±»å‹çš„å€¼ï¼›</li><li>$c_p$ æ˜¯é«˜å…‰é¢œè‰²ï¼Œä¸€èˆ¬ä¹Ÿæ˜¯ä¸€ä¸ª Vector3f ç±»å‹çš„å€¼ã€‚</li></ol><h1 id="UVæ˜ å°„"><a href="#UVæ˜ å°„" class="headerlink" title="UVæ˜ å°„"></a>UVæ˜ å°„</h1><p>ä¸ºäº†æŠŠè´´å›¾è´´åˆ°æ¨¡å‹ä¸Šï¼Œéœ€è¦æœ‰ä¸€ä¸ª $(x, y, z) \rightarrow (u, v)$ çš„å‡½æ•° $\phi$. æˆ‘ä»¬æœŸæœ›è¿™ä¸ªå‡½æ•°æœ‰è¿™äº›æ€§è´¨ï¼š</p><ol><li>å•å°„ï¼šæˆ‘ä»¬ä¸å¸Œæœ›ä¸¤ä¸ª 3D ç‚¹æ˜ å°„åˆ°åŒä¸€ä¸ª 2D ç‚¹ä¸Š</li><li>å¤§å°ä¸å˜æ€§ï¼šåœ¨ 3D æ¨¡å‹ä¸Šçš„ä¸‰è§’å½¢å¤šå¤§ï¼Œæˆ‘ä»¬å¸Œæœ› 2D çš„ä¸‰è§’å½¢ä¹Ÿå·®ä¸å¤šå¤§å°</li><li>å½¢çŠ¶ä¸å˜æ€§ï¼š3D æ¨¡å‹çš„ä¸‰è§’å½¢æ˜ å°„åˆ° 2D ä¸Šåï¼Œä¸¤ä¸ªä¸‰è§’å½¢åº”å°½é‡ç›¸ä¼¼</li><li>è¿ç»­ï¼šå¦‚æœä¸¤ä¸ªç‚¹åœ¨ 3D ä¸–ç•Œæ¨¡å‹ä¸Šç›¸è¿‘ï¼Œæˆ‘ä»¬å¸Œæœ›å®ƒä»¬åœ¨ 2D ä¸Šä¹Ÿç›¸è¿‘</li></ol><p>è´´å›¾æœ‰è®¸å¤šåº”ç”¨ï¼Œæœ€å®¹æ˜“æƒ³åˆ°çš„æ˜¯é¢œè‰²è´´å›¾ï¼Œå®ƒç›´æ¥æŠŠé¢œè‰²è´´åˆ°æ¨¡å‹ä¸Šï¼Œä¹Ÿè¢«ç§°ä½œæ¼«åå°„è´´å›¾ã€‚</p><p>æ³•çº¿è´´å›¾ã€é‡‘å±åº¦è´´å›¾ã€ç²—ç³™åº¦è´´å›¾åˆ™è¿›ä¸€æ­¥å†³å®šäº†æ¨¡å‹çš„å„ç§å±æ€§ã€‚æ¯”å¦‚æ³•çº¿è´´å›¾å®šä¹‰äº†æ¯ä¸€ç‚¹çš„æ³•çº¿ï¼Œåœ¨è®¡ç®—å…‰ç…§æ—¶ä¼šå€ŸåŠ©è¿™ä¸ªæ³•çº¿æ¥å¾—åˆ°æ›´çœŸå®çš„ç»“æœã€‚</p><p><img src="/images/learning/open-course/GAMES101/Notes/note3/normal-map.jpg" alt=""></p><h1 id="ç€è‰²æ–¹æ³•"><a href="#ç€è‰²æ–¹æ³•" class="headerlink" title="ç€è‰²æ–¹æ³•"></a>ç€è‰²æ–¹æ³•</h1><p>æ¨¡å‹ç”±ä¸‰è§’å½¢åˆ’åˆ†æ¥è¡¨ç¤ºï¼Œé‚£ä¹ˆæ¯ä¸ªä¸‰è§’å½¢ç”¨æ€æ ·çš„é¢œè‰²å‘¢ï¼Ÿ</p><h2 id="å¹³é¢ç€è‰²ï¼ˆFlat-Shadingï¼‰"><a href="#å¹³é¢ç€è‰²ï¼ˆFlat-Shadingï¼‰" class="headerlink" title="å¹³é¢ç€è‰²ï¼ˆFlat Shadingï¼‰"></a>å¹³é¢ç€è‰²ï¼ˆFlat Shadingï¼‰</h2><p>æˆ‘ä»¬é€šè¿‡å…‰ç…§è®¡ç®—é¢œè‰²ï¼Œè€Œè®¡ç®—å…‰ç…§éœ€è¦æ³•çº¿ã€‚å¹³é¢ç€è‰²ç›´æ¥æ±‚è¿™ä¸ªä¸‰è§’å½¢çš„æ³•çº¿ï¼Œç„¶åæŒ‰å…‰ç…§å…¬å¼è®¡ç®—è¿™ä¸ªä¸‰è§’å½¢çš„é¢œè‰²ã€‚è¿™ç§æ–¹æ³•å¾—åˆ°çš„æ¯ä¸ªä¸‰è§’å½¢éƒ½æ˜¯å•è‰²çš„ã€‚</p><h2 id="é€é¡¶ç‚¹ç€è‰²ï¼ˆGouraud-Shadingï¼‰"><a href="#é€é¡¶ç‚¹ç€è‰²ï¼ˆGouraud-Shadingï¼‰" class="headerlink" title="é€é¡¶ç‚¹ç€è‰²ï¼ˆGouraud Shadingï¼‰"></a>é€é¡¶ç‚¹ç€è‰²ï¼ˆGouraud Shadingï¼‰</h2><p>é€é¡¶ç‚¹ç€è‰²åˆ™æ±‚ä¸‰è§’å½¢é¡¶ç‚¹çš„æ³•çº¿ï¼Œå¹¶ä¸ºä¸‰è§’å½¢é¡¶ç‚¹ç€è‰²ï¼Œç„¶åå¯¹å†…éƒ¨çš„æ¯ä¸ªç‚¹æ’å€¼å†…éƒ¨é¢œè‰²ã€‚</p><p>é‚£ä¹ˆé¡¶ç‚¹çš„æ³•çº¿æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä¸€ä¸ªé¡¶ç‚¹ä¸€èˆ¬åœ¨å¤šä¸ªé¢ä¸Šï¼ŒæŠŠè¿™äº›é¢çš„æ³•çº¿åšåŠ æƒå¹³å‡å°±å¥½ï¼Œæƒå€¼å¯ä»¥æ˜¯é¢çš„é¢ç§¯ã€‚</p><h2 id="é€åƒç´ ç€è‰²ï¼ˆPhong-Shadingï¼‰"><a href="#é€åƒç´ ç€è‰²ï¼ˆPhong-Shadingï¼‰" class="headerlink" title="é€åƒç´ ç€è‰²ï¼ˆPhong Shadingï¼‰"></a>é€åƒç´ ç€è‰²ï¼ˆPhong Shadingï¼‰</h2><p>é€åƒç´ ç€è‰²åŒæ ·æ±‚ä¸‰è§’å½¢é¡¶ç‚¹çš„æ³•çº¿ï¼Œç„¶åå¯¹å†…éƒ¨çš„æ¯ä¸ªç‚¹æ’å€¼å†…éƒ¨æ³•çº¿ï¼Œä»æ³•çº¿å†æ±‚å„ä¸ªç‚¹çš„é¢œè‰²ã€‚</p><p>æ’å€¼æ˜¯é€šè¿‡é‡å¿ƒåæ ‡æ¥æ’å€¼ã€‚å¯¹ä¸‰è§’å½¢ $ABC$ å†…çš„æŸä¸€ç‚¹ $P$ï¼Œå®ƒå¯ä»¥è¡¨ç¤ºä¸º</p><script type="math/tex; mode=display">P=\frac{S_{APB}C+S_{BPC}A+S_{CPA}B}{S_{ABC}}</script><p>è¿™é‡Œçš„ $S$ æ˜¯é¢ç§¯ï¼Œè¿™é‡Œçš„å½¢å¦‚ $S<em>{APB}/S</em>{ABC}$ çš„å¼å­å°±æ˜¯å„ä¸ªç‚¹çš„æƒå€¼ã€‚</p><p>åœ¨æ’å€¼æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨ä¸–ç•Œç©ºé—´ / æ‘„åƒæœºç©ºé—´åšæ’å€¼ï¼Œå³åœ¨ viewing transformation å‰è¿›è¡Œæ’å€¼ï¼Œè€Œä¸æ˜¯ viewing transformation åã€‚</p><p>ä½†æˆ‘ä»¬ä¸€èˆ¬åœ¨å…‰æ …åŒ–æ—¶æ‰è¿›è¡Œæ’å€¼ï¼Œè¿™æ—¶å·²ç»æŠŠç‰©ä½“å˜æ¢åˆ°äº† NDC ç©ºé—´ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜è¦è¿›è¡Œé€è§†çŸ«æ­£ã€‚å…¬å¼å¦‚ä¸‹ï¼Œå…·ä½“æ¨å¯¼å¯ä»¥å‚è€ƒ Homework 3 çš„ç¬”è®°ã€‚</p><script type="math/tex; mode=display">\begin{align*}&\alpha = \frac{\alpha' / w_0}{\alpha' / w_0 + \beta' / w_1 + \gamma' / w_2}\\&\beta= \frac{\beta' / w_1}{\alpha' / w_0 + \beta' / w_1 + \gamma' / w_2}\\&\gamma= \frac{\gamma' / w_2}{\alpha' / w_0 + \beta' / w_1 + \gamma' / w_2}\end{align*}</script><p>å…¶ä¸­ $\alphaâ€™,\betaâ€™,\gammaâ€™$ æ˜¯å±å¹•ç©ºé—´çš„é‡å¿ƒåæ ‡ï¼Œ$\alpha,\beta,\gamma$ æ˜¯ä¸–ç•Œç©ºé—´çš„é‡å¿ƒåæ ‡ã€‚æˆ‘ä»¬ç”¨ä¸–ç•Œç©ºé—´çš„é‡å¿ƒåæ ‡ä½œä¸ºæƒé‡æ¥æ’å€¼ã€‚</p><p><img src="/images/learning/open-course/GAMES101/Notes/note3/shading-freq.png" alt=""></p><h1 id="æ¸²æŸ“ç®¡çº¿"><a href="#æ¸²æŸ“ç®¡çº¿" class="headerlink" title="æ¸²æŸ“ç®¡çº¿"></a>æ¸²æŸ“ç®¡çº¿</h1><p>æ¸²æŸ“æµç¨‹åŸºæœ¬å¦‚ä¸‹ï¼š</p><ol><li>Inputï¼šè¾“å…¥ 3D ä¸–ç•Œçš„é¡¶ç‚¹</li><li>Vertex Processingï¼šç”¨å„ç§å˜æ¢çŸ©é˜µæŠŠé¡¶ç‚¹å˜æ¢åˆ°å±å¹•ç©ºé—´</li><li>Triangle Processingï¼šæ ¹æ®ä¼ å…¥çš„é¡¶ç‚¹è¿æ¥æ–¹å¼åœ¨å±å¹•ç©ºé—´è¿æ¥ä¸‰è§’å½¢</li><li>Rasterizationï¼šæŠŠä¸‰è§’å½¢è½¬åŒ–æˆç‰‡å…ƒ / åƒç´ </li><li>Fragement Processingï¼šåº”ç”¨è´´å›¾ã€å…‰ç…§ç­‰</li><li>Framebuffer Operationsï¼šæ·±åº¦æµ‹è¯•ç­‰</li></ol><p><img src="/images/learning/open-course/GAMES101/Notes/note3/pipeline.png" alt=""></p><h1 id="çº¹ç†æ”¾å¤§å’Œçº¹ç†ç¼©å°"><a href="#çº¹ç†æ”¾å¤§å’Œçº¹ç†ç¼©å°" class="headerlink" title="çº¹ç†æ”¾å¤§å’Œçº¹ç†ç¼©å°"></a>çº¹ç†æ”¾å¤§å’Œçº¹ç†ç¼©å°</h1><p>åœ¨åšçº¹ç†æ˜ å°„æ—¶ï¼Œè´´å›¾å¤ªå°å’Œè´´å›¾å¤ªå¤§éƒ½ä¼šæœ‰é—®é¢˜ã€‚</p><p><img src="/images/learning/open-course/GAMES101/Notes/note3/mag-minification.png" alt=""></p><h2 id="çº¹ç†æ”¾å¤§"><a href="#çº¹ç†æ”¾å¤§" class="headerlink" title="çº¹ç†æ”¾å¤§"></a>çº¹ç†æ”¾å¤§</h2><p>è´´å›¾å¤ªå°æ—¶è¦åšçº¹ç†æ”¾å¤§ï¼Œå¯¹é‡‡æ ·ç‚¹åšåŒçº¿æ€§æ’å€¼å³å¯ã€‚</p><p><img src="/images/learning/open-course/GAMES101/Notes/note3/upsample.png" alt=""></p><h2 id="çº¹ç†ç¼©å°"><a href="#çº¹ç†ç¼©å°" class="headerlink" title="çº¹ç†ç¼©å°"></a>çº¹ç†ç¼©å°</h2><p>è´´å›¾å¤ªå¤§æ—¶ç›´è§‰ä¸Šæ¯”è´´å›¾å¤ªå°æ›´å¥½å¤„ç†ï¼Œä½†æ°æ°ç›¸åã€‚è¿˜è®°å¾—é¢‘è°±å—ï¼Œè´´å›¾å¤ªå¤§ä»£è¡¨é«˜é¢‘æœ‰æ›´å¤šä¿¡æ¯ï¼Œæˆ‘ä»¬ä¼šå› é‡‡æ ·é¢‘ç‡ä¸è¶³è€Œæ— æ³•æ­£ç¡®åæ˜ é«˜é¢‘ä¿¡æ¯ï¼Œå¯¼è‡´ç»“æœå‡ºç°é”¯é½¿ã€æ‘©å°”çº¹ç­‰èµ°æ ·é—®é¢˜ã€‚</p><p>æœ€å¸¸ç”¨çš„ç¼“è§£æ–¹æ³•æ˜¯ Mipmappingã€‚åŸºæœ¬æ€è·¯æ˜¯ï¼Œæˆ‘ä»¬åˆ†æå±å¹•ä¸Šæ¯ä¸ªåƒç´ åœ¨è´´å›¾ä¸Šè¦†ç›–çš„åƒç´ æ•°é‡ï¼Œå¯¹é‚£äº›è¦†ç›–è¾ƒå¤šçš„ï¼Œå°±è®©ä»–ä»¬å»è¢«ç¼©å°çš„è´´å›¾ä¸Šé‡‡æ ·ï¼Œè¿™æ ·å°±èƒ½ç¼“è§£æ¬ é‡‡æ ·é—®é¢˜ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬è¦åˆ›å»ºâ€œç¼©å°çš„è´´å›¾â€ï¼ŒMipmapé“¾åŒ…å«ä¸€ç³»åˆ—çº¹ç† $D_0, D_1, D_2, \ldots, D_N$ï¼Œå…¶ä¸­ $D_i$ çš„åˆ†è¾¨ç‡ä¸º $\frac{W}{2^i} \times \frac{H}{2^i}$ï¼Œç›´åˆ°æœ€å†…å±‚ä¸º $1 \times 1$ åƒç´ ã€‚</p><p>ç„¶åæˆ‘ä»¬è¦åˆ†æå•ä¸ªå±å¹•åƒç´ è¦†ç›–äº†å¤šå°‘çº¹ç†åƒç´ ï¼Œå¤§è‡´æ€è·¯æ˜¯è®¡ç®—å±å¹•ç©ºé—´çš„ç›¸é‚»ç‚¹æ˜ å°„åˆ°è´´å›¾ç©ºé—´åçš„è·ç¦»ã€‚è´´å›¾ç©ºé—´é‡Œç›¸é‚»åƒç´ è·ç¦»ä¸º $1$ï¼Œæ‰€ä»¥å¦‚æœå±å¹•ç©ºé—´çš„ç›¸é‚»ç‚¹æ˜ å°„åˆ°è´´å›¾ç©ºé—´åçš„è·ç¦»ä¸º $x$ï¼Œæˆ‘ä»¬å°±è®¤ä¸ºå®ƒè¦†ç›–äº† $x$ ä¸ªåƒç´ ã€‚</p><p>è¿™ä¸ªâ€œå•ä¸ªå±å¹•åƒç´ è¦†ç›–äº†å¤šå°‘çº¹ç†åƒç´ â€çš„ä¼°ç®—è¢«è®°ä½œ $\rho$ï¼Œå…¬å¼å¦‚ä¸‹ï¼š</p><script type="math/tex; mode=display">\rho = \max\left( \sqrt{\left(\frac{\partial u}{\partial x}\right)^2 + \left(\frac{\partial v}{\partial x}\right)^2}, \sqrt{\left(\frac{\partial u}{\partial y}\right)^2 + \left(\frac{\partial v}{\partial y}\right)^2} \right)</script><p>å– $\max$ æ˜¯ä¸ºäº†å°½å¯èƒ½å–å±‚çº§æ›´ä½çš„ Mipmapã€‚ä¸€ä¸ªå±å¹•åƒç´ è¦†ç›–çš„çº¹ç†åƒç´ è¶Šå¤šï¼Œå®ƒå¯¹åº”çš„ Mipmap å±‚çº§å°±è¶Šå°ã€‚æ€»ä¹‹ï¼Œæˆ‘ä»¬å®å¯æ¨¡ç³Šï¼Œä¹Ÿä¸è¦æ¬ é‡‡æ ·ã€‚</p><p>æœ€åç”¨ $\lambda = \log_2{\rho}$ å°±èƒ½ç®—å‡ºè¿™ä¸ªå±å¹•åƒç´ å¯¹åº”çš„çº¹ç†å±‚çº§ã€‚æ¯”å¦‚å½“ $\lambda = 0$ æ—¶ï¼Œè¡¨ç¤ºä¸€ä¸ªå±å¹•åƒç´ æ°å¥½å¯¹åº”ä¸€ä¸ªçº¹ç†åƒç´ ï¼Œåº”ä½¿ç”¨åŸå§‹çº¹ç† $D_0$.</p><p><img src="/images/learning/open-course/GAMES101/Notes/note3/downsample.png" alt=""></p><p>è®¡ç®—å‡ºå±‚çº§ $\lambda$ åè¿˜è¦åšé‡‡æ ·ã€‚æ˜¾ç„¶ $\lambda$ å¤§å¤šæ•°æ—¶å€™éƒ½ä¸æ˜¯æ•´æ•°ï¼Œæ‰€ä»¥æœ‰ä¸¤ç§å¸¸è§çš„é‡‡æ ·æ–¹æ³•ï¼š</p><ol><li><p>æœ€è¿‘é‚»Mipmapæ»¤æ³¢ï¼ˆNearest Mipmap Filteringï¼‰</p><p> é€‰æ‹©æœ€æ¥è¿‘ $\lambda$ çš„æ•´æ•°å±‚çº§ $d = \text{round}(\lambda)$ åšé‡‡æ ·ï¼Œåœ¨è¿™ä¸€å±‚å¯ä»¥æ˜¯æœ€è¿‘é‚»æˆ–åŒçº¿æ€§æ»¤æ³¢ã€‚</p></li><li><p>ä¸‰çº¿æ€§æ»¤æ³¢ï¼ˆTrilinear Filteringï¼‰</p><p> ç¡®å®š $\lambda$ ä¸¤ä¾§çš„ä¸¤ä¸ªæ•´æ•°å±‚çº§ï¼š$d_1 = \lfloor\lambda\rfloor$ å’Œ $d_2 = \lceil\lambda\rceil = d_1 + 1$ï¼Œåœ¨è¿™ä¸¤å±‚åˆ†åˆ«åšåŒçº¿æ€§æ»¤æ³¢é‡‡æ ·å¾—åˆ°é¢œè‰² $C_1$ å’Œ $C_2$ï¼Œç„¶åå¾—åˆ°æœ€ç»ˆé¢œè‰²</p><script type="math/tex; mode=display"> C = (1 - f) \cdot C_1 + f \cdot C_2</script><p> å…¶ä¸­ $f = \lambda - \lfloor\lambda\rfloor$ ä¸º $\lambda$ çš„å°æ•°éƒ¨åˆ†ã€‚</p></li></ol><h1 id="å…¶ä»–å°çŸ¥è¯†"><a href="#å…¶ä»–å°çŸ¥è¯†" class="headerlink" title="å…¶ä»–å°çŸ¥è¯†"></a>å…¶ä»–å°çŸ¥è¯†</h1><p>è™ä¹¦æåˆ°çš„planar projectionã€spherical coordinatesã€cylindrical coordinatesã€cubemapsæœ¬è´¨ä¸Šéƒ½æ˜¯æŠŠ3dè¡¨é¢æŠ•å½±åˆ°ä¸€ä¸ªç†æƒ³çš„ç®€å•å‡ ä½•ä½“ä¸Šï¼Œç„¶åæŠŠç®€å•å‡ ä½•ä½“å±•å¼€æˆå¹³é¢ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;×™Ö°×”Ö´×™-××•Ö¹×¨&quot;&gt;&lt;a href=&quot;#×™Ö°×”Ö´×™-××•Ö¹×¨&quot; class=&quot;headerlink&quot; title=&quot;×™Ö°×”Ö´×™ ××•Ö¹×¨&quot;&gt;&lt;/a&gt;×™Ö°×”Ö´×™ ××•Ö¹×¨&lt;/h1&gt;&lt;p&gt;èµ·åˆï¼Œè®¡ç®—æœºçš„ä¸–ç•Œå°šæœªæ¸²æŸ“ï¼Œæ˜¾ç¤ºå™¨ä¸­ç©ºè™šæ··æ²Œï¼Œæ¸Šé¢é»‘æš—ã€‚&lt;/p&gt;
&lt;p&gt;å”¯æœ‰</summary>
      
    
    
    
    <category term="å…¬å¼€è¯¾" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/"/>
    
    <category term="GAMES101" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/GAMES101/"/>
    
    <category term="Notes" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/GAMES101/Notes/"/>
    
    
  </entry>
  
  <entry>
    <title>Assignment 3 Pipeline and Shading</title>
    <link href="http://rinevard.github.io/wiki/learning/open-course/GAMES101/Hw/Hw3-pipeline-and-shading/"/>
    <id>http://rinevard.github.io/wiki/learning/open-course/GAMES101/Hw/Hw3-pipeline-and-shading/</id>
    <published>2025-09-13T11:45:16.000Z</published>
    <updated>2025-09-13T12:04:25.374Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬æ¬¡ä½œä¸šå¯¹ bump_fragment_shaderã€displacement_fragment_shader çš„è¦æ±‚éå¸¸ä¸ä¸¥è°¨ï¼Œè‡³å°‘åŒ…æ‹¬è¿™äº›é—®é¢˜ï¼š</p><ol><li>è¿™ä¸¤ä¸ª shdaer éœ€è¦çš„è´´å›¾æ˜¯å‡¹å‡¸è´´å›¾ï¼Œå‡¹å‡¸è´´å›¾æœ¬åº”è¯¥æ˜¯ç°åº¦å›¾ï¼Œè¿™é‡Œä½¿ç”¨ RGB è´´å›¾ã€‚</li><li>åœ¨è®¡ç®—åˆ‡çº¿ç©ºé—´åˆ°ä¸–ç•Œç©ºé—´çš„å˜æ¢çŸ©é˜µ TBN æ—¶ä½¿ç”¨äº†é”™è¯¯çš„å…¬å¼ã€‚æ­£ç¡®çš„å…¬å¼éœ€è¦çŸ¥é“ä¸‰è§’å½¢çš„ä¸‰ä¸ªé¡¶ç‚¹åŠå…¶ UV åæ ‡ã€‚</li><li>displacement æ–¹æ³•æ²¡æœ‰åœ¨å…‰æ …åŒ–å‰åç§»é¡¶ç‚¹ä½ç½®ï¼Œè€Œåªè°ƒæ•´äº†æ˜¾ç¤ºé¢œè‰²ã€‚</li></ol><p>æˆ‘ä»¬å…ˆä»‹ç»ä¸€ä¸‹ TBN çš„æ­£ç¡®è®¡ç®—æ–¹å¼å’Œä» bump texture ç®—å‡ºæ¢¯åº¦çš„æ–¹æ³•ï¼Œå†ä¾æ¬¡ä»‹ç»ä¸€ä¸‹å„ä¸ªä½œä¸šçš„åšæ³•ã€‚</p><h1 id="TBNçš„æ­£ç¡®è®¡ç®—æ–¹å¼"><a href="#TBNçš„æ­£ç¡®è®¡ç®—æ–¹å¼" class="headerlink" title="TBNçš„æ­£ç¡®è®¡ç®—æ–¹å¼"></a>TBNçš„æ­£ç¡®è®¡ç®—æ–¹å¼</h1><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ä»€ä¹ˆæ˜¯ TBN ä»¥åŠä¸ºä»€ä¹ˆéœ€è¦ TBN. ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬å…ˆè€ƒè™‘æ³•çº¿è´´å›¾ã€‚ä¸‹æ–‡æŠŠä¸–ç•Œç©ºé—´é‡ŒæŒ‰æ³•çº¿è´´å›¾ä¿®æ­£åçš„æ³•çº¿ç§°ä½œâ€œ<strong>ä¿®æ­£æ³•çº¿</strong>â€ï¼ŒæŠŠä¸–ç•Œç©ºé—´é‡Œä¿®æ­£å‰çš„æ³•çº¿ç§°ä½œâ€œ<strong>å‡ ä½•æ³•çº¿</strong>â€ï¼Œè¿™é‡Œé»˜è®¤å®ƒä»¬éƒ½æ˜¯å½’ä¸€åŒ–çš„ã€‚</p><p>è€ƒè™‘ä¸–ç•Œç©ºé—´çš„æŸä¸€ç‚¹ $Q$ï¼Œå‡è®¾å®ƒåœ¨æ³•çº¿è´´å›¾ä¸­å¯¹åº”çš„ä¸€ç‚¹ä¸º $Qâ€™$ï¼Œæˆ‘ä»¬çŸ¥é“ç‚¹ $Qâ€™$ å¯¹åº”çš„æ³•çº¿è¢«ç”¨äºè®¡ç®—ä¸–ç•Œç©ºé—´ç‚¹ $Q$ çš„ä¿®æ­£æ³•çº¿ã€‚ä½†ç­‰ç­‰ï¼Œç›´æ¥æŠŠ RGB å€¼å¤åˆ¶è¿‡å»çœ‹èµ·æ¥æ˜¯é”™è¯¯çš„ï¼Œå› ä¸ºéšç€ç‰©ä½“è½¬åŠ¨ï¼Œç‚¹ $Q$ å¯¹åº”çš„æ³•çº¿ä¹Ÿåº”å½“è½¬åŠ¨ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªçŸ©é˜µæ¥å®ç°è¿™ç§ä»æ³•çº¿è´´å›¾ä¸Šçš„æ³•çº¿åˆ°ä¸–ç•Œç©ºé—´çš„ä¿®æ­£æ³•çº¿çš„å˜æ¢ã€‚</p><p>è´´å›¾æ˜¯äºŒç»´çš„ï¼Œå› æ­¤æˆ‘ä»¬å†é¢å¤–å®šä¹‰ä¸€ä¸ªå‚ç›´çº¸é¢å‘å¤–çš„è½´ $n$ï¼Œå®ƒè¡¨ç¤ºæ³•çº¿çš„â€œé»˜è®¤æ–¹å‘â€ï¼Œè¿™å°±å¾—åˆ°äº†ä¸‰ç»´çš„<strong>åˆ‡çº¿ç©ºé—´</strong>ã€‚å¦‚æœç‚¹ $Qâ€™$ å¯¹åº”çš„æ³•çº¿æ˜¯ $(0,0,1)$ï¼Œé‚£ä¹ˆä¸–ç•Œç©ºé—´çš„ç‚¹ $Q$ çš„ä¿®æ­£æ³•çº¿å°±æ˜¯åŸæœ¬çš„å‡ ä½•æ³•çº¿ã€‚</p><p>æ¥ä¸‹æ¥å°±è¦è€ƒè™‘å¦‚ä½•æ‰¾åˆ°è¿™ä¸ªä»åˆ‡çº¿ç©ºé—´åˆ°ä¸–ç•Œç©ºé—´çš„æ—‹è½¬çŸ©é˜µäº†ã€‚ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬å…ˆè€ƒè™‘å•ä¸ªä¸‰è§’å½¢çš„æ—‹è½¬ã€‚ä¹‹åæˆ‘ä»¬ä¼šå¯¹æ¯ä¸ªç‚¹æ±‚å‡ºå®ƒè‡ªå·±çš„æ—‹è½¬çŸ©é˜µã€‚æ²¡é”™ï¼Œæ¯ä¸ªç‚¹çš„æ—‹è½¬çŸ©é˜µä¸åŒï¼Œè¿™æ˜¯å› ä¸ºæ¯ä¸ªç‚¹å¯¹åº”çš„çŸ©é˜µä¼šæŠŠ $(0,0,1)$ æ˜ å°„åˆ°è¯¥ç‚¹çš„å‡ ä½•æ³•çº¿ï¼Œè€Œæ¯ä¸ªç‚¹çš„å‡ ä½•æ³•çº¿ä¸€èˆ¬ä¸åŒã€‚</p><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬å¸Œæœ›æŠŠæ³•çº¿è´´å›¾ä¸Šçš„ $P_0â€™P_1â€™P_2â€™$ æ—‹è½¬ä¸ºä¸–ç•Œç©ºé—´çš„ $P_0P_1P_2$ï¼Œè®¾è¿™é‡Œçš„æ—‹è½¬çŸ©é˜µä¸º $M$ï¼Œä¸–ç•Œç©ºé—´çš„ $P_0P_1P_2$ çš„å‡ ä½•æ³•çº¿ä¸º $\mathbf{n}$ï¼Œåˆ™æœ‰</p><script type="math/tex; mode=display">\begin{align*}&M[0,0,1]^T=\mathbf n\end{align*}</script><p><img src="/images/learning/open-course/GAMES101/Assignments/hw3/tangent-world-space.png" alt=""></p><p>ä½†å…‰é è¿™ä¸€ä¸ªæ–¹ç¨‹å½“ç„¶è§£ä¸å‡º $M$ï¼Œæ‰€ä»¥æˆ‘ä»¬å†è€ƒè™‘ä¸¤ä¸ªé¢å¤–çš„æ–¹ç¨‹ï¼š</p><script type="math/tex; mode=display">\begin{align*}&M (P_1'-P_0')=k(P_1-P_0)\\&M (P_2'-P_0')=k(P_2-P_0)\end{align*}</script><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¸Œæœ›è¿™ä¸ªçŸ©é˜µæŠŠåˆ‡çº¿ç©ºé—´ä¸‰è§’å½¢çš„è¾¹å‘é‡æ—‹è½¬åˆ°ä¸–ç•Œç©ºé—´çš„è¾¹å‘é‡ä¸Šï¼Œè¿™çœ‹èµ·æ¥æ˜¯ä¸€ä¸ªåˆç†çš„è¦æ±‚ã€‚è¿™é‡Œçš„ $k$ æ˜¯è¾¹çš„é•¿åº¦çš„ç¼©æ”¾æ¯”ä¾‹ï¼Œä¸¥æ ¼æ¥è¯´æ¯æ¡è¾¹çš„ç¼©æ”¾æ¯”ä¾‹ä¸ä¸€å®šç›¸ç­‰ï¼Œä½†åªè¦ UV æ˜ å°„å‰åçš„ä¸‰è§’å½¢å¤§ä½“æ˜¯ç›¸ä¼¼ä¸‰è§’å½¢ï¼Œæˆ‘ä»¬å°±å¯ä»¥è®¤ä¸ºç¼©æ”¾æ¯”ä¾‹éƒ½ä¸º $k$.</p><p>ä¸‹é¢æˆ‘ä»¬æ¥è§£æ–¹ç¨‹ã€‚é¦–å…ˆæˆ‘ä»¬è®¾</p><script type="math/tex; mode=display">\begin{align*}&M=\begin{pmatrix}  T & B & N\end{pmatrix}\\&P_1'-P_0'= [\Delta u_1,\Delta v_1,0]^T\\&P_2'-P_0'= [\Delta u_2,\Delta v_2,0]^T\end{align*}</script><p>ä¸‹é¢ä¸¤ä¸ªå¼å­åˆ©ç”¨äº† $P_kâ€™$ çš„ç¬¬ä¸‰ä¸ªåˆ†é‡ä¸º $0$ çš„æ€§è´¨ã€‚</p><p>ç»“åˆç¬¬ä¸€ä¸ªæ–¹ç¨‹å°±èƒ½å¾—åˆ° $N=\mathbf n$ï¼Œè¿™é‡Œçš„ $\mathbf n$ è¡¨ç¤ºä¸–ç•Œç©ºé—´çš„ $P_0P_1P_2$ çš„å‡ ä½•æ³•çº¿ã€‚å†ç»“åˆå¦å¤–ä¸¤ä¸ªæ–¹ç¨‹å°±èƒ½å¾—åˆ°</p><script type="math/tex; mode=display">\begin{align*}&\Delta u_1 T+\Delta v_1 B=k(P_1-P_0)\\&\Delta u_2 T+\Delta v_2 B=k(P_2-P_0)\end{align*}</script><p>ä¹‹åæˆ‘ä»¬å¯ä»¥è§£å‡º $T,B,N$ çš„å€¼</p><script type="math/tex; mode=display">\begin{align*}&T=k\frac{\Delta v_2(P_1-P_0)-\Delta v_1(P_2-P_0)}{\Delta u_1 \Delta v_2-\Delta u_2 \Delta v_1}\\&B=k\frac{\Delta u_2(P_1-P_0)-\Delta u_1(P_2-P_0)}{\Delta u_2 \Delta v_1-\Delta u_1 \Delta v_2}\\&N=\mathbf n\end{align*}</script><p>è¿™ä¸ªå…¬å¼æ˜¯ä¸èƒ½ç”¨çš„ï¼Œå› ä¸ºé‡Œé¢æœ‰æœªçŸ¥æ•° $k$. æ¥ä¸‹æ¥æˆ‘ä»¬è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><p>æˆ‘ä»¬æœŸæœ› TBN çŸ©é˜µæ˜¯ä¸€ä¸ªæ—‹è½¬çŸ©é˜µï¼Œè€Œæ—‹è½¬çŸ©é˜µæ˜¯æ­£äº¤çŸ©é˜µï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šå¯¹ TBN åšæ–½å¯†ç‰¹æ­£äº¤åŒ–å’Œå½’ä¸€åŒ–ã€‚åªè¦ $P_0P_1P_2$ å’Œ $P_0â€™P_1â€™P_2â€™$ å¤§ä½“æ˜¯ç›¸ä¼¼ä¸‰è§’å½¢ï¼Œé‚£ä¹ˆå®ƒä»¬æœ¬æ¥å°±å·®ä¸å¤šæ­£äº¤ï¼ˆå›é¡¾æˆ‘ä»¬å¯¹ TBN çš„å®šä¹‰ï¼Œä¼šå‘ç°ç›¸ä¼¼è¯´æ˜ TBN åªå¯¹ $P_0â€™P_1â€™P_2â€™$ åšäº†æ—‹è½¬å’Œç¼©æ”¾ï¼Œè¿™è¡¨æ˜ TBN æ­£äº¤ï¼‰ï¼Œæ‰€ä»¥è¿™ç§æ­£äº¤åŒ–ä¸ä¼šæŠŠ TBN å˜åŒ–å¤ªå¤šã€‚è€Œç”±äºæˆ‘ä»¬ä¼šå¯¹ TBN åšå•ä½åŒ–ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ”¾å¿ƒåœ°ä»¤ $k=1$ æ¥ç”¨ä¸‹é¢çš„å…¬å¼æ±‚å‡º TBNï¼š</p><script type="math/tex; mode=display">\begin{align*}&T=\frac{\Delta v_2(P_1-P_0)-\Delta v_1(P_2-P_0)}{\Delta u_1 \Delta v_2-\Delta u_2 \Delta v_1}\\&B=\frac{\Delta u_2(P_1-P_0)-\Delta u_1(P_2-P_0)}{\Delta u_2 \Delta v_1-\Delta u_1 \Delta v_2}\\&N=\mathbf{n}\end{align*}</script><p>æœ€åï¼Œæˆ‘ä»¬å¸Œæœ› N åœ¨æ­£äº¤åŒ–å‰åä¸å˜ï¼Œæ‰€ä»¥åœ¨æ­£äº¤åŒ–åæˆ‘ä»¬æœ‰</p><script type="math/tex; mode=display">\begin{align*}&T'=T-(N\cdot T)N\\&B'=B-(N\cdot B)N-(T'\cdot B)T'/T'^2\\&N'=\mathbf n\end{align*}</script><p>å†åšä¸ªå•ä½åŒ–å°±èƒ½å¾—åˆ°é¡¶ç‚¹çš„ TBN çŸ©é˜µäº†ã€‚è¿˜è®°å¾— TBN çŸ©é˜µæ˜¯åšä»€ä¹ˆçš„å—ï¼Œæˆ‘ä»¬ç”¨å®ƒæ¥å®ç°ä»åˆ‡çº¿ç©ºé—´åˆ°ä¸–ç•Œç©ºé—´çš„å˜æ¢ã€‚æ‰€ä»¥å¯¹ç‚¹ $Q$ï¼Œå‡è®¾å…¶æ³•çº¿è´´å›¾å¯¹åº”çš„æ³•çº¿ä¸º $\mathbf nâ€™$ï¼Œé‚£ä¹ˆä¿®æ­£åçš„æ³•çº¿å°±æ˜¯ $M_{\text{TBN}}\mathbf nâ€™$.</p><p>å¾ˆå¥½ï¼Œæˆ‘ä»¬ç°åœ¨èƒ½æŠŠå•ä¸ªä¸‰è§’å½¢åšå˜æ¢äº†ï¼Œä½†åœ¨çœŸæ­£çš„æ¨¡å‹ä¸­ï¼Œæ¯ä¸ªç‚¹çš„å‡ ä½•æ³•çº¿æ–¹å‘ä¸€èˆ¬éƒ½ä¸åŒï¼Œè¿™å°±æ„å‘³ç€å®ƒä»¬ä¸€èˆ¬éƒ½æœ‰ä¸åŒçš„ TBN çŸ©é˜µã€‚ä¸è®¡ç®—é¡¶ç‚¹æ³•çº¿ç±»ä¼¼ï¼Œæˆ‘ä»¬ä¼šæ‰¾åˆ°æ¯ä¸ªé¡¶ç‚¹ç›¸é‚»çš„æ‰€æœ‰ä¸‰è§’å½¢ï¼Œå¹¶å¯¹å®ƒä»¬çš„ $T$ å’Œ $B$ åšåŠ æƒå¹³å‡æ¥å¾—åˆ°è¿™ä¸ªé¡¶ç‚¹çš„ $T$ å’Œ $B$.</p><p>åœ¨å®è·µä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬åªè®¡ç®—å‡ºæ¯ä¸ªé¡¶ç‚¹çš„ $T$ï¼Œç„¶ååœ¨éœ€è¦ $B$ æ—¶é€šè¿‡å‰ä¹˜ $N\times T$ æ¥è®¡ç®—ã€‚å¯¹é‚£äº›éé¡¶ç‚¹çš„ç‚¹ï¼Œæˆ‘ä»¬ç”¨é‡å¿ƒåæ ‡æ’å€¼æ¥ç®—å‡ºå…¶ $N$ å’Œ $T$ï¼Œç„¶åä¹Ÿåšæ­£äº¤åŒ–å’Œå•ä½åŒ–æ¥ä¿è¯ TBN çŸ©é˜µçš„æ­£äº¤æ€§ã€‚</p><p>æœ€åæˆ‘ä»¬å†ç®€å•åˆ†æä¸€ä¸‹æ€ä¹ˆæ ¹æ®å‡¹å‡¸è´´å›¾åšæ³•çº¿ä¿®æ­£ã€‚åœ¨ä¿®æ­£æ³•çº¿æ—¶ï¼Œå‡¹å‡¸è´´å›¾ä¸æ³•çº¿è´´å›¾çš„å”¯ä¸€åŒºåˆ«å°±æ˜¯æ²¡æœ‰ç›´æ¥ç»™å‡ºæ³•çº¿ã€‚å›é¡¾ä¸€ä¸‹åˆ‡çº¿ç©ºé—´çš„å®šä¹‰ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç»™å‡¹å‡¸è´´å›¾åŒæ ·è®¾ç½®æ²¿çº¸é¢å‘å¤–çš„ $n$ è½´ï¼Œç„¶åæŠŠå‡¹å‡¸è´´å›¾æƒ³è±¡æˆä¸€ä¸ªæŒ‰ç°åº¦å€¼èµ·ä¼çš„æ›²é¢ï¼Œè¿™ä¸ªæ›²é¢çš„æ³•çº¿å°±å’Œæ³•çº¿è´´å›¾æä¾›çš„æ³•çº¿ç›¸å¯¹åº”ã€‚</p><p>å…·ä½“æ¥è¯´ï¼Œç‚¹ $(u,v)$ å¤„çš„æ³•çº¿å¯ä»¥ç”¨ $(h(u)-h(u+1,v),h(v)-h(u,v+1),1)$ æ¥è¿‘ä¼¼ï¼Œå…¶ä¸­ $h(u,v)$ è¡¨ç¤ºå‡¹å‡¸è´´å›¾åœ¨ç‚¹ $(u,v)$ å¤„çš„ç°åº¦å€¼ï¼Œ$h(u+1,v)$ è¡¨ç¤º $(u,v)$ å³è¾¹ä¸€æ ¼çš„ç°åº¦å€¼ã€‚</p><p>æœ‰æ—¶ç”±äºæˆ‘ä»¬æŠŠè´´å›¾åšäº†å½’ä¸€åŒ–ï¼Œæˆ‘ä»¬ä¼šæ”¹ç”¨ $h(u+1/\text{width},v)$ï¼Œä½†è®°ä½å®ƒè¡¨ç¤ºç›¸é‚»æ ¼å­çš„ç°åº¦å€¼å°±è¡Œã€‚</p><p>æœ€åæŠŠè¿™ä¸ªæ³•çº¿å’Œ TBN çŸ©é˜µç›¸ä¹˜å³å¯å¾—åˆ°ä¿®æ­£æ³•çº¿ã€‚</p><p>å‚è€ƒ <a href="https://terathon.com/blog/tangent-space.html">Computing Tangent Space Basis Vectors for an Arbitrary Mesh - Eric Lengyel</a></p><h1 id="ä½œä¸šä»£ç "><a href="#ä½œä¸šä»£ç " class="headerlink" title="ä½œä¸šä»£ç "></a>ä½œä¸šä»£ç </h1><h2 id="rasterize-triangle"><a href="#rasterize-triangle" class="headerlink" title="rasterize_triangle"></a>rasterize_triangle</h2><p>æ³¨æ„è¿™é‡Œçš„æ’å€¼ç®—æ³•è¦å¯¹æ‰€æœ‰çš„å±æ€§éƒ½åšé€è§†çŸ«æ­£ï¼Œæˆ‘ä»¬ç®€å•æ¨å¯¼ä¸€ä¸‹é€è§†çŸ«æ­£çš„å…¬å¼ï¼š</p><p>å‡è®¾æˆ‘ä»¬åœ¨å¯¹ç‚¹ $Q$ çš„æŸä¸ªå±æ€§è¿›è¡Œæ’å€¼ï¼Œåœ¨ä¸–ç•Œç©ºé—´ä¸­ï¼Œå®ƒæ‰€åœ¨çš„ä¸‰è§’å½¢ä¸º $P_0P_1P_2$. æŠ•å½±å˜æ¢åï¼Œå®ƒä»¬åˆ†åˆ«å˜æˆäº† $Qâ€™$ å’Œ $P_0â€™P_1â€™P_2â€™$. ç”¨é‡å¿ƒåæ ‡åˆ†åˆ«è¡¨ç¤º $Q$ å’Œ $Qâ€™$ï¼Œä¼šå¾—åˆ°</p><script type="math/tex; mode=display">\begin{align*}&Q=\alpha P_0+\beta P_1+\gamma P_2\\&Q'=\alpha' P_0'+\beta' P_1'+\gamma' P_2'\end{align*}</script><p>è¿™é‡Œçš„ $Q,Qâ€™,P_k,P_kâ€™$ éƒ½æ˜¯å½¢å¦‚ $[x,y,z,1]^T$ çš„å‘é‡ã€‚</p><p>åœ¨æ’å€¼å±æ€§æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›ç”¨ $\alpha, \beta,\gamma$ æ¥æ’å€¼ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ $\alphaâ€™, \betaâ€™,\gammaâ€™$ æ’å€¼ï¼Œå› ä¸ºæˆ‘ä»¬å½“ç„¶ä¸å¸Œæœ›å±æ€§ä¼šå› é€è§†ä½ç½®ä¸åŒè€Œä¸åŒã€‚è¿™å°±éœ€è¦æˆ‘ä»¬æ ¹æ® $\alphaâ€™, \betaâ€™,\gammaâ€™$ ç®—å‡º $\alpha, \beta,\gamma$.</p><p>ä¸å¦¨è®¾æŠ•å½±å˜æ¢çŸ©é˜µä¸º $M$ï¼Œåˆ™æœ‰ </p><script type="math/tex; mode=display">\begin{align*}&MQ=\alpha MP_0+\beta MP_1+\gamma MP_2\end{align*}</script><p>è¿™é‡Œçš„ $MP_k$ æ˜¯å½¢å¦‚ $[x_k,y_k,z_k,w_k]^T$ çš„ç”¨é½æ¬¡åæ ‡è¡¨ç¤ºçš„å‘é‡ï¼Œå®ƒä¸å½¢å¦‚ $[x,y,z,1]^T$ çš„ $P_kâ€™$ è™½ç„¶åœ¨æ•°å­¦ä¸Šè¡¨ç¤ºåŒä¸€ä¸ªç‚¹ï¼Œä½†åœ¨æ•°å€¼ä¸Šä¸åŒã€‚ï¼ˆè¿˜è®°å¾—å—ï¼Œé½æ¬¡åæ ‡ä¸‹çš„ $[x,y,z,1<br>]$ å’Œ $[ax,ay,az,a]$ è¡¨ç¤ºåŒä¸€ä¸ªç‚¹ï¼‰</p><p>å› æ­¤æˆ‘ä»¬å¸Œæœ›å¯¹å‘é‡çš„ç³»æ•°åšä¸€äº›è°ƒæ•´ï¼Œæ¥è®©å„ä¸ªå‘é‡å˜æˆ $[x,y,z,1]^T$ çš„å½¢å¼ï¼Œä»è€Œæ‰¾å‡º $\alphaâ€™, \betaâ€™,\gammaâ€™$ å’Œ $\alpha, \beta,\gamma$ çš„å…³ç³»ã€‚</p><p> ç®€å•å˜æ¢ä¸€ä¸‹ï¼Œæˆ‘ä»¬èƒ½æŠŠä¸Šé¢çš„å¼å­å†™æˆ</p><script type="math/tex; mode=display">\begin{align*}&MQ=\alpha w_0\frac{MP_0}{w_0}+\beta w_1\frac{MP_1}{w_1}+\gamma w_2\frac{MP_2}{w_2}\end{align*}</script><p>ç°åœ¨å³è¾¹çš„å„ä¸ªå‘é‡ $\frac{MP_k}{w_k}$ éƒ½å·²ç»æ˜¯ $[x,y,z,1]^T$ çš„å½¢å¼äº†ï¼Œæˆ‘ä»¬ç»™å®ƒä»¬çš„ç³»æ•°åšä¸ªå½’ä¸€åŒ–å°±èƒ½è®©å·¦è¾¹çš„å‘é‡ä¹Ÿå˜æˆ $[x,y,z,1]^T$ çš„å½¢å¼ï¼š</p><script type="math/tex; mode=display">\frac{MQ}{\alpha w_0 + \beta w_1 + \gamma w_2}=\frac{1}{\alpha w_0 + \beta w_1 + \gamma w_2}\bigg(\alpha w_0\frac{MP_0}{w_0}+\beta w_1\frac{MP_1}{w_1}+\gamma w_2\frac{MP_2}{w_2}\bigg)</script><p>ç”±æ­¤æˆ‘ä»¬å°±æœ‰</p><script type="math/tex; mode=display">\begin{align*}&\frac{\alpha w_0}{\alpha w_0 + \beta w_1 + \gamma w_2}=\alpha'\\&\frac{\beta w_1}{\alpha w_0 + \beta w_1 + \gamma w_2}=\beta'\\&\frac{\gamma w_2}{\alpha w_0 + \beta w_1 + \gamma w_2}=\gamma'\end{align*}</script><p>è§£ä¸Šé¢çš„æ–¹ç¨‹çš„å°æŠ€å·§æ˜¯å€ŸåŠ©é™¤æ³•å’Œé‡å¿ƒåæ ‡å’Œä¸º $1$ çš„æ€§è´¨å¾—åˆ°ä¸‹é¢çš„ç­‰ä»·çš„æ–¹ç¨‹ç»„</p><script type="math/tex; mode=display">\begin{align*}&\frac{\alpha'}{\beta'}=\frac{\alpha w_0}{\beta w_1}\\&\frac{\alpha'}{\gamma'}=\frac{\alpha w_0}{\gamma w_2}\\&\alpha + \beta + \gamma = 1\end{align*}</script><p>ç„¶åå°±èƒ½æ±‚å‡º</p><script type="math/tex; mode=display">\begin{align*}&\alpha = \frac{\alpha' / w_0}{\alpha' / w_0 + \beta' / w_1 + \gamma' / w_2}\\&\beta= \frac{\beta' / w_1}{\alpha' / w_0 + \beta' / w_1 + \gamma' / w_2}\\&\gamma= \frac{\gamma' / w_2}{\alpha' / w_0 + \beta' / w_1 + \gamma' / w_2}\end{align*}</script><p>ç”±æ­¤ï¼Œæˆ‘ä»¬å°±ä»å±å¹•ç©ºé—´çš„é‡å¿ƒåæ ‡ $\alphaâ€™,\betaâ€™,\gammaâ€™$ ç®—å‡ºäº†ä¸–ç•Œç©ºé—´çš„é‡å¿ƒåæ ‡ $\alpha,\beta,\gamma$ï¼Œä¹‹åå°±èƒ½ç”¨ä¸–ç•Œç©ºé—´çš„é‡å¿ƒåæ ‡æ¥æ­£ç¡®æ’å€¼äº†ã€‚</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//Screen space rasterization</span><span class="token keyword">void</span> rst<span class="token double-colon punctuation">::</span>rasterizer<span class="token double-colon punctuation">::</span><span class="token function">rasterize_triangle</span><span class="token punctuation">(</span><span class="token keyword">const</span> Triangle<span class="token operator">&amp;</span> t<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>array<span class="token operator">&lt;</span>Eigen<span class="token double-colon punctuation">::</span>Vector3f<span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">></span><span class="token operator">&amp;</span> view_pos<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">auto</span> v <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">toVector4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// Find bounding box</span>    <span class="token keyword">float</span> left <span class="token operator">=</span> v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">float</span> right <span class="token operator">=</span> v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">float</span> bottom <span class="token operator">=</span> v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">float</span> top <span class="token operator">=</span> v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> vec<span class="token operator">:</span> v<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        left <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> vec<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        right <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span>right<span class="token punctuation">,</span> vec<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        bottom <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span>bottom<span class="token punctuation">,</span> vec<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        top <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span>top<span class="token punctuation">,</span> vec<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// Update pixels in bounding box</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span> x <span class="token operator">&lt;=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>right<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> y <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>bottom<span class="token punctuation">)</span><span class="token punctuation">;</span> y <span class="token operator">&lt;=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>top<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> y<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">auto</span><span class="token punctuation">[</span>alpha<span class="token punctuation">,</span> beta<span class="token punctuation">,</span> gamma<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">computeBarycentric2D</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> t<span class="token punctuation">.</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// If (x, y) is not inside triangle, continue</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>alpha <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> beta <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> gamma <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">// Interpolate z value, color, normal, texcoords, shadingcoords, viewpos</span>            <span class="token keyword">float</span> alpha_corrected <span class="token operator">=</span> alpha <span class="token operator">/</span> v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">float</span> beta_corrected <span class="token operator">=</span> beta <span class="token operator">/</span> v<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">float</span> gamma_corrected <span class="token operator">=</span> gamma <span class="token operator">/</span> v<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">float</span> w_reciprocal <span class="token operator">=</span> alpha_corrected <span class="token operator">+</span> beta_corrected <span class="token operator">+</span> gamma_corrected<span class="token punctuation">;</span>            <span class="token keyword">auto</span> z_interpolated <span class="token operator">=</span> <span class="token function">interpolate</span><span class="token punctuation">(</span>alpha_corrected<span class="token punctuation">,</span> beta_corrected<span class="token punctuation">,</span> gamma_corrected<span class="token punctuation">,</span> v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> v<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> v<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> w_reciprocal<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">auto</span> color_interpolated <span class="token operator">=</span> <span class="token function">interpolate</span><span class="token punctuation">(</span>alpha_corrected<span class="token punctuation">,</span> beta_corrected<span class="token punctuation">,</span> gamma_corrected<span class="token punctuation">,</span> t<span class="token punctuation">.</span>color<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>color<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>color<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> w_reciprocal<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">auto</span> normal_interpolated <span class="token operator">=</span> <span class="token function">interpolate</span><span class="token punctuation">(</span>alpha_corrected<span class="token punctuation">,</span> beta_corrected<span class="token punctuation">,</span> gamma_corrected<span class="token punctuation">,</span> t<span class="token punctuation">.</span>normal<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>normal<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>normal<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> w_reciprocal<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">auto</span> texcoordes_interpolated <span class="token operator">=</span> <span class="token function">interpolate</span><span class="token punctuation">(</span>alpha_corrected<span class="token punctuation">,</span> beta_corrected<span class="token punctuation">,</span> gamma_corrected<span class="token punctuation">,</span> t<span class="token punctuation">.</span>tex_coords<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>tex_coords<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>tex_coords<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> w_reciprocal<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">auto</span> viewpos_interpolated <span class="token operator">=</span> <span class="token function">interpolate</span><span class="token punctuation">(</span>alpha_corrected<span class="token punctuation">,</span> beta_corrected<span class="token punctuation">,</span> gamma_corrected<span class="token punctuation">,</span> view_pos<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> view_pos<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> view_pos<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> w_reciprocal<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment">// A lower z-value means it is displayed in front</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>z_interpolated <span class="token operator">&lt;</span> depth_buf<span class="token punctuation">[</span>y <span class="token operator">*</span> width <span class="token operator">+</span> x<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                depth_buf<span class="token punctuation">[</span>y <span class="token operator">*</span> width <span class="token operator">+</span> x<span class="token punctuation">]</span> <span class="token operator">=</span> z_interpolated<span class="token punctuation">;</span>                fragment_shader_payload <span class="token function">payload</span><span class="token punctuation">(</span> color_interpolated<span class="token punctuation">,</span> normal_interpolated<span class="token punctuation">,</span> texcoordes_interpolated<span class="token punctuation">,</span> texture <span class="token operator">?</span> <span class="token operator">&amp;</span><span class="token operator">*</span>texture <span class="token operator">:</span> <span class="token keyword">nullptr</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>                payload<span class="token punctuation">.</span>view_pos <span class="token operator">=</span> viewpos_interpolated<span class="token punctuation">;</span>                <span class="token keyword">auto</span> pixel_color <span class="token operator">=</span> <span class="token function">fragment_shader</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">set_pixel</span><span class="token punctuation">(</span><span class="token function">Vector2i</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span> pixel_color<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="phong-å’Œ-texture"><a href="#phong-å’Œ-texture" class="headerlink" title="phong å’Œ texture"></a>phong å’Œ texture</h2><p>phong çš„ä»£ç æŒ‰ç€ phong æ¨¡å‹å®ç°å³å¯ã€‚texture çš„ä»£ç å‡ ä¹æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ã€‚</p><p>æˆ‘å”¯ä¸€å¥½å¥‡çš„åœ°æ–¹æ˜¯ä¸ºä»€ä¹ˆæœ«å°¾ä¹˜äº† 255.0fï¼Œéš¾é“å…‰ç…§æ¨¡å‹çš„å„ä¸ªæ•°å€¼å–å€¼éƒ½åœ¨ $(0,1)$ ä¹‹é—´ï¼Ÿä½†çœ‹å…‰å¼ºä¼¼ä¹åˆä¸æ˜¯è¿™æ ·ã€‚</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">Eigen<span class="token double-colon punctuation">::</span>Vector3f <span class="token function">phong_fragment_shader</span><span class="token punctuation">(</span><span class="token keyword">const</span> fragment_shader_payload<span class="token operator">&amp;</span> payload<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    Eigen<span class="token double-colon punctuation">::</span>Vector3f ka <span class="token operator">=</span> <span class="token class-name">Eigen</span><span class="token double-colon punctuation">::</span><span class="token function">Vector3f</span><span class="token punctuation">(</span><span class="token number">0.005</span><span class="token punctuation">,</span> <span class="token number">0.005</span><span class="token punctuation">,</span> <span class="token number">0.005</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Eigen<span class="token double-colon punctuation">::</span>Vector3f kd <span class="token operator">=</span> payload<span class="token punctuation">.</span>color<span class="token punctuation">;</span>    Eigen<span class="token double-colon punctuation">::</span>Vector3f ks <span class="token operator">=</span> <span class="token class-name">Eigen</span><span class="token double-colon punctuation">::</span><span class="token function">Vector3f</span><span class="token punctuation">(</span><span class="token number">0.7937</span><span class="token punctuation">,</span> <span class="token number">0.7937</span><span class="token punctuation">,</span> <span class="token number">0.7937</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">auto</span> l1 <span class="token operator">=</span> light<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">auto</span> l2 <span class="token operator">=</span> light<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span><span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>light<span class="token operator">></span> lights <span class="token operator">=</span> <span class="token punctuation">&#123;</span>l1<span class="token punctuation">,</span> l2<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    Eigen<span class="token double-colon punctuation">::</span>Vector3f amb_light_intensity<span class="token punctuation">&#123;</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    Eigen<span class="token double-colon punctuation">::</span>Vector3f eye_pos<span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">float</span> p <span class="token operator">=</span> <span class="token number">150</span><span class="token punctuation">;</span>    Eigen<span class="token double-colon punctuation">::</span>Vector3f color <span class="token operator">=</span> payload<span class="token punctuation">.</span>color<span class="token punctuation">;</span>    Eigen<span class="token double-colon punctuation">::</span>Vector3f point <span class="token operator">=</span> payload<span class="token punctuation">.</span>view_pos<span class="token punctuation">;</span>    Eigen<span class="token double-colon punctuation">::</span>Vector3f normal <span class="token operator">=</span> payload<span class="token punctuation">.</span>normal<span class="token punctuation">;</span>    Eigen<span class="token double-colon punctuation">::</span>Vector3f result_color <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    Eigen<span class="token double-colon punctuation">::</span>Vector3f ambient <span class="token operator">=</span> ka<span class="token punctuation">.</span><span class="token function">cwiseProduct</span><span class="token punctuation">(</span>amb_light_intensity<span class="token punctuation">)</span><span class="token punctuation">;</span>    result_color <span class="token operator">+=</span> ambient<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> light <span class="token operator">:</span> lights<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token comment">// TODO: For each light source in the code, calculate what the *ambient*, *diffuse*, and *specular* </span>        <span class="token comment">// components are. Then, accumulate that result on the *result_color* object.</span>        Eigen<span class="token double-colon punctuation">::</span>Vector3f vec_to_light <span class="token operator">=</span> light<span class="token punctuation">.</span>position <span class="token operator">-</span> point<span class="token punctuation">;</span>        Eigen<span class="token double-colon punctuation">::</span>Vector3f diffuse <span class="token operator">=</span> kd<span class="token punctuation">.</span><span class="token function">cwiseProduct</span><span class="token punctuation">(</span>light<span class="token punctuation">.</span>intensity <span class="token operator">/</span> vec_to_light<span class="token punctuation">.</span><span class="token function">squaredNorm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">MAX</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> normal<span class="token punctuation">.</span><span class="token function">normalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dot</span><span class="token punctuation">(</span>vec_to_light<span class="token punctuation">.</span><span class="token function">normalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Eigen<span class="token double-colon punctuation">::</span>Vector3f vec_to_eye <span class="token operator">=</span> eye_pos <span class="token operator">-</span> point<span class="token punctuation">;</span>        Eigen<span class="token double-colon punctuation">::</span>Vector3f h <span class="token operator">=</span> vec_to_light<span class="token punctuation">.</span><span class="token function">normalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> vec_to_eye<span class="token punctuation">.</span><span class="token function">normalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Eigen<span class="token double-colon punctuation">::</span>Vector3f specular <span class="token operator">=</span> ks<span class="token punctuation">.</span><span class="token function">cwiseProduct</span><span class="token punctuation">(</span>light<span class="token punctuation">.</span>intensity <span class="token operator">/</span> vec_to_light<span class="token punctuation">.</span><span class="token function">squaredNorm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token function">MAX</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> normal<span class="token punctuation">.</span><span class="token function">normalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dot</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span><span class="token function">normalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// The ambient component is only added once before the for loop</span>        result_color <span class="token operator">+=</span> <span class="token punctuation">(</span>diffuse <span class="token operator">+</span> specular<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> result_color <span class="token operator">*</span> <span class="token number">255.f</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">Eigen<span class="token double-colon punctuation">::</span>Vector3f <span class="token function">texture_fragment_shader</span><span class="token punctuation">(</span><span class="token keyword">const</span> fragment_shader_payload<span class="token operator">&amp;</span> payload<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    Eigen<span class="token double-colon punctuation">::</span>Vector3f texture_color <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>payload<span class="token punctuation">.</span>texture<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token comment">// TODO: Get the texture value at the texture coordinates of the current fragment</span>        texture_color <span class="token operator">=</span> payload<span class="token punctuation">.</span>texture<span class="token operator">-></span><span class="token function">getColor</span><span class="token punctuation">(</span>payload<span class="token punctuation">.</span>tex_coords<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> payload<span class="token punctuation">.</span>tex_coords<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    Eigen<span class="token double-colon punctuation">::</span>Vector3f ka <span class="token operator">=</span> <span class="token class-name">Eigen</span><span class="token double-colon punctuation">::</span><span class="token function">Vector3f</span><span class="token punctuation">(</span><span class="token number">0.005</span><span class="token punctuation">,</span> <span class="token number">0.005</span><span class="token punctuation">,</span> <span class="token number">0.005</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Eigen<span class="token double-colon punctuation">::</span>Vector3f kd <span class="token operator">=</span> texture_color <span class="token operator">/</span> <span class="token number">255.f</span><span class="token punctuation">;</span>    Eigen<span class="token double-colon punctuation">::</span>Vector3f ks <span class="token operator">=</span> <span class="token class-name">Eigen</span><span class="token double-colon punctuation">::</span><span class="token function">Vector3f</span><span class="token punctuation">(</span><span class="token number">0.7937</span><span class="token punctuation">,</span> <span class="token number">0.7937</span><span class="token punctuation">,</span> <span class="token number">0.7937</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">auto</span> l1 <span class="token operator">=</span> light<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">auto</span> l2 <span class="token operator">=</span> light<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span><span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>light<span class="token operator">></span> lights <span class="token operator">=</span> <span class="token punctuation">&#123;</span>l1<span class="token punctuation">,</span> l2<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    Eigen<span class="token double-colon punctuation">::</span>Vector3f amb_light_intensity<span class="token punctuation">&#123;</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    Eigen<span class="token double-colon punctuation">::</span>Vector3f eye_pos<span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">float</span> p <span class="token operator">=</span> <span class="token number">150</span><span class="token punctuation">;</span>    Eigen<span class="token double-colon punctuation">::</span>Vector3f color <span class="token operator">=</span> texture_color<span class="token punctuation">;</span>    Eigen<span class="token double-colon punctuation">::</span>Vector3f point <span class="token operator">=</span> payload<span class="token punctuation">.</span>view_pos<span class="token punctuation">;</span>    Eigen<span class="token double-colon punctuation">::</span>Vector3f normal <span class="token operator">=</span> payload<span class="token punctuation">.</span>normal<span class="token punctuation">;</span>    Eigen<span class="token double-colon punctuation">::</span>Vector3f result_color <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    Eigen<span class="token double-colon punctuation">::</span>Vector3f ambient <span class="token operator">=</span> ka<span class="token punctuation">.</span><span class="token function">cwiseProduct</span><span class="token punctuation">(</span>amb_light_intensity<span class="token punctuation">)</span><span class="token punctuation">;</span>    result_color <span class="token operator">+=</span> ambient<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> light <span class="token operator">:</span> lights<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token comment">// TODO: For each light source in the code, calculate what the *ambient*, *diffuse*, and *specular* </span>        <span class="token comment">// components are. Then, accumulate that result on the *result_color* object.</span>        Eigen<span class="token double-colon punctuation">::</span>Vector3f vec_to_light <span class="token operator">=</span> light<span class="token punctuation">.</span>position <span class="token operator">-</span> point<span class="token punctuation">;</span>        Eigen<span class="token double-colon punctuation">::</span>Vector3f diffuse <span class="token operator">=</span> kd<span class="token punctuation">.</span><span class="token function">cwiseProduct</span><span class="token punctuation">(</span>light<span class="token punctuation">.</span>intensity <span class="token operator">/</span> vec_to_light<span class="token punctuation">.</span><span class="token function">squaredNorm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">MAX</span><span class="token punctuation">(</span><span class="token number">0.0f</span><span class="token punctuation">,</span> normal<span class="token punctuation">.</span><span class="token function">normalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dot</span><span class="token punctuation">(</span>vec_to_light<span class="token punctuation">.</span><span class="token function">normalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Eigen<span class="token double-colon punctuation">::</span>Vector3f vec_to_eye <span class="token operator">=</span> eye_pos <span class="token operator">-</span> point<span class="token punctuation">;</span>        Eigen<span class="token double-colon punctuation">::</span>Vector3f h <span class="token operator">=</span> vec_to_light<span class="token punctuation">.</span><span class="token function">normalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> vec_to_eye<span class="token punctuation">.</span><span class="token function">normalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Eigen<span class="token double-colon punctuation">::</span>Vector3f specular <span class="token operator">=</span> ks<span class="token punctuation">.</span><span class="token function">cwiseProduct</span><span class="token punctuation">(</span>light<span class="token punctuation">.</span>intensity <span class="token operator">/</span> vec_to_light<span class="token punctuation">.</span><span class="token function">squaredNorm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token function">MAX</span><span class="token punctuation">(</span><span class="token number">0.0f</span><span class="token punctuation">,</span> normal<span class="token punctuation">.</span><span class="token function">normalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dot</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span><span class="token function">normalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// The ambient component is only added once before the for loop</span>        result_color <span class="token operator">+=</span> <span class="token punctuation">(</span>diffuse <span class="token operator">+</span> specular<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> result_color <span class="token operator">*</span> <span class="token number">255.f</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="bump-å’Œ-displacement"><a href="#bump-å’Œ-displacement" class="headerlink" title="bump å’Œ displacement"></a>bump å’Œ displacement</h2><p>å¦‚å¼€å¤´æ‰€è¨€ï¼Œæœ¬æ¬¡ä½œä¸šå¯¹è¿™ä¸¤ä¸ª shader çš„è¦æ±‚éå¸¸ä¸ä¸¥è°¨ï¼Œæˆ‘ä»¬å°±ç®€å•æ”¾ä¸‹ä»£ç ï¼Œä¸å¤šè§£é‡Šäº†ã€‚åœ¨ä¸€äº›ä¸ä¸¥è°¨çš„åœ°æ–¹æˆ‘å·²ç»å†™äº†æ³¨é‡Šã€‚</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">Eigen<span class="token double-colon punctuation">::</span>Vector3f <span class="token function">bump_fragment_shader</span><span class="token punctuation">(</span><span class="token keyword">const</span> fragment_shader_payload<span class="token operator">&amp;</span> payload<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        Eigen<span class="token double-colon punctuation">::</span>Vector3f ka <span class="token operator">=</span> <span class="token class-name">Eigen</span><span class="token double-colon punctuation">::</span><span class="token function">Vector3f</span><span class="token punctuation">(</span><span class="token number">0.005</span><span class="token punctuation">,</span> <span class="token number">0.005</span><span class="token punctuation">,</span> <span class="token number">0.005</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Eigen<span class="token double-colon punctuation">::</span>Vector3f kd <span class="token operator">=</span> payload<span class="token punctuation">.</span>color<span class="token punctuation">;</span>    Eigen<span class="token double-colon punctuation">::</span>Vector3f ks <span class="token operator">=</span> <span class="token class-name">Eigen</span><span class="token double-colon punctuation">::</span><span class="token function">Vector3f</span><span class="token punctuation">(</span><span class="token number">0.7937</span><span class="token punctuation">,</span> <span class="token number">0.7937</span><span class="token punctuation">,</span> <span class="token number">0.7937</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">auto</span> l1 <span class="token operator">=</span> light<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">auto</span> l2 <span class="token operator">=</span> light<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span><span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>light<span class="token operator">></span> lights <span class="token operator">=</span> <span class="token punctuation">&#123;</span>l1<span class="token punctuation">,</span> l2<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    Eigen<span class="token double-colon punctuation">::</span>Vector3f amb_light_intensity<span class="token punctuation">&#123;</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    Eigen<span class="token double-colon punctuation">::</span>Vector3f eye_pos<span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">float</span> p <span class="token operator">=</span> <span class="token number">150</span><span class="token punctuation">;</span>    Eigen<span class="token double-colon punctuation">::</span>Vector3f color <span class="token operator">=</span> payload<span class="token punctuation">.</span>color<span class="token punctuation">;</span>     Eigen<span class="token double-colon punctuation">::</span>Vector3f point <span class="token operator">=</span> payload<span class="token punctuation">.</span>view_pos<span class="token punctuation">;</span>    Eigen<span class="token double-colon punctuation">::</span>Vector3f normal <span class="token operator">=</span> payload<span class="token punctuation">.</span>normal<span class="token punctuation">;</span>    <span class="token keyword">float</span> kh <span class="token operator">=</span> <span class="token number">0.2</span><span class="token punctuation">,</span> kn <span class="token operator">=</span> <span class="token number">0.1</span><span class="token punctuation">;</span>    <span class="token comment">// TODO: Implement bump mapping here</span>    <span class="token comment">// Let n = normal = (x, y, z)</span>    <span class="token comment">// Vector t = (x*y/sqrt(x*x+z*z),sqrt(x*x+z*z),z*y/sqrt(x*x+z*z))</span>    <span class="token comment">// Vector b = n cross product t</span>    <span class="token comment">// Matrix TBN = [t b n]</span>    <span class="token comment">// dU = kh * kn * (h(u+1/w,v)-h(u,v))</span>    <span class="token comment">// dV = kh * kn * (h(u,v+1/h)-h(u,v))</span>    <span class="token comment">// Vector ln = (-dU, -dV, 1)</span>    <span class="token comment">// Normal n = normalize(TBN * ln)</span>    <span class="token comment">// Note: The formula is WRONG in theory</span>    <span class="token comment">// To calculate the TBN matrix correctly, we need the triangle's vertices and their corresponding UV coordinates</span>    <span class="token comment">// read https://learnopengl.com/Advanced-Lighting/Normal-Mapping and </span>    <span class="token comment">// https://terathon.com/blog/tangent-space.html for more details</span>    <span class="token keyword">float</span> x <span class="token operator">=</span> normal<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">float</span> y <span class="token operator">=</span> normal<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">float</span> z <span class="token operator">=</span> normal<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">float</span> u <span class="token operator">=</span> payload<span class="token punctuation">.</span>tex_coords<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">float</span> v <span class="token operator">=</span> payload<span class="token punctuation">.</span>tex_coords<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">float</span> w <span class="token operator">=</span> payload<span class="token punctuation">.</span>texture<span class="token operator">-></span>width<span class="token punctuation">;</span>    <span class="token keyword">float</span> h <span class="token operator">=</span> payload<span class="token punctuation">.</span>texture<span class="token operator">-></span>height<span class="token punctuation">;</span>    Eigen<span class="token double-colon punctuation">::</span>Vector3f t <span class="token operator">=</span> <span class="token class-name">Eigen</span><span class="token double-colon punctuation">::</span><span class="token function">Vector3f</span><span class="token punctuation">(</span>x<span class="token operator">*</span>y<span class="token operator">/</span><span class="token function">sqrt</span><span class="token punctuation">(</span>x<span class="token operator">*</span>x<span class="token operator">+</span>z<span class="token operator">*</span>z<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">sqrt</span><span class="token punctuation">(</span>x<span class="token operator">*</span>x<span class="token operator">+</span>z<span class="token operator">*</span>z<span class="token punctuation">)</span><span class="token punctuation">,</span>z<span class="token operator">*</span>y<span class="token operator">/</span><span class="token function">sqrt</span><span class="token punctuation">(</span>x<span class="token operator">*</span>x<span class="token operator">+</span>z<span class="token operator">*</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Eigen<span class="token double-colon punctuation">::</span>Vector3f b <span class="token operator">=</span> normal<span class="token punctuation">.</span><span class="token function">cross</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>    Eigen<span class="token double-colon punctuation">::</span>Matrix3f TBN<span class="token punctuation">;</span>        TBN <span class="token operator">&lt;&lt;</span> t<span class="token punctuation">,</span> b<span class="token punctuation">,</span> normal<span class="token punctuation">;</span>    <span class="token comment">// In theory the texture should be a grayscale image</span>    <span class="token comment">// However we use an ordinary RGB image here, so we take norm</span>    <span class="token comment">// read https://games-cn.org/forums/topic/frequently-asked-questionskeep-updating/ for more details</span>    <span class="token keyword">float</span> dU <span class="token operator">=</span> kh <span class="token operator">*</span> kn <span class="token operator">*</span> <span class="token punctuation">(</span>payload<span class="token punctuation">.</span>texture<span class="token operator">-></span><span class="token function">getColor</span><span class="token punctuation">(</span>u<span class="token operator">+</span><span class="token number">1.0f</span><span class="token operator">/</span>w<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">norm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> payload<span class="token punctuation">.</span>texture<span class="token operator">-></span><span class="token function">getColor</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">norm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">float</span> dV <span class="token operator">=</span> kh <span class="token operator">*</span> kn <span class="token operator">*</span> <span class="token punctuation">(</span>payload<span class="token punctuation">.</span>texture<span class="token operator">-></span><span class="token function">getColor</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> v<span class="token operator">+</span><span class="token number">1.0f</span><span class="token operator">/</span>h<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">norm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> payload<span class="token punctuation">.</span>texture<span class="token operator">-></span><span class="token function">getColor</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">norm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Eigen<span class="token double-colon punctuation">::</span>Vector3f ln <span class="token operator">=</span> <span class="token class-name">Eigen</span><span class="token double-colon punctuation">::</span><span class="token function">Vector3f</span><span class="token punctuation">(</span><span class="token operator">-</span>dU<span class="token punctuation">,</span> <span class="token operator">-</span>dV<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    normal <span class="token operator">=</span> <span class="token punctuation">(</span>TBN <span class="token operator">*</span> ln<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">normalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Eigen<span class="token double-colon punctuation">::</span>Vector3f result_color <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    result_color <span class="token operator">=</span> normal<span class="token punctuation">;</span>    <span class="token keyword">return</span> result_color <span class="token operator">*</span> <span class="token number">255.f</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">Eigen<span class="token double-colon punctuation">::</span>Vector3f <span class="token function">displacement_fragment_shader</span><span class="token punctuation">(</span><span class="token keyword">const</span> fragment_shader_payload<span class="token operator">&amp;</span> payload<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        Eigen<span class="token double-colon punctuation">::</span>Vector3f ka <span class="token operator">=</span> <span class="token class-name">Eigen</span><span class="token double-colon punctuation">::</span><span class="token function">Vector3f</span><span class="token punctuation">(</span><span class="token number">0.005</span><span class="token punctuation">,</span> <span class="token number">0.005</span><span class="token punctuation">,</span> <span class="token number">0.005</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Eigen<span class="token double-colon punctuation">::</span>Vector3f kd <span class="token operator">=</span> payload<span class="token punctuation">.</span>color<span class="token punctuation">;</span>    Eigen<span class="token double-colon punctuation">::</span>Vector3f ks <span class="token operator">=</span> <span class="token class-name">Eigen</span><span class="token double-colon punctuation">::</span><span class="token function">Vector3f</span><span class="token punctuation">(</span><span class="token number">0.7937</span><span class="token punctuation">,</span> <span class="token number">0.7937</span><span class="token punctuation">,</span> <span class="token number">0.7937</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">auto</span> l1 <span class="token operator">=</span> light<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">auto</span> l2 <span class="token operator">=</span> light<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span><span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>light<span class="token operator">></span> lights <span class="token operator">=</span> <span class="token punctuation">&#123;</span>l1<span class="token punctuation">,</span> l2<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    Eigen<span class="token double-colon punctuation">::</span>Vector3f amb_light_intensity<span class="token punctuation">&#123;</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    Eigen<span class="token double-colon punctuation">::</span>Vector3f eye_pos<span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">float</span> p <span class="token operator">=</span> <span class="token number">150</span><span class="token punctuation">;</span>    Eigen<span class="token double-colon punctuation">::</span>Vector3f color <span class="token operator">=</span> payload<span class="token punctuation">.</span>color<span class="token punctuation">;</span>     Eigen<span class="token double-colon punctuation">::</span>Vector3f point <span class="token operator">=</span> payload<span class="token punctuation">.</span>view_pos<span class="token punctuation">;</span>    Eigen<span class="token double-colon punctuation">::</span>Vector3f normal <span class="token operator">=</span> payload<span class="token punctuation">.</span>normal<span class="token punctuation">;</span>    <span class="token keyword">float</span> kh <span class="token operator">=</span> <span class="token number">0.2</span><span class="token punctuation">,</span> kn <span class="token operator">=</span> <span class="token number">0.1</span><span class="token punctuation">;</span>        <span class="token comment">// TODO: Implement displacement mapping here</span>    <span class="token comment">// Let n = normal = (x, y, z)</span>    <span class="token comment">// Vector t = (x*y/sqrt(x*x+z*z),sqrt(x*x+z*z),z*y/sqrt(x*x+z*z))</span>    <span class="token comment">// Vector b = n cross product t</span>    <span class="token comment">// Matrix TBN = [t b n]</span>    <span class="token comment">// dU = kh * kn * (h(u+1/w,v)-h(u,v))</span>    <span class="token comment">// dV = kh * kn * (h(u,v+1/h)-h(u,v))</span>    <span class="token comment">// Vector ln = (-dU, -dV, 1)</span>    <span class="token comment">// Position p = p + kn * n * h(u,v)</span>    <span class="token comment">// Normal n = normalize(TBN * ln)</span>    <span class="token comment">// Note: The formula is WRONG in theory</span>    <span class="token comment">// When using Displacement Mapping, the points should be offset in the camera space before rasterizing, </span>    <span class="token comment">// instead of only changing its color</span>    <span class="token comment">// read https://learnopengl.com/Advanced-Lighting/Normal-Mapping and </span>    <span class="token comment">// https://terathon.com/blog/tangent-space.html for more details</span>    <span class="token keyword">float</span> x <span class="token operator">=</span> normal<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">float</span> y <span class="token operator">=</span> normal<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">float</span> z <span class="token operator">=</span> normal<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">float</span> u <span class="token operator">=</span> payload<span class="token punctuation">.</span>tex_coords<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">float</span> v <span class="token operator">=</span> payload<span class="token punctuation">.</span>tex_coords<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">float</span> w <span class="token operator">=</span> payload<span class="token punctuation">.</span>texture<span class="token operator">-></span>width<span class="token punctuation">;</span>    <span class="token keyword">float</span> h <span class="token operator">=</span> payload<span class="token punctuation">.</span>texture<span class="token operator">-></span>height<span class="token punctuation">;</span>    Eigen<span class="token double-colon punctuation">::</span>Vector3f t <span class="token operator">=</span> <span class="token class-name">Eigen</span><span class="token double-colon punctuation">::</span><span class="token function">Vector3f</span><span class="token punctuation">(</span>x<span class="token operator">*</span>y<span class="token operator">/</span><span class="token function">sqrt</span><span class="token punctuation">(</span>x<span class="token operator">*</span>x<span class="token operator">+</span>z<span class="token operator">*</span>z<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">sqrt</span><span class="token punctuation">(</span>x<span class="token operator">*</span>x<span class="token operator">+</span>z<span class="token operator">*</span>z<span class="token punctuation">)</span><span class="token punctuation">,</span>z<span class="token operator">*</span>y<span class="token operator">/</span><span class="token function">sqrt</span><span class="token punctuation">(</span>x<span class="token operator">*</span>x<span class="token operator">+</span>z<span class="token operator">*</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Eigen<span class="token double-colon punctuation">::</span>Vector3f b <span class="token operator">=</span> normal<span class="token punctuation">.</span><span class="token function">cross</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>    Eigen<span class="token double-colon punctuation">::</span>Matrix3f TBN<span class="token punctuation">;</span>        TBN <span class="token operator">&lt;&lt;</span> t<span class="token punctuation">,</span> b<span class="token punctuation">,</span> normal<span class="token punctuation">;</span>    <span class="token comment">// In theory the texture should be a grayscale image</span>    <span class="token comment">// However we use an ordinary RGB image here, so we take norm</span>    <span class="token comment">// read https://games-cn.org/forums/topic/frequently-asked-questionskeep-updating/ for more details</span>    <span class="token keyword">float</span> dU <span class="token operator">=</span> kh <span class="token operator">*</span> kn <span class="token operator">*</span> <span class="token punctuation">(</span>payload<span class="token punctuation">.</span>texture<span class="token operator">-></span><span class="token function">getColor</span><span class="token punctuation">(</span>u<span class="token operator">+</span><span class="token number">1.0f</span><span class="token operator">/</span>w<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">norm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> payload<span class="token punctuation">.</span>texture<span class="token operator">-></span><span class="token function">getColor</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">norm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">float</span> dV <span class="token operator">=</span> kh <span class="token operator">*</span> kn <span class="token operator">*</span> <span class="token punctuation">(</span>payload<span class="token punctuation">.</span>texture<span class="token operator">-></span><span class="token function">getColor</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> v<span class="token operator">+</span><span class="token number">1.0f</span><span class="token operator">/</span>h<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">norm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> payload<span class="token punctuation">.</span>texture<span class="token operator">-></span><span class="token function">getColor</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">norm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Eigen<span class="token double-colon punctuation">::</span>Vector3f ln <span class="token operator">=</span> <span class="token class-name">Eigen</span><span class="token double-colon punctuation">::</span><span class="token function">Vector3f</span><span class="token punctuation">(</span><span class="token operator">-</span>dU<span class="token punctuation">,</span> <span class="token operator">-</span>dV<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// In theory we should bias the point using the original normal</span>    <span class="token comment">// but to match the homework answer, we bias the point using the corrected normal</span>    normal <span class="token operator">=</span> <span class="token punctuation">(</span>TBN <span class="token operator">*</span> ln<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">normalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    point <span class="token operator">+=</span> kn <span class="token operator">*</span> normal <span class="token operator">*</span> payload<span class="token punctuation">.</span>texture<span class="token operator">-></span><span class="token function">getColor</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">norm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Eigen<span class="token double-colon punctuation">::</span>Vector3f result_color <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    Eigen<span class="token double-colon punctuation">::</span>Vector3f ambient <span class="token operator">=</span> ka<span class="token punctuation">.</span><span class="token function">cwiseProduct</span><span class="token punctuation">(</span>amb_light_intensity<span class="token punctuation">)</span><span class="token punctuation">;</span>    result_color <span class="token operator">+=</span> ambient<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> light <span class="token operator">:</span> lights<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token comment">// TODO: For each light source in the code, calculate what the *ambient*, *diffuse*, and *specular* </span>        <span class="token comment">// components are. Then, accumulate that result on the *result_color* object.</span>        Eigen<span class="token double-colon punctuation">::</span>Vector3f vec_to_light <span class="token operator">=</span> light<span class="token punctuation">.</span>position <span class="token operator">-</span> point<span class="token punctuation">;</span>        Eigen<span class="token double-colon punctuation">::</span>Vector3f diffuse <span class="token operator">=</span> kd<span class="token punctuation">.</span><span class="token function">cwiseProduct</span><span class="token punctuation">(</span>light<span class="token punctuation">.</span>intensity <span class="token operator">/</span> vec_to_light<span class="token punctuation">.</span><span class="token function">squaredNorm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">MAX</span><span class="token punctuation">(</span><span class="token number">0.0f</span><span class="token punctuation">,</span> normal<span class="token punctuation">.</span><span class="token function">normalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dot</span><span class="token punctuation">(</span>vec_to_light<span class="token punctuation">.</span><span class="token function">normalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Eigen<span class="token double-colon punctuation">::</span>Vector3f vec_to_eye <span class="token operator">=</span> eye_pos <span class="token operator">-</span> point<span class="token punctuation">;</span>        Eigen<span class="token double-colon punctuation">::</span>Vector3f h <span class="token operator">=</span> vec_to_light<span class="token punctuation">.</span><span class="token function">normalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> vec_to_eye<span class="token punctuation">.</span><span class="token function">normalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Eigen<span class="token double-colon punctuation">::</span>Vector3f specular <span class="token operator">=</span> ks<span class="token punctuation">.</span><span class="token function">cwiseProduct</span><span class="token punctuation">(</span>light<span class="token punctuation">.</span>intensity <span class="token operator">/</span> vec_to_light<span class="token punctuation">.</span><span class="token function">squaredNorm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token function">MAX</span><span class="token punctuation">(</span><span class="token number">0.0f</span><span class="token punctuation">,</span> normal<span class="token punctuation">.</span><span class="token function">normalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dot</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span><span class="token function">normalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// The ambient component is only added once before the for loop</span>        result_color <span class="token operator">+=</span> <span class="token punctuation">(</span>diffuse <span class="token operator">+</span> specular<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> result_color <span class="token operator">*</span> <span class="token number">255.f</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;æœ¬æ¬¡ä½œä¸šå¯¹ bump_fragment_shaderã€displacement_fragment_shader çš„è¦æ±‚éå¸¸ä¸ä¸¥è°¨ï¼Œè‡³å°‘åŒ…æ‹¬è¿™äº›é—®é¢˜ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;è¿™ä¸¤ä¸ª shdaer éœ€è¦çš„è´´å›¾æ˜¯å‡¹å‡¸è´´å›¾ï¼Œå‡¹å‡¸è´´å›¾æœ¬åº”è¯¥æ˜¯ç°åº¦å›¾ï¼Œè¿™é‡Œä½¿ç”¨ RGB è´´å›¾ã€‚&lt;/l</summary>
      
    
    
    
    <category term="å…¬å¼€è¯¾" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/"/>
    
    <category term="GAMES101" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/GAMES101/"/>
    
    <category term="Assignments" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/GAMES101/Assignments/"/>
    
    
  </entry>
  
  <entry>
    <title>Assignment 2 Rasterizing</title>
    <link href="http://rinevard.github.io/wiki/learning/open-course/GAMES101/Hw/Hw2-rasterizing/"/>
    <id>http://rinevard.github.io/wiki/learning/open-course/GAMES101/Hw/Hw2-rasterizing/</id>
    <published>2025-08-26T12:15:16.000Z</published>
    <updated>2025-08-26T12:21:11.482Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬æ¬¡ä½œä¸šè¦æ±‚æˆ‘ä»¬å®ç° Z-buffer ã€æ …æ ¼åŒ–å’Œ SSAAï¼ˆä¹Ÿå°±æ˜¯è¶…é‡‡æ ·ï¼‰ã€‚æˆ‘ä»¬å…ˆçœ‹çœ‹å‰ä¸¤ä¸ªä¸œè¥¿ï¼Œå†çœ‹çœ‹ SSAAã€‚</p><h1 id="Z-bufferå’Œæ …æ ¼åŒ–"><a href="#Z-bufferå’Œæ …æ ¼åŒ–" class="headerlink" title="Z-bufferå’Œæ …æ ¼åŒ–"></a>Z-bufferå’Œæ …æ ¼åŒ–</h1><h2 id="ä»£ç æ¡†æ¶"><a href="#ä»£ç æ¡†æ¶" class="headerlink" title="ä»£ç æ¡†æ¶"></a>ä»£ç æ¡†æ¶</h2><p>æˆ‘ä»¬è¦è¡¥å…¨çš„ <code>rasterize_triangle</code> å‡½æ•°åœ¨ <code>draw</code> å‡½æ•°å†…è¢«è°ƒç”¨ï¼Œå¯ä»¥çœ‹åˆ° <code>draw</code> å‡½æ•°å·²ç»åšå¥½äº†ä¸‰è§’å½¢çš„æŠ•å½±å˜æ¢ï¼Œæˆ‘ä»¬åªè¦æŠŠ $[0, \text{width}] \times [0,\text{height}] \times [n,f]$ é‡Œçš„ä¸‰è§’å½¢æ¸²æŸ“åˆ°å±å¹•ä¸Šå°±å¥½ã€‚è¾“å…¥çš„ä¸‰è§’å½¢å¤§æ¦‚å½¢å¦‚è¿™æ ·ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>input triangle<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token number">529.259</span>    <span class="token number">350</span><span class="token number">49.3857</span>      <span class="token number">1</span><span class="token operator">--</span>    <span class="token number">350</span><span class="token number">529.259</span><span class="token number">49.3857</span>      <span class="token number">1</span><span class="token operator">--</span><span class="token number">170.741</span>    <span class="token number">350</span><span class="token number">49.3857</span>      <span class="token number">1</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="insideTriangle-å‡½æ•°"><a href="#insideTriangle-å‡½æ•°" class="headerlink" title="insideTriangle å‡½æ•°"></a>insideTriangle å‡½æ•°</h2><p>ç”¨è¯¾ä¸Šè®²çš„å‰ä¹˜æ³•åˆ¤æ–­ç‚¹æ˜¯å¦åœ¨ä¸‰è§’å½¢å†…ã€‚â€œåœ¨ä¸‰è§’å½¢å†…â€è¿™ä¸ªè¯´æ³•ä¹Ÿä¸æ˜¯ç‰¹åˆ«ä¸¥è°¨ï¼Œæ›´å‡†ç¡®åœ°è¯´åº”è¯¥æ˜¯åˆ¤æ–­ä¸‰è§’å½¢åœ¨å±å¹•ä¸Šçš„äºŒç»´æŠ•å½±æ˜¯å¦åŒ…å«è¿™ä¸ªç‚¹ã€‚</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/*    Return whether (x, y) is in the triangle, ignoring its z value.*/</span><span class="token keyword">static</span> <span class="token keyword">bool</span> <span class="token function">insideTriangle</span><span class="token punctuation">(</span><span class="token keyword">float</span> x<span class="token punctuation">,</span> <span class="token keyword">float</span> y<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>array<span class="token operator">&lt;</span>Vector4f<span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">></span><span class="token operator">&amp;</span> triangle<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    Vector2f point1 <span class="token operator">=</span> <span class="token punctuation">&#123;</span>triangle<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> triangle<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    Vector2f point2 <span class="token operator">=</span> <span class="token punctuation">&#123;</span>triangle<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> triangle<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    Vector2f point3 <span class="token operator">=</span> <span class="token punctuation">&#123;</span>triangle<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> triangle<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    Vector2f checked_point <span class="token operator">=</span> <span class="token punctuation">&#123;</span>x<span class="token punctuation">,</span> y<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token keyword">auto</span> cross_product <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">const</span> Vector2f<span class="token operator">&amp;</span> v1<span class="token punctuation">,</span> <span class="token keyword">const</span> Vector2f<span class="token operator">&amp;</span> v2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> v1<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> v2<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> v1<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> v2<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">float</span> side1 <span class="token operator">=</span> <span class="token function">cross_product</span><span class="token punctuation">(</span>point1 <span class="token operator">-</span> checked_point<span class="token punctuation">,</span> point1 <span class="token operator">-</span> point2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">float</span> side2 <span class="token operator">=</span> <span class="token function">cross_product</span><span class="token punctuation">(</span>point2 <span class="token operator">-</span> checked_point<span class="token punctuation">,</span> point2 <span class="token operator">-</span> point3<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">float</span> side3 <span class="token operator">=</span> <span class="token function">cross_product</span><span class="token punctuation">(</span>point3 <span class="token operator">-</span> checked_point<span class="token punctuation">,</span> point3 <span class="token operator">-</span> point1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>side1 <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> side2 <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> side3 <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>side1 <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> side2 <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> side3 <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="rasterize-triangle-å‡½æ•°"><a href="#rasterize-triangle-å‡½æ•°" class="headerlink" title="rasterize_triangle å‡½æ•°"></a>rasterize_triangle å‡½æ•°</h2><p>è¿™ä¸ªå®ç°å¥½åƒæ²¡ä»€ä¹ˆç‰¹åˆ«å€¼å¾—è¯´çš„åœ°æ–¹ï¼Œç®€ç®€å•å•é‡‡é‡‡æ ·ï¼Œç„¶åç”¨ <code>depth_buf</code> å®ç° z-buffer å°±å¥½ã€‚</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//Screen space rasterization</span><span class="token keyword">void</span> rst<span class="token double-colon punctuation">::</span>rasterizer<span class="token double-colon punctuation">::</span><span class="token function">rasterize_triangle</span><span class="token punctuation">(</span><span class="token keyword">const</span> Triangle<span class="token operator">&amp;</span> t<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">auto</span> v <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">toVector4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// Find bounding box</span>    <span class="token keyword">float</span> left <span class="token operator">=</span> v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">float</span> right <span class="token operator">=</span> v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">float</span> bottom <span class="token operator">=</span> v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">float</span> top <span class="token operator">=</span> v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> vec<span class="token operator">:</span> v<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        left <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> vec<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        right <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span>right<span class="token punctuation">,</span> vec<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        bottom <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span>bottom<span class="token punctuation">,</span> vec<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        top <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span>top<span class="token punctuation">,</span> vec<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// Update pixels in bounding box</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span> x <span class="token operator">&lt;=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>right<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> y <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>bottom<span class="token punctuation">)</span><span class="token punctuation">;</span> y <span class="token operator">&lt;=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>top<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> y<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">insideTriangle</span><span class="token punctuation">(</span>x<span class="token operator">+</span><span class="token number">0.5</span><span class="token punctuation">,</span> y<span class="token operator">+</span><span class="token number">0.5</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">// Interpolate z value </span>            <span class="token keyword">auto</span><span class="token punctuation">[</span>alpha<span class="token punctuation">,</span> beta<span class="token punctuation">,</span> gamma<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">computeBarycentric2D</span><span class="token punctuation">(</span>x<span class="token operator">+</span><span class="token number">0.5</span><span class="token punctuation">,</span> y<span class="token operator">+</span><span class="token number">0.5</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">float</span> w_reciprocal <span class="token operator">=</span> <span class="token number">1.0</span><span class="token operator">/</span><span class="token punctuation">(</span>alpha <span class="token operator">/</span> v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> beta <span class="token operator">/</span> v<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> gamma <span class="token operator">/</span> v<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">float</span> z_interpolated <span class="token operator">=</span> alpha <span class="token operator">*</span> v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> beta <span class="token operator">*</span> v<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> v<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> gamma <span class="token operator">*</span> v<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> v<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            z_interpolated <span class="token operator">*=</span> w_reciprocal<span class="token punctuation">;</span>            <span class="token comment">// A lower z-value means it is displayed in front</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>z_interpolated <span class="token operator">&lt;</span> depth_buf<span class="token punctuation">[</span>y <span class="token operator">*</span> width <span class="token operator">+</span> x<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                depth_buf<span class="token punctuation">[</span>y <span class="token operator">*</span> width <span class="token operator">+</span> x<span class="token punctuation">]</span> <span class="token operator">=</span> z_interpolated<span class="token punctuation">;</span>                <span class="token function">set_pixel</span><span class="token punctuation">(</span><span class="token function">Vector3f</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z_interpolated<span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">getColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="SSAAçš„å®ç°"><a href="#SSAAçš„å®ç°" class="headerlink" title="SSAAçš„å®ç°"></a>SSAAçš„å®ç°</h1><p>SSAA çš„å®ç°ç›¸è¾ƒè€Œè¨€æ›´å›°éš¾ä¸€äº›ï¼Œç”±äºæ‚ä¸ƒæ‚å…«è¦æ”¹çš„åœ°æ–¹æ¯”è¾ƒå¤šï¼Œæˆ‘å°±å…ˆè¯´ä¸‹å¤§è‡´æ€è·¯ï¼Œå†èŠèŠå’±è¸©çš„ä¸¤ä¸ªå‘ã€‚</p><p>ä¸è¿‡åœ¨æ­¤ä¹‹å‰ï¼Œå…ˆæ¥çœ‹çœ‹æˆ‘ä»¬çš„æˆæœå§ï¼ï¼ˆè¿™æ˜¯åŠ¨å›¾</p><p><img src="/images/learning/open-course/GAMES101/Assignments/hw2/new-vs-orig.gif" alt=""></p><h2 id="å¤§è‡´æ€è·¯"><a href="#å¤§è‡´æ€è·¯" class="headerlink" title="å¤§è‡´æ€è·¯"></a>å¤§è‡´æ€è·¯</h2><p>æˆ‘ä»¬è¦å…ˆæŠŠæ‰€æœ‰å†…å®¹æ¸²æŸ“åˆ°å¤§å°ä¸º $(\text{width} * 2, \text{height} * 2<br>)$ çš„è‡ªå®šä¹‰ buffer é‡Œï¼Œå†æ ¹æ®è‡ªå®šä¹‰ buffer çš„å†…å®¹å¡«å……å±å¹•ä¸Šçš„åƒç´ ã€‚</p><p>è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥åœ¨ <code>rasterize_triangle</code> é‡ŒæŠŠä¸‰è§’å½¢ç”»åˆ°å±å¹•ä¸Šï¼ˆå…·ä½“åŸå› è§â€œè¸©å‘1â€é‚£ä¸€èŠ‚ï¼‰ï¼Œè€Œæ˜¯è¦åœ¨ <code>rasterize_triangle</code> ä¸­æŠŠä¸‰è§’å½¢ç”»åˆ°è‡ªå®šä¹‰çš„ buffer é‡Œï¼Œå†æ–°å¢ä¸€ä¸ª <code>resolve</code> å‡½æ•°å¹¶æŠŠå®ƒæ”¾åˆ° draw çš„æœ€åï¼Œä»è€ŒæŠŠè‡ªå®šä¹‰ buffer é‡Œçš„å†…å®¹ç”»åˆ°å±å¹•ä¸Šï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> rst<span class="token double-colon punctuation">::</span>rasterizer<span class="token double-colon punctuation">::</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> y <span class="token operator">&lt;</span> height<span class="token punctuation">;</span> y<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> width<span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            frame_buf<span class="token punctuation">[</span>y <span class="token operator">*</span> width <span class="token operator">+</span> x<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">Vector3f</span><span class="token double-colon punctuation">::</span><span class="token function">Zero</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                frame_buf<span class="token punctuation">[</span>y <span class="token operator">*</span> width <span class="token operator">+</span> x<span class="token punctuation">]</span> <span class="token operator">+=</span> ssaa_frame_buf<span class="token punctuation">[</span><span class="token punctuation">(</span>y <span class="token operator">*</span> width <span class="token operator">+</span> x<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">+</span> i<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            frame_buf<span class="token punctuation">[</span>y <span class="token operator">*</span> width <span class="token operator">+</span> x<span class="token punctuation">]</span> <span class="token operator">/=</span> <span class="token number">4.0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ›´ç»†èŠ‚ä¸€äº›çš„è¯ï¼Œæˆ‘ä»¬éœ€è¦åšè¿™äº›å·¥ä½œï¼š</p><ol><li>åœ¨ rasterizer.hpp é‡ŒåŠ å…¥ ssaa_frame_buf å’Œ resolve çš„å®šä¹‰ã€‚</li><li>ä¿®æ”¹ rasterizer çš„åˆå§‹åŒ–å‡½æ•°å’Œ clear å‡½æ•°ï¼Œæ­£ç¡®åˆå§‹åŒ–å’Œé‡ç½® ssaa_frame_bufã€‚</li><li>ä¿®æ”¹ set_pixel å‡½æ•°ï¼Œè®©å®ƒæŠŠå†…å®¹ç”»åˆ° ssaa_frame_buf é‡Œï¼Œè€Œé frame_buf é‡Œã€‚</li><li>ä¿®æ”¹ rasterize_triangleï¼Œè®©å®ƒç”¨ä½¿ç”¨æ›´é«˜çš„é‡‡æ ·ç‡ã€‚</li><li>å®ç° resolve å‡½æ•°ã€‚</li></ol><p>æ‚ä¸ƒæ‚å…«è¦æ”¹çš„åœ°æ–¹æ¯”è¾ƒå¤šï¼Œè¿™é‡Œå°±ä¸æ”¾æ›´å¤šä»£ç äº†ã€‚</p><h2 id="è¸©å‘1"><a href="#è¸©å‘1" class="headerlink" title="è¸©å‘1"></a>è¸©å‘1</h2><p>SSAAã€filtering éƒ½å»ºç«‹åœ¨â€œæˆ‘ä»¬å¯¹ç†æƒ³å›¾åƒè¿›è¡Œæ»¤æ³¢â€çš„åŸºç¡€ä¸Šã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¦å…ˆæŠŠä¸–ç•Œé‡Œçš„å¯¹è±¡æŒ‰æ­£ç¡®çš„å‰åé¡ºåºå˜ä¸ºä¸€ä¸ªäºŒç»´å›¾åƒï¼Œç„¶åå†æ»¤æ³¢ã€‚æ‰€ä»¥ç›´æ¥åœ¨ <code>rasterize_triangle</code> é‡ŒæŠŠåƒç´ åˆ’åˆ†æˆå­åƒç´ ç„¶åå–å¹³å‡å¹¶ä¸èƒ½å®ç° SSAAï¼Œè€Œæ˜¯ä¼šåœ¨ä¸‰è§’å½¢é‡å çš„åœ°æ–¹æ˜¾ç¤ºå‡ºé»‘è¾¹ã€‚</p><p><img src="/images/learning/open-course/GAMES101/Assignments/hw2/black-ssaa.png" alt=""></p><p>è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªå…·ä½“ä¾‹å­ã€‚è€ƒè™‘ä¸€ä¸ª 1/4 è¢«ç»¿è‰²ä¸‰è§’å½¢å æ®ã€3/4 è¢«è“è‰²ä¸‰è§’å½¢å æ®çš„åƒç´ ï¼ŒSSAA ä¼šæŠŠ 1/4 ç»¿ + 3/4 è“ ä½œä¸ºè¿™ä¸ªåƒç´ çš„é¢œè‰²ã€‚</p><p>è€Œå¦‚æœç›´æ¥åœ¨ <code>rasterize_triangle</code> é‡ŒæŠŠåƒç´ åˆ’åˆ†æˆå­åƒç´ ç„¶åå–å¹³å‡ï¼Œé‚£ä¹ˆæ …æ ¼åŒ–è“è‰²ä¸‰è§’å½¢æ—¶ï¼Œè¿™ä¸ªåƒç´ è¢«å½“æˆ 3/4 è“ï¼›æ …æ ¼åŒ–ç»¿è‰²ä¸‰è§’å½¢æ—¶ï¼Œè¿™ä¸ªåƒç´ è¢«å½“æˆ 1/4 ç»¿ã€‚æ— è®ºè°åœ¨å‰é¢ï¼Œæœ€ç»ˆç»“æœè¦ä¹ˆæ˜¯ 3/4 è“ï¼Œè¦ä¹ˆæ˜¯ 1/4 ç»¿ï¼Œæ€»ä¸ SSAA çš„ç»“æœ 1/4 ç»¿ + 3/4 è“ ä¸åŒã€‚</p><h2 id="è¸©å‘2"><a href="#è¸©å‘2" class="headerlink" title="è¸©å‘2"></a>è¸©å‘2</h2><p><code>insideTriangle</code> çš„å‚æ•° x å’Œ y çš„ç±»å‹åŸæœ¬æ˜¯ intï¼Œè€Œåœ¨ SSAA é‡Œæˆ‘ä»¬æŠŠåƒç´ åˆ’åˆ†æˆäº†å››ä¸ªå­åƒç´ ï¼Œè¿™äº›å­åƒç´ çš„åæ ‡å¤§å¤šä¸æ˜¯æ•´æ•°ã€‚å› æ­¤æˆ‘ä»¬è¦æŠŠ <code>insideTriangle</code> çš„ x å’Œ y çš„ç±»å‹æ”¹æˆ float. </p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">bool</span> <span class="token function">insideTriangle</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> <span class="token keyword">const</span> Vector3f<span class="token operator">*</span> _v<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>       <span class="token comment">// TODO : Implement this function to check if the point (x, y) is inside the triangle represented by _v[0], _v[1], _v[2]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;æœ¬æ¬¡ä½œä¸šè¦æ±‚æˆ‘ä»¬å®ç° Z-buffer ã€æ …æ ¼åŒ–å’Œ SSAAï¼ˆä¹Ÿå°±æ˜¯è¶…é‡‡æ ·ï¼‰ã€‚æˆ‘ä»¬å…ˆçœ‹çœ‹å‰ä¸¤ä¸ªä¸œè¥¿ï¼Œå†çœ‹çœ‹ SSAAã€‚&lt;/p&gt;
&lt;h1 id=&quot;Z-bufferå’Œæ …æ ¼åŒ–&quot;&gt;&lt;a href=&quot;#Z-bufferå’Œæ …æ ¼åŒ–&quot; class=&quot;headerlink&quot; title=&quot;Z</summary>
      
    
    
    
    <category term="å…¬å¼€è¯¾" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/"/>
    
    <category term="GAMES101" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/GAMES101/"/>
    
    <category term="Assignments" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/GAMES101/Assignments/"/>
    
    
  </entry>
  
  <entry>
    <title>Note 2 Rasterizing</title>
    <link href="http://rinevard.github.io/wiki/learning/open-course/GAMES101/Notes/Note2-Rasterizing/"/>
    <id>http://rinevard.github.io/wiki/learning/open-course/GAMES101/Notes/Note2-Rasterizing/</id>
    <published>2025-08-25T08:10:28.000Z</published>
    <updated>2025-09-23T07:19:39.089Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ Transformation éƒ¨åˆ†ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥æŠŠä¸€ä¸ªä¸‰ç»´ç©ºé—´é‡Œçš„ä¸‰è§’å½¢æŠ•å½±åˆ°å¹³é¢ä¸Šã€‚ä½†æ€ä¹ˆæŠŠä¸€ä¸ªçº¯è‰²ä¸‰è§’å½¢ç»˜åˆ¶åˆ°å±å¹•ä¸Šå‘¢ï¼Ÿæˆ‘ä»¬çŸ¥é“å±å¹•ç”±å¤§é‡çš„åƒç´ ç‚¹ç»„æˆï¼Œé‚£ä¹ˆæ€ä¹ˆç¡®å®šæ¯ä¸ªåƒç´ ç‚¹æ˜¯ä»€ä¹ˆé¢œè‰²å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬é€šè¿‡é‡‡æ ·ç»™æ¯ä¸ªåƒç´ ç‚¹æ¶‚ä¸Šé¢œè‰²ã€‚æˆ‘ä»¬å¯ä»¥æ£€æŸ¥æ¯ä¸ªåƒç´ çš„ä¸­å¿ƒç‚¹æ˜¯å¦åœ¨è¿™ä¸ªä¸‰è§’å½¢å†…éƒ¨ï¼Œå¦‚æœåœ¨åˆ™æ¶‚ä¸Šä¸‰è§’å½¢çš„é¢œè‰²ã€‚è™½ç„¶è¿™æ ·ç»˜åˆ¶çš„ä¸‰è§’å½¢ä¼šæœ‰é”¯é½¿ï¼Œæ•ˆæœä¸€èˆ¬ï¼Œä½†åŸºæœ¬æ€æƒ³å°±æ˜¯è¿™æ ·ã€‚</p><p>é‚£ä¹ˆå¦‚æœæœ‰å¤šä¸ªä¸‰è§’å½¢ï¼Œè€Œä¸”ä»–ä»¬ä¹‹é—´æœ‰é®æŒ¡å…³ç³»å‘¢ï¼Ÿè¿™å°±éœ€è¦ Z-Buffer å‡ºåœºäº†ã€‚</p><h1 id="Z-Buffer"><a href="#Z-Buffer" class="headerlink" title="Z-Buffer"></a>Z-Buffer</h1><p>Z-Buffer çš„ç®—æ³•å¦‚ä¸‹é¢çš„ä¼ªä»£ç æ‰€ç¤ºã€‚æ€è·¯æ˜¯å¯¹æ¯ä¸ªåƒç´ æ‰€åœ¨çš„æ‰€æœ‰ä¸‰è§’å½¢ï¼Œå– z å€¼æœ€å°çš„ä¸‰è§’å½¢çš„é¢œè‰²ä½œä¸ºè¿™ä¸ªåƒç´ çš„é¢œè‰²ã€‚</p><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name">Triangle</span> triangle <span class="token keyword">in</span> triangles<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name">Vector3</span> sample <span class="token keyword">in</span> triangle<span class="token punctuation">.</span><span class="token function">GetSamples</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// z å€¼è¶Šå°æ˜¾ç¤ºè¶Šé å‰</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>sample<span class="token punctuation">.</span>z <span class="token operator">&lt;</span> zBuffer<span class="token punctuation">[</span>sample<span class="token punctuation">.</span>x<span class="token punctuation">,</span> sample<span class="token punctuation">.</span>y<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            frameBuffer<span class="token punctuation">[</span>sample<span class="token punctuation">.</span>x<span class="token punctuation">,</span> sample<span class="token punctuation">.</span>y<span class="token punctuation">]</span> <span class="token operator">=</span> sample<span class="token punctuation">.</span>rgb<span class="token punctuation">;</span>            zBuffer<span class="token punctuation">[</span>sample<span class="token punctuation">.</span>x<span class="token punctuation">,</span> sample<span class="token punctuation">.</span>y<span class="token punctuation">]</span> <span class="token operator">=</span> sample<span class="token punctuation">.</span>z<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™ä¹Ÿæœ‰è‰¯å¥½çš„å¹¶è¡Œæ€§ï¼Œå› ä¸ºä¸‰è§’å½¢çš„éå†é¡ºåºå’Œæœ€ç»ˆç»“æœæ— å…³ï¼Œåƒç´ çš„ç»˜åˆ¶é¡ºåºä¹Ÿå’Œæœ€ç»ˆç»“æœæ— å…³ã€‚</p><p>è™ä¹¦è¿˜æåˆ°æˆ‘ä»¬ä¼šå°† $z$ å€¼æ˜ å°„åˆ° $[0, B-1]$ï¼Œç”¨æ•´æ•°å­˜å‚¨ $z$ å€¼ï¼Œä½†å…¶å®è¿™æ˜¯ç°åœ¨ä¸å†ä½¿ç”¨çš„æ–¹æ³•ï¼Œæˆ‘ä»¬ç°åœ¨é€šå¸¸ä½¿ç”¨ 24 ä½æˆ– 32 ä½çš„æµ®ç‚¹æ•°æ¥å­˜å‚¨æ·±åº¦å€¼ã€‚ï¼ˆæ€ªä¸å¾—æˆ‘æŸ¥äº†å¥½ä¹…èµ„æ–™éƒ½æ²¡æŸ¥åˆ°â€œæ•´æ•°æ˜ å°„â€çš„å…·ä½“ä»£ç ï¼ŒåŸæ¥æ—©å°±ä¸ç”¨äº†ï¼ï¼ï¼ï¼‰</p><h1 id="èµ°æ ·ç°è±¡"><a href="#èµ°æ ·ç°è±¡" class="headerlink" title="èµ°æ ·ç°è±¡"></a>èµ°æ ·ç°è±¡</h1><p>æˆ‘ä»¬ä¹‹å‰è¯´è¿‡ï¼Œç®€å•çš„é‡‡æ ·ä¼šå‡ºç°é”¯é½¿ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="/images/learning/open-course/GAMES101/Notes/note2/jaggies.png" alt=""></p><p>é”¯é½¿ã€æ‘©å°”çº¹ä¹‹ç±»çš„é‡‡æ ·å›¾åƒä¸åŸå›¾ä¸ç¬¦çš„ç°è±¡è¢«ç»Ÿç§°ä¸ºèµ°æ ·ï¼ˆAliasingï¼‰ç°è±¡ï¼Œèµ°æ ·çš„å®è´¨æ˜¯åŸå›¾çš„é«˜é¢‘ä¿¡å·è¢«é”™è¯¯é‡‡æ ·ã€‚ä¸ºäº†æ˜ç¡®ä»€ä¹ˆæ˜¯â€é«˜é¢‘ä¿¡å·â€å¹¶æ‰¾åˆ°ç¼“è§£èµ°æ ·ç°è±¡çš„æ–¹æ³•ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹ä¸€äº›æ•°å­¦çŸ¥è¯†ã€‚</p><h1 id="æ•°å­¦çŸ¥è¯†"><a href="#æ•°å­¦çŸ¥è¯†" class="headerlink" title="æ•°å­¦çŸ¥è¯†"></a>æ•°å­¦çŸ¥è¯†</h1><p>ä¸ºäº†ä¸è®©æ–‡ç« å¤ªé•¿ï¼Œè¿™é‡Œæˆ‘ä»¬çœç•¥æ‰€æœ‰çš„è¯æ˜ã€‚ä¸è¿‡æ‰€æœ‰çš„è¯æ˜éƒ½å¹¶ä¸å›°éš¾ï¼Œæœ‰ç©ºçš„è¯å¯ä»¥è‡ªå·±è¯ä¸€ä¸‹è¯•è¯•ã€‚åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬ä¼šé—®ï¼šè¿™äº›æ•°å­¦çŸ¥è¯†æœ‰ç”¨å—ï¼Ÿ</p><blockquote><p>In a word, mostly no, sometimes yes, and occasionally, maybe.<br>â€” <a href="https://www.dgp.toronto.edu/public_user/elf/2522/sampling.pdf">https://www.dgp.toronto.edu/public_user/elf/2522/sampling.pdf</a></p></blockquote><h2 id="å·ç§¯"><a href="#å·ç§¯" class="headerlink" title="å·ç§¯"></a>å·ç§¯</h2><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ä¸‰ç§å·ç§¯â€”â€”ç¦»æ•£-ç¦»æ•£å·ç§¯ã€è¿ç»­-è¿ç»­å·ç§¯ã€ç¦»æ•£-è¿ç»­å·ç§¯ã€‚ä¸‹é¢çš„ $f_{\rightarrow t}$ è¡¨ç¤ºå°†å‡½æ•° $f$ å‘å³å¹³ç§» $t$ é•¿åº¦å¾—åˆ°çš„æ–°å‡½æ•°ï¼š</p><p>ç¦»æ•£-ç¦»æ•£å·ç§¯</p><script type="math/tex; mode=display">\begin{align*}&(a*b)[i]=\sum_{j}a[j]b[i-j]\\&(a*b)=\sum_{j}a[j]b_{\rightarrow j}\end{align*}</script><p>è¿ç»­-è¿ç»­å·ç§¯</p><script type="math/tex; mode=display">\begin{align*}&(f*g)(x)=\int_{-\infty}^{\infty}f(t)g(x-t)dt\\&(f*g)=\int_{-\infty}^{\infty}f(t)g_{\rightarrow t}dt\end{align*}</script><p>ç¦»æ•£-è¿ç»­å·ç§¯</p><script type="math/tex; mode=display">\begin{align*}&(a*f)(x)=\sum_{i}a[i]f(x-i)\\&(a*f)=\sum_{i}a[i]f_{\rightarrow i}\end{align*}</script><p>æˆ‘ä»¬ä¼šæ³¨æ„åˆ°ï¼Œå·ç§¯å¯ä»¥è¡¨ç¤ºä¸ºå‡½æ•°å¹³ç§»åçš„åŠ æƒå’Œã€‚</p><p><img src="/images/learning/open-course/GAMES101/Notes/note2/convlution.png" alt=""></p><p>å·ç§¯æ˜¯è¿‡ä¼šå„¿ä¼šç”¨åˆ°çš„å¦™å¦™å°å·¥å…·ã€‚</p><h2 id="å‚…é‡Œå¶çº§æ•°å’Œå‚…é‡Œå¶å˜æ¢"><a href="#å‚…é‡Œå¶çº§æ•°å’Œå‚…é‡Œå¶å˜æ¢" class="headerlink" title="å‚…é‡Œå¶çº§æ•°å’Œå‚…é‡Œå¶å˜æ¢"></a>å‚…é‡Œå¶çº§æ•°å’Œå‚…é‡Œå¶å˜æ¢</h2><p>æˆ‘ä»¬ä¹‹å‰æåˆ°ï¼Œèµ°æ ·çš„å®è´¨æ˜¯åŸå›¾çš„é«˜é¢‘ä¿¡å·è¢«é”™è¯¯é‡‡æ ·ã€‚å›¾åƒä½œä¸ºä¸€ä¸ª $R^2\rightarrow \text{RGBA<br>}$çš„å‡½æ•°ï¼Œæ€ä¹ˆä¼šæœ‰é«˜é¢‘å’Œä½é¢‘ä¹‹åˆ†å‘¢ï¼Ÿuh actuallyâ˜ï¸ğŸ¤“ æˆ‘ä»¬å¤„ç†çš„ç»å¤§å¤šæ•°å‡½æ•°éƒ½æœ‰é¢‘åŸŸï¼Œè¿™ä¸ªé¢‘åŸŸå¯ä»¥é€šè¿‡å‚…é‡Œå¶å˜æ¢å¾—åˆ°ã€‚</p><p>å…ˆå›é¡¾ä¸€ä¸‹<strong>å‚…é‡Œå¶çº§æ•°</strong>ã€‚ç†ŸçŸ¥åœ¨ $[-\frac{T}{2},\frac{T}{2}]$ å†…ï¼Œå‡½æ•° $f(x)$ å¯ä»¥è¡¨ç¤ºä¸º</p><script type="math/tex; mode=display">f(x)=\sum_{n=-\infty}^{\infty}c_n e^{inw_0 x}</script><p>å…¶ä¸­</p><script type="math/tex; mode=display">\begin{align*}&c_n=\frac{1}{T}\int_{-\frac{T}{2}}^{\frac{T}{2}} f(t)e^{-inw_0t}dt\\&w_0=\frac{2\pi}{T}\end{align*}</script><p>è¿™æœ¬è´¨ä¸Šæ˜¯å‡½æ•°åœ¨é—­åŒºé—´å†…çš„æ­£äº¤åŸºå±•å¼€ï¼Œè¿™ä¸ªå±•å¼€çš„å‘¨æœŸä¸º $T$.</p><p>å½“ $T \rightarrow \infty$ æ—¶ï¼Œä»¤ $w_n=nw_0$ï¼Œ$\Delta w=w_n-w_{n-1}=w_0$ å†ç»“åˆç§¯åˆ†çš„å®šä¹‰ï¼Œæˆ‘ä»¬å°±èƒ½ï¼ˆä¸å¤ªä¸¥è°¨åœ°ï¼‰æ±‚å‡º</p><script type="math/tex; mode=display">f(x)=\frac{1}{2\pi}\int_{-\infty}^{\infty}\bigg(\int_{-\infty}^{\infty}f(t)e^{-iwt}dt \bigg)e^{iwx}dw</script><p>æˆ‘ä»¬å¯ä»¥ä»¤ $u=\frac{w}{2\pi}$ ä»è€Œå»æ‰ç§¯åˆ†å¤–é¢çš„é‚£ä¸ªç³»æ•°</p><script type="math/tex; mode=display">f(x)=\int_{-\infty}^{\infty}\bigg(\int_{-\infty}^{\infty}f(t)e^{-2\pi iut}dt \bigg)e^{2\pi iux}du</script><p>è€Œ $e^{2\pi iux}$ çš„ç³»æ•°</p><script type="math/tex; mode=display">\hat f(u)=\int_{-\infty}^{\infty}f(t)e^{-2\pi iut}dt</script><p>å°±æ˜¯ $f$ çš„<strong>å‚…é‡Œå¶å˜æ¢</strong>äº†ï¼Œå®ƒä¹Ÿè®°ä½œ $\mathcal{F}(f)$.</p><p>æŠŠ $\hat f$ ä»£å…¥å°±å¾—åˆ°äº†<strong>é€†å‚…é‡Œå¶å˜æ¢</strong></p><script type="math/tex; mode=display">f(x)=\int_{-\infty}^{\infty}\hat f(u)e^{2\pi iux}du</script><p>é€†å‚…é‡Œå¶å˜æ¢æŠŠå‡½æ•°å˜æˆäº†ä¸åŒé¢‘ç‡çš„ä¸‰è§’å‡½æ•°çš„ç§¯åˆ†/æ±‚å’Œï¼Œè¿™å°±æ˜¯æˆ‘ä»¬ä¹‹å‰æ‰€è¯´çš„â€œé«˜é¢‘ä¿¡å·â€å’Œâ€œä½é¢‘ä¿¡å·â€çš„å«ä¹‰ã€‚ä¹‹åæˆ‘ä»¬ä¼šä»‹ç»é‡‡æ ·å¯¼è‡´é«˜é¢‘ä¿¡å·ä¸¢å¤±çš„åŸå› ï¼Œä¸è¿‡åœ¨æ­¤ä¹‹å‰æˆ‘ä»¬å…ˆçœ‹çœ‹å‚…é‡Œå¶å˜æ¢çš„ä¸€äº›æ€§è´¨ã€‚</p><p><img src="/images/learning/open-course/GAMES101/Notes/note2/fourier.png" alt=""></p><h2 id="å‚…é‡Œå¶å˜æ¢çš„æ€§è´¨"><a href="#å‚…é‡Œå¶å˜æ¢çš„æ€§è´¨" class="headerlink" title="å‚…é‡Œå¶å˜æ¢çš„æ€§è´¨"></a>å‚…é‡Œå¶å˜æ¢çš„æ€§è´¨</h2><p>æˆ‘ä»¬åˆ—ä¸¾å‚…é‡Œå¶å˜æ¢çš„å‡ ä¸ªå¸¸ç”¨çš„æ€§è´¨ã€‚</p><ol><li>å¦‚æœ $f$ æ˜¯å®å‡½æ•°ï¼Œ$\hat f$ æ˜¯å¶å‡½æ•°ã€‚</li><li><p>å‡½æ•°å’Œå‚…é‡Œå¶å˜æ¢çš„å¹³æ–¹ç§¯åˆ†ç›¸ç­‰</p><script type="math/tex; mode=display"> \int (f(x))^2dx=\int (\hat f(u))^2du</script></li><li><p>åŸå‡½æ•°æ‹‰é•¿ï¼Œå‚…é‡Œå¶å˜æ¢æ”¶ç´§</p><script type="math/tex; mode=display"> \mathcal{F}(f(x/b))=b\hat f(bu)</script></li></ol><h2 id="ç‹„æ‹‰å…‹è„‰å†²å‡½æ•°å’Œå†²æ¿€ä¸²"><a href="#ç‹„æ‹‰å…‹è„‰å†²å‡½æ•°å’Œå†²æ¿€ä¸²" class="headerlink" title="ç‹„æ‹‰å…‹è„‰å†²å‡½æ•°å’Œå†²æ¿€ä¸²"></a>ç‹„æ‹‰å…‹è„‰å†²å‡½æ•°å’Œå†²æ¿€ä¸²</h2><p>ç‹„æ‹‰å…‹è„‰å†²å‡½æ•°çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><script type="math/tex; mode=display">\delta(t) =\begin{cases}\infty, & t = 0 \\0, & t \neq 0\end{cases}</script><p>æˆ‘ä»¬å¯ä»¥æŠŠè¿ç»­ä¿¡å·çš„å‡åŒ€é—´éš”é‡‡æ ·è¡¨ç¤ºä¸ºå†²æ¿€ä¸²</p><script type="math/tex; mode=display">s_T(x) = \sum_{n=-\infty}^{\infty}\delta(x-nT)</script><p>ä¸åŸå‡½æ•° $f$ çš„ä¹˜ç§¯ï¼Œè¿™é‡Œçš„ $T$ è¡¨ç¤ºä¸¤ä¸ªé‡‡æ ·ç‚¹ä¹‹é—´çš„é—´éš”ã€‚</p><p>$s_T$ çš„å‚…é‡Œå¶å˜æ¢ä¸º</p><script type="math/tex; mode=display">\hat s_T(u)=\frac{1}{T}\sum_{n=-\infty}^{\infty}\delta(u-\frac{n}{T})</script><p>å®ƒä»ç„¶æ˜¯ä¸€ç³»åˆ—ç‹„æ‹‰å…‹å‡½æ•°çš„å’Œã€‚</p><p><img src="/images/learning/open-course/GAMES101/Notes/note2/dirac.png" alt=""></p><h2 id="å·ç§¯å®šç†"><a href="#å·ç§¯å®šç†" class="headerlink" title="å·ç§¯å®šç†"></a>å·ç§¯å®šç†</h2><p>ä¹‹å‰è¯´è¿‡ï¼Œå°† $s_T$ å’ŒåŸå‡½æ•° $f$ ç›¸ä¹˜èƒ½è·å¾—è®¸å¤šé‡è¦çš„é‡‡æ ·æ€§è´¨ï¼Œæˆ‘ä»¬å¾ˆå¿«å°±ä¼šè®¨è®ºä»–ä»¬äº†ï¼Œåœ¨æ­¤ä¹‹å‰æˆ‘ä»¬è¿˜è¦è¡¥å……æœ€åä¸€ä¸ªçŸ¥è¯†â€”â€”å·ç§¯å®šç†ã€‚</p><script type="math/tex; mode=display">\begin{align*}&\mathcal{F}(f * g)=\hat f\hat g\\&\mathcal{F}(fg)=\hat f * \hat g\end{align*}</script><p>è¿™å°±æ˜¯è¯´ï¼Œæ—¶åŸŸçš„å·ç§¯å¯¹åº”é¢‘åŸŸçš„ä¹˜ç§¯ï¼Œé¢‘åŸŸçš„ä¹˜ç§¯å¯¹åº”æ—¶åŸŸçš„å·ç§¯ã€‚</p><h1 id="èµ°æ ·çš„åŸå› "><a href="#èµ°æ ·çš„åŸå› " class="headerlink" title="èµ°æ ·çš„åŸå› "></a>èµ°æ ·çš„åŸå› </h1><p>ä¸€å¼€å§‹æˆ‘ä»¬å°±è¯´è¿‡ï¼Œèµ°æ ·çš„å®è´¨æ˜¯åŸå›¾çš„é«˜é¢‘ä¿¡å·è¢«é”™è¯¯é‡‡æ ·ã€‚ç°åœ¨æˆ‘ä»¬çš„æ•°å­¦å·¥å…·å·²ç»è¶³ä»¥åˆ†æç©¶ç«Ÿä¸ºä»€ä¹ˆå‘ç”Ÿäº†é”™è¯¯é‡‡æ ·ï¼Œä»¥åŠå¦‚ä½•ç¼“è§£ä»–ä»¬äº†ã€‚</p><p>å…ˆæ¥çœ‹çœ‹ä¸ºä»€ä¹ˆæˆ‘ä»¬æ²¡æœ‰æ­£ç¡®é‡‡æ ·é«˜é¢‘ä¿¡å·ã€‚</p><p>å‡è®¾æˆ‘ä»¬å¸Œæœ›å¯¹è¿™æ ·çš„å‡½æ•°è¿›è¡Œé‡‡æ ·ï¼Œé€šè¿‡å‚…é‡Œå¶å˜æ¢æˆ‘ä»¬å¯ä»¥å¾—åˆ°å…¶é¢‘åŸŸï¼ˆå³ä¸€ï¼‰</p><p><img src="/images/learning/open-course/GAMES101/Notes/note2/sample-origin.png" alt=""></p><p>æˆ‘ä»¬ä¹‹å‰è¯´è¿‡ï¼Œå¯ä»¥æŠŠè¿ç»­å‡½æ•°çš„å‡åŒ€é—´éš”é‡‡æ ·è¡¨ç¤ºä¸ºå†²æ¿€ä¸² $s_{T}(x)=\sum_{n=-\infty}^{\infty}\delta(x-nT)$ å’ŒåŸå‡½æ•° $f$ çš„ä¹˜ç§¯ï¼Œè€Œæˆ‘ä»¬ä¹Ÿå·²ç»çŸ¥é“å†²æ¿€ä¸²çš„å‚…é‡Œå¶å˜æ¢è¿˜æ˜¯å†²æ¿€ä¸²</p><script type="math/tex; mode=display">\hat s_T(u)=\frac{1}{T}\sum_{n=-\infty}^{\infty}\delta(u-\frac{n}{T})</script><p>å†ç»“åˆå·ç§¯å®šç† $\mathcal{F}(s_Tf)=\hat s_T * \hat f$ï¼Œä»¥åŠâ€œå·ç§¯å°±æ˜¯å‡½æ•°å¹³ç§»åçš„åŠ æƒå’Œâ€ï¼Œæˆ‘ä»¬å°±èƒ½æ¨å‡ºï¼Œé‡‡æ ·ç»“æœçš„å‚…é‡Œå¶å˜æ¢å°±æ˜¯åŸå‡½æ•°çš„å‚…é‡Œå¶å˜æ¢çš„æ— ç©·ä¸ªå¤åˆ¶å„æŒ‰ $\frac{n}{T}$ å¹³ç§»çš„å’Œã€‚</p><p><img src="/images/learning/open-course/GAMES101/Notes/note2/sample-sampled.png" alt=""></p><p>ç”±äºæˆ‘ä»¬çš„é‡‡æ ·é—´éš” $T$ ä¸å¤Ÿå°ï¼Œå³é‡‡æ ·ç‡ $\frac{1}{T}$ ä¸å¤Ÿå¤§ï¼Œæ‰€ä»¥ç›¸é‚»çš„ä¸¤ä¸ªå¤åˆ¶é—´å‘ç”Ÿäº†é‡å ï¼Œå¯¼è‡´é«˜é¢‘ä¿¡å·å’Œä½é¢‘ä¿¡å·äº§ç”Ÿæ··åˆï¼Œè¿™å°±å¼•èµ·äº†èµ°æ ·ã€‚è€Œè¿™æ­£æ˜¯â€œé«˜é¢‘ä¿¡å·è¢«é”™è¯¯é‡‡æ ·â€çš„å®è´¨ã€‚</p><p>å½“æˆ‘ä»¬åœ¨å…‰æ …åŒ–æ—¶ï¼Œæˆ‘ä»¬è¿˜æŠŠåƒç´ å¡«ä¸Šäº†é¢œè‰²ï¼Œè¿™æ˜¯åœ¨â€œreconstructionâ€å³é‡å»ºå›¾åƒã€‚ä¸è¿‡ç”±äºåœ¨é‡‡æ ·æ—¶æˆ‘ä»¬å·²ç»å‘ç”Ÿäº†èµ°æ ·ï¼Œæ— è®ºæ€ä¹ˆé‡å»ºéƒ½ä¸ä¼šæœ‰ä¸€ä¸ªéå¸¸å®Œç¾çš„ç»“æœäº†ã€‚</p><p><img src="/images/l earning/open-course/GAMES101/Notes/note2/sample-recons.png" alt=""></p><h1 id="æ»¤æ³¢å™¨å’Œèµ°æ ·çš„ç¼“è§£æ–¹æ³•"><a href="#æ»¤æ³¢å™¨å’Œèµ°æ ·çš„ç¼“è§£æ–¹æ³•" class="headerlink" title="æ»¤æ³¢å™¨å’Œèµ°æ ·çš„ç¼“è§£æ–¹æ³•"></a>æ»¤æ³¢å™¨å’Œèµ°æ ·çš„ç¼“è§£æ–¹æ³•</h1><p>ä¸ºäº†ç¼“è§£èµ°æ ·ï¼Œæˆ‘ä»¬è‡ªç„¶å°±è¦é¿å…å‘ç”Ÿé‡å ã€‚é¿å…å‘ç”Ÿé‡å çš„æ€è·¯ä¸»è¦æœ‰ä¸¤ç§ï¼š</p><ol><li>å¢åŠ é‡‡æ ·ç‡ï¼Œè¿™æ ·å°±èƒ½è®©ç›¸é‚»çš„ä¸¤ä¸ªå¤åˆ¶è·ç¦»å¢å¤§ã€‚</li><li>ç”¨æ»¤æ³¢å™¨å‡å¼±é«˜é¢‘ä¿¡å·çš„å¼ºåº¦ã€‚</li></ol><p>å¯¹å›¾åƒçš„å…‰æ …åŒ–æ¥è¯´ï¼Œå¢åŠ åˆ†è¾¨ç‡å°±å¯¹åº”å‰è€…ï¼›åœ¨é‡‡æ ·å‰å¯¹åŸå›¾åº”ç”¨å„ç§æ»¤æ³¢å™¨å°±å¯¹åº”åè€…ã€‚</p><p>æˆ‘ä»¬å½“ç„¶ä¼šé—®ï¼Œå¢åŠ é‡‡æ ·ç‡èƒ½ç¼“è§£èµ°æ ·ï¼Œé‚£å¢åŠ åˆ°å¤šå¤§åˆé€‚å‘¢ï¼Ÿæˆ‘ä»¬å¸Œæœ›ç›¸é‚»çš„ä¸¤ä¸ªå¤åˆ¶é—´çš„è·ç¦»è¶³å¤Ÿå¤§ä»¥è‡³äºä¸å‘ç”Ÿé‡å ï¼Œè¿™å°±éœ€è¦è¾“å…¥ä¿¡å·çš„æœ€é«˜é¢‘ç‡å°äºé‡‡æ ·é¢‘ç‡çš„ä¸€åŠã€‚é‡‡æ ·é¢‘ç‡çš„ä¸€åŠä¹Ÿè¢«ç§°ä¸º<strong>å¥ˆå¥æ–¯ç‰¹é¢‘ç‡</strong>ã€‚ç†è®ºä¸Šè¯´ï¼Œåªè¦å¥ˆå¥æ–¯ç‰¹é¢‘ç‡é«˜äºè¢«é‡‡æ ·ä¿¡å·çš„æœ€é«˜é¢‘ç‡ï¼Œæˆ‘ä»¬å°±èƒ½å®Œç¾å¤åŸåŸä¿¡å·ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹å‡ ä¸ªå¸¸è§çš„æ»¤æ³¢å™¨ï¼Œå®ƒä»¬å¸¸è¢«ç”¨äºå’Œåˆ«çš„å‡½æ•°åšå·ç§¯ã€‚ç”±äºæˆ‘ä»¬çŸ¥é“å·ç§¯å¯ä»¥è¢«ç†è§£ä¸ºä¸€ç§â€œåŠ æƒå¹³å‡â€ï¼Œæ‰€ä»¥æˆ‘ä»¬å¸Œæœ›æ»¤æ³¢å™¨éƒ½æ˜¯å½’ä¸€åŒ–çš„ã€‚</p><table>  <thead>    <tr>      <th>åç§°</th>      <th>å…¬å¼</th>    </tr>  </thead>  <tbody>    <tr>      <td>Box filterï¼ˆç¦»æ•£ï¼‰</td>      <td>$a_{\text{box},r}[i] =\begin{cases}1/(2r + 1) & |i| \le r, \\0 & \text{otherwise}.\end{cases}$</td>    </tr>    <tr>      <td>Box filterï¼ˆè¿ç»­ï¼‰</td>      <td>$f_{\text{box},r}(x) =\begin{cases}1/(2r) & -r \le x < r, \\0 & \text{otherwise}.\end{cases}$</td>    </tr>    <tr>      <td>Tent filter</td>      <td>$f_{\text{tent}}(x) =\begin{cases}1 - |x| & |x| < 1, \\0 & \text{otherwise};\end{cases}$</td>    </tr>    <tr>      <td>Gaussian filter</td>      <td>$f_{g, \sigma}(x) = \frac{1}{\sigma\sqrt{2\pi}}e^{-x^2/2\sigma^2}$</td>    </tr>  </tbody></table><p><img src="/images/learning/open-course/GAMES101/Notes/note2/filters1.png" alt=""></p><table>  <thead>    <tr>      <th>åç§°</th>      <th>å…¬å¼</th>    </tr>  </thead>  <tbody>    <tr>      <td>B-Spline Cubic Filter</td>      <td>$f_B(x) = \frac{1}{6}\begin{cases}-3(1 - |x|)^3 + 3(1 - |x|)^2 + 3(1 - |x|) + 1 & -1 \le x \le 1, \\(2 - |x|)^3 & 1 \le |x| \le 2, \\0 & \text{otherwise}.\end{cases}$</td>    </tr>    <tr>      <td>Catmull-Rom Cubic Filter</td>      <td>$f_C(x) = \frac{1}{2}\begin{cases}-3(1 - |x|)^3 + 4(1 - |x|)^2 + (1 - |x|) & -1 \le x \le 1, \\(2 - |x|)^3 - (2 - |x|)^2 & 1 \le |x| \le 2, \\0 & \text{otherwise}.\end{cases}$</td>    </tr>    <tr>      <td>Mitchell-Netravali Cubic Filter</td>      <td>$f_M(x) = \frac{1}{3}f_B(x) + \frac{2}{3}f_C(x)\\= \frac{1}{18}\begin{cases} -21(1 - |x|)^3 + 27(1 - |x|)^2 + 9(1 - |x|) + 1 & -1 \le x \le 1, \\7(2 - |x|)^3 - 6(2 - |x|)^2 & 1 \le |x| \le 2, \\0 & \text{otherwise}.\end{cases}$</td>    </tr>  </tbody></table><p><img src="/images/learning/open-course/GAMES101/Notes/note2/filters2.png" alt=""></p><p>é™¤äº†è¿‡æ»¤é«˜é¢‘ä¿¡å·ä¹‹å¤–ï¼Œæ»¤æ³¢å™¨è¿˜åœ¨é‡å»ºå›¾åƒæ—¶å‘æŒ¥ç€é‡è¦ä½œç”¨ã€‚è¿˜è®°å¾—å—ï¼Œç¦»æ•£-è¿ç»­å·ç§¯èƒ½æŠŠä¸€ç³»åˆ—ç¦»æ•£ç‚¹å˜æˆä¸€ä¸ªè¿ç»­å‡½æ•°ã€‚åœ¨æ ¹æ®é‡‡æ ·ç‚¹é‡å»ºå›¾åƒæ—¶ï¼Œæˆ‘ä»¬åŸºæœ¬å°±æ˜¯åœ¨åšé‡‡æ ·ç‚¹å’Œæ»¤æ³¢å™¨çš„å·ç§¯ã€‚åœ¨å…‰æ …åŒ–çš„â€œæŠŠæ¯ä¸ªåƒç´ ç‚¹çš„ä¸­å¿ƒé‡‡æ ·é¢œè‰²å¡«åˆ°åƒç´ ç‚¹ä¸Šâ€è¿™ä¸€æ­¥ä¸­ï¼Œæˆ‘ä»¬å°±æ˜¯åœ¨å°†é‡‡æ ·ç‚¹å’Œ Box filter åšå·ç§¯ã€‚</p><p>æ€»è€Œè¨€ä¹‹ï¼Œä¸ºäº†ç¼“è§£èµ°æ ·ï¼Œæˆ‘ä»¬å¯ä»¥ä»¥å›¾åƒç»†èŠ‚ä¸°å¯Œåº¦ä¸ºä»£ä»·ï¼Œå…ˆç”¨ä½é€šæ»¤æ³¢å™¨æ»¤æ³¢ï¼Œå†é‡‡æ ·+é‡å»ºã€‚å½“ç„¶ï¼Œå¦‚æœæˆ‘ä»¬æœ‰æ›´é«˜åˆ†è¾¨ç‡çš„å±å¹•å°±æ›´å¥½äº†~</p><h1 id="å…¶ä»–å°çŸ¥è¯†"><a href="#å…¶ä»–å°çŸ¥è¯†" class="headerlink" title="å…¶ä»–å°çŸ¥è¯†"></a>å…¶ä»–å°çŸ¥è¯†</h1><h2 id="å¸¸è§æ»¤æ³¢å™¨çš„å‚…é‡Œå¶å˜æ¢"><a href="#å¸¸è§æ»¤æ³¢å™¨çš„å‚…é‡Œå¶å˜æ¢" class="headerlink" title="å¸¸è§æ»¤æ³¢å™¨çš„å‚…é‡Œå¶å˜æ¢"></a>å¸¸è§æ»¤æ³¢å™¨çš„å‚…é‡Œå¶å˜æ¢</h2><p><img src="/images/learning/open-course/GAMES101/Notes/note2/fourier-all.png" alt=""></p><h2 id="å·ç§¯çš„å•ä½å…ƒ"><a href="#å·ç§¯çš„å•ä½å…ƒ" class="headerlink" title="å·ç§¯çš„å•ä½å…ƒ"></a>å·ç§¯çš„å•ä½å…ƒ</h2><p>ä»»ä½•ç¦»æ•£ä¿¡å·å’Œå•ä½è„‰å†²åºåˆ—åšå·ç§¯ï¼Œç»“æœè¿˜æ˜¯åŸæœ¬çš„ç¦»æ•£ä¿¡å·</p><script type="math/tex; mode=display">\delta[n] =\begin{cases}1, & n = 0 \\0, & n \neq 0\end{cases}</script><p>ä»»ä½•è¿ç»­ä¿¡å·å’Œç‹„æ‹‰å…‹å‡½æ•°åšå·ç§¯ï¼Œç»“æœè¿˜æ˜¯åŸæœ¬çš„è¿ç»­ä¿¡å·</p><script type="math/tex; mode=display">\delta(t) =\begin{cases}\infty, & t = 0 \\0, & t \neq 0\end{cases}</script><h2 id="äºŒç»´å·ç§¯å’ŒäºŒç»´æ»¤æ³¢å™¨"><a href="#äºŒç»´å·ç§¯å’ŒäºŒç»´æ»¤æ³¢å™¨" class="headerlink" title="äºŒç»´å·ç§¯å’ŒäºŒç»´æ»¤æ³¢å™¨"></a>äºŒç»´å·ç§¯å’ŒäºŒç»´æ»¤æ³¢å™¨</h2><p>æˆ‘ä»¬è¿™é‡Œåªç»™å‡ºè¿ç»­-è¿ç»­çš„äºŒç»´å·ç§¯ï¼Œåˆ«çš„æƒ…å†µéƒ½å·®ä¸å¤šã€‚</p><script type="math/tex; mode=display">\begin{align*}&(f*g)(x,y)=\int\intf(x-x',y-y')g(x',y')dx'dy'\end{align*}</script><p>å¯¹æ»¤æ³¢å™¨ $f(x)$ï¼Œæˆ‘ä»¬ç®€å•åœ°å®šä¹‰ $g(x,y)=f(x)f(y)$ å°±å¾—åˆ°äº†è¿™ä¸ªæ»¤æ³¢å™¨å¯¹åº”çš„äºŒç»´æ»¤æ³¢å™¨ã€‚ä¸€ä¸ªæ¯”è¾ƒå¥½çš„æ€§è´¨æ˜¯ï¼Œå¦‚æœ $f$ æ˜¯å½’ä¸€åŒ–çš„ï¼Œé‚£ä¹ˆ $g$ ä¹Ÿæ˜¯å½’ä¸€åŒ–çš„ã€‚</p><h2 id="ä¼½é©¬å€¼"><a href="#ä¼½é©¬å€¼" class="headerlink" title="ä¼½é©¬å€¼"></a>ä¼½é©¬å€¼</h2><p>æ˜¾ç¤ºå™¨çš„æ˜¾ç¤ºäº®åº¦å…³äºè¾“å…¥ä¿¡å·ä¸æ˜¯çº¿æ€§å…³ç³»ã€‚å‡è®¾è¾“å…¥ä¿¡å·ä¸º $a\in[0,1]$ï¼Œåˆ™æœ‰</p><script type="math/tex; mode=display">\text{Displayed intensity}=(\text{Maximum intensity})a^\gamma</script><p>è¿™é‡Œçš„ $\gamma$ ä¸€èˆ¬åœ¨ $2.2$ å·¦å³ã€‚è™½ç„¶åœ¨æœ€å¼€å§‹è¿™æ˜¯ CRT æ˜¾ç¤ºå™¨çš„ç‰©ç†ç‰¹æ€§æ‰€è‡´ï¼Œä½†æœ‰è¶£çš„æ˜¯ï¼Œäººçœ¼ä¹Ÿæ°å¥½å¯¹æš—éƒ¨å˜åŒ–æ¯”äº®éƒ¨å˜åŒ–æ›´æ•æ„Ÿï¼Œæ‰€ä»¥å®ƒç°åœ¨ä½œä¸ºä¸€ä¸ªåˆ»æ„çš„è®¾è®¡ä¿ç•™äº†ä¸‹æ¥ã€‚</p><p>ä¼½é©¬çŸ«æ­£åœ¨å½±åƒç³»ç»Ÿä¸­ä¹Ÿæœ‰æå¤§ä½œç”¨ã€‚å‡è®¾æˆ‘ä»¬åœ¨æ‹æ‘„ä¸€ä¸ªè‹¹æœçš„ç…§ç‰‡ï¼Œè‹¹æœçš„ç‰©ç†äº®åº¦æ˜¯ $0.5$ï¼Œç›¸æœºå¿ å®åœ°æŠŠå®ƒè®°å½•äº†ä¸‹æ¥ã€‚è€Œå½“æ˜¾ç¤ºå™¨æ˜¾ç¤ºæ—¶ï¼Œå°±æ˜¾ç¤ºå‡ºäº† $0.5^{2.2}\approx<br> 0.22$ çš„ç‰©ç†äº®åº¦ï¼Œè¿™æ˜¾ç„¶ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚å› æ­¤åœ¨æˆ‘ä»¬æ‹æ‘„ç…§ç‰‡ä¹‹åï¼Œç›¸æœºçš„å›¾åƒå¤„ç†å™¨å°±ä¼šè‡ªåŠ¨å¯¹ç…§ç‰‡è¿›è¡Œä¼½é©¬çŸ«æ­£ã€‚</p><h2 id="å›¾åƒé”åŒ–"><a href="#å›¾åƒé”åŒ–" class="headerlink" title="å›¾åƒé”åŒ–"></a>å›¾åƒé”åŒ–</h2><p>Unsharp Mask æ˜¯ä¸€ä¸ªç»å…¸çš„å›¾åƒé”åŒ–ç®—æ³•ã€‚ä»¤é«˜æ–¯æ¨¡ç³Šæ ¸ä¸º $G$ï¼Œå†²æ¿€å‡½æ•°ä¸º $\delta$ï¼Œå®ƒå…ˆæå–åŸå§‹å›¾åƒçš„é«˜é¢‘ä¿¡å·</p><script type="math/tex; mode=display">I_{detail} = I_{orig} - I_{orig} * G</script><p>å†æŠŠè¿™äº›é«˜é¢‘ä¿¡å·åŠ å…¥å›åŸå›¾ä¸­</p><script type="math/tex; mode=display">I_{sharp} = I_{orig} + \alpha I_{detail}</script><p>ç»¼åˆèµ·æ¥å°±æ˜¯</p><script type="math/tex; mode=display">I_{sharp}=I_{orig}*((1+\alpha)\delta-G)</script><h2 id="å›¾åƒç¼©æ”¾"><a href="#å›¾åƒç¼©æ”¾" class="headerlink" title="å›¾åƒç¼©æ”¾"></a>å›¾åƒç¼©æ”¾</h2><p>ç›´æ¥å¯¹ä¸€ä¸ªåƒç´ åŒ–çš„å›¾åƒé‡‡æ ·è™½ç„¶æ•ˆç‡å¾ˆé«˜ï¼Œä½†æ•ˆæœä¸ä½³ã€‚å…ˆç”¨è¿ç»­çš„æ»¤æ³¢å™¨é‡å»ºä¿¡å·ï¼Œå†ç”¨ä½é€šæ»¤æ³¢å™¨è¿‡æ»¤é«˜é¢‘ä¿¡å·ï¼Œå†é‡‡æ ·ä¼šå¾—åˆ°æ›´å¥½çš„ç»“æœï¼Œè¿™è¢«ç§°ä¸º resamplingï¼Œé‡é‡‡æ ·ã€‚</p><p><img src="/images/learning/open-course/GAMES101/Notes/note2/resample.png" alt=""></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;åœ¨ Transformation éƒ¨åˆ†ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥æŠŠä¸€ä¸ªä¸‰ç»´ç©ºé—´é‡Œçš„ä¸‰è§’å½¢æŠ•å½±åˆ°å¹³é¢ä¸Šã€‚ä½†æ€ä¹ˆæŠŠä¸€ä¸ªçº¯è‰²ä¸‰è§’å½¢ç»˜åˆ¶åˆ°å±å¹•ä¸Šå‘¢ï¼Ÿæˆ‘ä»¬çŸ¥é“å±å¹•ç”±å¤§é‡çš„åƒç´ ç‚¹ç»„æˆï¼Œé‚£ä¹ˆæ€ä¹ˆç¡®å®šæ¯ä¸ªåƒç´ ç‚¹æ˜¯ä»€ä¹ˆé¢œè‰²å‘¢ï¼Ÿ&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬é€šè¿‡é‡‡æ ·ç»™æ¯ä¸ªåƒç´ ç‚¹æ¶‚ä¸Šé¢œè‰²ã€‚æˆ‘ä»¬å¯ä»¥æ£€æŸ¥æ¯ä¸ªåƒç´ çš„ä¸­å¿ƒç‚¹</summary>
      
    
    
    
    <category term="å…¬å¼€è¯¾" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/"/>
    
    <category term="GAMES101" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/GAMES101/"/>
    
    <category term="Notes" scheme="http://rinevard.github.io/categories/%E5%85%AC%E5%BC%80%E8%AF%BE/GAMES101/Notes/"/>
    
    
  </entry>
  
</feed>
